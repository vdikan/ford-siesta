<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A first-principles materials simulation code using Density Functional Theory.">
    
    <meta name="author" content="SIESTA Group" >
    <link rel="icon" href="../favicon.png">

    <title>setup_hamiltonian &ndash; SIESTA</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">SIESTA <small>trunk-674--vdikan-ford-681</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Program Overview</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>setup_hamiltonian
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 2.7% of total for procedures.">138 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/setup_hamiltonian.F"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/setup_hamiltonian.f.html'>setup_hamiltonian.F</a></li>
    
     <li><a href='../module/m_setup_hamiltonian.html'>m_setup_hamiltonian</a></li>
    
  
     <li class="active">setup_hamiltonian</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/setup_hamiltonian.html#src">setup_hamiltonian</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine setup_hamiltonian(iscf)
    
    
   
</h2>
    
  
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Uses</h3>
      </div>
      <ul class="list-group">
      
      <li class="list-group-item">
  <ul class="list-inline">
    
    <li>siesta_options</li>
    
    <li>sparse_matrices</li>
    
    <li>sparse_matrices</li>
    
    <li>sparse_matrices</li>
    
    <li>sparse_matrices</li>
    
    <li>sparse_matrices</li>
    
    <li>class_dSpData1D</li>
    
    <li>class_dSpData2D</li>
    
    <li>siesta_geom</li>
    
    <li>atmfuncs</li>
    
    <li>atomlist</li>
    
    <li>metaforce</li>
    
    <li>molecularmechanics</li>
    
    <li>ldau_specs</li>
    
    <li>m_ldau</li>
    
    <li>m_dhscf</li>
    
    <li>m_stress</li>
    
    <li>m_energies</li>
    
    <li>parallel</li>
    
    <li>m_steps</li>
    
    <li>m_ntm</li>
    
    <li>m_spin</li>
    
    <li>m_dipol</li>
    
    <li>alloc</li>
    
    <li>m_gamma</li>
    
    <li>m_hsx</li>
    
    <li>sys</li>
    
    <li>m_partial_charges</li>
    
    <li>files</li>
    
    <li>m_rhog</li>
    
    <li>m_mpi_utils</li>
    
  </ul>
      </li>
      
      
      
      <li class="list-group-item">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: proc~~setup_hamiltonian~~UsesGraph Pages: 1 -->
<svg id="procsetup_hamiltonianUsesGraph" width="254pt" height="1124pt"
 viewBox="0.00 0.00 254.00 1124.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~setup_hamiltonian~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 1120)">
<title>proc~~setup_hamiltonian~~UsesGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1120 250,-1120 250,4 -4,4"/>
<!-- proc~setup_hamiltonian -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node1" class="node">
<title>proc~setup_hamiltonian</title>
<polygon fill="none" stroke="#000000" points="246,-570 146,-570 146,-546 246,-546 246,-570"/>
<text text-anchor="middle" x="196" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">setup_hamiltonian</text>
</g>
<!-- atomlist -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node2" class="node">
<title>atomlist</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-1116 28,-1116 28,-1092 82,-1092 82,-1116"/>
<text text-anchor="middle" x="55" y="-1101.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">atomlist</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;atomlist -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge1" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;atomlist</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.6128,-570.1342C193.124,-640.9479 177.2805,-1000.5136 110,-1083 105.2476,-1088.8264 98.685,-1093.0384 91.7449,-1096.0826"/>
<polygon fill="#000000" stroke="#000000" points="90.3886,-1092.8514 82.1818,-1099.552 92.7759,-1099.4317 90.3886,-1092.8514"/>
</g>
<!-- parallel -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node3" class="node">
<title>parallel</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-1074 28,-1074 28,-1050 82,-1050 82,-1074"/>
<text text-anchor="middle" x="55" y="-1059.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">parallel</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;parallel -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge2" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.4289,-570.0343C192.0145,-637.2294 172.2981,-965.6921 110,-1041 105.2074,-1046.7934 98.6277,-1050.9913 91.6837,-1054.0323"/>
<polygon fill="#000000" stroke="#000000" points="90.3279,-1050.8009 82.1224,-1057.5032 92.7165,-1057.3808 90.3279,-1050.8009"/>
</g>
<!-- sys -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node4" class="node">
<title>sys</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-1032 28,-1032 28,-1008 82,-1008 82,-1032"/>
<text text-anchor="middle" x="55" y="-1017.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">sys</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;sys -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge4" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.193,-570.2305C190.7379,-634.3067 167.2416,-930.9476 110,-999 105.1601,-1004.7539 98.5603,-1008.9351 91.6116,-1011.9722"/>
<polygon fill="#000000" stroke="#000000" points="90.2563,-1008.7406 82.0524,-1015.4448 92.6465,-1015.32 90.2563,-1008.7406"/>
</g>
<!-- ldau_specs -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node5" class="node">
<title>ldau_specs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="88.5,-990 21.5,-990 21.5,-966 88.5,-966 88.5,-990"/>
<text text-anchor="middle" x="55" y="-975.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">ldau_specs</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;ldau_specs -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge3" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;ldau_specs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.9191,-570.2477C189.366,-630.6227 162.26,-896.0978 110,-957 106.593,-960.9704 102.3495,-964.1927 97.7403,-966.8072"/>
<polygon fill="#000000" stroke="#000000" points="96.1136,-963.7043 88.5495,-971.1229 99.089,-970.0405 96.1136,-963.7043"/>
</g>
<!-- class_dSpData1D -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node6" class="node">
<title>class_dSpData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="103.5,-948 6.5,-948 6.5,-924 103.5,-924 103.5,-948"/>
<text text-anchor="middle" x="55" y="-933.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">class_dSpData1D</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;class_dSpData1D -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge5" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;class_dSpData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.6055,-570.0675C187.9025,-626.1812 157.358,-861.1377 110,-915 109.1269,-915.9931 108.2015,-916.9394 107.2314,-917.8412"/>
<polygon fill="#000000" stroke="#000000" points="104.9874,-915.148 99.0435,-923.9184 109.1594,-920.7689 104.9874,-915.148"/>
</g>
<!-- m_hsx -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node7" class="node">
<title>m_hsx</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-906 28,-906 28,-882 82,-882 82,-906"/>
<text text-anchor="middle" x="55" y="-891.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_hsx</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_hsx -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge6" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_hsx</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.1973,-570.0187C186.2006,-621.902 152.4471,-826.1649 110,-873 104.998,-878.5191 98.3868,-882.5977 91.488,-885.6087"/>
<polygon fill="#000000" stroke="#000000" points="90.204,-882.3517 82.0263,-889.088 92.6199,-888.9216 90.204,-882.3517"/>
</g>
<!-- atmfuncs -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node8" class="node">
<title>atmfuncs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="83,-864 27,-864 27,-840 83,-840 83,-864"/>
<text text-anchor="middle" x="55" y="-849.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">atmfuncs</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;atmfuncs -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge7" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;atmfuncs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.6,-570.3174C184.0554,-618.1931 147.4833,-791.2151 110,-831 105.1967,-836.0982 99.0236,-839.9718 92.5583,-842.911"/>
<polygon fill="#000000" stroke="#000000" points="91.0817,-839.7289 83.0024,-846.5826 93.5924,-846.2631 91.0817,-839.7289"/>
</g>
<!-- m_ntm -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node9" class="node">
<title>m_ntm</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-822 28,-822 28,-798 82,-798 82,-822"/>
<text text-anchor="middle" x="55" y="-807.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_ntm</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_ntm -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge8" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_ntm</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.9411,-570.1496C191.0176,-607.8908 174.0326,-724.4312 110,-789 104.971,-794.0711 98.5898,-797.9384 91.9691,-800.8813"/>
<polygon fill="#000000" stroke="#000000" points="90.3437,-797.7539 82.2275,-804.564 92.8191,-804.3017 90.3437,-797.7539"/>
</g>
<!-- m_dhscf -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node10" class="node">
<title>m_dhscf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-780 28,-780 28,-756 82,-756 82,-780"/>
<text text-anchor="middle" x="55" y="-765.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_dhscf</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_dhscf -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge9" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_dhscf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.827,-570.0267C187.2659,-602.9763 164.6467,-695.6556 110,-747 104.8451,-751.8433 98.4581,-755.6027 91.8818,-758.5103"/>
<polygon fill="#000000" stroke="#000000" points="90.3306,-755.3558 82.2327,-762.1876 92.8235,-761.8969 90.3306,-755.3558"/>
</g>
<!-- m_stress -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node11" class="node">
<title>m_stress</title>
<polygon fill="#337ab7" stroke="#337ab7" points="83,-738 27,-738 27,-714 83,-714 83,-738"/>
<text text-anchor="middle" x="55" y="-723.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_stress</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_stress -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge10" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_stress</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M192.0748,-570.119C182.4969,-597.8674 155.3363,-666.5733 110,-705 104.9855,-709.2502 99.0194,-712.6903 92.8962,-715.459"/>
<polygon fill="#000000" stroke="#000000" points="91.2667,-712.3399 83.259,-719.2773 93.8452,-718.8477 91.2667,-712.3399"/>
</g>
<!-- sparse_matrices -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node12" class="node">
<title>sparse_matrices</title>
<polygon fill="#337ab7" stroke="#337ab7" points="100.5,-696 9.5,-696 9.5,-672 100.5,-672 100.5,-696"/>
<text text-anchor="middle" x="55" y="-681.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">sparse_matrices</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;sparse_matrices -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge11" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;sparse_matrices</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M189.0404,-570.1179C176.098,-591.6616 146.3163,-636.8182 110,-663 107.8962,-664.5167 105.669,-665.9391 103.3637,-667.2709"/>
<polygon fill="#000000" stroke="#000000" points="101.4899,-664.298 94.1798,-671.967 104.6768,-670.5305 101.4899,-664.298"/>
</g>
<!-- files -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node13" class="node">
<title>files</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-654 28,-654 28,-630 82,-630 82,-654"/>
<text text-anchor="middle" x="55" y="-639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">files</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;files -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge12" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;files</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M181.8876,-570.1908C165.4733,-583.9153 137.1472,-606.2226 110,-621 104.2855,-624.1107 98.0122,-626.9728 91.8114,-629.5176"/>
<polygon fill="#000000" stroke="#000000" points="90.2709,-626.3612 82.2176,-633.2456 92.8063,-632.8859 90.2709,-626.3612"/>
</g>
<!-- siesta_options -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node14" class="node">
<title>siesta_options</title>
<polygon fill="#337ab7" stroke="#337ab7" points="95.5,-612 14.5,-612 14.5,-588 95.5,-588 95.5,-612"/>
<text text-anchor="middle" x="55" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">siesta_options</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;siesta_options -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge13" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;siesta_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M155.5951,-570.0355C139.9604,-574.6926 121.8948,-580.0739 105.4241,-584.9801"/>
<polygon fill="#000000" stroke="#000000" points="103.9955,-581.7535 95.4108,-587.9627 105.9939,-588.4622 103.9955,-581.7535"/>
</g>
<!-- alloc -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node15" class="node">
<title>alloc</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-570 28,-570 28,-546 82,-546 82,-570"/>
<text text-anchor="middle" x="55" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">alloc</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;alloc -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge14" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M145.8917,-558C128.36,-558 108.9876,-558 92.6478,-558"/>
<polygon fill="#000000" stroke="#000000" points="92.3979,-554.5001 82.3979,-558 92.3978,-561.5001 92.3979,-554.5001"/>
</g>
<!-- m_partial_charges -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node16" class="node">
<title>m_partial_charges</title>
<polygon fill="#337ab7" stroke="#337ab7" points="105.5,-528 4.5,-528 4.5,-504 105.5,-504 105.5,-528"/>
<text text-anchor="middle" x="55" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_partial_charges</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_partial_charges -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge15" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_partial_charges</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M155.5951,-545.9645C139.9604,-541.3074 121.8948,-535.9261 105.4241,-531.0199"/>
<polygon fill="#000000" stroke="#000000" points="105.9939,-527.5378 95.4108,-528.0373 103.9955,-534.2465 105.9939,-527.5378"/>
</g>
<!-- metaforce -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node17" class="node">
<title>metaforce</title>
<polygon fill="#337ab7" stroke="#337ab7" points="85.5,-486 24.5,-486 24.5,-462 85.5,-462 85.5,-486"/>
<text text-anchor="middle" x="55" y="-471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">metaforce</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;metaforce -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge16" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;metaforce</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M181.8876,-545.8092C165.4733,-532.0847 137.1472,-509.7774 110,-495 105.3501,-492.4689 100.3303,-490.1023 95.2806,-487.9373"/>
<polygon fill="#000000" stroke="#000000" points="96.2051,-484.5359 85.6223,-484.0321 93.5811,-491.0255 96.2051,-484.5359"/>
</g>
<!-- m_energies -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node18" class="node">
<title>m_energies</title>
<polygon fill="#337ab7" stroke="#337ab7" points="89.5,-444 20.5,-444 20.5,-420 89.5,-420 89.5,-444"/>
<text text-anchor="middle" x="55" y="-429.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_energies</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_energies -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge17" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_energies</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M189.0404,-545.8821C176.098,-524.3384 146.3163,-479.1818 110,-453 106.5489,-450.512 102.766,-448.2778 98.8504,-446.2808"/>
<polygon fill="#000000" stroke="#000000" points="100.1175,-443.0118 89.567,-442.0435 97.2108,-449.3798 100.1175,-443.0118"/>
</g>
<!-- m_rhog -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node19" class="node">
<title>m_rhog</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-402 28,-402 28,-378 82,-378 82,-402"/>
<text text-anchor="middle" x="55" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_rhog</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_rhog -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge19" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_rhog</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M192.0748,-545.881C182.4969,-518.1326 155.3363,-449.4267 110,-411 104.6566,-406.471 98.2326,-402.8619 91.6894,-400.0047"/>
<polygon fill="#000000" stroke="#000000" points="92.7199,-396.6514 82.1297,-396.3371 90.2125,-403.1869 92.7199,-396.6514"/>
</g>
<!-- m_dipol -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node20" class="node">
<title>m_dipol</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-360 28,-360 28,-336 82,-336 82,-360"/>
<text text-anchor="middle" x="55" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_dipol</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_dipol -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge18" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_dipol</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.827,-545.9733C187.2659,-513.0237 164.6467,-420.3444 110,-369 104.8451,-364.1567 98.4581,-360.3973 91.8818,-357.4897"/>
<polygon fill="#000000" stroke="#000000" points="92.8235,-354.1031 82.2327,-353.8124 90.3306,-360.6442 92.8235,-354.1031"/>
</g>
<!-- m_ldau -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node21" class="node">
<title>m_ldau</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-318 28,-318 28,-294 82,-294 82,-318"/>
<text text-anchor="middle" x="55" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_ldau</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_ldau -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge20" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_ldau</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.9411,-545.8504C191.0176,-508.1092 174.0326,-391.5688 110,-327 104.971,-321.9289 98.5898,-318.0616 91.9691,-315.1187"/>
<polygon fill="#000000" stroke="#000000" points="92.8191,-311.6983 82.2275,-311.436 90.3437,-318.2461 92.8191,-311.6983"/>
</g>
<!-- m_gamma -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node22" class="node">
<title>m_gamma</title>
<polygon fill="#337ab7" stroke="#337ab7" points="87,-276 23,-276 23,-252 87,-252 87,-276"/>
<text text-anchor="middle" x="55" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_gamma</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_gamma -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge21" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_gamma</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.6,-545.6826C184.0554,-497.8069 147.4833,-324.7849 110,-285 106.1451,-280.9084 101.4079,-277.6056 96.3455,-274.9415"/>
<polygon fill="#000000" stroke="#000000" points="97.5629,-271.6528 87.0022,-270.8035 94.7283,-278.0532 97.5629,-271.6528"/>
</g>
<!-- m_steps -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node23" class="node">
<title>m_steps</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-234 28,-234 28,-210 82,-210 82,-234"/>
<text text-anchor="middle" x="55" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_steps</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_steps -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge22" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_steps</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.1973,-545.9813C186.2006,-494.098 152.4471,-289.8351 110,-243 104.998,-237.4809 98.3868,-233.4023 91.488,-230.3913"/>
<polygon fill="#000000" stroke="#000000" points="92.6199,-227.0784 82.0263,-226.912 90.204,-233.6483 92.6199,-227.0784"/>
</g>
<!-- siesta_geom -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node24" class="node">
<title>siesta_geom</title>
<polygon fill="#337ab7" stroke="#337ab7" points="91.5,-192 18.5,-192 18.5,-168 91.5,-168 91.5,-192"/>
<text text-anchor="middle" x="55" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">siesta_geom</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;siesta_geom -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge23" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;siesta_geom</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.6055,-545.9325C187.9025,-489.8188 157.358,-254.8623 110,-201 107.3057,-197.9356 104.1142,-195.3163 100.646,-193.0778"/>
<polygon fill="#000000" stroke="#000000" points="102.0541,-189.8626 91.581,-188.261 98.7695,-196.0441 102.0541,-189.8626"/>
</g>
<!-- m_mpi_utils -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node25" class="node">
<title>m_mpi_utils</title>
<polygon fill="#337ab7" stroke="#337ab7" points="90,-150 20,-150 20,-126 90,-126 90,-150"/>
<text text-anchor="middle" x="55" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_mpi_utils</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_mpi_utils -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge24" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_mpi_utils</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.9191,-545.7523C189.366,-485.3773 162.26,-219.9022 110,-159 106.9986,-155.5022 103.348,-152.5851 99.3701,-150.1526"/>
<polygon fill="#000000" stroke="#000000" points="100.7692,-146.9384 90.2638,-145.5643 97.6194,-153.1897 100.7692,-146.9384"/>
</g>
<!-- class_dSpData2D -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node26" class="node">
<title>class_dSpData2D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="103.5,-108 6.5,-108 6.5,-84 103.5,-84 103.5,-108"/>
<text text-anchor="middle" x="55" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">class_dSpData2D</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;class_dSpData2D -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge25" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;class_dSpData2D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.193,-545.7695C190.7379,-481.6933 167.2416,-185.0524 110,-117 109.2598,-116.12 108.4785,-115.2769 107.6611,-114.4689"/>
<polygon fill="#000000" stroke="#000000" points="109.5111,-111.4743 99.4652,-108.108 105.2192,-117.0043 109.5111,-111.4743"/>
</g>
<!-- m_spin -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node27" class="node">
<title>m_spin</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-66 28,-66 28,-42 82,-42 82,-66"/>
<text text-anchor="middle" x="55" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">m_spin</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_spin -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge26" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.4289,-545.9657C192.0145,-478.7706 172.2981,-150.3079 110,-75 105.2074,-69.2066 98.6277,-65.0087 91.6837,-61.9677"/>
<polygon fill="#000000" stroke="#000000" points="92.7165,-58.6192 82.1224,-58.4968 90.3279,-65.1991 92.7165,-58.6192"/>
</g>
<!-- molecularmechanics -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node28" class="node">
<title>molecularmechanics</title>
<polygon fill="#337ab7" stroke="#337ab7" points="110,-24 0,-24 0,0 110,0 110,-24"/>
<text text-anchor="middle" x="55" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">molecularmechanics</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;molecularmechanics -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge27" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;molecularmechanics</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.6128,-545.8658C193.124,-475.0521 177.2805,-115.4864 110,-33 109.2732,-32.109 108.5041,-31.2557 107.6978,-30.4386"/>
<polygon fill="#000000" stroke="#000000" points="109.59,-27.4729 99.5743,-24.0177 105.2492,-32.9645 109.59,-27.4729"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="490pt" height="32pt"
 viewBox="0.00 0.00 489.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 485.5,-28 485.5,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node">
<title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24 0,-24 0,0 54,0 54,-24"/>
<text text-anchor="middle" x="27" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node">
<title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="139.5,-24 72.5,-24 72.5,0 139.5,0 139.5,-24"/>
<text text-anchor="middle" x="106" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="222,-24 158,-24 158,0 222,0 222,-24"/>
<text text-anchor="middle" x="190" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="294,-24 240,-24 240,0 294,0 294,-24"/>
<text text-anchor="middle" x="267" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="366,-24 312,-24 312,0 366,0 366,-24"/>
<text text-anchor="middle" x="339" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="481.5,-24 384.5,-24 384.5,0 481.5,0 481.5,-24"/>
<text text-anchor="middle" x="433" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a submodule to the (sub)module which it is
    descended from. Dashed arrows point from a module or program unit to 
    modules which it uses.
    </p>
    </div></div></div></div>
      </li>
      
      </ul>
    </div>
    


    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iscf"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iscf</strong></td><td></td>
  
</tr>

</tbody>
</table>

    
    
    
    <br>
    
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Calls</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: proc~~setup_hamiltonian~~CallsGraph Pages: 1 -->
<svg id="procsetup_hamiltonianCallsGraph" width="225pt" height="578pt"
 viewBox="0.00 0.00 225.00 578.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~setup_hamiltonian~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 574)">
<title>proc~~setup_hamiltonian~~CallsGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-574 221,-574 221,4 -4,4"/>
<!-- proc~setup_hamiltonian -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node1" class="node">
<title>proc~setup_hamiltonian</title>
<polygon fill="none" stroke="#000000" points="100,-297 0,-297 0,-273 100,-273 100,-297"/>
<text text-anchor="middle" x="50" y="-282.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">setup_hamiltonian</text>
</g>
<!-- update_e0 -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node2" class="node">
<title>update_e0</title>
<polygon fill="#777777" stroke="#777777" points="208.5,-570 144.5,-570 144.5,-546 208.5,-546 208.5,-570"/>
<text text-anchor="middle" x="176.5" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">update_e0</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;update_e0 -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge2" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;update_e0</title>
<path fill="none" stroke="#000000" d="M50.9739,-297.0686C54.7289,-336.3018 71.4666,-462.0202 136,-537 136.8428,-537.9792 137.7427,-538.919 138.6888,-539.8202"/>
<polygon fill="#000000" stroke="#000000" points="136.6207,-542.6453 146.6725,-545.9938 140.9028,-537.1078 136.6207,-542.6453"/>
</g>
<!-- dscf -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node3" class="node">
<title>dscf</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-528 149.5,-528 149.5,-504 203.5,-504 203.5,-528"/>
<text text-anchor="middle" x="176.5" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">dscf</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;dscf -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge1" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;dscf</title>
<path fill="none" stroke="#000000" d="M51.9695,-297.239C58.1743,-332.2296 80.3118,-434.0806 136,-495 137.5197,-496.6624 139.2015,-498.2146 140.9906,-499.6606"/>
<polygon fill="#000000" stroke="#000000" points="139.1118,-502.6154 149.3524,-505.3323 143.0412,-496.8223 139.1118,-502.6154"/>
</g>
<!-- globalize_sum -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node4" class="node">
<title>globalize_sum</title>
<polygon fill="#777777" stroke="#777777" points="217,-486 136,-486 136,-462 217,-462 217,-486"/>
<text text-anchor="middle" x="176.5" y="-471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">globalize_sum</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;globalize_sum -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge3" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;globalize_sum</title>
<path fill="none" stroke="#000000" d="M53.3684,-297.1132C62.238,-327.0668 88.8587,-405.6116 136,-453 137.0473,-454.0528 138.1585,-455.0641 139.3186,-456.0342"/>
<polygon fill="#000000" stroke="#000000" points="137.3411,-458.9226 147.5251,-461.8446 141.3861,-453.2096 137.3411,-458.9226"/>
</g>
<!-- hubbard_term -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node5" class="node">
<title>hubbard_term</title>
<polygon fill="#777777" stroke="#777777" points="216.5,-444 136.5,-444 136.5,-420 216.5,-420 216.5,-444"/>
<text text-anchor="middle" x="176.5" y="-429.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">hubbard_term</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;hubbard_term -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge5" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;hubbard_term</title>
<path fill="none" stroke="#000000" d="M55.7379,-297.2184C67.6813,-321.5695 97.3478,-376.7477 136,-411 137.3041,-412.1556 138.6831,-413.2677 140.1146,-414.3353"/>
<polygon fill="#000000" stroke="#000000" points="138.442,-417.423 148.73,-419.9544 142.2661,-411.5598 138.442,-417.423"/>
</g>
<!-- re_alloc -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node6" class="node">
<title>re_alloc</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-402 149.5,-402 149.5,-378 203.5,-378 203.5,-402"/>
<text text-anchor="middle" x="176.5" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">re_alloc</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;re_alloc -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge4" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M60.4438,-297.286C75.7417,-314.7644 105.725,-347.1113 136,-369 137.8252,-370.3196 139.7447,-371.6052 141.715,-372.8481"/>
<polygon fill="#000000" stroke="#000000" points="140.1419,-375.9823 150.5436,-377.9961 143.668,-369.9353 140.1419,-375.9823"/>
</g>
<!-- bye -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node7" class="node">
<title>bye</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-360 149.5,-360 149.5,-336 203.5,-336 203.5,-360"/>
<text text-anchor="middle" x="176.5" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">bye</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;bye -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge6" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;bye</title>
<path fill="none" stroke="#000000" d="M74.3905,-297.147C93.9032,-306.8648 121.472,-320.5948 143.0461,-331.3391"/>
<polygon fill="#000000" stroke="#000000" points="141.6727,-334.5652 152.1844,-335.8903 144.7934,-328.2993 141.6727,-334.5652"/>
</g>
<!-- dhscf -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node8" class="node">
<title>dhscf</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-318 149.5,-318 149.5,-294 203.5,-294 203.5,-318"/>
<text text-anchor="middle" x="176.5" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">dhscf</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;dhscf -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge7" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;dhscf</title>
<path fill="none" stroke="#000000" d="M100.3596,-293.3601C113.2558,-295.501 126.8985,-297.7658 139.0186,-299.7778"/>
<polygon fill="#000000" stroke="#000000" points="138.7823,-303.2864 149.2205,-301.4714 139.9287,-296.3809 138.7823,-303.2864"/>
</g>
<!-- timer -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node9" class="node">
<title>timer</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-276 149.5,-276 149.5,-252 203.5,-252 203.5,-276"/>
<text text-anchor="middle" x="176.5" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">timer</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;timer -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge8" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M100.3596,-276.6399C113.2558,-274.499 126.8985,-272.2342 139.0186,-270.2222"/>
<polygon fill="#000000" stroke="#000000" points="139.9287,-273.6191 149.2205,-268.5286 138.7823,-266.7136 139.9287,-273.6191"/>
</g>
<!-- h -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node10" class="node">
<title>h</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-234 149.5,-234 149.5,-210 203.5,-210 203.5,-234"/>
<text text-anchor="middle" x="176.5" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">h</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;h -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge9" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;h</title>
<path fill="none" stroke="#000000" d="M74.3905,-272.853C93.9032,-263.1352 121.472,-249.4052 143.0461,-238.6609"/>
<polygon fill="#000000" stroke="#000000" points="144.7934,-241.7007 152.1844,-234.1097 141.6727,-235.4348 144.7934,-241.7007"/>
</g>
<!-- de_alloc -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node11" class="node">
<title>de_alloc</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-192 149.5,-192 149.5,-168 203.5,-168 203.5,-192"/>
<text text-anchor="middle" x="176.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">de_alloc</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;de_alloc -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge10" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M60.4438,-272.714C75.7417,-255.2356 105.725,-222.8887 136,-201 137.8252,-199.6804 139.7447,-198.3948 141.715,-197.1519"/>
<polygon fill="#000000" stroke="#000000" points="143.668,-200.0647 150.5436,-192.0039 140.1419,-194.0177 143.668,-200.0647"/>
</g>
<!-- hold -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node12" class="node">
<title>hold</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-150 149.5,-150 149.5,-126 203.5,-126 203.5,-150"/>
<text text-anchor="middle" x="176.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">hold</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;hold -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge11" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;hold</title>
<path fill="none" stroke="#000000" d="M55.7379,-272.7816C67.6813,-248.4305 97.3478,-193.2523 136,-159 137.4671,-157.6999 139.0291,-156.4549 140.6539,-155.2665"/>
<polygon fill="#000000" stroke="#000000" points="142.6336,-158.1547 149.1529,-149.8031 138.8484,-152.2664 142.6336,-158.1547"/>
</g>
<!-- write_hsx -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node13" class="node">
<title>write_hsx</title>
<polygon fill="#777777" stroke="#777777" points="205.5,-108 147.5,-108 147.5,-84 205.5,-84 205.5,-108"/>
<text text-anchor="middle" x="176.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">write_hsx</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;write_hsx -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge12" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;write_hsx</title>
<path fill="none" stroke="#000000" d="M53.3684,-272.8868C62.238,-242.9332 88.8587,-164.3884 136,-117 137.0473,-115.9472 138.1585,-114.9359 139.3186,-113.9658"/>
<polygon fill="#000000" stroke="#000000" points="141.3861,-116.7904 147.5251,-108.1554 137.3411,-111.0774 141.3861,-116.7904"/>
</g>
<!-- die -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node14" class="node">
<title>die</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-66 149.5,-66 149.5,-42 203.5,-42 203.5,-66"/>
<text text-anchor="middle" x="176.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">die</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;die -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge13" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;die</title>
<path fill="none" stroke="#000000" d="M51.9695,-272.761C58.1743,-237.7704 80.3118,-135.9194 136,-75 137.5197,-73.3376 139.2015,-71.7854 140.9906,-70.3394"/>
<polygon fill="#000000" stroke="#000000" points="143.0412,-73.1777 149.3524,-64.6677 139.1118,-67.3846 143.0412,-73.1777"/>
</g>
<!-- val -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node15" class="node">
<title>val</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-24 149.5,-24 149.5,0 203.5,0 203.5,-24"/>
<text text-anchor="middle" x="176.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">val</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;val -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge14" class="edge">
<title>proc~setup_hamiltonian&#45;&gt;val</title>
<path fill="none" stroke="#000000" d="M50.9739,-272.9314C54.7289,-233.6982 71.4666,-107.9798 136,-33 137.4693,-31.2929 139.1119,-29.7059 140.8712,-28.2334"/>
<polygon fill="#000000" stroke="#000000" points="142.9293,-31.0655 149.156,-22.4935 138.9428,-25.3116 142.9293,-31.0655"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,0 64,0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,0 136,0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,0 209.5,0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,0 364,0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,0 436,0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="551.5,-24 454.5,-24 454.5,0 551.5,0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
     
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Called by</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: proc~~setup_hamiltonian~~CalledByGraph Pages: 1 -->
<svg id="procsetup_hamiltonianCalledByGraph" width="220pt" height="32pt"
 viewBox="0.00 0.00 220.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~setup_hamiltonian~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>proc~~setup_hamiltonian~~CalledByGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 216,-28 216,4 -4,4"/>
<!-- proc~setup_hamiltonian -->
<g id="proc~~setup_hamiltonian~~CalledByGraph_node1" class="node">
<title>proc~setup_hamiltonian</title>
<polygon fill="none" stroke="#000000" points="212,-24 112,-24 112,0 212,0 212,-24"/>
<text text-anchor="middle" x="162" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">setup_hamiltonian</text>
</g>
<!-- proc~siesta_forces -->
<g id="proc~~setup_hamiltonian~~CalledByGraph_node2" class="node">
<title>proc~siesta_forces</title>
<g id="a_proc~~setup_hamiltonian~~CalledByGraph_node2"><a xlink:href=".././proc/siesta_forces.html" xlink:title="siesta_forces">
<polygon fill="#d9534f" stroke="#d9534f" points="76,-24 0,-24 0,0 76,0 76,-24"/>
<text text-anchor="middle" x="38" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">siesta_forces</text>
</a>
</g>
</g>
<!-- proc~siesta_forces&#45;&gt;proc~setup_hamiltonian -->
<g id="proc~~setup_hamiltonian~~CalledByGraph_edge1" class="edge">
<title>proc~siesta_forces&#45;&gt;proc~setup_hamiltonian</title>
<path fill="none" stroke="#000000" d="M76.2159,-12C84.297,-12 93.0136,-12 101.6862,-12"/>
<polygon fill="#000000" stroke="#000000" points="101.8061,-15.5001 111.806,-12 101.806,-8.5001 101.8061,-15.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,0 64,0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,0 136,0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,0 209.5,0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,0 364,0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,0 436,0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="551.5,-24 454.5,-24 454.5,0 551.5,0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/setup_hamiltonian.html#src">setup_hamiltonian</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>      <span class="k">subroutine </span><span class="n">setup_hamiltonian</span><span class="p">(</span> <span class="n">iscf</span> <span class="p">)</span>

      <span class="k">USE </span><span class="n">siesta_options</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H_kin_1D</span><span class="p">,</span> <span class="n">H_vkb_1D</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H_ldau_2D</span><span class="p">,</span> <span class="n">H_so_2D</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">listh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">maxnh</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Hold</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">Escf</span><span class="p">,</span> <span class="n">xijo</span>
      <span class="k">use </span><span class="n">class_dSpData1D</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">val</span>
      <span class="k">use </span><span class="n">class_dSpData2D</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">val</span>

      <span class="k">use </span><span class="n">siesta_geom</span>
      <span class="k">use </span><span class="n">atmfuncs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">uion</span>
      <span class="k">use </span><span class="n">atomlist</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">no_u</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphkb</span><span class="p">,</span> <span class="n">qtot</span><span class="p">,</span> <span class="n">indxuo</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span> 
     <span class="p">.</span>                    <span class="n">lastkb</span><span class="p">,</span> <span class="n">no_s</span><span class="p">,</span> <span class="n">rmaxv</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">lasto</span><span class="p">,</span>
     <span class="p">.</span>                    <span class="n">rmaxo</span><span class="p">,</span> <span class="n">no_l</span>
      <span class="k">use </span><span class="n">metaforce</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">lMetaForce</span><span class="p">,</span> <span class="n">meta</span>
      <span class="k">use </span><span class="n">molecularmechanics</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">twobody</span>
      <span class="k">use </span><span class="n">ldau_specs</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">switch_ldau</span>     <span class="c">! This variable determines whether</span>
                                              <span class="c">!   the subroutine to compute the</span>
                                              <span class="c">!   Hubbard terms should be called</span>
                                              <span class="c">!   or not</span>
      <span class="k">use </span><span class="n">m_ldau</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">hubbard_term</span>    <span class="c">! Subroutine that compute the</span>
                                              <span class="c">!   Hubbard terms</span>
      <span class="k">use </span><span class="n">m_dhscf</span><span class="p">,</span>      <span class="n">only</span><span class="p">:</span> <span class="n">dhscf</span>
      <span class="k">use </span><span class="n">m_stress</span>
      <span class="k">use </span><span class="n">m_energies</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">Node</span>
      <span class="k">use </span><span class="n">m_steps</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">istp</span>
      <span class="k">use </span><span class="n">m_ntm</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">spin</span>
      <span class="k">use </span><span class="n">m_dipol</span>
      <span class="k">use </span><span class="n">alloc</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">re_alloc</span><span class="p">,</span> <span class="n">de_alloc</span>
      <span class="k">use </span><span class="n">m_gamma</span>
      <span class="k">use </span><span class="n">m_hsx</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_hsx</span>
      <span class="k">use </span><span class="n">sys</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">die</span><span class="p">,</span> <span class="n">bye</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">want_partial_charges</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">filesOut_t</span>    <span class="c">! derived type for output file names</span>
      <span class="k">use </span><span class="n">m_rhog</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">rhog_in</span><span class="p">,</span> <span class="n">rhog</span>
<span class="cp">#ifdef MPI</span>
      <span class="k">use </span><span class="n">m_mpi_utils</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">globalize_sum</span>
<span class="cp">#endif</span>

      <span class="k">implicit none</span>
<span class="k">      </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iscf</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span>   <span class="kd">::</span> <span class="n">fal</span><span class="p">(:,:)</span>   <span class="c">! Local-node part of atomic F</span>
<span class="cp">#ifdef MPI</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">buffer1</span>
<span class="cp">#endif</span>
      <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">io</span><span class="p">,</span> <span class="k">is</span><span class="p">,</span> <span class="n">ispin</span>
      <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">ifa</span>     <span class="c">! Calc. forces?      0=&gt;no, 1=&gt;yes</span>
      <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">istr</span>    <span class="c">! Calc. stress?      0=&gt;no, 1=&gt;yes</span>
      <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">ihmat</span>   <span class="c">! Calc. hamiltonian? 0=&gt;no, 1=&gt;yes</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">g2max</span>
      <span class="k">type</span><span class="p">(</span><span class="n">filesOut_t</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">filesOut</span>  <span class="c">! blank output file names</span>
      <span class="kt">logical</span>             <span class="kd">::</span> <span class="n">use_rhog_in</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span>   <span class="kd">::</span> <span class="n">H_vkb</span><span class="p">(:),</span> <span class="n">H_kin</span><span class="p">(:),</span> <span class="n">H_ldau</span><span class="p">(:,:),</span> <span class="n">H_so</span><span class="p">(:,:)</span>

<span class="c">!------------------------------------------------------------------------- BEGIN</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;setup_H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

      <span class="c">! Nullify pointers</span>
      <span class="k">nullify</span><span class="p">(</span><span class="n">fal</span><span class="p">)</span>

<span class="c">!$OMP parallel default(shared), private(ispin,io)</span>

<span class="c">!     Save present H matrix</span>
<span class="c">!$OMP do collapse(2)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span>
         <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
            <span class="n">Hold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="n">enddo</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end do</span>

<span class="c">!$OMP single</span>
      <span class="n">H_kin</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_kin_1D</span><span class="p">)</span>
      <span class="n">H_vkb</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_vkb_1D</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>
         <span class="c">! Sadly some compilers (g95), does</span>
         <span class="c">! not allow bounds for pointer assignments :(</span>
         <span class="n">H_so</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_so_2D</span><span class="p">)</span>
      <span class="k">end if</span>
<span class="c">!$OMP end single ! keep wait</span>

      <span class="c">! We do not need to set the non-spinor components</span>
      <span class="c">! For non-colinear they are set down below,</span>
      <span class="c">! while for spin-orbit they are set to the H_so initial</span>
      <span class="c">! spin-orbit.</span>
      
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">spinor</span>
<span class="c">!$OMP do</span>
          <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
            <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">H_kin</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_vkb</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
          <span class="k">end do</span>
<span class="c">!$OMP end do nowait</span>
      <span class="k">end do</span>

<span class="k">      if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">NCol</span> <span class="p">)</span> <span class="k">then</span>

<span class="c">!$OMP do collapse(2)</span>
         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span>
            <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>
               <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0._dp</span>
            <span class="k">end do</span>
<span class="k">         end do</span>
<span class="c">!$OMP end do nowait</span>
         
      <span class="k">else if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>

<span class="c">!$OMP do collapse(2)</span>
         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span>
            <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>
               <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">end do</span>
<span class="k">         end do</span>
<span class="c">!$OMP end do nowait</span>

      <span class="k">end if</span>
         
<span class="c">! ..................</span>

<span class="c">! Non-SCF part of total energy .......................................</span>
<span class="c">! Note that these will be &quot;impure&quot; for a mixed Dscf</span>

<span class="c">! If mixing the charge, Dscf is the previous step&#39;s DM_out. Since</span>
<span class="c">! the &quot;scf&quot; components of the energy are computed with the (mixed)</span>
<span class="c">! charge, this introduces an inconsistency. In this case the energies</span>
<span class="c">! coming out of this routine need to be corrected.</span>
<span class="c">! </span>
<span class="c">!$OMP single</span>
      <span class="n">Ekin</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">Enl</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
<span class="c">!$OMP end single ! keep wait</span>
      
<span class="c">!$OMP do collapse(2), reduction(+:Ekin,Enl)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">spinor</span>
        <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
          <span class="n">Ekin</span> <span class="o">=</span> <span class="n">Ekin</span> <span class="o">+</span> <span class="n">H_kin</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">Enl</span>  <span class="o">=</span> <span class="n">Enl</span>  <span class="o">+</span> <span class="n">H_vkb</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">end do</span>
<span class="k">      end do</span>
<span class="c">!$OMP end do nowait</span>

<span class="c">!$OMP single</span>
      <span class="n">Eso</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP end single</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP do reduction(+:Eso)</span>
         <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>
            <span class="n">Eso</span> <span class="o">=</span> <span class="n">Eso</span> <span class="o">+</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
     <span class="p">.</span>           <span class="o">+</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
     <span class="p">.</span>           <span class="o">-</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
         <span class="k">end do</span>
<span class="c">!$OMP end do nowait</span>
      <span class="k">end if</span>

<span class="c">!$OMP end parallel</span>
      
<span class="cp">#ifdef MPI</span>
      <span class="c">! Global reduction of Ekin, Enl</span>
      <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Ekin</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
      <span class="n">Ekin</span> <span class="o">=</span> <span class="n">buffer1</span>
      <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Enl</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
      <span class="n">Enl</span> <span class="o">=</span> <span class="n">buffer1</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>
         <span class="c">! Global reduction of Eso </span>
         <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Eso</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
         <span class="n">Eso</span> <span class="o">=</span> <span class="n">buffer1</span>
      <span class="k">end if</span>
<span class="cp">#endif</span>

<span class="c">!     Non-SCF part of total energy</span>
      <span class="k">call </span><span class="n">update_E0</span><span class="p">()</span>

<span class="c">! Hubbard term for LDA+U: energy, forces, stress and matrix elements ....</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">switch_ldau</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">NCol</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;LDA+U cannot be used with non-colinear spin.&#39;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="k">        if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;LDA+U cannot be used with spin-orbit coupling.&#39;</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">fal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="s1">&#39;fal&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_hamiltonian&#39;</span> <span class="p">)</span>

        <span class="n">H_ldau</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_ldau_2D</span><span class="p">)</span>
        <span class="k">call </span><span class="n">hubbard_term</span><span class="p">(</span><span class="n">scell</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="n">na_s</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span>
     <span class="p">.</span>                    <span class="n">maxnh</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">,</span> <span class="n">lasto</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">no_u</span><span class="p">,</span> <span class="n">no_l</span><span class="p">,</span> 
     <span class="p">.</span>                    <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span>
     <span class="p">.</span>                    <span class="n">spin</span><span class="p">%</span><span class="n">spinor</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">Eldau</span><span class="p">,</span> <span class="n">DEldau</span><span class="p">,</span> <span class="n">H_ldau</span><span class="p">,</span> 
     <span class="p">.</span>                    <span class="n">fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">iscf</span><span class="p">,</span>
     <span class="p">.</span>                    <span class="n">matrix_elements_only</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span>

<span class="cp">#ifdef MPI</span>
        <span class="c">! Global reduction of energy terms</span>
        <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Eldau</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
        <span class="n">Eldau</span> <span class="o">=</span> <span class="n">buffer1</span>
        <span class="c">! DEldau should not be globalized</span>
        <span class="c">! as it is based on globalized occupations</span>
<span class="cp">#endif</span>
        <span class="n">Eldau</span> <span class="o">=</span> <span class="n">Eldau</span> <span class="o">+</span> <span class="n">DEldau</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">fal</span><span class="p">,</span> <span class="s1">&#39;fal&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_hamiltonian&#39;</span> <span class="p">)</span> 
      <span class="n">endif</span>
<span class="c">! ..................</span>


<span class="c">! Add SCF contribution to energy and matrix elements ..................</span>
      <span class="n">g2max</span> <span class="o">=</span> <span class="n">g2cut</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">fal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="s1">&#39;fal&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_hamiltonian&#39;</span> <span class="p">)</span>

      <span class="n">ifa</span>  <span class="o">=</span> <span class="mi">0</span>
      <span class="n">istr</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ihmat</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">hirshpop</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">voropop</span><span class="p">)</span>
     <span class="err">$</span>     <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">partial_charges_at_every_scf_step</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         </span><span class="n">want_partial_charges</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
      <span class="n">endif</span>
      <span class="n">use_rhog_in</span> <span class="o">=</span>  <span class="p">(</span><span class="n">mix_charge</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">iscf</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  
      <span class="k">call </span><span class="n">dhscf</span><span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">Grid</span><span class="p">,</span> <span class="n">no_s</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">no_l</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">no_u</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="n">na_s</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> 
     <span class="p">.</span>            <span class="n">ntm</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">ihmat</span><span class="p">,</span> <span class="n">filesOut</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">maxnh</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">Datm</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">maxnh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">Enaatm</span><span class="p">,</span> <span class="n">Enascf</span><span class="p">,</span> <span class="n">Uatm</span><span class="p">,</span> <span class="n">Uscf</span><span class="p">,</span> <span class="n">DUscf</span><span class="p">,</span> <span class="n">DUext</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">Exc</span><span class="p">,</span> <span class="n">Dxc</span><span class="p">,</span> <span class="n">dipol</span><span class="p">,</span> <span class="n">stress</span><span class="p">,</span> <span class="n">fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">use_rhog_in</span><span class="p">)</span>

      <span class="c">! This statement will apply to iscf = 1, for example, when</span>
      <span class="c">! we do not use rhog_in. Rhog here is always the charge used to</span>
      <span class="c">! build H, that is, rhog_in.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mix_charge</span><span class="p">)</span> <span class="n">rhog_in</span> <span class="o">=</span> <span class="n">rhog</span>

      <span class="n">want_partial_charges</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">fal</span><span class="p">,</span> <span class="s1">&#39;fal&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_hamiltonian&#39;</span> <span class="p">)</span> 
<span class="c">!  It is wasteful to write over and over H and S, as there are</span>
<span class="c">!  no different files.</span>
<span class="c">! Save Hamiltonian and overlap matrices ............................</span>
<span class="c">! Only in HSX format now.  Use Util/HSX/hsx2hs to generate an HS file</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">savehs</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">write_coop</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">write_hsx</span><span class="p">(</span> <span class="nb">gamma</span><span class="p">,</span> <span class="n">no_u</span><span class="p">,</span> <span class="n">no_s</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">,</span> <span class="n">indxuo</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">maxnh</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">qtot</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">temp</span><span class="p">,</span> <span class="n">xijo</span><span class="p">)</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;setup_H&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="cp">#ifdef SIESTA__PEXSI</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">memory_snapshot</span><span class="p">(</span><span class="s2">&quot;after setup_H&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">h_setup_only</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>  <span class="c">! New call to close the tree</span>
         <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>
         <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;H-Setup-Only requested&quot;</span><span class="p">)</span>
         <span class="k">STOP</span>
<span class="k">      </span><span class="n">endif</span>

<span class="c">!------------------------------------------------------------------------- END</span>
      <span class="k">END subroutine </span><span class="n">setup_hamiltonian</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> SIESTA was developed by SIESTA Group</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>