<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="A first-principles materials simulation code using Density Functional Theory.">
    
    <meta name="author" content="SIESTA Group" >
    <link rel="icon" href="../favicon.png">

    <title>setup_hamiltonian &ndash; SIESTA</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">SIESTA <small>trunk-674</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
            <li><a href='../page/index.html'>Program Overview</a></li>
	    
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
		 aria-expanded="false">Contents <span class="caret"></span></a>
	      <ul class="dropdown-menu">
              
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
								
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            </ul>
            </li>

<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>setup_hamiltonian
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
	  data-placement="bottom" data-html="true"
	  title=" 4.7% of total for procedures.">138 statements</a>
     </li> 
     
     
    <li><i class="fa fa-code"></i><a href="../src/setup_hamiltonian.F"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li><a href='../sourcefile/setup_hamiltonian.f.html'>setup_hamiltonian.F</a></li>
  
     <li><a href='../module/m_setup_hamiltonian.html'>m_setup_hamiltonian</a></li>
  
     <li class="active">setup_hamiltonian</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  




















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/setup_hamiltonian.html#src">setup_hamiltonian</a>
  </div>
</div>


  <hr>
  

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allprocs-0">All Procedures</a></h3></div>
  <div id="allprocs-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../proc/compute_dm.html">compute_dm</a>
      
      <a class="list-group-item" href="../proc/current_itt.html">current_itt</a>
      
      <a class="list-group-item" href="../proc/getstackval.html">getstackval</a>
      
      <a class="list-group-item" href="../proc/inverse.html">inverse</a>
      
      <a class="list-group-item" href="../proc/is_next.html">is_next</a>
      
      <a class="list-group-item" href="../proc/mix_method.html">mix_method</a>
      
      <a class="list-group-item" href="../proc/mix_method_variant.html">mix_method_variant</a>
      
      <a class="list-group-item" href="../proc/mixer_init.html">mixer_init</a>
      
      <a class="list-group-item" href="../proc/mixers_history_init.html">mixers_history_init</a>
      
      <a class="list-group-item" href="../proc/mixers_init.html">mixers_init</a>
      
      <a class="list-group-item" href="../proc/mixers_print.html">mixers_print</a>
      
      <a class="list-group-item" href="../proc/mixers_print_block.html">mixers_print_block</a>
      
      <a class="list-group-item" href="../proc/mixers_reset.html">mixers_reset</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_history_init.html">mixers_scf_history_init</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_init.html">mixers_scf_init</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_print.html">mixers_scf_print</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_print_block.html">mixers_scf_print_block</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_reset.html">mixers_scf_reset</a>
      
      <a class="list-group-item" href="../interface/mixing.html">mixing</a>
      
      <a class="list-group-item" href="../proc/mixing_1d.html">mixing_1d</a>
      
      <a class="list-group-item" href="../proc/mixing_2d.html">mixing_2d</a>
      
      <a class="list-group-item" href="../proc/mixing_calc_next.html">mixing_calc_next</a>
      
      <a class="list-group-item" href="../proc/mixing_coeff.html">mixing_coeff</a>
      
      <a class="list-group-item" href="../proc/mixing_finalize.html">mixing_finalize</a>
      
      <a class="list-group-item" href="../proc/mixing_init.html">mixing_init</a>
      
      <a class="list-group-item" href="../proc/mixing_ncoeff.html">mixing_ncoeff</a>
      
      <a class="list-group-item" href="../proc/mixing_scf_converged.html">mixing_scf_converged</a>
      
      <a class="list-group-item" href="../proc/mixing_step.html">mixing_step</a>
      
      <a class="list-group-item" href="../proc/norm.html">norm</a>
      
      <a class="list-group-item" href="../proc/push_diff.html">push_diff</a>
      
      <a class="list-group-item" href="../proc/push_f.html">push_F</a>
      
      <a class="list-group-item" href="../proc/push_stack_data.html">push_stack_data</a>
      
      <a class="list-group-item" href="../proc/setup_h0.html">setup_H0</a>
      
      <a class="list-group-item" href="../proc/setup_hamiltonian.html">setup_hamiltonian</a>
      
      <a class="list-group-item" href="../proc/siesta_analysis.html">siesta_analysis</a>
      
      <a class="list-group-item" href="../proc/siesta_forces.html">siesta_forces</a>
      
      <a class="list-group-item" href="../proc/stack_check.html">stack_check</a>
      
      <a class="list-group-item" href="../proc/state_analysis.html">state_analysis</a>
      
      <a class="list-group-item" href="../proc/state_init.html">state_init</a>
      
      <a class="list-group-item" href="../proc/svd.html">svd</a>
      
      <a class="list-group-item" href="../proc/update_f.html">update_F</a>
      
    </div>
  </div>
</div>


</div>  

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine setup_hamiltonian(iscf)
    
    
	 
</h2>
    
  
    <div class="panel panel-default">
      <div class="panel-heading">
	<h3 class="panel-title">Uses</h3>
      </div>
      <ul class="list-group">
      
      <li class="list-group-item">
	<ul class="list-inline">
	  
	  <li>siesta_options</li>
	  
	  <li>sparse_matrices</li>
	  
	  <li>sparse_matrices</li>
	  
	  <li>sparse_matrices</li>
	  
	  <li>sparse_matrices</li>
	  
	  <li>sparse_matrices</li>
	  
	  <li>class_dSpData1D</li>
	  
	  <li>class_dSpData2D</li>
	  
	  <li>siesta_geom</li>
	  
	  <li>atmfuncs</li>
	  
	  <li>atomlist</li>
	  
	  <li>metaforce</li>
	  
	  <li>molecularmechanics</li>
	  
	  <li>ldau_specs</li>
	  
	  <li>m_ldau</li>
	  
	  <li>m_dhscf</li>
	  
	  <li>m_stress</li>
	  
	  <li>m_energies</li>
	  
	  <li>parallel</li>
	  
	  <li>m_steps</li>
	  
	  <li>m_ntm</li>
	  
	  <li>m_spin</li>
	  
	  <li>m_dipol</li>
	  
	  <li>alloc</li>
	  
	  <li>m_gamma</li>
	  
	  <li>m_hsx</li>
	  
	  <li>sys</li>
	  
	  <li>m_partial_charges</li>
	  
	  <li>files</li>
	  
	  <li>m_rhog</li>
	  
	  <li>m_mpi_utils</li>
	  
	</ul>
      </li>
      
      
      
      <li class="list-group-item">
	<div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~setup_hamiltonian~~UsesGraph Pages: 1 -->
<svg id="procsetup_hamiltonianUsesGraph" width="254pt" height="1124pt"
 viewBox="0.00 0.00 254.00 1124.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~setup_hamiltonian~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 1120)">
<title>proc~~setup_hamiltonian~~UsesGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1120 250,-1120 250,4 -4,4"/>
<!-- proc~setup_hamiltonian -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node1" class="node"><title>proc~setup_hamiltonian</title>
<polygon fill="none" stroke="black" points="246,-570 146,-570 146,-546 246,-546 246,-570"/>
<text text-anchor="middle" x="196" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50">setup_hamiltonian</text>
</g>
<!-- alloc -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node2" class="node"><title>alloc</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-1116 28,-1116 28,-1092 82,-1092 82,-1116"/>
<text text-anchor="middle" x="55" y="-1101.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">alloc</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;alloc -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge1" class="edge"><title>proc~setup_hamiltonian&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.63,-570.127C192.243,-640.899 176.929,-1000.27 110,-1083 105.259,-1088.86 98.6664,-1093.09 91.7126,-1096.14"/>
<polygon fill="#000000" stroke="#000000" points="90.3523,-1092.91 82.1461,-1099.61 92.7403,-1099.49 90.3523,-1092.91"/>
</g>
<!-- m_dhscf -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node3" class="node"><title>m_dhscf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-1074 28,-1074 28,-1050 82,-1050 82,-1074"/>
<text text-anchor="middle" x="55" y="-1059.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_dhscf</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_dhscf -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge2" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_dhscf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.448,-570.027C191.143,-637.182 171.968,-965.465 110,-1041 105.219,-1046.83 98.6099,-1051.04 91.6526,-1054.09"/>
<polygon fill="#000000" stroke="#000000" points="90.293,-1050.86 82.0886,-1057.56 92.6827,-1057.44 90.293,-1050.86"/>
</g>
<!-- m_energies -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node4" class="node"><title>m_energies</title>
<polygon fill="#337ab7" stroke="#337ab7" points="89.5,-1032 20.5,-1032 20.5,-1008 89.5,-1008 89.5,-1032"/>
<text text-anchor="middle" x="55" y="-1017.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_energies</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_energies -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge3" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_energies</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.215,-570.223C189.877,-634.261 166.933,-930.738 110,-999 106.863,-1002.76 102.966,-1005.85 98.7119,-1008.39"/>
<polygon fill="#000000" stroke="#000000" points="97.0383,-1005.31 89.6061,-1012.86 100.125,-1011.59 97.0383,-1005.31"/>
</g>
<!-- m_ntm -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node5" class="node"><title>m_ntm</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-990 28,-990 28,-966 82,-966 82,-990"/>
<text text-anchor="middle" x="55" y="-975.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ntm</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_ntm -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge4" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_ntm</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.944,-570.24C188.517,-630.579 161.972,-895.906 110,-957 105.161,-962.689 98.5857,-966.844 91.6893,-969.877"/>
<polygon fill="#000000" stroke="#000000" points="90.3985,-966.623 82.2185,-973.356 92.8121,-973.193 90.3985,-966.623"/>
</g>
<!-- ldau_specs -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node6" class="node"><title>ldau_specs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="88.5,-948 21.5,-948 21.5,-924 88.5,-924 88.5,-948"/>
<text text-anchor="middle" x="55" y="-933.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ldau_specs</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;ldau_specs -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge5" class="edge"><title>proc~setup_hamiltonian&#45;&gt;ldau_specs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.634,-570.06C187.065,-626.139 157.09,-860.964 110,-915 106.577,-918.928 102.328,-922.126 97.7285,-924.729"/>
<polygon fill="#000000" stroke="#000000" points="96.1328,-921.612 88.5745,-929.036 99.1131,-927.946 96.1328,-921.612"/>
</g>
<!-- m_gamma -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node7" class="node"><title>m_gamma</title>
<polygon fill="#337ab7" stroke="#337ab7" points="87,-906 23,-906 23,-882 87,-882 87,-906"/>
<text text-anchor="middle" x="55" y="-891.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_gamma</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_gamma -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge6" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_gamma</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.381,-570.054C196.164,-615.796 192.885,-780.705 110,-873 106.219,-877.21 101.493,-880.583 96.4193,-883.285"/>
<polygon fill="#000000" stroke="#000000" points="94.7539,-880.195 87.04,-887.458 97.5993,-886.591 94.7539,-880.195"/>
</g>
<!-- sparse_matrices -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node8" class="node"><title>sparse_matrices</title>
<polygon fill="#337ab7" stroke="#337ab7" points="100.5,-864 9.5,-864 9.5,-840 100.5,-840 100.5,-864"/>
<text text-anchor="middle" x="55" y="-849.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">sparse_matrices</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;sparse_matrices -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge7" class="edge"><title>proc~setup_hamiltonian&#45;&gt;sparse_matrices</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.781,-570.171C193.374,-612.151 183.155,-752.61 110,-831 108.971,-832.103 107.876,-833.149 106.729,-834.141"/>
<polygon fill="#000000" stroke="#000000" points="104.662,-831.315 98.4925,-839.929 108.687,-837.043 104.662,-831.315"/>
</g>
<!-- sys -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node9" class="node"><title>sys</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-822 28,-822 28,-798 82,-798 82,-822"/>
<text text-anchor="middle" x="55" y="-807.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">sys</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;sys -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge8" class="edge"><title>proc~setup_hamiltonian&#45;&gt;sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.982,-570.13C190.189,-607.814 173.62,-724.204 110,-789 104.981,-794.112 98.5752,-798.005 91.9427,-800.961"/>
<polygon fill="#000000" stroke="#000000" points="90.3079,-797.838 82.1983,-804.656 92.7896,-804.383 90.3079,-797.838"/>
</g>
<!-- m_spin -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node10" class="node"><title>m_spin</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-780 28,-780 28,-756 82,-756 82,-780"/>
<text text-anchor="middle" x="55" y="-765.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_spin</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_spin -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge9" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M192.879,-570.007C186.463,-602.907 164.267,-695.471 110,-747 104.854,-751.886 98.4435,-755.674 91.856,-758.598"/>
<polygon fill="#000000" stroke="#000000" points="90.2937,-755.449 82.2049,-762.291 92.7953,-761.986 90.2937,-755.449"/>
</g>
<!-- m_rhog -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node11" class="node"><title>m_rhog</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-738 28,-738 28,-714 82,-714 82,-738"/>
<text text-anchor="middle" x="55" y="-723.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhog</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_rhog -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge10" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_rhog</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M191.145,-570.1C181.73,-597.807 154.986,-666.433 110,-705 104.664,-709.575 98.2176,-713.217 91.6648,-716.094"/>
<polygon fill="#000000" stroke="#000000" points="90.1747,-712.917 82.1049,-719.783 92.6945,-719.448 90.1747,-712.917"/>
</g>
<!-- m_stress -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node12" class="node"><title>m_stress</title>
<polygon fill="#337ab7" stroke="#337ab7" points="83,-696 27,-696 27,-672 83,-672 83,-696"/>
<text text-anchor="middle" x="55" y="-681.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_stress</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_stress -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge11" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_stress</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M188.141,-570.099C175.38,-591.614 145.992,-636.726 110,-663 104.775,-666.814 98.7672,-670.038 92.6996,-672.726"/>
<polygon fill="#000000" stroke="#000000" points="91.2044,-669.554 83.2197,-676.518 93.8044,-676.054 91.2044,-669.554"/>
</g>
<!-- m_hsx -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node13" class="node"><title>m_hsx</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-654 28,-654 28,-630 82,-630 82,-654"/>
<text text-anchor="middle" x="55" y="-639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_hsx</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_hsx -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge12" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_hsx</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M181.06,-570.174C164.845,-583.883 136.856,-606.176 110,-621 104.279,-624.158 97.9832,-627.066 91.7737,-629.647"/>
<polygon fill="#000000" stroke="#000000" points="90.2045,-626.503 82.1815,-633.423 92.7685,-633.017 90.2045,-626.503"/>
</g>
<!-- m_mpi_utils -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node14" class="node"><title>m_mpi_utils</title>
<polygon fill="#337ab7" stroke="#337ab7" points="90,-612 20,-612 20,-588 90,-588 90,-612"/>
<text text-anchor="middle" x="55" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_mpi_utils</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_mpi_utils -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge13" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_mpi_utils</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M155.168,-570.036C138,-575.223 117.859,-581.309 100.23,-586.636"/>
<polygon fill="#000000" stroke="#000000" points="98.7414,-583.429 90.1813,-589.672 100.766,-590.13 98.7414,-583.429"/>
</g>
<!-- m_dipol -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node15" class="node"><title>m_dipol</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-570 28,-570 28,-546 82,-546 82,-570"/>
<text text-anchor="middle" x="55" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_dipol</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_dipol -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge14" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_dipol</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M145.994,-558C128.426,-558 108.939,-558 92.6036,-558"/>
<polygon fill="#000000" stroke="#000000" points="92.3761,-554.5 82.376,-558 92.376,-561.5 92.3761,-554.5"/>
</g>
<!-- m_steps -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node16" class="node"><title>m_steps</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-528 28,-528 28,-504 82,-504 82,-528"/>
<text text-anchor="middle" x="55" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_steps</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_steps -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge27" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_steps</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M155.168,-545.964C135.22,-539.937 111.258,-532.697 91.8854,-526.843"/>
<polygon fill="#000000" stroke="#000000" points="92.8038,-523.464 82.2188,-523.922 90.779,-530.165 92.8038,-523.464"/>
</g>
<!-- class_dSpData1D -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node17" class="node"><title>class_dSpData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="103.5,-486 6.5,-486 6.5,-462 103.5,-462 103.5,-486"/>
<text text-anchor="middle" x="55" y="-471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_dSpData1D</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;class_dSpData1D -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge16" class="edge"><title>proc~setup_hamiltonian&#45;&gt;class_dSpData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M181.06,-545.826C164.845,-532.117 136.856,-509.824 110,-495 106.958,-493.321 103.753,-491.712 100.485,-490.186"/>
<polygon fill="#000000" stroke="#000000" points="101.755,-486.921 91.1916,-486.112 98.9451,-493.332 101.755,-486.921"/>
</g>
<!-- atomlist -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node18" class="node"><title>atomlist</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-444 28,-444 28,-420 82,-420 82,-444"/>
<text text-anchor="middle" x="55" y="-429.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">atomlist</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;atomlist -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge17" class="edge"><title>proc~setup_hamiltonian&#45;&gt;atomlist</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M188.141,-545.901C175.38,-524.386 145.992,-479.274 110,-453 104.432,-448.935 97.9756,-445.542 91.505,-442.752"/>
<polygon fill="#000000" stroke="#000000" points="92.705,-439.463 82.1168,-439.088 90.1598,-445.984 92.705,-439.463"/>
</g>
<!-- atmfuncs -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node19" class="node"><title>atmfuncs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="83,-402 27,-402 27,-378 83,-378 83,-402"/>
<text text-anchor="middle" x="55" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">atmfuncs</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;atmfuncs -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge18" class="edge"><title>proc~setup_hamiltonian&#45;&gt;atmfuncs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M191.145,-545.9C181.73,-518.193 154.986,-449.567 110,-411 104.988,-406.704 98.9976,-403.23 92.8591,-400.439"/>
<polygon fill="#000000" stroke="#000000" points="93.796,-397.045 83.2106,-396.597 91.206,-403.549 93.796,-397.045"/>
</g>
<!-- files -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node20" class="node"><title>files</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-360 28,-360 28,-336 82,-336 82,-360"/>
<text text-anchor="middle" x="55" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">files</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;files -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge19" class="edge"><title>proc~setup_hamiltonian&#45;&gt;files</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M192.879,-545.993C186.463,-513.093 164.267,-420.529 110,-369 104.854,-364.114 98.4435,-360.326 91.856,-357.402"/>
<polygon fill="#000000" stroke="#000000" points="92.7953,-354.014 82.2049,-353.709 90.2937,-360.551 92.7953,-354.014"/>
</g>
<!-- molecularmechanics -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node21" class="node"><title>molecularmechanics</title>
<polygon fill="#337ab7" stroke="#337ab7" points="110,-318 0,-318 0,-294 110,-294 110,-318"/>
<text text-anchor="middle" x="55" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">molecularmechanics</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;molecularmechanics -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge20" class="edge"><title>proc~setup_hamiltonian&#45;&gt;molecularmechanics</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.982,-545.87C190.189,-508.186 173.62,-391.796 110,-327 108.921,-325.901 107.778,-324.858 106.582,-323.869"/>
<polygon fill="#000000" stroke="#000000" points="108.291,-320.799 98.0489,-318.088 104.365,-326.595 108.291,-320.799"/>
</g>
<!-- metaforce -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node22" class="node"><title>metaforce</title>
<polygon fill="#337ab7" stroke="#337ab7" points="85.5,-276 24.5,-276 24.5,-252 85.5,-252 85.5,-276"/>
<text text-anchor="middle" x="55" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">metaforce</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;metaforce -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge21" class="edge"><title>proc~setup_hamiltonian&#45;&gt;metaforce</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.781,-545.829C193.374,-503.849 183.155,-363.39 110,-285 105.867,-280.571 100.691,-277.064 95.1903,-274.29"/>
<polygon fill="#000000" stroke="#000000" points="96.3269,-270.97 85.7546,-270.28 93.5891,-277.413 96.3269,-270.97"/>
</g>
<!-- siesta_options -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node23" class="node"><title>siesta_options</title>
<polygon fill="#337ab7" stroke="#337ab7" points="95.5,-234 14.5,-234 14.5,-210 95.5,-210 95.5,-234"/>
<text text-anchor="middle" x="55" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_options</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;siesta_options -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge22" class="edge"><title>proc~setup_hamiltonian&#45;&gt;siesta_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.381,-545.946C196.164,-500.204 192.885,-335.295 110,-243 108.265,-241.068 106.331,-239.312 104.256,-237.717"/>
<polygon fill="#000000" stroke="#000000" points="106.002,-234.681 95.6727,-232.323 102.278,-240.608 106.002,-234.681"/>
</g>
<!-- parallel -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node24" class="node"><title>parallel</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-192 28,-192 28,-168 82,-168 82,-192"/>
<text text-anchor="middle" x="55" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parallel</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;parallel -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge23" class="edge"><title>proc~setup_hamiltonian&#45;&gt;parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.634,-545.94C187.065,-489.861 157.09,-255.036 110,-201 105.093,-195.369 98.4899,-191.238 91.5873,-188.211"/>
<polygon fill="#000000" stroke="#000000" points="92.7136,-184.896 82.1201,-184.729 90.2973,-191.466 92.7136,-184.896"/>
</g>
<!-- m_ldau -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node25" class="node"><title>m_ldau</title>
<polygon fill="#337ab7" stroke="#337ab7" points="82,-150 28,-150 28,-126 82,-126 82,-150"/>
<text text-anchor="middle" x="55" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ldau</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_ldau -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge24" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_ldau</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M193.944,-545.76C188.517,-485.421 161.972,-220.094 110,-159 105.161,-153.311 98.5857,-149.156 91.6893,-146.123"/>
<polygon fill="#000000" stroke="#000000" points="92.8121,-142.807 82.2185,-142.644 90.3985,-149.377 92.8121,-142.807"/>
</g>
<!-- m_partial_charges -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node26" class="node"><title>m_partial_charges</title>
<polygon fill="#337ab7" stroke="#337ab7" points="105.5,-108 4.5,-108 4.5,-84 105.5,-84 105.5,-108"/>
<text text-anchor="middle" x="55" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_partial_charges</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;m_partial_charges -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge25" class="edge"><title>proc~setup_hamiltonian&#45;&gt;m_partial_charges</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.215,-545.777C189.877,-481.739 166.933,-185.262 110,-117 109.166,-116.001 108.279,-115.049 107.346,-114.142"/>
<polygon fill="#000000" stroke="#000000" points="109.472,-111.362 99.4131,-108.036 105.203,-116.909 109.472,-111.362"/>
</g>
<!-- siesta_geom -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node27" class="node"><title>siesta_geom</title>
<polygon fill="#337ab7" stroke="#337ab7" points="91.5,-66 18.5,-66 18.5,-42 91.5,-42 91.5,-66"/>
<text text-anchor="middle" x="55" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_geom</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;siesta_geom -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge26" class="edge"><title>proc~setup_hamiltonian&#45;&gt;siesta_geom</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.448,-545.973C191.143,-478.818 171.968,-150.535 110,-75 107.383,-71.8103 104.219,-69.1036 100.749,-66.8071"/>
<polygon fill="#000000" stroke="#000000" points="102.1,-63.5591 91.6352,-61.9018 98.7821,-69.7231 102.1,-63.5591"/>
</g>
<!-- class_dSpData2D -->
<g id="proc~~setup_hamiltonian~~UsesGraph_node28" class="node"><title>class_dSpData2D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="103.5,-24 6.5,-24 6.5,-0 103.5,-0 103.5,-24"/>
<text text-anchor="middle" x="55" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_dSpData2D</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;class_dSpData2D -->
<g id="proc~~setup_hamiltonian~~UsesGraph_edge15" class="edge"><title>proc~setup_hamiltonian&#45;&gt;class_dSpData2D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M194.63,-545.873C192.243,-475.101 176.929,-115.73 110,-33 109.288,-32.1202 108.535,-31.2772 107.745,-30.4694"/>
<polygon fill="#000000" stroke="#000000" points="109.777,-27.6137 99.7788,-24.1095 105.41,-33.084 109.777,-27.6137"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="490pt" height="32pt"
 viewBox="0.00 0.00 489.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 485.5,-28 485.5,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node"><title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24 0,-24 0,-0 54,-0 54,-24"/>
<text text-anchor="middle" x="27" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node"><title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="139.5,-24 72.5,-24 72.5,-0 139.5,-0 139.5,-24"/>
<text text-anchor="middle" x="106" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="222,-24 158,-24 158,-0 222,-0 222,-24"/>
<text text-anchor="middle" x="190" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="294,-24 240,-24 240,-0 294,-0 294,-24"/>
<text text-anchor="middle" x="267" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="366,-24 312,-24 312,-0 366,-0 366,-24"/>
<text text-anchor="middle" x="339" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="481.5,-24 384.5,-24 384.5,-0 481.5,-0 481.5,-24"/>
<text text-anchor="middle" x="433" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a submodule to the (sub)module which it is
    descended from. Dashed arrows point from a module or program unit to 
    modules which it uses.
    </p>
    </div></div></div></div>
      </li>
      
      </ul>
    </div>
    


    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iscf"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iscf</strong></td><td></td>
  
</tr>

</tbody>
</table>

    
    
    
    <br>
    
    
    <div class="panel panel-default">
      <div class="panel-heading">
	<h3 class="panel-title">Calls</h3>
      </div>
      <div class="panel-body">
	<div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~setup_hamiltonian~~CallsGraph Pages: 1 -->
<svg id="procsetup_hamiltonianCallsGraph" width="225pt" height="578pt"
 viewBox="0.00 0.00 225.00 578.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~setup_hamiltonian~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 574)">
<title>proc~~setup_hamiltonian~~CallsGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-574 221,-574 221,4 -4,4"/>
<!-- proc~setup_hamiltonian -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node1" class="node"><title>proc~setup_hamiltonian</title>
<polygon fill="none" stroke="black" points="100,-297 0,-297 0,-273 100,-273 100,-297"/>
<text text-anchor="middle" x="50" y="-282.6" font-family="Helvetica,sans-Serif" font-size="10.50">setup_hamiltonian</text>
</g>
<!-- h -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node2" class="node"><title>h</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-570 149.5,-570 149.5,-546 203.5,-546 203.5,-570"/>
<text text-anchor="middle" x="176.5" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">h</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;h -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge1" class="edge"><title>proc~setup_hamiltonian&#45;&gt;h</title>
<path fill="none" stroke="#000000" d="M51.9502,-297.04C55.6239,-336.186 72.0646,-461.666 136,-537 137.47,-538.732 139.12,-540.342 140.889,-541.836"/>
<polygon fill="#000000" stroke="#000000" points="139.021,-544.801 149.224,-547.657 143.029,-539.062 139.021,-544.801"/>
</g>
<!-- hubbard_term -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node3" class="node"><title>hubbard_term</title>
<polygon fill="#777777" stroke="#777777" points="216.5,-528 136.5,-528 136.5,-504 216.5,-504 216.5,-528"/>
<text text-anchor="middle" x="176.5" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">hubbard_term</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;hubbard_term -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge2" class="edge"><title>proc~setup_hamiltonian&#45;&gt;hubbard_term</title>
<path fill="none" stroke="#000000" d="M52.979,-297.461C59.1412,-332.607 80.9745,-433.93 136,-495 136.754,-495.837 137.549,-496.646 138.378,-497.428"/>
<polygon fill="#000000" stroke="#000000" points="136.52,-500.415 146.575,-503.751 140.795,-494.872 136.52,-500.415"/>
</g>
<!-- val -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node4" class="node"><title>val</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-486 149.5,-486 149.5,-462 203.5,-462 203.5,-486"/>
<text text-anchor="middle" x="176.5" y="-471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">val</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;val -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge3" class="edge"><title>proc~setup_hamiltonian&#45;&gt;val</title>
<path fill="none" stroke="#000000" d="M54.3195,-297.084C63.0638,-326.97 89.3283,-405.374 136,-453 137.427,-454.456 138.977,-455.834 140.609,-457.136"/>
<polygon fill="#000000" stroke="#000000" points="139.028,-460.292 149.271,-463.001 142.953,-454.496 139.028,-460.292"/>
</g>
<!-- die -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node5" class="node"><title>die</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-444 149.5,-444 149.5,-420 203.5,-420 203.5,-444"/>
<text text-anchor="middle" x="176.5" y="-429.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">die</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;die -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge4" class="edge"><title>proc~setup_hamiltonian&#45;&gt;die</title>
<path fill="none" stroke="#000000" d="M56.6648,-297.188C68.4577,-321.486 97.7595,-376.572 136,-411 137.472,-412.325 139.042,-413.595 140.677,-414.806"/>
<polygon fill="#000000" stroke="#000000" points="138.941,-417.852 149.231,-420.375 142.76,-411.986 138.941,-417.852"/>
</g>
<!-- dscf -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node6" class="node"><title>dscf</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-402 149.5,-402 149.5,-378 203.5,-378 203.5,-402"/>
<text text-anchor="middle" x="176.5" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dscf</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;dscf -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge5" class="edge"><title>proc~setup_hamiltonian&#45;&gt;dscf</title>
<path fill="none" stroke="#000000" d="M61.3235,-297.256C76.4449,-314.697 106.081,-346.999 136,-369 137.779,-370.308 139.651,-371.585 141.572,-372.821"/>
<polygon fill="#000000" stroke="#000000" points="139.799,-375.839 150.181,-377.952 143.383,-369.826 139.799,-375.839"/>
</g>
<!-- dhscf -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node7" class="node"><title>dhscf</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-360 149.5,-360 149.5,-336 203.5,-336 203.5,-360"/>
<text text-anchor="middle" x="176.5" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dhscf</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;dhscf -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge6" class="edge"><title>proc~setup_hamiltonian&#45;&gt;dhscf</title>
<path fill="none" stroke="#000000" d="M75.0049,-297.147C94.2091,-306.865 121.342,-320.595 142.575,-331.339"/>
<polygon fill="#000000" stroke="#000000" points="141.066,-334.498 151.569,-335.89 144.226,-328.252 141.066,-334.498"/>
</g>
<!-- timer -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node8" class="node"><title>timer</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-318 149.5,-318 149.5,-294 203.5,-294 203.5,-318"/>
<text text-anchor="middle" x="176.5" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">timer</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;timer -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge7" class="edge"><title>proc~setup_hamiltonian&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M100.206,-293.3C113.138,-295.481 126.856,-297.795 138.991,-299.842"/>
<polygon fill="#000000" stroke="#000000" points="138.744,-303.35 149.187,-301.562 139.909,-296.447 138.744,-303.35"/>
</g>
<!-- update_e0 -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node9" class="node"><title>update_e0</title>
<polygon fill="#777777" stroke="#777777" points="208.5,-276 144.5,-276 144.5,-252 208.5,-252 208.5,-276"/>
<text text-anchor="middle" x="176.5" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">update_e0</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;update_e0 -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge8" class="edge"><title>proc~setup_hamiltonian&#45;&gt;update_e0</title>
<path fill="none" stroke="#000000" d="M100.206,-276.7C111.434,-274.806 123.256,-272.812 134.119,-270.98"/>
<polygon fill="#000000" stroke="#000000" points="134.91,-274.396 144.189,-269.281 133.746,-267.493 134.91,-274.396"/>
</g>
<!-- hold -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node10" class="node"><title>hold</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-234 149.5,-234 149.5,-210 203.5,-210 203.5,-234"/>
<text text-anchor="middle" x="176.5" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">hold</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;hold -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge9" class="edge"><title>proc~setup_hamiltonian&#45;&gt;hold</title>
<path fill="none" stroke="#000000" d="M75.0049,-272.853C94.2091,-263.135 121.342,-249.405 142.575,-238.661"/>
<polygon fill="#000000" stroke="#000000" points="144.226,-241.748 151.569,-234.11 141.066,-235.502 144.226,-241.748"/>
</g>
<!-- bye -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node11" class="node"><title>bye</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-192 149.5,-192 149.5,-168 203.5,-168 203.5,-192"/>
<text text-anchor="middle" x="176.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">bye</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;bye -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge10" class="edge"><title>proc~setup_hamiltonian&#45;&gt;bye</title>
<path fill="none" stroke="#000000" d="M61.3235,-272.744C76.4449,-255.303 106.081,-223.001 136,-201 137.779,-199.692 139.651,-198.415 141.572,-197.179"/>
<polygon fill="#000000" stroke="#000000" points="143.383,-200.174 150.181,-192.048 139.799,-194.161 143.383,-200.174"/>
</g>
<!-- write_hsx -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node12" class="node"><title>write_hsx</title>
<polygon fill="#777777" stroke="#777777" points="205.5,-150 147.5,-150 147.5,-126 205.5,-126 205.5,-150"/>
<text text-anchor="middle" x="176.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_hsx</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;write_hsx -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge11" class="edge"><title>proc~setup_hamiltonian&#45;&gt;write_hsx</title>
<path fill="none" stroke="#000000" d="M56.6648,-272.812C68.4577,-248.514 97.7595,-193.428 136,-159 137.27,-157.857 138.613,-156.755 140.008,-155.696"/>
<polygon fill="#000000" stroke="#000000" points="142.02,-158.561 148.406,-150.107 138.142,-152.734 142.02,-158.561"/>
</g>
<!-- globalize_sum -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node13" class="node"><title>globalize_sum</title>
<polygon fill="#777777" stroke="#777777" points="217,-108 136,-108 136,-84 217,-84 217,-108"/>
<text text-anchor="middle" x="176.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">globalize_sum</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;globalize_sum -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge12" class="edge"><title>proc~setup_hamiltonian&#45;&gt;globalize_sum</title>
<path fill="none" stroke="#000000" d="M54.3195,-272.916C63.0638,-243.03 89.3283,-164.626 136,-117 136.917,-116.064 137.885,-115.16 138.893,-114.288"/>
<polygon fill="#000000" stroke="#000000" points="141.199,-116.939 147.228,-108.227 137.082,-111.278 141.199,-116.939"/>
</g>
<!-- de_alloc -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node14" class="node"><title>de_alloc</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-66 149.5,-66 149.5,-42 203.5,-42 203.5,-66"/>
<text text-anchor="middle" x="176.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">de_alloc</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;de_alloc -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge13" class="edge"><title>proc~setup_hamiltonian&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M52.979,-272.539C59.1412,-237.393 80.9745,-136.07 136,-75 137.521,-73.3123 139.209,-71.7361 141.008,-70.268"/>
<polygon fill="#000000" stroke="#000000" points="143.142,-73.049 149.417,-64.5126 139.188,-67.2725 143.142,-73.049"/>
</g>
<!-- re_alloc -->
<g id="proc~~setup_hamiltonian~~CallsGraph_node15" class="node"><title>re_alloc</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-24 149.5,-24 149.5,-0 203.5,-0 203.5,-24"/>
<text text-anchor="middle" x="176.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">re_alloc</text>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;re_alloc -->
<g id="proc~~setup_hamiltonian~~CallsGraph_edge14" class="edge"><title>proc~setup_hamiltonian&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M51.9502,-272.96C55.6239,-233.814 72.0646,-108.334 136,-33 137.47,-31.268 139.12,-29.6576 140.889,-28.1637"/>
<polygon fill="#000000" stroke="#000000" points="143.029,-30.9384 149.224,-22.3435 139.021,-25.1991 143.029,-30.9384"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
     
    <div class="panel panel-default">
      <div class="panel-heading">
	<h3 class="panel-title">Called by</h3>
      </div>
      <div class="panel-body">
	<div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~setup_hamiltonian~~CalledByGraph Pages: 1 -->
<svg id="procsetup_hamiltonianCalledByGraph" width="220pt" height="32pt"
 viewBox="0.00 0.00 220.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~setup_hamiltonian~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>proc~~setup_hamiltonian~~CalledByGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 216,-28 216,4 -4,4"/>
<!-- proc~setup_hamiltonian -->
<g id="proc~~setup_hamiltonian~~CalledByGraph_node1" class="node"><title>proc~setup_hamiltonian</title>
<polygon fill="none" stroke="black" points="212,-24 112,-24 112,-0 212,-0 212,-24"/>
<text text-anchor="middle" x="162" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">setup_hamiltonian</text>
</g>
<!-- proc~siesta_forces -->
<g id="proc~~setup_hamiltonian~~CalledByGraph_node2" class="node"><title>proc~siesta_forces</title>
<g id="a_proc~~setup_hamiltonian~~CalledByGraph_node2"><a xlink:href=".././proc/siesta_forces.html" xlink:title="siesta_forces">
<polygon fill="#d9534f" stroke="#d9534f" points="76,-24 0,-24 0,-0 76,-0 76,-24"/>
<text text-anchor="middle" x="38" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_forces</text>
</a>
</g>
</g>
<!-- proc~siesta_forces&#45;&gt;proc~setup_hamiltonian -->
<g id="proc~~setup_hamiltonian~~CalledByGraph_edge1" class="edge"><title>proc~siesta_forces&#45;&gt;proc~setup_hamiltonian</title>
<path fill="none" stroke="#000000" d="M76.2669,-12C84.3255,-12 93.0387,-12 101.706,-12"/>
<polygon fill="#000000" stroke="#000000" points="101.817,-15.5001 111.817,-12 101.817,-8.5001 101.817,-15.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      




















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/setup_hamiltonian.html#src">setup_hamiltonian</a>
  </div>
</div>


    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>      <span class="k">subroutine </span><span class="n">setup_hamiltonian</span><span class="p">(</span> <span class="n">iscf</span> <span class="p">)</span>

      <span class="k">USE </span><span class="n">siesta_options</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H_kin_1D</span><span class="p">,</span> <span class="n">H_vkb_1D</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H_ldau_2D</span><span class="p">,</span> <span class="n">H_so_2D</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">listh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">maxnh</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Hold</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">Escf</span><span class="p">,</span> <span class="n">xijo</span>
      <span class="k">use </span><span class="n">class_dSpData1D</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">val</span>
      <span class="k">use </span><span class="n">class_dSpData2D</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">val</span>

      <span class="k">use </span><span class="n">siesta_geom</span>
      <span class="k">use </span><span class="n">atmfuncs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">uion</span>
      <span class="k">use </span><span class="n">atomlist</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">no_u</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphkb</span><span class="p">,</span> <span class="n">qtot</span><span class="p">,</span> <span class="n">indxuo</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span> 
     <span class="p">.</span>                    <span class="n">lastkb</span><span class="p">,</span> <span class="n">no_s</span><span class="p">,</span> <span class="n">rmaxv</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">lasto</span><span class="p">,</span>
     <span class="p">.</span>                    <span class="n">rmaxo</span><span class="p">,</span> <span class="n">no_l</span>
      <span class="k">use </span><span class="n">metaforce</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">lMetaForce</span><span class="p">,</span> <span class="n">meta</span>
      <span class="k">use </span><span class="n">molecularmechanics</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">twobody</span>
      <span class="k">use </span><span class="n">ldau_specs</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">switch_ldau</span>     <span class="c">! This variable determines whether</span>
                                              <span class="c">!   the subroutine to compute the</span>
                                              <span class="c">!   Hubbard terms should be called</span>
                                              <span class="c">!   or not</span>
      <span class="k">use </span><span class="n">m_ldau</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">hubbard_term</span>    <span class="c">! Subroutine that compute the</span>
                                              <span class="c">!   Hubbard terms</span>
      <span class="k">use </span><span class="n">m_dhscf</span><span class="p">,</span>      <span class="n">only</span><span class="p">:</span> <span class="n">dhscf</span>
      <span class="k">use </span><span class="n">m_stress</span>
      <span class="k">use </span><span class="n">m_energies</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">Node</span>
      <span class="k">use </span><span class="n">m_steps</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">istp</span>
      <span class="k">use </span><span class="n">m_ntm</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">spin</span>
      <span class="k">use </span><span class="n">m_dipol</span>
      <span class="k">use </span><span class="n">alloc</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">re_alloc</span><span class="p">,</span> <span class="n">de_alloc</span>
      <span class="k">use </span><span class="n">m_gamma</span>
      <span class="k">use </span><span class="n">m_hsx</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_hsx</span>
      <span class="k">use </span><span class="n">sys</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">die</span><span class="p">,</span> <span class="n">bye</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">want_partial_charges</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">filesOut_t</span>    <span class="c">! derived type for output file names</span>
      <span class="k">use </span><span class="n">m_rhog</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">rhog_in</span><span class="p">,</span> <span class="n">rhog</span>
<span class="cp">#ifdef MPI</span>
      <span class="k">use </span><span class="n">m_mpi_utils</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">globalize_sum</span>
<span class="cp">#endif</span>

      <span class="k">implicit none</span>
<span class="k">      </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iscf</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span>   <span class="kd">::</span> <span class="n">fal</span><span class="p">(:,:)</span>   <span class="c">! Local-node part of atomic F</span>
<span class="cp">#ifdef MPI</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">buffer1</span>
<span class="cp">#endif</span>
      <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">io</span><span class="p">,</span> <span class="k">is</span><span class="p">,</span> <span class="n">ispin</span>
      <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">ifa</span>     <span class="c">! Calc. forces?      0=&gt;no, 1=&gt;yes</span>
      <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">istr</span>    <span class="c">! Calc. stress?      0=&gt;no, 1=&gt;yes</span>
      <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">ihmat</span>   <span class="c">! Calc. hamiltonian? 0=&gt;no, 1=&gt;yes</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">g2max</span>
      <span class="k">type</span><span class="p">(</span><span class="n">filesOut_t</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">filesOut</span>  <span class="c">! blank output file names</span>
      <span class="kt">logical</span>             <span class="kd">::</span> <span class="n">use_rhog_in</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span>   <span class="kd">::</span> <span class="n">H_vkb</span><span class="p">(:),</span> <span class="n">H_kin</span><span class="p">(:),</span> <span class="n">H_ldau</span><span class="p">(:,:),</span> <span class="n">H_so</span><span class="p">(:,:)</span>

<span class="c">!------------------------------------------------------------------------- BEGIN</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;setup_H&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

      <span class="c">! Nullify pointers</span>
      <span class="k">nullify</span><span class="p">(</span><span class="n">fal</span><span class="p">)</span>

<span class="c">!$OMP parallel default(shared), private(ispin,io)</span>

<span class="c">!     Save present H matrix</span>
<span class="c">!$OMP do collapse(2)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span>
         <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
            <span class="n">Hold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="n">enddo</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end do</span>

<span class="c">!$OMP single</span>
      <span class="n">H_kin</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_kin_1D</span><span class="p">)</span>
      <span class="n">H_vkb</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_vkb_1D</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>
         <span class="c">! Sadly some compilers (g95), does</span>
         <span class="c">! not allow bounds for pointer assignments :(</span>
         <span class="n">H_so</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_so_2D</span><span class="p">)</span>
      <span class="k">end if</span>
<span class="c">!$OMP end single ! keep wait</span>

      <span class="c">! We do not need to set the non-spinor components</span>
      <span class="c">! For non-colinear they are set down below,</span>
      <span class="c">! while for spin-orbit they are set to the H_so initial</span>
      <span class="c">! spin-orbit.</span>
      
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">spinor</span>
<span class="c">!$OMP do</span>
          <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
            <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">H_kin</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_vkb</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
          <span class="k">end do</span>
<span class="c">!$OMP end do nowait</span>
      <span class="k">end do</span>

<span class="k">      if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">NCol</span> <span class="p">)</span> <span class="k">then</span>

<span class="c">!$OMP do collapse(2)</span>
         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span>
            <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>
               <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0._dp</span>
            <span class="k">end do</span>
<span class="k">         end do</span>
<span class="c">!$OMP end do nowait</span>
         
      <span class="k">else if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>

<span class="c">!$OMP do collapse(2)</span>
         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span>
            <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>
               <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">end do</span>
<span class="k">         end do</span>
<span class="c">!$OMP end do nowait</span>

      <span class="k">end if</span>
         
<span class="c">! ..................</span>

<span class="c">! Non-SCF part of total energy .......................................</span>
<span class="c">! Note that these will be &quot;impure&quot; for a mixed Dscf</span>

<span class="c">! If mixing the charge, Dscf is the previous step&#39;s DM_out. Since</span>
<span class="c">! the &quot;scf&quot; components of the energy are computed with the (mixed)</span>
<span class="c">! charge, this introduces an inconsistency. In this case the energies</span>
<span class="c">! coming out of this routine need to be corrected.</span>
<span class="c">! </span>
<span class="c">!$OMP single</span>
      <span class="n">Ekin</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">Enl</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
<span class="c">!$OMP end single ! keep wait</span>
      
<span class="c">!$OMP do collapse(2), reduction(+:Ekin,Enl)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">spinor</span>
        <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
          <span class="n">Ekin</span> <span class="o">=</span> <span class="n">Ekin</span> <span class="o">+</span> <span class="n">H_kin</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">Enl</span>  <span class="o">=</span> <span class="n">Enl</span>  <span class="o">+</span> <span class="n">H_vkb</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">end do</span>
<span class="k">      end do</span>
<span class="c">!$OMP end do nowait</span>

<span class="c">!$OMP single</span>
      <span class="n">Eso</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP end single</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP do reduction(+:Eso)</span>
         <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>
            <span class="n">Eso</span> <span class="o">=</span> <span class="n">Eso</span> <span class="o">+</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
     <span class="p">.</span>           <span class="o">+</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
     <span class="p">.</span>           <span class="o">-</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">H_so</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
         <span class="k">end do</span>
<span class="c">!$OMP end do nowait</span>
      <span class="k">end if</span>

<span class="c">!$OMP end parallel</span>
      
<span class="cp">#ifdef MPI</span>
      <span class="c">! Global reduction of Ekin, Enl</span>
      <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Ekin</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
      <span class="n">Ekin</span> <span class="o">=</span> <span class="n">buffer1</span>
      <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Enl</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
      <span class="n">Enl</span> <span class="o">=</span> <span class="n">buffer1</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>
         <span class="c">! Global reduction of Eso </span>
         <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Eso</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
         <span class="n">Eso</span> <span class="o">=</span> <span class="n">buffer1</span>
      <span class="k">end if</span>
<span class="cp">#endif</span>

<span class="c">!     Non-SCF part of total energy</span>
      <span class="k">call </span><span class="n">update_E0</span><span class="p">()</span>

<span class="c">! Hubbard term for LDA+U: energy, forces, stress and matrix elements ....</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">switch_ldau</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">NCol</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;LDA+U cannot be used with non-colinear spin.&#39;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="k">        if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;LDA+U cannot be used with spin-orbit coupling.&#39;</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">fal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="s1">&#39;fal&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_hamiltonian&#39;</span> <span class="p">)</span>

        <span class="n">H_ldau</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_ldau_2D</span><span class="p">)</span>
        <span class="k">call </span><span class="n">hubbard_term</span><span class="p">(</span><span class="n">scell</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="n">na_s</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span>
     <span class="p">.</span>                    <span class="n">maxnh</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">,</span> <span class="n">lasto</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">no_u</span><span class="p">,</span> <span class="n">no_l</span><span class="p">,</span> 
     <span class="p">.</span>                    <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span>
     <span class="p">.</span>                    <span class="n">spin</span><span class="p">%</span><span class="n">spinor</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">Eldau</span><span class="p">,</span> <span class="n">DEldau</span><span class="p">,</span> <span class="n">H_ldau</span><span class="p">,</span> 
     <span class="p">.</span>                    <span class="n">fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">iscf</span><span class="p">,</span>
     <span class="p">.</span>                    <span class="n">matrix_elements_only</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.)</span>

<span class="cp">#ifdef MPI</span>
        <span class="c">! Global reduction of energy terms</span>
        <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Eldau</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
        <span class="n">Eldau</span> <span class="o">=</span> <span class="n">buffer1</span>
        <span class="c">! DEldau should not be globalized</span>
        <span class="c">! as it is based on globalized occupations</span>
<span class="cp">#endif</span>
        <span class="n">Eldau</span> <span class="o">=</span> <span class="n">Eldau</span> <span class="o">+</span> <span class="n">DEldau</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">fal</span><span class="p">,</span> <span class="s1">&#39;fal&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_hamiltonian&#39;</span> <span class="p">)</span> 
      <span class="n">endif</span>
<span class="c">! ..................</span>


<span class="c">! Add SCF contribution to energy and matrix elements ..................</span>
      <span class="n">g2max</span> <span class="o">=</span> <span class="n">g2cut</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">fal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="s1">&#39;fal&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_hamiltonian&#39;</span> <span class="p">)</span>

      <span class="n">ifa</span>  <span class="o">=</span> <span class="mi">0</span>
      <span class="n">istr</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ihmat</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">hirshpop</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">voropop</span><span class="p">)</span>
     <span class="err">$</span>     <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">partial_charges_at_every_scf_step</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         </span><span class="n">want_partial_charges</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>
      <span class="n">endif</span>
      <span class="n">use_rhog_in</span> <span class="o">=</span>  <span class="p">(</span><span class="n">mix_charge</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">iscf</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
  
      <span class="k">call </span><span class="n">dhscf</span><span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">Grid</span><span class="p">,</span> <span class="n">no_s</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">no_l</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">no_u</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="n">na_s</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> 
     <span class="p">.</span>            <span class="n">ntm</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">ihmat</span><span class="p">,</span> <span class="n">filesOut</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">maxnh</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">Datm</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">maxnh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">Enaatm</span><span class="p">,</span> <span class="n">Enascf</span><span class="p">,</span> <span class="n">Uatm</span><span class="p">,</span> <span class="n">Uscf</span><span class="p">,</span> <span class="n">DUscf</span><span class="p">,</span> <span class="n">DUext</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">Exc</span><span class="p">,</span> <span class="n">Dxc</span><span class="p">,</span> <span class="n">dipol</span><span class="p">,</span> <span class="n">stress</span><span class="p">,</span> <span class="n">fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span>
     <span class="p">.</span>            <span class="n">use_rhog_in</span><span class="p">)</span>

      <span class="c">! This statement will apply to iscf = 1, for example, when</span>
      <span class="c">! we do not use rhog_in. Rhog here is always the charge used to</span>
      <span class="c">! build H, that is, rhog_in.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mix_charge</span><span class="p">)</span> <span class="n">rhog_in</span> <span class="o">=</span> <span class="n">rhog</span>

      <span class="n">want_partial_charges</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">fal</span><span class="p">,</span> <span class="s1">&#39;fal&#39;</span><span class="p">,</span> <span class="s1">&#39;setup_hamiltonian&#39;</span> <span class="p">)</span> 
<span class="c">!  It is wasteful to write over and over H and S, as there are</span>
<span class="c">!  no different files.</span>
<span class="c">! Save Hamiltonian and overlap matrices ............................</span>
<span class="c">! Only in HSX format now.  Use Util/HSX/hsx2hs to generate an HS file</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">savehs</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">write_coop</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">write_hsx</span><span class="p">(</span> <span class="nb">gamma</span><span class="p">,</span> <span class="n">no_u</span><span class="p">,</span> <span class="n">no_s</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">,</span> <span class="n">indxuo</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">maxnh</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">qtot</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">temp</span><span class="p">,</span> <span class="n">xijo</span><span class="p">)</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;setup_H&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="cp">#ifdef SIESTA__PEXSI</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">memory_snapshot</span><span class="p">(</span><span class="s2">&quot;after setup_H&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">h_setup_only</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>  <span class="c">! New call to close the tree</span>
         <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>
         <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;H-Setup-Only requested&quot;</span><span class="p">)</span>
         <span class="k">STOP</span>
<span class="k">      </span><span class="n">endif</span>

<span class="c">!------------------------------------------------------------------------- END</span>
      <span class="k">END subroutine </span><span class="n">setup_hamiltonian</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>

  <section class="visible-xs visible-sm hidden-md">
    <hr>
    

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allprocs-1">All Procedures</a></h3></div>
  <div id="allprocs-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../proc/compute_dm.html">compute_dm</a>
      
      <a class="list-group-item" href="../proc/current_itt.html">current_itt</a>
      
      <a class="list-group-item" href="../proc/getstackval.html">getstackval</a>
      
      <a class="list-group-item" href="../proc/inverse.html">inverse</a>
      
      <a class="list-group-item" href="../proc/is_next.html">is_next</a>
      
      <a class="list-group-item" href="../proc/mix_method.html">mix_method</a>
      
      <a class="list-group-item" href="../proc/mix_method_variant.html">mix_method_variant</a>
      
      <a class="list-group-item" href="../proc/mixer_init.html">mixer_init</a>
      
      <a class="list-group-item" href="../proc/mixers_history_init.html">mixers_history_init</a>
      
      <a class="list-group-item" href="../proc/mixers_init.html">mixers_init</a>
      
      <a class="list-group-item" href="../proc/mixers_print.html">mixers_print</a>
      
      <a class="list-group-item" href="../proc/mixers_print_block.html">mixers_print_block</a>
      
      <a class="list-group-item" href="../proc/mixers_reset.html">mixers_reset</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_history_init.html">mixers_scf_history_init</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_init.html">mixers_scf_init</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_print.html">mixers_scf_print</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_print_block.html">mixers_scf_print_block</a>
      
      <a class="list-group-item" href="../proc/mixers_scf_reset.html">mixers_scf_reset</a>
      
      <a class="list-group-item" href="../interface/mixing.html">mixing</a>
      
      <a class="list-group-item" href="../proc/mixing_1d.html">mixing_1d</a>
      
      <a class="list-group-item" href="../proc/mixing_2d.html">mixing_2d</a>
      
      <a class="list-group-item" href="../proc/mixing_calc_next.html">mixing_calc_next</a>
      
      <a class="list-group-item" href="../proc/mixing_coeff.html">mixing_coeff</a>
      
      <a class="list-group-item" href="../proc/mixing_finalize.html">mixing_finalize</a>
      
      <a class="list-group-item" href="../proc/mixing_init.html">mixing_init</a>
      
      <a class="list-group-item" href="../proc/mixing_ncoeff.html">mixing_ncoeff</a>
      
      <a class="list-group-item" href="../proc/mixing_scf_converged.html">mixing_scf_converged</a>
      
      <a class="list-group-item" href="../proc/mixing_step.html">mixing_step</a>
      
      <a class="list-group-item" href="../proc/norm.html">norm</a>
      
      <a class="list-group-item" href="../proc/push_diff.html">push_diff</a>
      
      <a class="list-group-item" href="../proc/push_f.html">push_F</a>
      
      <a class="list-group-item" href="../proc/push_stack_data.html">push_stack_data</a>
      
      <a class="list-group-item" href="../proc/setup_h0.html">setup_H0</a>
      
      <a class="list-group-item" href="../proc/setup_hamiltonian.html">setup_hamiltonian</a>
      
      <a class="list-group-item" href="../proc/siesta_analysis.html">siesta_analysis</a>
      
      <a class="list-group-item" href="../proc/siesta_forces.html">siesta_forces</a>
      
      <a class="list-group-item" href="../proc/stack_check.html">stack_check</a>
      
      <a class="list-group-item" href="../proc/state_analysis.html">state_analysis</a>
      
      <a class="list-group-item" href="../proc/state_init.html">state_init</a>
      
      <a class="list-group-item" href="../proc/svd.html">svd</a>
      
      <a class="list-group-item" href="../proc/update_f.html">update_F</a>
      
    </div>
  </div>
</div>


  </section>

    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> SIESTA was developed by SIESTA Group</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>