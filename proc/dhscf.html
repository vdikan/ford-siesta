<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A first-principles materials simulation code using Density Functional Theory.">
    
    <meta name="author" content="SIESTA Group" >
    <link rel="icon" href="../favicon.png">

    <title>dhscf &ndash; SIESTA</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">SIESTA <small>trunk-700--vdikan-edens-704-ford-68</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Program Overview</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>dhscf
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title="10.2% of total for procedures.">626 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/dhscf.F"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/dhscf.f.html'>dhscf.F</a></li>
    
     <li><a href='../module/m_dhscf.html'>m_dhscf</a></li>
    
  
     <li class="active">dhscf</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/dhscf.html#src">dhscf</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine dhscf(nspin, norb, iaorb, iphorb, nuo, nuotot, nua, na, isa, xa, indxua, ntm, ifa, istr, iHmat, filesOut, maxnd, numd, listdptr, listd, Dscf, datm, maxnh, Hmat, Enaatm, Enascf, Uatm, Uscf, DUscf, DUext, Exc, Dxc, dipol, stress, Fal, stressl, use_rhog_in, charge_density_only)
    
    
   
</h2>
    
  
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Uses</h3>
      </div>
      <ul class="list-group">
      
      <li class="list-group-item">
  <ul class="list-inline">
    
    <li>precision</li>
    
    <li>parallel</li>
    
    <li>parallel</li>
    
    <li>atmfuncs</li>
    
    <li>units</li>
    
    <li>fdf</li>
    
    <li>sys</li>
    
    <li>mesh</li>
    
    <li>parsing</li>
    
    <li>m_iorho</li>
    
    <li>m_forhar</li>
    
    <li>alloc</li>
    
    <li>files</li>
    
    <li>files</li>
    
    <li>siesta_options</li>
    
    <li>siesta_options</li>
    
    <li>meshsubs</li>
    
    <li>meshsubs</li>
    
    <li>meshsubs</li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li>m_partial_charges</li>
    
    <li>m_partial_charges</li>
    
    <li>siestaXC</li>
    
    <li>siestaXC</li>
    
    <li>siestaXC</li>
    
    <li>m_vmat</li>
    
    <li>m_rhoofd</li>
    
    <li>mpi_siesta</li>
    
    <li>iogrid_netcdf</li>
    
    <li>iogrid_netcdf</li>
    
    <li>siesta_options</li>
    
    <li>siesta_options</li>
    
    <li>siesta_options</li>
    
    <li>siesta_options</li>
    
    <li>m_efield</li>
    
    <li>m_efield</li>
    
    <li>m_efield</li>
    
    <li>m_doping_uniform</li>
    
    <li>m_charge_add</li>
    
    <li>m_hartree_add</li>
    
    <li>siesta_options</li>
    
    <li>m_ncdf_siesta</li>
    
    <li>m_rhofft</li>
    
    <li>m_rhog</li>
    
    <li>m_spin</li>
    
    <li>m_spin</li>
    
    <li>m_iotddft</li>
    
    <li>m_ts_global_vars</li>
    
    <li>m_ts_options</li>
    
    <li>m_ts_voltage</li>
    
    <li>m_ts_hartree</li>
    
  </ul>
      </li>
      
      
      
      </ul>
    </div>
    


    
    <p>Use the functionality in the first block
 of the routine to get charge files and partial charges</p>
    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nspin%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nspin</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-norb%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>norb</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iaorb%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iaorb</strong>(norb)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iphorb%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iphorb</strong>(norb)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nuo%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nuo</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nuotot%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nuotot</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nua%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nua</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-na%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>na</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-isa%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>isa</strong>(na)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-xa%7E2"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>xa</strong>(3,na)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-indxua%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>indxua</strong>(na)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ntm%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>ntm</strong>(3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ifa"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>ifa</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-istr"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>istr</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ihmat"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iHmat</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-filesout"></span>type(filesOut_t)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>filesOut</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-maxnd%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>maxnd</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-numd%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>numd</strong>(nuo)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-listdptr%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>listdptr</strong>(nuo)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-listd%7E2"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>listd</strong>(*)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dscf"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Dscf</strong>(:,:)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-datm%7E2"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>datm</strong>(norb)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-maxnh"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>maxnh</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-hmat"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Hmat</strong>(:,:)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-enaatm"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Enaatm</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-enascf"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Enascf</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-uatm"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Uatm</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-uscf"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Uscf</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-duscf"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DUscf</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-duext"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DUext</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-exc"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Exc</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dxc"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Dxc</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dipol"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>dipol</strong>(3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-stress"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>stress</strong>(3,3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-fal%7E2"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Fal</strong>(3,nua)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-stressl%7E2"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>stressl</strong>(3,3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-use_rhog_in"></span>logical,</td>
  <td>intent(in),</td>
  <td>optional</td>
  
  <td></td><td>::</td>
  <td><strong>use_rhog_in</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-charge_density_only"></span>logical,</td>
  <td>intent(in),</td>
  <td>optional</td>
  
  <td></td><td>::</td>
  <td><strong>charge_density_only</strong></td><td></td>
  
</tr>

</tbody>
</table>

    
    
    
    
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/dhscf.html#src">dhscf</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>      <span class="k">subroutine </span><span class="n">dhscf</span><span class="p">(</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> 
     <span class="p">&amp;</span>                  <span class="n">nuotot</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">ntm</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">iHmat</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">filesOut</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">Enaatm</span><span class="p">,</span> <span class="n">Enascf</span><span class="p">,</span> <span class="n">Uatm</span><span class="p">,</span> <span class="n">Uscf</span><span class="p">,</span> <span class="n">DUscf</span><span class="p">,</span> <span class="n">DUext</span><span class="p">,</span> 
     <span class="p">&amp;</span>                  <span class="n">Exc</span><span class="p">,</span> <span class="n">Dxc</span><span class="p">,</span> <span class="n">dipol</span><span class="p">,</span> <span class="n">stress</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">use_rhog_in</span><span class="p">,</span> <span class="n">charge_density_only</span> <span class="p">)</span>

<span class="n">C</span>
<span class="n">C</span> <span class="n">Calculates</span> <span class="n">the</span> <span class="n">self</span><span class="o">-</span><span class="n">consistent</span> <span class="n">field</span> <span class="n">contributions</span> <span class="n">to</span> <span class="n">Hamiltonian</span>
<span class="n">C</span> <span class="n">matrix</span> <span class="n">elements</span><span class="p">,</span> <span class="n">total</span> <span class="n">energy</span> <span class="nb">and </span><span class="n">atomic</span> <span class="n">forces</span><span class="p">.</span>
<span class="n">C</span> <span class="n">Coded</span> <span class="n">by</span> <span class="n">J</span><span class="p">.</span><span class="n">M</span><span class="p">.</span> <span class="n">Soler</span><span class="p">,</span> <span class="n">August</span> <span class="mi">199</span><span class="mf">6.</span> <span class="n">July</span> <span class="mi">199</span><span class="mf">7.</span>
<span class="n">C</span> <span class="n">Modified</span> <span class="n">by</span> <span class="n">J</span><span class="p">.</span><span class="n">D</span><span class="p">.</span> <span class="n">Gale</span><span class="p">,</span> <span class="n">February</span> <span class="mi">200</span><span class="mf">0.</span>
<span class="n">C</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Input</span> <span class="p">:</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">nspin</span>         <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">different</span> <span class="n">spin</span> <span class="n">polarisations</span>
<span class="n">C</span>                         <span class="n">nspin</span><span class="o">=</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="n">Unpolarized</span><span class="p">,</span> <span class="n">nspin</span><span class="o">=</span><span class="mi">2</span> <span class="o">=&gt;</span> <span class="n">polarized</span>
<span class="n">C</span>                         <span class="n">nspin</span><span class="o">=</span><span class="mi">4</span> <span class="o">=&gt;</span> <span class="n">Noncollinear</span> <span class="n">spin</span> <span class="nb">or </span><span class="n">spin</span><span class="o">-</span><span class="n">orbit</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">norb</span>          <span class="p">:</span> <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">basis</span> <span class="n">orbitals</span> <span class="n">in</span> <span class="n">supercell</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">iaorb</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>   <span class="p">:</span> <span class="n">Atom</span> <span class="n">to</span> <span class="n">which</span> <span class="n">each</span> <span class="n">orbital</span> <span class="n">belongs</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">iphorb</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>  <span class="p">:</span> <span class="n">Orbital</span> <span class="nb">index</span> <span class="p">(</span><span class="n">within</span> <span class="n">atom</span><span class="p">)</span> <span class="n">of</span> <span class="n">each</span> <span class="n">orbital</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">nuo</span>           <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">orbitals</span> <span class="n">in</span> <span class="n">a</span> <span class="n">unit</span> <span class="n">cell</span> <span class="n">in</span> <span class="n">this</span> <span class="n">node</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">nuotot</span>        <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">orbitals</span> <span class="n">in</span> <span class="n">a</span> <span class="n">unit</span> <span class="n">cell</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">nua</span>           <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">atoms</span> <span class="n">in</span> <span class="n">unit</span> <span class="n">cell</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">na</span>            <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">atoms</span> <span class="n">in</span> <span class="n">supercell</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">isa</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>       <span class="p">:</span> <span class="n">Species</span> <span class="nb">index </span><span class="n">of</span> <span class="k">all </span><span class="n">atoms</span> <span class="n">in</span> <span class="n">supercell</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">xa</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">na</span><span class="p">)</span>      <span class="p">:</span> <span class="n">Atomic</span> <span class="n">positions</span> <span class="n">of</span> <span class="k">all </span><span class="n">atoms</span> <span class="n">in</span> <span class="n">supercell</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">indxua</span>        <span class="p">:</span> <span class="nb">Index </span><span class="n">of</span> <span class="n">equivalent</span> <span class="n">atom</span> <span class="n">in</span> <span class="n">unit</span> <span class="n">cell</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">ifa</span>           <span class="p">:</span> <span class="n">Switch</span> <span class="n">which</span> <span class="n">fixes</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">SCF</span> <span class="n">contrib</span><span class="p">.</span>
<span class="n">C</span>                         <span class="n">to</span> <span class="n">atomic</span> <span class="n">forces</span> <span class="k">is </span><span class="n">calculated</span> <span class="nb">and </span><span class="n">added</span> <span class="n">to</span> <span class="n">fa</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">istr</span>          <span class="p">:</span> <span class="n">Switch</span> <span class="n">which</span> <span class="n">fixes</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">SCF</span> <span class="n">contrib</span><span class="p">.</span>
<span class="n">C</span>                         <span class="n">to</span> <span class="n">stress</span> <span class="k">is </span><span class="n">calculated</span> <span class="nb">and </span><span class="n">added</span> <span class="n">to</span> <span class="n">stress</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">iHmat</span>         <span class="p">:</span> <span class="n">Switch</span> <span class="n">which</span> <span class="n">fixes</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">Hmat</span> <span class="n">matrix</span>
<span class="n">C</span>                         <span class="n">elements</span> <span class="n">are</span> <span class="n">calculated</span> <span class="nb">or not</span><span class="p">.</span>
<span class="n">C</span> <span class="k">type</span><span class="p">(</span><span class="n">filesOut_t</span><span class="p">)</span> <span class="n">filesOut</span> <span class="p">:</span> <span class="n">output</span> <span class="k">file </span><span class="n">names</span> <span class="p">(</span><span class="k">If </span><span class="n">blank</span> <span class="o">=&gt;</span> <span class="nb">not </span><span class="n">saved</span><span class="p">)</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">maxnd</span>             <span class="p">:</span> <span class="n">First</span> <span class="k">dimension </span><span class="n">of</span> <span class="n">listd</span> <span class="nb">and </span><span class="n">Dscf</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">numd</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>         <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">nonzero</span> <span class="n">density</span><span class="o">-</span><span class="n">matrix</span>
<span class="n">C</span>                             <span class="n">elements</span> <span class="n">for</span> <span class="n">each</span> <span class="n">matrix</span> <span class="n">row</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">listdptr</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>     <span class="p">:</span> <span class="k">Pointer </span><span class="n">to</span> <span class="n">start</span> <span class="n">of</span> <span class="n">rows</span> <span class="n">of</span> <span class="n">density</span><span class="o">-</span><span class="n">matrix</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">listd</span><span class="p">(</span><span class="n">maxnd</span><span class="p">)</span>      <span class="p">:</span> <span class="n">Nonzero</span><span class="o">-</span><span class="n">density</span><span class="o">-</span><span class="n">matrix</span><span class="o">-</span><span class="n">element</span> <span class="n">column</span>
<span class="n">C</span>                             <span class="n">indexes</span> <span class="n">for</span> <span class="n">each</span> <span class="n">matrix</span> <span class="n">row</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Dscf</span><span class="p">(</span><span class="n">maxnd</span><span class="p">,</span><span class="n">h_spin_dim</span><span class="p">):</span> <span class="n">SCF</span> <span class="n">density</span><span class="o">-</span><span class="n">matrix</span> <span class="n">elements</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">datm</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>        <span class="p">:</span> <span class="n">Harris</span> <span class="n">density</span><span class="o">-</span><span class="n">matrix</span> <span class="n">diagonal</span> <span class="n">elements</span>
<span class="n">C</span>                             <span class="p">(</span><span class="n">atomic</span> <span class="n">occupation</span> <span class="n">charges</span> <span class="n">of</span> <span class="n">orbitals</span><span class="p">)</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">maxnh</span>             <span class="p">:</span> <span class="n">First</span> <span class="k">dimension </span><span class="n">of</span> <span class="n">listh</span> <span class="nb">and </span><span class="n">Hmat</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Hmat</span><span class="p">(</span><span class="n">maxnh</span><span class="p">,</span><span class="n">h_spin_dim</span><span class="p">)</span> <span class="p">:</span> <span class="n">Hamiltonian</span> <span class="n">matrix</span> <span class="n">in</span> <span class="n">sparse</span> <span class="n">form</span><span class="p">,</span>
<span class="n">C</span>                             <span class="n">to</span> <span class="n">which</span> <span class="n">are</span> <span class="n">added</span> <span class="n">the</span> <span class="n">matrix</span> <span class="n">elements</span>
<span class="n">C</span>                                 <span class="o">&lt;</span><span class="n">ORB_I</span> <span class="err">|</span> <span class="n">DeltaV</span> <span class="err">|</span> <span class="n">ORB_J</span><span class="o">&gt;</span><span class="p">,</span> <span class="k">where</span>
<span class="n">C</span>                             <span class="n">DeltaV</span> <span class="o">=</span> <span class="n">Vna</span> <span class="o">+</span> <span class="n">Vxc</span><span class="p">(</span><span class="n">SCF</span><span class="p">)</span> <span class="o">+</span> 
<span class="n">C</span>                                      <span class="n">Vhartree</span><span class="p">(</span><span class="n">RhoSCF</span><span class="o">-</span><span class="n">RhoHarris</span><span class="p">)</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Input</span><span class="o">/</span><span class="n">output</span> <span class="p">:</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">ntm</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">mesh</span> <span class="n">divisions</span> <span class="n">of</span> <span class="n">each</span> <span class="n">cell</span>
<span class="n">C</span>                  <span class="n">vector</span><span class="p">,</span> <span class="n">including</span> <span class="n">subgrid</span><span class="p">.</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Output</span> <span class="p">:</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Enaatm</span> <span class="p">:</span> <span class="n">Integral</span> <span class="n">of</span> <span class="n">Vna</span> <span class="o">*</span> <span class="n">rhoatm</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Enascf</span> <span class="p">:</span> <span class="n">Integral</span> <span class="n">of</span> <span class="n">Vna</span> <span class="o">*</span> <span class="n">rhoscf</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Uatm</span>   <span class="p">:</span> <span class="n">Harris</span> <span class="n">hartree</span> <span class="n">electron</span><span class="o">-</span><span class="n">interaction</span> <span class="n">energy</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Uscf</span>   <span class="p">:</span> <span class="n">SCF</span> <span class="n">hartree</span> <span class="n">electron</span><span class="o">-</span><span class="n">interaction</span> <span class="n">energy</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">DUscf</span>  <span class="p">:</span> <span class="n">Electrostatic</span> <span class="p">(</span><span class="n">Hartree</span><span class="p">)</span> <span class="n">energy</span> <span class="n">of</span>
<span class="n">C</span>                    <span class="p">(</span><span class="n">rhoscf</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">)</span> <span class="n">density</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">DUext</span>  <span class="p">:</span> <span class="n">Interaction</span> <span class="n">energy</span> <span class="n">with</span> <span class="k">external </span><span class="n">electric</span> <span class="n">field</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Exc</span>    <span class="p">:</span> <span class="n">SCF</span> <span class="n">exchange</span><span class="o">-</span><span class="n">correlation</span> <span class="n">energy</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Dxc</span>    <span class="p">:</span> <span class="n">SCF</span> <span class="n">double</span><span class="o">-</span><span class="n">counting</span> <span class="n">correction</span> <span class="n">to</span> <span class="n">Exc</span>
<span class="n">C</span>                    <span class="n">Dxc</span> <span class="o">=</span> <span class="n">integral</span> <span class="n">of</span> <span class="p">(</span> <span class="p">(</span><span class="n">epsxc</span> <span class="o">-</span> <span class="n">Vxc</span><span class="p">)</span> <span class="o">*</span> <span class="n">Rho</span> <span class="p">)</span>
<span class="n">C</span>                    <span class="k">All </span><span class="n">energies</span> <span class="n">in</span> <span class="n">Rydbergs</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">dipol</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> <span class="n">Electric</span> <span class="n">dipole</span> <span class="p">(</span><span class="n">in</span> <span class="n">a</span><span class="p">.</span><span class="n">u</span><span class="p">.)</span>
<span class="n">C</span>                   <span class="n">only</span> <span class="n">when</span> <span class="n">the</span> <span class="nb">system </span><span class="k">is </span><span class="n">a</span> <span class="n">molecule</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Input</span><span class="o">/</span><span class="n">output</span> <span class="p">:</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Fal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">nua</span><span class="p">)</span> <span class="p">:</span> <span class="n">Atomic</span> <span class="n">forces</span><span class="p">,</span> <span class="n">to</span> <span class="n">which</span> <span class="n">the</span> <span class="n">SCF</span> <span class="n">contribution</span>
<span class="n">C</span>                        <span class="k">is </span><span class="n">added</span> <span class="n">by</span> <span class="n">this</span> <span class="n">routine</span> <span class="n">when</span> <span class="n">ifa</span><span class="o">=</span><span class="mf">1.</span>
<span class="n">C</span>                        <span class="n">the</span> <span class="n">SCF</span> <span class="n">contribution</span> <span class="k">is </span><span class="n">minus</span> <span class="n">the</span> <span class="n">derivative</span>
<span class="n">C</span>                        <span class="n">of</span> <span class="p">(</span> <span class="n">Enascf</span> <span class="o">-</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">DUscf</span> <span class="o">+</span> <span class="n">Exc</span> <span class="p">)</span> <span class="n">with</span>
<span class="n">C</span>                        <span class="n">respect</span> <span class="n">to</span> <span class="n">atomic</span> <span class="n">positions</span><span class="p">,</span> <span class="n">in</span>  <span class="n">Ry</span><span class="o">/</span><span class="n">Bohr</span><span class="p">.</span>
<span class="n">C</span>                        <span class="n">contributions</span> <span class="n">local</span> <span class="n">to</span> <span class="n">this</span> <span class="n">node</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span> <span class="n">Stress</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">to</span> <span class="n">which</span> <span class="n">the</span> <span class="n">SCF</span> <span class="n">contribution</span>
<span class="n">C</span>                      <span class="k">is </span><span class="n">added</span> <span class="n">by</span> <span class="n">this</span> <span class="n">routine</span> <span class="n">when</span> <span class="n">ifa</span><span class="o">=</span><span class="mf">1.</span>
<span class="n">C</span>                      <span class="n">the</span> <span class="n">SCF</span> <span class="n">contribution</span> <span class="k">is </span><span class="n">minus</span> <span class="n">the</span> <span class="n">derivative</span> <span class="n">of</span>
<span class="n">C</span>                         <span class="p">(</span> <span class="n">Enascf</span> <span class="o">-</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">DUscf</span> <span class="o">+</span> <span class="n">Exc</span> <span class="p">)</span> <span class="o">/</span> <span class="n">volume</span>
<span class="n">C</span>                      <span class="n">with</span> <span class="n">respect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">strain</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">in</span> <span class="n">Ry</span><span class="p">.</span>
<span class="n">C</span>                        <span class="n">contributions</span> <span class="n">local</span> <span class="n">to</span> <span class="n">this</span> <span class="n">node</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Units</span> <span class="p">:</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Energies</span> <span class="n">in</span> <span class="n">Rydbergs</span>
<span class="n">C</span> <span class="n">Distances</span> <span class="n">in</span> <span class="n">Bohr</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span>     <span class="n">Modules</span>
      <span class="k">use </span><span class="nb">precision</span><span class="p">,</span>     <span class="n">only</span>  <span class="p">:</span> <span class="n">dp</span><span class="p">,</span> <span class="n">grid_p</span>
<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ProcessorY</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>

<span class="c">!     Number of Mesh divisions of each cell vector (global)</span>
<span class="c">!     The status of this variable is confusing</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Nodes</span>
      <span class="k">use </span><span class="n">atmfuncs</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">rcut</span><span class="p">,</span> <span class="n">rcore</span>
      <span class="k">use </span><span class="n">units</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">Debye</span><span class="p">,</span> <span class="n">eV</span><span class="p">,</span> <span class="n">Ang</span>
      <span class="k">use </span><span class="n">fdf</span>
      <span class="k">use </span><span class="n">sys</span><span class="p">,</span>           <span class="n">only</span>  <span class="p">:</span> <span class="n">die</span><span class="p">,</span> <span class="n">bye</span>
      <span class="k">use </span><span class="n">mesh</span><span class="p">,</span>          <span class="n">only</span>  <span class="p">:</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span>
      <span class="k">use </span><span class="n">parsing</span>
      <span class="k">use </span><span class="n">m_iorho</span><span class="p">,</span>       <span class="n">only</span>  <span class="p">:</span> <span class="n">write_rho</span>
      <span class="k">use </span><span class="n">m_forhar</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">forhar</span>
      <span class="k">use </span><span class="n">alloc</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">re_alloc</span><span class="p">,</span> <span class="n">de_alloc</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">slabel</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">filesOut_t</span> <span class="c">! derived type for output file names</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">harrisfun</span><span class="p">,</span> <span class="n">save_initial_charge_density</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">analyze_charge_density_only</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">LocalChargeOnMesh</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">PartialCoreOnMesh</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">NeutralAtomOnMesh</span>

      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">setMeshDistr</span><span class="p">,</span> <span class="n">distMeshData</span>
      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">LINEAR</span>
      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">TO_SEQUENTIAL</span><span class="p">,</span> <span class="n">TO_CLUSTER</span><span class="p">,</span> <span class="n">KEEP</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">compute_partial_charges</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">want_partial_charges</span>
<span class="cp">#ifndef BSC_CELLXC</span>

      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cellXC</span>       <span class="c">! Finds xc energy and potential</span>
      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myMeshBox</span>    <span class="c">! Returns my processor mesh box</span>
      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jms_setMeshDistr</span> <span class="o">=&gt;</span> <span class="n">setMeshDistr</span>
                                        <span class="c">! Sets a distribution of mesh</span>
                                        <span class="c">! points over parallel processors</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">use </span><span class="n">m_vmat</span><span class="p">,</span>  <span class="n">only</span>  <span class="p">:</span> <span class="n">vmat</span>
      <span class="k">use </span><span class="n">m_rhoofd</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">rhoofd</span>
<span class="cp">#ifdef MPI</span>
      <span class="k">use </span><span class="n">mpi_siesta</span>
<span class="cp">#endif</span>
      <span class="k">use </span><span class="n">iogrid_netcdf</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_grid_netcdf</span>
      <span class="k">use </span><span class="n">iogrid_netcdf</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_grid_netcdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_charge_cdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savebader</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_deformation_charge_cdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">mix_charge</span>

      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">get_field_from_dipole</span><span class="p">,</span> <span class="n">dipole_correction</span>
      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">add_potential_from_field</span>
      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">user_specified_field</span><span class="p">,</span> <span class="n">acting_efield</span>
      <span class="k">use </span><span class="n">m_doping_uniform</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">doping_active</span><span class="p">,</span> <span class="n">doping_uniform</span>
      
      <span class="k">use </span><span class="n">m_charge_add</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">charge_add</span>
      <span class="k">use </span><span class="n">m_hartree_add</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">hartree_add</span>

<span class="cp">#ifdef NCDF_4</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_cdf</span>
      <span class="k">use </span><span class="n">m_ncdf_siesta</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">cdf_save_grid</span>
<span class="cp">#endif</span>
      <span class="k">use </span><span class="n">m_rhofft</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">rhofft</span><span class="p">,</span> <span class="n">FORWARD</span><span class="p">,</span> <span class="n">BACKWARD</span>
      <span class="k">use </span><span class="n">m_rhog</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">rhog_in</span><span class="p">,</span> <span class="n">rhog</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">spin</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">Spiral</span><span class="p">,</span> <span class="n">qSpiral</span>
      <span class="k">use </span><span class="n">m_iotddft</span><span class="p">,</span>      <span class="n">only</span><span class="p">:</span> <span class="n">write_tdrho</span>
      <span class="k">use </span><span class="n">m_ts_global_vars</span><span class="p">,</span><span class="n">only</span><span class="p">:</span> <span class="n">TSmode</span><span class="p">,</span> <span class="n">TSrun</span>
      <span class="k">use </span><span class="n">m_ts_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">IsVolt</span><span class="p">,</span> <span class="n">Elecs</span><span class="p">,</span> <span class="n">N_elec</span>
      <span class="k">use </span><span class="n">m_ts_voltage</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ts_voltage</span>
      <span class="k">use </span><span class="n">m_ts_hartree</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ts_hartree_fix</span>

      <span class="k">implicit none</span>

<span class="k">      </span><span class="kt">integer</span>
     <span class="p">&amp;</span>  <span class="n">maxnd</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">iaorb</span><span class="p">(</span><span class="n">norb</span><span class="p">),</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">iHmat</span><span class="p">,</span>
     <span class="p">&amp;</span>  <span class="n">indxua</span><span class="p">(</span><span class="n">na</span><span class="p">),</span> <span class="n">iphorb</span><span class="p">(</span><span class="n">norb</span><span class="p">),</span> <span class="n">isa</span><span class="p">(</span><span class="n">na</span><span class="p">),</span> 
     <span class="p">&amp;</span>  <span class="n">istr</span><span class="p">,</span> <span class="n">listd</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="n">listdptr</span><span class="p">(</span><span class="n">nuo</span><span class="p">),</span> <span class="n">ntm</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">numd</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>
     <span class="p">&amp;</span>  <span class="n">datm</span><span class="p">(</span><span class="n">norb</span><span class="p">),</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">Dscf</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>  <span class="n">DUext</span><span class="p">,</span> <span class="n">DUscf</span><span class="p">,</span> <span class="n">Dxc</span><span class="p">,</span> <span class="n">Enaatm</span><span class="p">,</span> <span class="n">Enascf</span><span class="p">,</span> <span class="n">Exc</span><span class="p">,</span>
     <span class="p">&amp;</span>  <span class="n">Hmat</span><span class="p">(:,:),</span> <span class="n">Uatm</span><span class="p">,</span> <span class="n">Uscf</span><span class="p">,</span> <span class="n">xa</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">na</span><span class="p">),</span>
     <span class="p">&amp;</span>  <span class="n">stress</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">Fal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">nua</span><span class="p">),</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

      <span class="k">type</span><span class="p">(</span><span class="n">filesOut_t</span><span class="p">)</span> <span class="n">filesOut</span>

      <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">use_rhog_in</span>
      <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">charge_density_only</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Routines</span> <span class="n">called</span> <span class="n">internally</span><span class="p">:</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span>        <span class="n">cellxc</span><span class="p">(...)</span>    <span class="p">:</span> <span class="n">Finds</span> <span class="n">total</span> <span class="n">exch</span><span class="o">-</span><span class="n">corr</span> <span class="n">energy</span> <span class="nb">and </span><span class="n">potential</span>
<span class="n">C</span>        <span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>   <span class="p">:</span> <span class="n">Finds</span> <span class="n">the</span> <span class="n">cross</span> <span class="nb">product </span><span class="n">of</span> <span class="n">two</span> <span class="n">vectors</span>
<span class="n">C</span>        <span class="n">dfscf</span><span class="p">(...)</span>     <span class="p">:</span> <span class="n">Finds</span> <span class="n">SCF</span> <span class="n">contribution</span> <span class="n">to</span> <span class="n">atomic</span> <span class="n">forces</span>
<span class="n">C</span>        <span class="n">dipole</span><span class="p">(...)</span>    <span class="p">:</span> <span class="n">Finds</span> <span class="n">electric</span> <span class="n">dipole</span> <span class="n">moment</span>
<span class="n">C</span>        <span class="n">doping</span><span class="p">(...)</span>    <span class="p">:</span> <span class="n">Adds</span> <span class="n">a</span> <span class="n">background</span> <span class="n">charge</span> <span class="n">for</span> <span class="n">doped</span> <span class="n">systems</span>
<span class="n">C</span>        <span class="n">write_rho</span><span class="p">(...)</span>     <span class="p">:</span> <span class="n">Saves</span> <span class="n">electron</span> <span class="n">density</span> <span class="n">on</span> <span class="n">a</span> <span class="k">file</span>
<span class="n">C</span>        <span class="n">poison</span><span class="p">(...)</span>    <span class="p">:</span> <span class="n">Solves</span> <span class="n">Poisson</span> <span class="n">equation</span>
<span class="n">C</span>        <span class="n">reord</span><span class="p">(...)</span>     <span class="p">:</span> <span class="n">Reorders</span> <span class="n">electron</span> <span class="n">density</span> <span class="nb">and </span><span class="n">potential</span> <span class="n">arrays</span>
<span class="n">C</span>        <span class="n">rhooda</span><span class="p">(...)</span>    <span class="p">:</span> <span class="n">Finds</span> <span class="n">Harris</span> <span class="n">electron</span> <span class="n">density</span> <span class="n">in</span> <span class="n">the</span> <span class="n">mesh</span>
<span class="n">C</span>        <span class="n">rhoofd</span><span class="p">(...)</span>    <span class="p">:</span> <span class="n">Finds</span> <span class="n">SCF</span> <span class="n">electron</span> <span class="n">density</span> <span class="n">in</span> <span class="n">the</span> <span class="n">mesh</span>
<span class="n">C</span>        <span class="n">rhoofdsp</span><span class="p">(...)</span>  <span class="p">:</span> <span class="n">Finds</span> <span class="n">SCF</span> <span class="n">electron</span> <span class="n">density</span> <span class="n">in</span> <span class="n">the</span> <span class="n">mesh</span> <span class="n">for</span>
<span class="n">C</span>                         <span class="n">spiral</span> <span class="n">arrangement</span> <span class="n">of</span> <span class="n">spins</span>
<span class="n">C</span>        <span class="n">timer</span><span class="p">(...)</span>     <span class="p">:</span> <span class="n">Finds</span> <span class="n">CPU</span> <span class="n">times</span>
<span class="n">C</span>        <span class="n">vmat</span><span class="p">(...)</span>      <span class="p">:</span> <span class="n">Finds</span> <span class="n">matrix</span> <span class="n">elements</span> <span class="n">of</span> <span class="n">SCF</span> <span class="n">potential</span>
<span class="n">C</span>        <span class="n">vmatsp</span><span class="p">(...)</span>    <span class="p">:</span> <span class="n">Finds</span> <span class="n">matrix</span> <span class="n">elements</span> <span class="n">of</span> <span class="n">SCF</span> <span class="n">potential</span> <span class="n">for</span>
<span class="n">C</span>                         <span class="n">spiral</span> <span class="n">arrangement</span> <span class="n">of</span> <span class="n">spins</span>
<span class="n">C</span>        <span class="n">delk</span><span class="p">(...)</span>      <span class="p">:</span> <span class="n">Finds</span> <span class="n">matrix</span> <span class="n">elements</span> <span class="n">of</span> <span class="nb">exp</span><span class="p">(</span><span class="n">i</span> <span class="err">\</span><span class="n">vec</span><span class="err">{</span><span class="n">k</span><span class="err">}</span> <span class="err">\</span><span class="n">cdot</span> <span class="err">\</span><span class="n">vec</span><span class="err">{</span><span class="n">r</span><span class="err">}</span><span class="p">)</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span> <span class="n">volcel</span><span class="p">(</span> <span class="n">cell</span> <span class="p">)</span> <span class="p">:</span> <span class="n">Returns</span> <span class="n">volume</span> <span class="n">of</span> <span class="n">unit</span> <span class="n">cell</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Internal</span> <span class="n">variables</span> <span class="nb">and </span><span class="n">arrays</span><span class="p">:</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">bcell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>    <span class="p">:</span> <span class="n">Bulk</span> <span class="n">lattice</span> <span class="n">vectors</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">cell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>     <span class="p">:</span> <span class="n">Auxiliary</span> <span class="n">lattice</span> <span class="n">vectors</span> <span class="p">(</span><span class="n">same</span> <span class="n">as</span> <span class="n">ucell</span><span class="p">)</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">const</span>         <span class="p">:</span> <span class="n">Auxiliary</span> <span class="n">variable</span> <span class="p">(</span><span class="n">constant</span> <span class="n">within</span> <span class="n">a</span> <span class="n">loop</span><span class="p">)</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">DEc</span>           <span class="p">:</span> <span class="n">Auxiliary</span> <span class="n">variable</span> <span class="n">to</span> <span class="k">call </span><span class="n">cellxc</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">DEx</span>           <span class="p">:</span> <span class="n">Auxiliary</span> <span class="n">variable</span> <span class="n">to</span> <span class="k">call </span><span class="n">cellxc</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">dvol</span>          <span class="p">:</span> <span class="n">Mesh</span><span class="o">-</span><span class="n">cell</span> <span class="n">volume</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Ec</span>            <span class="p">:</span> <span class="n">Correlation</span> <span class="n">energy</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">Ex</span>            <span class="p">:</span> <span class="n">Exchange</span> <span class="n">energy</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">field</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>      <span class="p">:</span> <span class="k">External </span><span class="n">electric</span> <span class="n">field</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">i</span>             <span class="p">:</span> <span class="n">General</span><span class="o">-</span><span class="n">purpose</span> <span class="nb">index</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">ia</span>            <span class="p">:</span> <span class="n">Atom</span> <span class="nb">index</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">io</span>            <span class="p">:</span> <span class="n">Orbital</span> <span class="nb">index</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">ip</span>            <span class="p">:</span> <span class="n">Point</span> <span class="nb">index</span>
<span class="n">C</span> <span class="kt">integer </span><span class="k">is</span>            <span class="p">:</span> <span class="n">Species</span> <span class="nb">index</span>
<span class="n">C</span> <span class="kt">logical </span><span class="n">IsDiag</span>        <span class="p">:</span> <span class="k">Is </span><span class="n">supercell</span> <span class="n">diagonal</span><span class="err">?</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">ispin</span>         <span class="p">:</span> <span class="n">Spin</span> <span class="nb">index</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">j</span>             <span class="p">:</span> <span class="n">General</span><span class="o">-</span><span class="n">purpose</span> <span class="nb">index</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">JDGdistr</span>      <span class="p">:</span> <span class="n">J</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">Gale</span><span class="s1">&#39;s parallel distribution of mesh points</span>
<span class="s1">C integer myBox(2,3)    : My processor&#39;</span><span class="n">s</span> <span class="n">mesh</span> <span class="n">box</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">nbcell</span>        <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">independent</span> <span class="n">bulk</span> <span class="n">lattice</span> <span class="n">vectors</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">npcc</span>          <span class="p">:</span> <span class="n">Partial</span> <span class="n">core</span> <span class="n">corrections</span><span class="err">?</span> <span class="p">(</span><span class="mi">0</span><span class="o">=</span><span class="n">no</span><span class="p">,</span> <span class="mi">1</span><span class="o">=</span><span class="n">yes</span><span class="p">)</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">nsd</span>           <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">diagonal</span> <span class="n">spin</span> <span class="n">values</span> <span class="p">(</span><span class="mi">1</span> <span class="nb">or </span><span class="mi">2</span><span class="p">)</span>
<span class="n">C</span> <span class="kt">integer </span><span class="n">ntpl</span>          <span class="p">:</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">mesh</span> <span class="n">Total</span> <span class="n">Points</span> <span class="n">in</span> <span class="n">unit</span> <span class="n">cell</span>
<span class="n">C</span>                         <span class="p">(</span><span class="n">including</span> <span class="n">subpoints</span><span class="p">)</span> <span class="n">locally</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">4</span>  <span class="n">rhoatm</span><span class="p">(</span><span class="n">ntpl</span><span class="p">)</span>  <span class="p">:</span> <span class="n">Harris</span> <span class="n">electron</span> <span class="n">density</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">4</span>  <span class="n">rhopcc</span><span class="p">(</span><span class="n">ntpl</span><span class="p">)</span>  <span class="p">:</span> <span class="n">Partial</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="n">correction</span> <span class="n">density</span> <span class="n">for</span> <span class="n">xc</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">4</span>  <span class="n">DRho</span><span class="p">(</span><span class="n">ntpl</span><span class="p">)</span>    <span class="p">:</span> <span class="n">Selfconsistent</span> <span class="n">electron</span> <span class="n">density</span> <span class="n">difference</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">rhotot</span>        <span class="p">:</span> <span class="n">Total</span> <span class="n">density</span> <span class="n">at</span> <span class="n">one</span> <span class="n">point</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">rmax</span>          <span class="p">:</span> <span class="n">Maximum</span> <span class="n">orbital</span> <span class="n">radius</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">scell</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>    <span class="p">:</span> <span class="n">Supercell</span> <span class="n">vectors</span>
<span class="n">C</span> <span class="kt">character </span><span class="nb">shape</span><span class="o">*</span><span class="mi">10</span>    <span class="p">:</span> <span class="n">Name</span> <span class="n">of</span> <span class="nb">system shape</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">4</span>  <span class="n">Vaux</span><span class="p">(</span><span class="n">ntpl</span><span class="p">)</span>    <span class="p">:</span> <span class="n">Auxiliary</span> <span class="n">potential</span> <span class="k">array</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">4</span>  <span class="n">Vna</span><span class="p">(</span><span class="n">ntpl</span><span class="p">)</span>     <span class="p">:</span> <span class="nb">Sum </span><span class="n">of</span> <span class="n">neutral</span><span class="o">-</span><span class="n">atom</span> <span class="n">potentials</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">volume</span>        <span class="p">:</span> <span class="n">Unit</span> <span class="n">cell</span> <span class="n">volume</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">4</span>  <span class="n">Vscf</span><span class="p">(</span><span class="n">ntpl</span><span class="p">)</span>    <span class="p">:</span> <span class="n">Hartree</span> <span class="n">potential</span> <span class="n">of</span> <span class="n">selfconsistent</span> <span class="n">density</span>
<span class="n">C</span> <span class="kt">real</span><span class="o">*</span><span class="mi">8</span>  <span class="n">x0</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="p">:</span> <span class="n">Center</span> <span class="n">of</span> <span class="n">molecule</span>
<span class="n">C</span> <span class="kt">logical </span><span class="n">harrisfun</span>     <span class="p">:</span> <span class="n">Harris</span> <span class="n">functional</span> <span class="nb">or </span><span class="n">Kohn</span><span class="o">-</span><span class="n">Sham</span><span class="err">?</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>

<span class="n">C</span>     <span class="n">Local</span> <span class="n">variables</span>
      <span class="kt">integer</span>  <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">nsd</span><span class="p">,</span> <span class="n">np_vac</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Interface to JMS&#39;s SiestaXC</span>
      <span class="kt">integer</span>       <span class="kd">::</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">save</span> <span class="kd">::</span> <span class="n">JDGdistr</span><span class="o">=-</span><span class="mi">1</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stressXC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">b1Xb2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">const</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DStres</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
     <span class="p">&amp;</span>            <span class="n">Ec</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">rhotot</span><span class="p">,</span> <span class="n">x0</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Vmax_vac</span><span class="p">,</span> <span class="n">Vmean_vac</span>
<span class="cp">#ifdef BSC_CELLXC</span>
<span class="c">!     Dummy arrays for cellxc call</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aux3</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dummy_DVxcdn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="kt">logical</span> <span class="kd">::</span> <span class="n">use_rhog</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">volcel</span><span class="p">,</span> <span class="n">ddot</span>

      <span class="k">external</span>
     <span class="p">&amp;</span>  <span class="n">cross</span><span class="p">,</span>
     <span class="p">&amp;</span>  <span class="n">dipole</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">poison</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">reord</span><span class="p">,</span> <span class="n">rhooda</span><span class="p">,</span> <span class="n">rhoofdsp</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">timer</span><span class="p">,</span> <span class="n">vmatsp</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">readsp</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">external </span><span class="n">bsc_cellxc</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="n">C</span>     <span class="n">Work</span> <span class="n">arrays</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Vscf</span><span class="p">(:,:),</span> <span class="n">Vscf_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                         <span class="n">DRho</span><span class="p">(:,:),</span> <span class="n">DRho_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                         <span class="n">Vaux</span><span class="p">(:),</span> <span class="n">Vaux_par</span><span class="p">(:),</span> <span class="n">Chlocal</span><span class="p">(:),</span>
     <span class="p">&amp;</span>                         <span class="n">Totchar</span><span class="p">(:),</span> <span class="n">fsrc</span><span class="p">(:),</span> <span class="n">fdst</span><span class="p">(:),</span>
     <span class="p">&amp;</span>                         <span class="n">rhoatm_quad</span><span class="p">(:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">(),</span>
     <span class="p">&amp;</span>                         <span class="n">DRho_quad</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>
      <span class="c">! Temporary reciprocal spin quantity</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">rnsd</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Vscf_gga</span><span class="p">(:,:),</span> <span class="n">DRho_gga</span><span class="p">(:,:)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
<span class="cp">#ifdef MPI</span>
      <span class="kt">integer</span>  <span class="kd">::</span> <span class="n">MPIerror</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
      <span class="k">call </span><span class="n">write_debug</span><span class="p">(</span> <span class="s1">&#39;    PRE DHSCF&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span> <span class="o">/=</span> <span class="n">size</span><span class="p">(</span><span class="n">Dscf</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;Spin components is not equal to options.&#39;</span><span class="p">)</span>
      <span class="k">end if</span>

<span class="k">      if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;DM&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">)</span>
         <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Hmat</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">)</span>
      <span class="k">end if</span>
      
<span class="c">!-------------------------------------------------------------------- BEGIN</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Start</span> <span class="n">of</span> <span class="n">SCF</span> <span class="n">iteration</span> <span class="n">part</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span>     <span class="n">At</span> <span class="n">the</span> <span class="k">end </span><span class="n">of</span> <span class="n">DHSCF_INIT</span><span class="p">,</span> <span class="nb">and </span><span class="n">also</span> <span class="n">at</span> <span class="n">the</span> <span class="k">end </span><span class="n">of</span> <span class="nb">any </span><span class="n">previous</span>
<span class="c">!     call to dhscf, we were in the UNIFORM distribution</span>
<span class="c">!     Rhoatm, Rhopcc and Vna were in UNIFORM dist, sequential form</span>
<span class="c">!     The index array endpht was in the QUADRATIC distribution</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>

<span class="cp">#ifdef _TRACE_</span>
      <span class="k">call </span><span class="n">MPI_Barrier</span><span class="p">(</span> <span class="n">MPI_Comm_World</span><span class="p">,</span> <span class="n">MPIerror</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">MPItrace_restart</span><span class="p">(</span> <span class="p">)</span>
<span class="cp">#endif</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>

      <span class="k">nullify</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">Totchar</span> <span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">nullify</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="n">DRho_gga</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="n">volume</span> <span class="o">=</span> <span class="n">volcel</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

<span class="n">C</span><span class="o">-------------------------------------------------------------------------</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">analyze_charge_density_only</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">!! Use the functionality in the first block</span>
         <span class="c">!! of the routine to get charge files and partial charges</span>
         <span class="k">call </span><span class="n">setup_analysis_options</span><span class="p">()</span>
      <span class="n">endif</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Uniform dist, sequential form</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vna&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span><span class="n">Vna</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vna</span><span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="s2">&quot;Vna&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vna</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="s2">&quot;Vna&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="n">C</span>     <span class="k">Allocate memory </span><span class="n">for</span> <span class="n">DRho</span> <span class="n">using</span> <span class="n">the</span> <span class="n">UNIFORM</span> <span class="k">data </span><span class="n">distribution</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

<span class="n">C</span> <span class="n">Find</span> <span class="n">number</span> <span class="n">of</span> <span class="n">diagonal</span> <span class="n">spin</span> <span class="n">values</span>
      <span class="n">nsd</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">nspin</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">nsd</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         </span><span class="n">rnsd</span> <span class="o">=</span> <span class="mf">1._grid_p</span>
      <span class="k">else</span>
<span class="k">         </span><span class="n">rnsd</span> <span class="o">=</span> <span class="mf">1._grid_p</span> <span class="o">/</span> <span class="n">nsd</span>
      <span class="k">end if</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Find</span> <span class="n">SCF</span> <span class="n">electron</span> <span class="n">density</span> <span class="n">at</span> <span class="n">mesh</span> <span class="n">points</span><span class="p">.</span> <span class="n">Store</span> <span class="n">it</span> <span class="n">in</span> <span class="k">array </span><span class="n">DRho</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="c">!</span>
<span class="c">!     The reading routine works in the uniform distribution, in</span>
<span class="c">!     sequential form</span>
<span class="c">!</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">use_rhog_in</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">use_rhog</span> <span class="o">=</span> <span class="n">use_rhog_in</span>
         <span class="k">else</span>
<span class="k">            </span><span class="n">use_rhog</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="n">endif</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">use_rhog</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! fourier transform back into drho</span>
         <span class="k">call </span><span class="n">rhofft</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>                  <span class="n">DRho</span><span class="p">,</span><span class="n">rhog_in</span><span class="p">,</span><span class="n">BACKWARD</span><span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span><span class="n">read_charge_cdf</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">read_grid_netcdf</span><span class="p">(</span><span class="n">ntm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="n">DRho</span><span class="p">,</span><span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
         <span class="n">read_charge_cdf</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">else if</span> <span class="p">(</span><span class="n">read_deformation_charge_cdf</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">read_grid_netcdf</span><span class="p">(</span><span class="n">ntm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="n">DRho</span><span class="p">,</span><span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
         <span class="c">! Add to diagonal components only</span>
         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
            <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
<span class="n">C</span>             <span class="n">rhoatm</span> <span class="nb">and </span><span class="n">Drho</span> <span class="n">are</span> <span class="n">in</span> <span class="n">sequential</span> <span class="n">mode</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
            <span class="n">enddo</span>
         <span class="n">enddo</span>
         <span class="n">read_deformation_charge_cdf</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">else</span>
        <span class="c">! Set the QUADRATIC distribution and allocate memory for DRho_par</span>
        <span class="c">! since the construction of the density from the DM and orbital</span>
        <span class="c">! data needs that distribution</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;DRho_par&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">Spiral</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">rhoofdsp</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>                   <span class="n">nspin</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span>
     <span class="p">&amp;</span>                   <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">qspiral</span> <span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">rhoofd</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="n">nspin</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span> 
     <span class="p">&amp;</span>                 <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="c">! DRHO_par is here in QUADRATIC, clustered form</span>

<span class="n">C</span>       <span class="n">Set</span> <span class="n">the</span> <span class="n">UNIFORM</span> <span class="n">distribution</span> <span class="n">again</span> <span class="nb">and </span><span class="n">copy</span> <span class="n">DRho</span> <span class="n">to</span> <span class="n">it</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>

        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! Sequential to be able to write it out</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
        <span class="n">enddo</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="s1">&#39;DRho_par&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;DRho&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nspin</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">save_initial_charge_density</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! This section is to be deprecated in favor</span>
           <span class="c">! of &quot;analyze_charge_density_only&quot;</span>
           <span class="c">! (except for the special name for the .nc file)</span>
<span class="cp">#ifdef NCDF_4</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoInit&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">ntml</span><span class="p">,</span><span class="n">DRho</span><span class="p">)</span>
          <span class="k">else</span>
<span class="k">             call </span><span class="n">write_rho</span><span class="p">(</span> <span class="s2">&quot;RHO_INIT&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>            <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">)</span>
             <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="err">$</span>            <span class="s2">&quot;RhoInit&quot;</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="cp">#else</span>
          <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="s2">&quot;RHO_INIT&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>         <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">)</span>
          <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="err">$</span>         <span class="s2">&quot;RhoInit&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
          <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;STOP after producing RHO_INIT from input DM&quot;</span><span class="p">)</span>
        <span class="n">endif</span>

      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">mix_charge</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! Save fourier transform of charge density</span>
         <span class="k">call </span><span class="n">rhofft</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">DRho</span><span class="p">,</span><span class="n">rhog</span><span class="p">,</span><span class="n">FORWARD</span><span class="p">)</span>
      <span class="n">endif</span>
<span class="c">!</span>
<span class="c">!     Proper place to integrate Hirshfeld and Voronoi code,</span>
<span class="c">!     since we have just computed rhoatm and Rho.</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">want_partial_charges</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! The endpht array is in the quadratic distribution, so</span>
        <span class="c">! we need to use it for this...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;DRho_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>       
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">rhoatm_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;rhoatm_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="c">! Redistribute grid-density</span>
        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho_quad</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="n">enddo</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">rhoatm</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">rhoatm_quad</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">compute_partial_charges</span><span class="p">(</span><span class="n">DRho_quad</span><span class="p">,</span><span class="n">rhoatm_quad</span><span class="p">,</span>
     <span class="p">.</span>                  <span class="n">nspin</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> 
     <span class="p">.</span>                  <span class="n">isa</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span><span class="n">dvol</span><span class="p">)</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span><span class="n">rhoatm_quad</span><span class="p">,</span><span class="s1">&#39;rhoatm_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span><span class="n">Drho_quad</span><span class="p">,</span><span class="s1">&#39;DRho_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
      <span class="n">endif</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="k">Save </span><span class="n">electron</span> <span class="n">density</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">!  DRho is already using a uniform, sequential form</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Rho&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>
<span class="n">C</span><span class="o">-----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="k">Save </span><span class="n">TD</span><span class="o">-</span><span class="n">electron</span> <span class="n">density</span> <span class="n">after</span> <span class="n">every</span> <span class="n">given</span> <span class="n">number</span> <span class="n">of</span> <span class="n">steps</span><span class="o">-</span> <span class="n">Rafi</span><span class="p">,</span> <span class="n">Jan</span> <span class="mi">2016</span>
<span class="n">C</span><span class="o">-----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">write_tdrho</span><span class="p">(</span><span class="n">filesOut</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">tdrho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">!  DRho is already using a uniform, sequential form</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">tdrho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;TDRho&quot;</span><span class="p">)</span>
      <span class="n">endif</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="k">Save </span><span class="n">the</span> <span class="n">diffuse</span> <span class="n">ionic</span> <span class="n">charge</span> <span class="nb">and</span><span class="o">/</span><span class="nb">or </span><span class="n">the</span> <span class="n">total</span> <span class="p">(</span><span class="n">ionic</span><span class="o">+</span><span class="n">electronic</span><span class="p">)</span> <span class="n">charge</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="n">C</span>       <span class="n">Find</span> <span class="n">diffuse</span> <span class="n">ionic</span> <span class="n">charge</span> <span class="n">on</span> <span class="n">mesh</span>
        <span class="c">! Note that the *OnMesh routines, except PhiOnMesh,</span>
        <span class="c">! work with any distribution, thanks to the fact that</span>
        <span class="c">! the ipa, idop, and indexp arrays are distro-specific</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">LocalChargeOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">indxua</span> <span class="p">)</span>
        <span class="c">! Chlocal comes out in clustered form, so we convert it</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Chlocal</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">end if</span>

<span class="n">C</span>       <span class="k">Save </span><span class="n">diffuse</span> <span class="n">ionic</span> <span class="n">charge</span> 
        <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">Chlocal</span><span class="p">)</span>
          <span class="k">else</span>
<span class="k">             call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">Chlocal</span><span class="p">)</span>
             <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="s1">&#39;Chlocal&#39;</span> <span class="p">)</span>
          <span class="k">end if</span>
<span class="cp">#else</span>
          <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Chlocal</span><span class="p">)</span>
          <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Chlocal</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>
        <span class="n">endif</span>

<span class="n">C</span>       <span class="k">Save </span><span class="n">total</span> <span class="p">(</span><span class="n">ionic</span><span class="o">+</span><span class="n">electronic</span><span class="p">)</span> <span class="n">charge</span> 
        <span class="k">if</span> <span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! *****************</span>
           <span class="c">! **  IMPORTANT  **</span>
           <span class="c">! The Chlocal array is re-used to minimize memory</span>
           <span class="c">! usage. In the this small snippet the Chlocal</span>
           <span class="c">! array will contain the total charge, and</span>
           <span class="c">! if the logic should change, (i.e. should Chlocal</span>
           <span class="c">! be retained) is the Totchar needed to be re-instantiated.</span>
           <span class="c">! *****************</span>

<span class="c">!$OMP parallel default(shared), private(ispin,ip)</span>
           <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
<span class="c">!$OMP do </span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
              <span class="n">Chlocal</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">Chlocal</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="k">end do</span>
<span class="c">!$OMP end do </span>
           <span class="k">end do</span>
<span class="c">!$OMP end parallel</span>

          <span class="c">! See note above</span>
<span class="cp">#ifdef NCDF_4</span>
           <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">              call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoTot&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">Chlocal</span><span class="p">)</span>
           <span class="k">else</span>
<span class="k">              call </span><span class="n">write_rho</span><span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">ntm</span><span class="p">,</span><span class="n">nsm</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Chlocal</span><span class="p">)</span>
              <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> 
     <span class="p">&amp;</span>             <span class="s2">&quot;TotalCharge&quot;</span><span class="p">)</span>
           <span class="k">end if</span>
<span class="cp">#else</span>
           <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Chlocal</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Chlocal</span><span class="p">,</span> <span class="s2">&quot;TotalCharge&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
        <span class="k">end if </span>
<span class="k">        call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="n">endif</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="k">Save </span><span class="n">the</span> <span class="n">total</span> <span class="n">charge</span> <span class="p">(</span><span class="n">model</span> <span class="n">core</span> <span class="o">+</span> <span class="n">valence</span><span class="p">)</span> <span class="n">for</span> <span class="n">Bader</span> <span class="n">analysis</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      
      <span class="c">! The test for toch guarantees that we are in &quot;analysis mode&quot;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">savebader</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">save_bader_charge</span><span class="p">()</span>
      <span class="n">endif</span>

<span class="n">C</span> <span class="n">Find</span> <span class="n">difference</span> <span class="n">between</span> <span class="n">selfconsistent</span> <span class="nb">and </span><span class="n">atomic</span> <span class="n">densities</span>

      <span class="c">!Both DRho and rhoatm are using a UNIFORM, sequential form</span>
<span class="c">!$OMP parallel do default(shared), private(ispin,ip),</span>
<span class="c">!$OMP&amp;collapse(2)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="k">Save </span><span class="n">electron</span> <span class="n">density</span> <span class="n">difference</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoDelta&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">charge_density_only</span><span class="p">))</span> <span class="k">then </span>
<span class="k">         if</span> <span class="p">(</span><span class="n">charge_density_only</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
            <span class="k">RETURN</span>
<span class="k">         </span><span class="n">endif</span>
      <span class="n">endif</span>

<span class="c">! End of analysis section</span>
<span class="c">! Can exit now, if requested</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">analyze_charge_density_only</span><span class="p">)</span> <span class="k">then </span>
<span class="k">            call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
           <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;STOP after analyzing charge from input DM&quot;</span><span class="p">)</span>
        <span class="n">endif</span>

<span class="c">!-------------------------------------------------------------</span>
<span class="n">C</span>     <span class="n">Transform</span> <span class="n">spin</span> <span class="n">density</span> <span class="n">into</span> <span class="nb">sum and </span><span class="n">difference</span>

      <span class="c">! TODO Check for NC/SO:</span>
      <span class="c">! Should we diagonalize locally at every point first?</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(rhotot,ip)</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
          <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">rhotot</span>
        <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">endif</span>

<span class="n">C</span> <span class="n">Add</span> <span class="n">a</span> <span class="n">background</span> <span class="n">charge</span> <span class="n">to</span> <span class="n">neutralize</span> <span class="n">the</span> <span class="n">net</span> <span class="n">charge</span><span class="p">,</span> <span class="n">to</span>
<span class="n">C</span> <span class="n">model</span> <span class="n">doped</span> <span class="n">systems</span><span class="p">.</span> <span class="n">It</span> <span class="n">only</span> <span class="n">adds</span> <span class="n">the</span> <span class="n">charge</span> <span class="n">at</span> <span class="n">points</span>
<span class="n">C</span> <span class="k">where </span><span class="n">there</span> <span class="n">are</span> <span class="n">atoms</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.,</span> <span class="nb">not </span><span class="n">in</span> <span class="n">vacuum</span><span class="p">).</span>          
<span class="n">C</span> <span class="n">First</span><span class="p">,</span> <span class="k">call </span><span class="n">with</span> <span class="s1">&#39;task=0&#39;</span> <span class="n">to</span> <span class="n">add</span> <span class="n">background</span> <span class="n">charge</span>    
      <span class="k">if</span> <span class="p">(</span><span class="n">doping_active</span><span class="p">)</span> <span class="k">call </span><span class="n">doping_uniform</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">rhoatm</span><span class="p">)</span>
      
      <span class="c">! Add doping in cell (from ChargeGeometries/Geometry.Charge)</span>
      <span class="c">! Note that this routine will return immediately if no dopant is present</span>
      <span class="k">call </span><span class="n">charge_add</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Calculate</span> <span class="n">the</span> <span class="n">dipole</span> <span class="n">moment</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39;bulk&#39;</span><span class="p">)</span> <span class="k">then</span>

<span class="n">C</span> <span class="n">Find</span> <span class="n">center</span> <span class="n">of</span> <span class="nb">system</span>
<span class="nb">        </span><span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
        <span class="k">do </span><span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nua</span>
          <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">xa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ia</span><span class="p">)</span> <span class="o">/</span> <span class="n">nua</span>
        <span class="n">enddo</span>

<span class="n">C</span> <span class="n">Find</span> <span class="n">dipole</span>
        <span class="c">! This routine is distribution-blind</span>
        <span class="c">! and will reduce over all processors.</span>
        <span class="k">call </span><span class="n">dipole</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">nsm</span><span class="p">,</span>
     <span class="p">&amp;</span>               <span class="n">DRho</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dipol</span> <span class="p">)</span>

        <span class="c">! Orthogonalize dipole to bulk directions</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          </span><span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span> <span class="o">*</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;slab&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">cross</span><span class="p">(</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">b1Xb2</span> <span class="p">)</span>
          <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span> <span class="o">*</span> <span class="n">b1Xb2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
       <span class="k">end if</span>

<span class="k">       if</span> <span class="p">(</span> <span class="n">TSmode</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span> <span class="n">N_elec</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">then</span>
          <span class="c">! Orthogonalize dipole to electrode transport directions</span>
          <span class="k">do </span><span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">,</span> <span class="n">N_Elec</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">Elecs</span><span class="p">(</span><span class="n">ia</span><span class="p">)%</span><span class="n">cell</span><span class="p">(:,</span><span class="n">Elecs</span><span class="p">(</span><span class="n">ia</span><span class="p">)%</span><span class="n">t_dir</span><span class="p">)</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span> <span class="o">*</span> <span class="n">x0</span>
          <span class="k">end do</span>
<span class="k">        else if</span> <span class="p">(</span> <span class="p">(</span><span class="nb">shape</span> <span class="o">==</span> <span class="s1">&#39;molecule&#39;</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="nb">shape</span> <span class="o">==</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
          <span class="c">! Only allow dipole correction for chains and molecules</span>
          <span class="c">! along the semi-infinite direciton.</span>
          <span class="c">! Note this is *only* for 1-electrode setups</span>
          <span class="c">! Note that since the above removes the periodic directions</span>
          <span class="c">! this should not do anything for &#39;chain&#39; with the same semi-infinite</span>
          <span class="c">! direction</span>
          <span class="n">x0</span> <span class="o">=</span> <span class="n">Elecs</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">cell</span><span class="p">(:,</span><span class="n">Elecs</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">t_dir</span><span class="p">)</span>
          <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span> <span class="o">*</span> <span class="n">x0</span>
        <span class="k">end if</span>
<span class="k">       end if</span>
<span class="k">          </span>
<span class="k">      </span><span class="n">endif</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span>     <span class="n">Find</span> <span class="n">Hartree</span> <span class="n">potential</span> <span class="n">of</span> <span class="n">DRho</span> <span class="o">=</span> <span class="n">rhoscf</span><span class="o">-</span><span class="n">rhoatm</span><span class="p">.</span> <span class="n">Store</span> <span class="n">it</span> <span class="n">in</span> <span class="n">Vaux</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="c">!     Solve Poisson&#39;s equation</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Vaux&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">call </span><span class="n">poison</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DUscf</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">DStres</span><span class="p">,</span> <span class="n">nsm</span> <span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;Poisson&#39;</span><span class="p">,</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vaux</span><span class="p">(:)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
      <span class="k">end if</span>

      <span class="c">! Vscf is in the UNIFORM, sequential form, and only using</span>
      <span class="c">! the first spin index</span>

      <span class="c">! We require that even the SIESTA potential is &quot;fixed&quot;</span>
      <span class="c">! NOTE, this will only do something if</span>
      <span class="c">!   TS.Hartree.Fix is set</span>
      <span class="k">call </span><span class="n">ts_hartree_fix</span><span class="p">(</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">)</span>
      
<span class="n">C</span> <span class="n">Add</span> <span class="n">contribution</span> <span class="n">to</span> <span class="n">stress</span> <span class="n">from</span> <span class="n">electrostatic</span> <span class="n">energy</span> <span class="n">of</span> <span class="n">rhoscf</span><span class="o">-</span><span class="n">rhoatm</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">istr</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">stressl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">DStres</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">endif</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span>     <span class="n">Find</span> <span class="n">electrostatic</span> <span class="p">(</span><span class="n">Hartree</span><span class="p">)</span> <span class="n">energy</span> <span class="n">of</span> <span class="n">full</span> <span class="n">SCF</span> <span class="n">electron</span> <span class="n">density</span>
<span class="n">C</span>     <span class="n">using</span> <span class="n">the</span> <span class="n">original</span> <span class="k">data </span><span class="n">distribution</span> 
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="n">Uatm</span> <span class="o">=</span> <span class="n">Uharrs</span>
      <span class="n">Uscf</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP parallel do default(shared), private(ip), </span>
<span class="c">!$OMP&amp;reduction(+:Uscf)</span>
      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
        <span class="n">Uscf</span> <span class="o">=</span> <span class="n">Uscf</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">Uscf</span> <span class="o">=</span> <span class="n">Uscf</span> <span class="o">*</span> <span class="n">dVol</span> <span class="o">+</span> <span class="n">Uatm</span> <span class="o">+</span> <span class="n">DUscf</span>

<span class="n">C</span> <span class="k">Call </span><span class="n">doping</span> <span class="n">with</span> <span class="s1">&#39;task=1&#39;</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">background</span> <span class="n">charge</span> <span class="n">added</span> <span class="n">previously</span>
<span class="n">C</span> <span class="n">The</span> <span class="n">extra</span> <span class="n">charge</span> <span class="n">thus</span> <span class="n">only</span> <span class="n">affects</span> <span class="n">the</span> <span class="n">Hartree</span> <span class="n">energy</span> <span class="nb">and </span><span class="n">potential</span><span class="p">,</span>
<span class="n">C</span> <span class="n">but</span> <span class="nb">not </span><span class="n">the</span> <span class="n">contribution</span> <span class="n">to</span> <span class="n">Enascf</span> <span class="p">(</span> <span class="o">=</span> <span class="err">\</span><span class="n">Int_</span><span class="err">{</span><span class="n">Vna</span><span class="o">*</span><span class="err">\</span><span class="n">rho</span><span class="err">}</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">doping_active</span><span class="p">)</span> <span class="k">call </span><span class="n">doping_uniform</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">rhoatm</span><span class="p">)</span>

      <span class="c">! Remove doping in cell (from ChargeGeometries/Geometry.Charge)</span>
      <span class="c">! Note that this routine will return immediately if no dopant is present</span>
      <span class="k">call </span><span class="n">charge_add</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Add</span> <span class="n">neutral</span><span class="o">-</span><span class="n">atom</span> <span class="n">potential</span> <span class="n">to</span> <span class="n">Vaux</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
<span class="c">!$OMP parallel do default(shared), private(ip),</span>
<span class="c">!$OMP&amp;reduction(+:Enaatm,Enascf)</span>
      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
        <span class="n">Enaatm</span>   <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="n">Enascf</span>   <span class="o">=</span> <span class="n">Enascf</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">*</span> <span class="n">dVol</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">Enascf</span> <span class="o">*</span> <span class="n">dVol</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Add</span> <span class="n">potential</span> <span class="n">from</span> <span class="k">external </span><span class="n">electric</span> <span class="n">field</span> <span class="p">(</span><span class="k">if </span><span class="nb">present</span><span class="p">)</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">acting_efield</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span> <span class="n">dipole_correction</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">field</span> <span class="o">=</span> <span class="n">get_field_from_dipole</span><span class="p">(</span><span class="n">dipol</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Node</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">	       write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;(a,3f12.4,a)&#39;</span><span class="p">)</span>
     <span class="err">$</span>              <span class="s1">&#39;Dipole moment in unit cell   =&#39;</span><span class="p">,</span> <span class="n">dipol</span><span class="o">/</span><span class="n">Debye</span><span class="p">,</span> <span class="s1">&#39; D&#39;</span>
	       <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;(a,3f12.6,a)&#39;</span><span class="p">)</span>
     <span class="err">$</span>              <span class="s1">&#39;Electric field for dipole correction =&#39;</span><span class="p">,</span>
     <span class="err">$</span>              <span class="n">field</span><span class="o">/</span><span class="n">eV</span><span class="o">*</span><span class="n">Ang</span><span class="p">,</span> <span class="s1">&#39; eV/Ang/e&#39;</span>
            <span class="k">end if</span>
            <span class="c">! The dipole correction energy has an extra factor</span>
            <span class="c">! of one half because the field involved is internal.</span>
            <span class="c">! See the paper by Bengtsson DOI:10.1103/PhysRevB.59.12301</span>
            <span class="c">! Hence we compute this part separately</span>
            <span class="n">DUext</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5_dp</span> <span class="o">*</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
         <span class="k">else</span>
<span class="k">            </span><span class="n">field</span> <span class="o">=</span> <span class="mf">0._dp</span>
            <span class="n">DUext</span> <span class="o">=</span> <span class="mf">0._dp</span>
         <span class="k">end if</span>
         <span class="c">! Add the external electric field</span>
         <span class="n">field</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="n">user_specified_field</span>
         <span class="c">! This routine expects a sequential array,</span>
         <span class="c">! but it is distribution-blind</span>
         <span class="k">call </span><span class="n">add_potential_from_field</span><span class="p">(</span> <span class="n">field</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span>
     <span class="p">&amp;</span>                                  <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
         <span class="c">! Add energy of external electric field</span>
         <span class="n">DUext</span> <span class="o">=</span> <span class="n">DUext</span> <span class="o">-</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">user_specified_field</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ---------------------------------------------------------------------</span>
<span class="c">!     Transiesta:</span>
<span class="c">!     add the potential corresponding to the (possible) voltage-drop.</span>
<span class="c">!     note that ts_voltage is not sharing the reord wih efield since</span>
<span class="c">!     we should not encounter both at the same time.</span>
<span class="c">! ---------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">TSmode</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">IsVolt</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">TSrun</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! This routine expects a sequential array,</span>
         <span class="c">! in whatever distribution</span>
<span class="cp">#ifdef TRANSIESTA_VOLTAGE_DEBUG</span>
<span class="c">!$OMP parallel workshare default(shared)</span>
         <span class="n">Vaux</span><span class="p">(:)</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP end parallel workshare</span>
<span class="cp">#endif</span>
         <span class="k">call </span><span class="n">ts_voltage</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">)</span>
<span class="cp">#ifdef TRANSIESTA_VOLTAGE_DEBUG</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> 
     <span class="p">&amp;</span>        <span class="s2">&quot;TransiestaHartreePotential&quot;</span><span class="p">)</span>
         <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;ts_volt&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
         <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s1">&#39;transiesta debug for Hartree potential&#39;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add potential from user defined geometries (if present)</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">hartree_add</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span>     <span class="k">Save </span><span class="n">electrostatic</span> <span class="n">potential</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Note that only the first spin component is used</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vh&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vaux</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">Vaux</span><span class="p">,</span> <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="n">C</span>     <span class="n">Get</span> <span class="n">back</span> <span class="n">spin</span> <span class="n">density</span> <span class="n">from</span> <span class="nb">sum and </span><span class="n">difference</span>
      <span class="c">! TODO Check for NC/SO:</span>
      <span class="c">! Should we diagonalize locally at every point first?</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(ip,rhotot)</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
          <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5_dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhotot</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5_dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhotot</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">endif</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="n">C</span> <span class="n">Set</span> <span class="n">uniform</span> <span class="n">distribution</span> <span class="n">of</span> <span class="n">mesh</span> <span class="n">points</span> <span class="nb">and </span><span class="n">find</span> <span class="n">my</span> <span class="n">processor</span> <span class="n">mesh</span> <span class="n">box</span>
<span class="n">C</span> <span class="n">This</span> <span class="k">is </span><span class="n">the</span> <span class="k">interface </span><span class="n">to</span> <span class="n">JM</span> <span class="n">Soler</span><span class="s1">&#39;s own cellxc routine, which sets</span>
<span class="s1">C up the right distribution internally.</span>
<span class="s1">C ----------------------------------------------------------------------</span>

<span class="s1">      call jms_setMeshDistr( distrID=JDGdistr, nMesh=ntm, </span>
<span class="s1">     .                   nNodesX=1, nNodesY=ProcessorY, nBlock=nsm )</span>
<span class="s1">      call myMeshBox( ntm, JDGdistr, myBox )</span>

<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">#endif /* ! BSC_CELLXC */</span>
<span class="s1">C Exchange-correlation energy</span>
<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">      call re_alloc( Vscf, 1, ntpl, 1, nspin, &#39;</span><span class="n">Vscf</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>

<span class="s1">      if (npcc .eq. 1) then</span>
<span class="s1">         </span>
<span class="s1">!$OMP parallel do default(shared), private(ip,ispin), collapse(2)</span>
<span class="s1">       do ispin = 1,nsd</span>
<span class="s1">          do ip= 1, ntpl</span>
<span class="s1">             DRho(ip,ispin) = DRho(ip,ispin) +</span>
<span class="s1">     &amp;            (rhopcc(ip)+rhoatm(ip)) * rnsd</span>
<span class="s1">          enddo</span>
<span class="s1">       enddo</span>
<span class="s1">!$OMP end parallel do</span>

<span class="s1">      else</span>

<span class="s1">!$OMP parallel do default(shared), private(ip,ispin), collapse(2)</span>
<span class="s1">       do ispin = 1,nsd</span>
<span class="s1">          do ip= 1, ntpl</span>
<span class="s1">             DRho(ip,ispin) = DRho(ip,ispin) +</span>
<span class="s1">     &amp;            rhoatm(ip) * rnsd</span>
<span class="s1">          enddo</span>
<span class="s1">       enddo</span>
<span class="s1">!$OMP end parallel do</span>

<span class="s1">      end if</span>

<span class="s1">      ! Write the electron density used by cellxc</span>
<span class="s1">      if (filesOut%rhoxc .ne. &#39;</span> <span class="s1">&#39;) then</span>
<span class="s1">#ifdef NCDF_4</span>
<span class="s1">        if ( write_cdf ) then</span>
<span class="s1">           call cdf_save_grid(trim(slabel)//&#39;</span><span class="p">.</span><span class="n">nc</span><span class="s1">&#39;,&#39;</span><span class="n">RhoXC</span><span class="s1">&#39;,nspin,ntml,</span>
<span class="s1">     &amp;          DRho )</span>
<span class="s1">        else</span>
<span class="s1">           call write_rho( filesOut%rhoxc, cell, ntm, nsm, ntpl, nspin,</span>
<span class="s1">     &amp;          DRho )</span>
<span class="s1">           call write_grid_netcdf( cell, ntm, nspin, ntpl, DRho, </span>
<span class="s1">     &amp;          &quot;RhoXC&quot;)</span>
<span class="s1">        end if</span>
<span class="s1">#else</span>
<span class="s1">        call write_rho( filesOut%rhoxc, cell, ntm, nsm, ntpl, nspin,</span>
<span class="s1">     &amp;       DRho )</span>
<span class="s1">        call write_grid_netcdf( cell, ntm, nspin, ntpl, DRho, </span>
<span class="s1">     &amp;       &quot;RhoXC&quot;)</span>
<span class="s1">#endif</span>
<span class="s1">      endif</span>

<span class="s1">!     Everything now is in UNIFORM, sequential form</span>

<span class="s1">      call timer(&quot;CellXC&quot;,1)</span>
<span class="s1">#ifdef BSC_CELLXC</span>
<span class="s1">      if (nodes.gt.1) then</span>
<span class="s1">         call setMeshDistr( LINEAR, nsm, nsp, nml, nmpl, ntml, ntpl )</span>
<span class="s1">      endif</span>

<span class="s1">      call re_alloc( Vscf_gga, 1, ntpl, 1, nspin, &#39;</span><span class="n">Vscf_gga</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>
<span class="s1">      call re_alloc( DRho_gga, 1, ntpl, 1, nspin, &#39;</span><span class="n">DRho_gga</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>

<span class="s1">      ! Redistribute all spin densities</span>
<span class="s1">      do ispin = 1, nspin</span>
<span class="s1">        fsrc =&gt; DRho(:,ispin)</span>
<span class="s1">        fdst =&gt; DRho_gga(:,ispin)</span>
<span class="s1">        call distMeshData( UNIFORM, fsrc, LINEAR, fdst, KEEP )</span>
<span class="s1">      enddo</span>

<span class="s1">      call bsc_cellxc( 0, 0, cell, ntml, ntml, ntpl, 0, aux3, nspin,</span>
<span class="s1">     &amp;             DRho_gga, Ex, Ec, DEx, DEc, Vscf_gga,</span>
<span class="s1">     &amp;             dummy_DVxcdn, stressl )</span>
<span class="s1">#endif /* BSC_CELLXC */</span>

<span class="s1">#ifndef BSC_CELLXC</span>
<span class="s1">      call cellXC( 0, cell, ntm, myBox(1,1), myBox(2,1),</span>
<span class="s1">     .                           myBox(1,2), myBox(2,2),</span>
<span class="s1">     .                           myBox(1,3), myBox(2,3), nspin,</span>
<span class="s1">     .             DRho, Ex, Ec, DEx, DEc, stressXC, Vscf )</span>
<span class="s1">#else /* BSC_CELLXC */</span>

<span class="s1">      if (nodes.gt.1) then</span>
<span class="s1">         call setMeshDistr( UNIFORM, nsm, nsp, nml, nmpl, ntml, ntpl )</span>
<span class="s1">      endif</span>

<span class="s1">      ! Redistribute to the Vxc array</span>
<span class="s1">      do ispin = 1,nspin</span>
<span class="s1">        fsrc =&gt; Vscf_gga(:,ispin)</span>
<span class="s1">        fdst =&gt; Vscf(:,ispin)</span>
<span class="s1">        call distMeshData( LINEAR, fsrc, UNIFORM, fdst, KEEP )</span>
<span class="s1">      enddo</span>
<span class="s1">#endif /* BSC_CELLXC */</span>

<span class="s1">      if ( debug_dhscf ) then</span>
<span class="s1">         write(*,debug_fmt) Node,&#39;</span><span class="n">XC</span><span class="s1">&#39;,</span>
<span class="s1">     &amp;        (sqrt(sum(Vscf(:,ispin)**2)),ispin=1,nspin)</span>
<span class="s1">      end if</span>
<span class="s1">      </span>
<span class="s1">      </span>
<span class="s1">#ifndef BSC_CELLXC</span>
<span class="s1">!     Vscf is still sequential after the call to JMS&#39;</span><span class="n">s</span> <span class="n">cellxc</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho_gga</span><span class="p">,</span> <span class="s1">&#39;DRho_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="s1">&#39;Vscf_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="n">Exc</span> <span class="o">=</span>  <span class="n">Ex</span> <span class="o">+</span>  <span class="n">Ec</span>
      <span class="n">Dxc</span> <span class="o">=</span> <span class="n">DEx</span> <span class="o">+</span> <span class="n">DEc</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;CellXC&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="c">!     Vscf contains only Vxc, and is UNIFORM and sequential</span>
<span class="c">!     Now we add up the other contributions to it, at </span>
<span class="c">!     the same time that we get DRho back to true DeltaRho form</span>
<span class="c">!$OMP parallel default(shared), private(ip,ispin)</span>

      <span class="c">! Hartree potential only has diagonal components</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP do</span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> 
     <span class="p">&amp;</span>             <span class="p">(</span><span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="n">rhopcc</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">rnsd</span>
              <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
           <span class="n">enddo</span>
<span class="c">!$OMP end do</span>
        <span class="k">else</span>
<span class="c">!$OMP do</span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
              <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
           <span class="n">enddo</span>
<span class="c">!$OMP end do</span>
        <span class="n">endif</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="n">stress</span> <span class="o">=</span> <span class="n">stress</span> <span class="o">+</span> <span class="n">stressXC</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span>     <span class="k">Save </span><span class="n">total</span> <span class="n">potential</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vt&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vscf</span><span class="p">)</span>
        <span class="k">else </span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vscf</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;TotalPotential&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">Vscf</span><span class="p">,</span> <span class="s2">&quot;TotalPotential&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="k">Print </span><span class="n">vacuum</span> <span class="n">level</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="o">/=</span><span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="o">/=</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        forall</span><span class="p">(</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nsd</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">rhoatm</span><span class="p">(:)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="k">call </span><span class="n">vacuum_level</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> 
     <span class="p">.</span>                     <span class="n">np_vac</span><span class="p">,</span> <span class="n">Vmax_vac</span><span class="p">,</span> <span class="n">Vmean_vac</span> <span class="p">)</span>
        <span class="k">forall</span><span class="p">(</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nsd</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(:)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np_vac</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">Node</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">print</span><span class="s1">&#39;(/,a,2f12.6,a)&#39;</span><span class="p">,</span> 
     <span class="p">.</span>    <span class="s1">&#39;dhscf: Vacuum level (max, mean) =&#39;</span><span class="p">,</span> 
     <span class="p">.</span>    <span class="n">Vmax_vac</span><span class="o">/</span><span class="n">eV</span><span class="p">,</span> <span class="n">Vmean_vac</span><span class="o">/</span><span class="n">eV</span><span class="p">,</span> <span class="s1">&#39; eV&#39;</span>
      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span> <span class="o">/=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">save_ebs_density</span><span class="p">()</span>
      <span class="n">endif</span>
      
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span>     <span class="n">Find</span> <span class="n">SCF</span> <span class="n">contribution</span> <span class="n">to</span> <span class="n">hamiltonian</span> <span class="n">matrix</span> <span class="n">elements</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">iHmat</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                         <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
         <span class="n">endif</span>

<span class="c">!        This is a work array, to which we copy Vscf</span>
         <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
           <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
         <span class="n">enddo</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">Spiral</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">vmatsp</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">qspiral</span> <span class="p">)</span>
         <span class="k">else</span>
<span class="k">            call </span><span class="n">vmat</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>
         <span class="n">endif</span>

         <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span>  <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!          Everything back to UNIFORM, sequential</span>
           <span class="k">call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                         <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
         <span class="n">endif</span>
      <span class="n">endif</span>


<span class="cp">#ifdef MPI</span>
<span class="n">C</span>     <span class="n">Global</span> <span class="n">reduction</span> <span class="n">of</span> <span class="n">Uscf</span><span class="o">/</span><span class="n">DUscf</span><span class="o">/</span><span class="n">Uatm</span><span class="o">/</span><span class="n">Enaatm</span><span class="o">/</span><span class="n">Enascf</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Note that Exc and Dxc are already reduced in the new cellxc</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uscf</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DUscf</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uatm</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Enaatm</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Enascf</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Exc</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">Dxc</span>
<span class="cp">#else</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">call </span><span class="n">MPI_AllReduce</span><span class="p">(</span> <span class="n">sbuffer</span><span class="p">,</span> <span class="n">rbuffer</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">MPI_double_precision</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">MPI_Sum</span><span class="p">,</span> <span class="n">MPI_Comm_World</span><span class="p">,</span> <span class="n">MPIerror</span> <span class="p">)</span>
      <span class="n">Uscf</span>   <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">DUscf</span>  <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">Uatm</span>   <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="n">Exc</span>    <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
      <span class="n">Dxc</span>    <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
<span class="cp">#endif /* MPI */</span>

<span class="n">C</span>     <span class="n">Add</span> <span class="n">contribution</span> <span class="n">to</span> <span class="n">stress</span> <span class="n">from</span> <span class="n">the</span> <span class="n">derivative</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Jacobian</span> <span class="n">of</span> <span class="o">---</span>
<span class="n">C</span>     <span class="n">r</span><span class="o">-&gt;</span><span class="n">r</span><span class="s1">&#39; (strained r) in the integral of Vna*(rhoscf-rhoatm)</span>
<span class="s1">      if (istr .eq. 1) then</span>
<span class="s1">        do i = 1,3</span>
<span class="s1">          stress(i,i) = stress(i,i) + ( Enascf - Enaatm ) / volume</span>
<span class="s1">        enddo</span>
<span class="s1">      endif</span>

<span class="s1">C     Stop time counter for SCF iteration part</span>
<span class="s1">      call timer( &#39;</span><span class="n">DHSCF3</span><span class="s1">&#39;, 2 )</span>

<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">C     End of SCF iteration part</span>
<span class="s1">C ----------------------------------------------------------------------</span>

<span class="s1">      if (ifa.eq.1 .or. istr.eq.1) then</span>
<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">C Forces and stress : SCF contribution</span>
<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">C       Start time counter for force calculation part</span>
<span class="s1">        call timer( &#39;</span><span class="n">DHSCF4</span><span class="s1">&#39;, 1 )</span>

<span class="s1">C       Find contribution of partial-core-correction</span>
<span class="s1">        if (npcc .eq. 1) then</span>
<span class="s1">          call reord( rhopcc, rhopcc, nml, nsm, TO_CLUSTER )</span>
<span class="s1">          call reord( Vaux, Vaux, nml, nsm, TO_CLUSTER )</span>
<span class="s1">          ! The partial core calculation only acts on</span>
<span class="s1">          ! the diagonal spin-components (no need to</span>
<span class="s1">          ! redistribute un-used elements)</span>
<span class="s1">          do ispin = 1, nsd</span>
<span class="s1">            call reord( Vscf(:,ispin), Vscf(:,ispin),</span>
<span class="s1">     &amp;                  nml, nsm, TO_CLUSTER )</span>
<span class="s1">          enddo</span>

<span class="s1">          call PartialCoreOnMesh( na, isa, ntpl, rhopcc, indxua, nsd,</span>
<span class="s1">     &amp;                            dvol, volume, Vscf, Vaux, Fal,</span>
<span class="s1">     &amp;                            stressl, ifa.ne.0, istr.ne.0 )</span>
<span class="s1">   </span>
<span class="s1">          call reord( rhopcc, rhopcc, nml, nsm, TO_SEQUENTIAL )</span>
<span class="s1">          call reord( Vaux, Vaux, nml, nsm, TO_SEQUENTIAL )</span>
<span class="s1">          ! ** see above</span>
<span class="s1">          do ispin = 1, nsd</span>
<span class="s1">            call reord( Vscf(:,ispin), Vscf(:,ispin),</span>
<span class="s1">     &amp;                  nml, nsm, TO_SEQUENTIAL )</span>
<span class="s1">          enddo</span>

<span class="s1">          if ( debug_dhscf ) then</span>
<span class="s1">             write(*,debug_fmt) Node,&#39;</span><span class="n">PartialCore</span><span class="s1">&#39;,</span>
<span class="s1">     &amp;            (sqrt(sum(Vscf(:,ispin)**2)),ispin=1,nsd)</span>
<span class="s1">          end if</span>
<span class="s1">        endif</span>

<span class="s1">        if ( harrisfun) then</span>
<span class="s1">!         Forhar deals internally with its own needs</span>
<span class="s1">!         for distribution changes</span>
<span class="s1">#ifndef BSC_CELLXC</span>
<span class="s1">          call forhar( ntpl, nspin, nml, ntml, ntm, npcc, cell, </span>
<span class="s1">#else /* BSC_CELLXC */</span>
<span class="s1">          call forhar( ntpl, nspin, nml, ntml, npcc, cell, </span>
<span class="s1">#endif /* BSC_CELLXC */</span>
<span class="s1">     &amp;                 rhoatm, rhopcc, Vna, DRho, Vscf, Vaux )</span>
<span class="s1">!         Upon return, everything is UNIFORM, sequential form</span>
<span class="s1">        endif</span>

<span class="s1">C     Transform spin density into sum and difference</span>
<span class="s1">        ! TODO NC/SO</span>
<span class="s1">        ! Should we perform local diagonalization?</span>
<span class="s1">        if (nsd .eq. 2) then</span>
<span class="s1">!$OMP parallel do default(shared), private(rhotot,ip)</span>
<span class="s1">          do ip = 1,ntpl</span>
<span class="s1">            rhotot     = DRho(ip,1) + DRho(ip,2)</span>
<span class="s1">            DRho(ip,2) = DRho(ip,2) - DRho(ip,1)</span>
<span class="s1">            DRho(ip,1) = rhotot</span>
<span class="s1">          enddo</span>
<span class="s1">!$OMP end parallel do</span>
<span class="s1">        endif</span>

<span class="s1">C       Find contribution of neutral-atom potential</span>
<span class="s1">        call reord( Vna, Vna, nml, nsm, TO_CLUSTER )</span>
<span class="s1">        call reord( DRho, DRho, nml, nsm, TO_CLUSTER )</span>
<span class="s1">        call NeutralAtomOnMesh( na, isa, ntpl, Vna, indxua, dvol, </span>
<span class="s1">     &amp;                          volume, DRho, Fal, stressl, </span>
<span class="s1">     &amp;                          ifa.ne.0, istr.ne.0 )</span>
<span class="s1">        call reord( DRho, DRho, nml, nsm, TO_SEQUENTIAL )</span>
<span class="s1">        call reord( Vna, Vna, nml, nsm, TO_SEQUENTIAL )</span>

<span class="s1">        if (nodes.gt.1) then</span>
<span class="s1">           call setMeshDistr( QUADRATIC, nsm, nsp,</span>
<span class="s1">     &amp;                       nml, nmpl, ntml, ntpl )</span>
<span class="s1">        endif</span>

<span class="s1">        call re_alloc( Vscf_par, 1, ntpl, 1, nspin,</span>
<span class="s1">     &amp;                 &#39;</span><span class="n">Vscf_par</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>
<span class="s1">        do ispin = 1, nspin</span>
<span class="s1">          fsrc =&gt; Vscf(:,ispin)</span>
<span class="s1">          fdst =&gt; Vscf_par(:,ispin)</span>
<span class="s1">          call distMeshData( UNIFORM, fsrc,</span>
<span class="s1">     &amp;                       QUADRATIC, fdst, TO_CLUSTER )</span>
<span class="s1">        enddo</span>

<span class="s1">!       Remember that Vaux contains everything except Vxc</span>
<span class="s1">        call re_alloc( Vaux_par, 1, ntpl, &#39;</span><span class="n">Vaux_par</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>
<span class="s1">        call distMeshData( UNIFORM, Vaux,</span>
<span class="s1">     &amp;                     QUADRATIC, Vaux_par, TO_CLUSTER )</span>

<span class="s1">        call dfscf( ifa, istr, na, norb, nuo, nuotot, nmpl, nspin,</span>
<span class="s1">     &amp;              indxua, isa, iaorb, iphorb, </span>
<span class="s1">     &amp;              maxnd, numd, listdptr, listd, Dscf, datm,</span>
<span class="s1">     &amp;              Vscf_par, Vaux_par, dvol, volume, Fal, stressl )</span>

<span class="s1">        call de_alloc( Vaux_par, &#39;</span><span class="n">Vaux_par</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>
<span class="s1">        call de_alloc( Vscf_par, &#39;</span><span class="n">Vscf_par</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>

<span class="s1">        if (nodes.gt.1) then</span>
<span class="s1">          call setMeshDistr( UNIFORM, nsm, nsp, nml, nmpl, ntml, ntpl )</span>
<span class="s1">        endif</span>


<span class="s1">C       Stop time counter for force calculation part</span>
<span class="s1">        call timer( &#39;</span><span class="n">DHSCF4</span><span class="s1">&#39;, 2 )</span>
<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">C       End of force and stress calculation</span>
<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">      endif</span>

<span class="s1">!     We are in the UNIFORM distribution</span>
<span class="s1">!     Rhoatm, Rhopcc and Vna are in UNIFORM dist, sequential form</span>
<span class="s1">!     The index array endpht is in the QUADRATIC distribution</span>

<span class="s1">C     Stop time counter</span>
<span class="s1">      call timer( &#39;</span><span class="n">DHSCF</span><span class="s1">&#39;, 2 )</span>

<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">C     Free locally allocated memory</span>
<span class="s1">C ----------------------------------------------------------------------</span>
<span class="s1">      call de_alloc( Vaux, &#39;</span><span class="n">Vaux</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>
<span class="s1">      call de_alloc( Vscf, &#39;</span><span class="n">Vscf</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>
<span class="s1">      call de_alloc( DRho, &#39;</span><span class="n">DRho</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>

<span class="s1">#ifdef DEBUG</span>
<span class="s1">      call write_debug( &#39;</span>    <span class="n">POS</span> <span class="n">DHSCF</span><span class="s1">&#39; )</span>
<span class="s1">#endif</span>
<span class="s1">!------------------------------------------------------------------------ END</span>
<span class="s1">      CONTAINS</span>

<span class="s1">      subroutine save_bader_charge()</span>
<span class="s1">      use meshsubs, only: ModelCoreChargeOnMesh</span>
<span class="s1">#ifdef NCDF_4</span>
<span class="s1">      use siesta_options, only: write_cdf</span>
<span class="s1">      use m_ncdf_siesta, only: cdf_save_grid</span>
<span class="s1">#endif</span>
<span class="s1">      ! Auxiliary routine to output the Bader Charge</span>
<span class="s1">      !</span>
<span class="s1">      real(grid_p), pointer :: BaderCharge(:) =&gt; null()</span>

<span class="s1">      call re_alloc( BaderCharge, 1, ntpl, name=&#39;</span><span class="n">BaderCharge</span><span class="s1">&#39;,</span>
<span class="s1">     &amp;                 routine=&#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>

<span class="s1">      ! Find a model core charge by re-scaling the local charge</span>
<span class="s1">      call ModelCoreChargeOnMesh( na, isa, ntpl, BaderCharge, indxua )</span>
<span class="s1">      ! It comes out in clustered form, so we convert it</span>
<span class="s1">      call reord( BaderCharge, BaderCharge, nml, nsm, TO_SEQUENTIAL)</span>
<span class="s1">      do ispin = 1,nsd</span>
<span class="s1">         BaderCharge(1:ntpl) = BaderCharge(1:ntpl) + DRho(1:ntpl,ispin)</span>
<span class="s1">      enddo</span>
<span class="s1">#ifdef NCDF_4</span>
<span class="s1">      if ( write_cdf ) then</span>
<span class="s1">         call cdf_save_grid(trim(slabel)//&#39;</span><span class="p">.</span><span class="n">nc</span><span class="s1">&#39;,&#39;</span><span class="n">RhoBader</span><span class="s1">&#39;,1,ntml,</span>
<span class="s1">     &amp;        BaderCharge)</span>
<span class="s1">      else</span>
<span class="s1">         call write_rho( trim(slabel)// &quot;.BADER&quot;, cell,</span>
<span class="s1">     $        ntm, nsm, ntpl, 1, BaderCharge )</span>
<span class="s1">         call write_grid_netcdf( cell, ntm, 1, ntpl,</span>
<span class="s1">     $        BaderCharge, &quot;BaderCharge&quot;)</span>
<span class="s1">      end if</span>
<span class="s1">#else</span>
<span class="s1">      call write_rho( trim(slabel)// &quot;.BADER&quot;, cell,</span>
<span class="s1">     $     ntm, nsm, ntpl, 1, BaderCharge )</span>
<span class="s1">      call write_grid_netcdf( cell, ntm, 1, ntpl,</span>
<span class="s1">     $     BaderCharge, &quot;BaderCharge&quot;)</span>
<span class="s1">#endif</span>

<span class="s1">      call de_alloc( BaderCharge, name=&#39;</span><span class="n">BaderCharge</span><span class="s1">&#39; )</span>
<span class="s1">      end subroutine save_bader_charge</span>

<span class="s1">      subroutine setup_analysis_options()</span>
<span class="s1">      !! For the analyze-charge-density-only case,</span>
<span class="s1">      !! avoiding any diagonalization</span>
<span class="s1">      </span>
<span class="s1">      use siesta_options, only: hirshpop, voropop</span>
<span class="s1">      use siesta_options, only: saverho, savedrho, saverhoxc</span>
<span class="s1">      use siesta_options, only: savevh, savevt, savevna</span>
<span class="s1">      use siesta_options, only: savepsch, savetoch</span>
<span class="s1">      </span>
<span class="s1">      want_partial_charges = (hirshpop .or. voropop) </span>

<span class="s1">      if (saverho)   filesOut%rho   = trim(slabel)//&#39;</span><span class="p">.</span><span class="n">RHO</span><span class="s1">&#39; </span>
<span class="s1">      if (savedrho)  filesOut%drho  = trim(slabel)//&#39;</span><span class="p">.</span><span class="n">DRHO</span><span class="s1">&#39;</span>
<span class="s1">      if (saverhoxc) filesOut%rhoxc = trim(slabel)//&#39;</span><span class="p">.</span><span class="n">RHOXC</span><span class="s1">&#39;</span>
<span class="s1">      if (savevh)    filesOut%vh    = trim(slabel)//&#39;</span><span class="p">.</span><span class="n">VH</span><span class="s1">&#39;  </span>
<span class="s1">      if (savevt)    filesOut%vt    = trim(slabel)//&#39;</span><span class="p">.</span><span class="n">VT</span><span class="s1">&#39;  </span>
<span class="s1">      if (savevna)   filesOut%vna   = trim(slabel)//&#39;</span><span class="p">.</span><span class="n">VNA</span><span class="s1">&#39; </span>
<span class="s1">      if (savepsch)  filesOut%psch  = trim(slabel)//&#39;</span><span class="p">.</span><span class="n">IOCH</span><span class="s1">&#39;</span>
<span class="s1">      if (savetoch)  filesOut%toch  = trim(slabel)//&#39;</span><span class="p">.</span><span class="n">TOCH</span><span class="s1">&#39;</span>
<span class="s1">      </span>
<span class="s1">      end subroutine setup_analysis_options</span>

<span class="s1">      subroutine save_ebs_density()</span>

<span class="s1">         ! Optional output of the &quot;band-structure energy density&quot;, which</span>
<span class="s1">         ! is just the charge density weighted by the eigenvalues, i.e.,</span>
<span class="s1">         ! using EDM instead of DM in rhoofd</span>

<span class="s1">      use sparse_matrices, only: Escf</span>
<span class="s1">      </span>
<span class="s1">      real(grid_p), pointer :: Ebs_dens(:,:) =&gt; null(),</span>
<span class="s1">     &amp;                         Ebs_dens_quad(:,:) =&gt; null()</span>

<span class="s1">!     Allocate memory for Ebs_dens using the UNIFORM data distribution</span>
<span class="s1">      call re_alloc( Ebs_dens, 1, ntpl, 1, nspin, &#39;</span><span class="n">Ebs_dens</span><span class="s1">&#39;,&#39;</span><span class="n">dhscf</span><span class="s1">&#39;)</span>

<span class="s1">      ! Switch to quadratic distribution for call to rhoofd</span>
<span class="s1">      if (nodes.gt.1) then</span>
<span class="s1">         call setMeshDistr( QUADRATIC, nsm, nsp,</span>
<span class="s1">     &amp;        nml, nmpl, ntml, ntpl )</span>
<span class="s1">      endif</span>
<span class="s1">         </span>
<span class="s1">      call re_alloc( ebs_dens_quad, 1, ntpl, 1, nspin,</span>
<span class="s1">     &amp;     &#39;</span><span class="n">Ebs_dens_quad</span><span class="s1">&#39;, &#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>
<span class="s1">      call rhoofd( norb, nmpl, maxnd, numd, listdptr, listd,</span>
<span class="s1">     &amp;     nspin, Escf, Ebs_dens_quad,</span>
<span class="s1">     &amp;     nuo, nuotot, iaorb, iphorb, isa )</span>

<span class="s1">      ! Ebs_dens_par is here in QUADRATIC, clustered form</span>

<span class="s1">      ! Set the UNIFORM distribution again and copy Ebs_dens to it</span>
<span class="s1">      if (nodes.gt.1) then</span>
<span class="s1">         call setMeshDistr( UNIFORM, nsm, nsp, nml, nmpl, ntml, ntpl )</span>
<span class="s1">      endif</span>
<span class="s1">      do ispin = 1, nspin</span>
<span class="s1">         fsrc =&gt; Ebs_dens_quad(:,ispin)</span>
<span class="s1">         fdst =&gt; Ebs_dens(:,ispin)</span>
<span class="s1">         ! Sequential to be able to write it out</span>
<span class="s1">         ! if nodes==1, this call will just reorder</span>
<span class="s1">         call distMeshData( QUADRATIC, fsrc,</span>
<span class="s1">     &amp;        UNIFORM, fdst, TO_SEQUENTIAL )</span>
<span class="s1">      enddo</span>
<span class="s1">      call de_alloc( Ebs_dens_quad, &#39;</span><span class="n">Ebs_dens_quad</span><span class="s1">&#39;,&#39;</span><span class="n">dhscf</span><span class="s1">&#39; )</span>
<span class="s1">#ifdef NCDF_4</span>
<span class="s1">      if ( write_cdf ) then</span>
<span class="s1">         call cdf_save_grid(trim(slabel)//&#39;</span><span class="p">.</span><span class="n">nc</span><span class="s1">&#39;,&#39;</span><span class="n">Ebs_density</span><span class="s1">&#39;,</span>
<span class="s1">     $        nspin,ntml, Ebs_dens)</span>
<span class="s1">      else </span>
<span class="s1">         call write_rho( filesOut%ebs_dens,</span>
<span class="s1">     $        cell, ntm, nsm, ntpl, nspin, Ebs_dens )</span>
<span class="s1">         call write_grid_netcdf( cell, ntm, nspin, ntpl, Ebs_dens, </span>
<span class="s1">     &amp;        &quot;Ebs_density&quot;)</span>
<span class="s1">      end if</span>
<span class="s1">#else</span>
<span class="s1">      call write_rho( filesOut%ebs_dens, cell, ntm, nsm, ntpl, nspin,</span>
<span class="s1">     $     Ebs_dens)</span>
<span class="s1">      call write_grid_netcdf( cell, ntm, nspin, ntpl,</span>
<span class="s1">     &amp;     Ebs_dens, &quot;Ebs_density&quot;)</span>
<span class="s1">#endif</span>
<span class="s1">      call de_alloc( Ebs_dens, &#39;</span><span class="n">Ebs_dens</span><span class="s1">&#39;,&#39;</span><span class="n">dhscf</span><span class="err">&#39;</span> <span class="p">)</span>
        
      <span class="k">end subroutine </span><span class="n">save_ebs_density</span>
<span class="c">!      </span>
      <span class="k">end subroutine </span><span class="n">dhscf</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> SIESTA was developed by SIESTA Group</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    
  </body>
</html>