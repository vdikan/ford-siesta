<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A first-principles materials simulation code using Density Functional Theory.">
    
    <meta name="author" content="SIESTA Group" >
    <link rel="icon" href="../favicon.png">

    <title>dhscf &ndash; SIESTA</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">SIESTA <small>trunk-700--vdikan-edens-711-ford-681</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Program Overview</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>dhscf
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     <li><i class="fa fa-pencil"></i> J.M. Soler</li>
     
     
    <li><i class="fa fa-calendar-o"></i> August 1996</li>
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 7.1% of total for procedures.">659 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/dhscf.F"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/dhscf.f.html'>dhscf.F</a></li>
    
     <li><a href='../module/m_dhscf.html'>m_dhscf</a></li>
    
  
     <li class="active">dhscf</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/dhscf.html#src">dhscf</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine dhscf(nspin, norb, iaorb, iphorb, nuo, nuotot, nua, na, isa, xa, indxua, ntm, ifa, istr, iHmat, filesOut, maxnd, numd, listdptr, listd, Dscf, datm, maxnh, Hmat, Enaatm, Enascf, Uatm, Uscf, DUscf, DUext, Exc, Dxc, dipol, stress, Fal, stressl, use_rhog_in, charge_density_only)
    
    
   
</h2>
    
  
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Uses</h3>
      </div>
      <ul class="list-group">
      
      <li class="list-group-item">
  <ul class="list-inline">
    
    <li><a href='../module/precision.html'>precision</a></li>
    
    <li><a href='../module/parallel.html'>parallel</a></li>
    
    <li><a href='../module/parallel.html'>parallel</a></li>
    
    <li><a href='../module/atmfuncs.html'>atmfuncs</a></li>
    
    <li><a href='../module/units.html'>units</a></li>
    
    <li>fdf</li>
    
    <li><a href='../module/sys.html'>sys</a></li>
    
    <li><a href='../module/mesh.html'>mesh</a></li>
    
    <li>parsing</li>
    
    <li><a href='../module/m_iorho.html'>m_iorho</a></li>
    
    <li><a href='../module/m_forhar.html'>m_forhar</a></li>
    
    <li>alloc</li>
    
    <li>files</li>
    
    <li>files</li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li>meshsubs</li>
    
    <li>meshsubs</li>
    
    <li>meshsubs</li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li>m_partial_charges</li>
    
    <li>m_partial_charges</li>
    
    <li>siestaXC</li>
    
    <li>siestaXC</li>
    
    <li>siestaXC</li>
    
    <li><a href='../module/m_vmat.html'>m_vmat</a></li>
    
    <li><a href='../module/m_rhoofd.html'>m_rhoofd</a></li>
    
    <li>mpi_siesta</li>
    
    <li>iogrid_netcdf</li>
    
    <li>iogrid_netcdf</li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li>m_efield</li>
    
    <li>m_efield</li>
    
    <li>m_efield</li>
    
    <li>m_doping_uniform</li>
    
    <li>m_charge_add</li>
    
    <li>m_hartree_add</li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li>m_ncdf_siesta</li>
    
    <li>m_rhofft</li>
    
    <li><a href='../module/m_rhog.html'>m_rhog</a></li>
    
    <li>m_spin</li>
    
    <li>m_spin</li>
    
    <li>m_iotddft</li>
    
    <li>m_ts_global_vars</li>
    
    <li>m_ts_options</li>
    
    <li>m_ts_voltage</li>
    
    <li>m_ts_hartree</li>
    
  </ul>
      </li>
      
      
      
      <li class="list-group-item">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~UsesGraph Pages: 1 -->
<svg id="procdhscfUsesGraph" width="596pt" height="1260pt"
 viewBox="0.00 0.00 596.00 1260.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 1256)">
<title>proc~~dhscf~~UsesGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1256 592,-1256 592,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~UsesGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="588,-636 534,-636 534,-612 588,-612 588,-636"/>
<text text-anchor="middle" x="561" y="-621.6" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- m_charge_add -->
<g id="proc~~dhscf~~UsesGraph_node2" class="node"><title>m_charge_add</title>
<polygon fill="#337ab7" stroke="#337ab7" points="489.5,-1252 404.5,-1252 404.5,-1228 489.5,-1228 489.5,-1252"/>
<text text-anchor="middle" x="447" y="-1237.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_charge_add</text>
</g>
<!-- proc~dhscf&#45;&gt;m_charge_add -->
<g id="proc~~dhscf~~UsesGraph_edge1" class="edge"><title>proc~dhscf&#45;&gt;m_charge_add</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.473,-636.109C555.885,-716.41 534.094,-1170.37 498,-1219 497.435,-1219.76 496.838,-1220.49 496.211,-1221.2"/>
<polygon fill="#000000" stroke="#000000" points="493.825,-1218.64 488.526,-1227.81 498.39,-1223.94 493.825,-1218.64"/>
</g>
<!-- m_partial_charges -->
<g id="proc~~dhscf~~UsesGraph_node3" class="node"><title>m_partial_charges</title>
<polygon fill="#337ab7" stroke="#337ab7" points="497.5,-1210 396.5,-1210 396.5,-1186 497.5,-1186 497.5,-1210"/>
<text text-anchor="middle" x="447" y="-1195.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_partial_charges</text>
</g>
<!-- proc~dhscf&#45;&gt;m_partial_charges -->
<g id="proc~~dhscf~~UsesGraph_edge2" class="edge"><title>proc~dhscf&#45;&gt;m_partial_charges</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.133,-636.05C560.713,-708.003 560.621,-1080.85 498,-1172 495.972,-1174.95 493.501,-1177.59 490.756,-1179.95"/>
<polygon fill="#000000" stroke="#000000" points="488.558,-1177.22 482.433,-1185.86 492.612,-1182.92 488.558,-1177.22"/>
</g>
<!-- module~units -->
<g id="proc~~dhscf~~UsesGraph_node4" class="node"><title>module~units</title>
<g id="a_proc~~dhscf~~UsesGraph_node4"><a xlink:href=".././module/units.html" xlink:title="units">
<polygon fill="#337ab7" stroke="#337ab7" points="169,-1026 115,-1026 115,-1002 169,-1002 169,-1026"/>
<text text-anchor="middle" x="142" y="-1011.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">units</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~units -->
<g id="proc~~dhscf~~UsesGraph_edge3" class="edge"><title>proc~dhscf&#45;&gt;module~units</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-1036C403.157,-1064.4 249.903,-1036.8 179.205,-1022.01"/>
<polygon fill="#000000" stroke="#000000" points="179.905,-1018.58 169.396,-1019.93 178.452,-1025.43 179.905,-1018.58"/>
</g>
<!-- m_ts_global_vars -->
<g id="proc~~dhscf~~UsesGraph_node5" class="node"><title>m_ts_global_vars</title>
<polygon fill="#337ab7" stroke="#337ab7" points="495.5,-1130 398.5,-1130 398.5,-1106 495.5,-1106 495.5,-1130"/>
<text text-anchor="middle" x="447" y="-1115.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_global_vars</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_global_vars -->
<g id="proc~~dhscf~~UsesGraph_edge4" class="edge"><title>proc~dhscf&#45;&gt;m_ts_global_vars</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.996,-636.159C559.745,-702.609 555.522,-1021.61 498,-1097 497.425,-1097.75 496.819,-1098.48 496.183,-1099.18"/>
<polygon fill="#000000" stroke="#000000" points="493.804,-1096.61 488.434,-1105.74 498.327,-1101.95 493.804,-1096.61"/>
</g>
<!-- parsing -->
<g id="proc~~dhscf~~UsesGraph_node6" class="node"><title>parsing</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-1088 420,-1088 420,-1064 474,-1064 474,-1088"/>
<text text-anchor="middle" x="447" y="-1073.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parsing</text>
</g>
<!-- proc~dhscf&#45;&gt;parsing -->
<g id="proc~~dhscf~~UsesGraph_edge5" class="edge"><title>proc~dhscf&#45;&gt;parsing</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.697,-636.087C557.93,-698.143 547.251,-980.705 498,-1050 494.206,-1055.34 488.977,-1059.66 483.324,-1063.14"/>
<polygon fill="#000000" stroke="#000000" points="481.453,-1060.17 474.236,-1067.92 484.715,-1066.36 481.453,-1060.17"/>
</g>
<!-- module~parallel -->
<g id="proc~~dhscf~~UsesGraph_node7" class="node"><title>module~parallel</title>
<g id="a_proc~~dhscf~~UsesGraph_node7"><a xlink:href=".././module/parallel.html" xlink:title="parallel">
<polygon fill="#337ab7" stroke="#337ab7" points="169,-924 115,-924 115,-900 169,-900 169,-924"/>
<text text-anchor="middle" x="142" y="-909.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parallel</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~parallel -->
<g id="proc~~dhscf~~UsesGraph_edge6" class="edge"><title>proc~dhscf&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.108,-636.218C555.314,-684.477 538.805,-860.848 498,-895 450.622,-934.653 260.132,-922.671 179.424,-915.573"/>
<polygon fill="#000000" stroke="#000000" points="179.515,-912.067 169.24,-914.652 178.884,-919.038 179.515,-912.067"/>
</g>
<!-- module~sys -->
<g id="proc~~dhscf~~UsesGraph_node8" class="node"><title>module~sys</title>
<g id="a_proc~~dhscf~~UsesGraph_node8"><a xlink:href=".././module/sys.html" xlink:title="sys">
<polygon fill="#337ab7" stroke="#337ab7" points="169,-434 115,-434 115,-410 169,-410 169,-434"/>
<text text-anchor="middle" x="142" y="-419.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">sys</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~sys -->
<g id="proc~~dhscf~~UsesGraph_edge7" class="edge"><title>proc~dhscf&#45;&gt;module~sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-422C249.349,-419.387 207.904,-419.765 179.065,-420.566"/>
<polygon fill="#000000" stroke="#000000" points="178.931,-417.068 169.044,-420.876 179.147,-424.065 178.931,-417.068"/>
</g>
<!-- m_ts_voltage -->
<g id="proc~~dhscf~~UsesGraph_node9" class="node"><title>m_ts_voltage</title>
<polygon fill="#337ab7" stroke="#337ab7" points="485,-1008 409,-1008 409,-984 485,-984 485,-1008"/>
<text text-anchor="middle" x="447" y="-993.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_voltage</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_voltage -->
<g id="proc~~dhscf~~UsesGraph_edge8" class="edge"><title>proc~dhscf&#45;&gt;m_ts_voltage</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.384,-636.17C556.35,-691.709 541.352,-920.728 498,-975 496.722,-976.6 495.3,-978.08 493.768,-979.448"/>
<polygon fill="#000000" stroke="#000000" points="491.491,-976.771 485.347,-985.402 495.533,-982.487 491.491,-976.771"/>
</g>
<!-- siestaXC -->
<g id="proc~~dhscf~~UsesGraph_node10" class="node"><title>siestaXC</title>
<polygon fill="#337ab7" stroke="#337ab7" points="314,-1006 259,-1006 259,-982 314,-982 314,-1006"/>
<text text-anchor="middle" x="286.5" y="-991.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siestaXC</text>
</g>
<!-- proc~dhscf&#45;&gt;siestaXC -->
<g id="proc~~dhscf~~UsesGraph_edge9" class="edge"><title>proc~dhscf&#45;&gt;siestaXC</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.684,-636.034C557.899,-695.361 547.313,-956.276 498,-1017 483.014,-1035.45 467.815,-1022.87 448,-1036"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-1036C435.764,-1042.79 367.312,-1021.34 323.777,-1006.64"/>
<polygon fill="#000000" stroke="#000000" points="324.691,-1003.25 314.097,-1003.34 322.435,-1009.88 324.691,-1003.25"/>
</g>
<!-- module~mesh -->
<g id="proc~~dhscf~~UsesGraph_node11" class="node"><title>module~mesh</title>
<g id="a_proc~~dhscf~~UsesGraph_node11"><a xlink:href=".././module/mesh.html" xlink:title="mesh">
<polygon fill="#337ab7" stroke="#337ab7" points="313.5,-1088 259.5,-1088 259.5,-1064 313.5,-1064 313.5,-1088"/>
<text text-anchor="middle" x="286.5" y="-1073.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mesh</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~mesh -->
<g id="proc~~dhscf~~UsesGraph_edge10" class="edge"><title>proc~dhscf&#45;&gt;module~mesh</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.477,-636.298C556.164,-711.238 536.994,-1104.42 498,-1139 442.863,-1187.9 351.065,-1127.12 309.339,-1094.35"/>
<polygon fill="#000000" stroke="#000000" points="311.445,-1091.55 301.456,-1088.02 307.063,-1097.01 311.445,-1091.55"/>
</g>
<!-- m_iotddft -->
<g id="proc~~dhscf~~UsesGraph_node12" class="node"><title>m_iotddft</title>
<polygon fill="#337ab7" stroke="#337ab7" points="475.5,-886 418.5,-886 418.5,-862 475.5,-862 475.5,-886"/>
<text text-anchor="middle" x="447" y="-871.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_iotddft</text>
</g>
<!-- proc~dhscf&#45;&gt;m_iotddft -->
<g id="proc~~dhscf~~UsesGraph_edge11" class="edge"><title>proc~dhscf&#45;&gt;m_iotddft</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.231,-636.145C560.284,-673.364 555.497,-787.283 498,-853 494.358,-857.163 489.754,-860.521 484.822,-863.225"/>
<polygon fill="#000000" stroke="#000000" points="483.343,-860.052 475.726,-867.417 486.273,-866.41 483.343,-860.052"/>
</g>
<!-- m_efield -->
<g id="proc~~dhscf~~UsesGraph_node13" class="node"><title>m_efield</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-844 420,-844 420,-820 474,-820 474,-844"/>
<text text-anchor="middle" x="447" y="-829.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_efield</text>
</g>
<!-- proc~dhscf&#45;&gt;m_efield -->
<g id="proc~~dhscf~~UsesGraph_edge12" class="edge"><title>proc~dhscf&#45;&gt;m_efield</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.34,-636.219C556.945,-668.842 546.087,-759.035 498,-811 493.944,-815.383 488.829,-818.883 483.429,-821.668"/>
<polygon fill="#000000" stroke="#000000" points="481.96,-818.491 474.208,-825.712 484.771,-824.901 481.96,-818.491"/>
</g>
<!-- m_doping_uniform -->
<g id="proc~~dhscf~~UsesGraph_node14" class="node"><title>m_doping_uniform</title>
<polygon fill="#337ab7" stroke="#337ab7" points="498,-802 396,-802 396,-778 498,-778 498,-802"/>
<text text-anchor="middle" x="447" y="-787.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_doping_uniform</text>
</g>
<!-- proc~dhscf&#45;&gt;m_doping_uniform -->
<g id="proc~~dhscf~~UsesGraph_edge13" class="edge"><title>proc~dhscf&#45;&gt;m_doping_uniform</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M557.974,-636.239C552.836,-663.614 536.843,-730.406 498,-769 496.783,-770.209 495.486,-771.352 494.127,-772.433"/>
<polygon fill="#000000" stroke="#000000" points="492.184,-769.522 485.781,-777.962 496.05,-775.357 492.184,-769.522"/>
</g>
<!-- files -->
<g id="proc~~dhscf~~UsesGraph_node15" class="node"><title>files</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-760 420,-760 420,-736 474,-736 474,-760"/>
<text text-anchor="middle" x="447" y="-745.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">files</text>
</g>
<!-- proc~dhscf&#45;&gt;files -->
<g id="proc~~dhscf~~UsesGraph_edge14" class="edge"><title>proc~dhscf&#45;&gt;files</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M555.612,-636.169C547.408,-657.348 527.831,-701.189 498,-727 493.728,-730.696 488.712,-733.814 483.535,-736.42"/>
<polygon fill="#000000" stroke="#000000" points="481.891,-733.32 474.17,-740.575 484.73,-739.719 481.891,-733.32"/>
</g>
<!-- m_rhofft -->
<g id="proc~~dhscf~~UsesGraph_node16" class="node"><title>m_rhofft</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-718 420,-718 420,-694 474,-694 474,-718"/>
<text text-anchor="middle" x="447" y="-703.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhofft</text>
</g>
<!-- proc~dhscf&#45;&gt;m_rhofft -->
<g id="proc~~dhscf~~UsesGraph_edge15" class="edge"><title>proc~dhscf&#45;&gt;m_rhofft</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M550.135,-636.166C538.739,-649.583 518.864,-671.107 498,-685 493.559,-687.957 488.634,-690.634 483.656,-693.01"/>
<polygon fill="#000000" stroke="#000000" points="481.876,-689.97 474.134,-697.203 484.697,-696.376 481.876,-689.97"/>
</g>
<!-- module~siesta_options -->
<g id="proc~~dhscf~~UsesGraph_node17" class="node"><title>module~siesta_options</title>
<g id="a_proc~~dhscf~~UsesGraph_node17"><a xlink:href=".././module/siesta_options.html" xlink:title="siesta_options">
<polygon fill="#337ab7" stroke="#337ab7" points="487.5,-676 406.5,-676 406.5,-652 487.5,-652 487.5,-676"/>
<text text-anchor="middle" x="447" y="-661.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_options</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~siesta_options -->
<g id="proc~~dhscf~~UsesGraph_edge16" class="edge"><title>proc~dhscf&#45;&gt;module~siesta_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M533.741,-633.378C521.133,-637.881 505.692,-643.396 491.404,-648.499"/>
<polygon fill="#000000" stroke="#000000" points="489.986,-645.288 481.746,-651.948 492.341,-651.88 489.986,-645.288"/>
</g>
<!-- module~m_forhar -->
<g id="proc~~dhscf~~UsesGraph_node18" class="node"><title>module~m_forhar</title>
<g id="a_proc~~dhscf~~UsesGraph_node18"><a xlink:href=".././module/m_forhar.html" xlink:title="m_forhar">
<polygon fill="#337ab7" stroke="#337ab7" points="475,-966 419,-966 419,-942 475,-942 475,-966"/>
<text text-anchor="middle" x="447" y="-951.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_forhar</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_forhar -->
<g id="proc~~dhscf~~UsesGraph_edge17" class="edge"><title>proc~dhscf&#45;&gt;module~m_forhar</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M558.915,-636.137C554.188,-686.709 534.004,-880.267 498,-928 494.301,-932.904 489.409,-936.966 484.132,-940.305"/>
<polygon fill="#000000" stroke="#000000" points="482.139,-937.405 475.03,-945.261 485.486,-943.553 482.139,-937.405"/>
</g>
<!-- m_ts_options -->
<g id="proc~~dhscf~~UsesGraph_node19" class="node"><title>m_ts_options</title>
<polygon fill="#337ab7" stroke="#337ab7" points="485,-596 409,-596 409,-572 485,-572 485,-596"/>
<text text-anchor="middle" x="447" y="-581.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_options</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_options -->
<g id="proc~~dhscf~~UsesGraph_edge18" class="edge"><title>proc~dhscf&#45;&gt;m_ts_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M533.741,-614.622C521.133,-610.119 505.692,-604.604 491.404,-599.501"/>
<polygon fill="#000000" stroke="#000000" points="492.341,-596.12 481.746,-596.052 489.986,-602.712 492.341,-596.12"/>
</g>
<!-- m_ncdf_siesta -->
<g id="proc~~dhscf~~UsesGraph_node20" class="node"><title>m_ncdf_siesta</title>
<polygon fill="#337ab7" stroke="#337ab7" points="488,-554 406,-554 406,-530 488,-530 488,-554"/>
<text text-anchor="middle" x="447" y="-539.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ncdf_siesta</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ncdf_siesta -->
<g id="proc~~dhscf~~UsesGraph_edge19" class="edge"><title>proc~dhscf&#45;&gt;m_ncdf_siesta</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M550.135,-611.834C538.739,-598.417 518.864,-576.893 498,-563 495.727,-561.487 493.328,-560.047 490.86,-558.683"/>
<polygon fill="#000000" stroke="#000000" points="492.23,-555.454 481.724,-554.083 489.082,-561.706 492.23,-555.454"/>
</g>
<!-- module~moremeshsubs -->
<g id="proc~~dhscf~~UsesGraph_node21" class="node"><title>module~moremeshsubs</title>
<g id="a_proc~~dhscf~~UsesGraph_node21"><a xlink:href=".././module/moremeshsubs.html" xlink:title="moreMeshSubs">
<polygon fill="#337ab7" stroke="#337ab7" points="330.5,-616 242.5,-616 242.5,-592 330.5,-592 330.5,-616"/>
<text text-anchor="middle" x="286.5" y="-601.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">moreMeshSubs</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~moremeshsubs -->
<g id="proc~~dhscf~~UsesGraph_edge20" class="edge"><title>proc~dhscf&#45;&gt;module~moremeshsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M533.872,-622.082C489.637,-618.836 399.149,-612.194 341.01,-607.927"/>
<polygon fill="#000000" stroke="#000000" points="341.134,-604.427 330.904,-607.186 340.621,-611.408 341.134,-604.427"/>
</g>
<!-- module~precision -->
<g id="proc~~dhscf~~UsesGraph_node22" class="node"><title>module~precision</title>
<g id="a_proc~~dhscf~~UsesGraph_node22"><a xlink:href=".././module/precision.html" xlink:title="precision">
<polygon fill="#337ab7" stroke="#337ab7" points="63,-565 8,-565 8,-541 63,-541 63,-565"/>
<text text-anchor="middle" x="35.5" y="-550.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">precision</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge28" class="edge"><title>proc~dhscf&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.815,-611.912C558.679,-555.752 550.79,-321.194 498,-277 475.417,-258.094 273.201,-253.397 213,-281 191.259,-290.969 195.691,-306.077 177,-321 163.472,-331.801 156.927,-329.72 143,-340"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M141,-340C126.969,-350.139 118.216,-345.815 107,-359 63.1601,-410.536 45.6382,-491.579 39.4604,-530.572"/>
<polygon fill="#000000" stroke="#000000" points="35.9768,-530.204 37.9771,-540.609 42.9016,-531.228 35.9768,-530.204"/>
</g>
<!-- meshsubs -->
<g id="proc~~dhscf~~UsesGraph_node23" class="node"><title>meshsubs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="477.5,-474 416.5,-474 416.5,-450 477.5,-450 477.5,-474"/>
<text text-anchor="middle" x="447" y="-459.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">meshsubs</text>
</g>
<!-- proc~dhscf&#45;&gt;meshsubs -->
<g id="proc~~dhscf~~UsesGraph_edge22" class="edge"><title>proc~dhscf&#45;&gt;meshsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M557.342,-611.958C551.119,-586.239 533.378,-525.259 498,-488 494.64,-484.461 490.691,-481.315 486.511,-478.541"/>
<polygon fill="#000000" stroke="#000000" points="488.113,-475.423 477.719,-473.368 484.563,-481.456 488.113,-475.423"/>
</g>
<!-- mpi_siesta -->
<g id="proc~~dhscf~~UsesGraph_node24" class="node"><title>mpi_siesta</title>
<polygon fill="#337ab7" stroke="#337ab7" points="174,-392 110,-392 110,-368 174,-368 174,-392"/>
<text text-anchor="middle" x="142" y="-377.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_siesta</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_siesta -->
<g id="proc~~dhscf~~UsesGraph_edge23" class="edge"><title>proc~dhscf&#45;&gt;mpi_siesta</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.06,-611.665C559.486,-577.997 552.816,-484.168 498,-441 424.201,-382.883 381.191,-428.772 287.5,-422"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-422C248.947,-418.9 209.025,-406.28 180.759,-395.675"/>
<polygon fill="#000000" stroke="#000000" points="181.862,-392.35 171.273,-392.027 179.35,-398.883 181.862,-392.35"/>
</g>
<!-- m_spin -->
<g id="proc~~dhscf~~UsesGraph_node25" class="node"><title>m_spin</title>
<polygon fill="#337ab7" stroke="#337ab7" points="313.5,-189 259.5,-189 259.5,-165 313.5,-165 313.5,-189"/>
<text text-anchor="middle" x="286.5" y="-174.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_spin</text>
</g>
<!-- proc~dhscf&#45;&gt;m_spin -->
<g id="proc~~dhscf~~UsesGraph_edge24" class="edge"><title>proc~dhscf&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.157,-611.906C560.711,-548.58 559.859,-255.873 498,-197 451.523,-152.767 370.388,-159.61 323.585,-168.405"/>
<polygon fill="#000000" stroke="#000000" points="322.7,-165.013 313.584,-170.413 324.078,-171.876 322.7,-165.013"/>
</g>
<!-- module~m_iorho -->
<g id="proc~~dhscf~~UsesGraph_node26" class="node"><title>module~m_iorho</title>
<g id="a_proc~~dhscf~~UsesGraph_node26"><a xlink:href=".././module/m_iorho.html" xlink:title="m_iorho">
<polygon fill="#337ab7" stroke="#337ab7" points="313.5,-474 259.5,-474 259.5,-450 313.5,-450 313.5,-474"/>
<text text-anchor="middle" x="286.5" y="-459.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_iorho</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_iorho -->
<g id="proc~~dhscf~~UsesGraph_edge25" class="edge"><title>proc~dhscf&#45;&gt;module~m_iorho</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M555.703,-611.725C547.639,-590.381 528.271,-546.293 498,-521 479.757,-505.757 469.177,-512.801 448,-502"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-502C424.836,-491.206 363.56,-477.422 323.692,-469.175"/>
<polygon fill="#000000" stroke="#000000" points="324.306,-465.729 313.808,-467.153 322.903,-472.587 324.306,-465.729"/>
</g>
<!-- m_ts_hartree -->
<g id="proc~~dhscf~~UsesGraph_node27" class="node"><title>m_ts_hartree</title>
<polygon fill="#337ab7" stroke="#337ab7" points="485,-352 409,-352 409,-328 485,-328 485,-352"/>
<text text-anchor="middle" x="447" y="-337.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_hartree</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_hartree -->
<g id="proc~~dhscf~~UsesGraph_edge26" class="edge"><title>proc~dhscf&#45;&gt;m_ts_hartree</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M558.607,-611.882C553.065,-565.557 531.26,-400.3 498,-361 496.677,-359.437 495.218,-357.988 493.656,-356.645"/>
<polygon fill="#000000" stroke="#000000" points="495.353,-353.564 485.133,-350.774 491.383,-359.329 495.353,-353.564"/>
</g>
<!-- iogrid_netcdf -->
<g id="proc~~dhscf~~UsesGraph_node28" class="node"><title>iogrid_netcdf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="484,-310 410,-310 410,-286 484,-286 484,-310"/>
<text text-anchor="middle" x="447" y="-295.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">iogrid_netcdf</text>
</g>
<!-- proc~dhscf&#45;&gt;iogrid_netcdf -->
<g id="proc~~dhscf~~UsesGraph_edge27" class="edge"><title>proc~dhscf&#45;&gt;iogrid_netcdf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.022,-611.743C554.727,-560.683 536.033,-365.378 498,-319 496.496,-317.166 494.804,-315.49 492.976,-313.958"/>
<polygon fill="#000000" stroke="#000000" points="494.504,-310.77 484.245,-308.125 490.616,-316.591 494.504,-310.77"/>
</g>
<!-- alloc -->
<g id="proc~~dhscf~~UsesGraph_node29" class="node"><title>alloc</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-563 115,-563 115,-539 169,-539 169,-563"/>
<text text-anchor="middle" x="142" y="-548.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge21" class="edge"><title>proc~dhscf&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-502C355.354,-455.769 231.352,-505.769 174.189,-534.163"/>
<polygon fill="#000000" stroke="#000000" points="172.289,-531.202 164.958,-538.851 175.459,-537.443 172.289,-531.202"/>
</g>
<!-- module~m_vmat -->
<g id="proc~~dhscf~~UsesGraph_node30" class="node"><title>module~m_vmat</title>
<g id="a_proc~~dhscf~~UsesGraph_node30"><a xlink:href=".././module/m_vmat.html" xlink:title="m_vmat">
<polygon fill="#337ab7" stroke="#337ab7" points="474,-230 420,-230 420,-206 474,-206 474,-230"/>
<text text-anchor="middle" x="447" y="-215.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_vmat</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_vmat -->
<g id="proc~~dhscf~~UsesGraph_edge29" class="edge"><title>proc~dhscf&#45;&gt;module~m_vmat</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.451,-611.703C556.636,-553.395 542.189,-305.054 498,-244 494.16,-238.695 488.91,-234.386 483.249,-230.916"/>
<polygon fill="#000000" stroke="#000000" points="484.639,-227.692 474.16,-226.13 481.378,-233.886 484.639,-227.692"/>
</g>
<!-- module~atmfuncs -->
<g id="proc~~dhscf~~UsesGraph_node31" class="node"><title>module~atmfuncs</title>
<g id="a_proc~~dhscf~~UsesGraph_node31"><a xlink:href=".././module/atmfuncs.html" xlink:title="atmfuncs">
<polygon fill="#337ab7" stroke="#337ab7" points="475,-394 419,-394 419,-370 475,-370 475,-394"/>
<text text-anchor="middle" x="447" y="-379.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">atmfuncs</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~atmfuncs -->
<g id="proc~~dhscf~~UsesGraph_edge30" class="edge"><title>proc~dhscf&#45;&gt;module~atmfuncs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.747,-611.981C558.398,-576.642 549.984,-471.578 498,-408 494.191,-403.342 489.327,-399.421 484.134,-396.152"/>
<polygon fill="#000000" stroke="#000000" points="485.662,-392.999 475.212,-391.252 482.292,-399.134 485.662,-392.999"/>
</g>
<!-- module~m_rhoofd -->
<g id="proc~~dhscf~~UsesGraph_node32" class="node"><title>module~m_rhoofd</title>
<g id="a_proc~~dhscf~~UsesGraph_node32"><a xlink:href=".././module/m_rhoofd.html" xlink:title="m_rhoofd">
<polygon fill="#337ab7" stroke="#337ab7" points="476,-150 418,-150 418,-126 476,-126 476,-150"/>
<text text-anchor="middle" x="447" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhoofd</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_rhoofd -->
<g id="proc~~dhscf~~UsesGraph_edge31" class="edge"><title>proc~dhscf&#45;&gt;module~m_rhoofd</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.84,-611.824C558.769,-546.663 550.94,-239.323 498,-164 494.576,-159.128 489.954,-155.104 484.898,-151.798"/>
<polygon fill="#000000" stroke="#000000" points="486.549,-148.712 476.112,-146.893 483.137,-154.824 486.549,-148.712"/>
</g>
<!-- fdf -->
<g id="proc~~dhscf~~UsesGraph_node33" class="node"><title>fdf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-108 420,-108 420,-84 474,-84 474,-108"/>
<text text-anchor="middle" x="447" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">fdf</text>
</g>
<!-- proc~dhscf&#45;&gt;fdf -->
<g id="proc~~dhscf~~UsesGraph_edge32" class="edge"><title>proc~dhscf&#45;&gt;fdf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.115,-611.89C560.539,-542.768 559.507,-198.342 498,-117 494.289,-112.093 489.215,-108.322 483.716,-105.428"/>
<polygon fill="#000000" stroke="#000000" points="484.793,-102.082 474.224,-101.339 482.023,-108.51 484.793,-102.082"/>
</g>
<!-- module~m_rhog -->
<g id="proc~~dhscf~~UsesGraph_node34" class="node"><title>module~m_rhog</title>
<g id="a_proc~~dhscf~~UsesGraph_node34"><a xlink:href=".././module/m_rhog.html" xlink:title="m_rhog">
<polygon fill="#337ab7" stroke="#337ab7" points="474,-66 420,-66 420,-42 474,-42 474,-66"/>
<text text-anchor="middle" x="447" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhog</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_rhog -->
<g id="proc~~dhscf~~UsesGraph_edge33" class="edge"><title>proc~dhscf&#45;&gt;module~m_rhog</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.242,-611.853C561.453,-539.328 564.41,-163.674 498,-75 494.276,-70.0274 489.15,-66.2231 483.592,-63.3151"/>
<polygon fill="#000000" stroke="#000000" points="484.573,-59.9283 474.002,-59.2194 481.824,-66.3658 484.573,-59.9283"/>
</g>
<!-- m_hartree_add -->
<g id="proc~~dhscf~~UsesGraph_node35" class="node"><title>m_hartree_add</title>
<polygon fill="#337ab7" stroke="#337ab7" points="490,-24 404,-24 404,-0 490,-0 490,-24"/>
<text text-anchor="middle" x="447" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_hartree_add</text>
</g>
<!-- proc~dhscf&#45;&gt;m_hartree_add -->
<g id="proc~~dhscf~~UsesGraph_edge34" class="edge"><title>proc~dhscf&#45;&gt;m_hartree_add</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.468,-611.972C555.846,-532.21 533.871,-81.295 498,-33 497.435,-32.2394 496.837,-31.5062 496.21,-30.7994"/>
<polygon fill="#000000" stroke="#000000" points="498.388,-28.0563 488.524,-24.1908 493.825,-33.3642 498.388,-28.0563"/>
</g>
<!-- module~units&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge35" class="edge"><title>module~units&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M130.079,-1001.89C122.403,-992.701 112.549,-979.397 107,-966 48.7066,-825.262 38.608,-638.396 36.863,-575.061"/>
<polygon fill="#000000" stroke="#000000" points="40.3613,-574.941 36.6304,-565.025 33.3632,-575.104 40.3613,-574.941"/>
</g>
<!-- module~mesh&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge36" class="edge"><title>module~mesh&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.214,-1078.37C219.905,-1080.31 146.239,-1077.53 107,-1035 44.0245,-966.737 37.2152,-660.807 36.5514,-575.278"/>
<polygon fill="#000000" stroke="#000000" points="40.0506,-575.113 36.4946,-565.132 33.0507,-575.152 40.0506,-575.113"/>
</g>
<!-- module~m_forhar&#45;&gt;module~parallel -->
<g id="proc~~dhscf~~UsesGraph_edge41" class="edge"><title>module~m_forhar&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-952C266.408,-943.856 214.663,-930.061 179.081,-920.991"/>
<polygon fill="#000000" stroke="#000000" points="179.616,-917.516 169.063,-918.453 177.897,-924.301 179.616,-917.516"/>
</g>
<!-- module~m_forhar&#45;&gt;siestaXC -->
<g id="proc~~dhscf~~UsesGraph_edge38" class="edge"><title>module~m_forhar&#45;&gt;siestaXC</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.753,-960.876C392.546,-967.49 352.755,-977.532 323.855,-984.825"/>
<polygon fill="#000000" stroke="#000000" points="322.967,-981.439 314.128,-987.28 324.68,-988.227 322.967,-981.439"/>
</g>
<!-- module~m_forhar&#45;&gt;module~mesh -->
<g id="proc~~dhscf~~UsesGraph_edge42" class="edge"><title>module~m_forhar&#45;&gt;module~mesh</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.907,-962.847C411.138,-966.039 402.907,-970.092 396,-975 376.504,-988.854 377.192,-998.372 360,-1015 344.383,-1030.1 325.583,-1045.86 311.04,-1057.58"/>
<polygon fill="#000000" stroke="#000000" points="308.66,-1055 303.026,-1063.97 313.026,-1060.47 308.66,-1055"/>
</g>
<!-- module~m_forhar&#45;&gt;module~moremeshsubs -->
<g id="proc~~dhscf~~UsesGraph_edge39" class="edge"><title>module~m_forhar&#45;&gt;module~moremeshsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M433.49,-941.861C422.423,-930.568 406.452,-912.841 396,-895 341.28,-801.598 305.656,-675.717 292.831,-625.748"/>
<polygon fill="#000000" stroke="#000000" points="296.216,-624.858 290.377,-616.018 289.428,-626.57 296.216,-624.858"/>
</g>
<!-- module~m_forhar&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge37" class="edge"><title>module~m_forhar&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-952C212.117,-920.695 165.554,-987.189 107,-933 54.0697,-884.016 40.3212,-649.356 37.2736,-575.385"/>
<polygon fill="#000000" stroke="#000000" points="40.7679,-575.168 36.885,-565.311 33.7731,-575.438 40.7679,-575.168"/>
</g>
<!-- module~m_forhar&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge40" class="edge"><title>module~m_forhar&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.925,-959.689C386.307,-965.215 330.531,-970.357 287.5,-952"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-952C211.508,-920.436 160.288,-652.427 146.636,-573.059"/>
<polygon fill="#000000" stroke="#000000" points="150.08,-572.432 144.961,-563.156 143.178,-573.6 150.08,-572.432"/>
</g>
<!-- module~moremeshsubs&#45;&gt;module~parallel -->
<g id="proc~~dhscf~~UsesGraph_edge43" class="edge"><title>module~moremeshsubs&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M279.914,-616.074C258.413,-662.545 180.824,-830.247 153.009,-890.365"/>
<polygon fill="#000000" stroke="#000000" points="149.725,-889.129 148.702,-899.675 156.078,-892.069 149.725,-889.129"/>
</g>
<!-- module~moremeshsubs&#45;&gt;module~sys -->
<g id="proc~~dhscf~~UsesGraph_edge46" class="edge"><title>module~moremeshsubs&#45;&gt;module~sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M279.606,-591.829C265.264,-563.145 226.091,-490.179 177,-443 175.937,-441.978 174.816,-440.982 173.655,-440.013"/>
<polygon fill="#000000" stroke="#000000" points="175.7,-437.172 165.574,-434.053 171.544,-442.806 175.7,-437.172"/>
</g>
<!-- module~moremeshsubs&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge44" class="edge"><title>module~moremeshsubs&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M242.373,-597.334C206.091,-591.472 152.93,-582.286 107,-572 95.8246,-569.497 83.7567,-566.395 72.818,-563.427"/>
<polygon fill="#000000" stroke="#000000" points="73.7184,-560.045 63.1478,-560.761 71.8579,-566.793 73.7184,-560.045"/>
</g>
<!-- module~moremeshsubs&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge45" class="edge"><title>module~moremeshsubs&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M253.165,-591.973C230.99,-583.726 201.561,-572.781 178.699,-564.277"/>
<polygon fill="#000000" stroke="#000000" points="179.618,-560.885 169.025,-560.68 177.178,-567.446 179.618,-560.885"/>
</g>
<!-- module~m_iorho&#45;&gt;module~parallel -->
<g id="proc~~dhscf~~UsesGraph_edge50" class="edge"><title>module~m_iorho&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M276.438,-474.008C261.052,-494.983 229.851,-540.155 213,-583 169.598,-693.35 151.008,-835.633 145.175,-889.765"/>
<polygon fill="#000000" stroke="#000000" points="141.67,-889.627 144.119,-899.935 148.633,-890.35 141.67,-889.627"/>
</g>
<!-- module~m_iorho&#45;&gt;module~sys -->
<g id="proc~~dhscf~~UsesGraph_edge52" class="edge"><title>module~m_iorho&#45;&gt;module~sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.363,-454.663C236.906,-448.36 204.292,-439.205 179.302,-432.19"/>
<polygon fill="#000000" stroke="#000000" points="180.027,-428.758 169.454,-429.426 178.136,-435.498 180.027,-428.758"/>
</g>
<!-- module~m_iorho&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge47" class="edge"><title>module~m_iorho&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.306,-471.333C245.517,-476.262 228.332,-482.428 213,-488 164.328,-505.689 108.225,-526.407 72.5759,-539.612"/>
<polygon fill="#000000" stroke="#000000" points="71.2473,-536.372 63.0867,-543.129 73.6798,-542.936 71.2473,-536.372"/>
</g>
<!-- module~m_iorho&#45;&gt;mpi_siesta -->
<g id="proc~~dhscf~~UsesGraph_edge51" class="edge"><title>module~m_iorho&#45;&gt;mpi_siesta</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.459,-455.595C245.081,-451.356 227.294,-444.919 213,-436 194.067,-424.188 194.597,-414.723 177,-401 175.646,-399.944 174.236,-398.896 172.793,-397.864"/>
<polygon fill="#000000" stroke="#000000" points="174.593,-394.857 164.339,-392.19 170.692,-400.669 174.593,-394.857"/>
</g>
<!-- module~m_iorho&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge49" class="edge"><title>module~m_iorho&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.248,-468.722C244.97,-473.027 227.349,-479.427 213,-488 211.583,-488.847 184.077,-513.715 163.974,-531.948"/>
<polygon fill="#000000" stroke="#000000" points="161.491,-529.475 156.438,-538.787 166.196,-534.659 161.491,-529.475"/>
</g>
<!-- parallelsubs -->
<g id="proc~~dhscf~~UsesGraph_node39" class="node"><title>parallelsubs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="177,-476 107,-476 107,-452 177,-452 177,-476"/>
<text text-anchor="middle" x="142" y="-461.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parallelsubs</text>
</g>
<!-- module~m_iorho&#45;&gt;parallelsubs -->
<g id="proc~~dhscf~~UsesGraph_edge48" class="edge"><title>module~m_iorho&#45;&gt;parallelsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.363,-462.367C239.206,-462.65 210.865,-463.048 187.199,-463.38"/>
<polygon fill="#000000" stroke="#000000" points="186.992,-459.882 177.042,-463.522 187.09,-466.881 186.992,-459.882"/>
</g>
<!-- module~atmfuncs&#45;&gt;module~sys -->
<g id="proc~~dhscf~~UsesGraph_edge57" class="edge"><title>module~atmfuncs&#45;&gt;module~sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-384C248.167,-383.845 207.134,-396.194 178.726,-406.854"/>
<polygon fill="#000000" stroke="#000000" points="177.293,-403.655 169.231,-410.53 179.82,-410.183 177.293,-403.655"/>
</g>
<!-- module~atmfuncs&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge54" class="edge"><title>module~atmfuncs&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.796,-382.62C387.225,-383.276 333.595,-384.191 287.5,-384"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-384C252.19,-383.862 244.826,-374.833 213,-365 181.437,-355.248 169.579,-320.381 143,-340"/>
</g>
<!-- spher_harm -->
<g id="proc~~dhscf~~UsesGraph_node36" class="node"><title>spher_harm</title>
<polygon fill="#337ab7" stroke="#337ab7" points="321.5,-356 251.5,-356 251.5,-332 321.5,-332 321.5,-356"/>
<text text-anchor="middle" x="286.5" y="-341.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">spher_harm</text>
</g>
<!-- module~atmfuncs&#45;&gt;spher_harm -->
<g id="proc~~dhscf~~UsesGraph_edge55" class="edge"><title>module~atmfuncs&#45;&gt;spher_harm</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.753,-375.468C394.789,-369.722 359.466,-361.254 331.499,-354.549"/>
<polygon fill="#000000" stroke="#000000" points="332.104,-351.094 321.563,-352.167 330.471,-357.902 332.104,-351.094"/>
</g>
<!-- module~atm_types -->
<g id="proc~~dhscf~~UsesGraph_node41" class="node"><title>module~atm_types</title>
<g id="a_proc~~dhscf~~UsesGraph_node41"><a xlink:href=".././module/atm_types.html" xlink:title="atm_types">
<polygon fill="#337ab7" stroke="#337ab7" points="317.5,-314 255.5,-314 255.5,-290 317.5,-290 317.5,-314"/>
<text text-anchor="middle" x="286.5" y="-299.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">atm_types</text>
</a>
</g>
</g>
<!-- module~atmfuncs&#45;&gt;module~atm_types -->
<g id="proc~~dhscf~~UsesGraph_edge53" class="edge"><title>module~atmfuncs&#45;&gt;module~atm_types</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.986,-373.041C411.218,-369.846 402.969,-365.82 396,-361 376.865,-347.768 379.868,-335.104 360,-323 350.147,-316.997 338.495,-312.639 327.448,-309.505"/>
<polygon fill="#000000" stroke="#000000" points="328.098,-306.058 317.541,-306.959 326.355,-312.838 328.098,-306.058"/>
</g>
<!-- module~radial -->
<g id="proc~~dhscf~~UsesGraph_node42" class="node"><title>module~radial</title>
<g id="a_proc~~dhscf~~UsesGraph_node42"><a xlink:href=".././module/radial.html" xlink:title="radial">
<polygon fill="#337ab7" stroke="#337ab7" points="169,-312 115,-312 115,-288 169,-288 169,-312"/>
<text text-anchor="middle" x="142" y="-297.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">radial</text>
</a>
</g>
</g>
<!-- module~atmfuncs&#45;&gt;module~radial -->
<g id="proc~~dhscf~~UsesGraph_edge56" class="edge"><title>module~atmfuncs&#45;&gt;module~radial</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.886,-374.837C410.761,-371.651 402.336,-367.179 396,-361 368.085,-333.78 392.742,-302.17 360,-281 304.821,-245.322 224.582,-266.827 178.718,-284.328"/>
<polygon fill="#000000" stroke="#000000" points="177.213,-281.159 169.201,-288.092 179.788,-287.669 177.213,-281.159"/>
</g>
<!-- module~m_rhog&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge58" class="edge"><title>module~m_rhog&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.865,-62.3221C411.793,-65.5705 403.152,-69.7867 396,-75 376.133,-89.4824 380.82,-103.925 360,-117 302.758,-152.948 270.29,-120.129 213,-156 151.835,-194.298 140.425,-215.042 107,-279 61.8326,-365.427 44.3206,-482.597 38.7346,-530.844"/>
<polygon fill="#000000" stroke="#000000" points="35.252,-530.495 37.6388,-540.817 42.2101,-531.259 35.252,-530.495"/>
</g>
<!-- module~m_rhog&#45;&gt;m_spin -->
<g id="proc~~dhscf~~UsesGraph_edge60" class="edge"><title>module~m_rhog&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.753,-60.9552C411.398,-64.1659 402.617,-68.7053 396,-75 369.211,-100.485 387.307,-125.072 360,-150 349.825,-159.289 336.163,-165.469 323.443,-169.54"/>
<polygon fill="#000000" stroke="#000000" points="322.183,-166.26 313.529,-172.372 324.105,-172.991 322.183,-166.26"/>
</g>
<!-- class_Pair_dData1D -->
<g id="proc~~dhscf~~UsesGraph_node37" class="node"><title>class_Pair_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="341,-108 232,-108 232,-84 341,-84 341,-108"/>
<text text-anchor="middle" x="286.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_Pair_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_Pair_dData1D -->
<g id="proc~~dhscf~~UsesGraph_edge59" class="edge"><title>module~m_rhog&#45;&gt;class_Pair_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.827,-60.9354C398.932,-66.4723 368.927,-74.4232 342.769,-81.3545"/>
<polygon fill="#000000" stroke="#000000" points="341.729,-78.0092 332.96,-83.9539 343.522,-84.7757 341.729,-78.0092"/>
</g>
<!-- class_dData1D -->
<g id="proc~~dhscf~~UsesGraph_node38" class="node"><title>class_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="329,-66 244,-66 244,-42 329,-42 329,-66"/>
<text text-anchor="middle" x="286.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_dData1D -->
<g id="proc~~dhscf~~UsesGraph_edge62" class="edge"><title>module~m_rhog&#45;&gt;class_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.827,-54C397.996,-54 366.221,-54 339.28,-54"/>
<polygon fill="#000000" stroke="#000000" points="339.222,-50.5001 329.222,-54 339.222,-57.5001 339.222,-50.5001"/>
</g>
<!-- class_Fstack_Pair_dData1D -->
<g id="proc~~dhscf~~UsesGraph_node40" class="node"><title>class_Fstack_Pair_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="360,-24 213,-24 213,-0 360,-0 360,-24"/>
<text text-anchor="middle" x="286.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_Fstack_Pair_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_Fstack_Pair_dData1D -->
<g id="proc~~dhscf~~UsesGraph_edge61" class="edge"><title>module~m_rhog&#45;&gt;class_Fstack_Pair_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.827,-47.0646C398.932,-41.5277 368.927,-33.5768 342.769,-26.6455"/>
<polygon fill="#000000" stroke="#000000" points="343.522,-23.2243 332.96,-24.0461 341.729,-29.9908 343.522,-23.2243"/>
</g>
<!-- module~atm_types&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge63" class="edge"><title>module~atm_types&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.469,-303.644C224.572,-306.693 176.372,-315.367 143,-340"/>
</g>
<!-- module~atm_types&#45;&gt;module~radial -->
<g id="proc~~dhscf~~UsesGraph_edge64" class="edge"><title>module~atm_types&#45;&gt;module~radial</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.279,-301.576C233.175,-301.266 203.078,-300.843 179.609,-300.514"/>
<polygon fill="#000000" stroke="#000000" points="179.393,-297.011 169.344,-300.37 179.294,-304.01 179.393,-297.011"/>
</g>
<!-- module~radial&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge66" class="edge"><title>module~radial&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M120.773,-312.237C115.696,-316.107 110.659,-320.76 107,-326 61.2523,-391.519 44.3755,-487.801 38.868,-530.819"/>
<polygon fill="#000000" stroke="#000000" points="35.3883,-530.441 37.6767,-540.786 42.3388,-531.272 35.3883,-530.441"/>
</g>
<!-- xml -->
<g id="proc~~dhscf~~UsesGraph_node43" class="node"><title>xml</title>
<polygon fill="#337ab7" stroke="#337ab7" points="62.5,-333 8.5,-333 8.5,-309 62.5,-309 62.5,-333"/>
<text text-anchor="middle" x="35.5" y="-318.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xml</text>
</g>
<!-- module~radial&#45;&gt;xml -->
<g id="proc~~dhscf~~UsesGraph_edge65" class="edge"><title>module~radial&#45;&gt;xml</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M114.9,-305.245C102.182,-307.801 86.6791,-310.916 72.8271,-313.7"/>
<polygon fill="#000000" stroke="#000000" points="71.7441,-310.347 62.6296,-315.749 73.1232,-317.21 71.7441,-310.347"/>
</g>
<!-- interpolation -->
<g id="proc~~dhscf~~UsesGraph_node44" class="node"><title>interpolation</title>
<polygon fill="#337ab7" stroke="#337ab7" points="71,-291 0,-291 0,-267 71,-267 71,-291"/>
<text text-anchor="middle" x="35.5" y="-276.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">interpolation</text>
</g>
<!-- module~radial&#45;&gt;interpolation -->
<g id="proc~~dhscf~~UsesGraph_edge67" class="edge"><title>module~radial&#45;&gt;interpolation</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M114.9,-294.755C104.707,-292.707 92.7249,-290.299 81.2377,-287.99"/>
<polygon fill="#000000" stroke="#000000" points="81.8212,-284.538 71.3276,-285.999 80.442,-291.401 81.8212,-284.538"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="490pt" height="32pt"
 viewBox="0.00 0.00 489.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 485.5,-28 485.5,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node"><title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24 0,-24 0,-0 54,-0 54,-24"/>
<text text-anchor="middle" x="27" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node"><title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="139.5,-24 72.5,-24 72.5,-0 139.5,-0 139.5,-24"/>
<text text-anchor="middle" x="106" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="222,-24 158,-24 158,-0 222,-0 222,-24"/>
<text text-anchor="middle" x="190" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="294,-24 240,-24 240,-0 294,-0 294,-24"/>
<text text-anchor="middle" x="267" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="366,-24 312,-24 312,-0 366,-0 366,-24"/>
<text text-anchor="middle" x="339" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="481.5,-24 384.5,-24 384.5,-0 481.5,-0 481.5,-24"/>
<text text-anchor="middle" x="433" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a submodule to the (sub)module which it is
    descended from. Dashed arrows point from a module or program unit to 
    modules which it uses.
    </p>
    </div></div></div></div>
      </li>
      
      </ul>
    </div>
    


    
    <p>Calculates the self-consistent field contributions to Hamiltonian
 matrix elements, total energy and atomic forces.</p>
<p>Coded by J.M. Soler, August 1996. July 1997.<br>
 Modified by J.D. Gale, February 2000.</p>
<h3>Units</h3>
<p>Energies in Rydbergs.<br>
 Distances in Bohr.</p>
<h3>Routines called internally</h3>
<ul>
<li><a>cellxc</a>    : Finds total exch-corr energy and potential</li>
<li><a href="../proc/cross.html">CROSS</a>   : Finds the cross product of two vectors</li>
<li><a href="../proc/dfscf.html">dfscf</a>     : Finds SCF contribution to atomic forces</li>
<li><a>dipole</a>    : Finds electric dipole moment</li>
<li><a>doping</a>    : Adds a background charge for doped systems</li>
<li><a href="../proc/write_rho.html">write_rho</a>     : Saves electron density on a file</li>
<li><a href="../proc/poison.html">poison</a>    : Solves Poisson equation</li>
<li><a href="../proc/reord.html">reord</a>     : Reorders electron density and potential arrays</li>
<li><a href="../proc/rhooda.html">rhooda</a>    : Finds Harris electron density in the mesh</li>
<li><a href="../proc/rhoofd.html">rhoofd</a>    : Finds SCF electron density in the mesh</li>
<li><a>rhoofdsp</a>  : Finds SCF electron density in the mesh for
                    spiral arrangement of spins</li>
<li><a>timer</a>     : Finds CPU times</li>
<li><a href="../proc/vmat.html">vmat</a>      : Finds matrix elements of SCF potential</li>
<li><a>vmatsp</a>    : Finds matrix elements of SCF potential for
                         spiral arrangement of spins</li>
<li><a href="../proc/delk.html">delk</a> : Finds matrix elements of <script type="math/tex"> exp(i \vec{k} \cdot \vec{r}) </script>
</li>
<li>real*8 volcel( cell ) : Returns volume of unit cell</li>
</ul>
<h3>Internal variables and arrays</h3>
<ul>
<li><code>real*8  bcell(3,3)</code>    : Bulk lattice vectors</li>
<li><code>real*8  cell(3,3)</code>     : Auxiliary lattice vectors (same as ucell)</li>
<li><code>real*8  const</code>         : Auxiliary variable (constant within a loop)</li>
<li><code>real*8  DEc</code>           : Auxiliary variable to call cellxc</li>
<li><code>real*8  DEx</code>           : Auxiliary variable to call cellxc</li>
<li><code>real*8  dvol</code>          : Mesh-cell volume</li>
<li><code>real*8  Ec</code>            : Correlation energy</li>
<li><code>real*8  Ex</code>            : Exchange energy</li>
<li><code>real*8  field(3)</code>      : External electric field</li>
<li><code>integer i</code>             : General-purpose index</li>
<li><code>integer ia</code>            : Atom index</li>
<li><code>integer io</code>            : Orbital index</li>
<li><code>integer ip</code>            : Point index</li>
<li><code>integer is</code>            : Species index</li>
<li><code>logical IsDiag</code>        : Is supercell diagonal?</li>
<li><code>integer ispin</code>         : Spin index</li>
<li><code>integer j</code>             : General-purpose index</li>
<li><code>integer JDGdistr</code>      : J.D.Gale's parallel distribution of mesh points</li>
<li><code>integer myBox(2,3)</code>    : My processor's mesh box</li>
<li><code>integer nbcell</code>        : Number of independent bulk lattice vectors</li>
<li><code>integer npcc</code>          : Partial core corrections? (0=no, 1=yes)</li>
<li><code>integer nsd</code>           : Number of diagonal spin values (1 or 2)</li>
<li><code>integer ntpl</code>          : Number of mesh Total Points in unit cell
                           (including subpoints) locally</li>
<li><code>real*4  rhoatm(ntpl)</code>  : Harris electron density</li>
<li><code>real*4  rhopcc(ntpl)</code>  : Partial-core-correction density for xc</li>
<li><code>real*4  DRho(ntpl)</code>    : Selfconsistent electron density difference</li>
<li><code>real*8  rhotot</code>        : Total density at one point</li>
<li><code>real*8  rmax</code>          : Maximum orbital radius</li>
<li><code>real*8  scell(3,3)</code>    : Supercell vectors</li>
<li><code>character shape*10</code>    : Name of system shape</li>
<li><code>real*4  Vaux(ntpl)</code>    : Auxiliary potential array</li>
<li><code>real*4  Vna(ntpl)</code>     : Sum of neutral-atom potentials</li>
<li><code>real*8  volume</code>        : Unit cell volume</li>
<li><code>real*4  Vscf(ntpl)</code>    : Hartree potential of selfconsistent density</li>
<li><code>real*8  x0(3)</code>         : Center of molecule</li>
<li><code>logical harrisfun</code>     : Harris functional or Kohn-Sham?</li>
</ul>
<p>Use the functionality in the first block
 of the routine to get charge files and partial charges</p>
    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nspin%7E9"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nspin</strong></td><td><p>Number of different spin polarisations:<br>
 nspin=1 =&gt; Unpolarized, nspin=2 =&gt; polarized<br>
 nspin=4 =&gt; Noncollinear spin or spin-orbit.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-norb%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>norb</strong></td><td><p>Total number of basis orbitals in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iaorb%7E6"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iaorb</strong>(norb)</td><td><p>Atom to which each orbital belongs</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iphorb%7E6"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iphorb</strong>(norb)</td><td><p>Orbital index (within atom) of each orbital</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nuo%7E5"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nuo</strong></td><td><p>Number of orbitals in a unit cell in this node</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nuotot%7E5"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nuotot</strong></td><td><p>Number of orbitals in a unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nua%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nua</strong></td><td><p>Number of atoms in unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-na%7E4"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>na</strong></td><td><p>Number of atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-isa%7E6"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>isa</strong>(na)</td><td><p>Species index of all atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-xa%7E2"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>xa</strong>(3,na)</td><td><p>Atomic positions of all atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-indxua%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>indxua</strong>(na)</td><td><p>Index of equivalent atom in unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ntm%7E2"></span>integer,</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>ntm</strong>(3)</td><td><p>Number of mesh divisions of each cell
 vector, including subgrid.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ifa%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>ifa</strong></td><td><p>Switch which fixes whether the SCF contrib:<br>
 to atomic forces is calculated and added to fa.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-istr%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>istr</strong></td><td><p>Switch which fixes whether the SCF contrib:<br>
 to stress is calculated and added to stress.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ihmat"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iHmat</strong></td><td><p>Switch which fixes whether the Hmat matrix
 elements are calculated or not.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-filesout"></span>type(filesOut_t),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>filesOut</strong></td><td><p>Output file names (If blank =&gt; not saved)</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-maxnd%7E4"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>maxnd</strong></td><td><p>First dimension of listd and Dscf</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-numd%7E4"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>numd</strong>(nuo)</td><td><p>Number of nonzero density-matrix
 elements for each matrix row</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-listdptr%7E4"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>listdptr</strong>(nuo)</td><td><p>Pointer to start of rows of density-matrix</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-listd%7E4"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>listd</strong>(*)</td><td><p><code>listd(maxnd)</code>: Nonzero-density-matrix-element column
 indexes for each matrix row</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dscf%7E3"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Dscf</strong>(:,:)</td><td><p><code>Dscf(maxnd,h_spin_dim)</code>:<br>
 SCF density-matrix elements</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-datm%7E2"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>datm</strong>(norb)</td><td><p>Harris density-matrix diagonal elements<br>
 (atomic occupation charges of orbitals)</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-maxnh"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>maxnh</strong></td><td><p>First dimension of listh and Hmat</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-hmat"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Hmat</strong>(:,:)</td><td><p><code>Hmat(maxnh,h_spin_dim)</code>:<br>
 Hamiltonian matrix in sparse form,<br>
 to which are added the matrix elements<br>
<code>&lt;ORB_I | DeltaV | ORB_J&gt;</code>, where<br>
<code>DeltaV = Vna + Vxc(SCF) + Vhartree(RhoSCF-RhoHarris)</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-enaatm"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Enaatm</strong></td><td><p>Integral of <code>Vna * rhoatm</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-enascf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Enascf</strong></td><td><p>Integral of <code>Vna * rhoscf</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-uatm"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Uatm</strong></td><td><p>Harris hartree electron-interaction energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-uscf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Uscf</strong></td><td><p>SCF hartree electron-interaction energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-duscf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DUscf</strong></td><td><p>Electrostatic (Hartree) energy of
 <code>(rhoscf - rhoatm)</code> density</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-duext"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DUext</strong></td><td><p>Interaction energy with external electric field</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-exc"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Exc</strong></td><td><p>SCF exchange-correlation energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dxc"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Dxc</strong></td><td><p>SCF double-counting correction to Exc<br>
<code>Dxc = integral of ( (epsxc - Vxc) * Rho )</code><br>
 All energies in Rydbergs</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dipol"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>dipol</strong>(3)</td><td><p>Electric dipole (in a.u.)
 only when the system is a molecule</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-stress"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>stress</strong>(3,3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-fal%7E3"></span>real(kind=dp),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Fal</strong>(3,nua)</td><td><p>Atomic forces, to which the SCF contribution
 is added by this routine when <code>ifa=1</code>.
 The SCF contribution is minus the derivative
 of <code>(Enascf - Enaatm + DUscf + Exc)</code> with
 respect to atomic positions, in Ry/Bohr.
 Contributions local to this node.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-stressl%7E2"></span>real(kind=dp),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>stressl</strong>(3,3)</td><td><p>Stress tensor, to which the SCF contribution
 is added by this routine when <code>ifa=1</code>.
 The SCF contribution is minus the derivative of
 <code>(Enascf - Enaatm + DUscf + Exc) / volume</code>
 with respect to the strain tensor, in Ry.
 Contributions local to this node.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-use_rhog_in"></span>logical,</td>
  <td>intent(in),</td>
  <td>optional</td>
  
  <td></td><td>::</td>
  <td><strong>use_rhog_in</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-charge_density_only"></span>logical,</td>
  <td>intent(in),</td>
  <td>optional</td>
  
  <td></td><td>::</td>
  <td><strong>charge_density_only</strong></td><td></td>
  
</tr>

</tbody>
</table>

    
    
    
    <br>
    
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Calls</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~CallsGraph Pages: 1 -->
<svg id="procdhscfCallsGraph" width="641pt" height="1559pt"
 viewBox="0.00 0.00 641.00 1559.18" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~CallsGraph" class="graph" transform="scale(0.748832 0.748832) rotate(0) translate(4 2078.16)">
<title>proc~~dhscf~~CallsGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-2078.16 852,-2078.16 852,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~CallsGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="54,-1346.16 0,-1346.16 0,-1322.16 54,-1322.16 54,-1346.16"/>
<text text-anchor="middle" x="27" y="-1331.76" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- volcel -->
<g id="proc~~dhscf~~CallsGraph_node2" class="node"><title>volcel</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-2074.16 129.5,-2074.16 129.5,-2050.16 183.5,-2050.16 183.5,-2074.16"/>
<text text-anchor="middle" x="156.5" y="-2059.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">volcel</text>
</g>
<!-- proc~dhscf&#45;&gt;volcel -->
<g id="proc~~dhscf~~CallsGraph_edge1" class="edge"><title>proc~dhscf&#45;&gt;volcel</title>
<path fill="none" stroke="#000000" d="M28.316,-1346.39C30.7072,-1435.15 47.0442,-1978.52 90,-2036.16 97.1818,-2045.79 108.495,-2051.86 119.713,-2055.68"/>
<polygon fill="#000000" stroke="#000000" points="118.861,-2059.08 129.44,-2058.49 120.805,-2052.35 118.861,-2059.08"/>
</g>
<!-- proc~forhar -->
<g id="proc~~dhscf~~CallsGraph_node3" class="node"><title>proc~forhar</title>
<g id="a_proc~~dhscf~~CallsGraph_node3"><a xlink:href=".././proc/forhar.html" xlink:title="forhar">
<polygon fill="#d9534f" stroke="#d9534f" points="183.5,-1590.16 129.5,-1590.16 129.5,-1566.16 183.5,-1566.16 183.5,-1590.16"/>
<text text-anchor="middle" x="156.5" y="-1575.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">forhar</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~forhar -->
<g id="proc~~dhscf~~CallsGraph_edge2" class="edge"><title>proc~dhscf&#45;&gt;proc~forhar</title>
<path fill="none" stroke="#000000" d="M27.9128,-1346.29C28.3077,-1382.41 34.3244,-1490.57 90,-1552.16 97.7891,-1560.77 108.809,-1566.57 119.593,-1570.46"/>
<polygon fill="#000000" stroke="#000000" points="118.74,-1573.86 129.33,-1573.52 120.839,-1567.19 118.74,-1573.86"/>
</g>
<!-- re_alloc -->
<g id="proc~~dhscf~~CallsGraph_node4" class="node"><title>re_alloc</title>
<polygon fill="#777777" stroke="#777777" points="727.5,-1546.16 673.5,-1546.16 673.5,-1522.16 727.5,-1522.16 727.5,-1546.16"/>
<text text-anchor="middle" x="700.5" y="-1531.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">re_alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge3" class="edge"><title>proc~dhscf&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M28.281,-1346.33C30.3324,-1430.16 44.2344,-1919.85 90,-1965.16 158.491,-2032.95 209.629,-1984.16 306,-1984.16 306,-1984.16 306,-1984.16 442,-1984.16 585.483,-1984.16 553.588,-1842.28 622,-1716.16 626.082,-1708.63 670.832,-1602.39 690.414,-1555.8"/>
<polygon fill="#000000" stroke="#000000" points="693.75,-1556.89 694.396,-1546.32 687.296,-1554.18 693.75,-1556.89"/>
</g>
<!-- ts_voltage -->
<g id="proc~~dhscf~~CallsGraph_node5" class="node"><title>ts_voltage</title>
<polygon fill="#777777" stroke="#777777" points="187,-1956.16 126,-1956.16 126,-1932.16 187,-1932.16 187,-1956.16"/>
<text text-anchor="middle" x="156.5" y="-1941.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ts_voltage</text>
</g>
<!-- proc~dhscf&#45;&gt;ts_voltage -->
<g id="proc~~dhscf~~CallsGraph_edge4" class="edge"><title>proc~dhscf&#45;&gt;ts_voltage</title>
<path fill="none" stroke="#000000" d="M28.5418,-1346.31C32.1873,-1425.88 54.0883,-1870.85 90,-1918.16 96.5032,-1926.72 106.263,-1932.47 116.277,-1936.33"/>
<polygon fill="#000000" stroke="#000000" points="115.265,-1939.68 125.858,-1939.47 117.45,-1933.03 115.265,-1939.68"/>
</g>
<!-- mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_node6" class="node"><title>mpi_barrier</title>
<polygon fill="#777777" stroke="#777777" points="608,-1388.16 541,-1388.16 541,-1364.16 608,-1364.16 608,-1388.16"/>
<text text-anchor="middle" x="574.5" y="-1373.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_barrier</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_edge5" class="edge"><title>proc~dhscf&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M30.9696,-1346.42C37.2962,-1369.51 54.5165,-1418.9 90,-1439.16 164.971,-1481.95 427.383,-1416.57 530.975,-1388.21"/>
<polygon fill="#000000" stroke="#000000" points="532.073,-1391.54 540.783,-1385.51 530.212,-1384.79 532.073,-1391.54"/>
</g>
<!-- ts_hartree_fix -->
<g id="proc~~dhscf~~CallsGraph_node7" class="node"><title>ts_hartree_fix</title>
<polygon fill="#777777" stroke="#777777" points="195.5,-1876.16 117.5,-1876.16 117.5,-1852.16 195.5,-1852.16 195.5,-1876.16"/>
<text text-anchor="middle" x="156.5" y="-1861.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ts_hartree_fix</text>
</g>
<!-- proc~dhscf&#45;&gt;ts_hartree_fix -->
<g id="proc~~dhscf~~CallsGraph_edge6" class="edge"><title>proc~dhscf&#45;&gt;ts_hartree_fix</title>
<path fill="none" stroke="#000000" d="M27.77,-1346.4C26.7035,-1416.27 24.7658,-1764.26 90,-1843.16 94.7083,-1848.85 100.967,-1853.02 107.752,-1856.07"/>
<polygon fill="#000000" stroke="#000000" points="106.64,-1859.39 117.233,-1859.57 109.063,-1852.82 106.64,-1859.39"/>
</g>
<!-- elecs -->
<g id="proc~~dhscf~~CallsGraph_node8" class="node"><title>elecs</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-1834.16 129.5,-1834.16 129.5,-1810.16 183.5,-1810.16 183.5,-1834.16"/>
<text text-anchor="middle" x="156.5" y="-1819.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">elecs</text>
</g>
<!-- proc~dhscf&#45;&gt;elecs -->
<g id="proc~~dhscf~~CallsGraph_edge7" class="edge"><title>proc~dhscf&#45;&gt;elecs</title>
<path fill="none" stroke="#000000" d="M27.9192,-1346.25C27.7193,-1412.31 29.9389,-1729.31 90,-1801.16 97.3884,-1809.99 108.51,-1815.15 119.501,-1818.15"/>
<polygon fill="#000000" stroke="#000000" points="118.929,-1821.61 129.448,-1820.34 120.434,-1814.77 118.929,-1821.61"/>
</g>
<!-- ddot -->
<g id="proc~~dhscf~~CallsGraph_node9" class="node"><title>ddot</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-1792.16 129.5,-1792.16 129.5,-1768.16 183.5,-1768.16 183.5,-1792.16"/>
<text text-anchor="middle" x="156.5" y="-1777.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddot</text>
</g>
<!-- proc~dhscf&#45;&gt;ddot -->
<g id="proc~~dhscf~~CallsGraph_edge8" class="edge"><title>proc~dhscf&#45;&gt;ddot</title>
<path fill="none" stroke="#000000" d="M28.199,-1346.17C29.4476,-1407.83 37.9525,-1688.43 90,-1754.16 97.4016,-1763.5 108.66,-1769.5 119.766,-1773.35"/>
<polygon fill="#000000" stroke="#000000" points="118.803,-1776.71 129.386,-1776.2 120.795,-1770 118.803,-1776.71"/>
</g>
<!-- jms_setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_node10" class="node"><title>jms_setmeshdistr</title>
<polygon fill="#777777" stroke="#777777" points="355,-1855.16 259,-1855.16 259,-1831.16 355,-1831.16 355,-1855.16"/>
<text text-anchor="middle" x="307" y="-1840.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">jms_setmeshdistr</text>
</g>
<!-- proc~dhscf&#45;&gt;jms_setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge9" class="edge"><title>proc~dhscf&#45;&gt;jms_setmeshdistr</title>
<path fill="none" stroke="#000000" d="M28.4168,-1346.29C31.2012,-1423.83 48.2818,-1847.87 90,-1885.16 143.562,-1933.03 234.982,-1887.91 279.742,-1860.58"/>
<polygon fill="#000000" stroke="#000000" points="281.683,-1863.5 288.302,-1855.22 277.968,-1857.56 281.683,-1863.5"/>
</g>
<!-- mpitrace_restart -->
<g id="proc~~dhscf~~CallsGraph_node11" class="node"><title>mpitrace_restart</title>
<polygon fill="#777777" stroke="#777777" points="202,-1712.16 111,-1712.16 111,-1688.16 202,-1688.16 202,-1712.16"/>
<text text-anchor="middle" x="156.5" y="-1697.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpitrace_restart</text>
</g>
<!-- proc~dhscf&#45;&gt;mpitrace_restart -->
<g id="proc~~dhscf~~CallsGraph_edge10" class="edge"><title>proc~dhscf&#45;&gt;mpitrace_restart</title>
<path fill="none" stroke="#000000" d="M28.6671,-1346.33C31.8807,-1400.85 47.3978,-1622.18 90,-1674.16 93.3557,-1678.25 97.4481,-1681.7 101.932,-1684.61"/>
<polygon fill="#000000" stroke="#000000" points="100.499,-1687.82 110.948,-1689.57 103.872,-1681.69 100.499,-1687.82"/>
</g>
<!-- bsc_cellxc -->
<g id="proc~~dhscf~~CallsGraph_node12" class="node"><title>bsc_cellxc</title>
<polygon fill="#777777" stroke="#777777" points="337.5,-1752.16 276.5,-1752.16 276.5,-1728.16 337.5,-1728.16 337.5,-1752.16"/>
<text text-anchor="middle" x="307" y="-1737.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">bsc_cellxc</text>
</g>
<!-- proc~dhscf&#45;&gt;bsc_cellxc -->
<g id="proc~~dhscf~~CallsGraph_edge11" class="edge"><title>proc~dhscf&#45;&gt;bsc_cellxc</title>
<path fill="none" stroke="#000000" d="M28.0336,-1346.3C28.4691,-1406.1 33.6075,-1668.64 90,-1721.16 137.224,-1765.14 218.056,-1758.74 266.312,-1749.71"/>
<polygon fill="#000000" stroke="#000000" points="267.261,-1753.09 276.382,-1747.69 265.89,-1746.22 267.261,-1753.09"/>
</g>
<!-- write_grid_netcdf -->
<g id="proc~~dhscf~~CallsGraph_node13" class="node"><title>write_grid_netcdf</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-1632.16 109.5,-1632.16 109.5,-1608.16 203.5,-1608.16 203.5,-1632.16"/>
<text text-anchor="middle" x="156.5" y="-1617.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_grid_netcdf</text>
</g>
<!-- proc~dhscf&#45;&gt;write_grid_netcdf -->
<g id="proc~~dhscf~~CallsGraph_edge12" class="edge"><title>proc~dhscf&#45;&gt;write_grid_netcdf</title>
<path fill="none" stroke="#000000" d="M29.2772,-1346.46C34.3921,-1393.47 54.836,-1561.04 90,-1599.16 92.9607,-1602.36 96.4118,-1605.09 100.153,-1607.39"/>
<polygon fill="#000000" stroke="#000000" points="98.8142,-1610.64 109.314,-1612.06 101.991,-1604.4 98.8142,-1610.64"/>
</g>
<!-- proc~bye -->
<g id="proc~~dhscf~~CallsGraph_node14" class="node"><title>proc~bye</title>
<g id="a_proc~~dhscf~~CallsGraph_node14"><a xlink:href=".././proc/bye.html" xlink:title="bye">
<polygon fill="#d9534f" stroke="#d9534f" points="727.5,-1708.16 673.5,-1708.16 673.5,-1684.16 727.5,-1684.16 727.5,-1708.16"/>
<text text-anchor="middle" x="700.5" y="-1693.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">bye</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~bye -->
<g id="proc~~dhscf~~CallsGraph_edge13" class="edge"><title>proc~dhscf&#45;&gt;proc~bye</title>
<path fill="none" stroke="#000000" d="M28.2394,-1346.35C30.046,-1432.54 42.7841,-1947.68 90,-1996.16 157.463,-2065.42 209.307,-2022.16 306,-2022.16 306,-2022.16 306,-2022.16 442,-2022.16 597.04,-2022.16 673.269,-1792.29 693.723,-1718.6"/>
<polygon fill="#000000" stroke="#000000" points="697.212,-1719.1 696.435,-1708.54 690.453,-1717.28 697.212,-1719.1"/>
</g>
<!-- proc~setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_node15" class="node"><title>proc~setmeshdistr</title>
<g id="a_proc~~dhscf~~CallsGraph_node15"><a xlink:href=".././proc/setmeshdistr.html" xlink:title="setMeshDistr">
<polygon fill="#d9534f" stroke="#d9534f" points="344.5,-1710.16 269.5,-1710.16 269.5,-1686.16 344.5,-1686.16 344.5,-1710.16"/>
<text text-anchor="middle" x="307" y="-1695.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">setMeshDistr</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge14" class="edge"><title>proc~dhscf&#45;&gt;proc~setmeshdistr</title>
<path fill="none" stroke="#000000" d="M28.7753,-1346.29C32.3036,-1397.73 48.5002,-1597.14 90,-1641.16 95.9072,-1647.42 197.59,-1672.43 259.308,-1687.16"/>
<polygon fill="#000000" stroke="#000000" points="258.682,-1690.61 269.22,-1689.52 260.302,-1683.8 258.682,-1690.61"/>
</g>
<!-- rhoofdsp -->
<g id="proc~~dhscf~~CallsGraph_node16" class="node"><title>rhoofdsp</title>
<polygon fill="#777777" stroke="#777777" points="184,-1510.16 129,-1510.16 129,-1486.16 184,-1486.16 184,-1510.16"/>
<text text-anchor="middle" x="156.5" y="-1495.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">rhoofdsp</text>
</g>
<!-- proc~dhscf&#45;&gt;rhoofdsp -->
<g id="proc~~dhscf~~CallsGraph_edge15" class="edge"><title>proc~dhscf&#45;&gt;rhoofdsp</title>
<path fill="none" stroke="#000000" d="M30.2349,-1346.26C35.7163,-1372.68 52.2301,-1436.03 90,-1472.16 98.1068,-1479.91 108.81,-1485.45 119.209,-1489.36"/>
<polygon fill="#000000" stroke="#000000" points="118.397,-1492.78 128.991,-1492.63 120.617,-1486.14 118.397,-1492.78"/>
</g>
<!-- proc~die -->
<g id="proc~~dhscf~~CallsGraph_node17" class="node"><title>proc~die</title>
<g id="a_proc~~dhscf~~CallsGraph_node17"><a xlink:href=".././proc/die.html" xlink:title="die">
<polygon fill="#d9534f" stroke="#d9534f" points="727.5,-1217.16 673.5,-1217.16 673.5,-1193.16 727.5,-1193.16 727.5,-1217.16"/>
<text text-anchor="middle" x="700.5" y="-1202.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">die</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge16" class="edge"><title>proc~dhscf&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M32.1157,-1321.99C39.7877,-1301.51 58.4229,-1260.75 90,-1244.16 142.328,-1216.66 166.673,-1226.23 223,-1244.16 310.191,-1271.91 303.809,-1335.4 391,-1363.16 433.351,-1376.64 448.871,-1377.31 491,-1363.16 573.449,-1335.44 649.227,-1260.77 682.171,-1224.91"/>
<polygon fill="#000000" stroke="#000000" points="684.783,-1227.24 688.895,-1217.47 679.591,-1222.54 684.783,-1227.24"/>
</g>
<!-- get_field_from_dipole -->
<g id="proc~~dhscf~~CallsGraph_node18" class="node"><title>get_field_from_dipole</title>
<polygon fill="#777777" stroke="#777777" points="214,-1430.16 99,-1430.16 99,-1406.16 214,-1406.16 214,-1430.16"/>
<text text-anchor="middle" x="156.5" y="-1415.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">get_field_from_dipole</text>
</g>
<!-- proc~dhscf&#45;&gt;get_field_from_dipole -->
<g id="proc~~dhscf~~CallsGraph_edge17" class="edge"><title>proc~dhscf&#45;&gt;get_field_from_dipole</title>
<path fill="none" stroke="#000000" d="M37.1592,-1346.58C48.2054,-1360.73 68.0459,-1383.64 90,-1397.16 92.9363,-1398.96 96.0436,-1400.63 99.2458,-1402.17"/>
<polygon fill="#000000" stroke="#000000" points="97.8912,-1405.39 108.459,-1406.15 100.67,-1398.97 97.8912,-1405.39"/>
</g>
<!-- vmatsp -->
<g id="proc~~dhscf~~CallsGraph_node19" class="node"><title>vmatsp</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-1388.16 129.5,-1388.16 129.5,-1364.16 183.5,-1364.16 183.5,-1388.16"/>
<text text-anchor="middle" x="156.5" y="-1373.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vmatsp</text>
</g>
<!-- proc~dhscf&#45;&gt;vmatsp -->
<g id="proc~~dhscf~~CallsGraph_edge18" class="edge"><title>proc~dhscf&#45;&gt;vmatsp</title>
<path fill="none" stroke="#000000" d="M54.2142,-1343.14C65.249,-1346.89 78.2353,-1351.28 90,-1355.16 99.5959,-1358.32 110.004,-1361.68 119.638,-1364.77"/>
<polygon fill="#000000" stroke="#000000" points="118.742,-1368.16 129.332,-1367.87 120.873,-1361.49 118.742,-1368.16"/>
</g>
<!-- add_potential_from_field -->
<g id="proc~~dhscf~~CallsGraph_node20" class="node"><title>add_potential_from_field</title>
<polygon fill="#777777" stroke="#777777" points="221.5,-1346.16 91.5,-1346.16 91.5,-1322.16 221.5,-1322.16 221.5,-1346.16"/>
<text text-anchor="middle" x="156.5" y="-1331.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">add_potential_from_field</text>
</g>
<!-- proc~dhscf&#45;&gt;add_potential_from_field -->
<g id="proc~~dhscf~~CallsGraph_edge19" class="edge"><title>proc~dhscf&#45;&gt;add_potential_from_field</title>
<path fill="none" stroke="#000000" d="M54.1092,-1334.16C62.1659,-1334.16 71.4723,-1334.16 81.1127,-1334.16"/>
<polygon fill="#000000" stroke="#000000" points="81.2415,-1337.66 91.2415,-1334.16 81.2415,-1330.66 81.2415,-1337.66"/>
</g>
<!-- hartree_add -->
<g id="proc~~dhscf~~CallsGraph_node21" class="node"><title>hartree_add</title>
<polygon fill="#777777" stroke="#777777" points="192,-1304.16 121,-1304.16 121,-1280.16 192,-1280.16 192,-1304.16"/>
<text text-anchor="middle" x="156.5" y="-1289.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">hartree_add</text>
</g>
<!-- proc~dhscf&#45;&gt;hartree_add -->
<g id="proc~~dhscf~~CallsGraph_edge20" class="edge"><title>proc~dhscf&#45;&gt;hartree_add</title>
<path fill="none" stroke="#000000" d="M54.2142,-1325.17C65.249,-1321.42 78.2353,-1317.03 90,-1313.16 96.8615,-1310.89 104.138,-1308.53 111.25,-1306.23"/>
<polygon fill="#000000" stroke="#000000" points="112.344,-1309.56 120.793,-1303.17 110.201,-1302.9 112.344,-1309.56"/>
</g>
<!-- proc~dfscf -->
<g id="proc~~dhscf~~CallsGraph_node22" class="node"><title>proc~dfscf</title>
<g id="a_proc~~dhscf~~CallsGraph_node22"><a xlink:href=".././proc/dfscf.html" xlink:title="dfscf">
<polygon fill="#d9534f" stroke="#d9534f" points="334,-1030.16 280,-1030.16 280,-1006.16 334,-1006.16 334,-1030.16"/>
<text text-anchor="middle" x="307" y="-1015.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dfscf</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~dfscf -->
<g id="proc~~dhscf~~CallsGraph_edge21" class="edge"><title>proc~dhscf&#45;&gt;proc~dfscf</title>
<path fill="none" stroke="#000000" d="M28.197,-1322.14C29.3875,-1266.3 37.4828,-1033.08 90,-989.156 142.974,-944.853 230.207,-978.463 275.921,-1001.41"/>
<polygon fill="#000000" stroke="#000000" points="274.527,-1004.63 285.018,-1006.11 277.742,-998.41 274.527,-1004.63"/>
</g>
<!-- proc~reord -->
<g id="proc~~dhscf~~CallsGraph_node23" class="node"><title>proc~reord</title>
<g id="a_proc~~dhscf~~CallsGraph_node23"><a xlink:href=".././proc/reord.html" xlink:title="reord">
<polygon fill="#d9534f" stroke="#d9534f" points="601.5,-1468.16 547.5,-1468.16 547.5,-1444.16 601.5,-1444.16 601.5,-1468.16"/>
<text text-anchor="middle" x="574.5" y="-1453.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">reord</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~reord -->
<g id="proc~~dhscf~~CallsGraph_edge22" class="edge"><title>proc~dhscf&#45;&gt;proc~reord</title>
<path fill="none" stroke="#000000" d="M28.8915,-1322.15C32.6831,-1274.73 49.1845,-1101.52 90,-1069.16 136.315,-1032.43 172.353,-1038.68 223,-1069.16 359.621,-1151.37 271.636,-1280.43 391,-1386.16 433.181,-1423.52 497.422,-1441.86 537.36,-1450.14"/>
<polygon fill="#000000" stroke="#000000" points="536.719,-1453.58 547.207,-1452.08 538.072,-1446.71 536.719,-1453.58"/>
</g>
<!-- compute_partial_charges -->
<g id="proc~~dhscf~~CallsGraph_node24" class="node"><title>compute_partial_charges</title>
<polygon fill="#777777" stroke="#777777" points="223,-1186.16 90,-1186.16 90,-1162.16 223,-1162.16 223,-1186.16"/>
<text text-anchor="middle" x="156.5" y="-1171.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">compute_partial_charges</text>
</g>
<!-- proc~dhscf&#45;&gt;compute_partial_charges -->
<g id="proc~~dhscf~~CallsGraph_edge23" class="edge"><title>proc~dhscf&#45;&gt;compute_partial_charges</title>
<path fill="none" stroke="#000000" d="M30.4277,-1322.01C36.2044,-1296.12 53.1298,-1235.03 90,-1200.16 93.7371,-1196.62 98.0135,-1193.55 102.551,-1190.87"/>
<polygon fill="#000000" stroke="#000000" points="104.26,-1193.93 111.527,-1186.22 101.038,-1187.72 104.26,-1193.93"/>
</g>
<!-- write_tdrho -->
<g id="proc~~dhscf~~CallsGraph_node25" class="node"><title>write_tdrho</title>
<polygon fill="#777777" stroke="#777777" points="189.5,-1144.16 123.5,-1144.16 123.5,-1120.16 189.5,-1120.16 189.5,-1144.16"/>
<text text-anchor="middle" x="156.5" y="-1129.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_tdrho</text>
</g>
<!-- proc~dhscf&#45;&gt;write_tdrho -->
<g id="proc~~dhscf~~CallsGraph_edge24" class="edge"><title>proc~dhscf&#45;&gt;write_tdrho</title>
<path fill="none" stroke="#000000" d="M28.5487,-1322.09C30.6681,-1289.92 40.9034,-1201.29 90,-1153.16 96.5052,-1146.78 104.95,-1142.34 113.601,-1139.24"/>
<polygon fill="#000000" stroke="#000000" points="114.803,-1142.54 123.363,-1136.29 112.778,-1135.84 114.803,-1142.54"/>
</g>
<!-- partialcoreonmesh -->
<g id="proc~~dhscf~~CallsGraph_node26" class="node"><title>partialcoreonmesh</title>
<polygon fill="#777777" stroke="#777777" points="207,-1102.16 106,-1102.16 106,-1078.16 207,-1078.16 207,-1102.16"/>
<text text-anchor="middle" x="156.5" y="-1087.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">partialcoreonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;partialcoreonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge25" class="edge"><title>proc~dhscf&#45;&gt;partialcoreonmesh</title>
<path fill="none" stroke="#000000" d="M27.6319,-1322.1C27.1826,-1285.19 30.9503,-1172.56 90,-1111.16 92.0952,-1108.98 94.4165,-1107.02 96.8986,-1105.27"/>
<polygon fill="#000000" stroke="#000000" points="98.9742,-1108.11 105.863,-1100.06 95.4578,-1102.06 98.9742,-1108.11"/>
</g>
<!-- mymeshbox -->
<g id="proc~~dhscf~~CallsGraph_node27" class="node"><title>mymeshbox</title>
<polygon fill="#777777" stroke="#777777" points="342,-1518.16 272,-1518.16 272,-1494.16 342,-1494.16 342,-1518.16"/>
<text text-anchor="middle" x="307" y="-1503.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mymeshbox</text>
</g>
<!-- proc~dhscf&#45;&gt;mymeshbox -->
<g id="proc~~dhscf~~CallsGraph_edge26" class="edge"><title>proc~dhscf&#45;&gt;mymeshbox</title>
<path fill="none" stroke="#000000" d="M35.428,-1322.08C45.5803,-1306.87 65.3721,-1281.47 90,-1271.16 144.521,-1248.32 175.616,-1235.82 223,-1271.16 267.976,-1304.7 240.283,-1339.26 259,-1392.16 270.581,-1424.88 286.349,-1461.89 296.353,-1484.63"/>
<polygon fill="#000000" stroke="#000000" points="293.256,-1486.28 300.508,-1494 299.655,-1483.44 293.256,-1486.28"/>
</g>
<!-- neutralatomonmesh -->
<g id="proc~~dhscf~~CallsGraph_node28" class="node"><title>neutralatomonmesh</title>
<polygon fill="#777777" stroke="#777777" points="210.5,-1022.16 102.5,-1022.16 102.5,-998.156 210.5,-998.156 210.5,-1022.16"/>
<text text-anchor="middle" x="156.5" y="-1007.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">neutralatomonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;neutralatomonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge27" class="edge"><title>proc~dhscf&#45;&gt;neutralatomonmesh</title>
<path fill="none" stroke="#000000" d="M29.0227,-1321.82C33.4346,-1271.32 52.341,-1080.95 90,-1036.16 92.7456,-1032.89 95.9587,-1030.03 99.461,-1027.53"/>
<polygon fill="#000000" stroke="#000000" points="101.331,-1030.49 108.074,-1022.32 97.7067,-1024.5 101.331,-1030.49"/>
</g>
<!-- interface~distmeshdata -->
<g id="proc~~dhscf~~CallsGraph_node29" class="node"><title>interface~distmeshdata</title>
<g id="a_proc~~dhscf~~CallsGraph_node29"><a xlink:href=".././interface/distmeshdata.html" xlink:title="distMeshData">
<polygon fill="#a7506f" stroke="#a7506f" points="346,-1569.16 268,-1569.16 268,-1545.16 346,-1545.16 346,-1569.16"/>
<text text-anchor="middle" x="307" y="-1554.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;interface~distmeshdata -->
<g id="proc~~dhscf~~CallsGraph_edge28" class="edge"><title>proc~dhscf&#45;&gt;interface~distmeshdata</title>
<path fill="none" stroke="#000000" d="M28.0901,-1346.38C29.0468,-1379.79 36.6038,-1473.19 90,-1519.16 114.584,-1540.32 202.136,-1550.15 257.941,-1554.35"/>
<polygon fill="#000000" stroke="#000000" points="257.744,-1557.84 267.969,-1555.07 258.246,-1550.86 257.744,-1557.84"/>
</g>
<!-- proc~vmat -->
<g id="proc~~dhscf~~CallsGraph_node30" class="node"><title>proc~vmat</title>
<g id="a_proc~~dhscf~~CallsGraph_node30"><a xlink:href=".././proc/vmat.html" xlink:title="vmat">
<polygon fill="#d9534f" stroke="#d9534f" points="334,-668.156 280,-668.156 280,-644.156 334,-644.156 334,-668.156"/>
<text text-anchor="middle" x="307" y="-653.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vmat</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~vmat -->
<g id="proc~~dhscf~~CallsGraph_edge29" class="edge"><title>proc~dhscf&#45;&gt;proc~vmat</title>
<path fill="none" stroke="#000000" d="M28.4,-1322.03C31.2246,-1239.61 49.2447,-763.347 90,-715.156 92.9662,-711.648 209.362,-681.142 270.028,-665.428"/>
<polygon fill="#000000" stroke="#000000" points="271.16,-668.751 279.965,-662.858 269.407,-661.974 271.16,-668.751"/>
</g>
<!-- timer -->
<g id="proc~~dhscf~~CallsGraph_node31" class="node"><title>timer</title>
<polygon fill="#777777" stroke="#777777" points="727.5,-796.156 673.5,-796.156 673.5,-772.156 727.5,-772.156 727.5,-796.156"/>
<text text-anchor="middle" x="700.5" y="-781.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">timer</text>
</g>
<!-- proc~dhscf&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge30" class="edge"><title>proc~dhscf&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M28.3719,-1322.05C30.9804,-1240.55 47.6798,-770.951 90,-635.156 147.916,-449.318 111.347,-254.156 306,-254.156 306,-254.156 306,-254.156 442,-254.156 532.252,-254.156 568.63,-275.375 622,-348.156 671.29,-415.373 692.682,-681.524 698.074,-761.385"/>
<polygon fill="#000000" stroke="#000000" points="694.608,-762.02 698.755,-771.77 701.593,-761.562 694.608,-762.02"/>
</g>
<!-- mpi_allreduce -->
<g id="proc~~dhscf~~CallsGraph_node32" class="node"><title>mpi_allreduce</title>
<polygon fill="#777777" stroke="#777777" points="196,-790.156 117,-790.156 117,-766.156 196,-766.156 196,-790.156"/>
<text text-anchor="middle" x="156.5" y="-775.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_allreduce</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_allreduce -->
<g id="proc~~dhscf~~CallsGraph_edge31" class="edge"><title>proc~dhscf&#45;&gt;mpi_allreduce</title>
<path fill="none" stroke="#000000" d="M27.7878,-1321.95C26.7846,-1250.7 24.987,-888.849 90,-804.156 94.5584,-798.217 100.68,-793.632 107.356,-790.093"/>
<polygon fill="#000000" stroke="#000000" points="109.026,-793.18 116.71,-785.886 106.154,-786.796 109.026,-793.18"/>
</g>
<!-- vacuum_level -->
<g id="proc~~dhscf~~CallsGraph_node33" class="node"><title>vacuum_level</title>
<polygon fill="#777777" stroke="#777777" points="195.5,-748.156 117.5,-748.156 117.5,-724.156 195.5,-724.156 195.5,-748.156"/>
<text text-anchor="middle" x="156.5" y="-733.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vacuum_level</text>
</g>
<!-- proc~dhscf&#45;&gt;vacuum_level -->
<g id="proc~~dhscf~~CallsGraph_edge32" class="edge"><title>proc~dhscf&#45;&gt;vacuum_level</title>
<path fill="none" stroke="#000000" d="M28.5137,-1322.12C31.9783,-1243.31 52.9253,-802.649 90,-757.156 94.6678,-751.428 100.906,-747.242 107.682,-744.188"/>
<polygon fill="#000000" stroke="#000000" points="108.992,-747.435 117.159,-740.685 106.566,-740.869 108.992,-747.435"/>
</g>
<!-- de_alloc -->
<g id="proc~~dhscf~~CallsGraph_node34" class="node"><title>de_alloc</title>
<polygon fill="#777777" stroke="#777777" points="727.5,-1158.16 673.5,-1158.16 673.5,-1134.16 727.5,-1134.16 727.5,-1158.16"/>
<text text-anchor="middle" x="700.5" y="-1143.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">de_alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge33" class="edge"><title>proc~dhscf&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M28.2154,-1322.04C29.5752,-1257.21 38.6617,-951.343 90,-875.156 128.045,-818.696 182.678,-854.012 223,-799.156 267.197,-739.028 235.225,-705.891 259,-635.156 303.602,-502.454 273.076,-424.607 391,-349.156 489.329,-286.241 570.324,-369.482 622,-474.156 654.753,-540.5 649.531,-731.653 658,-805.156 671.862,-925.459 689.843,-1069.46 696.688,-1123.87"/>
<polygon fill="#000000" stroke="#000000" points="693.252,-1124.6 697.974,-1134.08 700.197,-1123.72 693.252,-1124.6"/>
</g>
<!-- localchargeonmesh -->
<g id="proc~~dhscf~~CallsGraph_node35" class="node"><title>localchargeonmesh</title>
<polygon fill="#777777" stroke="#777777" points="209.5,-668.156 103.5,-668.156 103.5,-644.156 209.5,-644.156 209.5,-668.156"/>
<text text-anchor="middle" x="156.5" y="-653.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">localchargeonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;localchargeonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge34" class="edge"><title>proc~dhscf&#45;&gt;localchargeonmesh</title>
<path fill="none" stroke="#000000" d="M28.401,-1321.99C31.2954,-1237.12 50.0274,-735.412 90,-682.156 92.4099,-678.945 95.278,-676.13 98.4474,-673.662"/>
<polygon fill="#000000" stroke="#000000" points="100.366,-676.59 106.857,-668.216 96.5607,-670.715 100.366,-676.59"/>
</g>
<!-- write_debug -->
<g id="proc~~dhscf~~CallsGraph_node36" class="node"><title>write_debug</title>
<polygon fill="#777777" stroke="#777777" points="610,-226.156 539,-226.156 539,-202.156 610,-202.156 610,-226.156"/>
<text text-anchor="middle" x="574.5" y="-211.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_debug</text>
</g>
<!-- proc~dhscf&#45;&gt;write_debug -->
<g id="proc~~dhscf~~CallsGraph_edge35" class="edge"><title>proc~dhscf&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M28.2297,-1321.98C30.496,-1204.79 49.6288,-280.41 90,-240.156 150.561,-179.769 420.299,-198.95 528.438,-209.364"/>
<polygon fill="#000000" stroke="#000000" points="528.395,-212.876 538.689,-210.372 529.08,-205.91 528.395,-212.876"/>
</g>
<!-- proc~rhoofd -->
<g id="proc~~dhscf~~CallsGraph_node37" class="node"><title>proc~rhoofd</title>
<g id="a_proc~~dhscf~~CallsGraph_node37"><a xlink:href=".././proc/rhoofd.html" xlink:title="rhoofd">
<polygon fill="#d9534f" stroke="#d9534f" points="334,-872.156 280,-872.156 280,-848.156 334,-848.156 334,-872.156"/>
<text text-anchor="middle" x="307" y="-857.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">rhoofd</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~rhoofd -->
<g id="proc~~dhscf~~CallsGraph_edge36" class="edge"><title>proc~dhscf&#45;&gt;proc~rhoofd</title>
<path fill="none" stroke="#000000" d="M28.5437,-1322.12C31.3357,-1265.03 45.6924,-1021.96 90,-963.156 134.347,-904.298 220.942,-877.554 269.946,-866.679"/>
<polygon fill="#000000" stroke="#000000" points="270.745,-870.087 279.804,-864.593 269.296,-863.239 270.745,-870.087"/>
</g>
<!-- proc~write_rho -->
<g id="proc~~dhscf~~CallsGraph_node38" class="node"><title>proc~write_rho</title>
<g id="a_proc~~dhscf~~CallsGraph_node38"><a xlink:href=".././proc/write_rho.html" xlink:title="write_rho">
<polygon fill="#d9534f" stroke="#d9534f" points="469.5,-157.156 412.5,-157.156 412.5,-133.156 469.5,-133.156 469.5,-157.156"/>
<text text-anchor="middle" x="441" y="-142.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_rho</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~write_rho -->
<g id="proc~~dhscf~~CallsGraph_edge37" class="edge"><title>proc~dhscf&#45;&gt;proc~write_rho</title>
<path fill="none" stroke="#000000" d="M28.2327,-1321.95C30.5627,-1202.44 50.4392,-245.06 90,-201.156 169.898,-112.485 329.642,-126.032 402.374,-137.806"/>
<polygon fill="#000000" stroke="#000000" points="402.009,-141.294 412.454,-139.517 403.181,-134.392 402.009,-141.294"/>
</g>
<!-- proc~forhar&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge40" class="edge"><title>proc~forhar&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M183.583,-1584.14C195.961,-1587.57 210.7,-1592.53 223,-1599.16 241.087,-1608.9 240.62,-1618.97 259,-1628.16 332.418,-1664.83 552.566,-1739.91 622,-1696.16 634.885,-1688.04 673.248,-1597.94 690.691,-1555.73"/>
<polygon fill="#000000" stroke="#000000" points="693.986,-1556.92 694.553,-1546.34 687.513,-1554.26 693.986,-1556.92"/>
</g>
<!-- proc~forhar&#45;&gt;jms_setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge43" class="edge"><title>proc~forhar&#45;&gt;jms_setmeshdistr</title>
<path fill="none" stroke="#000000" d="M183.824,-1580.42C197.34,-1582.95 213.02,-1588.22 223,-1599.16 272.711,-1653.64 232.359,-1692.38 259,-1761.16 267.522,-1783.16 281.297,-1806.31 291.737,-1822.38"/>
<polygon fill="#000000" stroke="#000000" points="288.987,-1824.57 297.433,-1830.96 294.819,-1820.7 288.987,-1824.57"/>
</g>
<!-- proc~forhar&#45;&gt;bsc_cellxc -->
<g id="proc~~dhscf~~CallsGraph_edge44" class="edge"><title>proc~forhar&#45;&gt;bsc_cellxc</title>
<path fill="none" stroke="#000000" d="M183.512,-1580.72C196.937,-1583.33 212.628,-1588.59 223,-1599.16 262.001,-1638.9 222.241,-1677.33 259,-1719.16 261.373,-1721.86 264.16,-1724.23 267.173,-1726.3"/>
<polygon fill="#000000" stroke="#000000" points="265.687,-1729.48 276.105,-1731.41 269.162,-1723.41 265.687,-1729.48"/>
</g>
<!-- proc~forhar&#45;&gt;proc~setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge39" class="edge"><title>proc~forhar&#45;&gt;proc~setmeshdistr</title>
<path fill="none" stroke="#000000" d="M183.803,-1581.65C196.824,-1584.51 212.056,-1589.72 223,-1599.16 250.4,-1622.78 234.03,-1645.98 259,-1672.16 261.969,-1675.27 265.394,-1678.1 269.014,-1680.66"/>
<polygon fill="#000000" stroke="#000000" points="267.364,-1683.76 277.692,-1686.12 271.091,-1677.83 267.364,-1683.76"/>
</g>
<!-- proc~forhar&#45;&gt;mymeshbox -->
<g id="proc~~dhscf~~CallsGraph_edge38" class="edge"><title>proc~forhar&#45;&gt;mymeshbox</title>
<path fill="none" stroke="#000000" d="M182.356,-1566.1C206.877,-1554.22 244.552,-1535.95 271.871,-1522.7"/>
<polygon fill="#000000" stroke="#000000" points="273.592,-1525.76 281.063,-1518.25 270.538,-1519.46 273.592,-1525.76"/>
</g>
<!-- proc~forhar&#45;&gt;interface~distmeshdata -->
<g id="proc~~dhscf~~CallsGraph_edge41" class="edge"><title>proc~forhar&#45;&gt;interface~distmeshdata</title>
<path fill="none" stroke="#000000" d="M183.707,-1574.45C204.107,-1571.56 232.986,-1567.48 257.558,-1564.01"/>
<polygon fill="#000000" stroke="#000000" points="258.376,-1567.43 267.788,-1562.56 257.396,-1560.49 258.376,-1567.43"/>
</g>
<!-- proc~forhar&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge42" class="edge"><title>proc~forhar&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M183.577,-1583.65C271.898,-1601.57 557.816,-1653.96 622,-1595.16 689.599,-1533.22 617.431,-1266.37 658,-1184.16 661.507,-1177.05 666.959,-1170.63 672.77,-1165.18"/>
<polygon fill="#000000" stroke="#000000" points="675.425,-1167.51 680.77,-1158.37 670.887,-1162.18 675.425,-1167.51"/>
</g>
<!-- pxfflush -->
<g id="proc~~dhscf~~CallsGraph_node48" class="node"><title>pxfflush</title>
<polygon fill="#777777" stroke="#777777" points="840.5,-1575.16 786.5,-1575.16 786.5,-1551.16 840.5,-1551.16 840.5,-1575.16"/>
<text text-anchor="middle" x="813.5" y="-1560.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">pxfflush</text>
</g>
<!-- proc~bye&#45;&gt;pxfflush -->
<g id="proc~~dhscf~~CallsGraph_edge45" class="edge"><title>proc~bye&#45;&gt;pxfflush</title>
<path fill="none" stroke="#000000" d="M727.923,-1685.53C733.269,-1682.65 738.595,-1679.19 743,-1675.16 771.318,-1649.2 792.383,-1609.12 803.53,-1584.61"/>
<polygon fill="#000000" stroke="#000000" points="806.74,-1586 807.565,-1575.44 800.333,-1583.18 806.74,-1586"/>
</g>
<!-- cmlfinishfile -->
<g id="proc~~dhscf~~CallsGraph_node54" class="node"><title>cmlfinishfile</title>
<polygon fill="#777777" stroke="#777777" points="847,-1351.16 780,-1351.16 780,-1327.16 847,-1327.16 847,-1351.16"/>
<text text-anchor="middle" x="813.5" y="-1336.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cmlfinishfile</text>
</g>
<!-- proc~bye&#45;&gt;cmlfinishfile -->
<g id="proc~~dhscf~~CallsGraph_edge47" class="edge"><title>proc~bye&#45;&gt;cmlfinishfile</title>
<path fill="none" stroke="#000000" d="M727.808,-1687.3C733.55,-1684.26 739.074,-1680.29 743,-1675.16 762.371,-1649.84 797.937,-1431.96 809.073,-1361.23"/>
<polygon fill="#000000" stroke="#000000" points="812.556,-1361.61 810.645,-1351.19 805.64,-1360.53 812.556,-1361.61"/>
</g>
<!-- mpi_finalize -->
<g id="proc~~dhscf~~CallsGraph_node58" class="node"><title>mpi_finalize</title>
<polygon fill="#777777" stroke="#777777" points="848,-1708.16 779,-1708.16 779,-1684.16 848,-1684.16 848,-1708.16"/>
<text text-anchor="middle" x="813.5" y="-1693.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_finalize</text>
</g>
<!-- proc~bye&#45;&gt;mpi_finalize -->
<g id="proc~~dhscf~~CallsGraph_edge46" class="edge"><title>proc~bye&#45;&gt;mpi_finalize</title>
<path fill="none" stroke="#000000" d="M727.525,-1696.16C739.677,-1696.16 754.487,-1696.16 768.317,-1696.16"/>
<polygon fill="#000000" stroke="#000000" points="768.642,-1699.66 778.642,-1696.16 768.642,-1692.66 768.642,-1699.66"/>
</g>
<!-- io_close -->
<g id="proc~~dhscf~~CallsGraph_node46" class="node"><title>io_close</title>
<polygon fill="#777777" stroke="#777777" points="840.5,-888.156 786.5,-888.156 786.5,-864.156 840.5,-864.156 840.5,-888.156"/>
<text text-anchor="middle" x="813.5" y="-873.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">io_close</text>
</g>
<!-- proc~die&#45;&gt;io_close -->
<g id="proc~~dhscf~~CallsGraph_edge48" class="edge"><title>proc~die&#45;&gt;io_close</title>
<path fill="none" stroke="#000000" d="M719.159,-1192.93C727.564,-1186.24 737.054,-1177.26 743,-1167.16 795.902,-1077.26 808.574,-949.339 811.579,-898.363"/>
<polygon fill="#000000" stroke="#000000" points="815.085,-898.335 812.108,-888.167 808.094,-897.972 815.085,-898.335"/>
</g>
<!-- io_assign -->
<g id="proc~~dhscf~~CallsGraph_node47" class="node"><title>io_assign</title>
<polygon fill="#777777" stroke="#777777" points="842.5,-314.156 784.5,-314.156 784.5,-290.156 842.5,-290.156 842.5,-314.156"/>
<text text-anchor="middle" x="813.5" y="-299.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">io_assign</text>
</g>
<!-- proc~die&#45;&gt;io_assign -->
<g id="proc~~dhscf~~CallsGraph_edge50" class="edge"><title>proc~die&#45;&gt;io_assign</title>
<path fill="none" stroke="#000000" d="M720.262,-1192.96C728.724,-1186.39 737.936,-1177.51 743,-1167.16 762.091,-1128.11 803.24,-456.535 811.165,-324.56"/>
<polygon fill="#000000" stroke="#000000" points="814.667,-324.616 811.771,-314.425 807.68,-324.198 814.667,-324.616"/>
</g>
<!-- proc~die&#45;&gt;pxfflush -->
<g id="proc~~dhscf~~CallsGraph_edge53" class="edge"><title>proc~die&#45;&gt;pxfflush</title>
<path fill="none" stroke="#000000" d="M705.321,-1217.48C721.532,-1269.76 784.751,-1473.66 805.708,-1541.25"/>
<polygon fill="#000000" stroke="#000000" points="802.391,-1542.37 808.695,-1550.88 809.077,-1540.3 802.391,-1542.37"/>
</g>
<!-- proc~die&#45;&gt;cmlfinishfile -->
<g id="proc~~dhscf~~CallsGraph_edge49" class="edge"><title>proc~die&#45;&gt;cmlfinishfile</title>
<path fill="none" stroke="#000000" d="M711.744,-1217.52C730.907,-1240.66 772.345,-1290.68 795.669,-1318.84"/>
<polygon fill="#000000" stroke="#000000" points="793.207,-1321.35 802.281,-1326.82 798.597,-1316.89 793.207,-1321.35"/>
</g>
<!-- mpi_abort -->
<g id="proc~~dhscf~~CallsGraph_node59" class="node"><title>mpi_abort</title>
<polygon fill="#777777" stroke="#777777" points="844,-1238.16 783,-1238.16 783,-1214.16 844,-1214.16 844,-1238.16"/>
<text text-anchor="middle" x="813.5" y="-1223.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_abort</text>
</g>
<!-- proc~die&#45;&gt;mpi_abort -->
<g id="proc~~dhscf~~CallsGraph_edge52" class="edge"><title>proc~die&#45;&gt;mpi_abort</title>
<path fill="none" stroke="#000000" d="M727.525,-1210.08C740.957,-1212.62 757.635,-1215.78 772.648,-1218.62"/>
<polygon fill="#000000" stroke="#000000" points="772.24,-1222.1 782.716,-1220.52 773.541,-1215.22 772.24,-1222.1"/>
</g>
<!-- pxfabort -->
<g id="proc~~dhscf~~CallsGraph_node60" class="node"><title>pxfabort</title>
<polygon fill="#777777" stroke="#777777" points="840.5,-1196.16 786.5,-1196.16 786.5,-1172.16 840.5,-1172.16 840.5,-1196.16"/>
<text text-anchor="middle" x="813.5" y="-1181.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">pxfabort</text>
</g>
<!-- proc~die&#45;&gt;pxfabort -->
<g id="proc~~dhscf~~CallsGraph_edge51" class="edge"><title>proc~die&#45;&gt;pxfabort</title>
<path fill="none" stroke="#000000" d="M727.525,-1200.23C742.032,-1197.49 760.326,-1194.03 776.22,-1191.02"/>
<polygon fill="#000000" stroke="#000000" points="777.079,-1194.42 786.254,-1189.12 775.778,-1187.54 777.079,-1194.42"/>
</g>
<!-- proc~dfscf&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge57" class="edge"><title>proc~dfscf&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M308.962,-1030.22C313.701,-1086.26 336.563,-1320.26 391,-1363.16 471.689,-1426.73 536.134,-1298.76 622,-1355.16 675.816,-1390.5 692.443,-1472.08 697.436,-1511.72"/>
<polygon fill="#000000" stroke="#000000" points="693.965,-1512.17 698.557,-1521.71 700.921,-1511.39 693.965,-1512.17"/>
</g>
<!-- proc~dfscf&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge68" class="edge"><title>proc~dfscf&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M307.669,-1030.38C307.299,-1071.7 312.35,-1206.76 391,-1263.16 427.119,-1289.05 451.903,-1284.29 491,-1263.16 516.7,-1249.26 501.422,-1222.27 527,-1208.16 569.126,-1184.91 626.308,-1189.65 663.063,-1196.42"/>
<polygon fill="#000000" stroke="#000000" points="662.826,-1199.94 673.316,-1198.45 664.19,-1193.07 662.826,-1199.94"/>
</g>
<!-- proc~dfscf&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge60" class="edge"><title>proc~dfscf&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M308.973,-1030.28C312.503,-1065.19 327.988,-1166.01 391,-1207.16 428.213,-1231.46 456.975,-1235.75 491,-1207.16 562.153,-1147.36 488.904,-1085.93 527,-1001.16 564.412,-917.9 641.068,-838.903 678.287,-803.549"/>
<polygon fill="#000000" stroke="#000000" points="681.122,-805.688 686.021,-796.294 676.333,-800.583 681.122,-805.688"/>
</g>
<!-- proc~dfscf&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge65" class="edge"><title>proc~dfscf&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M308.135,-1030.34C309.305,-1069.12 318.819,-1190.08 391,-1240.16 427.518,-1265.49 453.061,-1263.31 491,-1240.16 520.863,-1221.93 498.466,-1190.4 527,-1170.16 567.124,-1141.69 625.925,-1139.71 663.454,-1142.05"/>
<polygon fill="#000000" stroke="#000000" points="663.206,-1145.54 673.442,-1142.81 663.735,-1138.56 663.206,-1145.54"/>
</g>
<!-- endpht -->
<g id="proc~~dhscf~~CallsGraph_node39" class="node"><title>endpht</title>
<polygon fill="#777777" stroke="#777777" points="468,-794.156 414,-794.156 414,-770.156 468,-770.156 468,-794.156"/>
<text text-anchor="middle" x="441" y="-779.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">endpht</text>
</g>
<!-- proc~dfscf&#45;&gt;endpht -->
<g id="proc~~dhscf~~CallsGraph_edge56" class="edge"><title>proc~dfscf&#45;&gt;endpht</title>
<path fill="none" stroke="#000000" d="M314.727,-1006.13C335.911,-968.253 401.425,-851.122 428.307,-803.061"/>
<polygon fill="#000000" stroke="#000000" points="431.459,-804.595 433.286,-794.159 425.35,-801.178 431.459,-804.595"/>
</g>
<!-- listp2 -->
<g id="proc~~dhscf~~CallsGraph_node40" class="node"><title>listp2</title>
<polygon fill="#777777" stroke="#777777" points="468,-626.156 414,-626.156 414,-602.156 468,-602.156 468,-626.156"/>
<text text-anchor="middle" x="441" y="-611.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">listp2</text>
</g>
<!-- proc~dfscf&#45;&gt;listp2 -->
<g id="proc~~dhscf~~CallsGraph_edge58" class="edge"><title>proc~dfscf&#45;&gt;listp2</title>
<path fill="none" stroke="#000000" d="M313.06,-1005.92C322.657,-982.236 343.563,-928.32 355,-881.156 381.04,-773.77 323.636,-722.745 391,-635.156 394.526,-630.57 399.252,-626.972 404.38,-624.153"/>
<polygon fill="#000000" stroke="#000000" points="406.196,-627.173 413.875,-619.873 403.32,-620.791 406.196,-627.173"/>
</g>
<!-- needdscfl -->
<g id="proc~~dhscf~~CallsGraph_node41" class="node"><title>needdscfl</title>
<polygon fill="#777777" stroke="#777777" points="470,-584.156 412,-584.156 412,-560.156 470,-560.156 470,-584.156"/>
<text text-anchor="middle" x="441" y="-569.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">needdscfl</text>
</g>
<!-- proc~dfscf&#45;&gt;needdscfl -->
<g id="proc~~dhscf~~CallsGraph_edge59" class="edge"><title>proc~dfscf&#45;&gt;needdscfl</title>
<path fill="none" stroke="#000000" d="M313.15,-1005.94C322.901,-982.294 344.058,-928.437 355,-881.156 369.542,-818.318 352.217,-644.691 391,-593.156 394.154,-588.965 398.313,-585.6 402.877,-582.901"/>
<polygon fill="#000000" stroke="#000000" points="404.518,-585.996 411.996,-578.49 401.47,-579.694 404.518,-585.996"/>
</g>
<!-- numdl -->
<g id="proc~~dhscf~~CallsGraph_node42" class="node"><title>numdl</title>
<polygon fill="#777777" stroke="#777777" points="468,-1114.16 414,-1114.16 414,-1090.16 468,-1090.16 468,-1114.16"/>
<text text-anchor="middle" x="441" y="-1099.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">numdl</text>
</g>
<!-- proc~dfscf&#45;&gt;numdl -->
<g id="proc~~dhscf~~CallsGraph_edge66" class="edge"><title>proc~dfscf&#45;&gt;numdl</title>
<path fill="none" stroke="#000000" d="M321.652,-1030.19C337.524,-1043.78 364.889,-1065.96 391,-1081.16 395.275,-1083.64 399.9,-1086.01 404.543,-1088.19"/>
<polygon fill="#000000" stroke="#000000" points="403.433,-1091.53 413.992,-1092.4 406.282,-1085.13 403.433,-1091.53"/>
</g>
<!-- alloc_default -->
<g id="proc~~dhscf~~CallsGraph_node44" class="node"><title>alloc_default</title>
<polygon fill="#777777" stroke="#777777" points="477.5,-1354.16 404.5,-1354.16 404.5,-1330.16 477.5,-1330.16 477.5,-1354.16"/>
<text text-anchor="middle" x="441" y="-1339.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">alloc_default</text>
</g>
<!-- proc~dfscf&#45;&gt;alloc_default -->
<g id="proc~~dhscf~~CallsGraph_edge69" class="edge"><title>proc~dfscf&#45;&gt;alloc_default</title>
<path fill="none" stroke="#000000" d="M310.085,-1030.41C318.817,-1080.57 353.725,-1269.81 391,-1316.16 393.508,-1319.27 396.494,-1322.07 399.735,-1324.55"/>
<polygon fill="#000000" stroke="#000000" points="397.919,-1327.55 408.195,-1330.13 401.77,-1321.7 397.919,-1327.55"/>
</g>
<!-- indxuo -->
<g id="proc~~dhscf~~CallsGraph_node51" class="node"><title>indxuo</title>
<polygon fill="#777777" stroke="#777777" points="468,-1072.16 414,-1072.16 414,-1048.16 468,-1048.16 468,-1072.16"/>
<text text-anchor="middle" x="441" y="-1057.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">indxuo</text>
</g>
<!-- proc~dfscf&#45;&gt;indxuo -->
<g id="proc~~dhscf~~CallsGraph_edge54" class="edge"><title>proc~dfscf&#45;&gt;indxuo</title>
<path fill="none" stroke="#000000" d="M334.079,-1026.45C354.147,-1032.84 382.102,-1041.73 404.255,-1048.78"/>
<polygon fill="#000000" stroke="#000000" points="403.385,-1052.18 413.975,-1051.88 405.507,-1045.51 403.385,-1052.18"/>
</g>
<!-- listsc -->
<g id="proc~~dhscf~~CallsGraph_node52" class="node"><title>listsc</title>
<polygon fill="#777777" stroke="#777777" points="468,-1030.16 414,-1030.16 414,-1006.16 468,-1006.16 468,-1030.16"/>
<text text-anchor="middle" x="441" y="-1015.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">listsc</text>
</g>
<!-- proc~dfscf&#45;&gt;listsc -->
<g id="proc~~dhscf~~CallsGraph_edge55" class="edge"><title>proc~dfscf&#45;&gt;listsc</title>
<path fill="none" stroke="#000000" d="M334.079,-1018.16C354.056,-1018.16 381.851,-1018.16 403.955,-1018.16"/>
<polygon fill="#000000" stroke="#000000" points="403.975,-1021.66 413.975,-1018.16 403.975,-1014.66 403.975,-1021.66"/>
</g>
<!-- listdlptr -->
<g id="proc~~dhscf~~CallsGraph_node55" class="node"><title>listdlptr</title>
<polygon fill="#777777" stroke="#777777" points="468,-752.156 414,-752.156 414,-728.156 468,-728.156 468,-752.156"/>
<text text-anchor="middle" x="441" y="-737.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">listdlptr</text>
</g>
<!-- proc~dfscf&#45;&gt;listdlptr -->
<g id="proc~~dhscf~~CallsGraph_edge61" class="edge"><title>proc~dfscf&#45;&gt;listdlptr</title>
<path fill="none" stroke="#000000" d="M312.308,-1006.11C320.779,-982.328 340.073,-927.598 355,-881.156 372.038,-828.145 353.922,-802.697 391,-761.156 394.775,-756.926 399.548,-753.519 404.626,-750.782"/>
<polygon fill="#000000" stroke="#000000" points="406.29,-753.87 413.946,-746.547 403.394,-747.497 406.29,-753.87"/>
</g>
<!-- lstpht -->
<g id="proc~~dhscf~~CallsGraph_node56" class="node"><title>lstpht</title>
<polygon fill="#777777" stroke="#777777" points="468,-710.156 414,-710.156 414,-686.156 468,-686.156 468,-710.156"/>
<text text-anchor="middle" x="441" y="-695.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">lstpht</text>
</g>
<!-- proc~dfscf&#45;&gt;lstpht -->
<g id="proc~~dhscf~~CallsGraph_edge63" class="edge"><title>proc~dfscf&#45;&gt;lstpht</title>
<path fill="none" stroke="#000000" d="M312.748,-1005.84C321.81,-982.014 341.841,-927.868 355,-881.156 374.998,-810.162 343.921,-775.932 391,-719.156 394.655,-714.747 399.406,-711.243 404.509,-708.464"/>
<polygon fill="#000000" stroke="#000000" points="406.25,-711.518 413.915,-704.204 403.362,-705.141 406.25,-711.518"/>
</g>
<!-- globaltolocalorb -->
<g id="proc~~dhscf~~CallsGraph_node57" class="node"><title>globaltolocalorb</title>
<polygon fill="#777777" stroke="#777777" points="485,-668.156 397,-668.156 397,-644.156 485,-644.156 485,-668.156"/>
<text text-anchor="middle" x="441" y="-653.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">globaltolocalorb</text>
</g>
<!-- proc~dfscf&#45;&gt;globaltolocalorb -->
<g id="proc~~dhscf~~CallsGraph_edge64" class="edge"><title>proc~dfscf&#45;&gt;globaltolocalorb</title>
<path fill="none" stroke="#000000" d="M312.935,-1005.89C322.317,-982.151 342.872,-928.147 355,-881.156 378.008,-792.009 333.806,-749.304 391,-677.156 391.69,-676.285 392.423,-675.45 393.193,-674.65"/>
<polygon fill="#000000" stroke="#000000" points="395.429,-677.343 400.988,-668.323 391.018,-671.908 395.429,-677.343"/>
</g>
<!-- matrixotom -->
<g id="proc~~dhscf~~CallsGraph_node61" class="node"><title>matrixotom</title>
<polygon fill="#777777" stroke="#777777" points="474,-1156.16 408,-1156.16 408,-1132.16 474,-1132.16 474,-1156.16"/>
<text text-anchor="middle" x="441" y="-1141.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">matrixotom</text>
</g>
<!-- proc~dfscf&#45;&gt;matrixotom -->
<g id="proc~~dhscf~~CallsGraph_edge62" class="edge"><title>proc~dfscf&#45;&gt;matrixotom</title>
<path fill="none" stroke="#000000" d="M314.914,-1030.48C327.507,-1051.95 356.128,-1096.46 391,-1123.16 393.456,-1125.04 396.106,-1126.78 398.858,-1128.4"/>
<polygon fill="#000000" stroke="#000000" points="397.395,-1131.59 407.877,-1133.12 400.643,-1125.38 397.395,-1131.59"/>
</g>
<!-- proc~rcut -->
<g id="proc~~dhscf~~CallsGraph_node63" class="node"><title>proc~rcut</title>
<g id="a_proc~~dhscf~~CallsGraph_node63"><a xlink:href=".././proc/rcut.html" xlink:title="rcut">
<polygon fill="#d94e8f" stroke="#d94e8f" points="468,-950.156 414,-950.156 414,-926.156 468,-926.156 468,-950.156"/>
<text text-anchor="middle" x="441" y="-935.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">rcut</text>
</a>
</g>
</g>
<!-- proc~dfscf&#45;&gt;proc~rcut -->
<g id="proc~~dhscf~~CallsGraph_edge67" class="edge"><title>proc~dfscf&#45;&gt;proc~rcut</title>
<path fill="none" stroke="#000000" d="M328.048,-1006.01C350.273,-992.536 386.299,-970.702 411.462,-955.451"/>
<polygon fill="#000000" stroke="#000000" points="413.458,-958.334 420.196,-950.158 409.83,-952.348 413.458,-958.334"/>
</g>
<!-- dscfl -->
<g id="proc~~dhscf~~CallsGraph_node64" class="node"><title>dscfl</title>
<polygon fill="#777777" stroke="#777777" points="468,-1198.16 414,-1198.16 414,-1174.16 468,-1174.16 468,-1198.16"/>
<text text-anchor="middle" x="441" y="-1183.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dscfl</text>
</g>
<!-- proc~dfscf&#45;&gt;dscfl -->
<g id="proc~~dhscf~~CallsGraph_edge70" class="edge"><title>proc~dfscf&#45;&gt;dscfl</title>
<path fill="none" stroke="#000000" d="M311.912,-1030.56C321.246,-1058.32 347.354,-1126.03 391,-1165.16 394.948,-1168.69 399.582,-1171.7 404.398,-1174.24"/>
<polygon fill="#000000" stroke="#000000" points="403.204,-1177.54 413.75,-1178.55 406.134,-1171.18 403.204,-1177.54"/>
</g>
<!-- listdl -->
<g id="proc~~dhscf~~CallsGraph_node65" class="node"><title>listdl</title>
<polygon fill="#777777" stroke="#777777" points="468,-542.156 414,-542.156 414,-518.156 468,-518.156 468,-542.156"/>
<text text-anchor="middle" x="441" y="-527.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">listdl</text>
</g>
<!-- proc~dfscf&#45;&gt;listdl -->
<g id="proc~~dhscf~~CallsGraph_edge71" class="edge"><title>proc~dfscf&#45;&gt;listdl</title>
<path fill="none" stroke="#000000" d="M313.218,-1005.95C323.084,-982.336 344.429,-928.521 355,-881.156 371.068,-809.158 347.107,-610.444 391,-551.156 394.563,-546.343 399.455,-542.621 404.777,-539.747"/>
<polygon fill="#000000" stroke="#000000" points="406.257,-542.919 413.98,-535.666 403.42,-536.52 406.257,-542.919"/>
</g>
<!-- proc~reord&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge72" class="edge"><title>proc~reord&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M594.603,-1468.17C615.205,-1481.13 648.202,-1501.89 671.683,-1516.66"/>
<polygon fill="#000000" stroke="#000000" points="669.843,-1519.63 680.171,-1522 673.57,-1513.71 669.843,-1519.63"/>
</g>
<!-- proc~reord&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge74" class="edge"><title>proc~reord&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M601.505,-1447.03C609.293,-1443.04 617.066,-1437.54 622,-1430.16 659.927,-1373.42 649.877,-1192.92 658,-1125.16 672.413,-1004.92 690.071,-860.882 696.759,-806.449"/>
<polygon fill="#000000" stroke="#000000" points="700.268,-806.587 698.014,-796.235 693.32,-805.733 700.268,-806.587"/>
</g>
<!-- proc~reord&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge73" class="edge"><title>proc~reord&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M601.871,-1446.7C609.489,-1442.72 617.068,-1437.32 622,-1430.16 684.678,-1339.15 606.255,-1281.79 658,-1184.16 661.86,-1176.87 667.684,-1170.26 673.757,-1164.67"/>
<polygon fill="#000000" stroke="#000000" points="676.078,-1167.29 681.455,-1158.16 671.559,-1161.95 676.078,-1167.29"/>
</g>
<!-- proc~distmeshdata_rea -->
<g id="proc~~dhscf~~CallsGraph_node53" class="node"><title>proc~distmeshdata_rea</title>
<g id="a_proc~~dhscf~~CallsGraph_node53"><a xlink:href=".././proc/distmeshdata_rea.html" xlink:title="distMeshData_rea">
<polygon fill="#d9534f" stroke="#d9534f" points="491,-1548.16 391,-1548.16 391,-1524.16 491,-1524.16 491,-1548.16"/>
<text text-anchor="middle" x="441" y="-1533.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData_rea</text>
</a>
</g>
</g>
<!-- interface~distmeshdata&#45;&gt;proc~distmeshdata_rea -->
<g id="proc~~dhscf~~CallsGraph_edge75" class="edge"><title>interface~distmeshdata&#45;&gt;proc~distmeshdata_rea</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M346.18,-1551.08C356.898,-1549.38 368.814,-1547.48 380.46,-1545.63"/>
<polygon fill="#000000" stroke="#000000" points="381.261,-1549.04 390.587,-1544.02 380.161,-1542.13 381.261,-1549.04"/>
</g>
<!-- proc~distmeshdata_int -->
<g id="proc~~dhscf~~CallsGraph_node62" class="node"><title>proc~distmeshdata_int</title>
<g id="a_proc~~dhscf~~CallsGraph_node62"><a xlink:href=".././proc/distmeshdata_int.html" xlink:title="distMeshData_int">
<polygon fill="#d9534f" stroke="#d9534f" points="622,-1666.16 527,-1666.16 527,-1642.16 622,-1642.16 622,-1666.16"/>
<text text-anchor="middle" x="574.5" y="-1651.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData_int</text>
</a>
</g>
</g>
<!-- interface~distmeshdata&#45;&gt;proc~distmeshdata_int -->
<g id="proc~~dhscf~~CallsGraph_edge76" class="edge"><title>interface~distmeshdata&#45;&gt;proc~distmeshdata_int</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M341.089,-1569.24C389.116,-1586.79 478.154,-1619.32 530.987,-1638.62"/>
<polygon fill="#000000" stroke="#000000" points="529.818,-1641.92 540.412,-1642.07 532.22,-1635.35 529.818,-1641.92"/>
</g>
<!-- proc~vmat&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge81" class="edge"><title>proc~vmat&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M308.973,-644.027C312.503,-609.124 327.988,-508.304 391,-467.156 428.213,-442.855 458.608,-436.725 491,-467.156 537.736,-511.062 512.612,-980.666 527,-1043.16 551.907,-1151.34 584.987,-1169.5 622,-1274.16 652.758,-1361.13 681.814,-1467.2 693.769,-1512.24"/>
<polygon fill="#000000" stroke="#000000" points="690.434,-1513.32 696.369,-1522.1 697.202,-1511.53 690.434,-1513.32"/>
</g>
<!-- proc~vmat&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge84" class="edge"><title>proc~vmat&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M311.085,-643.948C325.391,-587.449 384.835,-353.875 391,-349.156 426.291,-322.139 453.39,-325.475 491,-349.156 643.346,-445.077 686.855,-686.628 696.889,-761.602"/>
<polygon fill="#000000" stroke="#000000" points="693.45,-762.308 698.18,-771.789 700.395,-761.428 693.45,-762.308"/>
</g>
<!-- proc~vmat&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge89" class="edge"><title>proc~vmat&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M308.135,-643.972C309.305,-605.189 318.819,-484.23 391,-434.156 427.518,-408.822 455.208,-407.808 491,-434.156 608.708,-520.804 681.582,-1013.42 696.603,-1124.09"/>
<polygon fill="#000000" stroke="#000000" points="693.148,-1124.66 697.945,-1134.11 700.086,-1123.73 693.148,-1124.66"/>
</g>
<!-- proc~vmat&#45;&gt;endpht -->
<g id="proc~~dhscf~~CallsGraph_edge80" class="edge"><title>proc~vmat&#45;&gt;endpht</title>
<path fill="none" stroke="#000000" d="M314.914,-668.482C327.507,-689.95 356.128,-734.459 391,-761.156 395.12,-764.31 399.785,-767.09 404.56,-769.508"/>
<polygon fill="#000000" stroke="#000000" points="403.211,-772.739 413.761,-773.715 406.122,-766.374 403.211,-772.739"/>
</g>
<!-- proc~vmat&#45;&gt;listp2 -->
<g id="proc~~dhscf~~CallsGraph_edge82" class="edge"><title>proc~vmat&#45;&gt;listp2</title>
<path fill="none" stroke="#000000" d="M334.079,-647.858C354.147,-641.473 382.102,-632.578 404.255,-625.529"/>
<polygon fill="#000000" stroke="#000000" points="405.507,-628.804 413.975,-622.436 403.385,-622.133 405.507,-628.804"/>
</g>
<!-- proc~vmat&#45;&gt;needdscfl -->
<g id="proc~~dhscf~~CallsGraph_edge83" class="edge"><title>proc~vmat&#45;&gt;needdscfl</title>
<path fill="none" stroke="#000000" d="M321.652,-644.117C337.524,-630.532 364.889,-608.352 391,-593.156 394.69,-591.008 398.64,-588.953 402.638,-587.026"/>
<polygon fill="#000000" stroke="#000000" points="404.304,-590.114 411.952,-582.781 401.401,-583.744 404.304,-590.114"/>
</g>
<!-- proc~vmat&#45;&gt;numdl -->
<g id="proc~~dhscf~~CallsGraph_edge90" class="edge"><title>proc~vmat&#45;&gt;numdl</title>
<path fill="none" stroke="#000000" d="M311.638,-668.479C320.196,-697.817 341.866,-774.21 355,-839.156 376.554,-945.737 324.606,-995.039 391,-1081.16 394.532,-1085.74 399.26,-1089.33 404.389,-1092.15"/>
<polygon fill="#000000" stroke="#000000" points="403.33,-1095.51 413.885,-1096.43 406.206,-1089.13 403.33,-1095.51"/>
</g>
<!-- matrixmtoo -->
<g id="proc~~dhscf~~CallsGraph_node45" class="node"><title>matrixmtoo</title>
<polygon fill="#777777" stroke="#777777" points="474,-382.156 408,-382.156 408,-358.156 474,-358.156 474,-382.156"/>
<text text-anchor="middle" x="441" y="-367.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">matrixmtoo</text>
</g>
<!-- proc~vmat&#45;&gt;matrixmtoo -->
<g id="proc~~dhscf~~CallsGraph_edge86" class="edge"><title>proc~vmat&#45;&gt;matrixmtoo</title>
<path fill="none" stroke="#000000" d="M310.616,-643.927C320.643,-597.94 357.735,-435.973 391,-396.156 393.6,-393.044 396.67,-390.252 399.986,-387.759"/>
<polygon fill="#000000" stroke="#000000" points="402.121,-390.546 408.605,-382.167 398.311,-384.674 402.121,-390.546"/>
</g>
<!-- phi -->
<g id="proc~~dhscf~~CallsGraph_node50" class="node"><title>phi</title>
<polygon fill="#777777" stroke="#777777" points="468,-500.156 414,-500.156 414,-476.156 468,-476.156 468,-500.156"/>
<text text-anchor="middle" x="441" y="-485.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">phi</text>
</g>
<!-- proc~vmat&#45;&gt;phi -->
<g id="proc~~dhscf~~CallsGraph_edge77" class="edge"><title>proc~vmat&#45;&gt;phi</title>
<path fill="none" stroke="#000000" d="M311.912,-643.747C321.246,-615.995 347.354,-548.282 391,-509.156 394.948,-505.617 399.582,-502.61 404.398,-500.075"/>
<polygon fill="#000000" stroke="#000000" points="406.134,-503.129 413.75,-495.764 403.204,-496.772 406.134,-503.129"/>
</g>
<!-- proc~vmat&#45;&gt;indxuo -->
<g id="proc~~dhscf~~CallsGraph_edge78" class="edge"><title>proc~vmat&#45;&gt;indxuo</title>
<path fill="none" stroke="#000000" d="M311.507,-668.507C319.78,-697.905 340.88,-774.418 355,-839.156 374.246,-927.399 334.773,-968.475 391,-1039.16 394.565,-1043.64 399.269,-1047.18 404.354,-1049.97"/>
<polygon fill="#000000" stroke="#000000" points="403.2,-1053.29 413.753,-1054.24 406.093,-1046.92 403.2,-1053.29"/>
</g>
<!-- proc~vmat&#45;&gt;listsc -->
<g id="proc~~dhscf~~CallsGraph_edge79" class="edge"><title>proc~vmat&#45;&gt;listsc</title>
<path fill="none" stroke="#000000" d="M311.14,-668.173C325.429,-722.794 383.929,-945.581 391,-959.156 398.524,-973.599 410.043,-987.71 420.023,-998.508"/>
<polygon fill="#000000" stroke="#000000" points="417.499,-1000.93 426.939,-1005.74 422.559,-996.095 417.499,-1000.93"/>
</g>
<!-- proc~vmat&#45;&gt;listdlptr -->
<g id="proc~~dhscf~~CallsGraph_edge85" class="edge"><title>proc~vmat&#45;&gt;listdlptr</title>
<path fill="none" stroke="#000000" d="M321.652,-668.194C337.524,-681.78 364.889,-703.959 391,-719.156 395.275,-721.643 399.9,-724.008 404.543,-726.191"/>
<polygon fill="#000000" stroke="#000000" points="403.433,-729.529 413.992,-730.402 406.282,-723.135 403.433,-729.529"/>
</g>
<!-- proc~vmat&#45;&gt;lstpht -->
<g id="proc~~dhscf~~CallsGraph_edge87" class="edge"><title>proc~vmat&#45;&gt;lstpht</title>
<path fill="none" stroke="#000000" d="M334.079,-664.453C354.147,-670.839 382.102,-679.734 404.255,-686.782"/>
<polygon fill="#000000" stroke="#000000" points="403.385,-690.178 413.975,-689.875 405.507,-683.508 403.385,-690.178"/>
</g>
<!-- proc~vmat&#45;&gt;globaltolocalorb -->
<g id="proc~~dhscf~~CallsGraph_edge88" class="edge"><title>proc~vmat&#45;&gt;globaltolocalorb</title>
<path fill="none" stroke="#000000" d="M334.079,-656.156C349.097,-656.156 368.532,-656.156 386.647,-656.156"/>
<polygon fill="#000000" stroke="#000000" points="386.827,-659.656 396.827,-656.156 386.827,-652.656 386.827,-659.656"/>
</g>
<!-- proc~vmat&#45;&gt;proc~rcut -->
<g id="proc~~dhscf~~CallsGraph_edge91" class="edge"><title>proc~vmat&#45;&gt;proc~rcut</title>
<path fill="none" stroke="#000000" d="M313.672,-668.273C334.066,-711.842 403.845,-860.915 429.996,-916.783"/>
<polygon fill="#000000" stroke="#000000" points="426.94,-918.51 434.349,-926.084 433.28,-915.543 426.94,-918.51"/>
</g>
<!-- proc~vmat&#45;&gt;listdl -->
<g id="proc~~dhscf~~CallsGraph_edge92" class="edge"><title>proc~vmat&#45;&gt;listdl</title>
<path fill="none" stroke="#000000" d="M314.914,-643.83C327.507,-622.361 356.128,-577.852 391,-551.156 395.12,-548.001 399.785,-545.222 404.56,-542.804"/>
<polygon fill="#000000" stroke="#000000" points="406.122,-545.938 413.761,-538.596 403.211,-539.572 406.122,-545.938"/>
</g>
<!-- proc~rhoofd&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge97" class="edge"><title>proc~rhoofd&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M315.184,-872.228C327.982,-892.783 356.636,-934.72 391,-959.156 429.748,-986.708 461.533,-959.843 491,-997.156 567.942,-1094.58 460.96,-1169.03 527,-1274.16 553.82,-1316.85 590.186,-1297.04 622,-1336.16 666.072,-1390.34 687.333,-1472.59 695.427,-1511.82"/>
<polygon fill="#000000" stroke="#000000" points="692.003,-1512.55 697.368,-1521.69 698.871,-1511.2 692.003,-1512.55"/>
</g>
<!-- proc~rhoofd&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge108" class="edge"><title>proc~rhoofd&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M334.364,-863.034C396.675,-871.391 552.967,-901.769 622,-1001.16 665.067,-1063.16 620.392,-1101.7 658,-1167.16 662.106,-1174.3 668.014,-1180.87 674.089,-1186.46"/>
<polygon fill="#000000" stroke="#000000" points="671.87,-1189.16 681.752,-1192.98 676.409,-1183.83 671.87,-1189.16"/>
</g>
<!-- proc~rhoofd&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge100" class="edge"><title>proc~rhoofd&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M334.122,-853.103C375.007,-842.257 456.717,-821.358 527,-808.156 573.725,-799.378 628.127,-792.329 663.149,-788.197"/>
<polygon fill="#000000" stroke="#000000" points="663.837,-791.64 673.366,-787.009 663.028,-784.687 663.837,-791.64"/>
</g>
<!-- proc~rhoofd&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge105" class="edge"><title>proc~rhoofd&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M334.243,-858.494C401.57,-854.788 578.203,-848.758 622,-884.156 660.044,-914.904 687.092,-1066.17 696.167,-1123.8"/>
<polygon fill="#000000" stroke="#000000" points="692.759,-1124.66 697.741,-1134.02 699.677,-1123.6 692.759,-1124.66"/>
</g>
<!-- proc~rhoofd&#45;&gt;endpht -->
<g id="proc~~dhscf~~CallsGraph_edge96" class="edge"><title>proc~rhoofd&#45;&gt;endpht</title>
<path fill="none" stroke="#000000" d="M326.556,-847.995C343.224,-837.2 368.471,-821.167 391,-808.156 396.236,-805.132 401.85,-802.027 407.343,-799.064"/>
<polygon fill="#000000" stroke="#000000" points="409.203,-802.039 416.384,-794.248 405.912,-795.86 409.203,-802.039"/>
</g>
<!-- proc~rhoofd&#45;&gt;listp2 -->
<g id="proc~~dhscf~~CallsGraph_edge98" class="edge"><title>proc~rhoofd&#45;&gt;listp2</title>
<path fill="none" stroke="#000000" d="M309.155,-847.911C313.264,-810.929 330.356,-699.005 391,-635.156 394.864,-631.087 399.646,-627.768 404.694,-625.071"/>
<polygon fill="#000000" stroke="#000000" points="406.281,-628.195 413.929,-620.862 403.378,-621.825 406.281,-628.195"/>
</g>
<!-- proc~rhoofd&#45;&gt;needdscfl -->
<g id="proc~~dhscf~~CallsGraph_edge99" class="edge"><title>proc~rhoofd&#45;&gt;needdscfl</title>
<path fill="none" stroke="#000000" d="M311.135,-848.003C324.012,-798.421 373.001,-613.121 391,-593.156 394.312,-589.482 398.376,-586.427 402.734,-583.893"/>
<polygon fill="#000000" stroke="#000000" points="404.499,-586.926 411.946,-579.39 401.425,-580.637 404.499,-586.926"/>
</g>
<!-- proc~rhoofd&#45;&gt;numdl -->
<g id="proc~~dhscf~~CallsGraph_edge106" class="edge"><title>proc~rhoofd&#45;&gt;numdl</title>
<path fill="none" stroke="#000000" d="M312.215,-872.162C328.018,-917.077 383.25,-1073.04 391,-1081.16 394.876,-1085.21 399.664,-1088.53 404.715,-1091.22"/>
<polygon fill="#000000" stroke="#000000" points="403.4,-1094.47 413.951,-1095.43 406.302,-1088.1 403.4,-1094.47"/>
</g>
<!-- proc~rhoofd&#45;&gt;phi -->
<g id="proc~~dhscf~~CallsGraph_edge93" class="edge"><title>proc~rhoofd&#45;&gt;phi</title>
<path fill="none" stroke="#000000" d="M311.364,-847.772C319.33,-818.304 339.814,-741.652 355,-677.156 372.501,-602.827 342.481,-568.122 391,-509.156 394.639,-504.733 399.381,-501.222 404.481,-498.44"/>
<polygon fill="#000000" stroke="#000000" points="406.221,-501.494 413.885,-494.179 403.332,-495.118 406.221,-501.494"/>
</g>
<!-- proc~rhoofd&#45;&gt;indxuo -->
<g id="proc~~dhscf~~CallsGraph_edge94" class="edge"><title>proc~rhoofd&#45;&gt;indxuo</title>
<path fill="none" stroke="#000000" d="M310.469,-872.347C317.481,-904.046 340.378,-989.995 391,-1039.16 394.984,-1043.02 399.792,-1046.23 404.819,-1048.88"/>
<polygon fill="#000000" stroke="#000000" points="403.423,-1052.09 413.973,-1053.05 406.327,-1045.72 403.423,-1052.09"/>
</g>
<!-- proc~rhoofd&#45;&gt;listsc -->
<g id="proc~~dhscf~~CallsGraph_edge95" class="edge"><title>proc~rhoofd&#45;&gt;listsc</title>
<path fill="none" stroke="#000000" d="M312.968,-872.174C323.841,-897.257 351.931,-955.857 391,-992.156 395.145,-996.007 399.968,-999.459 404.94,-1002.49"/>
<polygon fill="#000000" stroke="#000000" points="403.495,-1005.7 413.935,-1007.5 406.899,-999.579 403.495,-1005.7"/>
</g>
<!-- proc~rhoofd&#45;&gt;listdlptr -->
<g id="proc~~dhscf~~CallsGraph_edge101" class="edge"><title>proc~rhoofd&#45;&gt;listdlptr</title>
<path fill="none" stroke="#000000" d="M315.501,-847.908C328.564,-827.464 357.333,-786.169 391,-761.156 395.165,-758.061 399.856,-755.315 404.642,-752.913"/>
<polygon fill="#000000" stroke="#000000" points="406.203,-756.048 413.852,-748.716 403.301,-749.678 406.203,-756.048"/>
</g>
<!-- proc~rhoofd&#45;&gt;lstpht -->
<g id="proc~~dhscf~~CallsGraph_edge103" class="edge"><title>proc~rhoofd&#45;&gt;lstpht</title>
<path fill="none" stroke="#000000" d="M312.202,-847.853C321.952,-820.989 348.571,-756.506 391,-719.156 394.979,-715.653 399.631,-712.666 404.455,-710.14"/>
<polygon fill="#000000" stroke="#000000" points="406.191,-713.194 413.813,-705.835 403.265,-706.834 406.191,-713.194"/>
</g>
<!-- proc~rhoofd&#45;&gt;globaltolocalorb -->
<g id="proc~~dhscf~~CallsGraph_edge104" class="edge"><title>proc~rhoofd&#45;&gt;globaltolocalorb</title>
<path fill="none" stroke="#000000" d="M310.386,-847.694C317.199,-815.294 339.655,-727.438 391,-677.156 392.227,-675.954 393.535,-674.815 394.903,-673.738"/>
<polygon fill="#000000" stroke="#000000" points="396.864,-676.638 403.291,-668.215 393.014,-670.792 396.864,-676.638"/>
</g>
<!-- proc~rhoofd&#45;&gt;matrixotom -->
<g id="proc~~dhscf~~CallsGraph_edge102" class="edge"><title>proc~rhoofd&#45;&gt;matrixotom</title>
<path fill="none" stroke="#000000" d="M312.362,-872.181C320.927,-895.937 340.379,-950.616 355,-997.156 372.456,-1052.72 352.505,-1079.45 391,-1123.16 393.334,-1125.81 396.061,-1128.13 399.012,-1130.17"/>
<polygon fill="#000000" stroke="#000000" points="397.363,-1133.26 407.78,-1135.2 400.844,-1127.19 397.363,-1133.26"/>
</g>
<!-- proc~rhoofd&#45;&gt;proc~rcut -->
<g id="proc~~dhscf~~CallsGraph_edge107" class="edge"><title>proc~rhoofd&#45;&gt;proc~rcut</title>
<path fill="none" stroke="#000000" d="M326.556,-872.316C343.224,-883.111 368.471,-899.144 391,-912.156 396.236,-915.179 401.85,-918.284 407.343,-921.248"/>
<polygon fill="#000000" stroke="#000000" points="405.912,-924.451 416.384,-926.063 409.203,-918.273 405.912,-924.451"/>
</g>
<!-- proc~rhoofd&#45;&gt;dscfl -->
<g id="proc~~dhscf~~CallsGraph_edge109" class="edge"><title>proc~rhoofd&#45;&gt;dscfl</title>
<path fill="none" stroke="#000000" d="M312.78,-872.467C321.897,-896.272 342.018,-950.393 355,-997.156 375.426,-1070.73 342.481,-1106.19 391,-1165.16 394.639,-1169.58 399.381,-1173.09 404.481,-1175.87"/>
<polygon fill="#000000" stroke="#000000" points="403.332,-1179.19 413.885,-1180.13 406.221,-1172.82 403.332,-1179.19"/>
</g>
<!-- proc~rhoofd&#45;&gt;listdl -->
<g id="proc~~dhscf~~CallsGraph_edge110" class="edge"><title>proc~rhoofd&#45;&gt;listdl</title>
<path fill="none" stroke="#000000" d="M311.131,-847.919C325.645,-791.28 385.884,-557.058 391,-551.156 394.713,-546.872 399.454,-543.436 404.519,-540.687"/>
<polygon fill="#000000" stroke="#000000" points="406.182,-543.776 413.833,-536.447 403.282,-537.405 406.182,-543.776"/>
</g>
<!-- proc~write_rho&#45;&gt;mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_edge114" class="edge"><title>proc~write_rho&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M445.785,-157.42C455.316,-188.896 480.301,-275.257 491,-349.156 535.254,-654.828 497.615,-735.698 527,-1043.16 538.251,-1160.88 560.816,-1300.82 569.742,-1354.09"/>
<polygon fill="#000000" stroke="#000000" points="566.316,-1354.83 571.43,-1364.1 573.218,-1353.66 566.316,-1354.83"/>
</g>
<!-- proc~write_rho&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge115" class="edge"><title>proc~write_rho&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M469.648,-148.581C515.181,-154.835 602.829,-169.665 622,-193.156 665.068,-245.93 651.882,-737.313 658,-805.156 668.876,-925.766 688.608,-1069.58 696.305,-1123.91"/>
<polygon fill="#000000" stroke="#000000" points="692.882,-1124.7 697.757,-1134.1 699.812,-1123.71 692.882,-1124.7"/>
</g>
<!-- proc~write_rho&#45;&gt;write_debug -->
<g id="proc~~dhscf~~CallsGraph_edge116" class="edge"><title>proc~write_rho&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M464.906,-157.175C486.083,-168.287 517.764,-184.91 541.449,-197.338"/>
<polygon fill="#000000" stroke="#000000" points="539.934,-200.496 550.416,-202.043 543.187,-194.297 539.934,-200.496"/>
</g>
<!-- mpi_wait -->
<g id="proc~~dhscf~~CallsGraph_node43" class="node"><title>mpi_wait</title>
<polygon fill="#777777" stroke="#777777" points="602,-146.156 547,-146.156 547,-122.156 602,-122.156 602,-146.156"/>
<text text-anchor="middle" x="574.5" y="-131.756" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_wait</text>
</g>
<!-- proc~write_rho&#45;&gt;mpi_wait -->
<g id="proc~~dhscf~~CallsGraph_edge113" class="edge"><title>proc~write_rho&#45;&gt;mpi_wait</title>
<path fill="none" stroke="#000000" d="M469.567,-142.85C489.113,-141.215 515.548,-139.003 536.866,-137.22"/>
<polygon fill="#000000" stroke="#000000" points="537.195,-140.705 546.868,-136.383 536.611,-133.729 537.195,-140.705"/>
</g>
<!-- proc~write_rho&#45;&gt;io_close -->
<g id="proc~~dhscf~~CallsGraph_edge111" class="edge"><title>proc~write_rho&#45;&gt;io_close</title>
<path fill="none" stroke="#000000" d="M451.072,-133.019C465.075,-115.422 493.833,-83.5702 527,-71.1556 566.543,-56.3544 588.885,-44.9623 622,-71.1556 750.762,-173.003 801.475,-734.979 810.848,-854.003"/>
<polygon fill="#000000" stroke="#000000" points="807.369,-854.407 811.627,-864.108 814.348,-853.869 807.369,-854.407"/>
</g>
<!-- proc~write_rho&#45;&gt;io_assign -->
<g id="proc~~dhscf~~CallsGraph_edge112" class="edge"><title>proc~write_rho&#45;&gt;io_assign</title>
<path fill="none" stroke="#000000" d="M447.249,-132.888C458.11,-109.295 485.551,-58.1644 527,-38.1556 613.454,3.57875 666.966,20.4522 743,-38.1556 781.791,-68.0565 803.247,-221.753 810.075,-279.864"/>
<polygon fill="#000000" stroke="#000000" points="806.603,-280.311 811.213,-289.85 813.558,-279.518 806.603,-280.311"/>
</g>
<!-- mpi_irecv -->
<g id="proc~~dhscf~~CallsGraph_node49" class="node"><title>mpi_irecv</title>
<polygon fill="#777777" stroke="#777777" points="603.5,-104.156 545.5,-104.156 545.5,-80.1556 603.5,-80.1556 603.5,-104.156"/>
<text text-anchor="middle" x="574.5" y="-89.7556" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_irecv</text>
</g>
<!-- proc~write_rho&#45;&gt;mpi_irecv -->
<g id="proc~~dhscf~~CallsGraph_edge117" class="edge"><title>proc~write_rho&#45;&gt;mpi_irecv</title>
<path fill="none" stroke="#000000" d="M469.567,-134.045C488.768,-126.306 514.618,-115.888 535.733,-107.377"/>
<polygon fill="#000000" stroke="#000000" points="537.095,-110.602 545.061,-103.618 534.478,-104.11 537.095,-110.602"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge121" class="edge"><title>proc~distmeshdata_rea&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M445.098,-1548.37C453.051,-1576.82 477.16,-1647.21 527,-1675.16 563.829,-1695.8 585.658,-1696.65 622,-1675.16 644.539,-1661.82 675.634,-1592.39 690.663,-1556.18"/>
<polygon fill="#000000" stroke="#000000" points="694.07,-1557.1 694.62,-1546.51 687.592,-1554.44 694.07,-1557.1"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_edge123" class="edge"><title>proc~distmeshdata_rea&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M452.453,-1523.89C462.879,-1511.35 479.027,-1491.08 491,-1472.16 509.708,-1442.59 502.697,-1427.32 527,-1402.16 529.964,-1399.09 533.369,-1396.28 536.96,-1393.74"/>
<polygon fill="#000000" stroke="#000000" points="538.979,-1396.6 545.558,-1388.3 535.236,-1390.69 538.979,-1396.6"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge126" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M491.319,-1542.79C531.418,-1545.29 586.91,-1541.73 622,-1510.16 664.623,-1471.8 689.452,-1291.3 697.012,-1227.54"/>
<polygon fill="#000000" stroke="#000000" points="700.516,-1227.7 698.187,-1217.37 693.562,-1226.9 700.516,-1227.7"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~reord -->
<g id="proc~~dhscf~~CallsGraph_edge120" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~reord</title>
<path fill="none" stroke="#000000" d="M466.651,-1524.14C474.592,-1519.99 483.32,-1515.13 491,-1510.16 508.016,-1499.14 510.106,-1493.36 527,-1482.16 531.625,-1479.09 536.637,-1476.03 541.6,-1473.15"/>
<polygon fill="#000000" stroke="#000000" points="543.404,-1476.15 550.385,-1468.18 539.958,-1470.06 543.404,-1476.15"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge122" class="edge"><title>proc~distmeshdata_rea&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M451.094,-1523.91C469.051,-1500 508.89,-1448.25 527,-1435.16 563.855,-1408.52 594.19,-1433.14 622,-1397.16 624.324,-1394.15 683.314,-915.698 696.781,-806.269"/>
<polygon fill="#000000" stroke="#000000" points="700.255,-806.687 698.003,-796.335 693.308,-805.832 700.255,-806.687"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge124" class="edge"><title>proc~distmeshdata_rea&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M480.423,-1524.12C532.591,-1507.71 619.663,-1480 622,-1477.16 705.328,-1375.81 597.9,-1300.78 658,-1184.16 661.63,-1177.11 667.127,-1170.71 672.943,-1165.26"/>
<polygon fill="#000000" stroke="#000000" points="675.596,-1167.6 680.927,-1158.44 671.05,-1162.28 675.596,-1167.6"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;write_debug -->
<g id="proc~~dhscf~~CallsGraph_edge125" class="edge"><title>proc~distmeshdata_rea&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M446.458,-1523.77C456.368,-1495.65 480.201,-1424.65 491,-1363.16 511.186,-1248.21 563.149,-387.638 572.159,-236.715"/>
<polygon fill="#000000" stroke="#000000" points="575.673,-236.581 572.774,-226.39 568.685,-236.164 575.673,-236.581"/>
</g>
<!-- mpitrace_event -->
<g id="proc~~dhscf~~CallsGraph_node66" class="node"><title>mpitrace_event</title>
<polygon fill="#777777" stroke="#777777" points="617.5,-1586.16 531.5,-1586.16 531.5,-1562.16 617.5,-1562.16 617.5,-1586.16"/>
<text text-anchor="middle" x="574.5" y="-1571.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpitrace_event</text>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;mpitrace_event -->
<g id="proc~~dhscf~~CallsGraph_edge118" class="edge"><title>proc~distmeshdata_rea&#45;&gt;mpitrace_event</title>
<path fill="none" stroke="#000000" d="M483.607,-1548.18C495.719,-1551.68 509.101,-1555.55 521.756,-1559.2"/>
<polygon fill="#000000" stroke="#000000" points="521.133,-1562.67 531.712,-1562.08 523.077,-1555.94 521.133,-1562.67"/>
</g>
<!-- proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_node67" class="node"><title>proc~boxintersection</title>
<g id="a_proc~~dhscf~~CallsGraph_node67"><a xlink:href=".././proc/boxintersection.html" xlink:title="boxIntersection">
<polygon fill="#d9534f" stroke="#d9534f" points="743,-1666.16 658,-1666.16 658,-1642.16 743,-1642.16 743,-1666.16"/>
<text text-anchor="middle" x="700.5" y="-1651.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">boxIntersection</text>
</a>
</g>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_edge119" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~boxintersection</title>
<path fill="none" stroke="#000000" d="M444.105,-1548.26C450.267,-1579.51 471.465,-1662.77 527,-1696.16 563.188,-1717.91 581.241,-1707.17 622,-1696.16 639.881,-1691.32 641.729,-1684.01 658,-1675.16 660.527,-1673.78 663.154,-1672.38 665.805,-1670.99"/>
<polygon fill="#000000" stroke="#000000" points="667.515,-1674.05 674.796,-1666.35 664.305,-1667.83 667.515,-1674.05"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge127" class="edge"><title>proc~distmeshdata_int&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M601.221,-1642C608.304,-1638.07 615.752,-1633.37 622,-1628.16 648.025,-1606.43 671.842,-1575.06 686.013,-1554.64"/>
<polygon fill="#000000" stroke="#000000" points="688.915,-1556.6 691.647,-1546.36 683.128,-1552.66 688.915,-1556.6"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge130" class="edge"><title>proc~distmeshdata_int&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M606.072,-1642.15C612.149,-1638.49 617.909,-1633.87 622,-1628.16 645.728,-1595 685.396,-1310.4 696.52,-1227.64"/>
<polygon fill="#000000" stroke="#000000" points="700.012,-1227.93 697.868,-1217.55 693.074,-1227 700.012,-1227.93"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge129" class="edge"><title>proc~distmeshdata_int&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M606.982,-1642.15C612.855,-1638.52 618.301,-1633.91 622,-1628.16 675.496,-1544.87 614.484,-1273.07 658,-1184.16 661.484,-1177.04 666.927,-1170.61 672.738,-1165.16"/>
<polygon fill="#000000" stroke="#000000" points="675.393,-1167.5 680.741,-1158.35 670.857,-1162.17 675.393,-1167.5"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_edge128" class="edge"><title>proc~distmeshdata_int&#45;&gt;proc~boxintersection</title>
<path fill="none" stroke="#000000" d="M622.026,-1654.16C630.331,-1654.16 639.033,-1654.16 647.481,-1654.16"/>
<polygon fill="#000000" stroke="#000000" points="647.615,-1657.66 657.615,-1654.16 647.615,-1650.66 647.615,-1657.66"/>
</g>
<!-- proc~chk -->
<g id="proc~~dhscf~~CallsGraph_node68" class="node"><title>proc~chk</title>
<g id="a_proc~~dhscf~~CallsGraph_node68"><a xlink:href=".././proc/chk.html" xlink:title="chk">
<polygon fill="#d9534f" stroke="#d9534f" points="601.5,-1034.16 547.5,-1034.16 547.5,-1010.16 601.5,-1010.16 601.5,-1034.16"/>
<text text-anchor="middle" x="574.5" y="-1019.76" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">chk</text>
</a>
</g>
</g>
<!-- proc~rcut&#45;&gt;proc~chk -->
<g id="proc~~dhscf~~CallsGraph_edge131" class="edge"><title>proc~rcut&#45;&gt;proc~chk</title>
<path fill="none" stroke="#000000" d="M466.261,-950.263C474.259,-954.456 483.12,-959.321 491,-964.156 511.147,-976.516 532.988,-991.969 549.133,-1003.82"/>
<polygon fill="#000000" stroke="#000000" points="547.349,-1006.85 557.47,-1009.98 551.513,-1001.22 547.349,-1006.85"/>
</g>
<!-- proc~chk&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge132" class="edge"><title>proc~chk&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M580.778,-1034.21C592.444,-1060.1 622.238,-1122.33 658,-1167.16 663.397,-1173.92 670.029,-1180.56 676.394,-1186.34"/>
<polygon fill="#000000" stroke="#000000" points="674.367,-1189.21 684.202,-1193.15 678.97,-1183.94 674.367,-1189.21"/>
</g>
</g>
</svg>
</div><script>var panprocdhscfCallsGraph = svgPanZoom('#procdhscfCallsGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
     
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Called by</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~CalledByGraph Pages: 1 -->
<svg id="procdhscfCalledByGraph" width="310pt" height="74pt"
 viewBox="0.00 0.00 310.00 74.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 70)">
<title>proc~~dhscf~~CalledByGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-70 306,-70 306,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="302,-45 248,-45 248,-21 302,-21 302,-45"/>
<text text-anchor="middle" x="275" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- proc~siesta_analysis -->
<g id="proc~~dhscf~~CalledByGraph_node2" class="node"><title>proc~siesta_analysis</title>
<g id="a_proc~~dhscf~~CalledByGraph_node2"><a xlink:href=".././proc/siesta_analysis.html" xlink:title="siesta_analysis">
<polygon fill="#d9534f" stroke="#d9534f" points="204.5,-66 119.5,-66 119.5,-42 204.5,-42 204.5,-66"/>
<text text-anchor="middle" x="162" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_analysis</text>
</a>
</g>
</g>
<!-- proc~siesta_analysis&#45;&gt;proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_edge1" class="edge"><title>proc~siesta_analysis&#45;&gt;proc~dhscf</title>
<path fill="none" stroke="#000000" d="M204.648,-46.1206C215.65,-44.0392 227.428,-41.811 238.097,-39.7925"/>
<polygon fill="#000000" stroke="#000000" points="238.75,-43.2311 247.925,-37.9331 237.449,-36.3531 238.75,-43.2311"/>
</g>
<!-- proc~setup_hamiltonian -->
<g id="proc~~dhscf~~CalledByGraph_node3" class="node"><title>proc~setup_hamiltonian</title>
<g id="a_proc~~dhscf~~CalledByGraph_node3"><a xlink:href=".././proc/setup_hamiltonian.html" xlink:title="setup_hamiltonian">
<polygon fill="#d9534f" stroke="#d9534f" points="212,-24 112,-24 112,-0 212,-0 212,-24"/>
<text text-anchor="middle" x="162" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">setup_hamiltonian</text>
</a>
</g>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_edge2" class="edge"><title>proc~setup_hamiltonian&#45;&gt;proc~dhscf</title>
<path fill="none" stroke="#000000" d="M212.009,-21.272C220.666,-22.9099 229.537,-24.5881 237.763,-26.1444"/>
<polygon fill="#000000" stroke="#000000" points="237.297,-29.6183 247.774,-28.0383 238.599,-22.7403 237.297,-29.6183"/>
</g>
<!-- proc~siesta_forces -->
<g id="proc~~dhscf~~CalledByGraph_node4" class="node"><title>proc~siesta_forces</title>
<g id="a_proc~~dhscf~~CalledByGraph_node4"><a xlink:href=".././proc/siesta_forces.html" xlink:title="siesta_forces">
<polygon fill="#d9534f" stroke="#d9534f" points="76,-24 0,-24 0,-0 76,-0 76,-24"/>
<text text-anchor="middle" x="38" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_forces</text>
</a>
</g>
</g>
<!-- proc~siesta_forces&#45;&gt;proc~setup_hamiltonian -->
<g id="proc~~dhscf~~CalledByGraph_edge3" class="edge"><title>proc~siesta_forces&#45;&gt;proc~setup_hamiltonian</title>
<path fill="none" stroke="#000000" d="M76.2669,-12C84.3255,-12 93.0387,-12 101.706,-12"/>
<polygon fill="#000000" stroke="#000000" points="101.817,-15.5001 111.817,-12 101.817,-8.5001 101.817,-15.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/dhscf.html#src">dhscf</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>      <span class="k">subroutine </span><span class="n">dhscf</span><span class="p">(</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> 
     <span class="p">&amp;</span>                  <span class="n">nuotot</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">ntm</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">iHmat</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">filesOut</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">Enaatm</span><span class="p">,</span> <span class="n">Enascf</span><span class="p">,</span> <span class="n">Uatm</span><span class="p">,</span> <span class="n">Uscf</span><span class="p">,</span> <span class="n">DUscf</span><span class="p">,</span> <span class="n">DUext</span><span class="p">,</span> 
     <span class="p">&amp;</span>                  <span class="n">Exc</span><span class="p">,</span> <span class="n">Dxc</span><span class="p">,</span> <span class="n">dipol</span><span class="p">,</span> <span class="n">stress</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">use_rhog_in</span><span class="p">,</span> <span class="n">charge_density_only</span> <span class="p">)</span>
<span class="c">!! author: J.M. Soler</span>
<span class="c">!! date: August 1996</span>
<span class="c">!!</span>
<span class="c">!! Calculates the self-consistent field contributions to Hamiltonian</span>
<span class="c">!! matrix elements, total energy and atomic forces.</span>
<span class="c">!!</span>
<span class="c">!! Coded by J.M. Soler, August 1996. July 1997.  </span>
<span class="c">!! Modified by J.D. Gale, February 2000.</span>
<span class="c">!!</span>
<span class="c">!!</span>
<span class="c">!!### Units</span>
<span class="c">!! Energies in Rydbergs.  </span>
<span class="c">!! Distances in Bohr.</span>
<span class="c">!!</span>
<span class="c">!!### Routines called internally</span>
<span class="c">!! * [[cellxc(proc)]]    : Finds total exch-corr energy and potential</span>
<span class="c">!! * [[cross(proc)]]   : Finds the cross product of two vectors</span>
<span class="c">!! * [[dfscf(proc)]]     : Finds SCF contribution to atomic forces</span>
<span class="c">!! * [[dipole(proc)]]    : Finds electric dipole moment</span>
<span class="c">!! * [[doping(proc)]]    : Adds a background charge for doped systems</span>
<span class="c">!! * [[write_rho(proc)]]     : Saves electron density on a file</span>
<span class="c">!! * [[poison(proc)]]    : Solves Poisson equation</span>
<span class="c">!! * [[reord(proc)]]     : Reorders electron density and potential arrays</span>
<span class="c">!! * [[rhooda(proc)]]    : Finds Harris electron density in the mesh</span>
<span class="c">!! * [[rhoofd(proc)]]    : Finds SCF electron density in the mesh</span>
<span class="c">!! * [[rhoofdsp(proc)]]  : Finds SCF electron density in the mesh for</span>
<span class="c">!!                    spiral arrangement of spins</span>
<span class="c">!! * [[timer(proc)]]     : Finds CPU times</span>
<span class="c">!! * [[vmat(proc)]]      : Finds matrix elements of SCF potential</span>
<span class="c">!! * [[vmatsp(proc)]]    : Finds matrix elements of SCF potential for</span>
<span class="c">!!                         spiral arrangement of spins</span>
<span class="c">!! * [[delk(proc)]] : Finds matrix elements of \( exp(i \vec{k} \cdot \vec{r}) \)</span>
<span class="c">!! * real*8 volcel( cell ) : Returns volume of unit cell</span>
<span class="c">!!</span>
<span class="c">!!### Internal variables and arrays</span>
<span class="c">!! * `real*8  bcell(3,3)`    : Bulk lattice vectors</span>
<span class="c">!! * `real*8  cell(3,3)`     : Auxiliary lattice vectors (same as ucell)</span>
<span class="c">!! * `real*8  const`         : Auxiliary variable (constant within a loop)</span>
<span class="c">!! * `real*8  DEc`           : Auxiliary variable to call cellxc</span>
<span class="c">!! * `real*8  DEx`           : Auxiliary variable to call cellxc</span>
<span class="c">!! * `real*8  dvol`          : Mesh-cell volume</span>
<span class="c">!! * `real*8  Ec`            : Correlation energy</span>
<span class="c">!! * `real*8  Ex`            : Exchange energy</span>
<span class="c">!! * `real*8  field(3)`      : External electric field</span>
<span class="c">!! * `integer i`             : General-purpose index</span>
<span class="c">!! * `integer ia`            : Atom index</span>
<span class="c">!! * `integer io`            : Orbital index</span>
<span class="c">!! * `integer ip`            : Point index</span>
<span class="c">!! * `integer is`            : Species index</span>
<span class="c">!! * `logical IsDiag`        : Is supercell diagonal?</span>
<span class="c">!! * `integer ispin`         : Spin index</span>
<span class="c">!! * `integer j`             : General-purpose index</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!! * `integer JDGdistr`      : J.D.Gale&#39;s parallel distribution of mesh points</span>
<span class="c">!! * `integer myBox(2,3)`    : My processor&#39;s mesh box</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
<span class="c">!! * `integer nbcell`        : Number of independent bulk lattice vectors</span>
<span class="c">!! * `integer npcc`          : Partial core corrections? (0=no, 1=yes)</span>
<span class="c">!! * `integer nsd`           : Number of diagonal spin values (1 or 2)</span>
<span class="c">!! * `integer ntpl`          : Number of mesh Total Points in unit cell</span>
<span class="c">!!                           (including subpoints) locally</span>
<span class="c">!! * `real*4  rhoatm(ntpl)`  : Harris electron density</span>
<span class="c">!! * `real*4  rhopcc(ntpl)`  : Partial-core-correction density for xc</span>
<span class="c">!! * `real*4  DRho(ntpl)`    : Selfconsistent electron density difference</span>
<span class="c">!! * `real*8  rhotot`        : Total density at one point</span>
<span class="c">!! * `real*8  rmax`          : Maximum orbital radius</span>
<span class="c">!! * `real*8  scell(3,3)`    : Supercell vectors</span>
<span class="c">!! * `character shape*10`    : Name of system shape</span>
<span class="c">!! * `real*4  Vaux(ntpl)`    : Auxiliary potential array</span>
<span class="c">!! * `real*4  Vna(ntpl)`     : Sum of neutral-atom potentials</span>
<span class="c">!! * `real*8  volume`        : Unit cell volume</span>
<span class="c">!! * `real*4  Vscf(ntpl)`    : Hartree potential of selfconsistent density</span>
<span class="c">!! * `real*8  x0(3)`         : Center of molecule</span>
<span class="c">!! * `logical harrisfun`     : Harris functional or Kohn-Sham?</span>

      <span class="k">use </span><span class="nb">precision</span><span class="p">,</span>     <span class="n">only</span>  <span class="p">:</span> <span class="n">dp</span><span class="p">,</span> <span class="n">grid_p</span>
<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ProcessorY</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>

<span class="c">!     Number of Mesh divisions of each cell vector (global)</span>
<span class="c">!     The status of this variable is confusing</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Nodes</span>
      <span class="k">use </span><span class="n">atmfuncs</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">rcut</span><span class="p">,</span> <span class="n">rcore</span>
      <span class="k">use </span><span class="n">units</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">Debye</span><span class="p">,</span> <span class="n">eV</span><span class="p">,</span> <span class="n">Ang</span>
      <span class="k">use </span><span class="n">fdf</span>
      <span class="k">use </span><span class="n">sys</span><span class="p">,</span>           <span class="n">only</span>  <span class="p">:</span> <span class="n">die</span><span class="p">,</span> <span class="n">bye</span>
      <span class="k">use </span><span class="n">mesh</span><span class="p">,</span>          <span class="n">only</span>  <span class="p">:</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span>
      <span class="k">use </span><span class="n">parsing</span>
      <span class="k">use </span><span class="n">m_iorho</span><span class="p">,</span>       <span class="n">only</span>  <span class="p">:</span> <span class="n">write_rho</span>
      <span class="k">use </span><span class="n">m_forhar</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">forhar</span>
      <span class="k">use </span><span class="n">alloc</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">re_alloc</span><span class="p">,</span> <span class="n">de_alloc</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">slabel</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">filesOut_t</span> <span class="c">! derived type for output file names</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">harrisfun</span><span class="p">,</span> <span class="n">save_initial_charge_density</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">analyze_charge_density_only</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">LocalChargeOnMesh</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">PartialCoreOnMesh</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">NeutralAtomOnMesh</span>

      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">setMeshDistr</span><span class="p">,</span> <span class="n">distMeshData</span>
      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">LINEAR</span>
      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">TO_SEQUENTIAL</span><span class="p">,</span> <span class="n">TO_CLUSTER</span><span class="p">,</span> <span class="n">KEEP</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">compute_partial_charges</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">want_partial_charges</span>
<span class="cp">#ifndef BSC_CELLXC</span>

      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cellXC</span>       <span class="c">! Finds xc energy and potential</span>
      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myMeshBox</span>    <span class="c">! Returns my processor mesh box</span>
      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jms_setMeshDistr</span> <span class="o">=&gt;</span> <span class="n">setMeshDistr</span>
                                        <span class="c">! Sets a distribution of mesh</span>
                                        <span class="c">! points over parallel processors</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">use </span><span class="n">m_vmat</span><span class="p">,</span>  <span class="n">only</span>  <span class="p">:</span> <span class="n">vmat</span>
      <span class="k">use </span><span class="n">m_rhoofd</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">rhoofd</span>
<span class="cp">#ifdef MPI</span>
      <span class="k">use </span><span class="n">mpi_siesta</span>
<span class="cp">#endif</span>
      <span class="k">use </span><span class="n">iogrid_netcdf</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_grid_netcdf</span>
      <span class="k">use </span><span class="n">iogrid_netcdf</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_grid_netcdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_charge_cdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savebader</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_deformation_charge_cdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">mix_charge</span>

      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">get_field_from_dipole</span><span class="p">,</span> <span class="n">dipole_correction</span>
      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">add_potential_from_field</span>
      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">user_specified_field</span><span class="p">,</span> <span class="n">acting_efield</span>
      <span class="k">use </span><span class="n">m_doping_uniform</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">doping_active</span><span class="p">,</span> <span class="n">doping_uniform</span>
      
      <span class="k">use </span><span class="n">m_charge_add</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">charge_add</span>
      <span class="k">use </span><span class="n">m_hartree_add</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">hartree_add</span>

<span class="cp">#ifdef NCDF_4</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_cdf</span>
      <span class="k">use </span><span class="n">m_ncdf_siesta</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">cdf_save_grid</span>
<span class="cp">#endif</span>
      <span class="k">use </span><span class="n">m_rhofft</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">rhofft</span><span class="p">,</span> <span class="n">FORWARD</span><span class="p">,</span> <span class="n">BACKWARD</span>
      <span class="k">use </span><span class="n">m_rhog</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">rhog_in</span><span class="p">,</span> <span class="n">rhog</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">spin</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">Spiral</span><span class="p">,</span> <span class="n">qSpiral</span>
      <span class="k">use </span><span class="n">m_iotddft</span><span class="p">,</span>      <span class="n">only</span><span class="p">:</span> <span class="n">write_tdrho</span>
      <span class="k">use </span><span class="n">m_ts_global_vars</span><span class="p">,</span><span class="n">only</span><span class="p">:</span> <span class="n">TSmode</span><span class="p">,</span> <span class="n">TSrun</span>
      <span class="k">use </span><span class="n">m_ts_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">IsVolt</span><span class="p">,</span> <span class="n">Elecs</span><span class="p">,</span> <span class="n">N_elec</span>
      <span class="k">use </span><span class="n">m_ts_voltage</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ts_voltage</span>
      <span class="k">use </span><span class="n">m_ts_hartree</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ts_hartree_fix</span>

      <span class="k">implicit none</span>

<span class="k">      </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nspin</span>
        <span class="c">!! Number of different spin polarisations:  </span>
        <span class="c">!! nspin=1 =&gt; Unpolarized, nspin=2 =&gt; polarized  </span>
        <span class="c">!! nspin=4 =&gt; Noncollinear spin or spin-orbit.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">norb</span>
        <span class="c">!! Total number of basis orbitals in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iaorb</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Atom to which each orbital belongs</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iphorb</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Orbital index (within atom) of each orbital</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nuo</span>
        <span class="c">!! Number of orbitals in a unit cell in this node</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nuotot</span>
        <span class="c">!! Number of orbitals in a unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nua</span>
        <span class="c">!! Number of atoms in unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">na</span>
        <span class="c">!! Number of atoms in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">isa</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Species index of all atoms in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">indxua</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Index of equivalent atom in unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ifa</span>
        <span class="c">!! Switch which fixes whether the SCF contrib:  </span>
        <span class="c">!! to atomic forces is calculated and added to fa.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istr</span>
        <span class="c">!! Switch which fixes whether the SCF contrib:  </span>
        <span class="c">!! to stress is calculated and added to stress.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iHmat</span>
        <span class="c">!! Switch which fixes whether the Hmat matrix</span>
        <span class="c">!! elements are calculated or not.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">maxnd</span>
        <span class="c">!! First dimension of listd and Dscf</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">numd</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>
        <span class="c">!! Number of nonzero density-matrix</span>
        <span class="c">!! elements for each matrix row</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">listdptr</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>
        <span class="c">!! Pointer to start of rows of density-matrix</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">listd</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
        <span class="c">!! `listd(maxnd)`: Nonzero-density-matrix-element column</span>
        <span class="c">!! indexes for each matrix row</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">maxnh</span>
        <span class="c">!! First dimension of listh and Hmat</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xa</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Atomic positions of all atoms in supercell</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Dscf</span><span class="p">(:,:)</span>
        <span class="c">!! `Dscf(maxnd,h_spin_dim)`:  </span>
        <span class="c">!! SCF density-matrix elements</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">datm</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Harris density-matrix diagonal elements  </span>
        <span class="c">!! (atomic occupation charges of orbitals)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Hmat</span><span class="p">(:,:)</span>
        <span class="c">!! `Hmat(maxnh,h_spin_dim)`:  </span>
        <span class="c">!! Hamiltonian matrix in sparse form,  </span>
        <span class="c">!! to which are added the matrix elements  </span>
        <span class="c">!! `&lt;ORB_I | DeltaV | ORB_J&gt;`, where  </span>
        <span class="c">!! `DeltaV = Vna + Vxc(SCF) + Vhartree(RhoSCF-RhoHarris)`</span>

      <span class="k">type</span><span class="p">(</span><span class="n">filesOut_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">filesOut</span>
        <span class="c">!! Output file names (If blank =&gt; not saved)</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ntm</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Number of mesh divisions of each cell</span>
        <span class="c">!! vector, including subgrid.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">nua</span><span class="p">)</span>
        <span class="c">!! Atomic forces, to which the SCF contribution</span>
        <span class="c">!! is added by this routine when `ifa=1`.</span>
        <span class="c">!! The SCF contribution is minus the derivative</span>
        <span class="c">!! of `(Enascf - Enaatm + DUscf + Exc)` with</span>
        <span class="c">!! respect to atomic positions, in Ry/Bohr.</span>
        <span class="c">!! Contributions local to this node.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Stress tensor, to which the SCF contribution</span>
        <span class="c">!! is added by this routine when `ifa=1`.</span>
        <span class="c">!! The SCF contribution is minus the derivative of</span>
        <span class="c">!! `(Enascf - Enaatm + DUscf + Exc) / volume`</span>
        <span class="c">!! with respect to the strain tensor, in Ry.</span>
        <span class="c">!! Contributions local to this node.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stress</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Enaatm</span>
        <span class="c">!! Integral of `Vna * rhoatm`</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Enascf</span>
        <span class="c">!! Integral of `Vna * rhoscf`</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Uatm</span>
        <span class="c">!! Harris hartree electron-interaction energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Uscf</span>
        <span class="c">!! SCF hartree electron-interaction energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">DUscf</span>
        <span class="c">!! Electrostatic (Hartree) energy of</span>
        <span class="c">!! `(rhoscf - rhoatm)` density</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">DUext</span>
        <span class="c">!! Interaction energy with external electric field</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Exc</span>
        <span class="c">!! SCF exchange-correlation energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Dxc</span>
        <span class="c">!! SCF double-counting correction to Exc  </span>
        <span class="c">!! `Dxc = integral of ( (epsxc - Vxc) * Rho )`  </span>
        <span class="c">!! All energies in Rydbergs</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Electric dipole (in a.u.)</span>
        <span class="c">!! only when the system is a molecule</span>

      <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">use_rhog_in</span>
      <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">charge_density_only</span>


<span class="c">!     Local variables</span>
      <span class="kt">integer</span>  <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">nsd</span><span class="p">,</span> <span class="n">np_vac</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Interface to JMS&#39;s SiestaXC</span>
      <span class="kt">integer</span>       <span class="kd">::</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">save</span> <span class="kd">::</span> <span class="n">JDGdistr</span><span class="o">=-</span><span class="mi">1</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stressXC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">b1Xb2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">const</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DStres</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
     <span class="p">&amp;</span>            <span class="n">Ec</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">rhotot</span><span class="p">,</span> <span class="n">x0</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Vmax_vac</span><span class="p">,</span> <span class="n">Vmean_vac</span>
<span class="cp">#ifdef BSC_CELLXC</span>
<span class="c">!     Dummy arrays for cellxc call</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aux3</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dummy_DVxcdn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="kt">logical</span> <span class="kd">::</span> <span class="n">use_rhog</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">volcel</span><span class="p">,</span> <span class="n">ddot</span>

      <span class="k">external</span>
     <span class="p">&amp;</span>  <span class="n">cross</span><span class="p">,</span>
     <span class="p">&amp;</span>  <span class="n">dipole</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">poison</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">reord</span><span class="p">,</span> <span class="n">rhooda</span><span class="p">,</span> <span class="n">rhoofdsp</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">timer</span><span class="p">,</span> <span class="n">vmatsp</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">readsp</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">external </span><span class="n">bsc_cellxc</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="c">!     Work arrays</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Vscf</span><span class="p">(:,:),</span> <span class="n">Vscf_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                         <span class="n">DRho</span><span class="p">(:,:),</span> <span class="n">DRho_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                         <span class="n">Vaux</span><span class="p">(:),</span> <span class="n">Vaux_par</span><span class="p">(:),</span> <span class="n">Chlocal</span><span class="p">(:),</span>
     <span class="p">&amp;</span>                         <span class="n">Totchar</span><span class="p">(:),</span> <span class="n">fsrc</span><span class="p">(:),</span> <span class="n">fdst</span><span class="p">(:),</span>
     <span class="p">&amp;</span>                         <span class="n">rhoatm_quad</span><span class="p">(:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">(),</span>
     <span class="p">&amp;</span>                         <span class="n">DRho_quad</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>
      <span class="c">! Temporary reciprocal spin quantity</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">rnsd</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Vscf_gga</span><span class="p">(:,:),</span> <span class="n">DRho_gga</span><span class="p">(:,:)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
<span class="cp">#ifdef MPI</span>
      <span class="kt">integer</span>  <span class="kd">::</span> <span class="n">MPIerror</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
      <span class="k">call </span><span class="n">write_debug</span><span class="p">(</span> <span class="s1">&#39;    PRE DHSCF&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span> <span class="o">/=</span> <span class="n">size</span><span class="p">(</span><span class="n">Dscf</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;Spin components is not equal to options.&#39;</span><span class="p">)</span>
      <span class="k">end if</span>

<span class="k">      if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;DM&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">)</span>
         <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Hmat</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">)</span>
      <span class="k">end if</span>
      
<span class="c">!-------------------------------------------------------------------- BEGIN</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Start of SCF iteration part</span>
<span class="c">! ----------------------------------------------------------------------</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     At the end of DHSCF_INIT, and also at the end of any previous</span>
<span class="c">!     call to dhscf, we were in the UNIFORM distribution</span>
<span class="c">!     Rhoatm, Rhopcc and Vna were in UNIFORM dist, sequential form</span>
<span class="c">!     The index array endpht was in the QUADRATIC distribution</span>
<span class="c">! ----------------------------------------------------------------------</span>

<span class="cp">#ifdef _TRACE_</span>
      <span class="k">call </span><span class="n">MPI_Barrier</span><span class="p">(</span> <span class="n">MPI_Comm_World</span><span class="p">,</span> <span class="n">MPIerror</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">MPItrace_restart</span><span class="p">(</span> <span class="p">)</span>
<span class="cp">#endif</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>

      <span class="k">nullify</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">Totchar</span> <span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">nullify</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="n">DRho_gga</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="n">volume</span> <span class="o">=</span> <span class="n">volcel</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

<span class="c">!-------------------------------------------------------------------------</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">analyze_charge_density_only</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">!! Use the functionality in the first block</span>
         <span class="c">!! of the routine to get charge files and partial charges</span>
         <span class="k">call </span><span class="n">setup_analysis_options</span><span class="p">()</span>
      <span class="n">endif</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Uniform dist, sequential form</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vna&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span><span class="n">Vna</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vna</span><span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="s2">&quot;Vna&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vna</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="s2">&quot;Vna&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Allocate memory for DRho using the UNIFORM data distribution</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

<span class="c">! Find number of diagonal spin values</span>
      <span class="n">nsd</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">nspin</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">nsd</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         </span><span class="n">rnsd</span> <span class="o">=</span> <span class="mf">1._grid_p</span>
      <span class="k">else</span>
<span class="k">         </span><span class="n">rnsd</span> <span class="o">=</span> <span class="mf">1._grid_p</span> <span class="o">/</span> <span class="n">nsd</span>
      <span class="k">end if</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Find SCF electron density at mesh points. Store it in array DRho</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!</span>
<span class="c">!     The reading routine works in the uniform distribution, in</span>
<span class="c">!     sequential form</span>
<span class="c">!</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">use_rhog_in</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">use_rhog</span> <span class="o">=</span> <span class="n">use_rhog_in</span>
         <span class="k">else</span>
<span class="k">            </span><span class="n">use_rhog</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="n">endif</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">use_rhog</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! fourier transform back into drho</span>
         <span class="k">call </span><span class="n">rhofft</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>                  <span class="n">DRho</span><span class="p">,</span><span class="n">rhog_in</span><span class="p">,</span><span class="n">BACKWARD</span><span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span><span class="n">read_charge_cdf</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">read_grid_netcdf</span><span class="p">(</span><span class="n">ntm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="n">DRho</span><span class="p">,</span><span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
         <span class="n">read_charge_cdf</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">else if</span> <span class="p">(</span><span class="n">read_deformation_charge_cdf</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">read_grid_netcdf</span><span class="p">(</span><span class="n">ntm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="n">DRho</span><span class="p">,</span><span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
         <span class="c">! Add to diagonal components only</span>
         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
            <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
<span class="c">!             rhoatm and Drho are in sequential mode</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
            <span class="n">enddo</span>
         <span class="n">enddo</span>
         <span class="n">read_deformation_charge_cdf</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">else</span>
        <span class="c">! Set the QUADRATIC distribution and allocate memory for DRho_par</span>
        <span class="c">! since the construction of the density from the DM and orbital</span>
        <span class="c">! data needs that distribution</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;DRho_par&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">Spiral</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">rhoofdsp</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>                   <span class="n">nspin</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span>
     <span class="p">&amp;</span>                   <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">qspiral</span> <span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">rhoofd</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="n">nspin</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span> 
     <span class="p">&amp;</span>                 <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="c">! DRHO_par is here in QUADRATIC, clustered form</span>

<span class="c">!       Set the UNIFORM distribution again and copy DRho to it</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>

        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! Sequential to be able to write it out</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
        <span class="n">enddo</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="s1">&#39;DRho_par&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;DRho&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nspin</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">save_initial_charge_density</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! This section is to be deprecated in favor</span>
           <span class="c">! of &quot;analyze_charge_density_only&quot;</span>
           <span class="c">! (except for the special name for the .nc file)</span>
<span class="cp">#ifdef NCDF_4</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoInit&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">ntml</span><span class="p">,</span><span class="n">DRho</span><span class="p">)</span>
          <span class="k">else</span>
<span class="k">             call </span><span class="n">write_rho</span><span class="p">(</span> <span class="s2">&quot;RHO_INIT&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>            <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">)</span>
             <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="err">$</span>            <span class="s2">&quot;RhoInit&quot;</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="cp">#else</span>
          <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="s2">&quot;RHO_INIT&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>         <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">)</span>
          <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="err">$</span>         <span class="s2">&quot;RhoInit&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
          <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;STOP after producing RHO_INIT from input DM&quot;</span><span class="p">)</span>
        <span class="n">endif</span>

      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">mix_charge</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! Save fourier transform of charge density</span>
         <span class="k">call </span><span class="n">rhofft</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">DRho</span><span class="p">,</span><span class="n">rhog</span><span class="p">,</span><span class="n">FORWARD</span><span class="p">)</span>
      <span class="n">endif</span>
<span class="c">!</span>
<span class="c">!     Proper place to integrate Hirshfeld and Voronoi code,</span>
<span class="c">!     since we have just computed rhoatm and Rho.</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">want_partial_charges</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! The endpht array is in the quadratic distribution, so</span>
        <span class="c">! we need to use it for this...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;DRho_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>       
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">rhoatm_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;rhoatm_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="c">! Redistribute grid-density</span>
        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho_quad</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="n">enddo</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">rhoatm</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">rhoatm_quad</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">compute_partial_charges</span><span class="p">(</span><span class="n">DRho_quad</span><span class="p">,</span><span class="n">rhoatm_quad</span><span class="p">,</span>
     <span class="p">.</span>                  <span class="n">nspin</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> 
     <span class="p">.</span>                  <span class="n">isa</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span><span class="n">dvol</span><span class="p">)</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span><span class="n">rhoatm_quad</span><span class="p">,</span><span class="s1">&#39;rhoatm_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span><span class="n">Drho_quad</span><span class="p">,</span><span class="s1">&#39;DRho_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save electron density</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">!  DRho is already using a uniform, sequential form</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Rho&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">! Save TD-electron density after every given number of steps- Rafi, Jan 2016</span>
<span class="c">!-----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">write_tdrho</span><span class="p">(</span><span class="n">filesOut</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">tdrho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">!  DRho is already using a uniform, sequential form</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">tdrho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;TDRho&quot;</span><span class="p">)</span>
      <span class="n">endif</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save the diffuse ionic charge and/or the total (ionic+electronic) charge</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!       Find diffuse ionic charge on mesh</span>
        <span class="c">! Note that the *OnMesh routines, except PhiOnMesh,</span>
        <span class="c">! work with any distribution, thanks to the fact that</span>
        <span class="c">! the ipa, idop, and indexp arrays are distro-specific</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">LocalChargeOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">indxua</span> <span class="p">)</span>
        <span class="c">! Chlocal comes out in clustered form, so we convert it</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Chlocal</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">end if</span>

<span class="c">!       Save diffuse ionic charge </span>
        <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">Chlocal</span><span class="p">)</span>
          <span class="k">else</span>
<span class="k">             call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">Chlocal</span><span class="p">)</span>
             <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="s1">&#39;Chlocal&#39;</span> <span class="p">)</span>
          <span class="k">end if</span>
<span class="cp">#else</span>
          <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Chlocal</span><span class="p">)</span>
          <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Chlocal</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>
        <span class="n">endif</span>

<span class="c">!       Save total (ionic+electronic) charge </span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! *****************</span>
           <span class="c">! **  IMPORTANT  **</span>
           <span class="c">! The Chlocal array is re-used to minimize memory</span>
           <span class="c">! usage. In the this small snippet the Chlocal</span>
           <span class="c">! array will contain the total charge, and</span>
           <span class="c">! if the logic should change, (i.e. should Chlocal</span>
           <span class="c">! be retained) is the Totchar needed to be re-instantiated.</span>
           <span class="c">! *****************</span>

<span class="c">!$OMP parallel default(shared), private(ispin,ip)</span>
           <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
<span class="c">!$OMP do </span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
              <span class="n">Chlocal</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">Chlocal</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="k">end do</span>
<span class="c">!$OMP end do </span>
           <span class="k">end do</span>
<span class="c">!$OMP end parallel</span>

          <span class="c">! See note above</span>
<span class="cp">#ifdef NCDF_4</span>
           <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">              call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoTot&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">Chlocal</span><span class="p">)</span>
           <span class="k">else</span>
<span class="k">              call </span><span class="n">write_rho</span><span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">ntm</span><span class="p">,</span><span class="n">nsm</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Chlocal</span><span class="p">)</span>
              <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> 
     <span class="p">&amp;</span>             <span class="s2">&quot;TotalCharge&quot;</span><span class="p">)</span>
           <span class="k">end if</span>
<span class="cp">#else</span>
           <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Chlocal</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Chlocal</span><span class="p">,</span> <span class="s2">&quot;TotalCharge&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
        <span class="k">end if </span>
<span class="k">        call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save the total charge (model core + valence) for Bader analysis</span>
<span class="c">! ----------------------------------------------------------------------</span>
      
      <span class="c">! The test for toch guarantees that we are in &quot;analysis mode&quot;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">savebader</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">save_bader_charge</span><span class="p">()</span>
      <span class="n">endif</span>

<span class="c">! Find difference between selfconsistent and atomic densities</span>

      <span class="c">!Both DRho and rhoatm are using a UNIFORM, sequential form</span>
<span class="c">!$OMP parallel do default(shared), private(ispin,ip),</span>
<span class="c">!$OMP&amp;collapse(2)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save electron density difference</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoDelta&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">charge_density_only</span><span class="p">))</span> <span class="k">then </span>
<span class="k">         if</span> <span class="p">(</span><span class="n">charge_density_only</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
            <span class="k">RETURN</span>
<span class="k">         </span><span class="n">endif</span>
      <span class="n">endif</span>

<span class="c">! End of analysis section</span>
<span class="c">! Can exit now, if requested</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">analyze_charge_density_only</span><span class="p">)</span> <span class="k">then </span>
<span class="k">            call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
           <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;STOP after analyzing charge from input DM&quot;</span><span class="p">)</span>
        <span class="n">endif</span>

<span class="c">!-------------------------------------------------------------</span>
<span class="c">!     Transform spin density into sum and difference</span>

      <span class="c">! TODO Check for NC/SO:</span>
      <span class="c">! Should we diagonalize locally at every point first?</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(rhotot,ip)</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
          <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">rhotot</span>
        <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">endif</span>

<span class="c">! Add a background charge to neutralize the net charge, to</span>
<span class="c">! model doped systems. It only adds the charge at points</span>
<span class="c">! where there are atoms (i.e., not in vacuum).          </span>
<span class="c">! First, call with &#39;task=0&#39; to add background charge    </span>
      <span class="k">if</span> <span class="p">(</span><span class="n">doping_active</span><span class="p">)</span> <span class="k">call </span><span class="n">doping_uniform</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">rhoatm</span><span class="p">)</span>
      
      <span class="c">! Add doping in cell (from ChargeGeometries/Geometry.Charge)</span>
      <span class="c">! Note that this routine will return immediately if no dopant is present</span>
      <span class="k">call </span><span class="n">charge_add</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Calculate the dipole moment</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39;bulk&#39;</span><span class="p">)</span> <span class="k">then</span>

<span class="c">! Find center of system</span>
        <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
        <span class="k">do </span><span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nua</span>
          <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">xa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ia</span><span class="p">)</span> <span class="o">/</span> <span class="n">nua</span>
        <span class="n">enddo</span>

<span class="c">! Find dipole</span>
        <span class="c">! This routine is distribution-blind</span>
        <span class="c">! and will reduce over all processors.</span>
        <span class="k">call </span><span class="n">dipole</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">nsm</span><span class="p">,</span>
     <span class="p">&amp;</span>               <span class="n">DRho</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dipol</span> <span class="p">)</span>

        <span class="c">! Orthogonalize dipole to bulk directions</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          </span><span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span> <span class="o">*</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;slab&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">cross</span><span class="p">(</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">b1Xb2</span> <span class="p">)</span>
          <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span> <span class="o">*</span> <span class="n">b1Xb2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
       <span class="k">end if</span>

<span class="k">       if</span> <span class="p">(</span> <span class="n">TSmode</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span> <span class="n">N_elec</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">then</span>
          <span class="c">! Orthogonalize dipole to electrode transport directions</span>
          <span class="k">do </span><span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">,</span> <span class="n">N_Elec</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">Elecs</span><span class="p">(</span><span class="n">ia</span><span class="p">)%</span><span class="n">cell</span><span class="p">(:,</span><span class="n">Elecs</span><span class="p">(</span><span class="n">ia</span><span class="p">)%</span><span class="n">t_dir</span><span class="p">)</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span> <span class="o">*</span> <span class="n">x0</span>
          <span class="k">end do</span>
<span class="k">        else if</span> <span class="p">(</span> <span class="p">(</span><span class="nb">shape</span> <span class="o">==</span> <span class="s1">&#39;molecule&#39;</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="nb">shape</span> <span class="o">==</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
          <span class="c">! Only allow dipole correction for chains and molecules</span>
          <span class="c">! along the semi-infinite direciton.</span>
          <span class="c">! Note this is *only* for 1-electrode setups</span>
          <span class="c">! Note that since the above removes the periodic directions</span>
          <span class="c">! this should not do anything for &#39;chain&#39; with the same semi-infinite</span>
          <span class="c">! direction</span>
          <span class="n">x0</span> <span class="o">=</span> <span class="n">Elecs</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">cell</span><span class="p">(:,</span><span class="n">Elecs</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">t_dir</span><span class="p">)</span>
          <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span> <span class="o">*</span> <span class="n">x0</span>
        <span class="k">end if</span>
<span class="k">       end if</span>
<span class="k">          </span>
<span class="k">      </span><span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find Hartree potential of DRho = rhoscf-rhoatm. Store it in Vaux</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Solve Poisson&#39;s equation</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Vaux&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">call </span><span class="n">poison</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DUscf</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">DStres</span><span class="p">,</span> <span class="n">nsm</span> <span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;Poisson&#39;</span><span class="p">,</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vaux</span><span class="p">(:)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
      <span class="k">end if</span>

      <span class="c">! Vscf is in the UNIFORM, sequential form, and only using</span>
      <span class="c">! the first spin index</span>

      <span class="c">! We require that even the SIESTA potential is &quot;fixed&quot;</span>
      <span class="c">! NOTE, this will only do something if</span>
      <span class="c">!   TS.Hartree.Fix is set</span>
      <span class="k">call </span><span class="n">ts_hartree_fix</span><span class="p">(</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">)</span>
      
<span class="c">! Add contribution to stress from electrostatic energy of rhoscf-rhoatm</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">istr</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">stressl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">DStres</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find electrostatic (Hartree) energy of full SCF electron density</span>
<span class="c">!     using the original data distribution </span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">Uatm</span> <span class="o">=</span> <span class="n">Uharrs</span>
      <span class="n">Uscf</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP parallel do default(shared), private(ip), </span>
<span class="c">!$OMP&amp;reduction(+:Uscf)</span>
      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
        <span class="n">Uscf</span> <span class="o">=</span> <span class="n">Uscf</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">Uscf</span> <span class="o">=</span> <span class="n">Uscf</span> <span class="o">*</span> <span class="n">dVol</span> <span class="o">+</span> <span class="n">Uatm</span> <span class="o">+</span> <span class="n">DUscf</span>

<span class="c">! Call doping with &#39;task=1&#39; to remove background charge added previously</span>
<span class="c">! The extra charge thus only affects the Hartree energy and potential,</span>
<span class="c">! but not the contribution to Enascf ( = \Int_{Vna*\rho})</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">doping_active</span><span class="p">)</span> <span class="k">call </span><span class="n">doping_uniform</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">rhoatm</span><span class="p">)</span>

      <span class="c">! Remove doping in cell (from ChargeGeometries/Geometry.Charge)</span>
      <span class="c">! Note that this routine will return immediately if no dopant is present</span>
      <span class="k">call </span><span class="n">charge_add</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add neutral-atom potential to Vaux</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
<span class="c">!$OMP parallel do default(shared), private(ip),</span>
<span class="c">!$OMP&amp;reduction(+:Enaatm,Enascf)</span>
      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
        <span class="n">Enaatm</span>   <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="n">Enascf</span>   <span class="o">=</span> <span class="n">Enascf</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">*</span> <span class="n">dVol</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">Enascf</span> <span class="o">*</span> <span class="n">dVol</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add potential from external electric field (if present)</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">acting_efield</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span> <span class="n">dipole_correction</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">field</span> <span class="o">=</span> <span class="n">get_field_from_dipole</span><span class="p">(</span><span class="n">dipol</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Node</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">	       write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;(a,3f12.4,a)&#39;</span><span class="p">)</span>
     <span class="err">$</span>              <span class="s1">&#39;Dipole moment in unit cell   =&#39;</span><span class="p">,</span> <span class="n">dipol</span><span class="o">/</span><span class="n">Debye</span><span class="p">,</span> <span class="s1">&#39; D&#39;</span>
	       <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;(a,3f12.6,a)&#39;</span><span class="p">)</span>
     <span class="err">$</span>              <span class="s1">&#39;Electric field for dipole correction =&#39;</span><span class="p">,</span>
     <span class="err">$</span>              <span class="n">field</span><span class="o">/</span><span class="n">eV</span><span class="o">*</span><span class="n">Ang</span><span class="p">,</span> <span class="s1">&#39; eV/Ang/e&#39;</span>
            <span class="k">end if</span>
            <span class="c">! The dipole correction energy has an extra factor</span>
            <span class="c">! of one half because the field involved is internal.</span>
            <span class="c">! See the paper by Bengtsson DOI:10.1103/PhysRevB.59.12301</span>
            <span class="c">! Hence we compute this part separately</span>
            <span class="n">DUext</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5_dp</span> <span class="o">*</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
         <span class="k">else</span>
<span class="k">            </span><span class="n">field</span> <span class="o">=</span> <span class="mf">0._dp</span>
            <span class="n">DUext</span> <span class="o">=</span> <span class="mf">0._dp</span>
         <span class="k">end if</span>
         <span class="c">! Add the external electric field</span>
         <span class="n">field</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="n">user_specified_field</span>
         <span class="c">! This routine expects a sequential array,</span>
         <span class="c">! but it is distribution-blind</span>
         <span class="k">call </span><span class="n">add_potential_from_field</span><span class="p">(</span> <span class="n">field</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span>
     <span class="p">&amp;</span>                                  <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
         <span class="c">! Add energy of external electric field</span>
         <span class="n">DUext</span> <span class="o">=</span> <span class="n">DUext</span> <span class="o">-</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">user_specified_field</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ---------------------------------------------------------------------</span>
<span class="c">!     Transiesta:</span>
<span class="c">!     add the potential corresponding to the (possible) voltage-drop.</span>
<span class="c">!     note that ts_voltage is not sharing the reord wih efield since</span>
<span class="c">!     we should not encounter both at the same time.</span>
<span class="c">! ---------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">TSmode</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">IsVolt</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">TSrun</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! This routine expects a sequential array,</span>
         <span class="c">! in whatever distribution</span>
<span class="cp">#ifdef TRANSIESTA_VOLTAGE_DEBUG</span>
<span class="c">!$OMP parallel workshare default(shared)</span>
         <span class="n">Vaux</span><span class="p">(:)</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP end parallel workshare</span>
<span class="cp">#endif</span>
         <span class="k">call </span><span class="n">ts_voltage</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">)</span>
<span class="cp">#ifdef TRANSIESTA_VOLTAGE_DEBUG</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> 
     <span class="p">&amp;</span>        <span class="s2">&quot;TransiestaHartreePotential&quot;</span><span class="p">)</span>
         <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;ts_volt&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
         <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s1">&#39;transiesta debug for Hartree potential&#39;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add potential from user defined geometries (if present)</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">hartree_add</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Save electrostatic potential</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Note that only the first spin component is used</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vh&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vaux</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">Vaux</span><span class="p">,</span> <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Get back spin density from sum and difference</span>
      <span class="c">! TODO Check for NC/SO:</span>
      <span class="c">! Should we diagonalize locally at every point first?</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(ip,rhotot)</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
          <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5_dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhotot</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5_dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhotot</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">! Set uniform distribution of mesh points and find my processor mesh box</span>
<span class="c">! This is the interface to JM Soler&#39;s own cellxc routine, which sets</span>
<span class="c">! up the right distribution internally.</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">call </span><span class="n">jms_setMeshDistr</span><span class="p">(</span> <span class="n">distrID</span><span class="o">=</span><span class="n">JDGdistr</span><span class="p">,</span> <span class="n">nMesh</span><span class="o">=</span><span class="n">ntm</span><span class="p">,</span> 
     <span class="p">.</span>                   <span class="n">nNodesX</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nNodesY</span><span class="o">=</span><span class="n">ProcessorY</span><span class="p">,</span> <span class="n">nBlock</span><span class="o">=</span><span class="n">nsm</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">myMeshBox</span><span class="p">(</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">JDGdistr</span><span class="p">,</span> <span class="n">myBox</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
<span class="c">! Exchange-correlation energy</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Vscf&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
         
<span class="c">!$OMP parallel do default(shared), private(ip,ispin), collapse(2)</span>
       <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
          <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
             <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span>
     <span class="p">&amp;</span>            <span class="p">(</span><span class="n">rhopcc</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">rnsd</span>
          <span class="n">enddo</span>
       <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

      <span class="k">else</span>

<span class="c">!$OMP parallel do default(shared), private(ip,ispin), collapse(2)</span>
       <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
          <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
             <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span>
     <span class="p">&amp;</span>            <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
          <span class="n">enddo</span>
       <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

      <span class="k">end if</span>

      <span class="c">! Write the electron density used by cellxc</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoXC&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;RhoXC&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>       <span class="s2">&quot;RhoXC&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Everything now is in UNIFORM, sequential form</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;CellXC&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Vscf_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_gga</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;DRho_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="c">! Redistribute all spin densities</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
        <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho_gga</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
      <span class="n">enddo</span>

      <span class="k">call </span><span class="n">bsc_cellxc</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aux3</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DRho_gga</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">Ec</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">Vscf_gga</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">dummy_DVxcdn</span><span class="p">,</span> <span class="n">stressl</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">call </span><span class="n">cellXC</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
     <span class="p">.</span>                           <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
     <span class="p">.</span>                           <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">.</span>             <span class="n">DRho</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">Ec</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">stressXC</span><span class="p">,</span> <span class="n">Vscf</span> <span class="p">)</span>
<span class="cp">#else /* BSC_CELLXC */</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="c">! Redistribute to the Vxc array</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nspin</span>
        <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf_gga</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
      <span class="n">enddo</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;XC&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nspin</span><span class="p">)</span>
      <span class="k">end if</span>
      
      
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Vscf is still sequential after the call to JMS&#39;s cellxc</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho_gga</span><span class="p">,</span> <span class="s1">&#39;DRho_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="s1">&#39;Vscf_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="n">Exc</span> <span class="o">=</span>  <span class="n">Ex</span> <span class="o">+</span>  <span class="n">Ec</span>
      <span class="n">Dxc</span> <span class="o">=</span> <span class="n">DEx</span> <span class="o">+</span> <span class="n">DEc</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;CellXC&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="c">!     Vscf contains only Vxc, and is UNIFORM and sequential</span>
<span class="c">!     Now we add up the other contributions to it, at </span>
<span class="c">!     the same time that we get DRho back to true DeltaRho form</span>
<span class="c">!$OMP parallel default(shared), private(ip,ispin)</span>

      <span class="c">! Hartree potential only has diagonal components</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP do</span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> 
     <span class="p">&amp;</span>             <span class="p">(</span><span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="n">rhopcc</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">rnsd</span>
              <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
           <span class="n">enddo</span>
<span class="c">!$OMP end do</span>
        <span class="k">else</span>
<span class="c">!$OMP do</span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
              <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
           <span class="n">enddo</span>
<span class="c">!$OMP end do</span>
        <span class="n">endif</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="n">stress</span> <span class="o">=</span> <span class="n">stress</span> <span class="o">+</span> <span class="n">stressXC</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Save total potential</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vt&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vscf</span><span class="p">)</span>
        <span class="k">else </span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vscf</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;TotalPotential&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">Vscf</span><span class="p">,</span> <span class="s2">&quot;TotalPotential&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Print vacuum level</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="o">/=</span><span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="o">/=</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        forall</span><span class="p">(</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nsd</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">rhoatm</span><span class="p">(:)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="k">call </span><span class="n">vacuum_level</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> 
     <span class="p">.</span>                     <span class="n">np_vac</span><span class="p">,</span> <span class="n">Vmax_vac</span><span class="p">,</span> <span class="n">Vmean_vac</span> <span class="p">)</span>
        <span class="k">forall</span><span class="p">(</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nsd</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(:)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np_vac</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">Node</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">print</span><span class="s1">&#39;(/,a,2f12.6,a)&#39;</span><span class="p">,</span> 
     <span class="p">.</span>    <span class="s1">&#39;dhscf: Vacuum level (max, mean) =&#39;</span><span class="p">,</span> 
     <span class="p">.</span>    <span class="n">Vmax_vac</span><span class="o">/</span><span class="n">eV</span><span class="p">,</span> <span class="n">Vmean_vac</span><span class="o">/</span><span class="n">eV</span><span class="p">,</span> <span class="s1">&#39; eV&#39;</span>
      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span> <span class="o">/=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">save_ebs_density</span><span class="p">()</span>
      <span class="n">endif</span>
      
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find SCF contribution to hamiltonian matrix elements</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">iHmat</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                         <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
         <span class="n">endif</span>

<span class="c">!        This is a work array, to which we copy Vscf</span>
         <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
           <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
         <span class="n">enddo</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">Spiral</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">vmatsp</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">qspiral</span> <span class="p">)</span>
         <span class="k">else</span>
<span class="k">            call </span><span class="n">vmat</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>
         <span class="n">endif</span>

         <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span>  <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!          Everything back to UNIFORM, sequential</span>
           <span class="k">call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                         <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
         <span class="n">endif</span>
      <span class="n">endif</span>


<span class="cp">#ifdef MPI</span>
<span class="c">!     Global reduction of Uscf/DUscf/Uatm/Enaatm/Enascf</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Note that Exc and Dxc are already reduced in the new cellxc</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uscf</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DUscf</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uatm</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Enaatm</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Enascf</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Exc</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">Dxc</span>
<span class="cp">#else</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">call </span><span class="n">MPI_AllReduce</span><span class="p">(</span> <span class="n">sbuffer</span><span class="p">,</span> <span class="n">rbuffer</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">MPI_double_precision</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">MPI_Sum</span><span class="p">,</span> <span class="n">MPI_Comm_World</span><span class="p">,</span> <span class="n">MPIerror</span> <span class="p">)</span>
      <span class="n">Uscf</span>   <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">DUscf</span>  <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">Uatm</span>   <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="n">Exc</span>    <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
      <span class="n">Dxc</span>    <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
<span class="cp">#endif /* MPI */</span>

<span class="c">!     Add contribution to stress from the derivative of the Jacobian of ---</span>
<span class="c">!     r-&gt;r&#39; (strained r) in the integral of Vna*(rhoscf-rhoatm)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">istr</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
          <span class="n">stress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">stress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">Enascf</span> <span class="o">-</span> <span class="n">Enaatm</span> <span class="p">)</span> <span class="o">/</span> <span class="n">volume</span>
        <span class="n">enddo</span>
      <span class="n">endif</span>

<span class="c">!     Stop time counter for SCF iteration part</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     End of SCF iteration part</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">istr</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Forces and stress : SCF contribution</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!       Start time counter for force calculation part</span>
        <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF4&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>

<span class="c">!       Find contribution of partial-core-correction</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">reord</span><span class="p">(</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="c">! The partial core calculation only acts on</span>
          <span class="c">! the diagonal spin-components (no need to</span>
          <span class="c">! redistribute un-used elements)</span>
          <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
            <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span>
     <span class="p">&amp;</span>                  <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="n">enddo</span>

          <span class="k">call </span><span class="n">PartialCoreOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">nsd</span><span class="p">,</span>
     <span class="p">&amp;</span>                            <span class="n">dvol</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span>
     <span class="p">&amp;</span>                            <span class="n">stressl</span><span class="p">,</span> <span class="n">ifa</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">istr</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span> <span class="p">)</span>
   
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="c">! ** see above</span>
          <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
            <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span>
     <span class="p">&amp;</span>                  <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="n">enddo</span>

          <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;PartialCore&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsd</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="k">        </span><span class="n">endif</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">harrisfun</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!         Forhar deals internally with its own needs</span>
<span class="c">!         for distribution changes</span>
<span class="cp">#ifndef BSC_CELLXC</span>
          <span class="k">call </span><span class="n">forhar</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">npcc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> 
<span class="cp">#else /* BSC_CELLXC */</span>
          <span class="k">call </span><span class="n">forhar</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">npcc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> 
<span class="cp">#endif /* BSC_CELLXC */</span>
     <span class="p">&amp;</span>                 <span class="n">rhoatm</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
<span class="c">!         Upon return, everything is UNIFORM, sequential form</span>
        <span class="n">endif</span>

<span class="c">!     Transform spin density into sum and difference</span>
        <span class="c">! TODO NC/SO</span>
        <span class="c">! Should we perform local diagonalization?</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(rhotot,ip)</span>
          <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
            <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">rhotot</span>
          <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
        <span class="n">endif</span>

<span class="c">!       Find contribution of neutral-atom potential</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">NeutralAtomOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> 
     <span class="p">&amp;</span>                          <span class="n">volume</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span> 
     <span class="p">&amp;</span>                          <span class="n">ifa</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">istr</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>

        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="n">enddo</span>

<span class="c">!       Remember that Vaux contains everything except Vxc</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Vaux_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">dfscf</span><span class="p">(</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>              <span class="n">indxua</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> 
     <span class="p">&amp;</span>              <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span>
     <span class="p">&amp;</span>              <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="s1">&#39;Vaux_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>


<span class="c">!       Stop time counter for force calculation part</span>
        <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF4&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!       End of force and stress calculation</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">endif</span>

<span class="c">!     We are in the UNIFORM distribution</span>
<span class="c">!     Rhoatm, Rhopcc and Vna are in UNIFORM dist, sequential form</span>
<span class="c">!     The index array endpht is in the QUADRATIC distribution</span>

<span class="c">!     Stop time counter</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Free locally allocated memory</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="s1">&#39;Vaux&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="s1">&#39;Vscf&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

<span class="cp">#ifdef DEBUG</span>
      <span class="k">call </span><span class="n">write_debug</span><span class="p">(</span> <span class="s1">&#39;    POS DHSCF&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>
<span class="c">!------------------------------------------------------------------------ END</span>
      <span class="k">CONTAINS</span>

<span class="k">      subroutine </span><span class="n">save_bader_charge</span><span class="p">()</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ModelCoreChargeOnMesh</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_cdf</span>
      <span class="k">use </span><span class="n">m_ncdf_siesta</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">cdf_save_grid</span>
<span class="cp">#endif</span>
      <span class="c">! Auxiliary routine to output the Bader Charge</span>
      <span class="c">!</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">BaderCharge</span><span class="p">(:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BaderCharge&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="n">routine</span><span class="o">=</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="c">! Find a model core charge by re-scaling the local charge</span>
      <span class="k">call </span><span class="n">ModelCoreChargeOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">indxua</span> <span class="p">)</span>
      <span class="c">! It comes out in clustered form, so we convert it</span>
      <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span><span class="p">)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
         <span class="n">BaderCharge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">BaderCharge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoBader&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">BaderCharge</span><span class="p">)</span>
      <span class="k">else</span>
<span class="k">         call </span><span class="n">write_rho</span><span class="p">(</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BaderCharge</span> <span class="p">)</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">BaderCharge</span><span class="p">,</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">)</span>
      <span class="k">end if</span>
<span class="cp">#else</span>
      <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BaderCharge</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">BaderCharge</span><span class="p">,</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BaderCharge&#39;</span> <span class="p">)</span>
      <span class="k">end subroutine </span><span class="n">save_bader_charge</span>

      <span class="k">subroutine </span><span class="n">setup_analysis_options</span><span class="p">()</span>
      <span class="c">!! For the analyze-charge-density-only case,</span>
      <span class="c">!! avoiding any diagonalization</span>

      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">hirshpop</span><span class="p">,</span> <span class="n">voropop</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">saverho</span><span class="p">,</span> <span class="n">savedrho</span><span class="p">,</span> <span class="n">saverhoxc</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savevh</span><span class="p">,</span> <span class="n">savevt</span><span class="p">,</span> <span class="n">savevna</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savepsch</span><span class="p">,</span> <span class="n">savetoch</span>

      <span class="n">want_partial_charges</span> <span class="o">=</span> <span class="p">(</span><span class="n">hirshpop</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">voropop</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">saverho</span><span class="p">)</span>   <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span>   <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.RHO&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savedrho</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.DRHO&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">saverhoxc</span><span class="p">)</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.RHOXC&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevh</span><span class="p">)</span>    <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span>    <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VH&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevt</span><span class="p">)</span>    <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span>    <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VT&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevna</span><span class="p">)</span>   <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span>   <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VNA&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savepsch</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.IOCH&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savetoch</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.TOCH&#39;</span>

      <span class="k">end subroutine </span><span class="n">setup_analysis_options</span>

      <span class="k">subroutine </span><span class="n">save_ebs_density</span><span class="p">()</span>
<span class="c">!! Optional output of the &quot;band-structure energy density&quot;, which</span>
<span class="c">!! is just the charge density weighted by the eigenvalues, i.e.,</span>
<span class="c">!! using EDM instead of DM in rhoofd</span>

      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">Escf</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Ebs_dens</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">(),</span>
     <span class="p">&amp;</span>                         <span class="n">Ebs_dens_quad</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>

<span class="c">!     Allocate memory for Ebs_dens using the UNIFORM data distribution</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Ebs_dens</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>

<span class="c">!     Switch to quadratic distribution for call to rhoofd</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">ebs_dens_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="s1">&#39;Ebs_dens_quad&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">rhoofd</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">nspin</span><span class="p">,</span> <span class="n">Escf</span><span class="p">,</span> <span class="n">Ebs_dens_quad</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>

<span class="c">!     Ebs_dens_par is here in QUADRATIC, clustered form</span>

<span class="c">!     Set the UNIFORM distribution again and copy Ebs_dens to it</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
         <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Ebs_dens_quad</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Ebs_dens</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! Sequential to be able to write it out</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
         <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
      <span class="n">enddo</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Ebs_dens_quad</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Ebs_density&#39;</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span> <span class="n">Ebs_dens</span><span class="p">)</span>
      <span class="k">else</span>
<span class="k">         call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Ebs_dens</span> <span class="p">)</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Ebs_dens</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="s2">&quot;Ebs_density&quot;</span><span class="p">)</span>
      <span class="k">end if</span>
<span class="cp">#else</span>
      <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">Ebs_dens</span><span class="p">)</span>
      <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">Ebs_dens</span><span class="p">,</span> <span class="s2">&quot;Ebs_density&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Ebs_dens</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">end subroutine </span><span class="n">save_ebs_density</span>

      <span class="k">end subroutine </span><span class="n">dhscf</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> SIESTA was developed by SIESTA Group</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>