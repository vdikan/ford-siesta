<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A first-principles materials simulation code using Density Functional Theory.">
    
    <meta name="author" content="SIESTA Group" >
    <link rel="icon" href="../favicon.png">

    <title>dhscf &ndash; SIESTA</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">SIESTA <small>trunk-700--vdikan-edens-708-ford-681</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Program Overview</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>dhscf
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     <li><i class="fa fa-pencil"></i> J.M. Soler</li>
     
     
    <li><i class="fa fa-calendar-o"></i> August 1996</li>
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title="10.5% of total for procedures.">659 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/dhscf.F"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/dhscf.f.html'>dhscf.F</a></li>
    
     <li><a href='../module/m_dhscf.html'>m_dhscf</a></li>
    
  
     <li class="active">dhscf</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/dhscf.html#src">dhscf</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine dhscf(nspin, norb, iaorb, iphorb, nuo, nuotot, nua, na, isa, xa, indxua, ntm, ifa, istr, iHmat, filesOut, maxnd, numd, listdptr, listd, Dscf, datm, maxnh, Hmat, Enaatm, Enascf, Uatm, Uscf, DUscf, DUext, Exc, Dxc, dipol, stress, Fal, stressl, use_rhog_in, charge_density_only)
    
    
   
</h2>
    
  
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Uses</h3>
      </div>
      <ul class="list-group">
      
      <li class="list-group-item">
  <ul class="list-inline">
    
    <li>precision</li>
    
    <li>parallel</li>
    
    <li>parallel</li>
    
    <li>atmfuncs</li>
    
    <li>units</li>
    
    <li>fdf</li>
    
    <li>sys</li>
    
    <li>mesh</li>
    
    <li>parsing</li>
    
    <li>m_iorho</li>
    
    <li>m_forhar</li>
    
    <li>alloc</li>
    
    <li>files</li>
    
    <li>files</li>
    
    <li>siesta_options</li>
    
    <li>siesta_options</li>
    
    <li>meshsubs</li>
    
    <li>meshsubs</li>
    
    <li>meshsubs</li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li>m_partial_charges</li>
    
    <li>m_partial_charges</li>
    
    <li>siestaXC</li>
    
    <li>siestaXC</li>
    
    <li>siestaXC</li>
    
    <li>m_vmat</li>
    
    <li>m_rhoofd</li>
    
    <li>mpi_siesta</li>
    
    <li>iogrid_netcdf</li>
    
    <li>iogrid_netcdf</li>
    
    <li>siesta_options</li>
    
    <li>siesta_options</li>
    
    <li>siesta_options</li>
    
    <li>siesta_options</li>
    
    <li>m_efield</li>
    
    <li>m_efield</li>
    
    <li>m_efield</li>
    
    <li>m_doping_uniform</li>
    
    <li>m_charge_add</li>
    
    <li>m_hartree_add</li>
    
    <li>siesta_options</li>
    
    <li>m_ncdf_siesta</li>
    
    <li>m_rhofft</li>
    
    <li>m_rhog</li>
    
    <li>m_spin</li>
    
    <li>m_spin</li>
    
    <li>m_iotddft</li>
    
    <li>m_ts_global_vars</li>
    
    <li>m_ts_options</li>
    
    <li>m_ts_voltage</li>
    
    <li>m_ts_hartree</li>
    
  </ul>
      </li>
      
      
      
      <li class="list-group-item">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~UsesGraph Pages: 1 -->
<svg id="procdhscfUsesGraph" width="291pt" height="1326pt"
 viewBox="0.00 0.00 291.00 1326.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 1322)">
<title>proc~~dhscf~~UsesGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1322 287,-1322 287,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~UsesGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="283,-667 229,-667 229,-643 283,-643 283,-667"/>
<text text-anchor="middle" x="256" y="-652.6" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- files -->
<g id="proc~~dhscf~~UsesGraph_node2" class="node"><title>files</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-1318 115,-1318 115,-1294 169,-1294 169,-1318"/>
<text text-anchor="middle" x="142" y="-1303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">files</text>
</g>
<!-- proc~dhscf&#45;&gt;files -->
<g id="proc~~dhscf~~UsesGraph_edge16" class="edge"><title>proc~dhscf&#45;&gt;files</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.551,-667.012C251.362,-749.736 231.17,-1233.26 193,-1285 189.312,-1290 184.203,-1293.82 178.651,-1296.73"/>
<polygon fill="#000000" stroke="#000000" points="176.883,-1293.68 169.062,-1300.83 179.633,-1300.12 176.883,-1293.68"/>
</g>
<!-- m_charge_add -->
<g id="proc~~dhscf~~UsesGraph_node3" class="node"><title>m_charge_add</title>
<polygon fill="#337ab7" stroke="#337ab7" points="184.5,-1276 99.5,-1276 99.5,-1252 184.5,-1252 184.5,-1276"/>
<text text-anchor="middle" x="142" y="-1261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_charge_add</text>
</g>
<!-- proc~dhscf&#45;&gt;m_charge_add -->
<g id="proc~~dhscf~~UsesGraph_edge3" class="edge"><title>proc~dhscf&#45;&gt;m_charge_add</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.452,-667.224C250.768,-747.286 228.666,-1195.01 193,-1243 192.435,-1243.76 191.837,-1244.49 191.21,-1245.2"/>
<polygon fill="#000000" stroke="#000000" points="188.824,-1242.64 183.522,-1251.81 193.387,-1247.94 188.824,-1242.64"/>
</g>
<!-- m_rhog -->
<g id="proc~~dhscf~~UsesGraph_node4" class="node"><title>m_rhog</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-1234 115,-1234 115,-1210 169,-1210 169,-1234"/>
<text text-anchor="middle" x="142" y="-1219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhog</text>
</g>
<!-- proc~dhscf&#45;&gt;m_rhog -->
<g id="proc~~dhscf~~UsesGraph_edge4" class="edge"><title>proc~dhscf&#45;&gt;m_rhog</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.232,-667.081C256.388,-739.212 259.079,-1112.82 193,-1201 189.311,-1205.92 184.247,-1209.7 178.751,-1212.6"/>
<polygon fill="#000000" stroke="#000000" points="177.059,-1209.52 169.26,-1216.69 179.829,-1215.94 177.059,-1209.52"/>
</g>
<!-- m_partial_charges -->
<g id="proc~~dhscf~~UsesGraph_node5" class="node"><title>m_partial_charges</title>
<polygon fill="#337ab7" stroke="#337ab7" points="192.5,-1192 91.5,-1192 91.5,-1168 192.5,-1168 192.5,-1192"/>
<text text-anchor="middle" x="142" y="-1177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_partial_charges</text>
</g>
<!-- proc~dhscf&#45;&gt;m_partial_charges -->
<g id="proc~~dhscf~~UsesGraph_edge5" class="edge"><title>proc~dhscf&#45;&gt;m_partial_charges</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.104,-667.038C255.472,-735.755 254.177,-1078.15 193,-1159 192.428,-1159.76 191.824,-1160.48 191.191,-1161.19"/>
<polygon fill="#000000" stroke="#000000" points="188.81,-1158.62 183.461,-1167.76 193.346,-1163.95 188.81,-1158.62"/>
</g>
<!-- m_ts_options -->
<g id="proc~~dhscf~~UsesGraph_node6" class="node"><title>m_ts_options</title>
<polygon fill="#337ab7" stroke="#337ab7" points="180,-1150 104,-1150 104,-1126 180,-1126 180,-1150"/>
<text text-anchor="middle" x="142" y="-1135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_options</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_options -->
<g id="proc~~dhscf~~UsesGraph_edge18" class="edge"><title>proc~dhscf&#45;&gt;m_ts_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.953,-667.307C254.469,-733.152 249.197,-1043.58 193,-1117 191.605,-1118.82 190.023,-1120.49 188.301,-1122.01"/>
<polygon fill="#000000" stroke="#000000" points="186.199,-1119.21 180.01,-1127.81 190.211,-1124.95 186.199,-1119.21"/>
</g>
<!-- parsing -->
<g id="proc~~dhscf~~UsesGraph_node7" class="node"><title>parsing</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-1108 115,-1108 115,-1084 169,-1084 169,-1108"/>
<text text-anchor="middle" x="142" y="-1093.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parsing</text>
</g>
<!-- proc~dhscf&#45;&gt;parsing -->
<g id="proc~~dhscf~~UsesGraph_edge7" class="edge"><title>proc~dhscf&#45;&gt;parsing</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.768,-667.403C253.367,-729.792 244.283,-1008.9 193,-1075 189.229,-1079.86 184.125,-1083.61 178.615,-1086.49"/>
<polygon fill="#000000" stroke="#000000" points="176.922,-1083.41 169.121,-1090.58 179.69,-1089.84 176.922,-1083.41"/>
</g>
<!-- m_iorho -->
<g id="proc~~dhscf~~UsesGraph_node8" class="node"><title>m_iorho</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-1066 115,-1066 115,-1042 169,-1042 169,-1066"/>
<text text-anchor="middle" x="142" y="-1051.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_iorho</text>
</g>
<!-- proc~dhscf&#45;&gt;m_iorho -->
<g id="proc~~dhscf~~UsesGraph_edge26" class="edge"><title>proc~dhscf&#45;&gt;m_iorho</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.547,-667.311C252.172,-725.677 239.437,-974.129 193,-1033 189.19,-1037.83 184.067,-1041.56 178.55,-1044.44"/>
<polygon fill="#000000" stroke="#000000" points="176.857,-1041.36 169.056,-1048.53 179.625,-1047.79 176.857,-1041.36"/>
</g>
<!-- m_ts_voltage -->
<g id="proc~~dhscf~~UsesGraph_node9" class="node"><title>m_ts_voltage</title>
<polygon fill="#337ab7" stroke="#337ab7" points="180,-1024 104,-1024 104,-1000 180,-1000 180,-1024"/>
<text text-anchor="middle" x="142" y="-1009.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_voltage</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_voltage -->
<g id="proc~~dhscf~~UsesGraph_edge8" class="edge"><title>proc~dhscf&#45;&gt;m_ts_voltage</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.289,-667.012C250.884,-720.812 234.662,-939.25 193,-991 191.716,-992.595 190.289,-994.071 188.753,-995.436"/>
<polygon fill="#000000" stroke="#000000" points="186.477,-992.758 180.318,-1001.38 190.508,-998.48 186.477,-992.758"/>
</g>
<!-- m_rhoofd -->
<g id="proc~~dhscf~~UsesGraph_node10" class="node"><title>m_rhoofd</title>
<polygon fill="#337ab7" stroke="#337ab7" points="171,-982 113,-982 113,-958 171,-958 171,-982"/>
<text text-anchor="middle" x="142" y="-967.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhoofd</text>
</g>
<!-- proc~dhscf&#45;&gt;m_rhoofd -->
<g id="proc~~dhscf~~UsesGraph_edge9" class="edge"><title>proc~dhscf&#45;&gt;m_rhoofd</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M253.93,-667.153C249.333,-716.898 229.796,-904.462 193,-949 189.602,-953.113 185.257,-956.435 180.553,-959.113"/>
<polygon fill="#000000" stroke="#000000" points="178.771,-956.083 171.215,-963.511 181.754,-962.416 178.771,-956.083"/>
</g>
<!-- siestaXC -->
<g id="proc~~dhscf~~UsesGraph_node11" class="node"><title>siestaXC</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169.5,-940 114.5,-940 114.5,-916 169.5,-916 169.5,-940"/>
<text text-anchor="middle" x="142" y="-925.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siestaXC</text>
</g>
<!-- proc~dhscf&#45;&gt;siestaXC -->
<g id="proc~~dhscf~~UsesGraph_edge10" class="edge"><title>proc~dhscf&#45;&gt;siestaXC</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.6,-667.205C256.88,-706.855 255.643,-833.706 193,-907 189.12,-911.539 184.094,-915.118 178.728,-917.934"/>
<polygon fill="#000000" stroke="#000000" points="177.26,-914.756 169.518,-921.988 180.08,-921.163 177.26,-914.756"/>
</g>
<!-- m_forhar -->
<g id="proc~~dhscf~~UsesGraph_node12" class="node"><title>m_forhar</title>
<polygon fill="#337ab7" stroke="#337ab7" points="170,-898 114,-898 114,-874 170,-874 170,-898"/>
<text text-anchor="middle" x="142" y="-883.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_forhar</text>
</g>
<!-- proc~dhscf&#45;&gt;m_forhar -->
<g id="proc~~dhscf~~UsesGraph_edge11" class="edge"><title>proc~dhscf&#45;&gt;m_forhar</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.871,-667.143C253.855,-702.313 246.243,-805.52 193,-865 189.232,-869.209 184.484,-872.599 179.422,-875.322"/>
<polygon fill="#000000" stroke="#000000" points="177.781,-872.223 170.115,-879.537 180.669,-878.599 177.781,-872.223"/>
</g>
<!-- m_iotddft -->
<g id="proc~~dhscf~~UsesGraph_node13" class="node"><title>m_iotddft</title>
<polygon fill="#337ab7" stroke="#337ab7" points="170.5,-856 113.5,-856 113.5,-832 170.5,-832 170.5,-856"/>
<text text-anchor="middle" x="142" y="-841.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_iotddft</text>
</g>
<!-- proc~dhscf&#45;&gt;m_iotddft -->
<g id="proc~~dhscf~~UsesGraph_edge12" class="edge"><title>proc~dhscf&#45;&gt;m_iotddft</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M253.792,-667.307C250.184,-697.702 236.847,-777.176 193,-823 189.311,-826.855 184.805,-830.033 180.025,-832.643"/>
<polygon fill="#000000" stroke="#000000" points="178.237,-829.614 170.636,-836.995 181.181,-835.965 178.237,-829.614"/>
</g>
<!-- units -->
<g id="proc~~dhscf~~UsesGraph_node14" class="node"><title>units</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-814 115,-814 115,-790 169,-790 169,-814"/>
<text text-anchor="middle" x="142" y="-799.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">units</text>
</g>
<!-- proc~dhscf&#45;&gt;units -->
<g id="proc~~dhscf~~UsesGraph_edge13" class="edge"><title>proc~dhscf&#45;&gt;units</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M252.111,-667.12C245.647,-691.782 227.781,-748.234 193,-781 188.845,-784.914 183.854,-788.152 178.656,-790.814"/>
<polygon fill="#000000" stroke="#000000" points="176.931,-787.751 169.212,-795.007 179.772,-794.149 176.931,-787.751"/>
</g>
<!-- m_efield -->
<g id="proc~~dhscf~~UsesGraph_node15" class="node"><title>m_efield</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-772 115,-772 115,-748 169,-748 169,-772"/>
<text text-anchor="middle" x="142" y="-757.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_efield</text>
</g>
<!-- proc~dhscf&#45;&gt;m_efield -->
<g id="proc~~dhscf~~UsesGraph_edge14" class="edge"><title>proc~dhscf&#45;&gt;m_efield</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M248.794,-667.184C239.105,-685.128 218.79,-718.723 193,-739 188.605,-742.455 183.56,-745.437 178.401,-747.98"/>
<polygon fill="#000000" stroke="#000000" points="176.84,-744.843 169.111,-752.089 179.672,-751.245 176.84,-744.843"/>
</g>
<!-- m_doping_uniform -->
<g id="proc~~dhscf~~UsesGraph_node16" class="node"><title>m_doping_uniform</title>
<polygon fill="#337ab7" stroke="#337ab7" points="193,-730 91,-730 91,-706 193,-706 193,-730"/>
<text text-anchor="middle" x="142" y="-715.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_doping_uniform</text>
</g>
<!-- proc~dhscf&#45;&gt;m_doping_uniform -->
<g id="proc~~dhscf~~UsesGraph_edge15" class="edge"><title>proc~dhscf&#45;&gt;m_doping_uniform</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M238.979,-667.149C226.777,-676.076 209.347,-688.144 193,-697 189.969,-698.642 186.783,-700.244 183.548,-701.783"/>
<polygon fill="#000000" stroke="#000000" points="182.048,-698.62 174.387,-705.939 184.94,-704.995 182.048,-698.62"/>
</g>
<!-- siesta_options -->
<g id="proc~~dhscf~~UsesGraph_node17" class="node"><title>siesta_options</title>
<polygon fill="#337ab7" stroke="#337ab7" points="182.5,-688 101.5,-688 101.5,-664 182.5,-664 182.5,-688"/>
<text text-anchor="middle" x="142" y="-673.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_options</text>
</g>
<!-- proc~dhscf&#45;&gt;siesta_options -->
<g id="proc~~dhscf~~UsesGraph_edge2" class="edge"><title>proc~dhscf&#45;&gt;siesta_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M228.741,-659.924C217.925,-661.952 205.024,-664.37 192.556,-666.708"/>
<polygon fill="#000000" stroke="#000000" points="191.88,-663.274 182.696,-668.557 193.17,-670.154 191.88,-663.274"/>
</g>
<!-- m_rhofft -->
<g id="proc~~dhscf~~UsesGraph_node18" class="node"><title>m_rhofft</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-646 115,-646 115,-622 169,-622 169,-646"/>
<text text-anchor="middle" x="142" y="-631.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhofft</text>
</g>
<!-- proc~dhscf&#45;&gt;m_rhofft -->
<g id="proc~~dhscf~~UsesGraph_edge17" class="edge"><title>proc~dhscf&#45;&gt;m_rhofft</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M228.741,-650.076C213.996,-647.312 195.377,-643.821 179.259,-640.799"/>
<polygon fill="#000000" stroke="#000000" points="179.568,-637.296 169.095,-638.893 178.278,-644.176 179.568,-637.296"/>
</g>
<!-- m_ts_global_vars -->
<g id="proc~~dhscf~~UsesGraph_node19" class="node"><title>m_ts_global_vars</title>
<polygon fill="#337ab7" stroke="#337ab7" points="190.5,-604 93.5,-604 93.5,-580 190.5,-580 190.5,-604"/>
<text text-anchor="middle" x="142" y="-589.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_global_vars</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_global_vars -->
<g id="proc~~dhscf~~UsesGraph_edge6" class="edge"><title>proc~dhscf&#45;&gt;m_ts_global_vars</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M238.979,-642.851C226.777,-633.924 209.347,-621.856 193,-613 189.969,-611.358 186.783,-609.756 183.548,-608.217"/>
<polygon fill="#000000" stroke="#000000" points="184.94,-605.005 174.387,-604.061 182.048,-611.38 184.94,-605.005"/>
</g>
<!-- m_ncdf_siesta -->
<g id="proc~~dhscf~~UsesGraph_node20" class="node"><title>m_ncdf_siesta</title>
<polygon fill="#337ab7" stroke="#337ab7" points="183,-562 101,-562 101,-538 183,-538 183,-562"/>
<text text-anchor="middle" x="142" y="-547.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ncdf_siesta</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ncdf_siesta -->
<g id="proc~~dhscf~~UsesGraph_edge19" class="edge"><title>proc~dhscf&#45;&gt;m_ncdf_siesta</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M248.794,-642.816C239.105,-624.872 218.79,-591.277 193,-571 191.226,-569.605 189.346,-568.287 187.395,-567.045"/>
<polygon fill="#000000" stroke="#000000" points="188.935,-563.896 178.499,-562.068 185.518,-570.005 188.935,-563.896"/>
</g>
<!-- module~moremeshsubs -->
<g id="proc~~dhscf~~UsesGraph_node21" class="node"><title>module~moremeshsubs</title>
<g id="a_proc~~dhscf~~UsesGraph_node21"><a xlink:href=".././module/moremeshsubs.html" xlink:title="moreMeshSubs">
<polygon fill="#337ab7" stroke="#337ab7" points="186,-482 98,-482 98,-458 186,-458 186,-482"/>
<text text-anchor="middle" x="142" y="-467.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">moreMeshSubs</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~moremeshsubs -->
<g id="proc~~dhscf~~UsesGraph_edge20" class="edge"><title>proc~dhscf&#45;&gt;module~moremeshsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M253.225,-642.706C248.469,-613.786 232.981,-540.537 193,-496 190.169,-492.847 186.865,-490.016 183.329,-487.489"/>
<polygon fill="#000000" stroke="#000000" points="185.104,-484.471 174.769,-482.136 181.392,-490.406 185.104,-484.471"/>
</g>
<!-- precision -->
<g id="proc~~dhscf~~UsesGraph_node22" class="node"><title>precision</title>
<polygon fill="#337ab7" stroke="#337ab7" points="55,-526 0,-526 0,-502 55,-502 55,-526"/>
<text text-anchor="middle" x="27.5" y="-511.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">precision</text>
</g>
<!-- proc~dhscf&#45;&gt;precision -->
<g id="proc~~dhscf~~UsesGraph_edge21" class="edge"><title>proc~dhscf&#45;&gt;precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M141,-510C118.326,-496.838 88.5233,-498.568 65.2892,-503.198"/>
<polygon fill="#000000" stroke="#000000" points="64.4419,-499.801 55.4504,-505.405 65.974,-506.631 64.4419,-499.801"/>
</g>
<!-- meshsubs -->
<g id="proc~~dhscf~~UsesGraph_node23" class="node"><title>meshsubs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="172.5,-402 111.5,-402 111.5,-378 172.5,-378 172.5,-402"/>
<text text-anchor="middle" x="142" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">meshsubs</text>
</g>
<!-- proc~dhscf&#45;&gt;meshsubs -->
<g id="proc~~dhscf~~UsesGraph_edge22" class="edge"><title>proc~dhscf&#45;&gt;meshsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.153,-642.815C255.005,-604.894 249.748,-487.255 193,-416 189.769,-411.942 185.731,-408.45 181.36,-405.464"/>
<polygon fill="#000000" stroke="#000000" points="183.058,-402.401 172.668,-400.327 179.496,-408.428 183.058,-402.401"/>
</g>
<!-- sys -->
<g id="proc~~dhscf~~UsesGraph_node24" class="node"><title>sys</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54.5,-484 0.5,-484 0.5,-460 54.5,-460 54.5,-484"/>
<text text-anchor="middle" x="27.5" y="-469.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">sys</text>
</g>
<!-- proc~dhscf&#45;&gt;sys -->
<g id="proc~~dhscf~~UsesGraph_edge23" class="edge"><title>proc~dhscf&#45;&gt;sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M252.203,-642.78C245.909,-617.935 228.341,-561.162 193,-529 175.418,-513 163.56,-521.935 143,-510"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M141,-510C134.132,-506.013 94.777,-493.06 64.5296,-483.377"/>
<polygon fill="#000000" stroke="#000000" points="65.2717,-479.94 54.681,-480.237 63.1451,-486.61 65.2717,-479.94"/>
</g>
<!-- mesh -->
<g id="proc~~dhscf~~UsesGraph_node25" class="node"><title>mesh</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-360 115,-360 115,-336 169,-336 169,-360"/>
<text text-anchor="middle" x="142" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mesh</text>
</g>
<!-- proc~dhscf&#45;&gt;mesh -->
<g id="proc~~dhscf~~UsesGraph_edge24" class="edge"><title>proc~dhscf&#45;&gt;mesh</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M253.852,-642.845C249.017,-593.95 228.879,-412.179 193,-369 189.107,-364.315 183.987,-360.656 178.511,-357.805"/>
<polygon fill="#000000" stroke="#000000" points="179.676,-354.495 169.109,-353.729 176.892,-360.918 179.676,-354.495"/>
</g>
<!-- mpi_siesta -->
<g id="proc~~dhscf~~UsesGraph_node26" class="node"><title>mpi_siesta</title>
<polygon fill="#337ab7" stroke="#337ab7" points="174,-318 110,-318 110,-294 174,-294 174,-318"/>
<text text-anchor="middle" x="142" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_siesta</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_siesta -->
<g id="proc~~dhscf~~UsesGraph_edge25" class="edge"><title>proc~dhscf&#45;&gt;mpi_siesta</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.225,-642.918C250.597,-589.791 233.722,-377.358 193,-327 190.269,-323.623 186.9,-320.782 183.21,-318.392"/>
<polygon fill="#000000" stroke="#000000" points="184.643,-315.19 174.168,-313.597 181.363,-321.374 184.643,-315.19"/>
</g>
<!-- m_spin -->
<g id="proc~~dhscf~~UsesGraph_node27" class="node"><title>m_spin</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-276 115,-276 115,-252 169,-252 169,-276"/>
<text text-anchor="middle" x="142" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_spin</text>
</g>
<!-- proc~dhscf&#45;&gt;m_spin -->
<g id="proc~~dhscf~~UsesGraph_edge1" class="edge"><title>proc~dhscf&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.51,-642.947C251.967,-585.808 238.58,-342.579 193,-285 189.182,-280.176 184.055,-276.447 178.536,-273.567"/>
<polygon fill="#000000" stroke="#000000" points="179.611,-270.219 169.041,-269.481 176.843,-276.649 179.611,-270.219"/>
</g>
<!-- parallel -->
<g id="proc~~dhscf~~UsesGraph_node28" class="node"><title>parallel</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54.5,-442 0.5,-442 0.5,-418 54.5,-418 54.5,-442"/>
<text text-anchor="middle" x="27.5" y="-427.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parallel</text>
</g>
<!-- proc~dhscf&#45;&gt;parallel -->
<g id="proc~~dhscf~~UsesGraph_edge27" class="edge"><title>proc~dhscf&#45;&gt;parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M141,-430C119.505,-413.942 88.6834,-415.118 64.7349,-419.656"/>
<polygon fill="#000000" stroke="#000000" points="63.9779,-416.239 54.9392,-421.766 65.4521,-423.082 63.9779,-416.239"/>
</g>
<!-- m_vmat -->
<g id="proc~~dhscf~~UsesGraph_node29" class="node"><title>m_vmat</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-234 115,-234 115,-210 169,-210 169,-234"/>
<text text-anchor="middle" x="142" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_vmat</text>
</g>
<!-- proc~dhscf&#45;&gt;m_vmat -->
<g id="proc~~dhscf~~UsesGraph_edge28" class="edge"><title>proc~dhscf&#45;&gt;m_vmat</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.734,-642.831C253.172,-581.623 243.418,-307.793 193,-243 189.222,-238.145 184.115,-234.4 178.603,-231.515"/>
<polygon fill="#000000" stroke="#000000" points="179.679,-228.167 169.11,-227.427 176.91,-234.596 179.679,-228.167"/>
</g>
<!-- m_ts_hartree -->
<g id="proc~~dhscf~~UsesGraph_node30" class="node"><title>m_ts_hartree</title>
<polygon fill="#337ab7" stroke="#337ab7" points="180,-192 104,-192 104,-168 180,-168 180,-192"/>
<text text-anchor="middle" x="142" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_hartree</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_hartree -->
<g id="proc~~dhscf~~UsesGraph_edge29" class="edge"><title>proc~dhscf&#45;&gt;m_ts_hartree</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.923,-642.905C254.281,-578.192 248.325,-273.108 193,-201 191.603,-199.179 190.019,-197.515 188.296,-195.993"/>
<polygon fill="#000000" stroke="#000000" points="190.203,-193.056 180.001,-190.198 186.194,-198.795 190.203,-193.056"/>
</g>
<!-- iogrid_netcdf -->
<g id="proc~~dhscf~~UsesGraph_node31" class="node"><title>iogrid_netcdf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="179,-150 105,-150 105,-126 179,-126 179,-150"/>
<text text-anchor="middle" x="142" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">iogrid_netcdf</text>
</g>
<!-- proc~dhscf&#45;&gt;iogrid_netcdf -->
<g id="proc~~dhscf~~UsesGraph_edge30" class="edge"><title>proc~dhscf&#45;&gt;iogrid_netcdf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.079,-642.707C255.285,-574.055 253.167,-238.35 193,-159 191.407,-156.899 189.565,-155.007 187.546,-153.303"/>
<polygon fill="#000000" stroke="#000000" points="189.302,-150.266 179.044,-147.616 185.41,-156.085 189.302,-150.266"/>
</g>
<!-- alloc -->
<g id="proc~~dhscf~~UsesGraph_node32" class="node"><title>alloc</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54.5,-400 0.5,-400 0.5,-376 54.5,-376 54.5,-400"/>
<text text-anchor="middle" x="27.5" y="-385.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge31" class="edge"><title>proc~dhscf&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.892,-642.995C253.934,-608.244 246.462,-506.388 193,-449 176.796,-431.606 162.045,-444.228 143,-430"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M141,-430C140.17,-429.38 96.9479,-413.319 64.3287,-401.243"/>
<polygon fill="#000000" stroke="#000000" points="65.1977,-397.832 54.6045,-397.644 62.7683,-404.397 65.1977,-397.832"/>
</g>
<!-- atmfuncs -->
<g id="proc~~dhscf~~UsesGraph_node33" class="node"><title>atmfuncs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="170,-108 114,-108 114,-84 170,-84 170,-108"/>
<text text-anchor="middle" x="142" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">atmfuncs</text>
</g>
<!-- proc~dhscf&#45;&gt;atmfuncs -->
<g id="proc~~dhscf~~UsesGraph_edge32" class="edge"><title>proc~dhscf&#45;&gt;atmfuncs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.213,-642.629C256.224,-570.422 258.055,-203.658 193,-117 189.415,-112.225 184.538,-108.526 179.228,-105.665"/>
<polygon fill="#000000" stroke="#000000" points="180.598,-102.444 170.037,-101.596 177.764,-108.845 180.598,-102.444"/>
</g>
<!-- fdf -->
<g id="proc~~dhscf~~UsesGraph_node34" class="node"><title>fdf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-66 115,-66 115,-42 169,-42 169,-66"/>
<text text-anchor="middle" x="142" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">fdf</text>
</g>
<!-- proc~dhscf&#45;&gt;fdf -->
<g id="proc~~dhscf~~UsesGraph_edge33" class="edge"><title>proc~dhscf&#45;&gt;fdf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.441,-642.942C250.688,-563.966 228.22,-122.321 193,-75 189.291,-70.0164 184.172,-66.2066 178.616,-63.2968"/>
<polygon fill="#000000" stroke="#000000" points="179.598,-59.9101 169.027,-59.2009 176.848,-66.3475 179.598,-59.9101"/>
</g>
<!-- m_hartree_add -->
<g id="proc~~dhscf~~UsesGraph_node35" class="node"><title>m_hartree_add</title>
<polygon fill="#337ab7" stroke="#337ab7" points="185,-24 99,-24 99,-0 185,-0 185,-24"/>
<text text-anchor="middle" x="142" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_hartree_add</text>
</g>
<!-- proc~dhscf&#45;&gt;m_hartree_add -->
<g id="proc~~dhscf~~UsesGraph_edge34" class="edge"><title>proc~dhscf&#45;&gt;m_hartree_add</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M254.53,-642.877C251.241,-560.444 230.682,-84.0079 193,-33 192.437,-32.238 191.841,-31.5034 191.216,-30.7954"/>
<polygon fill="#000000" stroke="#000000" points="193.401,-28.0579 183.542,-24.1773 188.829,-33.3588 193.401,-28.0579"/>
</g>
<!-- module~moremeshsubs&#45;&gt;precision -->
<g id="proc~~dhscf~~UsesGraph_edge37" class="edge"><title>module~moremeshsubs&#45;&gt;precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M110.259,-482.023C96.0632,-487.575 79.1177,-494.203 64.3444,-499.981"/>
<polygon fill="#000000" stroke="#000000" points="63.0389,-496.733 55.0007,-503.635 65.5886,-503.252 63.0389,-496.733"/>
</g>
<!-- module~moremeshsubs&#45;&gt;sys -->
<g id="proc~~dhscf~~UsesGraph_edge35" class="edge"><title>module~moremeshsubs&#45;&gt;sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M97.8263,-470.768C86.9516,-470.961 75.3866,-471.166 64.8823,-471.353"/>
<polygon fill="#000000" stroke="#000000" points="64.7325,-467.855 54.7964,-471.533 64.857,-474.854 64.7325,-467.855"/>
</g>
<!-- module~moremeshsubs&#45;&gt;parallel -->
<g id="proc~~dhscf~~UsesGraph_edge38" class="edge"><title>module~moremeshsubs&#45;&gt;parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M107.246,-457.999C93.7053,-453.184 78.0818,-447.629 64.3389,-442.743"/>
<polygon fill="#000000" stroke="#000000" points="65.3157,-439.375 54.721,-439.323 62.9706,-445.971 65.3157,-439.375"/>
</g>
<!-- module~moremeshsubs&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge36" class="edge"><title>module~moremeshsubs&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M114.199,-457.884C106.438,-453.899 98.1389,-449.155 91,-444 72.9085,-430.936 71.7662,-423.726 55,-409 54.162,-408.264 53.3025,-407.522 52.4291,-406.778"/>
<polygon fill="#000000" stroke="#000000" points="54.3549,-403.83 44.4086,-400.18 49.9079,-409.236 54.3549,-403.83"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="490pt" height="32pt"
 viewBox="0.00 0.00 489.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 485.5,-28 485.5,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node"><title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24 0,-24 0,-0 54,-0 54,-24"/>
<text text-anchor="middle" x="27" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node"><title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="139.5,-24 72.5,-24 72.5,-0 139.5,-0 139.5,-24"/>
<text text-anchor="middle" x="106" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="222,-24 158,-24 158,-0 222,-0 222,-24"/>
<text text-anchor="middle" x="190" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="294,-24 240,-24 240,-0 294,-0 294,-24"/>
<text text-anchor="middle" x="267" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="366,-24 312,-24 312,-0 366,-0 366,-24"/>
<text text-anchor="middle" x="339" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="481.5,-24 384.5,-24 384.5,-0 481.5,-0 481.5,-24"/>
<text text-anchor="middle" x="433" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a submodule to the (sub)module which it is
    descended from. Dashed arrows point from a module or program unit to 
    modules which it uses.
    </p>
    </div></div></div></div>
      </li>
      
      </ul>
    </div>
    


    
    <p>Calculates the self-consistent field contributions to Hamiltonian
 matrix elements, total energy and atomic forces.</p>
<p>Coded by J.M. Soler, August 1996. July 1997.<br>
 Modified by J.D. Gale, February 2000.</p>
<h3>Units</h3>
<p>Energies in Rydbergs.<br>
 Distances in Bohr.</p>
<h3>Routines called internally</h3>
<ul>
<li>cellxc(...)    : Finds total exch-corr energy and potential</li>
<li><a href="../proc/cross.html">CROSS</a>   : Finds the cross product of two vectors</li>
<li>dfscf(...)     : Finds SCF contribution to atomic forces</li>
<li>dipole(...)    : Finds electric dipole moment</li>
<li>doping(...)    : Adds a background charge for doped systems</li>
<li>write_rho(...)     : Saves electron density on a file</li>
<li>poison(...)    : Solves Poisson equation</li>
<li>reord(...)     : Reorders electron density and potential arrays</li>
<li>rhooda(...)    : Finds Harris electron density in the mesh</li>
<li>rhoofd(...)    : Finds SCF electron density in the mesh</li>
<li>rhoofdsp(...)  : Finds SCF electron density in the mesh for</li>
<li>spiral arrangement of spins</li>
<li>timer(...)     : Finds CPU times</li>
<li>vmat(...)      : Finds matrix elements of SCF potential</li>
<li>vmatsp(...)    : Finds matrix elements of SCF potential for
                    spiral arrangement of spins</li>
<li>delk(...)      : Finds matrix elements of <script type="math/tex"> exp(i \vec{k} \cdot \vec{r}) </script>
</li>
<li>real*8 volcel( cell ) : Returns volume of unit cell</li>
</ul>
<h3>Internal variables and arrays</h3>
<ul>
<li><code>real*8  bcell(3,3)</code>    : Bulk lattice vectors</li>
<li><code>real*8  cell(3,3)</code>     : Auxiliary lattice vectors (same as ucell)</li>
<li><code>real*8  const</code>         : Auxiliary variable (constant within a loop)</li>
<li><code>real*8  DEc</code>           : Auxiliary variable to call cellxc</li>
<li><code>real*8  DEx</code>           : Auxiliary variable to call cellxc</li>
<li><code>real*8  dvol</code>          : Mesh-cell volume</li>
<li><code>real*8  Ec</code>            : Correlation energy</li>
<li><code>real*8  Ex</code>            : Exchange energy</li>
<li><code>real*8  field(3)</code>      : External electric field</li>
<li><code>integer i</code>             : General-purpose index</li>
<li><code>integer ia</code>            : Atom index</li>
<li><code>integer io</code>            : Orbital index</li>
<li><code>integer ip</code>            : Point index</li>
<li><code>integer is</code>            : Species index</li>
<li><code>logical IsDiag</code>        : Is supercell diagonal?</li>
<li><code>integer ispin</code>         : Spin index</li>
<li><code>integer j</code>             : General-purpose index</li>
<li><code>integer JDGdistr</code>      : J.D.Gale's parallel distribution of mesh points</li>
<li><code>integer myBox(2,3)</code>    : My processor's mesh box</li>
<li><code>integer nbcell</code>        : Number of independent bulk lattice vectors</li>
<li><code>integer npcc</code>          : Partial core corrections? (0=no, 1=yes)</li>
<li><code>integer nsd</code>           : Number of diagonal spin values (1 or 2)</li>
<li><code>integer ntpl</code>          : Number of mesh Total Points in unit cell
                           (including subpoints) locally</li>
<li><code>real*4  rhoatm(ntpl)</code>  : Harris electron density</li>
<li><code>real*4  rhopcc(ntpl)</code>  : Partial-core-correction density for xc</li>
<li><code>real*4  DRho(ntpl)</code>    : Selfconsistent electron density difference</li>
<li><code>real*8  rhotot</code>        : Total density at one point</li>
<li><code>real*8  rmax</code>          : Maximum orbital radius</li>
<li><code>real*8  scell(3,3)</code>    : Supercell vectors</li>
<li><code>character shape*10</code>    : Name of system shape</li>
<li><code>real*4  Vaux(ntpl)</code>    : Auxiliary potential array</li>
<li><code>real*4  Vna(ntpl)</code>     : Sum of neutral-atom potentials</li>
<li><code>real*8  volume</code>        : Unit cell volume</li>
<li><code>real*4  Vscf(ntpl)</code>    : Hartree potential of selfconsistent density</li>
<li><code>real*8  x0(3)</code>         : Center of molecule</li>
<li><code>logical harrisfun</code>     : Harris functional or Kohn-Sham?</li>
</ul>
<p>Use the functionality in the first block
 of the routine to get charge files and partial charges</p>
    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nspin%7E4"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nspin</strong></td><td><p>Number of different spin polarisations:<br>
 nspin=1 =&gt; Unpolarized, nspin=2 =&gt; polarized<br>
 nspin=4 =&gt; Noncollinear spin or spin-orbit.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-norb%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>norb</strong></td><td><p>Total number of basis orbitals in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iaorb%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iaorb</strong>(norb)</td><td><p>Atom to which each orbital belongs</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iphorb%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iphorb</strong>(norb)</td><td><p>Orbital index (within atom) of each orbital</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nuo%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nuo</strong></td><td><p>Number of orbitals in a unit cell in this node</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nuotot%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nuotot</strong></td><td><p>Number of orbitals in a unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nua%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nua</strong></td><td><p>Number of atoms in unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-na%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>na</strong></td><td><p>Number of atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-isa%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>isa</strong>(na)</td><td><p>Species index of all atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-xa%7E2"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>xa</strong>(3,na)</td><td><p>Atomic positions of all atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-indxua%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>indxua</strong>(na)</td><td><p>Index of equivalent atom in unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ntm%7E2"></span>integer,</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>ntm</strong>(3)</td><td><p>Number of mesh divisions of each cell
 vector, including subgrid.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ifa"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>ifa</strong></td><td><p>Switch which fixes whether the SCF contrib:<br>
 to atomic forces is calculated and added to fa.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-istr"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>istr</strong></td><td><p>Switch which fixes whether the SCF contrib:<br>
 to stress is calculated and added to stress.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ihmat"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iHmat</strong></td><td><p>Switch which fixes whether the Hmat matrix
 elements are calculated or not.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-filesout"></span>type(filesOut_t),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>filesOut</strong></td><td><p>Output file names (If blank =&gt; not saved)</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-maxnd%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>maxnd</strong></td><td><p>First dimension of listd and Dscf</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-numd%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>numd</strong>(nuo)</td><td><p>Number of nonzero density-matrix
 elements for each matrix row</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-listdptr%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>listdptr</strong>(nuo)</td><td><p>Pointer to start of rows of density-matrix</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-listd%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>listd</strong>(*)</td><td><p><code>listd(maxnd)</code>: Nonzero-density-matrix-element column
 indexes for each matrix row</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dscf"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Dscf</strong>(:,:)</td><td><p><code>Dscf(maxnd,h_spin_dim)</code>:<br>
 SCF density-matrix elements</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-datm%7E2"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>datm</strong>(norb)</td><td><p>Harris density-matrix diagonal elements<br>
 (atomic occupation charges of orbitals)</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-maxnh"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>maxnh</strong></td><td><p>First dimension of listh and Hmat</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-hmat"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Hmat</strong>(:,:)</td><td><p><code>Hmat(maxnh,h_spin_dim)</code>:<br>
 Hamiltonian matrix in sparse form,<br>
 to which are added the matrix elements<br>
<code>&lt;ORB_I | DeltaV | ORB_J&gt;</code>, where<br>
<code>DeltaV = Vna + Vxc(SCF) + Vhartree(RhoSCF-RhoHarris)</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-enaatm"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Enaatm</strong></td><td><p>Integral of <code>Vna * rhoatm</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-enascf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Enascf</strong></td><td><p>Integral of <code>Vna * rhoscf</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-uatm"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Uatm</strong></td><td><p>Harris hartree electron-interaction energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-uscf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Uscf</strong></td><td><p>SCF hartree electron-interaction energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-duscf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DUscf</strong></td><td><p>Electrostatic (Hartree) energy of
 <code>(rhoscf - rhoatm)</code> density</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-duext"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DUext</strong></td><td><p>Interaction energy with external electric field</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-exc"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Exc</strong></td><td><p>SCF exchange-correlation energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dxc"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Dxc</strong></td><td><p>SCF double-counting correction to Exc<br>
<code>Dxc = integral of ( (epsxc - Vxc) * Rho )</code><br>
 All energies in Rydbergs</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dipol"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>dipol</strong>(3)</td><td><p>Electric dipole (in a.u.)
 only when the system is a molecule</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-stress"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>stress</strong>(3,3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-fal%7E2"></span>real(kind=dp),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Fal</strong>(3,nua)</td><td><p>Atomic forces, to which the SCF contribution
 is added by this routine when <code>ifa=1</code>.
 The SCF contribution is minus the derivative
 of <code>(Enascf - Enaatm + DUscf + Exc)</code> with
 respect to atomic positions, in Ry/Bohr.
 Contributions local to this node.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-stressl%7E2"></span>real(kind=dp),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>stressl</strong>(3,3)</td><td><p>Stress tensor, to which the SCF contribution
 is added by this routine when <code>ifa=1</code>.
 The SCF contribution is minus the derivative of
 <code>(Enascf - Enaatm + DUscf + Exc) / volume</code>
 with respect to the strain tensor, in Ry.
 Contributions local to this node.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-use_rhog_in"></span>logical,</td>
  <td>intent(in),</td>
  <td>optional</td>
  
  <td></td><td>::</td>
  <td><strong>use_rhog_in</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-charge_density_only"></span>logical,</td>
  <td>intent(in),</td>
  <td>optional</td>
  
  <td></td><td>::</td>
  <td><strong>charge_density_only</strong></td><td></td>
  
</tr>

</tbody>
</table>

    
    
    
    <br>
    
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Calls</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~CallsGraph Pages: 1 -->
<svg id="procdhscfCallsGraph" width="579pt" height="1725pt"
 viewBox="0.00 0.00 579.00 1725.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 1721)">
<title>proc~~dhscf~~CallsGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1721 575,-1721 575,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~CallsGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="54,-780 0,-780 0,-756 54,-756 54,-780"/>
<text text-anchor="middle" x="27" y="-765.6" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- elecs -->
<g id="proc~~dhscf~~CallsGraph_node2" class="node"><title>elecs</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-1717 129.5,-1717 129.5,-1693 183.5,-1693 183.5,-1717"/>
<text text-anchor="middle" x="156.5" y="-1702.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">elecs</text>
</g>
<!-- proc~dhscf&#45;&gt;elecs -->
<g id="proc~~dhscf~~CallsGraph_edge6" class="edge"><title>proc~dhscf&#45;&gt;elecs</title>
<path fill="none" stroke="#000000" d="M28.0535,-780.069C28.6053,-882.407 34.4552,-1602.89 90,-1679 97.0844,-1688.71 108.375,-1694.79 119.602,-1698.61"/>
<polygon fill="#000000" stroke="#000000" points="118.766,-1702.01 129.344,-1701.41 120.7,-1695.28 118.766,-1702.01"/>
</g>
<!-- re_alloc -->
<g id="proc~~dhscf~~CallsGraph_node3" class="node"><title>re_alloc</title>
<polygon fill="#777777" stroke="#777777" points="571,-1498 517,-1498 517,-1474 571,-1474 571,-1498"/>
<text text-anchor="middle" x="544" y="-1483.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">re_alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge2" class="edge"><title>proc~dhscf&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M28.3286,-780.277C30.8387,-870.557 48.0236,-1429.94 90,-1491 141.382,-1565.74 405.065,-1657.59 481,-1608 514.324,-1586.24 498.092,-1561.02 517,-1526 520.49,-1519.54 524.682,-1512.75 528.671,-1506.64"/>
<polygon fill="#000000" stroke="#000000" points="531.607,-1508.55 534.265,-1498.29 525.791,-1504.65 531.607,-1508.55"/>
</g>
<!-- ts_voltage -->
<g id="proc~~dhscf~~CallsGraph_node4" class="node"><title>ts_voltage</title>
<polygon fill="#777777" stroke="#777777" points="187,-1158 126,-1158 126,-1134 187,-1134 187,-1158"/>
<text text-anchor="middle" x="156.5" y="-1143.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ts_voltage</text>
</g>
<!-- proc~dhscf&#45;&gt;ts_voltage -->
<g id="proc~~dhscf~~CallsGraph_edge3" class="edge"><title>proc~dhscf&#45;&gt;ts_voltage</title>
<path fill="none" stroke="#000000" d="M28.4632,-780.089C30.8533,-836.298 43.5352,-1071.62 90,-1125 96.7624,-1132.77 106.403,-1137.69 116.215,-1140.79"/>
<polygon fill="#000000" stroke="#000000" points="115.425,-1144.2 125.984,-1143.33 117.186,-1137.43 115.425,-1144.2"/>
</g>
<!-- mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_node5" class="node"><title>mpi_barrier</title>
<polygon fill="#777777" stroke="#777777" points="471.5,-1599 404.5,-1599 404.5,-1575 471.5,-1575 471.5,-1599"/>
<text text-anchor="middle" x="438" y="-1584.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_barrier</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_edge4" class="edge"><title>proc~dhscf&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M28.4268,-780.254C31.4984,-865.734 51.2218,-1371.12 90,-1426 162.842,-1529.08 318.789,-1567.85 394.292,-1580.98"/>
<polygon fill="#000000" stroke="#000000" points="393.956,-1584.47 404.395,-1582.66 395.108,-1577.56 393.956,-1584.47"/>
</g>
<!-- ts_hartree_fix -->
<g id="proc~~dhscf~~CallsGraph_node6" class="node"><title>ts_hartree_fix</title>
<polygon fill="#777777" stroke="#777777" points="195.5,-1116 117.5,-1116 117.5,-1092 195.5,-1092 195.5,-1116"/>
<text text-anchor="middle" x="156.5" y="-1101.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ts_hartree_fix</text>
</g>
<!-- proc~dhscf&#45;&gt;ts_hartree_fix -->
<g id="proc~~dhscf~~CallsGraph_edge5" class="edge"><title>proc~dhscf&#45;&gt;ts_hartree_fix</title>
<path fill="none" stroke="#000000" d="M28.7651,-780.04C32.3001,-832.01 48.6751,-1036.58 90,-1083 94.8587,-1088.46 101.137,-1092.51 107.878,-1095.51"/>
<polygon fill="#000000" stroke="#000000" points="106.675,-1098.79 117.268,-1098.98 109.106,-1092.23 106.675,-1098.79"/>
</g>
<!-- volcel -->
<g id="proc~~dhscf~~CallsGraph_node7" class="node"><title>volcel</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-1074 129.5,-1074 129.5,-1050 183.5,-1050 183.5,-1074"/>
<text text-anchor="middle" x="156.5" y="-1059.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">volcel</text>
</g>
<!-- proc~dhscf&#45;&gt;volcel -->
<g id="proc~~dhscf~~CallsGraph_edge1" class="edge"><title>proc~dhscf&#45;&gt;volcel</title>
<path fill="none" stroke="#000000" d="M29.1573,-780.015C33.9611,-827.51 53.7923,-1001.5 90,-1041 97.6606,-1049.36 108.648,-1054.4 119.44,-1057.45"/>
<polygon fill="#000000" stroke="#000000" points="118.663,-1060.86 129.196,-1059.71 120.248,-1054.04 118.663,-1060.86"/>
</g>
<!-- ddot -->
<g id="proc~~dhscf~~CallsGraph_node8" class="node"><title>ddot</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-1032 129.5,-1032 129.5,-1008 183.5,-1008 183.5,-1032"/>
<text text-anchor="middle" x="156.5" y="-1017.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddot</text>
</g>
<!-- proc~dhscf&#45;&gt;ddot -->
<g id="proc~~dhscf~~CallsGraph_edge7" class="edge"><title>proc~dhscf&#45;&gt;ddot</title>
<path fill="none" stroke="#000000" d="M27.4889,-780.21C26.5915,-818.127 29.1231,-935.126 90,-999 97.7419,-1007.12 108.626,-1012.11 119.301,-1015.17"/>
<polygon fill="#000000" stroke="#000000" points="118.826,-1018.66 129.364,-1017.56 120.44,-1011.85 118.826,-1018.66"/>
</g>
<!-- jms_setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_node9" class="node"><title>jms_setmeshdistr</title>
<polygon fill="#777777" stroke="#777777" points="204.5,-990 108.5,-990 108.5,-966 204.5,-966 204.5,-990"/>
<text text-anchor="middle" x="156.5" y="-975.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">jms_setmeshdistr</text>
</g>
<!-- proc~dhscf&#45;&gt;jms_setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge8" class="edge"><title>proc~dhscf&#45;&gt;jms_setmeshdistr</title>
<path fill="none" stroke="#000000" d="M28.3469,-780.103C29.96,-813.248 39.0391,-906.381 90,-957 92.8263,-959.807 96.0283,-962.24 99.46,-964.347"/>
<polygon fill="#000000" stroke="#000000" points="97.8881,-967.474 108.38,-968.944 101.095,-961.252 97.8881,-967.474"/>
</g>
<!-- mpitrace_restart -->
<g id="proc~~dhscf~~CallsGraph_node10" class="node"><title>mpitrace_restart</title>
<polygon fill="#777777" stroke="#777777" points="202,-948 111,-948 111,-924 202,-924 202,-948"/>
<text text-anchor="middle" x="156.5" y="-933.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpitrace_restart</text>
</g>
<!-- proc~dhscf&#45;&gt;mpitrace_restart -->
<g id="proc~~dhscf~~CallsGraph_edge9" class="edge"><title>proc~dhscf&#45;&gt;mpitrace_restart</title>
<path fill="none" stroke="#000000" d="M29.6677,-780.236C34.1288,-808.232 48.9235,-877.421 90,-915 93.4128,-918.122 97.2924,-920.78 101.419,-923.043"/>
<polygon fill="#000000" stroke="#000000" points="100.221,-926.346 110.764,-927.393 103.175,-920 100.221,-926.346"/>
</g>
<!-- bsc_cellxc -->
<g id="proc~~dhscf~~CallsGraph_node11" class="node"><title>bsc_cellxc</title>
<polygon fill="#777777" stroke="#777777" points="187,-906 126,-906 126,-882 187,-882 187,-906"/>
<text text-anchor="middle" x="156.5" y="-891.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">bsc_cellxc</text>
</g>
<!-- proc~dhscf&#45;&gt;bsc_cellxc -->
<g id="proc~~dhscf~~CallsGraph_edge10" class="edge"><title>proc~dhscf&#45;&gt;bsc_cellxc</title>
<path fill="none" stroke="#000000" d="M31.9705,-780.334C39.6409,-802.22 58.5685,-847.902 90,-873 97.5382,-879.019 106.841,-883.331 116.044,-886.413"/>
<polygon fill="#000000" stroke="#000000" points="115.323,-889.849 125.903,-889.298 117.289,-883.13 115.323,-889.849"/>
</g>
<!-- write_grid_netcdf -->
<g id="proc~~dhscf~~CallsGraph_node12" class="node"><title>write_grid_netcdf</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-864 109.5,-864 109.5,-840 203.5,-840 203.5,-864"/>
<text text-anchor="middle" x="156.5" y="-849.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_grid_netcdf</text>
</g>
<!-- proc~dhscf&#45;&gt;write_grid_netcdf -->
<g id="proc~~dhscf~~CallsGraph_edge11" class="edge"><title>proc~dhscf&#45;&gt;write_grid_netcdf</title>
<path fill="none" stroke="#000000" d="M37.1592,-780.424C48.2054,-794.576 68.0459,-817.485 90,-831 93.1874,-832.962 96.5762,-834.759 100.069,-836.401"/>
<polygon fill="#000000" stroke="#000000" points="98.9194,-839.715 109.492,-840.394 101.651,-833.27 98.9194,-839.715"/>
</g>
<!-- proc~setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_node13" class="node"><title>proc~setmeshdistr</title>
<g id="a_proc~~dhscf~~CallsGraph_node13"><a xlink:href=".././proc/setmeshdistr.html" xlink:title="setMeshDistr">
<polygon fill="#d9534f" stroke="#d9534f" points="194,-822 119,-822 119,-798 194,-798 194,-822"/>
<text text-anchor="middle" x="156.5" y="-807.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">setMeshDistr</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge12" class="edge"><title>proc~dhscf&#45;&gt;proc~setmeshdistr</title>
<path fill="none" stroke="#000000" d="M54.2142,-776.985C65.249,-780.739 78.2353,-785.122 90,-789 96.1031,-791.012 102.535,-793.106 108.887,-795.158"/>
<polygon fill="#000000" stroke="#000000" points="108.153,-798.599 118.745,-798.332 110.299,-791.936 108.153,-798.599"/>
</g>
<!-- rhoofd -->
<g id="proc~~dhscf~~CallsGraph_node14" class="node"><title>rhoofd</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-780 129.5,-780 129.5,-756 183.5,-756 183.5,-780"/>
<text text-anchor="middle" x="156.5" y="-765.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">rhoofd</text>
</g>
<!-- proc~dhscf&#45;&gt;rhoofd -->
<g id="proc~~dhscf~~CallsGraph_edge16" class="edge"><title>proc~dhscf&#45;&gt;rhoofd</title>
<path fill="none" stroke="#000000" d="M54.1092,-768C72.9314,-768 98.574,-768 119.362,-768"/>
<polygon fill="#000000" stroke="#000000" points="119.426,-771.5 129.426,-768 119.426,-764.5 119.426,-771.5"/>
</g>
<!-- bye -->
<g id="proc~~dhscf~~CallsGraph_node15" class="node"><title>bye</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-738 129.5,-738 129.5,-714 183.5,-714 183.5,-738"/>
<text text-anchor="middle" x="156.5" y="-723.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">bye</text>
</g>
<!-- proc~dhscf&#45;&gt;bye -->
<g id="proc~~dhscf~~CallsGraph_edge13" class="edge"><title>proc~dhscf&#45;&gt;bye</title>
<path fill="none" stroke="#000000" d="M54.2142,-759.015C65.249,-755.261 78.2353,-750.878 90,-747 99.5959,-743.837 110.004,-740.471 119.638,-737.381"/>
<polygon fill="#000000" stroke="#000000" points="120.873,-740.661 129.332,-734.282 118.742,-733.993 120.873,-740.661"/>
</g>
<!-- get_field_from_dipole -->
<g id="proc~~dhscf~~CallsGraph_node16" class="node"><title>get_field_from_dipole</title>
<polygon fill="#777777" stroke="#777777" points="214,-696 99,-696 99,-672 214,-672 214,-696"/>
<text text-anchor="middle" x="156.5" y="-681.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">get_field_from_dipole</text>
</g>
<!-- proc~dhscf&#45;&gt;get_field_from_dipole -->
<g id="proc~~dhscf~~CallsGraph_edge14" class="edge"><title>proc~dhscf&#45;&gt;get_field_from_dipole</title>
<path fill="none" stroke="#000000" d="M37.1592,-755.576C48.2054,-741.424 68.0459,-718.515 90,-705 92.9363,-703.192 96.0436,-701.525 99.2458,-699.99"/>
<polygon fill="#000000" stroke="#000000" points="100.67,-703.188 108.459,-696.006 97.8912,-696.763 100.67,-703.188"/>
</g>
<!-- vmatsp -->
<g id="proc~~dhscf~~CallsGraph_node17" class="node"><title>vmatsp</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-654 129.5,-654 129.5,-630 183.5,-630 183.5,-654"/>
<text text-anchor="middle" x="156.5" y="-639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vmatsp</text>
</g>
<!-- proc~dhscf&#45;&gt;vmatsp -->
<g id="proc~~dhscf~~CallsGraph_edge15" class="edge"><title>proc~dhscf&#45;&gt;vmatsp</title>
<path fill="none" stroke="#000000" d="M31.9705,-755.666C39.6409,-733.78 58.5685,-688.098 90,-663 98.5567,-656.167 109.387,-651.535 119.764,-648.404"/>
<polygon fill="#000000" stroke="#000000" points="120.71,-651.774 129.486,-645.838 118.924,-645.006 120.71,-651.774"/>
</g>
<!-- add_potential_from_field -->
<g id="proc~~dhscf~~CallsGraph_node18" class="node"><title>add_potential_from_field</title>
<polygon fill="#777777" stroke="#777777" points="221.5,-612 91.5,-612 91.5,-588 221.5,-588 221.5,-612"/>
<text text-anchor="middle" x="156.5" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">add_potential_from_field</text>
</g>
<!-- proc~dhscf&#45;&gt;add_potential_from_field -->
<g id="proc~~dhscf~~CallsGraph_edge18" class="edge"><title>proc~dhscf&#45;&gt;add_potential_from_field</title>
<path fill="none" stroke="#000000" d="M29.6677,-755.764C34.1288,-727.768 48.9235,-658.579 90,-621 91.3326,-619.781 92.7364,-618.632 94.1984,-617.551"/>
<polygon fill="#000000" stroke="#000000" points="96.4386,-620.281 103.116,-612.055 92.7661,-614.322 96.4386,-620.281"/>
</g>
<!-- hartree_add -->
<g id="proc~~dhscf~~CallsGraph_node19" class="node"><title>hartree_add</title>
<polygon fill="#777777" stroke="#777777" points="192,-570 121,-570 121,-546 192,-546 192,-570"/>
<text text-anchor="middle" x="156.5" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">hartree_add</text>
</g>
<!-- proc~dhscf&#45;&gt;hartree_add -->
<g id="proc~~dhscf~~CallsGraph_edge17" class="edge"><title>proc~dhscf&#45;&gt;hartree_add</title>
<path fill="none" stroke="#000000" d="M28.3469,-755.897C29.96,-722.752 39.0391,-629.619 90,-579 95.9029,-573.137 103.444,-568.909 111.295,-565.862"/>
<polygon fill="#000000" stroke="#000000" points="112.525,-569.142 120.935,-562.699 110.343,-562.491 112.525,-569.142"/>
</g>
<!-- proc~reord -->
<g id="proc~~dhscf~~CallsGraph_node20" class="node"><title>proc~reord</title>
<g id="a_proc~~dhscf~~CallsGraph_node20"><a xlink:href=".././proc/reord.html" xlink:title="reord">
<polygon fill="#d9534f" stroke="#d9534f" points="465,-1519 411,-1519 411,-1495 465,-1495 465,-1519"/>
<text text-anchor="middle" x="438" y="-1504.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">reord</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~reord -->
<g id="proc~~dhscf~~CallsGraph_edge19" class="edge"><title>proc~dhscf&#45;&gt;proc~reord</title>
<path fill="none" stroke="#000000" d="M28.5188,-780.154C32.055,-860.749 53.57,-1316.37 90,-1365 166.252,-1466.79 328.248,-1495.92 400.681,-1504.01"/>
<polygon fill="#000000" stroke="#000000" points="400.388,-1507.5 410.697,-1505.05 401.115,-1500.53 400.388,-1507.5"/>
</g>
<!-- rhoofdsp -->
<g id="proc~~dhscf~~CallsGraph_node21" class="node"><title>rhoofdsp</title>
<polygon fill="#777777" stroke="#777777" points="184,-528 129,-528 129,-504 184,-504 184,-528"/>
<text text-anchor="middle" x="156.5" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">rhoofdsp</text>
</g>
<!-- proc~dhscf&#45;&gt;rhoofdsp -->
<g id="proc~~dhscf~~CallsGraph_edge25" class="edge"><title>proc~dhscf&#45;&gt;rhoofdsp</title>
<path fill="none" stroke="#000000" d="M27.4889,-755.79C26.5915,-717.873 29.1231,-600.874 90,-537 97.617,-529.008 108.275,-524.05 118.785,-520.976"/>
<polygon fill="#000000" stroke="#000000" points="119.817,-524.327 128.711,-518.569 118.168,-517.524 119.817,-524.327"/>
</g>
<!-- compute_partial_charges -->
<g id="proc~~dhscf~~CallsGraph_node22" class="node"><title>compute_partial_charges</title>
<polygon fill="#777777" stroke="#777777" points="223,-486 90,-486 90,-462 223,-462 223,-486"/>
<text text-anchor="middle" x="156.5" y="-471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">compute_partial_charges</text>
</g>
<!-- proc~dhscf&#45;&gt;compute_partial_charges -->
<g id="proc~~dhscf~~CallsGraph_edge21" class="edge"><title>proc~dhscf&#45;&gt;compute_partial_charges</title>
<path fill="none" stroke="#000000" d="M29.1573,-755.985C33.9611,-708.49 53.7923,-534.501 90,-495 90.9078,-494.01 91.8623,-493.066 92.8576,-492.166"/>
<polygon fill="#000000" stroke="#000000" points="95.1649,-494.816 101.191,-486.102 91.046,-489.156 95.1649,-494.816"/>
</g>
<!-- write_tdrho -->
<g id="proc~~dhscf~~CallsGraph_node23" class="node"><title>write_tdrho</title>
<polygon fill="#777777" stroke="#777777" points="189.5,-444 123.5,-444 123.5,-420 189.5,-420 189.5,-444"/>
<text text-anchor="middle" x="156.5" y="-429.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_tdrho</text>
</g>
<!-- proc~dhscf&#45;&gt;write_tdrho -->
<g id="proc~~dhscf~~CallsGraph_edge22" class="edge"><title>proc~dhscf&#45;&gt;write_tdrho</title>
<path fill="none" stroke="#000000" d="M28.7651,-755.96C32.3001,-703.99 48.6751,-499.416 90,-453 96.2397,-445.992 104.82,-441.307 113.716,-438.18"/>
<polygon fill="#000000" stroke="#000000" points="114.774,-441.517 123.398,-435.362 112.818,-434.796 114.774,-441.517"/>
</g>
<!-- dfscf -->
<g id="proc~~dhscf~~CallsGraph_node24" class="node"><title>dfscf</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-402 129.5,-402 129.5,-378 183.5,-378 183.5,-402"/>
<text text-anchor="middle" x="156.5" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dfscf</text>
</g>
<!-- proc~dhscf&#45;&gt;dfscf -->
<g id="proc~~dhscf~~CallsGraph_edge23" class="edge"><title>proc~dhscf&#45;&gt;dfscf</title>
<path fill="none" stroke="#000000" d="M28.4632,-755.911C30.8533,-699.702 43.5352,-464.38 90,-411 97.5035,-402.38 108.551,-397.27 119.444,-394.25"/>
<polygon fill="#000000" stroke="#000000" points="120.315,-397.642 129.298,-392.024 118.772,-390.814 120.315,-397.642"/>
</g>
<!-- write_rho -->
<g id="proc~~dhscf~~CallsGraph_node25" class="node"><title>write_rho</title>
<polygon fill="#777777" stroke="#777777" points="185,-360 128,-360 128,-336 185,-336 185,-360"/>
<text text-anchor="middle" x="156.5" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_rho</text>
</g>
<!-- proc~dhscf&#45;&gt;write_rho -->
<g id="proc~~dhscf~~CallsGraph_edge24" class="edge"><title>proc~dhscf&#45;&gt;write_rho</title>
<path fill="none" stroke="#000000" d="M28.225,-755.73C29.576,-695.249 38.4104,-429.344 90,-369 97.1155,-360.677 107.537,-355.622 117.983,-352.562"/>
<polygon fill="#000000" stroke="#000000" points="118.984,-355.922 127.9,-350.198 117.36,-349.113 118.984,-355.922"/>
</g>
<!-- partialcoreonmesh -->
<g id="proc~~dhscf~~CallsGraph_node26" class="node"><title>partialcoreonmesh</title>
<polygon fill="#777777" stroke="#777777" points="207,-318 106,-318 106,-294 207,-294 207,-318"/>
<text text-anchor="middle" x="156.5" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">partialcoreonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;partialcoreonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge20" class="edge"><title>proc~dhscf&#45;&gt;partialcoreonmesh</title>
<path fill="none" stroke="#000000" d="M28.0248,-755.746C28.3984,-691.552 33.2117,-394.407 90,-327 92.1543,-324.443 94.621,-322.194 97.3058,-320.216"/>
<polygon fill="#000000" stroke="#000000" points="99.1375,-323.199 105.921,-315.06 95.5428,-317.192 99.1375,-323.199"/>
</g>
<!-- mymeshbox -->
<g id="proc~~dhscf~~CallsGraph_node27" class="node"><title>mymeshbox</title>
<polygon fill="#777777" stroke="#777777" points="191.5,-276 121.5,-276 121.5,-252 191.5,-252 191.5,-276"/>
<text text-anchor="middle" x="156.5" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mymeshbox</text>
</g>
<!-- proc~dhscf&#45;&gt;mymeshbox -->
<g id="proc~~dhscf~~CallsGraph_edge26" class="edge"><title>proc~dhscf&#45;&gt;mymeshbox</title>
<path fill="none" stroke="#000000" d="M27.8606,-755.942C27.3236,-688.617 27.9417,-359.566 90,-285 95.6004,-278.271 103.365,-273.674 111.595,-270.539"/>
<polygon fill="#000000" stroke="#000000" points="112.863,-273.81 121.368,-267.491 110.779,-267.127 112.863,-273.81"/>
</g>
<!-- neutralatomonmesh -->
<g id="proc~~dhscf~~CallsGraph_node28" class="node"><title>neutralatomonmesh</title>
<polygon fill="#777777" stroke="#777777" points="210.5,-234 102.5,-234 102.5,-210 210.5,-210 210.5,-234"/>
<text text-anchor="middle" x="156.5" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">neutralatomonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;neutralatomonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge27" class="edge"><title>proc~dhscf&#45;&gt;neutralatomonmesh</title>
<path fill="none" stroke="#000000" d="M27.7211,-755.841C26.3385,-684.884 22.7479,-324.643 90,-243 91.2812,-241.445 92.6782,-240.003 94.17,-238.667"/>
<polygon fill="#000000" stroke="#000000" points="96.2307,-241.496 102.323,-232.828 92.1552,-235.805 96.2307,-241.496"/>
</g>
<!-- interface~distmeshdata -->
<g id="proc~~dhscf~~CallsGraph_node29" class="node"><title>interface~distmeshdata</title>
<g id="a_proc~~dhscf~~CallsGraph_node29"><a xlink:href=".././interface/distmeshdata.html" xlink:title="distMeshData">
<polygon fill="#a7506f" stroke="#a7506f" points="195.5,-1356 117.5,-1356 117.5,-1332 195.5,-1332 195.5,-1356"/>
<text text-anchor="middle" x="156.5" y="-1341.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;interface~distmeshdata -->
<g id="proc~~dhscf~~CallsGraph_edge28" class="edge"><title>proc~dhscf&#45;&gt;interface~distmeshdata</title>
<path fill="none" stroke="#000000" d="M27.7302,-780.188C26.355,-852.954 22.6049,-1229.82 90,-1318 94.648,-1324.08 100.936,-1328.74 107.785,-1332.32"/>
<polygon fill="#000000" stroke="#000000" points="106.809,-1335.71 117.371,-1336.54 109.634,-1329.31 106.809,-1335.71"/>
</g>
<!-- die -->
<g id="proc~~dhscf~~CallsGraph_node30" class="node"><title>die</title>
<polygon fill="#777777" stroke="#777777" points="465,-1317 411,-1317 411,-1293 465,-1293 465,-1317"/>
<text text-anchor="middle" x="438" y="-1302.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">die</text>
</g>
<!-- proc~dhscf&#45;&gt;die -->
<g id="proc~~dhscf~~CallsGraph_edge29" class="edge"><title>proc~dhscf&#45;&gt;die</title>
<path fill="none" stroke="#000000" d="M27.9328,-780.422C27.8215,-846.87 30.4994,-1159.97 90,-1231 167.289,-1323.26 328.739,-1317.79 400.855,-1310.03"/>
<polygon fill="#000000" stroke="#000000" points="401.294,-1313.51 410.827,-1308.88 400.492,-1306.55 401.294,-1313.51"/>
</g>
<!-- timer -->
<g id="proc~~dhscf~~CallsGraph_node31" class="node"><title>timer</title>
<polygon fill="#777777" stroke="#777777" points="571,-1559 517,-1559 517,-1535 571,-1535 571,-1559"/>
<text text-anchor="middle" x="544" y="-1544.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">timer</text>
</g>
<!-- proc~dhscf&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge30" class="edge"><title>proc~dhscf&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M28.2086,-780.037C29.9256,-873.561 42.8715,-1482.19 90,-1547 194.43,-1690.6 322.033,-1708.1 481,-1629 506.288,-1616.42 524.005,-1588.05 533.847,-1568.23"/>
<polygon fill="#000000" stroke="#000000" points="537.084,-1569.57 538.16,-1559.03 530.746,-1566.6 537.084,-1569.57"/>
</g>
<!-- mpi_allreduce -->
<g id="proc~~dhscf~~CallsGraph_node32" class="node"><title>mpi_allreduce</title>
<polygon fill="#777777" stroke="#777777" points="196,-192 117,-192 117,-168 196,-168 196,-192"/>
<text text-anchor="middle" x="156.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_allreduce</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_allreduce -->
<g id="proc~~dhscf~~CallsGraph_edge31" class="edge"><title>proc~dhscf&#45;&gt;mpi_allreduce</title>
<path fill="none" stroke="#000000" d="M28.5395,-755.924C32.1309,-677.794 53.5577,-245.632 90,-201 94.5163,-195.469 100.496,-191.376 107.01,-188.351"/>
<polygon fill="#000000" stroke="#000000" points="108.71,-191.45 116.827,-184.64 106.235,-184.902 108.71,-191.45"/>
</g>
<!-- forhar -->
<g id="proc~~dhscf~~CallsGraph_node33" class="node"><title>forhar</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-150 129.5,-150 129.5,-126 183.5,-126 183.5,-150"/>
<text text-anchor="middle" x="156.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">forhar</text>
</g>
<!-- proc~dhscf&#45;&gt;forhar -->
<g id="proc~~dhscf~~CallsGraph_edge32" class="edge"><title>proc~dhscf&#45;&gt;forhar</title>
<path fill="none" stroke="#000000" d="M28.4475,-755.831C31.5539,-674.126 50.9425,-207.2 90,-159 97.2526,-150.05 108.34,-144.863 119.343,-141.874"/>
<polygon fill="#000000" stroke="#000000" points="120.285,-145.251 129.311,-139.702 118.795,-138.411 120.285,-145.251"/>
</g>
<!-- vacuum_level -->
<g id="proc~~dhscf~~CallsGraph_node34" class="node"><title>vacuum_level</title>
<polygon fill="#777777" stroke="#777777" points="195.5,-108 117.5,-108 117.5,-84 195.5,-84 195.5,-108"/>
<text text-anchor="middle" x="156.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vacuum_level</text>
</g>
<!-- proc~dhscf&#45;&gt;vacuum_level -->
<g id="proc~~dhscf~~CallsGraph_edge33" class="edge"><title>proc~dhscf&#45;&gt;vacuum_level</title>
<path fill="none" stroke="#000000" d="M28.3638,-755.823C31.0036,-670.881 48.3099,-168.793 90,-117 94.6846,-111.18 100.991,-106.951 107.848,-103.882"/>
<polygon fill="#000000" stroke="#000000" points="109.247,-107.097 117.437,-100.376 106.843,-100.522 109.247,-107.097"/>
</g>
<!-- de_alloc -->
<g id="proc~~dhscf~~CallsGraph_node35" class="node"><title>de_alloc</title>
<polygon fill="#777777" stroke="#777777" points="571,-1277 517,-1277 517,-1253 571,-1253 571,-1277"/>
<text text-anchor="middle" x="544" y="-1262.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">de_alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge34" class="edge"><title>proc~dhscf&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M27.8803,-780.208C27.5608,-841.551 29.5732,-1115.24 90,-1167 222.772,-1280.73 334.599,-1028.45 481,-1124 521.464,-1150.41 535.695,-1209.79 540.566,-1242.43"/>
<polygon fill="#000000" stroke="#000000" points="537.151,-1243.31 541.926,-1252.77 544.091,-1242.4 537.151,-1243.31"/>
</g>
<!-- localchargeonmesh -->
<g id="proc~~dhscf~~CallsGraph_node36" class="node"><title>localchargeonmesh</title>
<polygon fill="#777777" stroke="#777777" points="209.5,-66 103.5,-66 103.5,-42 209.5,-42 209.5,-66"/>
<text text-anchor="middle" x="156.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">localchargeonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;localchargeonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge35" class="edge"><title>proc~dhscf&#45;&gt;localchargeonmesh</title>
<path fill="none" stroke="#000000" d="M28.2881,-755.894C30.4801,-668.058 45.66,-130.409 90,-75 91.4853,-73.144 93.1356,-71.4496 94.9163,-69.903"/>
<polygon fill="#000000" stroke="#000000" points="97.2007,-72.5795 103.452,-64.0251 93.2305,-66.8143 97.2007,-72.5795"/>
</g>
<!-- write_debug -->
<g id="proc~~dhscf~~CallsGraph_node37" class="node"><title>write_debug</title>
<polygon fill="#777777" stroke="#777777" points="473.5,-1157 402.5,-1157 402.5,-1133 473.5,-1133 473.5,-1157"/>
<text text-anchor="middle" x="438" y="-1142.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_debug</text>
</g>
<!-- proc~dhscf&#45;&gt;write_debug -->
<g id="proc~~dhscf~~CallsGraph_edge36" class="edge"><title>proc~dhscf&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M27.7203,-780.343C26.5427,-844.957 24.7285,-1143.43 90,-1200 182.915,-1280.53 344.663,-1200.13 409.226,-1162.31"/>
<polygon fill="#000000" stroke="#000000" points="411.23,-1165.19 418.027,-1157.07 407.645,-1159.18 411.23,-1165.19"/>
</g>
<!-- vmat -->
<g id="proc~~dhscf~~CallsGraph_node38" class="node"><title>vmat</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-24 129.5,-24 129.5,-0 183.5,-0 183.5,-24"/>
<text text-anchor="middle" x="156.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vmat</text>
</g>
<!-- proc~dhscf&#45;&gt;vmat -->
<g id="proc~~dhscf~~CallsGraph_edge37" class="edge"><title>proc~dhscf&#45;&gt;vmat</title>
<path fill="none" stroke="#000000" d="M28.2257,-755.75C30.0116,-664.445 43.043,-91.9852 90,-33 97.1749,-23.9872 108.243,-18.785 119.252,-15.8013"/>
<polygon fill="#000000" stroke="#000000" points="120.2,-19.1772 129.232,-13.6391 118.718,-12.3359 120.2,-19.1772"/>
</g>
<!-- meshlim -->
<g id="proc~~dhscf~~CallsGraph_node39" class="node"><title>meshlim</title>
<polygon fill="#777777" stroke="#777777" points="336,-822 282,-822 282,-798 336,-798 336,-822"/>
<text text-anchor="middle" x="309" y="-807.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">meshlim</text>
</g>
<!-- proc~setmeshdistr&#45;&gt;meshlim -->
<g id="proc~~dhscf~~CallsGraph_edge38" class="edge"><title>proc~setmeshdistr&#45;&gt;meshlim</title>
<path fill="none" stroke="#000000" d="M194.316,-810C217.861,-810 248.268,-810 271.71,-810"/>
<polygon fill="#000000" stroke="#000000" points="271.941,-813.5 281.941,-810 271.941,-806.5 271.941,-813.5"/>
</g>
<!-- proc~reord&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge39" class="edge"><title>proc~reord&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M465.244,-1501.7C477.807,-1499.16 493.054,-1496.09 506.706,-1493.33"/>
<polygon fill="#000000" stroke="#000000" points="507.655,-1496.71 516.765,-1491.3 506.27,-1489.85 507.655,-1496.71"/>
</g>
<!-- proc~reord&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge41" class="edge"><title>proc~reord&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M465.244,-1517.09C477.93,-1521.97 493.353,-1527.9 507.107,-1533.2"/>
<polygon fill="#000000" stroke="#000000" points="506.175,-1536.59 516.765,-1536.91 508.688,-1530.05 506.175,-1536.59"/>
</g>
<!-- proc~reord&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge40" class="edge"><title>proc~reord&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M449.491,-1494.58C458.777,-1483.09 472.185,-1465.24 481,-1448 509.111,-1393.02 528.852,-1322.49 537.725,-1287.2"/>
<polygon fill="#000000" stroke="#000000" points="541.233,-1287.59 540.221,-1277.04 534.435,-1285.92 541.233,-1287.59"/>
</g>
<!-- proc~distmeshdata_rea -->
<g id="proc~~dhscf~~CallsGraph_node40" class="node"><title>proc~distmeshdata_rea</title>
<g id="a_proc~~dhscf~~CallsGraph_node40"><a xlink:href=".././proc/distmeshdata_rea.html" xlink:title="distMeshData_rea">
<polygon fill="#d9534f" stroke="#d9534f" points="359,-1397 259,-1397 259,-1373 359,-1373 359,-1397"/>
<text text-anchor="middle" x="309" y="-1382.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData_rea</text>
</a>
</g>
</g>
<!-- interface~distmeshdata&#45;&gt;proc~distmeshdata_rea -->
<g id="proc~~dhscf~~CallsGraph_edge42" class="edge"><title>interface~distmeshdata&#45;&gt;proc~distmeshdata_rea</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M195.867,-1354.45C213.517,-1359.26 234.765,-1365.05 253.995,-1370.29"/>
<polygon fill="#000000" stroke="#000000" points="253.27,-1373.72 263.838,-1372.97 255.11,-1366.96 253.27,-1373.72"/>
</g>
<!-- proc~distmeshdata_int -->
<g id="proc~~dhscf~~CallsGraph_node41" class="node"><title>proc~distmeshdata_int</title>
<g id="a_proc~~dhscf~~CallsGraph_node41"><a xlink:href=".././proc/distmeshdata_int.html" xlink:title="distMeshData_int">
<polygon fill="#d9534f" stroke="#d9534f" points="356.5,-1276 261.5,-1276 261.5,-1252 356.5,-1252 356.5,-1276"/>
<text text-anchor="middle" x="309" y="-1261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData_int</text>
</a>
</g>
</g>
<!-- interface~distmeshdata&#45;&gt;proc~distmeshdata_int -->
<g id="proc~~dhscf~~CallsGraph_edge43" class="edge"><title>interface~distmeshdata&#45;&gt;proc~distmeshdata_int</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M180.358,-1331.85C206.031,-1318.2 247.856,-1295.97 276.589,-1280.7"/>
<polygon fill="#000000" stroke="#000000" points="278.233,-1283.79 285.42,-1276 274.947,-1277.61 278.233,-1283.79"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge47" class="edge"><title>proc~distmeshdata_rea&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M322.788,-1397.01C338.576,-1411.2 366.809,-1434.57 395,-1448 431.148,-1465.22 476.119,-1475.34 506.943,-1480.75"/>
<polygon fill="#000000" stroke="#000000" points="506.38,-1484.21 516.821,-1482.41 507.538,-1477.3 506.38,-1484.21"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_edge50" class="edge"><title>proc~distmeshdata_rea&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M313.233,-1397.02C321.945,-1427.55 348.446,-1509.31 395,-1561 397.637,-1563.93 400.679,-1566.64 403.897,-1569.12"/>
<polygon fill="#000000" stroke="#000000" points="401.91,-1572.01 412.127,-1574.81 405.889,-1566.25 401.91,-1572.01"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~reord -->
<g id="proc~~dhscf~~CallsGraph_edge46" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~reord</title>
<path fill="none" stroke="#000000" d="M318.956,-1397.25C333.47,-1416.56 363.677,-1454.61 395,-1481 398.488,-1483.94 402.34,-1486.78 406.253,-1489.43"/>
<polygon fill="#000000" stroke="#000000" points="404.496,-1492.47 414.802,-1494.92 408.276,-1486.57 404.496,-1492.47"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;die -->
<g id="proc~~dhscf~~CallsGraph_edge53" class="edge"><title>proc~distmeshdata_rea&#45;&gt;die</title>
<path fill="none" stroke="#000000" d="M328.866,-1372.93C346.064,-1361.94 372.191,-1345.3 395,-1331 399.427,-1328.22 404.127,-1325.3 408.718,-1322.45"/>
<polygon fill="#000000" stroke="#000000" points="410.655,-1325.36 417.313,-1317.12 406.969,-1319.41 410.655,-1325.36"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge49" class="edge"><title>proc~distmeshdata_rea&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M313.241,-1397.13C321.505,-1425.45 346.236,-1495.98 395,-1528 428.169,-1549.78 474.635,-1552.3 506.608,-1550.81"/>
<polygon fill="#000000" stroke="#000000" points="507.092,-1554.29 516.856,-1550.17 506.657,-1547.3 507.092,-1554.29"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge51" class="edge"><title>proc~distmeshdata_rea&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M359.354,-1374.2C394.967,-1364.96 443.226,-1349.41 481,-1326 498.645,-1315.07 515.218,-1298.29 526.782,-1285.09"/>
<polygon fill="#000000" stroke="#000000" points="529.49,-1287.31 533.3,-1277.42 524.156,-1282.77 529.49,-1287.31"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;write_debug -->
<g id="proc~~dhscf~~CallsGraph_edge52" class="edge"><title>proc~distmeshdata_rea&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M316.473,-1372.77C336.854,-1334.25 399.887,-1215.14 425.75,-1166.26"/>
<polygon fill="#000000" stroke="#000000" points="428.957,-1167.68 430.54,-1157.21 422.77,-1164.41 428.957,-1167.68"/>
</g>
<!-- mpitrace_event -->
<g id="proc~~dhscf~~CallsGraph_node42" class="node"><title>mpitrace_event</title>
<polygon fill="#777777" stroke="#777777" points="481,-1397 395,-1397 395,-1373 481,-1373 481,-1397"/>
<text text-anchor="middle" x="438" y="-1382.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpitrace_event</text>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;mpitrace_event -->
<g id="proc~~dhscf~~CallsGraph_edge44" class="edge"><title>proc~distmeshdata_rea&#45;&gt;mpitrace_event</title>
<path fill="none" stroke="#000000" d="M359.102,-1385C367.438,-1385 376.125,-1385 384.544,-1385"/>
<polygon fill="#000000" stroke="#000000" points="384.639,-1388.5 394.639,-1385 384.639,-1381.5 384.639,-1388.5"/>
</g>
<!-- nmeshg -->
<g id="proc~~dhscf~~CallsGraph_node43" class="node"><title>nmeshg</title>
<polygon fill="#777777" stroke="#777777" points="465,-1439 411,-1439 411,-1415 465,-1415 465,-1439"/>
<text text-anchor="middle" x="438" y="-1424.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nmeshg</text>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;nmeshg -->
<g id="proc~~dhscf~~CallsGraph_edge45" class="edge"><title>proc~distmeshdata_rea&#45;&gt;nmeshg</title>
<path fill="none" stroke="#000000" d="M346.393,-1397.04C363.549,-1402.71 383.955,-1409.46 401.054,-1415.11"/>
<polygon fill="#000000" stroke="#000000" points="400.097,-1418.48 410.69,-1418.3 402.295,-1411.84 400.097,-1418.48"/>
</g>
<!-- proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_node44" class="node"><title>proc~boxintersection</title>
<g id="a_proc~~dhscf~~CallsGraph_node44"><a xlink:href=".././proc/boxintersection.html" xlink:title="boxIntersection">
<polygon fill="#d9534f" stroke="#d9534f" points="480.5,-1275 395.5,-1275 395.5,-1251 480.5,-1251 480.5,-1275"/>
<text text-anchor="middle" x="438" y="-1260.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">boxIntersection</text>
</a>
</g>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_edge48" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~boxintersection</title>
<path fill="none" stroke="#000000" d="M317.86,-1372.72C331.5,-1352.19 361.34,-1310.53 395,-1284 396.585,-1282.75 398.256,-1281.55 399.981,-1280.39"/>
<polygon fill="#000000" stroke="#000000" points="402.145,-1283.18 408.919,-1275.03 398.543,-1277.17 402.145,-1283.18"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge57" class="edge"><title>proc~distmeshdata_int&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M332.364,-1251.88C367.829,-1234.49 437.406,-1208.1 481,-1242 516.264,-1269.42 534.743,-1408.63 540.758,-1463.61"/>
<polygon fill="#000000" stroke="#000000" points="537.294,-1464.14 541.825,-1473.71 544.255,-1463.4 537.294,-1464.14"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;die -->
<g id="proc~~dhscf~~CallsGraph_edge54" class="edge"><title>proc~distmeshdata_int&#45;&gt;die</title>
<path fill="none" stroke="#000000" d="M347.417,-1276.08C364.262,-1281.52 384.07,-1287.91 400.771,-1293.3"/>
<polygon fill="#000000" stroke="#000000" points="400.123,-1296.77 410.714,-1296.51 402.273,-1290.11 400.123,-1296.77"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge56" class="edge"><title>proc~distmeshdata_int&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M334.953,-1251.93C342.829,-1247.81 351.443,-1242.98 359,-1238 376.152,-1226.69 375.624,-1215.83 395,-1209 431.046,-1196.29 445.327,-1195.27 481,-1209 499.656,-1216.18 516.193,-1231.86 527.487,-1244.8"/>
<polygon fill="#000000" stroke="#000000" points="525.042,-1247.34 534.12,-1252.8 530.429,-1242.87 525.042,-1247.34"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_edge55" class="edge"><title>proc~distmeshdata_int&#45;&gt;proc~boxintersection</title>
<path fill="none" stroke="#000000" d="M356.569,-1263.63C365.927,-1263.56 375.814,-1263.48 385.333,-1263.41"/>
<polygon fill="#000000" stroke="#000000" points="385.504,-1266.91 395.476,-1263.33 385.449,-1259.91 385.504,-1266.91"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
     
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Called by</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~CalledByGraph Pages: 1 -->
<svg id="procdhscfCalledByGraph" width="310pt" height="74pt"
 viewBox="0.00 0.00 310.00 74.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 70)">
<title>proc~~dhscf~~CalledByGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-70 306,-70 306,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="302,-45 248,-45 248,-21 302,-21 302,-45"/>
<text text-anchor="middle" x="275" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- proc~siesta_analysis -->
<g id="proc~~dhscf~~CalledByGraph_node2" class="node"><title>proc~siesta_analysis</title>
<g id="a_proc~~dhscf~~CalledByGraph_node2"><a xlink:href=".././proc/siesta_analysis.html" xlink:title="siesta_analysis">
<polygon fill="#d9534f" stroke="#d9534f" points="204.5,-66 119.5,-66 119.5,-42 204.5,-42 204.5,-66"/>
<text text-anchor="middle" x="162" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_analysis</text>
</a>
</g>
</g>
<!-- proc~siesta_analysis&#45;&gt;proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_edge1" class="edge"><title>proc~siesta_analysis&#45;&gt;proc~dhscf</title>
<path fill="none" stroke="#000000" d="M204.648,-46.1206C215.65,-44.0392 227.428,-41.811 238.097,-39.7925"/>
<polygon fill="#000000" stroke="#000000" points="238.75,-43.2311 247.925,-37.9331 237.449,-36.3531 238.75,-43.2311"/>
</g>
<!-- proc~setup_hamiltonian -->
<g id="proc~~dhscf~~CalledByGraph_node3" class="node"><title>proc~setup_hamiltonian</title>
<g id="a_proc~~dhscf~~CalledByGraph_node3"><a xlink:href=".././proc/setup_hamiltonian.html" xlink:title="setup_hamiltonian">
<polygon fill="#d9534f" stroke="#d9534f" points="212,-24 112,-24 112,-0 212,-0 212,-24"/>
<text text-anchor="middle" x="162" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">setup_hamiltonian</text>
</a>
</g>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_edge2" class="edge"><title>proc~setup_hamiltonian&#45;&gt;proc~dhscf</title>
<path fill="none" stroke="#000000" d="M212.009,-21.272C220.666,-22.9099 229.537,-24.5881 237.763,-26.1444"/>
<polygon fill="#000000" stroke="#000000" points="237.297,-29.6183 247.774,-28.0383 238.599,-22.7403 237.297,-29.6183"/>
</g>
<!-- proc~siesta_forces -->
<g id="proc~~dhscf~~CalledByGraph_node4" class="node"><title>proc~siesta_forces</title>
<g id="a_proc~~dhscf~~CalledByGraph_node4"><a xlink:href=".././proc/siesta_forces.html" xlink:title="siesta_forces">
<polygon fill="#d9534f" stroke="#d9534f" points="76,-24 0,-24 0,-0 76,-0 76,-24"/>
<text text-anchor="middle" x="38" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_forces</text>
</a>
</g>
</g>
<!-- proc~siesta_forces&#45;&gt;proc~setup_hamiltonian -->
<g id="proc~~dhscf~~CalledByGraph_edge3" class="edge"><title>proc~siesta_forces&#45;&gt;proc~setup_hamiltonian</title>
<path fill="none" stroke="#000000" d="M76.2669,-12C84.3255,-12 93.0387,-12 101.706,-12"/>
<polygon fill="#000000" stroke="#000000" points="101.817,-15.5001 111.817,-12 101.817,-8.5001 101.817,-15.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/dhscf.html#src">dhscf</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>      <span class="k">subroutine </span><span class="n">dhscf</span><span class="p">(</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> 
     <span class="p">&amp;</span>                  <span class="n">nuotot</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">ntm</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">iHmat</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">filesOut</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">Enaatm</span><span class="p">,</span> <span class="n">Enascf</span><span class="p">,</span> <span class="n">Uatm</span><span class="p">,</span> <span class="n">Uscf</span><span class="p">,</span> <span class="n">DUscf</span><span class="p">,</span> <span class="n">DUext</span><span class="p">,</span> 
     <span class="p">&amp;</span>                  <span class="n">Exc</span><span class="p">,</span> <span class="n">Dxc</span><span class="p">,</span> <span class="n">dipol</span><span class="p">,</span> <span class="n">stress</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">use_rhog_in</span><span class="p">,</span> <span class="n">charge_density_only</span> <span class="p">)</span>
<span class="c">!! author: J.M. Soler</span>
<span class="c">!! date: August 1996</span>
<span class="c">!!</span>
<span class="c">!! Calculates the self-consistent field contributions to Hamiltonian</span>
<span class="c">!! matrix elements, total energy and atomic forces.</span>
<span class="c">!!</span>
<span class="c">!! Coded by J.M. Soler, August 1996. July 1997.  </span>
<span class="c">!! Modified by J.D. Gale, February 2000.</span>
<span class="c">!!</span>
<span class="c">!!</span>
<span class="c">!!### Units</span>
<span class="c">!! Energies in Rydbergs.  </span>
<span class="c">!! Distances in Bohr.</span>
<span class="c">!!</span>
<span class="c">!!### Routines called internally</span>
<span class="c">!! * cellxc(...)    : Finds total exch-corr energy and potential</span>
<span class="c">!! * [[cross(proc)]]   : Finds the cross product of two vectors</span>
<span class="c">!! * dfscf(...)     : Finds SCF contribution to atomic forces</span>
<span class="c">!! * dipole(...)    : Finds electric dipole moment</span>
<span class="c">!! * doping(...)    : Adds a background charge for doped systems</span>
<span class="c">!! * write_rho(...)     : Saves electron density on a file</span>
<span class="c">!! * poison(...)    : Solves Poisson equation</span>
<span class="c">!! * reord(...)     : Reorders electron density and potential arrays</span>
<span class="c">!! * rhooda(...)    : Finds Harris electron density in the mesh</span>
<span class="c">!! * rhoofd(...)    : Finds SCF electron density in the mesh</span>
<span class="c">!! * rhoofdsp(...)  : Finds SCF electron density in the mesh for</span>
<span class="c">!! *                  spiral arrangement of spins</span>
<span class="c">!! * timer(...)     : Finds CPU times</span>
<span class="c">!! * vmat(...)      : Finds matrix elements of SCF potential</span>
<span class="c">!! * vmatsp(...)    : Finds matrix elements of SCF potential for</span>
<span class="c">!!                    spiral arrangement of spins</span>
<span class="c">!! * delk(...)      : Finds matrix elements of \( exp(i \vec{k} \cdot \vec{r}) \)</span>
<span class="c">!! * real*8 volcel( cell ) : Returns volume of unit cell</span>
<span class="c">!!</span>
<span class="c">!!### Internal variables and arrays</span>
<span class="c">!! * `real*8  bcell(3,3)`    : Bulk lattice vectors</span>
<span class="c">!! * `real*8  cell(3,3)`     : Auxiliary lattice vectors (same as ucell)</span>
<span class="c">!! * `real*8  const`         : Auxiliary variable (constant within a loop)</span>
<span class="c">!! * `real*8  DEc`           : Auxiliary variable to call cellxc</span>
<span class="c">!! * `real*8  DEx`           : Auxiliary variable to call cellxc</span>
<span class="c">!! * `real*8  dvol`          : Mesh-cell volume</span>
<span class="c">!! * `real*8  Ec`            : Correlation energy</span>
<span class="c">!! * `real*8  Ex`            : Exchange energy</span>
<span class="c">!! * `real*8  field(3)`      : External electric field</span>
<span class="c">!! * `integer i`             : General-purpose index</span>
<span class="c">!! * `integer ia`            : Atom index</span>
<span class="c">!! * `integer io`            : Orbital index</span>
<span class="c">!! * `integer ip`            : Point index</span>
<span class="c">!! * `integer is`            : Species index</span>
<span class="c">!! * `logical IsDiag`        : Is supercell diagonal?</span>
<span class="c">!! * `integer ispin`         : Spin index</span>
<span class="c">!! * `integer j`             : General-purpose index</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!! * `integer JDGdistr`      : J.D.Gale&#39;s parallel distribution of mesh points</span>
<span class="c">!! * `integer myBox(2,3)`    : My processor&#39;s mesh box</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
<span class="c">!! * `integer nbcell`        : Number of independent bulk lattice vectors</span>
<span class="c">!! * `integer npcc`          : Partial core corrections? (0=no, 1=yes)</span>
<span class="c">!! * `integer nsd`           : Number of diagonal spin values (1 or 2)</span>
<span class="c">!! * `integer ntpl`          : Number of mesh Total Points in unit cell</span>
<span class="c">!!                           (including subpoints) locally</span>
<span class="c">!! * `real*4  rhoatm(ntpl)`  : Harris electron density</span>
<span class="c">!! * `real*4  rhopcc(ntpl)`  : Partial-core-correction density for xc</span>
<span class="c">!! * `real*4  DRho(ntpl)`    : Selfconsistent electron density difference</span>
<span class="c">!! * `real*8  rhotot`        : Total density at one point</span>
<span class="c">!! * `real*8  rmax`          : Maximum orbital radius</span>
<span class="c">!! * `real*8  scell(3,3)`    : Supercell vectors</span>
<span class="c">!! * `character shape*10`    : Name of system shape</span>
<span class="c">!! * `real*4  Vaux(ntpl)`    : Auxiliary potential array</span>
<span class="c">!! * `real*4  Vna(ntpl)`     : Sum of neutral-atom potentials</span>
<span class="c">!! * `real*8  volume`        : Unit cell volume</span>
<span class="c">!! * `real*4  Vscf(ntpl)`    : Hartree potential of selfconsistent density</span>
<span class="c">!! * `real*8  x0(3)`         : Center of molecule</span>
<span class="c">!! * `logical harrisfun`     : Harris functional or Kohn-Sham?</span>

      <span class="k">use </span><span class="nb">precision</span><span class="p">,</span>     <span class="n">only</span>  <span class="p">:</span> <span class="n">dp</span><span class="p">,</span> <span class="n">grid_p</span>
<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ProcessorY</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>

<span class="c">!     Number of Mesh divisions of each cell vector (global)</span>
<span class="c">!     The status of this variable is confusing</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Nodes</span>
      <span class="k">use </span><span class="n">atmfuncs</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">rcut</span><span class="p">,</span> <span class="n">rcore</span>
      <span class="k">use </span><span class="n">units</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">Debye</span><span class="p">,</span> <span class="n">eV</span><span class="p">,</span> <span class="n">Ang</span>
      <span class="k">use </span><span class="n">fdf</span>
      <span class="k">use </span><span class="n">sys</span><span class="p">,</span>           <span class="n">only</span>  <span class="p">:</span> <span class="n">die</span><span class="p">,</span> <span class="n">bye</span>
      <span class="k">use </span><span class="n">mesh</span><span class="p">,</span>          <span class="n">only</span>  <span class="p">:</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span>
      <span class="k">use </span><span class="n">parsing</span>
      <span class="k">use </span><span class="n">m_iorho</span><span class="p">,</span>       <span class="n">only</span>  <span class="p">:</span> <span class="n">write_rho</span>
      <span class="k">use </span><span class="n">m_forhar</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">forhar</span>
      <span class="k">use </span><span class="n">alloc</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">re_alloc</span><span class="p">,</span> <span class="n">de_alloc</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">slabel</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">filesOut_t</span> <span class="c">! derived type for output file names</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">harrisfun</span><span class="p">,</span> <span class="n">save_initial_charge_density</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">analyze_charge_density_only</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">LocalChargeOnMesh</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">PartialCoreOnMesh</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">NeutralAtomOnMesh</span>

      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">setMeshDistr</span><span class="p">,</span> <span class="n">distMeshData</span>
      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">LINEAR</span>
      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">TO_SEQUENTIAL</span><span class="p">,</span> <span class="n">TO_CLUSTER</span><span class="p">,</span> <span class="n">KEEP</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">compute_partial_charges</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">want_partial_charges</span>
<span class="cp">#ifndef BSC_CELLXC</span>

      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cellXC</span>       <span class="c">! Finds xc energy and potential</span>
      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myMeshBox</span>    <span class="c">! Returns my processor mesh box</span>
      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jms_setMeshDistr</span> <span class="o">=&gt;</span> <span class="n">setMeshDistr</span>
                                        <span class="c">! Sets a distribution of mesh</span>
                                        <span class="c">! points over parallel processors</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">use </span><span class="n">m_vmat</span><span class="p">,</span>  <span class="n">only</span>  <span class="p">:</span> <span class="n">vmat</span>
      <span class="k">use </span><span class="n">m_rhoofd</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">rhoofd</span>
<span class="cp">#ifdef MPI</span>
      <span class="k">use </span><span class="n">mpi_siesta</span>
<span class="cp">#endif</span>
      <span class="k">use </span><span class="n">iogrid_netcdf</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_grid_netcdf</span>
      <span class="k">use </span><span class="n">iogrid_netcdf</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_grid_netcdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_charge_cdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savebader</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_deformation_charge_cdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">mix_charge</span>

      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">get_field_from_dipole</span><span class="p">,</span> <span class="n">dipole_correction</span>
      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">add_potential_from_field</span>
      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">user_specified_field</span><span class="p">,</span> <span class="n">acting_efield</span>
      <span class="k">use </span><span class="n">m_doping_uniform</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">doping_active</span><span class="p">,</span> <span class="n">doping_uniform</span>
      
      <span class="k">use </span><span class="n">m_charge_add</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">charge_add</span>
      <span class="k">use </span><span class="n">m_hartree_add</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">hartree_add</span>

<span class="cp">#ifdef NCDF_4</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_cdf</span>
      <span class="k">use </span><span class="n">m_ncdf_siesta</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">cdf_save_grid</span>
<span class="cp">#endif</span>
      <span class="k">use </span><span class="n">m_rhofft</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">rhofft</span><span class="p">,</span> <span class="n">FORWARD</span><span class="p">,</span> <span class="n">BACKWARD</span>
      <span class="k">use </span><span class="n">m_rhog</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">rhog_in</span><span class="p">,</span> <span class="n">rhog</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">spin</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">Spiral</span><span class="p">,</span> <span class="n">qSpiral</span>
      <span class="k">use </span><span class="n">m_iotddft</span><span class="p">,</span>      <span class="n">only</span><span class="p">:</span> <span class="n">write_tdrho</span>
      <span class="k">use </span><span class="n">m_ts_global_vars</span><span class="p">,</span><span class="n">only</span><span class="p">:</span> <span class="n">TSmode</span><span class="p">,</span> <span class="n">TSrun</span>
      <span class="k">use </span><span class="n">m_ts_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">IsVolt</span><span class="p">,</span> <span class="n">Elecs</span><span class="p">,</span> <span class="n">N_elec</span>
      <span class="k">use </span><span class="n">m_ts_voltage</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ts_voltage</span>
      <span class="k">use </span><span class="n">m_ts_hartree</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ts_hartree_fix</span>

      <span class="k">implicit none</span>

<span class="k">      </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nspin</span>
        <span class="c">!! Number of different spin polarisations:  </span>
        <span class="c">!! nspin=1 =&gt; Unpolarized, nspin=2 =&gt; polarized  </span>
        <span class="c">!! nspin=4 =&gt; Noncollinear spin or spin-orbit.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">norb</span>
        <span class="c">!! Total number of basis orbitals in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iaorb</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Atom to which each orbital belongs</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iphorb</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Orbital index (within atom) of each orbital</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nuo</span>
        <span class="c">!! Number of orbitals in a unit cell in this node</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nuotot</span>
        <span class="c">!! Number of orbitals in a unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nua</span>
        <span class="c">!! Number of atoms in unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">na</span>
        <span class="c">!! Number of atoms in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">isa</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Species index of all atoms in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">indxua</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Index of equivalent atom in unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ifa</span>
        <span class="c">!! Switch which fixes whether the SCF contrib:  </span>
        <span class="c">!! to atomic forces is calculated and added to fa.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istr</span>
        <span class="c">!! Switch which fixes whether the SCF contrib:  </span>
        <span class="c">!! to stress is calculated and added to stress.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iHmat</span>
        <span class="c">!! Switch which fixes whether the Hmat matrix</span>
        <span class="c">!! elements are calculated or not.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">maxnd</span>
        <span class="c">!! First dimension of listd and Dscf</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">numd</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>
        <span class="c">!! Number of nonzero density-matrix</span>
        <span class="c">!! elements for each matrix row</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">listdptr</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>
        <span class="c">!! Pointer to start of rows of density-matrix</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">listd</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
        <span class="c">!! `listd(maxnd)`: Nonzero-density-matrix-element column</span>
        <span class="c">!! indexes for each matrix row</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">maxnh</span>
        <span class="c">!! First dimension of listh and Hmat</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xa</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Atomic positions of all atoms in supercell</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Dscf</span><span class="p">(:,:)</span>
        <span class="c">!! `Dscf(maxnd,h_spin_dim)`:  </span>
        <span class="c">!! SCF density-matrix elements</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">datm</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Harris density-matrix diagonal elements  </span>
        <span class="c">!! (atomic occupation charges of orbitals)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Hmat</span><span class="p">(:,:)</span>
        <span class="c">!! `Hmat(maxnh,h_spin_dim)`:  </span>
        <span class="c">!! Hamiltonian matrix in sparse form,  </span>
        <span class="c">!! to which are added the matrix elements  </span>
        <span class="c">!! `&lt;ORB_I | DeltaV | ORB_J&gt;`, where  </span>
        <span class="c">!! `DeltaV = Vna + Vxc(SCF) + Vhartree(RhoSCF-RhoHarris)`</span>

      <span class="k">type</span><span class="p">(</span><span class="n">filesOut_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">filesOut</span>
        <span class="c">!! Output file names (If blank =&gt; not saved)</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ntm</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Number of mesh divisions of each cell</span>
        <span class="c">!! vector, including subgrid.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">nua</span><span class="p">)</span>
        <span class="c">!! Atomic forces, to which the SCF contribution</span>
        <span class="c">!! is added by this routine when `ifa=1`.</span>
        <span class="c">!! The SCF contribution is minus the derivative</span>
        <span class="c">!! of `(Enascf - Enaatm + DUscf + Exc)` with</span>
        <span class="c">!! respect to atomic positions, in Ry/Bohr.</span>
        <span class="c">!! Contributions local to this node.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Stress tensor, to which the SCF contribution</span>
        <span class="c">!! is added by this routine when `ifa=1`.</span>
        <span class="c">!! The SCF contribution is minus the derivative of</span>
        <span class="c">!! `(Enascf - Enaatm + DUscf + Exc) / volume`</span>
        <span class="c">!! with respect to the strain tensor, in Ry.</span>
        <span class="c">!! Contributions local to this node.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stress</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Enaatm</span>
        <span class="c">!! Integral of `Vna * rhoatm`</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Enascf</span>
        <span class="c">!! Integral of `Vna * rhoscf`</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Uatm</span>
        <span class="c">!! Harris hartree electron-interaction energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Uscf</span>
        <span class="c">!! SCF hartree electron-interaction energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">DUscf</span>
        <span class="c">!! Electrostatic (Hartree) energy of</span>
        <span class="c">!! `(rhoscf - rhoatm)` density</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">DUext</span>
        <span class="c">!! Interaction energy with external electric field</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Exc</span>
        <span class="c">!! SCF exchange-correlation energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Dxc</span>
        <span class="c">!! SCF double-counting correction to Exc  </span>
        <span class="c">!! `Dxc = integral of ( (epsxc - Vxc) * Rho )`  </span>
        <span class="c">!! All energies in Rydbergs</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Electric dipole (in a.u.)</span>
        <span class="c">!! only when the system is a molecule</span>

      <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">use_rhog_in</span>
      <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">charge_density_only</span>


<span class="c">!     Local variables</span>
      <span class="kt">integer</span>  <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">nsd</span><span class="p">,</span> <span class="n">np_vac</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Interface to JMS&#39;s SiestaXC</span>
      <span class="kt">integer</span>       <span class="kd">::</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">save</span> <span class="kd">::</span> <span class="n">JDGdistr</span><span class="o">=-</span><span class="mi">1</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stressXC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">b1Xb2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">const</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DStres</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
     <span class="p">&amp;</span>            <span class="n">Ec</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">rhotot</span><span class="p">,</span> <span class="n">x0</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Vmax_vac</span><span class="p">,</span> <span class="n">Vmean_vac</span>
<span class="cp">#ifdef BSC_CELLXC</span>
<span class="c">!     Dummy arrays for cellxc call</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aux3</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dummy_DVxcdn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="kt">logical</span> <span class="kd">::</span> <span class="n">use_rhog</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">volcel</span><span class="p">,</span> <span class="n">ddot</span>

      <span class="k">external</span>
     <span class="p">&amp;</span>  <span class="n">cross</span><span class="p">,</span>
     <span class="p">&amp;</span>  <span class="n">dipole</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">poison</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">reord</span><span class="p">,</span> <span class="n">rhooda</span><span class="p">,</span> <span class="n">rhoofdsp</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">timer</span><span class="p">,</span> <span class="n">vmatsp</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">readsp</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">external </span><span class="n">bsc_cellxc</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="c">!     Work arrays</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Vscf</span><span class="p">(:,:),</span> <span class="n">Vscf_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                         <span class="n">DRho</span><span class="p">(:,:),</span> <span class="n">DRho_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                         <span class="n">Vaux</span><span class="p">(:),</span> <span class="n">Vaux_par</span><span class="p">(:),</span> <span class="n">Chlocal</span><span class="p">(:),</span>
     <span class="p">&amp;</span>                         <span class="n">Totchar</span><span class="p">(:),</span> <span class="n">fsrc</span><span class="p">(:),</span> <span class="n">fdst</span><span class="p">(:),</span>
     <span class="p">&amp;</span>                         <span class="n">rhoatm_quad</span><span class="p">(:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">(),</span>
     <span class="p">&amp;</span>                         <span class="n">DRho_quad</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>
      <span class="c">! Temporary reciprocal spin quantity</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">rnsd</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Vscf_gga</span><span class="p">(:,:),</span> <span class="n">DRho_gga</span><span class="p">(:,:)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
<span class="cp">#ifdef MPI</span>
      <span class="kt">integer</span>  <span class="kd">::</span> <span class="n">MPIerror</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
      <span class="k">call </span><span class="n">write_debug</span><span class="p">(</span> <span class="s1">&#39;    PRE DHSCF&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span> <span class="o">/=</span> <span class="n">size</span><span class="p">(</span><span class="n">Dscf</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;Spin components is not equal to options.&#39;</span><span class="p">)</span>
      <span class="k">end if</span>

<span class="k">      if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;DM&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">)</span>
         <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Hmat</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">)</span>
      <span class="k">end if</span>
      
<span class="c">!-------------------------------------------------------------------- BEGIN</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Start of SCF iteration part</span>
<span class="c">! ----------------------------------------------------------------------</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     At the end of DHSCF_INIT, and also at the end of any previous</span>
<span class="c">!     call to dhscf, we were in the UNIFORM distribution</span>
<span class="c">!     Rhoatm, Rhopcc and Vna were in UNIFORM dist, sequential form</span>
<span class="c">!     The index array endpht was in the QUADRATIC distribution</span>
<span class="c">! ----------------------------------------------------------------------</span>

<span class="cp">#ifdef _TRACE_</span>
      <span class="k">call </span><span class="n">MPI_Barrier</span><span class="p">(</span> <span class="n">MPI_Comm_World</span><span class="p">,</span> <span class="n">MPIerror</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">MPItrace_restart</span><span class="p">(</span> <span class="p">)</span>
<span class="cp">#endif</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>

      <span class="k">nullify</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">Totchar</span> <span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">nullify</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="n">DRho_gga</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="n">volume</span> <span class="o">=</span> <span class="n">volcel</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

<span class="c">!-------------------------------------------------------------------------</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">analyze_charge_density_only</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">!! Use the functionality in the first block</span>
         <span class="c">!! of the routine to get charge files and partial charges</span>
         <span class="k">call </span><span class="n">setup_analysis_options</span><span class="p">()</span>
      <span class="n">endif</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Uniform dist, sequential form</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vna&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span><span class="n">Vna</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vna</span><span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="s2">&quot;Vna&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vna</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="s2">&quot;Vna&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Allocate memory for DRho using the UNIFORM data distribution</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

<span class="c">! Find number of diagonal spin values</span>
      <span class="n">nsd</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">nspin</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">nsd</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         </span><span class="n">rnsd</span> <span class="o">=</span> <span class="mf">1._grid_p</span>
      <span class="k">else</span>
<span class="k">         </span><span class="n">rnsd</span> <span class="o">=</span> <span class="mf">1._grid_p</span> <span class="o">/</span> <span class="n">nsd</span>
      <span class="k">end if</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Find SCF electron density at mesh points. Store it in array DRho</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!</span>
<span class="c">!     The reading routine works in the uniform distribution, in</span>
<span class="c">!     sequential form</span>
<span class="c">!</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">use_rhog_in</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">use_rhog</span> <span class="o">=</span> <span class="n">use_rhog_in</span>
         <span class="k">else</span>
<span class="k">            </span><span class="n">use_rhog</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="n">endif</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">use_rhog</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! fourier transform back into drho</span>
         <span class="k">call </span><span class="n">rhofft</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>                  <span class="n">DRho</span><span class="p">,</span><span class="n">rhog_in</span><span class="p">,</span><span class="n">BACKWARD</span><span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span><span class="n">read_charge_cdf</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">read_grid_netcdf</span><span class="p">(</span><span class="n">ntm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="n">DRho</span><span class="p">,</span><span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
         <span class="n">read_charge_cdf</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">else if</span> <span class="p">(</span><span class="n">read_deformation_charge_cdf</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">read_grid_netcdf</span><span class="p">(</span><span class="n">ntm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="n">DRho</span><span class="p">,</span><span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
         <span class="c">! Add to diagonal components only</span>
         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
            <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
<span class="c">!             rhoatm and Drho are in sequential mode</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
            <span class="n">enddo</span>
         <span class="n">enddo</span>
         <span class="n">read_deformation_charge_cdf</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">else</span>
        <span class="c">! Set the QUADRATIC distribution and allocate memory for DRho_par</span>
        <span class="c">! since the construction of the density from the DM and orbital</span>
        <span class="c">! data needs that distribution</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;DRho_par&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">Spiral</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">rhoofdsp</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>                   <span class="n">nspin</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span>
     <span class="p">&amp;</span>                   <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">qspiral</span> <span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">rhoofd</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="n">nspin</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span> 
     <span class="p">&amp;</span>                 <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="c">! DRHO_par is here in QUADRATIC, clustered form</span>

<span class="c">!       Set the UNIFORM distribution again and copy DRho to it</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>

        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! Sequential to be able to write it out</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
        <span class="n">enddo</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="s1">&#39;DRho_par&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;DRho&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nspin</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">save_initial_charge_density</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! This section is to be deprecated in favor</span>
           <span class="c">! of &quot;analyze_charge_density_only&quot;</span>
           <span class="c">! (except for the special name for the .nc file)</span>
<span class="cp">#ifdef NCDF_4</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoInit&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">ntml</span><span class="p">,</span><span class="n">DRho</span><span class="p">)</span>
          <span class="k">else</span>
<span class="k">             call </span><span class="n">write_rho</span><span class="p">(</span> <span class="s2">&quot;RHO_INIT&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>            <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">)</span>
             <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="err">$</span>            <span class="s2">&quot;RhoInit&quot;</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="cp">#else</span>
          <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="s2">&quot;RHO_INIT&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>         <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">)</span>
          <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="err">$</span>         <span class="s2">&quot;RhoInit&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
          <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;STOP after producing RHO_INIT from input DM&quot;</span><span class="p">)</span>
        <span class="n">endif</span>

      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">mix_charge</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! Save fourier transform of charge density</span>
         <span class="k">call </span><span class="n">rhofft</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">DRho</span><span class="p">,</span><span class="n">rhog</span><span class="p">,</span><span class="n">FORWARD</span><span class="p">)</span>
      <span class="n">endif</span>
<span class="c">!</span>
<span class="c">!     Proper place to integrate Hirshfeld and Voronoi code,</span>
<span class="c">!     since we have just computed rhoatm and Rho.</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">want_partial_charges</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! The endpht array is in the quadratic distribution, so</span>
        <span class="c">! we need to use it for this...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;DRho_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>       
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">rhoatm_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;rhoatm_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="c">! Redistribute grid-density</span>
        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho_quad</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="n">enddo</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">rhoatm</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">rhoatm_quad</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">compute_partial_charges</span><span class="p">(</span><span class="n">DRho_quad</span><span class="p">,</span><span class="n">rhoatm_quad</span><span class="p">,</span>
     <span class="p">.</span>                  <span class="n">nspin</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> 
     <span class="p">.</span>                  <span class="n">isa</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span><span class="n">dvol</span><span class="p">)</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span><span class="n">rhoatm_quad</span><span class="p">,</span><span class="s1">&#39;rhoatm_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span><span class="n">Drho_quad</span><span class="p">,</span><span class="s1">&#39;DRho_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save electron density</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">!  DRho is already using a uniform, sequential form</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Rho&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">! Save TD-electron density after every given number of steps- Rafi, Jan 2016</span>
<span class="c">!-----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">write_tdrho</span><span class="p">(</span><span class="n">filesOut</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">tdrho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">!  DRho is already using a uniform, sequential form</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">tdrho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;TDRho&quot;</span><span class="p">)</span>
      <span class="n">endif</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save the diffuse ionic charge and/or the total (ionic+electronic) charge</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!       Find diffuse ionic charge on mesh</span>
        <span class="c">! Note that the *OnMesh routines, except PhiOnMesh,</span>
        <span class="c">! work with any distribution, thanks to the fact that</span>
        <span class="c">! the ipa, idop, and indexp arrays are distro-specific</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">LocalChargeOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">indxua</span> <span class="p">)</span>
        <span class="c">! Chlocal comes out in clustered form, so we convert it</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Chlocal</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">end if</span>

<span class="c">!       Save diffuse ionic charge </span>
        <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">Chlocal</span><span class="p">)</span>
          <span class="k">else</span>
<span class="k">             call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">Chlocal</span><span class="p">)</span>
             <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="s1">&#39;Chlocal&#39;</span> <span class="p">)</span>
          <span class="k">end if</span>
<span class="cp">#else</span>
          <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Chlocal</span><span class="p">)</span>
          <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Chlocal</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>
        <span class="n">endif</span>

<span class="c">!       Save total (ionic+electronic) charge </span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! *****************</span>
           <span class="c">! **  IMPORTANT  **</span>
           <span class="c">! The Chlocal array is re-used to minimize memory</span>
           <span class="c">! usage. In the this small snippet the Chlocal</span>
           <span class="c">! array will contain the total charge, and</span>
           <span class="c">! if the logic should change, (i.e. should Chlocal</span>
           <span class="c">! be retained) is the Totchar needed to be re-instantiated.</span>
           <span class="c">! *****************</span>

<span class="c">!$OMP parallel default(shared), private(ispin,ip)</span>
           <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
<span class="c">!$OMP do </span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
              <span class="n">Chlocal</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">Chlocal</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="k">end do</span>
<span class="c">!$OMP end do </span>
           <span class="k">end do</span>
<span class="c">!$OMP end parallel</span>

          <span class="c">! See note above</span>
<span class="cp">#ifdef NCDF_4</span>
           <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">              call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoTot&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">Chlocal</span><span class="p">)</span>
           <span class="k">else</span>
<span class="k">              call </span><span class="n">write_rho</span><span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">ntm</span><span class="p">,</span><span class="n">nsm</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Chlocal</span><span class="p">)</span>
              <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> 
     <span class="p">&amp;</span>             <span class="s2">&quot;TotalCharge&quot;</span><span class="p">)</span>
           <span class="k">end if</span>
<span class="cp">#else</span>
           <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Chlocal</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Chlocal</span><span class="p">,</span> <span class="s2">&quot;TotalCharge&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
        <span class="k">end if </span>
<span class="k">        call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save the total charge (model core + valence) for Bader analysis</span>
<span class="c">! ----------------------------------------------------------------------</span>
      
      <span class="c">! The test for toch guarantees that we are in &quot;analysis mode&quot;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">savebader</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">save_bader_charge</span><span class="p">()</span>
      <span class="n">endif</span>

<span class="c">! Find difference between selfconsistent and atomic densities</span>

      <span class="c">!Both DRho and rhoatm are using a UNIFORM, sequential form</span>
<span class="c">!$OMP parallel do default(shared), private(ispin,ip),</span>
<span class="c">!$OMP&amp;collapse(2)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save electron density difference</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoDelta&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">charge_density_only</span><span class="p">))</span> <span class="k">then </span>
<span class="k">         if</span> <span class="p">(</span><span class="n">charge_density_only</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
            <span class="k">RETURN</span>
<span class="k">         </span><span class="n">endif</span>
      <span class="n">endif</span>

<span class="c">! End of analysis section</span>
<span class="c">! Can exit now, if requested</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">analyze_charge_density_only</span><span class="p">)</span> <span class="k">then </span>
<span class="k">            call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
           <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;STOP after analyzing charge from input DM&quot;</span><span class="p">)</span>
        <span class="n">endif</span>

<span class="c">!-------------------------------------------------------------</span>
<span class="c">!     Transform spin density into sum and difference</span>

      <span class="c">! TODO Check for NC/SO:</span>
      <span class="c">! Should we diagonalize locally at every point first?</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(rhotot,ip)</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
          <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">rhotot</span>
        <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">endif</span>

<span class="c">! Add a background charge to neutralize the net charge, to</span>
<span class="c">! model doped systems. It only adds the charge at points</span>
<span class="c">! where there are atoms (i.e., not in vacuum).          </span>
<span class="c">! First, call with &#39;task=0&#39; to add background charge    </span>
      <span class="k">if</span> <span class="p">(</span><span class="n">doping_active</span><span class="p">)</span> <span class="k">call </span><span class="n">doping_uniform</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">rhoatm</span><span class="p">)</span>
      
      <span class="c">! Add doping in cell (from ChargeGeometries/Geometry.Charge)</span>
      <span class="c">! Note that this routine will return immediately if no dopant is present</span>
      <span class="k">call </span><span class="n">charge_add</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Calculate the dipole moment</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39;bulk&#39;</span><span class="p">)</span> <span class="k">then</span>

<span class="c">! Find center of system</span>
        <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
        <span class="k">do </span><span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nua</span>
          <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">xa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ia</span><span class="p">)</span> <span class="o">/</span> <span class="n">nua</span>
        <span class="n">enddo</span>

<span class="c">! Find dipole</span>
        <span class="c">! This routine is distribution-blind</span>
        <span class="c">! and will reduce over all processors.</span>
        <span class="k">call </span><span class="n">dipole</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">nsm</span><span class="p">,</span>
     <span class="p">&amp;</span>               <span class="n">DRho</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dipol</span> <span class="p">)</span>

        <span class="c">! Orthogonalize dipole to bulk directions</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          </span><span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span> <span class="o">*</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;slab&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">cross</span><span class="p">(</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">b1Xb2</span> <span class="p">)</span>
          <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span> <span class="o">*</span> <span class="n">b1Xb2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
       <span class="k">end if</span>

<span class="k">       if</span> <span class="p">(</span> <span class="n">TSmode</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span> <span class="n">N_elec</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">then</span>
          <span class="c">! Orthogonalize dipole to electrode transport directions</span>
          <span class="k">do </span><span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">,</span> <span class="n">N_Elec</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">Elecs</span><span class="p">(</span><span class="n">ia</span><span class="p">)%</span><span class="n">cell</span><span class="p">(:,</span><span class="n">Elecs</span><span class="p">(</span><span class="n">ia</span><span class="p">)%</span><span class="n">t_dir</span><span class="p">)</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span> <span class="o">*</span> <span class="n">x0</span>
          <span class="k">end do</span>
<span class="k">        else if</span> <span class="p">(</span> <span class="p">(</span><span class="nb">shape</span> <span class="o">==</span> <span class="s1">&#39;molecule&#39;</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="nb">shape</span> <span class="o">==</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
          <span class="c">! Only allow dipole correction for chains and molecules</span>
          <span class="c">! along the semi-infinite direciton.</span>
          <span class="c">! Note this is *only* for 1-electrode setups</span>
          <span class="c">! Note that since the above removes the periodic directions</span>
          <span class="c">! this should not do anything for &#39;chain&#39; with the same semi-infinite</span>
          <span class="c">! direction</span>
          <span class="n">x0</span> <span class="o">=</span> <span class="n">Elecs</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">cell</span><span class="p">(:,</span><span class="n">Elecs</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">t_dir</span><span class="p">)</span>
          <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span> <span class="o">*</span> <span class="n">x0</span>
        <span class="k">end if</span>
<span class="k">       end if</span>
<span class="k">          </span>
<span class="k">      </span><span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find Hartree potential of DRho = rhoscf-rhoatm. Store it in Vaux</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Solve Poisson&#39;s equation</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Vaux&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">call </span><span class="n">poison</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DUscf</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">DStres</span><span class="p">,</span> <span class="n">nsm</span> <span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;Poisson&#39;</span><span class="p">,</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vaux</span><span class="p">(:)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
      <span class="k">end if</span>

      <span class="c">! Vscf is in the UNIFORM, sequential form, and only using</span>
      <span class="c">! the first spin index</span>

      <span class="c">! We require that even the SIESTA potential is &quot;fixed&quot;</span>
      <span class="c">! NOTE, this will only do something if</span>
      <span class="c">!   TS.Hartree.Fix is set</span>
      <span class="k">call </span><span class="n">ts_hartree_fix</span><span class="p">(</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">)</span>
      
<span class="c">! Add contribution to stress from electrostatic energy of rhoscf-rhoatm</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">istr</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">stressl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">DStres</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find electrostatic (Hartree) energy of full SCF electron density</span>
<span class="c">!     using the original data distribution </span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">Uatm</span> <span class="o">=</span> <span class="n">Uharrs</span>
      <span class="n">Uscf</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP parallel do default(shared), private(ip), </span>
<span class="c">!$OMP&amp;reduction(+:Uscf)</span>
      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
        <span class="n">Uscf</span> <span class="o">=</span> <span class="n">Uscf</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">Uscf</span> <span class="o">=</span> <span class="n">Uscf</span> <span class="o">*</span> <span class="n">dVol</span> <span class="o">+</span> <span class="n">Uatm</span> <span class="o">+</span> <span class="n">DUscf</span>

<span class="c">! Call doping with &#39;task=1&#39; to remove background charge added previously</span>
<span class="c">! The extra charge thus only affects the Hartree energy and potential,</span>
<span class="c">! but not the contribution to Enascf ( = \Int_{Vna*\rho})</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">doping_active</span><span class="p">)</span> <span class="k">call </span><span class="n">doping_uniform</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">rhoatm</span><span class="p">)</span>

      <span class="c">! Remove doping in cell (from ChargeGeometries/Geometry.Charge)</span>
      <span class="c">! Note that this routine will return immediately if no dopant is present</span>
      <span class="k">call </span><span class="n">charge_add</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add neutral-atom potential to Vaux</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
<span class="c">!$OMP parallel do default(shared), private(ip),</span>
<span class="c">!$OMP&amp;reduction(+:Enaatm,Enascf)</span>
      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
        <span class="n">Enaatm</span>   <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="n">Enascf</span>   <span class="o">=</span> <span class="n">Enascf</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">*</span> <span class="n">dVol</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">Enascf</span> <span class="o">*</span> <span class="n">dVol</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add potential from external electric field (if present)</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">acting_efield</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span> <span class="n">dipole_correction</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">field</span> <span class="o">=</span> <span class="n">get_field_from_dipole</span><span class="p">(</span><span class="n">dipol</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Node</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">	       write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;(a,3f12.4,a)&#39;</span><span class="p">)</span>
     <span class="err">$</span>              <span class="s1">&#39;Dipole moment in unit cell   =&#39;</span><span class="p">,</span> <span class="n">dipol</span><span class="o">/</span><span class="n">Debye</span><span class="p">,</span> <span class="s1">&#39; D&#39;</span>
	       <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;(a,3f12.6,a)&#39;</span><span class="p">)</span>
     <span class="err">$</span>              <span class="s1">&#39;Electric field for dipole correction =&#39;</span><span class="p">,</span>
     <span class="err">$</span>              <span class="n">field</span><span class="o">/</span><span class="n">eV</span><span class="o">*</span><span class="n">Ang</span><span class="p">,</span> <span class="s1">&#39; eV/Ang/e&#39;</span>
            <span class="k">end if</span>
            <span class="c">! The dipole correction energy has an extra factor</span>
            <span class="c">! of one half because the field involved is internal.</span>
            <span class="c">! See the paper by Bengtsson DOI:10.1103/PhysRevB.59.12301</span>
            <span class="c">! Hence we compute this part separately</span>
            <span class="n">DUext</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5_dp</span> <span class="o">*</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
         <span class="k">else</span>
<span class="k">            </span><span class="n">field</span> <span class="o">=</span> <span class="mf">0._dp</span>
            <span class="n">DUext</span> <span class="o">=</span> <span class="mf">0._dp</span>
         <span class="k">end if</span>
         <span class="c">! Add the external electric field</span>
         <span class="n">field</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="n">user_specified_field</span>
         <span class="c">! This routine expects a sequential array,</span>
         <span class="c">! but it is distribution-blind</span>
         <span class="k">call </span><span class="n">add_potential_from_field</span><span class="p">(</span> <span class="n">field</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span>
     <span class="p">&amp;</span>                                  <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
         <span class="c">! Add energy of external electric field</span>
         <span class="n">DUext</span> <span class="o">=</span> <span class="n">DUext</span> <span class="o">-</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">user_specified_field</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ---------------------------------------------------------------------</span>
<span class="c">!     Transiesta:</span>
<span class="c">!     add the potential corresponding to the (possible) voltage-drop.</span>
<span class="c">!     note that ts_voltage is not sharing the reord wih efield since</span>
<span class="c">!     we should not encounter both at the same time.</span>
<span class="c">! ---------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">TSmode</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">IsVolt</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">TSrun</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! This routine expects a sequential array,</span>
         <span class="c">! in whatever distribution</span>
<span class="cp">#ifdef TRANSIESTA_VOLTAGE_DEBUG</span>
<span class="c">!$OMP parallel workshare default(shared)</span>
         <span class="n">Vaux</span><span class="p">(:)</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP end parallel workshare</span>
<span class="cp">#endif</span>
         <span class="k">call </span><span class="n">ts_voltage</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">)</span>
<span class="cp">#ifdef TRANSIESTA_VOLTAGE_DEBUG</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> 
     <span class="p">&amp;</span>        <span class="s2">&quot;TransiestaHartreePotential&quot;</span><span class="p">)</span>
         <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;ts_volt&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
         <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s1">&#39;transiesta debug for Hartree potential&#39;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add potential from user defined geometries (if present)</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">hartree_add</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Save electrostatic potential</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Note that only the first spin component is used</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vh&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vaux</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">Vaux</span><span class="p">,</span> <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Get back spin density from sum and difference</span>
      <span class="c">! TODO Check for NC/SO:</span>
      <span class="c">! Should we diagonalize locally at every point first?</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(ip,rhotot)</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
          <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5_dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhotot</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5_dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhotot</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">! Set uniform distribution of mesh points and find my processor mesh box</span>
<span class="c">! This is the interface to JM Soler&#39;s own cellxc routine, which sets</span>
<span class="c">! up the right distribution internally.</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">call </span><span class="n">jms_setMeshDistr</span><span class="p">(</span> <span class="n">distrID</span><span class="o">=</span><span class="n">JDGdistr</span><span class="p">,</span> <span class="n">nMesh</span><span class="o">=</span><span class="n">ntm</span><span class="p">,</span> 
     <span class="p">.</span>                   <span class="n">nNodesX</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nNodesY</span><span class="o">=</span><span class="n">ProcessorY</span><span class="p">,</span> <span class="n">nBlock</span><span class="o">=</span><span class="n">nsm</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">myMeshBox</span><span class="p">(</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">JDGdistr</span><span class="p">,</span> <span class="n">myBox</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
<span class="c">! Exchange-correlation energy</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Vscf&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
         
<span class="c">!$OMP parallel do default(shared), private(ip,ispin), collapse(2)</span>
       <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
          <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
             <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span>
     <span class="p">&amp;</span>            <span class="p">(</span><span class="n">rhopcc</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">rnsd</span>
          <span class="n">enddo</span>
       <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

      <span class="k">else</span>

<span class="c">!$OMP parallel do default(shared), private(ip,ispin), collapse(2)</span>
       <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
          <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
             <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span>
     <span class="p">&amp;</span>            <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
          <span class="n">enddo</span>
       <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

      <span class="k">end if</span>

      <span class="c">! Write the electron density used by cellxc</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoXC&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;RhoXC&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>       <span class="s2">&quot;RhoXC&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Everything now is in UNIFORM, sequential form</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;CellXC&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Vscf_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_gga</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;DRho_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="c">! Redistribute all spin densities</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
        <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho_gga</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
      <span class="n">enddo</span>

      <span class="k">call </span><span class="n">bsc_cellxc</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aux3</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DRho_gga</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">Ec</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">Vscf_gga</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">dummy_DVxcdn</span><span class="p">,</span> <span class="n">stressl</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">call </span><span class="n">cellXC</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
     <span class="p">.</span>                           <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
     <span class="p">.</span>                           <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">.</span>             <span class="n">DRho</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">Ec</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">stressXC</span><span class="p">,</span> <span class="n">Vscf</span> <span class="p">)</span>
<span class="cp">#else /* BSC_CELLXC */</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="c">! Redistribute to the Vxc array</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nspin</span>
        <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf_gga</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
      <span class="n">enddo</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;XC&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nspin</span><span class="p">)</span>
      <span class="k">end if</span>
      
      
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Vscf is still sequential after the call to JMS&#39;s cellxc</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho_gga</span><span class="p">,</span> <span class="s1">&#39;DRho_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="s1">&#39;Vscf_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="n">Exc</span> <span class="o">=</span>  <span class="n">Ex</span> <span class="o">+</span>  <span class="n">Ec</span>
      <span class="n">Dxc</span> <span class="o">=</span> <span class="n">DEx</span> <span class="o">+</span> <span class="n">DEc</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;CellXC&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="c">!     Vscf contains only Vxc, and is UNIFORM and sequential</span>
<span class="c">!     Now we add up the other contributions to it, at </span>
<span class="c">!     the same time that we get DRho back to true DeltaRho form</span>
<span class="c">!$OMP parallel default(shared), private(ip,ispin)</span>

      <span class="c">! Hartree potential only has diagonal components</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP do</span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> 
     <span class="p">&amp;</span>             <span class="p">(</span><span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="n">rhopcc</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">rnsd</span>
              <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
           <span class="n">enddo</span>
<span class="c">!$OMP end do</span>
        <span class="k">else</span>
<span class="c">!$OMP do</span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
              <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
           <span class="n">enddo</span>
<span class="c">!$OMP end do</span>
        <span class="n">endif</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="n">stress</span> <span class="o">=</span> <span class="n">stress</span> <span class="o">+</span> <span class="n">stressXC</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Save total potential</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vt&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vscf</span><span class="p">)</span>
        <span class="k">else </span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vscf</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;TotalPotential&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">Vscf</span><span class="p">,</span> <span class="s2">&quot;TotalPotential&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Print vacuum level</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="o">/=</span><span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="o">/=</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        forall</span><span class="p">(</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nsd</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">rhoatm</span><span class="p">(:)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="k">call </span><span class="n">vacuum_level</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> 
     <span class="p">.</span>                     <span class="n">np_vac</span><span class="p">,</span> <span class="n">Vmax_vac</span><span class="p">,</span> <span class="n">Vmean_vac</span> <span class="p">)</span>
        <span class="k">forall</span><span class="p">(</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nsd</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(:)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np_vac</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">Node</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">print</span><span class="s1">&#39;(/,a,2f12.6,a)&#39;</span><span class="p">,</span> 
     <span class="p">.</span>    <span class="s1">&#39;dhscf: Vacuum level (max, mean) =&#39;</span><span class="p">,</span> 
     <span class="p">.</span>    <span class="n">Vmax_vac</span><span class="o">/</span><span class="n">eV</span><span class="p">,</span> <span class="n">Vmean_vac</span><span class="o">/</span><span class="n">eV</span><span class="p">,</span> <span class="s1">&#39; eV&#39;</span>
      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span> <span class="o">/=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">save_ebs_density</span><span class="p">()</span>
      <span class="n">endif</span>
      
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find SCF contribution to hamiltonian matrix elements</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">iHmat</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                         <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
         <span class="n">endif</span>

<span class="c">!        This is a work array, to which we copy Vscf</span>
         <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
           <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
         <span class="n">enddo</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">Spiral</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">vmatsp</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">qspiral</span> <span class="p">)</span>
         <span class="k">else</span>
<span class="k">            call </span><span class="n">vmat</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>
         <span class="n">endif</span>

         <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span>  <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!          Everything back to UNIFORM, sequential</span>
           <span class="k">call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                         <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
         <span class="n">endif</span>
      <span class="n">endif</span>


<span class="cp">#ifdef MPI</span>
<span class="c">!     Global reduction of Uscf/DUscf/Uatm/Enaatm/Enascf</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Note that Exc and Dxc are already reduced in the new cellxc</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uscf</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DUscf</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uatm</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Enaatm</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Enascf</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Exc</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">Dxc</span>
<span class="cp">#else</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">call </span><span class="n">MPI_AllReduce</span><span class="p">(</span> <span class="n">sbuffer</span><span class="p">,</span> <span class="n">rbuffer</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">MPI_double_precision</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">MPI_Sum</span><span class="p">,</span> <span class="n">MPI_Comm_World</span><span class="p">,</span> <span class="n">MPIerror</span> <span class="p">)</span>
      <span class="n">Uscf</span>   <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">DUscf</span>  <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">Uatm</span>   <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="n">Exc</span>    <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
      <span class="n">Dxc</span>    <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
<span class="cp">#endif /* MPI */</span>

<span class="c">!     Add contribution to stress from the derivative of the Jacobian of ---</span>
<span class="c">!     r-&gt;r&#39; (strained r) in the integral of Vna*(rhoscf-rhoatm)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">istr</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
          <span class="n">stress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">stress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">Enascf</span> <span class="o">-</span> <span class="n">Enaatm</span> <span class="p">)</span> <span class="o">/</span> <span class="n">volume</span>
        <span class="n">enddo</span>
      <span class="n">endif</span>

<span class="c">!     Stop time counter for SCF iteration part</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     End of SCF iteration part</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">istr</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Forces and stress : SCF contribution</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!       Start time counter for force calculation part</span>
        <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF4&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>

<span class="c">!       Find contribution of partial-core-correction</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">reord</span><span class="p">(</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="c">! The partial core calculation only acts on</span>
          <span class="c">! the diagonal spin-components (no need to</span>
          <span class="c">! redistribute un-used elements)</span>
          <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
            <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span>
     <span class="p">&amp;</span>                  <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="n">enddo</span>

          <span class="k">call </span><span class="n">PartialCoreOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">nsd</span><span class="p">,</span>
     <span class="p">&amp;</span>                            <span class="n">dvol</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span>
     <span class="p">&amp;</span>                            <span class="n">stressl</span><span class="p">,</span> <span class="n">ifa</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">istr</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span> <span class="p">)</span>
   
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="c">! ** see above</span>
          <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
            <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span>
     <span class="p">&amp;</span>                  <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="n">enddo</span>

          <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;PartialCore&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsd</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="k">        </span><span class="n">endif</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">harrisfun</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!         Forhar deals internally with its own needs</span>
<span class="c">!         for distribution changes</span>
<span class="cp">#ifndef BSC_CELLXC</span>
          <span class="k">call </span><span class="n">forhar</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">npcc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> 
<span class="cp">#else /* BSC_CELLXC */</span>
          <span class="k">call </span><span class="n">forhar</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">npcc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> 
<span class="cp">#endif /* BSC_CELLXC */</span>
     <span class="p">&amp;</span>                 <span class="n">rhoatm</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
<span class="c">!         Upon return, everything is UNIFORM, sequential form</span>
        <span class="n">endif</span>

<span class="c">!     Transform spin density into sum and difference</span>
        <span class="c">! TODO NC/SO</span>
        <span class="c">! Should we perform local diagonalization?</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(rhotot,ip)</span>
          <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
            <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">rhotot</span>
          <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
        <span class="n">endif</span>

<span class="c">!       Find contribution of neutral-atom potential</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">NeutralAtomOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> 
     <span class="p">&amp;</span>                          <span class="n">volume</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span> 
     <span class="p">&amp;</span>                          <span class="n">ifa</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">istr</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>

        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="n">enddo</span>

<span class="c">!       Remember that Vaux contains everything except Vxc</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Vaux_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">dfscf</span><span class="p">(</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>              <span class="n">indxua</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> 
     <span class="p">&amp;</span>              <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span>
     <span class="p">&amp;</span>              <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="s1">&#39;Vaux_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>


<span class="c">!       Stop time counter for force calculation part</span>
        <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF4&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!       End of force and stress calculation</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">endif</span>

<span class="c">!     We are in the UNIFORM distribution</span>
<span class="c">!     Rhoatm, Rhopcc and Vna are in UNIFORM dist, sequential form</span>
<span class="c">!     The index array endpht is in the QUADRATIC distribution</span>

<span class="c">!     Stop time counter</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Free locally allocated memory</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="s1">&#39;Vaux&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="s1">&#39;Vscf&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

<span class="cp">#ifdef DEBUG</span>
      <span class="k">call </span><span class="n">write_debug</span><span class="p">(</span> <span class="s1">&#39;    POS DHSCF&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>
<span class="c">!------------------------------------------------------------------------ END</span>
      <span class="k">CONTAINS</span>

<span class="k">      subroutine </span><span class="n">save_bader_charge</span><span class="p">()</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ModelCoreChargeOnMesh</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_cdf</span>
      <span class="k">use </span><span class="n">m_ncdf_siesta</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">cdf_save_grid</span>
<span class="cp">#endif</span>
      <span class="c">! Auxiliary routine to output the Bader Charge</span>
      <span class="c">!</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">BaderCharge</span><span class="p">(:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BaderCharge&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="n">routine</span><span class="o">=</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="c">! Find a model core charge by re-scaling the local charge</span>
      <span class="k">call </span><span class="n">ModelCoreChargeOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">indxua</span> <span class="p">)</span>
      <span class="c">! It comes out in clustered form, so we convert it</span>
      <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span><span class="p">)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
         <span class="n">BaderCharge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">BaderCharge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoBader&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">BaderCharge</span><span class="p">)</span>
      <span class="k">else</span>
<span class="k">         call </span><span class="n">write_rho</span><span class="p">(</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BaderCharge</span> <span class="p">)</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">BaderCharge</span><span class="p">,</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">)</span>
      <span class="k">end if</span>
<span class="cp">#else</span>
      <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BaderCharge</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">BaderCharge</span><span class="p">,</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BaderCharge&#39;</span> <span class="p">)</span>
      <span class="k">end subroutine </span><span class="n">save_bader_charge</span>

      <span class="k">subroutine </span><span class="n">setup_analysis_options</span><span class="p">()</span>
      <span class="c">!! For the analyze-charge-density-only case,</span>
      <span class="c">!! avoiding any diagonalization</span>

      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">hirshpop</span><span class="p">,</span> <span class="n">voropop</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">saverho</span><span class="p">,</span> <span class="n">savedrho</span><span class="p">,</span> <span class="n">saverhoxc</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savevh</span><span class="p">,</span> <span class="n">savevt</span><span class="p">,</span> <span class="n">savevna</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savepsch</span><span class="p">,</span> <span class="n">savetoch</span>

      <span class="n">want_partial_charges</span> <span class="o">=</span> <span class="p">(</span><span class="n">hirshpop</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">voropop</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">saverho</span><span class="p">)</span>   <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span>   <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.RHO&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savedrho</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.DRHO&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">saverhoxc</span><span class="p">)</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.RHOXC&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevh</span><span class="p">)</span>    <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span>    <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VH&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevt</span><span class="p">)</span>    <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span>    <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VT&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevna</span><span class="p">)</span>   <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span>   <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VNA&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savepsch</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.IOCH&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savetoch</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.TOCH&#39;</span>

      <span class="k">end subroutine </span><span class="n">setup_analysis_options</span>

      <span class="k">subroutine </span><span class="n">save_ebs_density</span><span class="p">()</span>
<span class="c">!! Optional output of the &quot;band-structure energy density&quot;, which</span>
<span class="c">!! is just the charge density weighted by the eigenvalues, i.e.,</span>
<span class="c">!! using EDM instead of DM in rhoofd</span>

      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">Escf</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Ebs_dens</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">(),</span>
     <span class="p">&amp;</span>                         <span class="n">Ebs_dens_quad</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>

<span class="c">!     Allocate memory for Ebs_dens using the UNIFORM data distribution</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Ebs_dens</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>

<span class="c">!     Switch to quadratic distribution for call to rhoofd</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">ebs_dens_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="s1">&#39;Ebs_dens_quad&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">rhoofd</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">nspin</span><span class="p">,</span> <span class="n">Escf</span><span class="p">,</span> <span class="n">Ebs_dens_quad</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>

<span class="c">!     Ebs_dens_par is here in QUADRATIC, clustered form</span>

<span class="c">!     Set the UNIFORM distribution again and copy Ebs_dens to it</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
         <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Ebs_dens_quad</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Ebs_dens</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! Sequential to be able to write it out</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
         <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
      <span class="n">enddo</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Ebs_dens_quad</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Ebs_density&#39;</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span> <span class="n">Ebs_dens</span><span class="p">)</span>
      <span class="k">else</span>
<span class="k">         call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Ebs_dens</span> <span class="p">)</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Ebs_dens</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="s2">&quot;Ebs_density&quot;</span><span class="p">)</span>
      <span class="k">end if</span>
<span class="cp">#else</span>
      <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">Ebs_dens</span><span class="p">)</span>
      <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">Ebs_dens</span><span class="p">,</span> <span class="s2">&quot;Ebs_density&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Ebs_dens</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">end subroutine </span><span class="n">save_ebs_density</span>

      <span class="k">end subroutine </span><span class="n">dhscf</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> SIESTA was developed by SIESTA Group</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>