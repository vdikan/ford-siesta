<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A first-principles materials simulation code using Density Functional Theory.">
    
    <meta name="author" content="SIESTA Group" >
    <link rel="icon" href="../favicon.png">

    <title>dhscf &ndash; SIESTA</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">SIESTA <small>trunk-700--vdikan-edens-710-ford-681</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Program Overview</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>dhscf
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     <li><i class="fa fa-pencil"></i> J.M. Soler</li>
     
     
    <li><i class="fa fa-calendar-o"></i> August 1996</li>
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 7.8% of total for procedures.">659 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/dhscf.F"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/dhscf.f.html'>dhscf.F</a></li>
    
     <li><a href='../module/m_dhscf.html'>m_dhscf</a></li>
    
  
     <li class="active">dhscf</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/dhscf.html#src">dhscf</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine dhscf(nspin, norb, iaorb, iphorb, nuo, nuotot, nua, na, isa, xa, indxua, ntm, ifa, istr, iHmat, filesOut, maxnd, numd, listdptr, listd, Dscf, datm, maxnh, Hmat, Enaatm, Enascf, Uatm, Uscf, DUscf, DUext, Exc, Dxc, dipol, stress, Fal, stressl, use_rhog_in, charge_density_only)
    
    
   
</h2>
    
  
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Uses</h3>
      </div>
      <ul class="list-group">
      
      <li class="list-group-item">
  <ul class="list-inline">
    
    <li><a href='../module/precision.html'>precision</a></li>
    
    <li><a href='../module/parallel.html'>parallel</a></li>
    
    <li><a href='../module/parallel.html'>parallel</a></li>
    
    <li><a href='../module/atmfuncs.html'>atmfuncs</a></li>
    
    <li><a href='../module/units.html'>units</a></li>
    
    <li>fdf</li>
    
    <li><a href='../module/sys.html'>sys</a></li>
    
    <li><a href='../module/mesh.html'>mesh</a></li>
    
    <li>parsing</li>
    
    <li><a href='../module/m_iorho.html'>m_iorho</a></li>
    
    <li><a href='../module/m_forhar.html'>m_forhar</a></li>
    
    <li>alloc</li>
    
    <li>files</li>
    
    <li>files</li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li>meshsubs</li>
    
    <li>meshsubs</li>
    
    <li>meshsubs</li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li><a href='../module/moremeshsubs.html'>moreMeshSubs</a></li>
    
    <li>m_partial_charges</li>
    
    <li>m_partial_charges</li>
    
    <li>siestaXC</li>
    
    <li>siestaXC</li>
    
    <li>siestaXC</li>
    
    <li>m_vmat</li>
    
    <li><a href='../module/m_rhoofd.html'>m_rhoofd</a></li>
    
    <li>mpi_siesta</li>
    
    <li>iogrid_netcdf</li>
    
    <li>iogrid_netcdf</li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li>m_efield</li>
    
    <li>m_efield</li>
    
    <li>m_efield</li>
    
    <li>m_doping_uniform</li>
    
    <li>m_charge_add</li>
    
    <li>m_hartree_add</li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li>m_ncdf_siesta</li>
    
    <li>m_rhofft</li>
    
    <li><a href='../module/m_rhog.html'>m_rhog</a></li>
    
    <li>m_spin</li>
    
    <li>m_spin</li>
    
    <li>m_iotddft</li>
    
    <li>m_ts_global_vars</li>
    
    <li>m_ts_options</li>
    
    <li>m_ts_voltage</li>
    
    <li>m_ts_hartree</li>
    
  </ul>
      </li>
      
      
      
      <li class="list-group-item">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~UsesGraph Pages: 1 -->
<svg id="procdhscfUsesGraph" width="596pt" height="1252pt"
 viewBox="0.00 0.00 596.00 1252.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 1248)">
<title>proc~~dhscf~~UsesGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1248 592,-1248 592,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~UsesGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="588,-648 534,-648 534,-624 588,-624 588,-648"/>
<text text-anchor="middle" x="561" y="-633.6" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- m_charge_add -->
<g id="proc~~dhscf~~UsesGraph_node2" class="node"><title>m_charge_add</title>
<polygon fill="#337ab7" stroke="#337ab7" points="489.5,-1244 404.5,-1244 404.5,-1220 489.5,-1220 489.5,-1244"/>
<text text-anchor="middle" x="447" y="-1229.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_charge_add</text>
</g>
<!-- proc~dhscf&#45;&gt;m_charge_add -->
<g id="proc~~dhscf~~UsesGraph_edge1" class="edge"><title>proc~dhscf&#45;&gt;m_charge_add</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.422,-648.208C555.59,-727.191 532.904,-1164.15 498,-1211 497.434,-1211.76 496.835,-1212.49 496.207,-1213.2"/>
<polygon fill="#000000" stroke="#000000" points="493.822,-1210.63 488.514,-1219.8 498.381,-1215.94 493.822,-1210.63"/>
</g>
<!-- m_partial_charges -->
<g id="proc~~dhscf~~UsesGraph_node3" class="node"><title>m_partial_charges</title>
<polygon fill="#337ab7" stroke="#337ab7" points="497.5,-1202 396.5,-1202 396.5,-1178 497.5,-1178 497.5,-1202"/>
<text text-anchor="middle" x="447" y="-1187.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_partial_charges</text>
</g>
<!-- proc~dhscf&#45;&gt;m_partial_charges -->
<g id="proc~~dhscf~~UsesGraph_edge2" class="edge"><title>proc~dhscf&#45;&gt;m_partial_charges</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.076,-648.067C560.3,-718.508 558.42,-1076.45 498,-1164 495.874,-1167.08 493.268,-1169.82 490.371,-1172.25"/>
<polygon fill="#000000" stroke="#000000" points="488.346,-1169.4 482.158,-1178 492.359,-1175.13 488.346,-1169.4"/>
</g>
<!-- module~units -->
<g id="proc~~dhscf~~UsesGraph_node4" class="node"><title>module~units</title>
<g id="a_proc~~dhscf~~UsesGraph_node4"><a xlink:href=".././module/units.html" xlink:title="units">
<polygon fill="#337ab7" stroke="#337ab7" points="169,-1018 115,-1018 115,-994 169,-994 169,-1018"/>
<text text-anchor="middle" x="142" y="-1003.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">units</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~units -->
<g id="proc~~dhscf~~UsesGraph_edge3" class="edge"><title>proc~dhscf&#45;&gt;module~units</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-1028C402.972,-1056.12 249.815,-1028.67 179.174,-1013.96"/>
<polygon fill="#000000" stroke="#000000" points="179.88,-1010.54 169.373,-1011.89 178.434,-1017.38 179.88,-1010.54"/>
</g>
<!-- m_ts_global_vars -->
<g id="proc~~dhscf~~UsesGraph_node5" class="node"><title>m_ts_global_vars</title>
<polygon fill="#337ab7" stroke="#337ab7" points="495.5,-1122 398.5,-1122 398.5,-1098 495.5,-1098 495.5,-1122"/>
<text text-anchor="middle" x="447" y="-1107.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_global_vars</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_global_vars -->
<g id="proc~~dhscf~~UsesGraph_edge4" class="edge"><title>proc~dhscf&#45;&gt;m_ts_global_vars</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.919,-648.068C559.258,-712.64 553.216,-1017.06 498,-1089 497.423,-1089.75 496.814,-1090.48 496.177,-1091.18"/>
<polygon fill="#000000" stroke="#000000" points="493.8,-1088.6 488.414,-1097.73 498.314,-1093.95 493.8,-1088.6"/>
</g>
<!-- parsing -->
<g id="proc~~dhscf~~UsesGraph_node6" class="node"><title>parsing</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-1080 420,-1080 420,-1056 474,-1056 474,-1080"/>
<text text-anchor="middle" x="447" y="-1065.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parsing</text>
</g>
<!-- proc~dhscf&#45;&gt;parsing -->
<g id="proc~~dhscf~~UsesGraph_edge5" class="edge"><title>proc~dhscf&#45;&gt;parsing</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.593,-648.316C557.369,-709.048 545.012,-976.345 498,-1042 494.187,-1047.32 488.95,-1051.64 483.294,-1055.12"/>
<polygon fill="#000000" stroke="#000000" points="481.422,-1052.15 474.205,-1059.9 484.684,-1058.34 481.422,-1052.15"/>
</g>
<!-- module~parallel -->
<g id="proc~~dhscf~~UsesGraph_node7" class="node"><title>module~parallel</title>
<g id="a_proc~~dhscf~~UsesGraph_node7"><a xlink:href=".././module/parallel.html" xlink:title="parallel">
<polygon fill="#337ab7" stroke="#337ab7" points="169,-916 115,-916 115,-892 169,-892 169,-916"/>
<text text-anchor="middle" x="142" y="-901.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parallel</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~parallel -->
<g id="proc~~dhscf~~UsesGraph_edge6" class="edge"><title>proc~dhscf&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M558.868,-648.258C554.347,-694.287 535.962,-855.781 498,-887 450.281,-926.243 259.984,-914.492 179.376,-907.515"/>
<polygon fill="#000000" stroke="#000000" points="179.475,-904.01 169.204,-906.609 178.854,-910.982 179.475,-904.01"/>
</g>
<!-- module~sys -->
<g id="proc~~dhscf~~UsesGraph_node8" class="node"><title>module~sys</title>
<g id="a_proc~~dhscf~~UsesGraph_node8"><a xlink:href=".././module/sys.html" xlink:title="sys">
<polygon fill="#337ab7" stroke="#337ab7" points="169,-426 115,-426 115,-402 169,-402 169,-426"/>
<text text-anchor="middle" x="142" y="-411.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">sys</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~sys -->
<g id="proc~~dhscf~~UsesGraph_edge7" class="edge"><title>proc~dhscf&#45;&gt;module~sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-414C249.349,-411.387 207.904,-411.765 179.065,-412.566"/>
<polygon fill="#000000" stroke="#000000" points="178.931,-409.068 169.044,-412.876 179.147,-416.065 178.931,-409.068"/>
</g>
<!-- m_ts_voltage -->
<g id="proc~~dhscf~~UsesGraph_node9" class="node"><title>m_ts_voltage</title>
<polygon fill="#337ab7" stroke="#337ab7" points="485,-1000 409,-1000 409,-976 485,-976 485,-1000"/>
<text text-anchor="middle" x="447" y="-985.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_voltage</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_voltage -->
<g id="proc~~dhscf~~UsesGraph_edge8" class="edge"><title>proc~dhscf&#45;&gt;m_ts_voltage</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.24,-648.192C555.677,-701.801 539.039,-916.164 498,-967 496.714,-968.593 495.285,-970.068 493.748,-971.431"/>
<polygon fill="#000000" stroke="#000000" points="491.471,-968.753 485.308,-977.371 495.5,-974.478 491.471,-968.753"/>
</g>
<!-- siestaXC -->
<g id="proc~~dhscf~~UsesGraph_node10" class="node"><title>siestaXC</title>
<polygon fill="#337ab7" stroke="#337ab7" points="314,-998 259,-998 259,-974 314,-974 314,-998"/>
<text text-anchor="middle" x="286.5" y="-983.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siestaXC</text>
</g>
<!-- proc~dhscf&#45;&gt;siestaXC -->
<g id="proc~~dhscf~~UsesGraph_edge9" class="edge"><title>proc~dhscf&#45;&gt;siestaXC</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.566,-648.184C557.281,-705.94 544.895,-951.737 498,-1009 482.938,-1027.39 467.9,-1015 448,-1028"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-1028C435.72,-1034.72 367.284,-1013.3 323.763,-998.619"/>
<polygon fill="#000000" stroke="#000000" points="324.68,-995.234 314.086,-995.328 322.427,-1001.86 324.68,-995.234"/>
</g>
<!-- module~mesh -->
<g id="proc~~dhscf~~UsesGraph_node11" class="node"><title>module~mesh</title>
<g id="a_proc~~dhscf~~UsesGraph_node11"><a xlink:href=".././module/mesh.html" xlink:title="mesh">
<polygon fill="#337ab7" stroke="#337ab7" points="313.5,-1080 259.5,-1080 259.5,-1056 313.5,-1056 313.5,-1080"/>
<text text-anchor="middle" x="286.5" y="-1065.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mesh</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~mesh -->
<g id="proc~~dhscf~~UsesGraph_edge10" class="edge"><title>proc~dhscf&#45;&gt;module~mesh</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.415,-648.293C555.806,-721.495 535.501,-1097.9 498,-1131 442.746,-1179.77 351.008,-1119.05 309.318,-1086.32"/>
<polygon fill="#000000" stroke="#000000" points="311.432,-1083.53 301.442,-1080 307.051,-1088.99 311.432,-1083.53"/>
</g>
<!-- m_iotddft -->
<g id="proc~~dhscf~~UsesGraph_node12" class="node"><title>m_iotddft</title>
<polygon fill="#337ab7" stroke="#337ab7" points="475.5,-878 418.5,-878 418.5,-854 475.5,-854 475.5,-878"/>
<text text-anchor="middle" x="447" y="-863.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_iotddft</text>
</g>
<!-- proc~dhscf&#45;&gt;m_iotddft -->
<g id="proc~~dhscf~~UsesGraph_edge11" class="edge"><title>proc~dhscf&#45;&gt;m_iotddft</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.852,-648.086C558.785,-683.092 551.049,-785.815 498,-845 494.308,-849.119 489.677,-852.453 484.733,-855.146"/>
<polygon fill="#000000" stroke="#000000" points="483.254,-851.974 475.63,-859.332 486.178,-858.334 483.254,-851.974"/>
</g>
<!-- m_efield -->
<g id="proc~~dhscf~~UsesGraph_node13" class="node"><title>m_efield</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-836 420,-836 420,-812 474,-812 474,-836"/>
<text text-anchor="middle" x="447" y="-821.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_efield</text>
</g>
<!-- proc~dhscf&#45;&gt;m_efield -->
<g id="proc~~dhscf~~UsesGraph_edge12" class="edge"><title>proc~dhscf&#45;&gt;m_efield</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M558.769,-648.235C555.108,-678.452 541.662,-757.458 498,-803 493.868,-807.31 488.714,-810.774 483.299,-813.546"/>
<polygon fill="#000000" stroke="#000000" points="481.829,-810.368 474.072,-817.585 484.637,-816.781 481.829,-810.368"/>
</g>
<!-- m_doping_uniform -->
<g id="proc~~dhscf~~UsesGraph_node14" class="node"><title>m_doping_uniform</title>
<polygon fill="#337ab7" stroke="#337ab7" points="498,-794 396,-794 396,-770 498,-770 498,-794"/>
<text text-anchor="middle" x="447" y="-779.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_doping_uniform</text>
</g>
<!-- proc~dhscf&#45;&gt;m_doping_uniform -->
<g id="proc~~dhscf~~UsesGraph_edge13" class="edge"><title>proc~dhscf&#45;&gt;m_doping_uniform</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M557.083,-648.025C550.567,-672.492 532.611,-728.498 498,-761 496.726,-762.196 495.374,-763.33 493.962,-764.403"/>
<polygon fill="#000000" stroke="#000000" points="491.884,-761.576 485.342,-769.91 495.653,-767.475 491.884,-761.576"/>
</g>
<!-- files -->
<g id="proc~~dhscf~~UsesGraph_node15" class="node"><title>files</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-752 420,-752 420,-728 474,-728 474,-752"/>
<text text-anchor="middle" x="447" y="-737.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">files</text>
</g>
<!-- proc~dhscf&#45;&gt;files -->
<g id="proc~~dhscf~~UsesGraph_edge14" class="edge"><title>proc~dhscf&#45;&gt;files</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M553.758,-648.035C544.022,-665.762 523.65,-698.952 498,-719 493.596,-722.443 488.545,-725.418 483.384,-727.958"/>
<polygon fill="#000000" stroke="#000000" points="481.823,-724.821 474.092,-732.065 484.653,-731.223 481.823,-724.821"/>
</g>
<!-- m_rhofft -->
<g id="proc~~dhscf~~UsesGraph_node16" class="node"><title>m_rhofft</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-710 420,-710 420,-686 474,-686 474,-710"/>
<text text-anchor="middle" x="447" y="-695.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhofft</text>
</g>
<!-- proc~dhscf&#45;&gt;m_rhofft -->
<g id="proc~~dhscf~~UsesGraph_edge15" class="edge"><title>proc~dhscf&#45;&gt;m_rhofft</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M543.679,-648.011C531.469,-656.691 514.16,-668.361 498,-677 493.396,-679.461 488.44,-681.842 483.501,-684.061"/>
<polygon fill="#000000" stroke="#000000" points="481.917,-680.933 474.121,-688.108 484.69,-687.36 481.917,-680.933"/>
</g>
<!-- module~siesta_options -->
<g id="proc~~dhscf~~UsesGraph_node17" class="node"><title>module~siesta_options</title>
<g id="a_proc~~dhscf~~UsesGraph_node17"><a xlink:href=".././module/siesta_options.html" xlink:title="siesta_options">
<polygon fill="#337ab7" stroke="#337ab7" points="487.5,-668 406.5,-668 406.5,-644 487.5,-644 487.5,-668"/>
<text text-anchor="middle" x="447" y="-653.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_options</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~siesta_options -->
<g id="proc~~dhscf~~UsesGraph_edge16" class="edge"><title>proc~dhscf&#45;&gt;module~siesta_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M533.741,-640.689C522.925,-642.62 510.024,-644.924 497.556,-647.151"/>
<polygon fill="#000000" stroke="#000000" points="496.925,-643.708 487.696,-648.911 498.156,-650.599 496.925,-643.708"/>
</g>
<!-- module~m_forhar -->
<g id="proc~~dhscf~~UsesGraph_node18" class="node"><title>module~m_forhar</title>
<g id="a_proc~~dhscf~~UsesGraph_node18"><a xlink:href=".././module/m_forhar.html" xlink:title="m_forhar">
<polygon fill="#337ab7" stroke="#337ab7" points="475,-958 419,-958 419,-934 475,-934 475,-958"/>
<text text-anchor="middle" x="447" y="-943.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_forhar</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_forhar -->
<g id="proc~~dhscf~~UsesGraph_edge17" class="edge"><title>proc~dhscf&#45;&gt;module~m_forhar</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M558.704,-648.32C553.374,-697.049 531.81,-875.811 498,-920 494.306,-924.829 489.459,-928.845 484.236,-932.159"/>
<polygon fill="#000000" stroke="#000000" points="482.319,-929.218 475.231,-937.092 485.682,-935.358 482.319,-929.218"/>
</g>
<!-- m_ts_options -->
<g id="proc~~dhscf~~UsesGraph_node19" class="node"><title>m_ts_options</title>
<polygon fill="#337ab7" stroke="#337ab7" points="485,-588 409,-588 409,-564 485,-564 485,-588"/>
<text text-anchor="middle" x="447" y="-573.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_options</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_options -->
<g id="proc~~dhscf~~UsesGraph_edge18" class="edge"><title>proc~dhscf&#45;&gt;m_ts_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M538.257,-623.924C526.393,-617.373 511.427,-609.172 498,-602 492.336,-598.975 486.291,-595.792 480.431,-592.732"/>
<polygon fill="#000000" stroke="#000000" points="481.945,-589.574 471.458,-588.063 478.713,-595.783 481.945,-589.574"/>
</g>
<!-- m_ncdf_siesta -->
<g id="proc~~dhscf~~UsesGraph_node20" class="node"><title>m_ncdf_siesta</title>
<polygon fill="#337ab7" stroke="#337ab7" points="488,-546 406,-546 406,-522 488,-522 488,-546"/>
<text text-anchor="middle" x="447" y="-531.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ncdf_siesta</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ncdf_siesta -->
<g id="proc~~dhscf~~UsesGraph_edge19" class="edge"><title>proc~dhscf&#45;&gt;m_ncdf_siesta</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M553.522,-623.973C543.632,-606.613 523.23,-574.483 498,-555 496.184,-553.597 494.26,-552.271 492.266,-551.02"/>
<polygon fill="#000000" stroke="#000000" points="493.631,-547.776 483.185,-546.008 490.249,-553.905 493.631,-547.776"/>
</g>
<!-- module~moremeshsubs -->
<g id="proc~~dhscf~~UsesGraph_node21" class="node"><title>module~moremeshsubs</title>
<g id="a_proc~~dhscf~~UsesGraph_node21"><a xlink:href=".././module/moremeshsubs.html" xlink:title="moreMeshSubs">
<polygon fill="#337ab7" stroke="#337ab7" points="330.5,-626 242.5,-626 242.5,-602 330.5,-602 330.5,-626"/>
<text text-anchor="middle" x="286.5" y="-611.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">moreMeshSubs</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~moremeshsubs -->
<g id="proc~~dhscf~~UsesGraph_edge20" class="edge"><title>proc~dhscf&#45;&gt;module~moremeshsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M533.872,-633.891C489.637,-630.319 399.149,-623.014 341.01,-618.32"/>
<polygon fill="#000000" stroke="#000000" points="341.154,-614.82 330.904,-617.504 340.59,-621.798 341.154,-614.82"/>
</g>
<!-- module~precision -->
<g id="proc~~dhscf~~UsesGraph_node22" class="node"><title>module~precision</title>
<g id="a_proc~~dhscf~~UsesGraph_node22"><a xlink:href=".././module/precision.html" xlink:title="precision">
<polygon fill="#337ab7" stroke="#337ab7" points="63,-568 8,-568 8,-544 63,-544 63,-568"/>
<text text-anchor="middle" x="35.5" y="-553.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">precision</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge29" class="edge"><title>proc~dhscf&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-208C402.674,-176.181 258.686,-244.673 213,-273 192.673,-285.604 195.691,-298.077 177,-313 163.472,-323.801 156.825,-321.582 143,-332"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M141,-332C127.34,-342.633 118.102,-337.718 107,-351 60.8893,-406.167 44.3382,-493.159 38.9075,-533.755"/>
<polygon fill="#000000" stroke="#000000" points="35.4055,-533.557 37.6553,-543.911 42.3529,-534.414 35.4055,-533.557"/>
</g>
<!-- meshsubs -->
<g id="proc~~dhscf~~UsesGraph_node23" class="node"><title>meshsubs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="477.5,-466 416.5,-466 416.5,-442 477.5,-442 477.5,-466"/>
<text text-anchor="middle" x="447" y="-451.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">meshsubs</text>
</g>
<!-- proc~dhscf&#45;&gt;meshsubs -->
<g id="proc~~dhscf~~UsesGraph_edge22" class="edge"><title>proc~dhscf&#45;&gt;meshsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M558.156,-623.935C553.253,-595.556 537.469,-523.681 498,-480 494.69,-476.336 490.741,-473.107 486.535,-470.282"/>
<polygon fill="#000000" stroke="#000000" points="488.052,-467.113 477.661,-465.045 484.494,-473.142 488.052,-467.113"/>
</g>
<!-- mpi_siesta -->
<g id="proc~~dhscf~~UsesGraph_node24" class="node"><title>mpi_siesta</title>
<polygon fill="#337ab7" stroke="#337ab7" points="174,-384 110,-384 110,-360 174,-360 174,-384"/>
<text text-anchor="middle" x="142" y="-369.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_siesta</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_siesta -->
<g id="proc~~dhscf~~UsesGraph_edge23" class="edge"><title>proc~dhscf&#45;&gt;mpi_siesta</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.521,-623.932C561.336,-588.14 558.352,-482.024 498,-433 425.088,-373.773 381.191,-420.772 287.5,-414"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-414C248.938,-411.013 209.016,-398.381 180.754,-387.743"/>
<polygon fill="#000000" stroke="#000000" points="181.858,-384.417 171.268,-384.082 179.337,-390.948 181.858,-384.417"/>
</g>
<!-- m_spin -->
<g id="proc~~dhscf~~UsesGraph_node25" class="node"><title>m_spin</title>
<polygon fill="#337ab7" stroke="#337ab7" points="313.5,-188 259.5,-188 259.5,-164 313.5,-164 313.5,-188"/>
<text text-anchor="middle" x="286.5" y="-173.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_spin</text>
</g>
<!-- proc~dhscf&#45;&gt;m_spin -->
<g id="proc~~dhscf~~UsesGraph_edge24" class="edge"><title>proc~dhscf&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.764,-623.885C558.348,-562.956 549.195,-290.432 498,-227 483.07,-208.501 467.16,-222.072 448,-208"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-208C426.955,-194.013 364.416,-184.584 323.823,-179.766"/>
<polygon fill="#000000" stroke="#000000" points="324.098,-176.275 313.764,-178.613 323.3,-183.229 324.098,-176.275"/>
</g>
<!-- module~m_iorho -->
<g id="proc~~dhscf~~UsesGraph_node26" class="node"><title>module~m_iorho</title>
<g id="a_proc~~dhscf~~UsesGraph_node26"><a xlink:href=".././module/m_iorho.html" xlink:title="m_iorho">
<polygon fill="#337ab7" stroke="#337ab7" points="313.5,-466 259.5,-466 259.5,-442 313.5,-442 313.5,-466"/>
<text text-anchor="middle" x="286.5" y="-451.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_iorho</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_iorho -->
<g id="proc~~dhscf~~UsesGraph_edge25" class="edge"><title>proc~dhscf&#45;&gt;module~m_iorho</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M557.017,-623.695C550.481,-599.245 532.639,-544.219 498,-513 480.341,-497.084 468.757,-505.588 448,-494"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-494C425.199,-482.388 363.513,-468.803 323.514,-460.827"/>
<polygon fill="#000000" stroke="#000000" points="324.09,-457.373 313.602,-458.877 322.738,-464.242 324.09,-457.373"/>
</g>
<!-- m_vmat -->
<g id="proc~~dhscf~~UsesGraph_node27" class="node"><title>m_vmat</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-344 420,-344 420,-320 474,-320 474,-344"/>
<text text-anchor="middle" x="447" y="-329.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_vmat</text>
</g>
<!-- proc~dhscf&#45;&gt;m_vmat -->
<g id="proc~~dhscf~~UsesGraph_edge26" class="edge"><title>proc~dhscf&#45;&gt;m_vmat</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M558.835,-623.972C553.931,-575.585 533.567,-395.708 498,-353 494.102,-348.319 488.98,-344.663 483.502,-341.812"/>
<polygon fill="#000000" stroke="#000000" points="484.667,-338.503 474.1,-337.737 481.883,-344.925 484.667,-338.503"/>
</g>
<!-- m_ts_hartree -->
<g id="proc~~dhscf~~UsesGraph_node28" class="node"><title>m_ts_hartree</title>
<polygon fill="#337ab7" stroke="#337ab7" points="485,-302 409,-302 409,-278 485,-278 485,-302"/>
<text text-anchor="middle" x="447" y="-287.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ts_hartree</text>
</g>
<!-- proc~dhscf&#45;&gt;m_ts_hartree -->
<g id="proc~~dhscf~~UsesGraph_edge27" class="edge"><title>proc~dhscf&#45;&gt;m_ts_hartree</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.185,-623.672C555.439,-570.442 538.314,-360.767 498,-311 496.689,-309.381 495.231,-307.886 493.661,-306.504"/>
<polygon fill="#000000" stroke="#000000" points="495.251,-303.345 485.045,-300.5 491.249,-309.088 495.251,-303.345"/>
</g>
<!-- iogrid_netcdf -->
<g id="proc~~dhscf~~UsesGraph_node29" class="node"><title>iogrid_netcdf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="484,-260 410,-260 410,-236 484,-236 484,-260"/>
<text text-anchor="middle" x="447" y="-245.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">iogrid_netcdf</text>
</g>
<!-- proc~dhscf&#45;&gt;iogrid_netcdf -->
<g id="proc~~dhscf~~UsesGraph_edge28" class="edge"><title>proc~dhscf&#45;&gt;iogrid_netcdf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.479,-623.665C556.83,-566.296 543.158,-325.968 498,-269 496.388,-266.966 494.543,-265.127 492.535,-263.464"/>
<polygon fill="#000000" stroke="#000000" points="494.391,-260.496 484.123,-257.885 490.522,-266.329 494.391,-260.496"/>
</g>
<!-- alloc -->
<g id="proc~~dhscf~~UsesGraph_node30" class="node"><title>alloc</title>
<polygon fill="#337ab7" stroke="#337ab7" points="169,-563 115,-563 115,-539 169,-539 169,-563"/>
<text text-anchor="middle" x="142" y="-548.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge21" class="edge"><title>proc~dhscf&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M446,-494C400.451,-468.572 248.612,-514.908 178.743,-538.469"/>
<polygon fill="#000000" stroke="#000000" points="177.39,-535.232 169.052,-541.769 179.646,-541.859 177.39,-535.232"/>
</g>
<!-- module~atmfuncs -->
<g id="proc~~dhscf~~UsesGraph_node31" class="node"><title>module~atmfuncs</title>
<g id="a_proc~~dhscf~~UsesGraph_node31"><a xlink:href=".././module/atmfuncs.html" xlink:title="atmfuncs">
<polygon fill="#337ab7" stroke="#337ab7" points="475,-386 419,-386 419,-362 475,-362 475,-386"/>
<text text-anchor="middle" x="447" y="-371.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">atmfuncs</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~atmfuncs -->
<g id="proc~~dhscf~~UsesGraph_edge30" class="edge"><title>proc~dhscf&#45;&gt;module~atmfuncs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.105,-623.965C559.816,-586.512 554.19,-470.331 498,-400 494.205,-395.25 489.306,-391.274 484.063,-387.976"/>
<polygon fill="#000000" stroke="#000000" points="485.502,-384.774 475.049,-383.05 482.145,-390.917 485.502,-384.774"/>
</g>
<!-- module~m_rhoofd -->
<g id="proc~~dhscf~~UsesGraph_node32" class="node"><title>module~m_rhoofd</title>
<g id="a_proc~~dhscf~~UsesGraph_node32"><a xlink:href=".././module/m_rhoofd.html" xlink:title="m_rhoofd">
<polygon fill="#337ab7" stroke="#337ab7" points="476,-180 418,-180 418,-156 476,-156 476,-180"/>
<text text-anchor="middle" x="447" y="-165.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhoofd</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_rhoofd -->
<g id="proc~~dhscf~~UsesGraph_edge31" class="edge"><title>proc~dhscf&#45;&gt;module~m_rhoofd</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.767,-623.883C558.333,-560.379 548.989,-266.134 498,-194 494.563,-189.138 489.934,-185.118 484.875,-181.814"/>
<polygon fill="#000000" stroke="#000000" points="486.525,-178.728 476.088,-176.91 483.114,-184.84 486.525,-178.728"/>
</g>
<!-- fdf -->
<g id="proc~~dhscf~~UsesGraph_node33" class="node"><title>fdf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="474,-138 420,-138 420,-114 474,-114 474,-138"/>
<text text-anchor="middle" x="447" y="-123.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">fdf</text>
</g>
<!-- proc~dhscf&#45;&gt;fdf -->
<g id="proc~~dhscf~~UsesGraph_edge32" class="edge"><title>proc~dhscf&#45;&gt;fdf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.054,-623.879C560.126,-556.19 557.4,-225.195 498,-147 494.279,-142.101 489.199,-138.335 483.698,-135.442"/>
<polygon fill="#000000" stroke="#000000" points="484.775,-132.095 474.206,-131.353 482.005,-138.524 484.775,-132.095"/>
</g>
<!-- module~m_rhog -->
<g id="proc~~dhscf~~UsesGraph_node34" class="node"><title>module~m_rhog</title>
<g id="a_proc~~dhscf~~UsesGraph_node34"><a xlink:href=".././module/m_rhog.html" xlink:title="m_rhog">
<polygon fill="#337ab7" stroke="#337ab7" points="474,-96 420,-96 420,-72 474,-72 474,-96"/>
<text text-anchor="middle" x="447" y="-81.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhog</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;module~m_rhog -->
<g id="proc~~dhscf~~UsesGraph_edge33" class="edge"><title>proc~dhscf&#45;&gt;module~m_rhog</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M560.191,-623.789C561.07,-552.516 562.283,-190.497 498,-105 494.303,-100.083 489.235,-96.3075 483.738,-93.4117"/>
<polygon fill="#000000" stroke="#000000" points="484.816,-90.0649 474.247,-89.3221 482.046,-96.4936 484.816,-90.0649"/>
</g>
<!-- m_hartree_add -->
<g id="proc~~dhscf~~UsesGraph_node35" class="node"><title>m_hartree_add</title>
<polygon fill="#337ab7" stroke="#337ab7" points="490,-54 404,-54 404,-30 490,-30 490,-54"/>
<text text-anchor="middle" x="447" y="-39.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_hartree_add</text>
</g>
<!-- proc~dhscf&#45;&gt;m_hartree_add -->
<g id="proc~~dhscf~~UsesGraph_edge34" class="edge"><title>proc~dhscf&#45;&gt;m_hartree_add</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M559.42,-623.835C555.569,-545.126 532.792,-109.683 498,-63 497.434,-62.2404 496.835,-61.508 496.207,-60.8019"/>
<polygon fill="#000000" stroke="#000000" points="498.381,-58.0553 488.512,-54.1993 493.822,-63.3676 498.381,-58.0553"/>
</g>
<!-- module~units&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge35" class="edge"><title>module~units&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M130.097,-993.885C122.43,-984.689 112.58,-971.385 107,-958 50.1505,-821.623 39.1384,-640.699 37.0091,-578.281"/>
<polygon fill="#000000" stroke="#000000" points="40.5005,-577.934 36.7059,-568.042 33.5035,-578.141 40.5005,-577.934"/>
</g>
<!-- module~mesh&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge36" class="edge"><title>module~mesh&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.232,-1070.35C219.946,-1072.27 146.311,-1069.47 107,-1027 45.4541,-960.51 37.6171,-662.669 36.6361,-578.323"/>
<polygon fill="#000000" stroke="#000000" points="40.1358,-578.261 36.5412,-568.294 33.1361,-578.327 40.1358,-578.261"/>
</g>
<!-- module~m_forhar&#45;&gt;module~parallel -->
<g id="proc~~dhscf~~UsesGraph_edge41" class="edge"><title>module~m_forhar&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-944C266.371,-935.943 214.636,-922.125 179.066,-913.026"/>
<polygon fill="#000000" stroke="#000000" points="179.605,-909.552 169.051,-910.48 177.88,-916.336 179.605,-909.552"/>
</g>
<!-- module~m_forhar&#45;&gt;siestaXC -->
<g id="proc~~dhscf~~UsesGraph_edge38" class="edge"><title>module~m_forhar&#45;&gt;siestaXC</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.753,-952.876C392.546,-959.49 352.755,-969.532 323.855,-976.825"/>
<polygon fill="#000000" stroke="#000000" points="322.967,-973.439 314.128,-979.28 324.68,-980.227 322.967,-973.439"/>
</g>
<!-- module~m_forhar&#45;&gt;module~mesh -->
<g id="proc~~dhscf~~UsesGraph_edge42" class="edge"><title>module~m_forhar&#45;&gt;module~mesh</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.907,-954.847C411.138,-958.039 402.907,-962.092 396,-967 376.504,-980.854 377.192,-990.372 360,-1007 344.383,-1022.1 325.583,-1037.86 311.04,-1049.58"/>
<polygon fill="#000000" stroke="#000000" points="308.66,-1047 303.026,-1055.97 313.026,-1052.47 308.66,-1047"/>
</g>
<!-- module~m_forhar&#45;&gt;module~moremeshsubs -->
<g id="proc~~dhscf~~UsesGraph_edge39" class="edge"><title>module~m_forhar&#45;&gt;module~moremeshsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M433.581,-933.808C422.574,-922.478 406.642,-904.728 396,-887 343.883,-800.185 307.346,-683.831 293.569,-635.969"/>
<polygon fill="#000000" stroke="#000000" points="296.86,-634.745 290.767,-626.077 290.125,-636.653 296.86,-634.745"/>
</g>
<!-- module~m_forhar&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge37" class="edge"><title>module~m_forhar&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-944C211.974,-913.032 165.699,-979.033 107,-925 55.643,-877.726 40.8808,-651.534 37.4217,-578.671"/>
<polygon fill="#000000" stroke="#000000" points="40.9032,-578.178 36.9597,-568.344 33.9102,-578.491 40.9032,-578.178"/>
</g>
<!-- module~m_forhar&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge40" class="edge"><title>module~m_forhar&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.953,-951.623C386.363,-957.083 330.615,-962.16 287.5,-944"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-944C212.984,-913.457 161.078,-652.703 146.893,-573.635"/>
<polygon fill="#000000" stroke="#000000" points="150.261,-572.576 145.076,-563.336 143.367,-573.793 150.261,-572.576"/>
</g>
<!-- module~moremeshsubs&#45;&gt;module~parallel -->
<g id="proc~~dhscf~~UsesGraph_edge43" class="edge"><title>module~moremeshsubs&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M279.558,-626.092C257.694,-670.587 181.53,-825.588 153.477,-882.678"/>
<polygon fill="#000000" stroke="#000000" points="150.236,-881.338 148.967,-891.857 156.518,-884.425 150.236,-881.338"/>
</g>
<!-- module~moremeshsubs&#45;&gt;module~sys -->
<g id="proc~~dhscf~~UsesGraph_edge46" class="edge"><title>module~moremeshsubs&#45;&gt;module~sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M280.543,-601.816C267.476,-570.86 229.456,-487.897 177,-435 176.093,-434.086 175.139,-433.193 174.149,-432.325"/>
<polygon fill="#000000" stroke="#000000" points="176.133,-429.436 166.057,-426.159 171.89,-435.004 176.133,-429.436"/>
</g>
<!-- module~moremeshsubs&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge44" class="edge"><title>module~moremeshsubs&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M242.412,-603.963C194.632,-592.834 118.365,-575.069 73.2847,-564.568"/>
<polygon fill="#000000" stroke="#000000" points="73.8793,-561.113 63.346,-562.253 72.2912,-567.931 73.8793,-561.113"/>
</g>
<!-- module~moremeshsubs&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge45" class="edge"><title>module~moremeshsubs&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M258.025,-601.853C235.463,-591.878 203.339,-577.676 178.772,-566.815"/>
<polygon fill="#000000" stroke="#000000" points="179.989,-563.526 169.428,-562.684 177.158,-569.928 179.989,-563.526"/>
</g>
<!-- module~m_iorho&#45;&gt;module~parallel -->
<g id="proc~~dhscf~~UsesGraph_edge50" class="edge"><title>module~m_iorho&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M277.771,-466.149C263.099,-489.719 231.065,-543.675 213,-593 174.698,-697.577 153.359,-829.914 145.981,-881.749"/>
<polygon fill="#000000" stroke="#000000" points="142.492,-881.429 144.582,-891.816 149.426,-882.393 142.492,-881.429"/>
</g>
<!-- module~m_iorho&#45;&gt;module~sys -->
<g id="proc~~dhscf~~UsesGraph_edge52" class="edge"><title>module~m_iorho&#45;&gt;module~sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.363,-446.663C236.906,-440.36 204.292,-431.205 179.302,-424.19"/>
<polygon fill="#000000" stroke="#000000" points="180.027,-420.758 169.454,-421.426 178.136,-427.498 180.027,-420.758"/>
</g>
<!-- module~m_iorho&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge47" class="edge"><title>module~m_iorho&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.178,-462.996C245.354,-467.832 228.177,-474.018 213,-480 163.918,-499.346 108.127,-523.791 72.6433,-539.653"/>
<polygon fill="#000000" stroke="#000000" points="70.8893,-536.604 63.196,-543.888 73.7528,-542.991 70.8893,-536.604"/>
</g>
<!-- module~m_iorho&#45;&gt;mpi_siesta -->
<g id="proc~~dhscf~~UsesGraph_edge51" class="edge"><title>module~m_iorho&#45;&gt;mpi_siesta</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.459,-447.595C245.081,-443.356 227.294,-436.919 213,-428 194.067,-416.188 194.597,-406.723 177,-393 175.646,-391.944 174.236,-390.896 172.793,-389.864"/>
<polygon fill="#000000" stroke="#000000" points="174.593,-386.857 164.339,-384.19 170.692,-392.669 174.593,-386.857"/>
</g>
<!-- module~m_iorho&#45;&gt;alloc -->
<g id="proc~~dhscf~~UsesGraph_edge49" class="edge"><title>module~m_iorho&#45;&gt;alloc</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.385,-460.288C244.984,-464.49 227.199,-470.931 213,-480 207.012,-483.825 179.906,-511.954 161.237,-531.635"/>
<polygon fill="#000000" stroke="#000000" points="158.647,-529.28 154.318,-538.949 163.732,-534.09 158.647,-529.28"/>
</g>
<!-- parallelsubs -->
<g id="proc~~dhscf~~UsesGraph_node39" class="node"><title>parallelsubs</title>
<polygon fill="#337ab7" stroke="#337ab7" points="177,-468 107,-468 107,-444 177,-444 177,-468"/>
<text text-anchor="middle" x="142" y="-453.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parallelsubs</text>
</g>
<!-- module~m_iorho&#45;&gt;parallelsubs -->
<g id="proc~~dhscf~~UsesGraph_edge48" class="edge"><title>module~m_iorho&#45;&gt;parallelsubs</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M259.363,-454.367C239.206,-454.65 210.865,-455.048 187.199,-455.38"/>
<polygon fill="#000000" stroke="#000000" points="186.992,-451.882 177.042,-455.522 187.09,-458.881 186.992,-451.882"/>
</g>
<!-- module~atmfuncs&#45;&gt;module~sys -->
<g id="proc~~dhscf~~UsesGraph_edge57" class="edge"><title>module~atmfuncs&#45;&gt;module~sys</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-376C248.167,-375.845 207.134,-388.194 178.726,-398.854"/>
<polygon fill="#000000" stroke="#000000" points="177.293,-395.655 169.231,-402.53 179.82,-402.183 177.293,-395.655"/>
</g>
<!-- module~atmfuncs&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge54" class="edge"><title>module~atmfuncs&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.796,-374.62C387.225,-375.276 333.595,-376.191 287.5,-376"/>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M285.5,-376C252.19,-375.862 244.826,-366.833 213,-357 181.437,-347.248 169.383,-312.118 143,-332"/>
</g>
<!-- spher_harm -->
<g id="proc~~dhscf~~UsesGraph_node36" class="node"><title>spher_harm</title>
<polygon fill="#337ab7" stroke="#337ab7" points="321.5,-348 251.5,-348 251.5,-324 321.5,-324 321.5,-348"/>
<text text-anchor="middle" x="286.5" y="-333.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">spher_harm</text>
</g>
<!-- module~atmfuncs&#45;&gt;spher_harm -->
<g id="proc~~dhscf~~UsesGraph_edge55" class="edge"><title>module~atmfuncs&#45;&gt;spher_harm</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.753,-367.468C394.789,-361.722 359.466,-353.254 331.499,-346.549"/>
<polygon fill="#000000" stroke="#000000" points="332.104,-343.094 321.563,-344.167 330.471,-349.902 332.104,-343.094"/>
</g>
<!-- module~atm_types -->
<g id="proc~~dhscf~~UsesGraph_node41" class="node"><title>module~atm_types</title>
<g id="a_proc~~dhscf~~UsesGraph_node41"><a xlink:href=".././module/atm_types.html" xlink:title="atm_types">
<polygon fill="#337ab7" stroke="#337ab7" points="317.5,-306 255.5,-306 255.5,-282 317.5,-282 317.5,-306"/>
<text text-anchor="middle" x="286.5" y="-291.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">atm_types</text>
</a>
</g>
</g>
<!-- module~atmfuncs&#45;&gt;module~atm_types -->
<g id="proc~~dhscf~~UsesGraph_edge53" class="edge"><title>module~atmfuncs&#45;&gt;module~atm_types</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.986,-365.041C411.218,-361.846 402.969,-357.82 396,-353 376.865,-339.768 379.868,-327.104 360,-315 350.147,-308.997 338.495,-304.639 327.448,-301.505"/>
<polygon fill="#000000" stroke="#000000" points="328.098,-298.058 317.541,-298.959 326.355,-304.838 328.098,-298.058"/>
</g>
<!-- module~radial -->
<g id="proc~~dhscf~~UsesGraph_node42" class="node"><title>module~radial</title>
<g id="a_proc~~dhscf~~UsesGraph_node42"><a xlink:href=".././module/radial.html" xlink:title="radial">
<polygon fill="#337ab7" stroke="#337ab7" points="169,-304 115,-304 115,-280 169,-280 169,-304"/>
<text text-anchor="middle" x="142" y="-289.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">radial</text>
</a>
</g>
</g>
<!-- module~atmfuncs&#45;&gt;module~radial -->
<g id="proc~~dhscf~~UsesGraph_edge56" class="edge"><title>module~atmfuncs&#45;&gt;module~radial</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M418.886,-366.837C410.761,-363.651 402.336,-359.179 396,-353 368.085,-325.78 392.742,-294.17 360,-273 304.821,-237.322 224.582,-258.827 178.718,-276.328"/>
<polygon fill="#000000" stroke="#000000" points="177.213,-273.159 169.201,-280.092 179.788,-279.669 177.213,-273.159"/>
</g>
<!-- module~m_rhog&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge58" class="edge"><title>module~m_rhog&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.927,-94.8911C403.016,-101.734 380.41,-110.469 360,-117 295.729,-137.565 270.82,-120.208 213,-155 153.16,-191.008 139.957,-209.427 107,-271 58.9224,-360.824 42.9427,-484.127 38.2471,-533.868"/>
<polygon fill="#000000" stroke="#000000" points="34.7594,-533.576 37.3664,-543.846 41.7322,-534.192 34.7594,-533.576"/>
</g>
<!-- module~m_rhog&#45;&gt;m_spin -->
<g id="proc~~dhscf~~UsesGraph_edge60" class="edge"><title>module~m_rhog&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.758,-92.1775C411.68,-95.4181 403.062,-99.6663 396,-105 375.561,-120.436 380.843,-135.114 360,-150 349.096,-157.788 335.619,-163.463 323.255,-167.485"/>
<polygon fill="#000000" stroke="#000000" points="322.221,-164.141 313.648,-170.366 324.232,-170.846 322.221,-164.141"/>
</g>
<!-- class_Pair_dData1D -->
<g id="proc~~dhscf~~UsesGraph_node37" class="node"><title>class_Pair_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="341,-108 232,-108 232,-84 341,-84 341,-108"/>
<text text-anchor="middle" x="286.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_Pair_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_Pair_dData1D -->
<g id="proc~~dhscf~~UsesGraph_edge59" class="edge"><title>module~m_rhog&#45;&gt;class_Pair_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.827,-85.9816C401.132,-87.397 375.143,-89.3646 351.143,-91.1816"/>
<polygon fill="#000000" stroke="#000000" points="350.713,-87.7041 341.005,-91.9491 351.241,-94.6841 350.713,-87.7041"/>
</g>
<!-- class_dData1D -->
<g id="proc~~dhscf~~UsesGraph_node38" class="node"><title>class_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="329,-66 244,-66 244,-42 329,-42 329,-66"/>
<text text-anchor="middle" x="286.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_dData1D -->
<g id="proc~~dhscf~~UsesGraph_edge62" class="edge"><title>module~m_rhog&#45;&gt;class_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.827,-79.0461C397.996,-74.9141 366.221,-68.8999 339.28,-63.8006"/>
<polygon fill="#000000" stroke="#000000" points="339.698,-60.3177 329.222,-61.8969 338.396,-67.1956 339.698,-60.3177"/>
</g>
<!-- class_Fstack_Pair_dData1D -->
<g id="proc~~dhscf~~UsesGraph_node40" class="node"><title>class_Fstack_Pair_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="360,-24 213,-24 213,-0 360,-0 360,-24"/>
<text text-anchor="middle" x="286.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_Fstack_Pair_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_Fstack_Pair_dData1D -->
<g id="proc~~dhscf~~UsesGraph_edge61" class="edge"><title>module~m_rhog&#45;&gt;class_Fstack_Pair_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M419.844,-74.7266C411.941,-71.4768 403.402,-67.4992 396,-63 378.203,-52.1817 378.393,-42.7713 360,-33 356.456,-31.1172 352.722,-29.3843 348.895,-27.7925"/>
<polygon fill="#000000" stroke="#000000" points="349.835,-24.4053 339.244,-24.1209 347.346,-30.9479 349.835,-24.4053"/>
</g>
<!-- module~atm_types&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge63" class="edge"><title>module~atm_types&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.37,-295.511C224.391,-298.451 176.126,-307.037 143,-332"/>
</g>
<!-- module~atm_types&#45;&gt;module~radial -->
<g id="proc~~dhscf~~UsesGraph_edge64" class="edge"><title>module~atm_types&#45;&gt;module~radial</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M255.279,-293.576C233.175,-293.266 203.078,-292.843 179.609,-292.514"/>
<polygon fill="#000000" stroke="#000000" points="179.393,-289.011 169.344,-292.37 179.294,-296.01 179.393,-289.011"/>
</g>
<!-- module~radial&#45;&gt;module~precision -->
<g id="proc~~dhscf~~UsesGraph_edge66" class="edge"><title>module~radial&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M120.727,-304.205C115.65,-308.075 110.624,-312.736 107,-318 59.2386,-387.37 43.313,-489.534 38.4509,-533.989"/>
<polygon fill="#000000" stroke="#000000" points="34.9632,-533.692 37.4405,-543.993 41.9278,-534.396 34.9632,-533.692"/>
</g>
<!-- xml -->
<g id="proc~~dhscf~~UsesGraph_node43" class="node"><title>xml</title>
<polygon fill="#337ab7" stroke="#337ab7" points="62.5,-325 8.5,-325 8.5,-301 62.5,-301 62.5,-325"/>
<text text-anchor="middle" x="35.5" y="-310.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xml</text>
</g>
<!-- module~radial&#45;&gt;xml -->
<g id="proc~~dhscf~~UsesGraph_edge65" class="edge"><title>module~radial&#45;&gt;xml</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M114.9,-297.245C102.182,-299.801 86.6791,-302.916 72.8271,-305.7"/>
<polygon fill="#000000" stroke="#000000" points="71.7441,-302.347 62.6296,-307.749 73.1232,-309.21 71.7441,-302.347"/>
</g>
<!-- interpolation -->
<g id="proc~~dhscf~~UsesGraph_node44" class="node"><title>interpolation</title>
<polygon fill="#337ab7" stroke="#337ab7" points="71,-283 0,-283 0,-259 71,-259 71,-283"/>
<text text-anchor="middle" x="35.5" y="-268.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">interpolation</text>
</g>
<!-- module~radial&#45;&gt;interpolation -->
<g id="proc~~dhscf~~UsesGraph_edge67" class="edge"><title>module~radial&#45;&gt;interpolation</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M114.9,-286.755C104.707,-284.707 92.7249,-282.299 81.2377,-279.99"/>
<polygon fill="#000000" stroke="#000000" points="81.8212,-276.538 71.3276,-277.999 80.442,-283.401 81.8212,-276.538"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="490pt" height="32pt"
 viewBox="0.00 0.00 489.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 485.5,-28 485.5,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node"><title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24 0,-24 0,-0 54,-0 54,-24"/>
<text text-anchor="middle" x="27" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node"><title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="139.5,-24 72.5,-24 72.5,-0 139.5,-0 139.5,-24"/>
<text text-anchor="middle" x="106" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="222,-24 158,-24 158,-0 222,-0 222,-24"/>
<text text-anchor="middle" x="190" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="294,-24 240,-24 240,-0 294,-0 294,-24"/>
<text text-anchor="middle" x="267" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="366,-24 312,-24 312,-0 366,-0 366,-24"/>
<text text-anchor="middle" x="339" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="481.5,-24 384.5,-24 384.5,-0 481.5,-0 481.5,-24"/>
<text text-anchor="middle" x="433" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a submodule to the (sub)module which it is
    descended from. Dashed arrows point from a module or program unit to 
    modules which it uses.
    </p>
    </div></div></div></div>
      </li>
      
      </ul>
    </div>
    


    
    <p>Calculates the self-consistent field contributions to Hamiltonian
 matrix elements, total energy and atomic forces.</p>
<p>Coded by J.M. Soler, August 1996. July 1997.<br>
 Modified by J.D. Gale, February 2000.</p>
<h3>Units</h3>
<p>Energies in Rydbergs.<br>
 Distances in Bohr.</p>
<h3>Routines called internally</h3>
<ul>
<li><a>cellxc</a>    : Finds total exch-corr energy and potential</li>
<li><a href="../proc/cross.html">CROSS</a>   : Finds the cross product of two vectors</li>
<li><a>dfscf</a>     : Finds SCF contribution to atomic forces</li>
<li><a>dipole</a>    : Finds electric dipole moment</li>
<li><a>doping</a>    : Adds a background charge for doped systems</li>
<li><a href="../proc/write_rho.html">write_rho</a>     : Saves electron density on a file</li>
<li><a>poison</a>    : Solves Poisson equation</li>
<li><a href="../proc/reord.html">reord</a>     : Reorders electron density and potential arrays</li>
<li><a>rhooda</a>    : Finds Harris electron density in the mesh</li>
<li><a href="../proc/rhoofd.html">rhoofd</a>    : Finds SCF electron density in the mesh</li>
<li><a>rhoofdsp</a>  : Finds SCF electron density in the mesh for
                    spiral arrangement of spins</li>
<li><a>timer</a>     : Finds CPU times</li>
<li><a>vmat</a>      : Finds matrix elements of SCF potential</li>
<li><a>vmatsp</a>    : Finds matrix elements of SCF potential for
                         spiral arrangement of spins</li>
<li><a href="../proc/delk.html">delk</a> : Finds matrix elements of <script type="math/tex"> exp(i \vec{k} \cdot \vec{r}) </script>
</li>
<li>real*8 volcel( cell ) : Returns volume of unit cell</li>
</ul>
<h3>Internal variables and arrays</h3>
<ul>
<li><code>real*8  bcell(3,3)</code>    : Bulk lattice vectors</li>
<li><code>real*8  cell(3,3)</code>     : Auxiliary lattice vectors (same as ucell)</li>
<li><code>real*8  const</code>         : Auxiliary variable (constant within a loop)</li>
<li><code>real*8  DEc</code>           : Auxiliary variable to call cellxc</li>
<li><code>real*8  DEx</code>           : Auxiliary variable to call cellxc</li>
<li><code>real*8  dvol</code>          : Mesh-cell volume</li>
<li><code>real*8  Ec</code>            : Correlation energy</li>
<li><code>real*8  Ex</code>            : Exchange energy</li>
<li><code>real*8  field(3)</code>      : External electric field</li>
<li><code>integer i</code>             : General-purpose index</li>
<li><code>integer ia</code>            : Atom index</li>
<li><code>integer io</code>            : Orbital index</li>
<li><code>integer ip</code>            : Point index</li>
<li><code>integer is</code>            : Species index</li>
<li><code>logical IsDiag</code>        : Is supercell diagonal?</li>
<li><code>integer ispin</code>         : Spin index</li>
<li><code>integer j</code>             : General-purpose index</li>
<li><code>integer JDGdistr</code>      : J.D.Gale's parallel distribution of mesh points</li>
<li><code>integer myBox(2,3)</code>    : My processor's mesh box</li>
<li><code>integer nbcell</code>        : Number of independent bulk lattice vectors</li>
<li><code>integer npcc</code>          : Partial core corrections? (0=no, 1=yes)</li>
<li><code>integer nsd</code>           : Number of diagonal spin values (1 or 2)</li>
<li><code>integer ntpl</code>          : Number of mesh Total Points in unit cell
                           (including subpoints) locally</li>
<li><code>real*4  rhoatm(ntpl)</code>  : Harris electron density</li>
<li><code>real*4  rhopcc(ntpl)</code>  : Partial-core-correction density for xc</li>
<li><code>real*4  DRho(ntpl)</code>    : Selfconsistent electron density difference</li>
<li><code>real*8  rhotot</code>        : Total density at one point</li>
<li><code>real*8  rmax</code>          : Maximum orbital radius</li>
<li><code>real*8  scell(3,3)</code>    : Supercell vectors</li>
<li><code>character shape*10</code>    : Name of system shape</li>
<li><code>real*4  Vaux(ntpl)</code>    : Auxiliary potential array</li>
<li><code>real*4  Vna(ntpl)</code>     : Sum of neutral-atom potentials</li>
<li><code>real*8  volume</code>        : Unit cell volume</li>
<li><code>real*4  Vscf(ntpl)</code>    : Hartree potential of selfconsistent density</li>
<li><code>real*8  x0(3)</code>         : Center of molecule</li>
<li><code>logical harrisfun</code>     : Harris functional or Kohn-Sham?</li>
</ul>
<p>Use the functionality in the first block
 of the routine to get charge files and partial charges</p>
    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nspin%7E8"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nspin</strong></td><td><p>Number of different spin polarisations:<br>
 nspin=1 =&gt; Unpolarized, nspin=2 =&gt; polarized<br>
 nspin=4 =&gt; Noncollinear spin or spin-orbit.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-norb%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>norb</strong></td><td><p>Total number of basis orbitals in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iaorb%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iaorb</strong>(norb)</td><td><p>Atom to which each orbital belongs</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iphorb%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iphorb</strong>(norb)</td><td><p>Orbital index (within atom) of each orbital</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nuo%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nuo</strong></td><td><p>Number of orbitals in a unit cell in this node</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nuotot%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nuotot</strong></td><td><p>Number of orbitals in a unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nua%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>nua</strong></td><td><p>Number of atoms in unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-na%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>na</strong></td><td><p>Number of atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-isa%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>isa</strong>(na)</td><td><p>Species index of all atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-xa%7E2"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>xa</strong>(3,na)</td><td><p>Atomic positions of all atoms in supercell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-indxua%7E2"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>indxua</strong>(na)</td><td><p>Index of equivalent atom in unit cell</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ntm%7E2"></span>integer,</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>ntm</strong>(3)</td><td><p>Number of mesh divisions of each cell
 vector, including subgrid.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ifa"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>ifa</strong></td><td><p>Switch which fixes whether the SCF contrib:<br>
 to atomic forces is calculated and added to fa.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-istr"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>istr</strong></td><td><p>Switch which fixes whether the SCF contrib:<br>
 to stress is calculated and added to stress.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ihmat"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iHmat</strong></td><td><p>Switch which fixes whether the Hmat matrix
 elements are calculated or not.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-filesout"></span>type(filesOut_t),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>filesOut</strong></td><td><p>Output file names (If blank =&gt; not saved)</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-maxnd%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>maxnd</strong></td><td><p>First dimension of listd and Dscf</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-numd%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>numd</strong>(nuo)</td><td><p>Number of nonzero density-matrix
 elements for each matrix row</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-listdptr%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>listdptr</strong>(nuo)</td><td><p>Pointer to start of rows of density-matrix</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-listd%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>listd</strong>(*)</td><td><p><code>listd(maxnd)</code>: Nonzero-density-matrix-element column
 indexes for each matrix row</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dscf%7E2"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Dscf</strong>(:,:)</td><td><p><code>Dscf(maxnd,h_spin_dim)</code>:<br>
 SCF density-matrix elements</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-datm%7E2"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>datm</strong>(norb)</td><td><p>Harris density-matrix diagonal elements<br>
 (atomic occupation charges of orbitals)</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-maxnh"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>maxnh</strong></td><td><p>First dimension of listh and Hmat</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-hmat"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Hmat</strong>(:,:)</td><td><p><code>Hmat(maxnh,h_spin_dim)</code>:<br>
 Hamiltonian matrix in sparse form,<br>
 to which are added the matrix elements<br>
<code>&lt;ORB_I | DeltaV | ORB_J&gt;</code>, where<br>
<code>DeltaV = Vna + Vxc(SCF) + Vhartree(RhoSCF-RhoHarris)</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-enaatm"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Enaatm</strong></td><td><p>Integral of <code>Vna * rhoatm</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-enascf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Enascf</strong></td><td><p>Integral of <code>Vna * rhoscf</code></p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-uatm"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Uatm</strong></td><td><p>Harris hartree electron-interaction energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-uscf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Uscf</strong></td><td><p>SCF hartree electron-interaction energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-duscf"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DUscf</strong></td><td><p>Electrostatic (Hartree) energy of
 <code>(rhoscf - rhoatm)</code> density</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-duext"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DUext</strong></td><td><p>Interaction energy with external electric field</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-exc"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Exc</strong></td><td><p>SCF exchange-correlation energy</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dxc"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Dxc</strong></td><td><p>SCF double-counting correction to Exc<br>
<code>Dxc = integral of ( (epsxc - Vxc) * Rho )</code><br>
 All energies in Rydbergs</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-dipol"></span>real(kind=dp),</td>
  <td>intent(out)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>dipol</strong>(3)</td><td><p>Electric dipole (in a.u.)
 only when the system is a molecule</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-stress"></span>real(kind=dp)</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>stress</strong>(3,3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-fal%7E2"></span>real(kind=dp),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>Fal</strong>(3,nua)</td><td><p>Atomic forces, to which the SCF contribution
 is added by this routine when <code>ifa=1</code>.
 The SCF contribution is minus the derivative
 of <code>(Enascf - Enaatm + DUscf + Exc)</code> with
 respect to atomic positions, in Ry/Bohr.
 Contributions local to this node.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-stressl%7E2"></span>real(kind=dp),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>stressl</strong>(3,3)</td><td><p>Stress tensor, to which the SCF contribution
 is added by this routine when <code>ifa=1</code>.
 The SCF contribution is minus the derivative of
 <code>(Enascf - Enaatm + DUscf + Exc) / volume</code>
 with respect to the strain tensor, in Ry.
 Contributions local to this node.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-use_rhog_in"></span>logical,</td>
  <td>intent(in),</td>
  <td>optional</td>
  
  <td></td><td>::</td>
  <td><strong>use_rhog_in</strong></td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-charge_density_only"></span>logical,</td>
  <td>intent(in),</td>
  <td>optional</td>
  
  <td></td><td>::</td>
  <td><strong>charge_density_only</strong></td><td></td>
  
</tr>

</tbody>
</table>

    
    
    
    <br>
    
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Calls</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~CallsGraph Pages: 1 -->
<svg id="procdhscfCallsGraph" width="641pt" height="1969pt"
 viewBox="0.00 0.00 641.00 1968.91" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~CallsGraph" class="graph" transform="scale(0.88292 0.88292) rotate(0) translate(4 2226)">
<title>proc~~dhscf~~CallsGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-2226 722,-2226 722,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~CallsGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="54,-780 0,-780 0,-756 54,-756 54,-780"/>
<text text-anchor="middle" x="27" y="-765.6" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- volcel -->
<g id="proc~~dhscf~~CallsGraph_node2" class="node"><title>volcel</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-2222 129.5,-2222 129.5,-2198 183.5,-2198 183.5,-2222"/>
<text text-anchor="middle" x="156.5" y="-2207.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">volcel</text>
</g>
<!-- proc~dhscf&#45;&gt;volcel -->
<g id="proc~~dhscf~~CallsGraph_edge1" class="edge"><title>proc~dhscf&#45;&gt;volcel</title>
<path fill="none" stroke="#000000" d="M28.1543,-780.111C29.9115,-914.508 46.8953,-2123.41 90,-2184 96.9665,-2193.79 108.23,-2199.9 119.468,-2203.7"/>
<polygon fill="#000000" stroke="#000000" points="118.651,-2207.11 129.228,-2206.49 120.573,-2200.38 118.651,-2207.11"/>
</g>
<!-- proc~forhar -->
<g id="proc~~dhscf~~CallsGraph_node3" class="node"><title>proc~forhar</title>
<g id="a_proc~~dhscf~~CallsGraph_node3"><a xlink:href=".././proc/forhar.html" xlink:title="forhar">
<polygon fill="#d9534f" stroke="#d9534f" points="183.5,-1054 129.5,-1054 129.5,-1030 183.5,-1030 183.5,-1054"/>
<text text-anchor="middle" x="156.5" y="-1039.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">forhar</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~forhar -->
<g id="proc~~dhscf~~CallsGraph_edge2" class="edge"><title>proc~dhscf&#45;&gt;proc~forhar</title>
<path fill="none" stroke="#000000" d="M27.408,-780.065C26.1507,-819.249 27.4501,-944.532 90,-1016 97.6498,-1024.74 108.634,-1030.57 119.427,-1034.45"/>
<polygon fill="#000000" stroke="#000000" points="118.596,-1037.86 129.185,-1037.5 120.68,-1031.18 118.596,-1037.86"/>
</g>
<!-- re_alloc -->
<g id="proc~~dhscf~~CallsGraph_node4" class="node"><title>re_alloc</title>
<polygon fill="#777777" stroke="#777777" points="710.5,-1110 656.5,-1110 656.5,-1086 710.5,-1086 710.5,-1110"/>
<text text-anchor="middle" x="683.5" y="-1095.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">re_alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge3" class="edge"><title>proc~dhscf&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M32.9774,-780.045C41.5541,-799.159 61.0332,-836.1 90,-854 191.502,-916.723 242.604,-856.951 355,-897 480.345,-941.663 609.18,-1038.75 659.974,-1079.45"/>
<polygon fill="#000000" stroke="#000000" points="658.013,-1082.37 667.991,-1085.93 662.412,-1076.92 658.013,-1082.37"/>
</g>
<!-- ts_voltage -->
<g id="proc~~dhscf~~CallsGraph_node5" class="node"><title>ts_voltage</title>
<polygon fill="#777777" stroke="#777777" points="187,-822 126,-822 126,-798 187,-798 187,-822"/>
<text text-anchor="middle" x="156.5" y="-807.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ts_voltage</text>
</g>
<!-- proc~dhscf&#45;&gt;ts_voltage -->
<g id="proc~~dhscf~~CallsGraph_edge4" class="edge"><title>proc~dhscf&#45;&gt;ts_voltage</title>
<path fill="none" stroke="#000000" d="M54.2142,-776.985C65.249,-780.739 78.2353,-785.122 90,-789 98.4874,-791.798 107.61,-794.754 116.271,-797.538"/>
<polygon fill="#000000" stroke="#000000" points="115.204,-800.871 125.795,-800.589 117.34,-794.205 115.204,-800.871"/>
</g>
<!-- mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_node6" class="node"><title>mpi_barrier</title>
<polygon fill="#777777" stroke="#777777" points="603.5,-1792 536.5,-1792 536.5,-1768 603.5,-1768 603.5,-1792"/>
<text text-anchor="middle" x="570" y="-1777.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_barrier</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_edge5" class="edge"><title>proc~dhscf&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M28.2248,-780.09C30.3482,-890.938 47.7393,-1728.95 90,-1831 145.448,-1964.9 229.902,-2094.16 355,-2021 383.171,-2004.52 370.315,-1982.24 391,-1957 428.153,-1911.66 455.215,-1917.43 491,-1871 513.327,-1842.03 500.272,-1821.97 527,-1797 527.345,-1796.68 527.697,-1796.36 528.055,-1796.05"/>
<polygon fill="#000000" stroke="#000000" points="530.102,-1798.89 536.341,-1790.33 526.124,-1793.13 530.102,-1798.89"/>
</g>
<!-- ts_hartree_fix -->
<g id="proc~~dhscf~~CallsGraph_node7" class="node"><title>ts_hartree_fix</title>
<polygon fill="#777777" stroke="#777777" points="195.5,-780 117.5,-780 117.5,-756 195.5,-756 195.5,-780"/>
<text text-anchor="middle" x="156.5" y="-765.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ts_hartree_fix</text>
</g>
<!-- proc~dhscf&#45;&gt;ts_hartree_fix -->
<g id="proc~~dhscf~~CallsGraph_edge6" class="edge"><title>proc~dhscf&#45;&gt;ts_hartree_fix</title>
<path fill="none" stroke="#000000" d="M54.1092,-768C69.4059,-768 89.2073,-768 107.246,-768"/>
<polygon fill="#000000" stroke="#000000" points="107.331,-771.5 117.331,-768 107.331,-764.5 107.331,-771.5"/>
</g>
<!-- elecs -->
<g id="proc~~dhscf~~CallsGraph_node8" class="node"><title>elecs</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-738 129.5,-738 129.5,-714 183.5,-714 183.5,-738"/>
<text text-anchor="middle" x="156.5" y="-723.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">elecs</text>
</g>
<!-- proc~dhscf&#45;&gt;elecs -->
<g id="proc~~dhscf~~CallsGraph_edge7" class="edge"><title>proc~dhscf&#45;&gt;elecs</title>
<path fill="none" stroke="#000000" d="M54.2142,-759.015C65.249,-755.261 78.2353,-750.878 90,-747 99.5959,-743.837 110.004,-740.471 119.638,-737.381"/>
<polygon fill="#000000" stroke="#000000" points="120.873,-740.661 129.332,-734.282 118.742,-733.993 120.873,-740.661"/>
</g>
<!-- ddot -->
<g id="proc~~dhscf~~CallsGraph_node9" class="node"><title>ddot</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-696 129.5,-696 129.5,-672 183.5,-672 183.5,-696"/>
<text text-anchor="middle" x="156.5" y="-681.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ddot</text>
</g>
<!-- proc~dhscf&#45;&gt;ddot -->
<g id="proc~~dhscf~~CallsGraph_edge8" class="edge"><title>proc~dhscf&#45;&gt;ddot</title>
<path fill="none" stroke="#000000" d="M37.1592,-755.576C48.2054,-741.424 68.0459,-718.515 90,-705 98.9997,-699.46 109.605,-695.24 119.63,-692.09"/>
<polygon fill="#000000" stroke="#000000" points="120.737,-695.414 129.381,-689.288 118.803,-688.686 120.737,-695.414"/>
</g>
<!-- jms_setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_node10" class="node"><title>jms_setmeshdistr</title>
<polygon fill="#777777" stroke="#777777" points="355,-1132 259,-1132 259,-1108 355,-1108 355,-1132"/>
<text text-anchor="middle" x="307" y="-1117.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">jms_setmeshdistr</text>
</g>
<!-- proc~dhscf&#45;&gt;jms_setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge9" class="edge"><title>proc~dhscf&#45;&gt;jms_setmeshdistr</title>
<path fill="none" stroke="#000000" d="M28.8727,-780C32.7451,-829.971 49.9811,-1020.89 90,-1063 130.783,-1105.91 199.725,-1117.92 248.747,-1120.61"/>
<polygon fill="#000000" stroke="#000000" points="248.745,-1124.12 258.888,-1121.06 249.05,-1117.12 248.745,-1124.12"/>
</g>
<!-- mpitrace_restart -->
<g id="proc~~dhscf~~CallsGraph_node11" class="node"><title>mpitrace_restart</title>
<polygon fill="#777777" stroke="#777777" points="202,-654 111,-654 111,-630 202,-630 202,-654"/>
<text text-anchor="middle" x="156.5" y="-639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpitrace_restart</text>
</g>
<!-- proc~dhscf&#45;&gt;mpitrace_restart -->
<g id="proc~~dhscf~~CallsGraph_edge10" class="edge"><title>proc~dhscf&#45;&gt;mpitrace_restart</title>
<path fill="none" stroke="#000000" d="M31.9705,-755.666C39.6409,-733.78 58.5685,-688.098 90,-663 93.5606,-660.157 97.5149,-657.695 101.666,-655.563"/>
<polygon fill="#000000" stroke="#000000" points="103.285,-658.674 110.994,-651.405 100.435,-652.28 103.285,-658.674"/>
</g>
<!-- bsc_cellxc -->
<g id="proc~~dhscf~~CallsGraph_node12" class="node"><title>bsc_cellxc</title>
<polygon fill="#777777" stroke="#777777" points="337.5,-1014 276.5,-1014 276.5,-990 337.5,-990 337.5,-1014"/>
<text text-anchor="middle" x="307" y="-999.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">bsc_cellxc</text>
</g>
<!-- proc~dhscf&#45;&gt;bsc_cellxc -->
<g id="proc~~dhscf~~CallsGraph_edge11" class="edge"><title>proc~dhscf&#45;&gt;bsc_cellxc</title>
<path fill="none" stroke="#000000" d="M27.8953,-780.276C28.3165,-814.756 34.5534,-913.145 90,-962 138.816,-1005.01 218.492,-1008.46 266.221,-1005.98"/>
<polygon fill="#000000" stroke="#000000" points="266.716,-1009.45 276.474,-1005.32 266.272,-1002.47 266.716,-1009.45"/>
</g>
<!-- write_grid_netcdf -->
<g id="proc~~dhscf~~CallsGraph_node13" class="node"><title>write_grid_netcdf</title>
<polygon fill="#777777" stroke="#777777" points="203.5,-612 109.5,-612 109.5,-588 203.5,-588 203.5,-612"/>
<text text-anchor="middle" x="156.5" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_grid_netcdf</text>
</g>
<!-- proc~dhscf&#45;&gt;write_grid_netcdf -->
<g id="proc~~dhscf~~CallsGraph_edge12" class="edge"><title>proc~dhscf&#45;&gt;write_grid_netcdf</title>
<path fill="none" stroke="#000000" d="M29.6677,-755.764C34.1288,-727.768 48.9235,-658.579 90,-621 93.1223,-618.144 96.6354,-615.675 100.371,-613.543"/>
<polygon fill="#000000" stroke="#000000" points="101.947,-616.669 109.413,-609.152 98.8886,-610.372 101.947,-616.669"/>
</g>
<!-- proc~bye -->
<g id="proc~~dhscf~~CallsGraph_node14" class="node"><title>proc~bye</title>
<g id="a_proc~~dhscf~~CallsGraph_node14"><a xlink:href=".././proc/bye.html" xlink:title="bye">
<polygon fill="#d9534f" stroke="#d9534f" points="597,-851 543,-851 543,-827 597,-827 597,-851"/>
<text text-anchor="middle" x="570" y="-836.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">bye</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~bye -->
<g id="proc~~dhscf~~CallsGraph_edge13" class="edge"><title>proc~dhscf&#45;&gt;proc~bye</title>
<path fill="none" stroke="#000000" d="M35.4548,-780.012C45.636,-795.155 65.4591,-820.478 90,-831 169.378,-865.034 435.214,-849.112 532.734,-841.89"/>
<polygon fill="#000000" stroke="#000000" points="532.998,-845.38 542.707,-841.138 532.472,-838.4 532.998,-845.38"/>
</g>
<!-- proc~setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_node15" class="node"><title>proc~setmeshdistr</title>
<g id="a_proc~~dhscf~~CallsGraph_node15"><a xlink:href=".././proc/setmeshdistr.html" xlink:title="setMeshDistr">
<polygon fill="#d9534f" stroke="#d9534f" points="344.5,-972 269.5,-972 269.5,-948 344.5,-948 344.5,-972"/>
<text text-anchor="middle" x="307" y="-957.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">setMeshDistr</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge14" class="edge"><title>proc~dhscf&#45;&gt;proc~setmeshdistr</title>
<path fill="none" stroke="#000000" d="M28.6477,-780.153C30.9876,-810.811 41.6742,-891.584 90,-930 137.905,-968.081 211.428,-970.033 259.12,-966.298"/>
<polygon fill="#000000" stroke="#000000" points="259.534,-969.775 269.181,-965.396 258.909,-962.803 259.534,-969.775"/>
</g>
<!-- rhoofdsp -->
<g id="proc~~dhscf~~CallsGraph_node16" class="node"><title>rhoofdsp</title>
<polygon fill="#777777" stroke="#777777" points="184,-570 129,-570 129,-546 184,-546 184,-570"/>
<text text-anchor="middle" x="156.5" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">rhoofdsp</text>
</g>
<!-- proc~dhscf&#45;&gt;rhoofdsp -->
<g id="proc~~dhscf~~CallsGraph_edge15" class="edge"><title>proc~dhscf&#45;&gt;rhoofdsp</title>
<path fill="none" stroke="#000000" d="M28.3469,-755.897C29.96,-722.752 39.0391,-629.619 90,-579 97.833,-571.22 108.551,-566.32 119.049,-563.235"/>
<polygon fill="#000000" stroke="#000000" points="120.072,-566.588 128.945,-560.799 118.398,-559.791 120.072,-566.588"/>
</g>
<!-- proc~die -->
<g id="proc~~dhscf~~CallsGraph_node17" class="node"><title>proc~die</title>
<g id="a_proc~~dhscf~~CallsGraph_node17"><a xlink:href=".././proc/die.html" xlink:title="die">
<polygon fill="#d9534f" stroke="#d9534f" points="597,-1170 543,-1170 543,-1146 597,-1146 597,-1170"/>
<text text-anchor="middle" x="570" y="-1155.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">die</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge16" class="edge"><title>proc~dhscf&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M28.4987,-780.199C30.9826,-834.813 43.8054,-1056.25 90,-1104 152.367,-1168.46 401.527,-1143.68 491,-1150 504.608,-1150.96 519.514,-1152.4 532.617,-1153.79"/>
<polygon fill="#000000" stroke="#000000" points="532.36,-1157.28 542.68,-1154.88 533.117,-1150.32 532.36,-1157.28"/>
</g>
<!-- get_field_from_dipole -->
<g id="proc~~dhscf~~CallsGraph_node18" class="node"><title>get_field_from_dipole</title>
<polygon fill="#777777" stroke="#777777" points="214,-528 99,-528 99,-504 214,-504 214,-528"/>
<text text-anchor="middle" x="156.5" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">get_field_from_dipole</text>
</g>
<!-- proc~dhscf&#45;&gt;get_field_from_dipole -->
<g id="proc~~dhscf~~CallsGraph_edge17" class="edge"><title>proc~dhscf&#45;&gt;get_field_from_dipole</title>
<path fill="none" stroke="#000000" d="M27.4889,-755.79C26.5915,-717.873 29.1231,-600.874 90,-537 91.0556,-535.892 92.1696,-534.843 93.3335,-533.849"/>
<polygon fill="#000000" stroke="#000000" points="95.4442,-536.644 101.65,-528.057 91.4435,-530.9 95.4442,-536.644"/>
</g>
<!-- vmatsp -->
<g id="proc~~dhscf~~CallsGraph_node19" class="node"><title>vmatsp</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-486 129.5,-486 129.5,-462 183.5,-462 183.5,-486"/>
<text text-anchor="middle" x="156.5" y="-471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vmatsp</text>
</g>
<!-- proc~dhscf&#45;&gt;vmatsp -->
<g id="proc~~dhscf~~CallsGraph_edge18" class="edge"><title>proc~dhscf&#45;&gt;vmatsp</title>
<path fill="none" stroke="#000000" d="M29.1573,-755.985C33.9611,-708.49 53.7923,-534.501 90,-495 97.6606,-486.643 108.648,-481.596 119.44,-478.553"/>
<polygon fill="#000000" stroke="#000000" points="120.248,-481.959 129.196,-476.286 118.663,-475.141 120.248,-481.959"/>
</g>
<!-- add_potential_from_field -->
<g id="proc~~dhscf~~CallsGraph_node20" class="node"><title>add_potential_from_field</title>
<polygon fill="#777777" stroke="#777777" points="221.5,-444 91.5,-444 91.5,-420 221.5,-420 221.5,-444"/>
<text text-anchor="middle" x="156.5" y="-429.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">add_potential_from_field</text>
</g>
<!-- proc~dhscf&#45;&gt;add_potential_from_field -->
<g id="proc~~dhscf~~CallsGraph_edge19" class="edge"><title>proc~dhscf&#45;&gt;add_potential_from_field</title>
<path fill="none" stroke="#000000" d="M28.7651,-755.96C32.3001,-703.99 48.6751,-499.416 90,-453 90.8933,-451.997 91.8346,-451.041 92.818,-450.13"/>
<polygon fill="#000000" stroke="#000000" points="95.1338,-452.771 101.081,-444.003 90.9642,-447.148 95.1338,-452.771"/>
</g>
<!-- hartree_add -->
<g id="proc~~dhscf~~CallsGraph_node21" class="node"><title>hartree_add</title>
<polygon fill="#777777" stroke="#777777" points="192,-402 121,-402 121,-378 192,-378 192,-402"/>
<text text-anchor="middle" x="156.5" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">hartree_add</text>
</g>
<!-- proc~dhscf&#45;&gt;hartree_add -->
<g id="proc~~dhscf~~CallsGraph_edge20" class="edge"><title>proc~dhscf&#45;&gt;hartree_add</title>
<path fill="none" stroke="#000000" d="M28.4632,-755.911C30.8533,-699.702 43.5352,-464.38 90,-411 95.6353,-404.526 103.269,-400.032 111.336,-396.916"/>
<polygon fill="#000000" stroke="#000000" points="112.45,-400.235 120.91,-393.856 110.319,-393.567 112.45,-400.235"/>
</g>
<!-- proc~reord -->
<g id="proc~~dhscf~~CallsGraph_node22" class="node"><title>proc~reord</title>
<g id="a_proc~~dhscf~~CallsGraph_node22"><a xlink:href=".././proc/reord.html" xlink:title="reord">
<polygon fill="#d9534f" stroke="#d9534f" points="597,-1448 543,-1448 543,-1424 597,-1424 597,-1448"/>
<text text-anchor="middle" x="570" y="-1433.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">reord</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~reord -->
<g id="proc~~dhscf~~CallsGraph_edge21" class="edge"><title>proc~dhscf&#45;&gt;proc~reord</title>
<path fill="none" stroke="#000000" d="M28.0497,-780.281C28.5472,-845.99 33.877,-1155.77 90,-1229 167.675,-1330.35 237.849,-1289.2 355,-1340 418.079,-1367.35 491.043,-1400.39 533.413,-1419.71"/>
<polygon fill="#000000" stroke="#000000" points="532.187,-1423 542.738,-1423.96 535.094,-1416.63 532.187,-1423"/>
</g>
<!-- compute_partial_charges -->
<g id="proc~~dhscf~~CallsGraph_node23" class="node"><title>compute_partial_charges</title>
<polygon fill="#777777" stroke="#777777" points="223,-360 90,-360 90,-336 223,-336 223,-360"/>
<text text-anchor="middle" x="156.5" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">compute_partial_charges</text>
</g>
<!-- proc~dhscf&#45;&gt;compute_partial_charges -->
<g id="proc~~dhscf~~CallsGraph_edge22" class="edge"><title>proc~dhscf&#45;&gt;compute_partial_charges</title>
<path fill="none" stroke="#000000" d="M28.225,-755.73C29.576,-695.249 38.4104,-429.344 90,-369 90.8512,-368.004 91.7496,-367.056 92.6898,-366.151"/>
<polygon fill="#000000" stroke="#000000" points="94.8249,-368.925 100.621,-360.056 90.5592,-363.375 94.8249,-368.925"/>
</g>
<!-- write_tdrho -->
<g id="proc~~dhscf~~CallsGraph_node24" class="node"><title>write_tdrho</title>
<polygon fill="#777777" stroke="#777777" points="189.5,-318 123.5,-318 123.5,-294 189.5,-294 189.5,-318"/>
<text text-anchor="middle" x="156.5" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_tdrho</text>
</g>
<!-- proc~dhscf&#45;&gt;write_tdrho -->
<g id="proc~~dhscf~~CallsGraph_edge23" class="edge"><title>proc~dhscf&#45;&gt;write_tdrho</title>
<path fill="none" stroke="#000000" d="M28.0248,-755.746C28.3984,-691.552 33.2117,-394.407 90,-327 96.1023,-319.757 104.71,-314.986 113.686,-311.851"/>
<polygon fill="#000000" stroke="#000000" points="114.817,-315.167 123.469,-309.051 112.891,-308.438 114.817,-315.167"/>
</g>
<!-- dfscf -->
<g id="proc~~dhscf~~CallsGraph_node25" class="node"><title>dfscf</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-276 129.5,-276 129.5,-252 183.5,-252 183.5,-276"/>
<text text-anchor="middle" x="156.5" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dfscf</text>
</g>
<!-- proc~dhscf&#45;&gt;dfscf -->
<g id="proc~~dhscf~~CallsGraph_edge24" class="edge"><title>proc~dhscf&#45;&gt;dfscf</title>
<path fill="none" stroke="#000000" d="M27.8606,-755.942C27.3236,-688.617 27.9417,-359.566 90,-285 97.3693,-276.145 108.486,-270.982 119.479,-267.986"/>
<polygon fill="#000000" stroke="#000000" points="120.413,-271.364 129.429,-265.799 118.911,-264.527 120.413,-271.364"/>
</g>
<!-- partialcoreonmesh -->
<g id="proc~~dhscf~~CallsGraph_node26" class="node"><title>partialcoreonmesh</title>
<polygon fill="#777777" stroke="#777777" points="207,-234 106,-234 106,-210 207,-210 207,-234"/>
<text text-anchor="middle" x="156.5" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">partialcoreonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;partialcoreonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge25" class="edge"><title>proc~dhscf&#45;&gt;partialcoreonmesh</title>
<path fill="none" stroke="#000000" d="M27.7211,-755.841C26.3385,-684.884 22.7479,-324.643 90,-243 92.1259,-240.419 94.5703,-238.152 97.2382,-236.16"/>
<polygon fill="#000000" stroke="#000000" points="99.0699,-239.142 105.817,-230.974 95.4484,-233.152 99.0699,-239.142"/>
</g>
<!-- mymeshbox -->
<g id="proc~~dhscf~~CallsGraph_node27" class="node"><title>mymeshbox</title>
<polygon fill="#777777" stroke="#777777" points="342,-930 272,-930 272,-906 342,-906 342,-930"/>
<text text-anchor="middle" x="307" y="-915.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mymeshbox</text>
</g>
<!-- proc~dhscf&#45;&gt;mymeshbox -->
<g id="proc~~dhscf~~CallsGraph_edge26" class="edge"><title>proc~dhscf&#45;&gt;mymeshbox</title>
<path fill="none" stroke="#000000" d="M29.552,-780.241C33.719,-807.443 47.8531,-872.812 90,-902 140.582,-937.029 214.746,-933.816 261.682,-926.937"/>
<polygon fill="#000000" stroke="#000000" points="262.513,-930.349 271.842,-925.328 261.418,-923.435 262.513,-930.349"/>
</g>
<!-- neutralatomonmesh -->
<g id="proc~~dhscf~~CallsGraph_node28" class="node"><title>neutralatomonmesh</title>
<polygon fill="#777777" stroke="#777777" points="210.5,-192 102.5,-192 102.5,-168 210.5,-168 210.5,-192"/>
<text text-anchor="middle" x="156.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">neutralatomonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;neutralatomonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge27" class="edge"><title>proc~dhscf&#45;&gt;neutralatomonmesh</title>
<path fill="none" stroke="#000000" d="M28.5395,-755.924C32.1309,-677.794 53.5577,-245.632 90,-201 91.2745,-199.439 92.6656,-197.993 94.1524,-196.653"/>
<polygon fill="#000000" stroke="#000000" points="96.2146,-199.481 102.287,-190.798 92.1257,-193.799 96.2146,-199.481"/>
</g>
<!-- interface~distmeshdata -->
<g id="proc~~dhscf~~CallsGraph_node29" class="node"><title>interface~distmeshdata</title>
<g id="a_proc~~dhscf~~CallsGraph_node29"><a xlink:href=".././interface/distmeshdata.html" xlink:title="distMeshData">
<polygon fill="#a7506f" stroke="#a7506f" points="346,-1288 268,-1288 268,-1264 346,-1264 346,-1288"/>
<text text-anchor="middle" x="307" y="-1273.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;interface~distmeshdata -->
<g id="proc~~dhscf~~CallsGraph_edge28" class="edge"><title>proc~dhscf&#45;&gt;interface~distmeshdata</title>
<path fill="none" stroke="#000000" d="M28.3576,-780.352C30.343,-841.258 41.7385,-1109.26 90,-1174 130.579,-1228.44 207.599,-1254.96 257.853,-1267.01"/>
<polygon fill="#000000" stroke="#000000" points="257.309,-1270.48 267.838,-1269.3 258.873,-1263.66 257.309,-1270.48"/>
</g>
<!-- timer -->
<g id="proc~~dhscf~~CallsGraph_node30" class="node"><title>timer</title>
<polygon fill="#777777" stroke="#777777" points="710.5,-1760 656.5,-1760 656.5,-1736 710.5,-1736 710.5,-1760"/>
<text text-anchor="middle" x="683.5" y="-1745.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">timer</text>
</g>
<!-- proc~dhscf&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge29" class="edge"><title>proc~dhscf&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M28.1165,-780.135C29.438,-912.286 42.45,-2080.38 90,-2134 154.576,-2206.81 208.676,-2170 306,-2170 306,-2170 306,-2170 442,-2170 538.009,-2170 560.842,-2118.61 613,-2038 669.481,-1950.71 680.117,-1821.92 682.077,-1770.45"/>
<polygon fill="#000000" stroke="#000000" points="685.585,-1770.25 682.39,-1760.15 678.588,-1770.04 685.585,-1770.25"/>
</g>
<!-- mpi_allreduce -->
<g id="proc~~dhscf~~CallsGraph_node31" class="node"><title>mpi_allreduce</title>
<polygon fill="#777777" stroke="#777777" points="196,-150 117,-150 117,-126 196,-126 196,-150"/>
<text text-anchor="middle" x="156.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_allreduce</text>
</g>
<!-- proc~dhscf&#45;&gt;mpi_allreduce -->
<g id="proc~~dhscf~~CallsGraph_edge30" class="edge"><title>proc~dhscf&#45;&gt;mpi_allreduce</title>
<path fill="none" stroke="#000000" d="M28.4475,-755.831C31.5539,-674.126 50.9425,-207.2 90,-159 94.4956,-153.452 100.465,-149.35 106.974,-146.321"/>
<polygon fill="#000000" stroke="#000000" points="108.673,-149.421 116.788,-142.608 106.196,-142.873 108.673,-149.421"/>
</g>
<!-- vacuum_level -->
<g id="proc~~dhscf~~CallsGraph_node32" class="node"><title>vacuum_level</title>
<polygon fill="#777777" stroke="#777777" points="195.5,-108 117.5,-108 117.5,-84 195.5,-84 195.5,-108"/>
<text text-anchor="middle" x="156.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vacuum_level</text>
</g>
<!-- proc~dhscf&#45;&gt;vacuum_level -->
<g id="proc~~dhscf~~CallsGraph_edge31" class="edge"><title>proc~dhscf&#45;&gt;vacuum_level</title>
<path fill="none" stroke="#000000" d="M28.3638,-755.823C31.0036,-670.881 48.3099,-168.793 90,-117 94.6846,-111.18 100.991,-106.951 107.848,-103.882"/>
<polygon fill="#000000" stroke="#000000" points="109.247,-107.097 117.437,-100.376 106.843,-100.522 109.247,-107.097"/>
</g>
<!-- de_alloc -->
<g id="proc~~dhscf~~CallsGraph_node33" class="node"><title>de_alloc</title>
<polygon fill="#777777" stroke="#777777" points="710.5,-1448 656.5,-1448 656.5,-1424 710.5,-1424 710.5,-1448"/>
<text text-anchor="middle" x="683.5" y="-1433.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">de_alloc</text>
</g>
<!-- proc~dhscf&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge32" class="edge"><title>proc~dhscf&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M27.7872,-780.313C26.8166,-850.585 25.3224,-1200.62 90,-1281 139.876,-1342.98 183.826,-1313.96 259,-1340 301.631,-1354.77 313.593,-1355.08 355,-1373 371.604,-1380.18 374.835,-1383.88 391,-1392 450.858,-1422.09 461.664,-1442.19 527,-1457 564.276,-1465.45 575.188,-1462.59 613,-1457 624.056,-1455.37 635.79,-1452.35 646.407,-1449.09"/>
<polygon fill="#000000" stroke="#000000" points="647.74,-1452.34 656.185,-1445.94 645.593,-1445.68 647.74,-1452.34"/>
</g>
<!-- localchargeonmesh -->
<g id="proc~~dhscf~~CallsGraph_node34" class="node"><title>localchargeonmesh</title>
<polygon fill="#777777" stroke="#777777" points="209.5,-66 103.5,-66 103.5,-42 209.5,-42 209.5,-66"/>
<text text-anchor="middle" x="156.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">localchargeonmesh</text>
</g>
<!-- proc~dhscf&#45;&gt;localchargeonmesh -->
<g id="proc~~dhscf~~CallsGraph_edge33" class="edge"><title>proc~dhscf&#45;&gt;localchargeonmesh</title>
<path fill="none" stroke="#000000" d="M28.2881,-755.894C30.4801,-668.058 45.66,-130.409 90,-75 91.4853,-73.144 93.1356,-71.4496 94.9163,-69.903"/>
<polygon fill="#000000" stroke="#000000" points="97.2007,-72.5795 103.452,-64.0251 93.2305,-66.8143 97.2007,-72.5795"/>
</g>
<!-- write_debug -->
<g id="proc~~dhscf~~CallsGraph_node35" class="node"><title>write_debug</title>
<polygon fill="#777777" stroke="#777777" points="605.5,-1750 534.5,-1750 534.5,-1726 605.5,-1726 605.5,-1750"/>
<text text-anchor="middle" x="570" y="-1735.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_debug</text>
</g>
<!-- proc~dhscf&#45;&gt;write_debug -->
<g id="proc~~dhscf~~CallsGraph_edge34" class="edge"><title>proc~dhscf&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M28.1863,-780.289C29.7159,-874.686 41.4036,-1485.75 90,-1663 134.199,-1824.21 116.702,-1911.29 259,-1999 295.321,-2021.39 318.888,-2021.72 355,-1999 386.295,-1979.31 371.096,-1955.16 391,-1924 442.158,-1843.91 452.661,-1818.2 527,-1759 528.53,-1757.78 530.143,-1756.61 531.809,-1755.48"/>
<polygon fill="#000000" stroke="#000000" points="533.717,-1758.41 540.45,-1750.23 530.085,-1752.43 533.717,-1758.41"/>
</g>
<!-- proc~rhoofd -->
<g id="proc~~dhscf~~CallsGraph_node36" class="node"><title>proc~rhoofd</title>
<g id="a_proc~~dhscf~~CallsGraph_node36"><a xlink:href=".././proc/rhoofd.html" xlink:title="rhoofd">
<polygon fill="#d9534f" stroke="#d9534f" points="183.5,-1654 129.5,-1654 129.5,-1630 183.5,-1630 183.5,-1654"/>
<text text-anchor="middle" x="156.5" y="-1639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">rhoofd</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~rhoofd -->
<g id="proc~~dhscf~~CallsGraph_edge35" class="edge"><title>proc~dhscf&#45;&gt;proc~rhoofd</title>
<path fill="none" stroke="#000000" d="M28.6691,-780.333C32.2027,-843.146 50.0618,-1133.66 90,-1368 106.166,-1462.85 136.166,-1573.73 149.192,-1619.99"/>
<polygon fill="#000000" stroke="#000000" points="145.886,-1621.16 151.982,-1629.83 152.621,-1619.25 145.886,-1621.16"/>
</g>
<!-- vmat -->
<g id="proc~~dhscf~~CallsGraph_node37" class="node"><title>vmat</title>
<polygon fill="#777777" stroke="#777777" points="183.5,-24 129.5,-24 129.5,-0 183.5,-0 183.5,-24"/>
<text text-anchor="middle" x="156.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">vmat</text>
</g>
<!-- proc~dhscf&#45;&gt;vmat -->
<g id="proc~~dhscf~~CallsGraph_edge36" class="edge"><title>proc~dhscf&#45;&gt;vmat</title>
<path fill="none" stroke="#000000" d="M28.2257,-755.75C30.0116,-664.445 43.043,-91.9852 90,-33 97.1749,-23.9872 108.243,-18.785 119.252,-15.8013"/>
<polygon fill="#000000" stroke="#000000" points="120.2,-19.1772 129.232,-13.6391 118.718,-12.3359 120.2,-19.1772"/>
</g>
<!-- proc~write_rho -->
<g id="proc~~dhscf~~CallsGraph_node38" class="node"><title>proc~write_rho</title>
<g id="a_proc~~dhscf~~CallsGraph_node38"><a xlink:href=".././proc/write_rho.html" xlink:title="write_rho">
<polygon fill="#d9534f" stroke="#d9534f" points="469.5,-1990 412.5,-1990 412.5,-1966 469.5,-1966 469.5,-1990"/>
<text text-anchor="middle" x="441" y="-1975.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_rho</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~write_rho -->
<g id="proc~~dhscf~~CallsGraph_edge37" class="edge"><title>proc~dhscf&#45;&gt;proc~write_rho</title>
<path fill="none" stroke="#000000" d="M28.0879,-780.35C29.0854,-912.377 39.2051,-2059.5 90,-2108 132.592,-2148.67 303.204,-2136.02 355,-2108 397.433,-2085.05 422.071,-2030.68 433.062,-2000.02"/>
<polygon fill="#000000" stroke="#000000" points="436.477,-2000.85 436.387,-1990.26 429.85,-1998.6 436.477,-2000.85"/>
</g>
<!-- proc~forhar&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge40" class="edge"><title>proc~forhar&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M183.684,-1039.98C254.261,-1035.27 453.857,-1026.71 613,-1066 626.534,-1069.34 640.651,-1075.32 652.599,-1081.21"/>
<polygon fill="#000000" stroke="#000000" points="651.169,-1084.41 661.664,-1085.87 654.367,-1078.19 651.169,-1084.41"/>
</g>
<!-- proc~forhar&#45;&gt;jms_setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge43" class="edge"><title>proc~forhar&#45;&gt;jms_setmeshdistr</title>
<path fill="none" stroke="#000000" d="M180.378,-1054.02C205.376,-1067.15 245.614,-1088.28 273.796,-1103.08"/>
<polygon fill="#000000" stroke="#000000" points="272.371,-1106.29 282.852,-1107.84 275.626,-1100.09 272.371,-1106.29"/>
</g>
<!-- proc~forhar&#45;&gt;bsc_cellxc -->
<g id="proc~~dhscf~~CallsGraph_edge44" class="edge"><title>proc~forhar&#45;&gt;bsc_cellxc</title>
<path fill="none" stroke="#000000" d="M183.707,-1034.94C206.641,-1028.76 240.292,-1019.7 266.492,-1012.64"/>
<polygon fill="#000000" stroke="#000000" points="267.744,-1015.93 276.489,-1009.95 265.923,-1009.17 267.744,-1015.93"/>
</g>
<!-- proc~forhar&#45;&gt;proc~setmeshdistr -->
<g id="proc~~dhscf~~CallsGraph_edge39" class="edge"><title>proc~forhar&#45;&gt;proc~setmeshdistr</title>
<path fill="none" stroke="#000000" d="M176.189,-1029.83C196.262,-1016.99 229.286,-996.495 259,-981 261.932,-979.471 264.998,-977.945 268.099,-976.454"/>
<polygon fill="#000000" stroke="#000000" points="269.82,-979.513 277.403,-972.114 266.861,-973.169 269.82,-979.513"/>
</g>
<!-- proc~forhar&#45;&gt;mymeshbox -->
<g id="proc~~dhscf~~CallsGraph_edge38" class="edge"><title>proc~forhar&#45;&gt;mymeshbox</title>
<path fill="none" stroke="#000000" d="M166.971,-1029.75C183.658,-1008.84 220.219,-965.901 259,-939 260.909,-937.676 262.916,-936.404 264.979,-935.187"/>
<polygon fill="#000000" stroke="#000000" points="267.106,-938.019 274.275,-930.217 263.806,-931.846 267.106,-938.019"/>
</g>
<!-- proc~forhar&#45;&gt;interface~distmeshdata -->
<g id="proc~~dhscf~~CallsGraph_edge41" class="edge"><title>proc~forhar&#45;&gt;interface~distmeshdata</title>
<path fill="none" stroke="#000000" d="M165.275,-1054.25C189.332,-1092.16 262.746,-1207.84 292.88,-1255.33"/>
<polygon fill="#000000" stroke="#000000" points="289.989,-1257.3 298.302,-1263.87 295.899,-1253.55 289.989,-1257.3"/>
</g>
<!-- proc~forhar&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge42" class="edge"><title>proc~forhar&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M183.587,-1041.55C226.025,-1042.32 309.805,-1050.38 355,-1099 404.627,-1152.38 342.331,-1204.74 391,-1259 408.409,-1278.41 592.228,-1319.24 613,-1335 616.806,-1337.89 649.467,-1386.42 668.631,-1415.14"/>
<polygon fill="#000000" stroke="#000000" points="665.868,-1417.3 674.325,-1423.68 671.693,-1413.42 665.868,-1417.3"/>
</g>
<!-- pxfflush -->
<g id="proc~~dhscf~~CallsGraph_node46" class="node"><title>pxfflush</title>
<polygon fill="#777777" stroke="#777777" points="710.5,-927 656.5,-927 656.5,-903 710.5,-903 710.5,-927"/>
<text text-anchor="middle" x="683.5" y="-912.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">pxfflush</text>
</g>
<!-- proc~bye&#45;&gt;pxfflush -->
<g id="proc~~dhscf~~CallsGraph_edge45" class="edge"><title>proc~bye&#45;&gt;pxfflush</title>
<path fill="none" stroke="#000000" d="M591.262,-851.151C598.219,-855.427 606.012,-860.331 613,-865 628.309,-875.228 645.075,-887.264 658.303,-896.964"/>
<polygon fill="#000000" stroke="#000000" points="656.308,-899.842 666.434,-902.958 660.462,-894.207 656.308,-899.842"/>
</g>
<!-- cmlfinishfile -->
<g id="proc~~dhscf~~CallsGraph_node52" class="node"><title>cmlfinishfile</title>
<polygon fill="#777777" stroke="#777777" points="717,-1035 650,-1035 650,-1011 717,-1011 717,-1035"/>
<text text-anchor="middle" x="683.5" y="-1020.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cmlfinishfile</text>
</g>
<!-- proc~bye&#45;&gt;cmlfinishfile -->
<g id="proc~~dhscf~~CallsGraph_edge47" class="edge"><title>proc~bye&#45;&gt;cmlfinishfile</title>
<path fill="none" stroke="#000000" d="M596.002,-851.076C602.128,-854.894 608.275,-859.563 613,-865 622.514,-875.947 657.384,-960.694 673.819,-1001.36"/>
<polygon fill="#000000" stroke="#000000" points="670.59,-1002.71 677.574,-1010.68 677.083,-1000.1 670.59,-1002.71"/>
</g>
<!-- mpi_finalize -->
<g id="proc~~dhscf~~CallsGraph_node56" class="node"><title>mpi_finalize</title>
<polygon fill="#777777" stroke="#777777" points="718,-851 649,-851 649,-827 718,-827 718,-851"/>
<text text-anchor="middle" x="683.5" y="-836.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_finalize</text>
</g>
<!-- proc~bye&#45;&gt;mpi_finalize -->
<g id="proc~~dhscf~~CallsGraph_edge46" class="edge"><title>proc~bye&#45;&gt;mpi_finalize</title>
<path fill="none" stroke="#000000" d="M597.142,-839C609.573,-839 624.77,-839 638.879,-839"/>
<polygon fill="#000000" stroke="#000000" points="638.905,-842.5 648.905,-839 638.905,-835.5 638.905,-842.5"/>
</g>
<!-- io_close -->
<g id="proc~~dhscf~~CallsGraph_node44" class="node"><title>io_close</title>
<polygon fill="#777777" stroke="#777777" points="710.5,-1376 656.5,-1376 656.5,-1352 710.5,-1352 710.5,-1376"/>
<text text-anchor="middle" x="683.5" y="-1361.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">io_close</text>
</g>
<!-- proc~die&#45;&gt;io_close -->
<g id="proc~~dhscf~~CallsGraph_edge48" class="edge"><title>proc~die&#45;&gt;io_close</title>
<path fill="none" stroke="#000000" d="M596.697,-1170.13C602.672,-1173.91 608.573,-1178.54 613,-1184 642.74,-1220.7 631.872,-1239.98 649,-1284 656.748,-1303.91 666.201,-1326.33 673.087,-1342.36"/>
<polygon fill="#000000" stroke="#000000" points="670.02,-1344.09 677.198,-1351.88 676.446,-1341.31 670.02,-1344.09"/>
</g>
<!-- io_assign -->
<g id="proc~~dhscf~~CallsGraph_node45" class="node"><title>io_assign</title>
<polygon fill="#777777" stroke="#777777" points="712.5,-1275 654.5,-1275 654.5,-1251 712.5,-1251 712.5,-1275"/>
<text text-anchor="middle" x="683.5" y="-1260.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">io_assign</text>
</g>
<!-- proc~die&#45;&gt;io_assign -->
<g id="proc~~dhscf~~CallsGraph_edge50" class="edge"><title>proc~die&#45;&gt;io_assign</title>
<path fill="none" stroke="#000000" d="M593.208,-1170.07C599.856,-1174.12 606.975,-1178.91 613,-1184 633.908,-1201.68 654.156,-1225.73 667.351,-1242.64"/>
<polygon fill="#000000" stroke="#000000" points="664.712,-1244.95 673.574,-1250.76 670.268,-1240.69 664.712,-1244.95"/>
</g>
<!-- proc~die&#45;&gt;pxfflush -->
<g id="proc~~dhscf~~CallsGraph_edge53" class="edge"><title>proc~die&#45;&gt;pxfflush</title>
<path fill="none" stroke="#000000" d="M576.529,-1145.95C594.289,-1107.25 650.041,-985.74 672.74,-936.271"/>
<polygon fill="#000000" stroke="#000000" points="675.948,-937.672 676.937,-927.123 669.586,-934.752 675.948,-937.672"/>
</g>
<!-- proc~die&#45;&gt;cmlfinishfile -->
<g id="proc~~dhscf~~CallsGraph_edge49" class="edge"><title>proc~die&#45;&gt;cmlfinishfile</title>
<path fill="none" stroke="#000000" d="M581.29,-1145.54C600.637,-1122.12 642.587,-1071.33 665.948,-1043.04"/>
<polygon fill="#000000" stroke="#000000" points="668.887,-1044.98 672.556,-1035.04 663.489,-1040.52 668.887,-1044.98"/>
</g>
<!-- mpi_abort -->
<g id="proc~~dhscf~~CallsGraph_node57" class="node"><title>mpi_abort</title>
<polygon fill="#777777" stroke="#777777" points="714,-1161 653,-1161 653,-1137 714,-1137 714,-1161"/>
<text text-anchor="middle" x="683.5" y="-1146.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_abort</text>
</g>
<!-- proc~die&#45;&gt;mpi_abort -->
<g id="proc~~dhscf~~CallsGraph_edge52" class="edge"><title>proc~die&#45;&gt;mpi_abort</title>
<path fill="none" stroke="#000000" d="M597.142,-1155.89C610.739,-1154.79 627.647,-1153.43 642.819,-1152.2"/>
<polygon fill="#000000" stroke="#000000" points="643.298,-1155.68 652.984,-1151.38 642.734,-1148.7 643.298,-1155.68"/>
</g>
<!-- pxfabort -->
<g id="proc~~dhscf~~CallsGraph_node58" class="node"><title>pxfabort</title>
<polygon fill="#777777" stroke="#777777" points="710.5,-1203 656.5,-1203 656.5,-1179 710.5,-1179 710.5,-1203"/>
<text text-anchor="middle" x="683.5" y="-1188.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">pxfabort</text>
</g>
<!-- proc~die&#45;&gt;pxfabort -->
<g id="proc~~dhscf~~CallsGraph_edge51" class="edge"><title>proc~die&#45;&gt;pxfabort</title>
<path fill="none" stroke="#000000" d="M597.142,-1165.74C611.854,-1170.09 630.441,-1175.59 646.512,-1180.35"/>
<polygon fill="#000000" stroke="#000000" points="645.553,-1183.72 656.136,-1183.2 647.54,-1177 645.553,-1183.72"/>
</g>
<!-- proc~reord&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge54" class="edge"><title>proc~reord&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M582.259,-1423.92C592.062,-1412.67 605.798,-1394.97 613,-1377 654.591,-1273.21 596.176,-1226.55 649,-1128 651.075,-1124.13 653.855,-1120.51 656.931,-1117.22"/>
<polygon fill="#000000" stroke="#000000" points="659.545,-1119.57 664.45,-1110.18 654.759,-1114.46 659.545,-1119.57"/>
</g>
<!-- proc~reord&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge56" class="edge"><title>proc~reord&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M597.111,-1447.82C603.079,-1451.59 608.872,-1456.31 613,-1462 673.367,-1545.24 681.773,-1674.34 682.607,-1725.76"/>
<polygon fill="#000000" stroke="#000000" points="679.107,-1725.81 682.686,-1735.78 686.107,-1725.75 679.107,-1725.81"/>
</g>
<!-- proc~reord&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge55" class="edge"><title>proc~reord&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M597.142,-1436C611.715,-1436 630.091,-1436 646.056,-1436"/>
<polygon fill="#000000" stroke="#000000" points="646.136,-1439.5 656.136,-1436 646.136,-1432.5 646.136,-1439.5"/>
</g>
<!-- proc~distmeshdata_rea -->
<g id="proc~~dhscf~~CallsGraph_node51" class="node"><title>proc~distmeshdata_rea</title>
<g id="a_proc~~dhscf~~CallsGraph_node51"><a xlink:href=".././proc/distmeshdata_rea.html" xlink:title="distMeshData_rea">
<polygon fill="#d9534f" stroke="#d9534f" points="491,-1330 391,-1330 391,-1306 491,-1306 491,-1330"/>
<text text-anchor="middle" x="441" y="-1315.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData_rea</text>
</a>
</g>
</g>
<!-- interface~distmeshdata&#45;&gt;proc~distmeshdata_rea -->
<g id="proc~~dhscf~~CallsGraph_edge57" class="edge"><title>interface~distmeshdata&#45;&gt;proc~distmeshdata_rea</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M345.826,-1288.04C360.324,-1292.65 377.056,-1297.97 392.358,-1302.84"/>
<polygon fill="#000000" stroke="#000000" points="391.578,-1306.27 402.169,-1305.96 393.701,-1299.6 391.578,-1306.27"/>
</g>
<!-- proc~distmeshdata_int -->
<g id="proc~~dhscf~~CallsGraph_node60" class="node"><title>proc~distmeshdata_int</title>
<g id="a_proc~~dhscf~~CallsGraph_node60"><a xlink:href=".././proc/distmeshdata_int.html" xlink:title="distMeshData_int">
<polygon fill="#d9534f" stroke="#d9534f" points="488.5,-1250 393.5,-1250 393.5,-1226 488.5,-1226 488.5,-1250"/>
<text text-anchor="middle" x="441" y="-1235.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData_int</text>
</a>
</g>
</g>
<!-- interface~distmeshdata&#45;&gt;proc~distmeshdata_int -->
<g id="proc~~dhscf~~CallsGraph_edge58" class="edge"><title>interface~distmeshdata&#45;&gt;proc~distmeshdata_int</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M346.18,-1265.01C359.292,-1261.23 374.197,-1256.94 388.205,-1252.91"/>
<polygon fill="#000000" stroke="#000000" points="389.567,-1256.16 398.209,-1250.03 387.631,-1249.43 389.567,-1256.16"/>
</g>
<!-- proc~rhoofd&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge63" class="edge"><title>proc~rhoofd&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M158.95,-1629.72C166.6,-1566.67 204.019,-1279.75 259,-1212 299.783,-1161.75 463.356,-1109.75 527,-1098 567.309,-1090.56 614.504,-1091.94 646.237,-1094.3"/>
<polygon fill="#000000" stroke="#000000" points="646.123,-1097.81 656.374,-1095.13 646.691,-1090.83 646.123,-1097.81"/>
</g>
<!-- proc~rhoofd&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge74" class="edge"><title>proc~rhoofd&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M157.126,-1629.91C156.174,-1578.2 159.073,-1372.9 259,-1255 289.228,-1219.34 316.683,-1238.79 355,-1212 373.804,-1198.85 370.312,-1184.92 391,-1175 436.093,-1153.38 494.922,-1152.23 532.342,-1154.36"/>
<polygon fill="#000000" stroke="#000000" points="532.549,-1157.88 542.763,-1155.07 533.024,-1150.9 532.549,-1157.88"/>
</g>
<!-- proc~rhoofd&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge66" class="edge"><title>proc~rhoofd&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M159.01,-1654.13C166.431,-1711.57 201.027,-1955.21 259,-1999 384.545,-2093.83 487.781,-2094.26 613,-1999 649.95,-1970.89 672.341,-1826.37 679.754,-1770.29"/>
<polygon fill="#000000" stroke="#000000" points="683.27,-1770.38 681.073,-1760.02 676.327,-1769.49 683.27,-1770.38"/>
</g>
<!-- proc~rhoofd&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge71" class="edge"><title>proc~rhoofd&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M159.652,-1629.77C166.576,-1594.61 191.874,-1493.14 259,-1453 397.026,-1370.45 469.029,-1599.67 613,-1528 642.37,-1513.38 662.621,-1479.77 673.39,-1457.48"/>
<polygon fill="#000000" stroke="#000000" points="676.684,-1458.69 677.67,-1448.14 670.321,-1455.77 676.684,-1458.69"/>
</g>
<!-- endpht -->
<g id="proc~~dhscf~~CallsGraph_node39" class="node"><title>endpht</title>
<polygon fill="#777777" stroke="#777777" points="334,-1906 280,-1906 280,-1882 334,-1882 334,-1906"/>
<text text-anchor="middle" x="307" y="-1891.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">endpht</text>
</g>
<!-- proc~rhoofd&#45;&gt;endpht -->
<g id="proc~~dhscf~~CallsGraph_edge62" class="edge"><title>proc~rhoofd&#45;&gt;endpht</title>
<path fill="none" stroke="#000000" d="M159.612,-1654.02C166.764,-1691.4 193.383,-1806.98 259,-1873 262.441,-1876.46 266.554,-1879.4 270.895,-1881.89"/>
<polygon fill="#000000" stroke="#000000" points="269.466,-1885.09 279.983,-1886.37 272.561,-1878.81 269.466,-1885.09"/>
</g>
<!-- listp2 -->
<g id="proc~~dhscf~~CallsGraph_node40" class="node"><title>listp2</title>
<polygon fill="#777777" stroke="#777777" points="334,-1864 280,-1864 280,-1840 334,-1840 334,-1864"/>
<text text-anchor="middle" x="307" y="-1849.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">listp2</text>
</g>
<!-- proc~rhoofd&#45;&gt;listp2 -->
<g id="proc~~dhscf~~CallsGraph_edge64" class="edge"><title>proc~rhoofd&#45;&gt;listp2</title>
<path fill="none" stroke="#000000" d="M161.027,-1654.35C171.024,-1687.33 202.541,-1778.5 259,-1831 262.405,-1834.17 266.368,-1836.91 270.521,-1839.28"/>
<polygon fill="#000000" stroke="#000000" points="269.259,-1842.56 279.773,-1843.87 272.37,-1836.29 269.259,-1842.56"/>
</g>
<!-- needdscfl -->
<g id="proc~~dhscf~~CallsGraph_node41" class="node"><title>needdscfl</title>
<polygon fill="#777777" stroke="#777777" points="336,-1822 278,-1822 278,-1798 336,-1798 336,-1822"/>
<text text-anchor="middle" x="307" y="-1807.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">needdscfl</text>
</g>
<!-- proc~rhoofd&#45;&gt;needdscfl -->
<g id="proc~~dhscf~~CallsGraph_edge65" class="edge"><title>proc~rhoofd&#45;&gt;needdscfl</title>
<path fill="none" stroke="#000000" d="M163.098,-1654.33C176.178,-1681.93 211.294,-1749.36 259,-1789 261.921,-1791.43 265.168,-1793.63 268.552,-1795.61"/>
<polygon fill="#000000" stroke="#000000" points="267.209,-1798.86 277.698,-1800.35 270.43,-1792.64 267.209,-1798.86"/>
</g>
<!-- numdl -->
<g id="proc~~dhscf~~CallsGraph_node42" class="node"><title>numdl</title>
<polygon fill="#777777" stroke="#777777" points="334,-1780 280,-1780 280,-1756 334,-1756 334,-1780"/>
<text text-anchor="middle" x="307" y="-1765.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">numdl</text>
</g>
<!-- proc~rhoofd&#45;&gt;numdl -->
<g id="proc~~dhscf~~CallsGraph_edge72" class="edge"><title>proc~rhoofd&#45;&gt;numdl</title>
<path fill="none" stroke="#000000" d="M166.654,-1654.16C183.136,-1675.37 219.758,-1719.5 259,-1747 262.54,-1749.48 266.421,-1751.77 270.387,-1753.86"/>
<polygon fill="#000000" stroke="#000000" points="269.149,-1757.15 279.676,-1758.35 272.196,-1750.85 269.149,-1757.15"/>
</g>
<!-- phi -->
<g id="proc~~dhscf~~CallsGraph_node48" class="node"><title>phi</title>
<polygon fill="#777777" stroke="#777777" points="334,-1738 280,-1738 280,-1714 334,-1714 334,-1738"/>
<text text-anchor="middle" x="307" y="-1723.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">phi</text>
</g>
<!-- proc~rhoofd&#45;&gt;phi -->
<g id="proc~~dhscf~~CallsGraph_edge59" class="edge"><title>proc~rhoofd&#45;&gt;phi</title>
<path fill="none" stroke="#000000" d="M175.399,-1654.14C195.344,-1667.42 228.771,-1688.96 259,-1705 262.73,-1706.98 266.685,-1708.94 270.653,-1710.83"/>
<polygon fill="#000000" stroke="#000000" points="269.294,-1714.06 279.841,-1715.06 272.224,-1707.7 269.294,-1714.06"/>
</g>
<!-- indxuo -->
<g id="proc~~dhscf~~CallsGraph_node49" class="node"><title>indxuo</title>
<polygon fill="#777777" stroke="#777777" points="334,-1696 280,-1696 280,-1672 334,-1672 334,-1696"/>
<text text-anchor="middle" x="307" y="-1681.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">indxuo</text>
</g>
<!-- proc~rhoofd&#45;&gt;indxuo -->
<g id="proc~~dhscf~~CallsGraph_edge60" class="edge"><title>proc~rhoofd&#45;&gt;indxuo</title>
<path fill="none" stroke="#000000" d="M183.707,-1649.41C207.629,-1656.18 243.21,-1666.24 269.833,-1673.77"/>
<polygon fill="#000000" stroke="#000000" points="268.98,-1677.17 279.555,-1676.52 270.886,-1670.43 268.98,-1677.17"/>
</g>
<!-- listsc -->
<g id="proc~~dhscf~~CallsGraph_node50" class="node"><title>listsc</title>
<polygon fill="#777777" stroke="#777777" points="334,-1654 280,-1654 280,-1630 334,-1630 334,-1654"/>
<text text-anchor="middle" x="307" y="-1639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">listsc</text>
</g>
<!-- proc~rhoofd&#45;&gt;listsc -->
<g id="proc~~dhscf~~CallsGraph_edge61" class="edge"><title>proc~rhoofd&#45;&gt;listsc</title>
<path fill="none" stroke="#000000" d="M183.707,-1642C207.523,-1642 242.896,-1642 269.481,-1642"/>
<polygon fill="#000000" stroke="#000000" points="269.556,-1645.5 279.555,-1642 269.555,-1638.5 269.556,-1645.5"/>
</g>
<!-- listdlptr -->
<g id="proc~~dhscf~~CallsGraph_node53" class="node"><title>listdlptr</title>
<polygon fill="#777777" stroke="#777777" points="334,-1612 280,-1612 280,-1588 334,-1588 334,-1612"/>
<text text-anchor="middle" x="307" y="-1597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">listdlptr</text>
</g>
<!-- proc~rhoofd&#45;&gt;listdlptr -->
<g id="proc~~dhscf~~CallsGraph_edge67" class="edge"><title>proc~rhoofd&#45;&gt;listdlptr</title>
<path fill="none" stroke="#000000" d="M183.707,-1634.59C207.629,-1627.82 243.21,-1617.76 269.833,-1610.23"/>
<polygon fill="#000000" stroke="#000000" points="270.886,-1613.57 279.555,-1607.48 268.98,-1606.83 270.886,-1613.57"/>
</g>
<!-- lstpht -->
<g id="proc~~dhscf~~CallsGraph_node54" class="node"><title>lstpht</title>
<polygon fill="#777777" stroke="#777777" points="334,-1570 280,-1570 280,-1546 334,-1546 334,-1570"/>
<text text-anchor="middle" x="307" y="-1555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">lstpht</text>
</g>
<!-- proc~rhoofd&#45;&gt;lstpht -->
<g id="proc~~dhscf~~CallsGraph_edge69" class="edge"><title>proc~rhoofd&#45;&gt;lstpht</title>
<path fill="none" stroke="#000000" d="M175.399,-1629.86C195.344,-1616.58 228.771,-1595.04 259,-1579 262.73,-1577.02 266.685,-1575.06 270.653,-1573.17"/>
<polygon fill="#000000" stroke="#000000" points="272.224,-1576.3 279.841,-1568.94 269.294,-1569.94 272.224,-1576.3"/>
</g>
<!-- globaltolocalorb -->
<g id="proc~~dhscf~~CallsGraph_node55" class="node"><title>globaltolocalorb</title>
<polygon fill="#777777" stroke="#777777" points="351,-1528 263,-1528 263,-1504 351,-1504 351,-1528"/>
<text text-anchor="middle" x="307" y="-1513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">globaltolocalorb</text>
</g>
<!-- proc~rhoofd&#45;&gt;globaltolocalorb -->
<g id="proc~~dhscf~~CallsGraph_edge70" class="edge"><title>proc~rhoofd&#45;&gt;globaltolocalorb</title>
<path fill="none" stroke="#000000" d="M166.654,-1629.84C183.136,-1608.63 219.758,-1564.5 259,-1537 260.903,-1535.67 262.904,-1534.39 264.964,-1533.16"/>
<polygon fill="#000000" stroke="#000000" points="267.094,-1535.99 274.248,-1528.18 263.782,-1529.83 267.094,-1535.99"/>
</g>
<!-- matrixotom -->
<g id="proc~~dhscf~~CallsGraph_node59" class="node"><title>matrixotom</title>
<polygon fill="#777777" stroke="#777777" points="340,-1486 274,-1486 274,-1462 340,-1462 340,-1486"/>
<text text-anchor="middle" x="307" y="-1471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">matrixotom</text>
</g>
<!-- proc~rhoofd&#45;&gt;matrixotom -->
<g id="proc~~dhscf~~CallsGraph_edge68" class="edge"><title>proc~rhoofd&#45;&gt;matrixotom</title>
<path fill="none" stroke="#000000" d="M163.098,-1629.67C176.178,-1602.07 211.294,-1534.64 259,-1495 260.787,-1493.51 262.696,-1492.11 264.684,-1490.8"/>
<polygon fill="#000000" stroke="#000000" points="266.859,-1493.58 273.767,-1485.55 263.358,-1487.52 266.859,-1493.58"/>
</g>
<!-- proc~rcut -->
<g id="proc~~dhscf~~CallsGraph_node61" class="node"><title>proc~rcut</title>
<g id="a_proc~~dhscf~~CallsGraph_node61"><a xlink:href=".././proc/rcut.html" xlink:title="rcut">
<polygon fill="#d94e8f" stroke="#d94e8f" points="334,-1406 280,-1406 280,-1382 334,-1382 334,-1406"/>
<text text-anchor="middle" x="307" y="-1391.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">rcut</text>
</a>
</g>
</g>
<!-- proc~rhoofd&#45;&gt;proc~rcut -->
<g id="proc~~dhscf~~CallsGraph_edge73" class="edge"><title>proc~rhoofd&#45;&gt;proc~rcut</title>
<path fill="none" stroke="#000000" d="M160.173,-1629.91C168.684,-1593.88 198.234,-1485.6 259,-1420 262.386,-1416.34 266.407,-1413.08 270.649,-1410.21"/>
<polygon fill="#000000" stroke="#000000" points="272.778,-1413.01 279.537,-1404.85 269.165,-1407.02 272.778,-1413.01"/>
</g>
<!-- dscfl -->
<g id="proc~~dhscf~~CallsGraph_node62" class="node"><title>dscfl</title>
<polygon fill="#777777" stroke="#777777" points="334,-1990 280,-1990 280,-1966 334,-1966 334,-1990"/>
<text text-anchor="middle" x="307" y="-1975.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dscfl</text>
</g>
<!-- proc~rhoofd&#45;&gt;dscfl -->
<g id="proc~~dhscf~~CallsGraph_edge75" class="edge"><title>proc~rhoofd&#45;&gt;dscfl</title>
<path fill="none" stroke="#000000" d="M157.999,-1654.28C160.499,-1700.15 175.171,-1863.55 259,-1957 262.26,-1960.63 266.268,-1963.67 270.558,-1966.21"/>
<polygon fill="#000000" stroke="#000000" points="269.096,-1969.39 279.607,-1970.72 272.222,-1963.13 269.096,-1969.39"/>
</g>
<!-- listdl -->
<g id="proc~~dhscf~~CallsGraph_node63" class="node"><title>listdl</title>
<polygon fill="#777777" stroke="#777777" points="334,-1948 280,-1948 280,-1924 334,-1924 334,-1948"/>
<text text-anchor="middle" x="307" y="-1933.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">listdl</text>
</g>
<!-- proc~rhoofd&#45;&gt;listdl -->
<g id="proc~~dhscf~~CallsGraph_edge76" class="edge"><title>proc~rhoofd&#45;&gt;listdl</title>
<path fill="none" stroke="#000000" d="M158.688,-1654.08C163.393,-1695.75 184.289,-1835.33 259,-1915 262.339,-1918.56 266.394,-1921.56 270.706,-1924.07"/>
<polygon fill="#000000" stroke="#000000" points="269.259,-1927.26 279.772,-1928.57 272.371,-1920.99 269.259,-1927.26"/>
</g>
<!-- proc~write_rho&#45;&gt;mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_edge80" class="edge"><title>proc~write_rho&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M469.6,-1968.39C477.519,-1964.42 485.492,-1959.06 491,-1952 532.1,-1899.3 487.674,-1860.04 527,-1806 529.082,-1803.14 531.583,-1800.53 534.314,-1798.15"/>
<polygon fill="#000000" stroke="#000000" points="536.522,-1800.87 542.466,-1792.1 532.35,-1795.25 536.522,-1800.87"/>
</g>
<!-- proc~write_rho&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge81" class="edge"><title>proc~write_rho&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M468.343,-1965.94C475.951,-1961.96 484.066,-1957.2 491,-1952 509.356,-1938.23 508.479,-1928.54 527,-1915 561.495,-1889.78 587.734,-1906.46 613,-1872 637.831,-1838.13 671.083,-1542.71 680.139,-1458.38"/>
<polygon fill="#000000" stroke="#000000" points="683.629,-1458.66 681.21,-1448.35 676.669,-1457.92 683.629,-1458.66"/>
</g>
<!-- proc~write_rho&#45;&gt;write_debug -->
<g id="proc~~dhscf~~CallsGraph_edge82" class="edge"><title>proc~write_rho&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M453.897,-1965.84C465.112,-1953.69 481.566,-1934 491,-1914 521.176,-1850.04 483.211,-1814.54 527,-1759 527.681,-1758.14 528.408,-1757.3 529.172,-1756.5"/>
<polygon fill="#000000" stroke="#000000" points="531.414,-1759.19 536.909,-1750.13 526.965,-1753.79 531.414,-1759.19"/>
</g>
<!-- mpi_wait -->
<g id="proc~~dhscf~~CallsGraph_node43" class="node"><title>mpi_wait</title>
<polygon fill="#777777" stroke="#777777" points="597.5,-1948 542.5,-1948 542.5,-1924 597.5,-1924 597.5,-1948"/>
<text text-anchor="middle" x="570" y="-1933.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_wait</text>
</g>
<!-- proc~write_rho&#45;&gt;mpi_wait -->
<g id="proc~~dhscf~~CallsGraph_edge79" class="edge"><title>proc~write_rho&#45;&gt;mpi_wait</title>
<path fill="none" stroke="#000000" d="M469.557,-1968.89C488.03,-1962.78 512.554,-1954.67 532.626,-1948.03"/>
<polygon fill="#000000" stroke="#000000" points="533.972,-1951.27 542.367,-1944.81 531.774,-1944.62 533.972,-1951.27"/>
</g>
<!-- proc~write_rho&#45;&gt;io_close -->
<g id="proc~~dhscf~~CallsGraph_edge77" class="edge"><title>proc~write_rho&#45;&gt;io_close</title>
<path fill="none" stroke="#000000" d="M469.614,-1967.36C477.258,-1963.42 485.074,-1958.32 491,-1952 517.66,-1923.55 499.337,-1899.48 527,-1872 556.648,-1842.55 588.713,-1868 613,-1834 667.317,-1757.95 618.412,-1503.31 649,-1415 652.797,-1404.04 659.474,-1393.12 665.874,-1384.22"/>
<polygon fill="#000000" stroke="#000000" points="668.808,-1386.14 672.064,-1376.06 663.232,-1381.91 668.808,-1386.14"/>
</g>
<!-- proc~write_rho&#45;&gt;io_assign -->
<g id="proc~~dhscf~~CallsGraph_edge78" class="edge"><title>proc~write_rho&#45;&gt;io_assign</title>
<path fill="none" stroke="#000000" d="M469.624,-1968.08C477.45,-1964.12 485.364,-1958.84 491,-1952 525.882,-1909.7 489.615,-1874.11 527,-1834 554.914,-1804.05 588.504,-1833.8 613,-1801 674.085,-1719.2 624.98,-1442.23 649,-1343 653.998,-1322.35 663.663,-1300.16 671.332,-1284.4"/>
<polygon fill="#000000" stroke="#000000" points="674.665,-1285.57 676.015,-1275.06 668.406,-1282.43 674.665,-1285.57"/>
</g>
<!-- mpi_irecv -->
<g id="proc~~dhscf~~CallsGraph_node47" class="node"><title>mpi_irecv</title>
<polygon fill="#777777" stroke="#777777" points="599,-1990 541,-1990 541,-1966 599,-1966 599,-1990"/>
<text text-anchor="middle" x="570" y="-1975.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_irecv</text>
</g>
<!-- proc~write_rho&#45;&gt;mpi_irecv -->
<g id="proc~~dhscf~~CallsGraph_edge83" class="edge"><title>proc~write_rho&#45;&gt;mpi_irecv</title>
<path fill="none" stroke="#000000" d="M469.557,-1978C487.367,-1978 510.801,-1978 530.447,-1978"/>
<polygon fill="#000000" stroke="#000000" points="530.617,-1981.5 540.617,-1978 530.617,-1974.5 530.617,-1981.5"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge87" class="edge"><title>proc~distmeshdata_rea&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M491.036,-1313.4C529.371,-1307.23 581.311,-1292.79 613,-1259 654.307,-1214.96 617.217,-1179.34 649,-1128 651.423,-1124.09 654.508,-1120.38 657.82,-1117"/>
<polygon fill="#000000" stroke="#000000" points="660.273,-1119.5 665.267,-1110.16 655.536,-1114.35 660.273,-1119.5"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;mpi_barrier -->
<g id="proc~~dhscf~~CallsGraph_edge89" class="edge"><title>proc~distmeshdata_rea&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M442.901,-1330.13C447.828,-1393.7 473.293,-1688.17 527,-1759 527.665,-1759.88 528.377,-1760.72 529.128,-1761.53"/>
<polygon fill="#000000" stroke="#000000" points="526.878,-1764.21 536.786,-1767.96 531.379,-1758.85 526.878,-1764.21"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge92" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M452.262,-1305.9C462.265,-1294.05 477.848,-1275.42 491,-1259 513.178,-1231.31 538.128,-1198.75 553.706,-1178.24"/>
<polygon fill="#000000" stroke="#000000" points="556.52,-1180.32 559.773,-1170.24 550.942,-1176.09 556.52,-1180.32"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~reord -->
<g id="proc~~dhscf~~CallsGraph_edge86" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~reord</title>
<path fill="none" stroke="#000000" d="M471.355,-1330.01C478.338,-1333.79 485.384,-1338.45 491,-1344 514.762,-1367.49 504.031,-1385.73 527,-1410 529.773,-1412.93 532.944,-1415.66 536.274,-1418.17"/>
<polygon fill="#000000" stroke="#000000" points="534.503,-1421.19 544.742,-1423.92 538.436,-1415.4 534.503,-1421.19"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;timer -->
<g id="proc~~dhscf~~CallsGraph_edge88" class="edge"><title>proc~distmeshdata_rea&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M448.938,-1330.41C482.475,-1390.37 627.908,-1650.39 670.647,-1726.81"/>
<polygon fill="#000000" stroke="#000000" points="667.827,-1728.94 675.763,-1735.96 673.936,-1725.52 667.827,-1728.94"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge90" class="edge"><title>proc~distmeshdata_rea&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M467.653,-1330.05C475.399,-1334.09 483.763,-1338.89 491,-1344 508.729,-1356.52 508.522,-1365.61 527,-1377 547.521,-1389.65 607.421,-1410.89 646.603,-1424.14"/>
<polygon fill="#000000" stroke="#000000" points="645.731,-1427.54 656.325,-1427.41 647.961,-1420.91 645.731,-1427.54"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;write_debug -->
<g id="proc~~dhscf~~CallsGraph_edge91" class="edge"><title>proc~distmeshdata_rea&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M445.664,-1330.12C463.263,-1388.32 539.211,-1639.49 562.31,-1715.88"/>
<polygon fill="#000000" stroke="#000000" points="559.077,-1717.28 565.321,-1725.83 565.777,-1715.25 559.077,-1717.28"/>
</g>
<!-- mpitrace_event -->
<g id="proc~~dhscf~~CallsGraph_node64" class="node"><title>mpitrace_event</title>
<polygon fill="#777777" stroke="#777777" points="613,-1368 527,-1368 527,-1344 613,-1344 613,-1368"/>
<text text-anchor="middle" x="570" y="-1353.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpitrace_event</text>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;mpitrace_event -->
<g id="proc~~dhscf~~CallsGraph_edge84" class="edge"><title>proc~distmeshdata_rea&#45;&gt;mpitrace_event</title>
<path fill="none" stroke="#000000" d="M482.184,-1330.02C493.881,-1333.52 506.805,-1337.39 519.027,-1341.05"/>
<polygon fill="#000000" stroke="#000000" points="518.058,-1344.41 528.642,-1343.92 520.065,-1337.7 518.058,-1344.41"/>
</g>
<!-- proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_node65" class="node"><title>proc~boxintersection</title>
<g id="a_proc~~dhscf~~CallsGraph_node65"><a xlink:href=".././proc/boxintersection.html" xlink:title="boxIntersection">
<polygon fill="#d9534f" stroke="#d9534f" points="612.5,-1250 527.5,-1250 527.5,-1226 612.5,-1226 612.5,-1250"/>
<text text-anchor="middle" x="570" y="-1235.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">boxIntersection</text>
</a>
</g>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_edge85" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~boxintersection</title>
<path fill="none" stroke="#000000" d="M461.289,-1305.85C482.578,-1292.44 517.029,-1270.74 541.224,-1255.5"/>
<polygon fill="#000000" stroke="#000000" points="543.35,-1258.29 549.946,-1250 539.619,-1252.37 543.35,-1258.29"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;re_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge93" class="edge"><title>proc~distmeshdata_int&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M478.719,-1225.95C483.193,-1223.46 487.434,-1220.5 491,-1217 518.816,-1189.68 497.1,-1162.02 527,-1137 560.657,-1108.83 611.85,-1100.57 646.206,-1098.38"/>
<polygon fill="#000000" stroke="#000000" points="646.475,-1101.87 656.289,-1097.87 646.128,-1094.87 646.475,-1101.87"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge96" class="edge"><title>proc~distmeshdata_int&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M474.429,-1225.94C480.126,-1223.31 485.869,-1220.31 491,-1217 509.233,-1205.22 509.696,-1197.1 527,-1184 530.715,-1181.19 534.746,-1178.4 538.791,-1175.75"/>
<polygon fill="#000000" stroke="#000000" points="540.965,-1178.51 547.55,-1170.21 537.227,-1172.59 540.965,-1178.51"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;de_alloc -->
<g id="proc~~dhscf~~CallsGraph_edge95" class="edge"><title>proc~distmeshdata_int&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M484.588,-1225.94C528.717,-1214.62 593.868,-1201.53 613,-1217 672.384,-1265.01 619.535,-1314.55 649,-1385 653.476,-1395.7 660.252,-1406.58 666.541,-1415.52"/>
<polygon fill="#000000" stroke="#000000" points="663.832,-1417.75 672.565,-1423.75 669.479,-1413.61 663.832,-1417.75"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;proc~boxintersection -->
<g id="proc~~dhscf~~CallsGraph_edge94" class="edge"><title>proc~distmeshdata_int&#45;&gt;proc~boxintersection</title>
<path fill="none" stroke="#000000" d="M488.569,-1238C497.927,-1238 507.814,-1238 517.333,-1238"/>
<polygon fill="#000000" stroke="#000000" points="517.476,-1241.5 527.476,-1238 517.476,-1234.5 517.476,-1241.5"/>
</g>
<!-- proc~chk -->
<g id="proc~~dhscf~~CallsGraph_node66" class="node"><title>proc~chk</title>
<g id="a_proc~~dhscf~~CallsGraph_node66"><a xlink:href=".././proc/chk.html" xlink:title="chk">
<polygon fill="#d9534f" stroke="#d9534f" points="468,-1208 414,-1208 414,-1184 468,-1184 468,-1208"/>
<text text-anchor="middle" x="441" y="-1193.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">chk</text>
</a>
</g>
</g>
<!-- proc~rcut&#45;&gt;proc~chk -->
<g id="proc~~dhscf~~CallsGraph_edge97" class="edge"><title>proc~rcut&#45;&gt;proc~chk</title>
<path fill="none" stroke="#000000" d="M314.047,-1381.8C323.105,-1363.47 340.664,-1327.69 355,-1297 371.502,-1261.67 363.184,-1244.32 391,-1217 394.962,-1213.11 399.758,-1209.89 404.78,-1207.24"/>
<polygon fill="#000000" stroke="#000000" points="406.289,-1210.4 413.932,-1203.06 403.382,-1204.03 406.289,-1210.4"/>
</g>
<!-- proc~chk&#45;&gt;proc~die -->
<g id="proc~~dhscf~~CallsGraph_edge98" class="edge"><title>proc~chk&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M468.007,-1188.22C486.716,-1182.62 512.191,-1175 532.874,-1168.81"/>
<polygon fill="#000000" stroke="#000000" points="534.015,-1172.12 542.592,-1165.9 532.008,-1165.42 534.015,-1172.12"/>
</g>
</g>
</svg>
</div><script>var panprocdhscfCallsGraph = svgPanZoom('#procdhscfCallsGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
     
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Called by</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~dhscf~~CalledByGraph Pages: 1 -->
<svg id="procdhscfCalledByGraph" width="310pt" height="74pt"
 viewBox="0.00 0.00 310.00 74.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~dhscf~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 70)">
<title>proc~~dhscf~~CalledByGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-70 306,-70 306,4 -4,4"/>
<!-- proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_node1" class="node"><title>proc~dhscf</title>
<polygon fill="none" stroke="black" points="302,-45 248,-45 248,-21 302,-21 302,-45"/>
<text text-anchor="middle" x="275" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50">dhscf</text>
</g>
<!-- proc~siesta_analysis -->
<g id="proc~~dhscf~~CalledByGraph_node2" class="node"><title>proc~siesta_analysis</title>
<g id="a_proc~~dhscf~~CalledByGraph_node2"><a xlink:href=".././proc/siesta_analysis.html" xlink:title="siesta_analysis">
<polygon fill="#d9534f" stroke="#d9534f" points="204.5,-66 119.5,-66 119.5,-42 204.5,-42 204.5,-66"/>
<text text-anchor="middle" x="162" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_analysis</text>
</a>
</g>
</g>
<!-- proc~siesta_analysis&#45;&gt;proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_edge1" class="edge"><title>proc~siesta_analysis&#45;&gt;proc~dhscf</title>
<path fill="none" stroke="#000000" d="M204.648,-46.1206C215.65,-44.0392 227.428,-41.811 238.097,-39.7925"/>
<polygon fill="#000000" stroke="#000000" points="238.75,-43.2311 247.925,-37.9331 237.449,-36.3531 238.75,-43.2311"/>
</g>
<!-- proc~setup_hamiltonian -->
<g id="proc~~dhscf~~CalledByGraph_node3" class="node"><title>proc~setup_hamiltonian</title>
<g id="a_proc~~dhscf~~CalledByGraph_node3"><a xlink:href=".././proc/setup_hamiltonian.html" xlink:title="setup_hamiltonian">
<polygon fill="#d9534f" stroke="#d9534f" points="212,-24 112,-24 112,-0 212,-0 212,-24"/>
<text text-anchor="middle" x="162" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">setup_hamiltonian</text>
</a>
</g>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;proc~dhscf -->
<g id="proc~~dhscf~~CalledByGraph_edge2" class="edge"><title>proc~setup_hamiltonian&#45;&gt;proc~dhscf</title>
<path fill="none" stroke="#000000" d="M212.009,-21.272C220.666,-22.9099 229.537,-24.5881 237.763,-26.1444"/>
<polygon fill="#000000" stroke="#000000" points="237.297,-29.6183 247.774,-28.0383 238.599,-22.7403 237.297,-29.6183"/>
</g>
<!-- proc~siesta_forces -->
<g id="proc~~dhscf~~CalledByGraph_node4" class="node"><title>proc~siesta_forces</title>
<g id="a_proc~~dhscf~~CalledByGraph_node4"><a xlink:href=".././proc/siesta_forces.html" xlink:title="siesta_forces">
<polygon fill="#d9534f" stroke="#d9534f" points="76,-24 0,-24 0,-0 76,-0 76,-24"/>
<text text-anchor="middle" x="38" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_forces</text>
</a>
</g>
</g>
<!-- proc~siesta_forces&#45;&gt;proc~setup_hamiltonian -->
<g id="proc~~dhscf~~CalledByGraph_edge3" class="edge"><title>proc~siesta_forces&#45;&gt;proc~setup_hamiltonian</title>
<path fill="none" stroke="#000000" d="M76.2669,-12C84.3255,-12 93.0387,-12 101.706,-12"/>
<polygon fill="#000000" stroke="#000000" points="101.817,-15.5001 111.817,-12 101.817,-8.5001 101.817,-15.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/dhscf.html#src">dhscf</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>      <span class="k">subroutine </span><span class="n">dhscf</span><span class="p">(</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> 
     <span class="p">&amp;</span>                  <span class="n">nuotot</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">ntm</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">iHmat</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">filesOut</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span> <span class="n">maxnh</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">Enaatm</span><span class="p">,</span> <span class="n">Enascf</span><span class="p">,</span> <span class="n">Uatm</span><span class="p">,</span> <span class="n">Uscf</span><span class="p">,</span> <span class="n">DUscf</span><span class="p">,</span> <span class="n">DUext</span><span class="p">,</span> 
     <span class="p">&amp;</span>                  <span class="n">Exc</span><span class="p">,</span> <span class="n">Dxc</span><span class="p">,</span> <span class="n">dipol</span><span class="p">,</span> <span class="n">stress</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">use_rhog_in</span><span class="p">,</span> <span class="n">charge_density_only</span> <span class="p">)</span>
<span class="c">!! author: J.M. Soler</span>
<span class="c">!! date: August 1996</span>
<span class="c">!!</span>
<span class="c">!! Calculates the self-consistent field contributions to Hamiltonian</span>
<span class="c">!! matrix elements, total energy and atomic forces.</span>
<span class="c">!!</span>
<span class="c">!! Coded by J.M. Soler, August 1996. July 1997.  </span>
<span class="c">!! Modified by J.D. Gale, February 2000.</span>
<span class="c">!!</span>
<span class="c">!!</span>
<span class="c">!!### Units</span>
<span class="c">!! Energies in Rydbergs.  </span>
<span class="c">!! Distances in Bohr.</span>
<span class="c">!!</span>
<span class="c">!!### Routines called internally</span>
<span class="c">!! * [[cellxc(proc)]]    : Finds total exch-corr energy and potential</span>
<span class="c">!! * [[cross(proc)]]   : Finds the cross product of two vectors</span>
<span class="c">!! * [[dfscf(proc)]]     : Finds SCF contribution to atomic forces</span>
<span class="c">!! * [[dipole(proc)]]    : Finds electric dipole moment</span>
<span class="c">!! * [[doping(proc)]]    : Adds a background charge for doped systems</span>
<span class="c">!! * [[write_rho(proc)]]     : Saves electron density on a file</span>
<span class="c">!! * [[poison(proc)]]    : Solves Poisson equation</span>
<span class="c">!! * [[reord(proc)]]     : Reorders electron density and potential arrays</span>
<span class="c">!! * [[rhooda(proc)]]    : Finds Harris electron density in the mesh</span>
<span class="c">!! * [[rhoofd(proc)]]    : Finds SCF electron density in the mesh</span>
<span class="c">!! * [[rhoofdsp(proc)]]  : Finds SCF electron density in the mesh for</span>
<span class="c">!!                    spiral arrangement of spins</span>
<span class="c">!! * [[timer(proc)]]     : Finds CPU times</span>
<span class="c">!! * [[vmat(proc)]]      : Finds matrix elements of SCF potential</span>
<span class="c">!! * [[vmatsp(proc)]]    : Finds matrix elements of SCF potential for</span>
<span class="c">!!                         spiral arrangement of spins</span>
<span class="c">!! * [[delk(proc)]] : Finds matrix elements of \( exp(i \vec{k} \cdot \vec{r}) \)</span>
<span class="c">!! * real*8 volcel( cell ) : Returns volume of unit cell</span>
<span class="c">!!</span>
<span class="c">!!### Internal variables and arrays</span>
<span class="c">!! * `real*8  bcell(3,3)`    : Bulk lattice vectors</span>
<span class="c">!! * `real*8  cell(3,3)`     : Auxiliary lattice vectors (same as ucell)</span>
<span class="c">!! * `real*8  const`         : Auxiliary variable (constant within a loop)</span>
<span class="c">!! * `real*8  DEc`           : Auxiliary variable to call cellxc</span>
<span class="c">!! * `real*8  DEx`           : Auxiliary variable to call cellxc</span>
<span class="c">!! * `real*8  dvol`          : Mesh-cell volume</span>
<span class="c">!! * `real*8  Ec`            : Correlation energy</span>
<span class="c">!! * `real*8  Ex`            : Exchange energy</span>
<span class="c">!! * `real*8  field(3)`      : External electric field</span>
<span class="c">!! * `integer i`             : General-purpose index</span>
<span class="c">!! * `integer ia`            : Atom index</span>
<span class="c">!! * `integer io`            : Orbital index</span>
<span class="c">!! * `integer ip`            : Point index</span>
<span class="c">!! * `integer is`            : Species index</span>
<span class="c">!! * `logical IsDiag`        : Is supercell diagonal?</span>
<span class="c">!! * `integer ispin`         : Spin index</span>
<span class="c">!! * `integer j`             : General-purpose index</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!! * `integer JDGdistr`      : J.D.Gale&#39;s parallel distribution of mesh points</span>
<span class="c">!! * `integer myBox(2,3)`    : My processor&#39;s mesh box</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
<span class="c">!! * `integer nbcell`        : Number of independent bulk lattice vectors</span>
<span class="c">!! * `integer npcc`          : Partial core corrections? (0=no, 1=yes)</span>
<span class="c">!! * `integer nsd`           : Number of diagonal spin values (1 or 2)</span>
<span class="c">!! * `integer ntpl`          : Number of mesh Total Points in unit cell</span>
<span class="c">!!                           (including subpoints) locally</span>
<span class="c">!! * `real*4  rhoatm(ntpl)`  : Harris electron density</span>
<span class="c">!! * `real*4  rhopcc(ntpl)`  : Partial-core-correction density for xc</span>
<span class="c">!! * `real*4  DRho(ntpl)`    : Selfconsistent electron density difference</span>
<span class="c">!! * `real*8  rhotot`        : Total density at one point</span>
<span class="c">!! * `real*8  rmax`          : Maximum orbital radius</span>
<span class="c">!! * `real*8  scell(3,3)`    : Supercell vectors</span>
<span class="c">!! * `character shape*10`    : Name of system shape</span>
<span class="c">!! * `real*4  Vaux(ntpl)`    : Auxiliary potential array</span>
<span class="c">!! * `real*4  Vna(ntpl)`     : Sum of neutral-atom potentials</span>
<span class="c">!! * `real*8  volume`        : Unit cell volume</span>
<span class="c">!! * `real*4  Vscf(ntpl)`    : Hartree potential of selfconsistent density</span>
<span class="c">!! * `real*8  x0(3)`         : Center of molecule</span>
<span class="c">!! * `logical harrisfun`     : Harris functional or Kohn-Sham?</span>

      <span class="k">use </span><span class="nb">precision</span><span class="p">,</span>     <span class="n">only</span>  <span class="p">:</span> <span class="n">dp</span><span class="p">,</span> <span class="n">grid_p</span>
<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ProcessorY</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>

<span class="c">!     Number of Mesh divisions of each cell vector (global)</span>
<span class="c">!     The status of this variable is confusing</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Nodes</span>
      <span class="k">use </span><span class="n">atmfuncs</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">rcut</span><span class="p">,</span> <span class="n">rcore</span>
      <span class="k">use </span><span class="n">units</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">Debye</span><span class="p">,</span> <span class="n">eV</span><span class="p">,</span> <span class="n">Ang</span>
      <span class="k">use </span><span class="n">fdf</span>
      <span class="k">use </span><span class="n">sys</span><span class="p">,</span>           <span class="n">only</span>  <span class="p">:</span> <span class="n">die</span><span class="p">,</span> <span class="n">bye</span>
      <span class="k">use </span><span class="n">mesh</span><span class="p">,</span>          <span class="n">only</span>  <span class="p">:</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span>
      <span class="k">use </span><span class="n">parsing</span>
      <span class="k">use </span><span class="n">m_iorho</span><span class="p">,</span>       <span class="n">only</span>  <span class="p">:</span> <span class="n">write_rho</span>
      <span class="k">use </span><span class="n">m_forhar</span><span class="p">,</span>      <span class="n">only</span>  <span class="p">:</span> <span class="n">forhar</span>
      <span class="k">use </span><span class="n">alloc</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">re_alloc</span><span class="p">,</span> <span class="n">de_alloc</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">slabel</span>
      <span class="k">use </span><span class="n">files</span><span class="p">,</span>         <span class="n">only</span>  <span class="p">:</span> <span class="n">filesOut_t</span> <span class="c">! derived type for output file names</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">harrisfun</span><span class="p">,</span> <span class="n">save_initial_charge_density</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">analyze_charge_density_only</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">LocalChargeOnMesh</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">PartialCoreOnMesh</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span>       <span class="n">only</span> <span class="p">:</span> <span class="n">NeutralAtomOnMesh</span>

      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">setMeshDistr</span><span class="p">,</span> <span class="n">distMeshData</span>
      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">LINEAR</span>
      <span class="k">use </span><span class="n">moreMeshSubs</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">TO_SEQUENTIAL</span><span class="p">,</span> <span class="n">TO_CLUSTER</span><span class="p">,</span> <span class="n">KEEP</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">compute_partial_charges</span>
      <span class="k">use </span><span class="n">m_partial_charges</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">want_partial_charges</span>
<span class="cp">#ifndef BSC_CELLXC</span>

      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cellXC</span>       <span class="c">! Finds xc energy and potential</span>
      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myMeshBox</span>    <span class="c">! Returns my processor mesh box</span>
      <span class="k">use </span><span class="n">siestaXC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jms_setMeshDistr</span> <span class="o">=&gt;</span> <span class="n">setMeshDistr</span>
                                        <span class="c">! Sets a distribution of mesh</span>
                                        <span class="c">! points over parallel processors</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">use </span><span class="n">m_vmat</span><span class="p">,</span>  <span class="n">only</span>  <span class="p">:</span> <span class="n">vmat</span>
      <span class="k">use </span><span class="n">m_rhoofd</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">rhoofd</span>
<span class="cp">#ifdef MPI</span>
      <span class="k">use </span><span class="n">mpi_siesta</span>
<span class="cp">#endif</span>
      <span class="k">use </span><span class="n">iogrid_netcdf</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_grid_netcdf</span>
      <span class="k">use </span><span class="n">iogrid_netcdf</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_grid_netcdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_charge_cdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savebader</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">read_deformation_charge_cdf</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">mix_charge</span>

      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">get_field_from_dipole</span><span class="p">,</span> <span class="n">dipole_correction</span>
      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">add_potential_from_field</span>
      <span class="k">use </span><span class="n">m_efield</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">user_specified_field</span><span class="p">,</span> <span class="n">acting_efield</span>
      <span class="k">use </span><span class="n">m_doping_uniform</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">doping_active</span><span class="p">,</span> <span class="n">doping_uniform</span>
      
      <span class="k">use </span><span class="n">m_charge_add</span><span class="p">,</span>   <span class="n">only</span><span class="p">:</span> <span class="n">charge_add</span>
      <span class="k">use </span><span class="n">m_hartree_add</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">hartree_add</span>

<span class="cp">#ifdef NCDF_4</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_cdf</span>
      <span class="k">use </span><span class="n">m_ncdf_siesta</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">cdf_save_grid</span>
<span class="cp">#endif</span>
      <span class="k">use </span><span class="n">m_rhofft</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">rhofft</span><span class="p">,</span> <span class="n">FORWARD</span><span class="p">,</span> <span class="n">BACKWARD</span>
      <span class="k">use </span><span class="n">m_rhog</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">rhog_in</span><span class="p">,</span> <span class="n">rhog</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">spin</span>
      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">Spiral</span><span class="p">,</span> <span class="n">qSpiral</span>
      <span class="k">use </span><span class="n">m_iotddft</span><span class="p">,</span>      <span class="n">only</span><span class="p">:</span> <span class="n">write_tdrho</span>
      <span class="k">use </span><span class="n">m_ts_global_vars</span><span class="p">,</span><span class="n">only</span><span class="p">:</span> <span class="n">TSmode</span><span class="p">,</span> <span class="n">TSrun</span>
      <span class="k">use </span><span class="n">m_ts_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">IsVolt</span><span class="p">,</span> <span class="n">Elecs</span><span class="p">,</span> <span class="n">N_elec</span>
      <span class="k">use </span><span class="n">m_ts_voltage</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ts_voltage</span>
      <span class="k">use </span><span class="n">m_ts_hartree</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ts_hartree_fix</span>

      <span class="k">implicit none</span>

<span class="k">      </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nspin</span>
        <span class="c">!! Number of different spin polarisations:  </span>
        <span class="c">!! nspin=1 =&gt; Unpolarized, nspin=2 =&gt; polarized  </span>
        <span class="c">!! nspin=4 =&gt; Noncollinear spin or spin-orbit.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">norb</span>
        <span class="c">!! Total number of basis orbitals in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iaorb</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Atom to which each orbital belongs</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iphorb</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Orbital index (within atom) of each orbital</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nuo</span>
        <span class="c">!! Number of orbitals in a unit cell in this node</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nuotot</span>
        <span class="c">!! Number of orbitals in a unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nua</span>
        <span class="c">!! Number of atoms in unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">na</span>
        <span class="c">!! Number of atoms in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">isa</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Species index of all atoms in supercell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">indxua</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Index of equivalent atom in unit cell</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ifa</span>
        <span class="c">!! Switch which fixes whether the SCF contrib:  </span>
        <span class="c">!! to atomic forces is calculated and added to fa.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">istr</span>
        <span class="c">!! Switch which fixes whether the SCF contrib:  </span>
        <span class="c">!! to stress is calculated and added to stress.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iHmat</span>
        <span class="c">!! Switch which fixes whether the Hmat matrix</span>
        <span class="c">!! elements are calculated or not.</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">maxnd</span>
        <span class="c">!! First dimension of listd and Dscf</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">numd</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>
        <span class="c">!! Number of nonzero density-matrix</span>
        <span class="c">!! elements for each matrix row</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">listdptr</span><span class="p">(</span><span class="n">nuo</span><span class="p">)</span>
        <span class="c">!! Pointer to start of rows of density-matrix</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">listd</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
        <span class="c">!! `listd(maxnd)`: Nonzero-density-matrix-element column</span>
        <span class="c">!! indexes for each matrix row</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">maxnh</span>
        <span class="c">!! First dimension of listh and Hmat</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xa</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">na</span><span class="p">)</span>
        <span class="c">!! Atomic positions of all atoms in supercell</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Dscf</span><span class="p">(:,:)</span>
        <span class="c">!! `Dscf(maxnd,h_spin_dim)`:  </span>
        <span class="c">!! SCF density-matrix elements</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">datm</span><span class="p">(</span><span class="n">norb</span><span class="p">)</span>
        <span class="c">!! Harris density-matrix diagonal elements  </span>
        <span class="c">!! (atomic occupation charges of orbitals)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Hmat</span><span class="p">(:,:)</span>
        <span class="c">!! `Hmat(maxnh,h_spin_dim)`:  </span>
        <span class="c">!! Hamiltonian matrix in sparse form,  </span>
        <span class="c">!! to which are added the matrix elements  </span>
        <span class="c">!! `&lt;ORB_I | DeltaV | ORB_J&gt;`, where  </span>
        <span class="c">!! `DeltaV = Vna + Vxc(SCF) + Vhartree(RhoSCF-RhoHarris)`</span>

      <span class="k">type</span><span class="p">(</span><span class="n">filesOut_t</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">filesOut</span>
        <span class="c">!! Output file names (If blank =&gt; not saved)</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ntm</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Number of mesh divisions of each cell</span>
        <span class="c">!! vector, including subgrid.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">nua</span><span class="p">)</span>
        <span class="c">!! Atomic forces, to which the SCF contribution</span>
        <span class="c">!! is added by this routine when `ifa=1`.</span>
        <span class="c">!! The SCF contribution is minus the derivative</span>
        <span class="c">!! of `(Enascf - Enaatm + DUscf + Exc)` with</span>
        <span class="c">!! respect to atomic positions, in Ry/Bohr.</span>
        <span class="c">!! Contributions local to this node.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Stress tensor, to which the SCF contribution</span>
        <span class="c">!! is added by this routine when `ifa=1`.</span>
        <span class="c">!! The SCF contribution is minus the derivative of</span>
        <span class="c">!! `(Enascf - Enaatm + DUscf + Exc) / volume`</span>
        <span class="c">!! with respect to the strain tensor, in Ry.</span>
        <span class="c">!! Contributions local to this node.</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stress</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Enaatm</span>
        <span class="c">!! Integral of `Vna * rhoatm`</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Enascf</span>
        <span class="c">!! Integral of `Vna * rhoscf`</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Uatm</span>
        <span class="c">!! Harris hartree electron-interaction energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Uscf</span>
        <span class="c">!! SCF hartree electron-interaction energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">DUscf</span>
        <span class="c">!! Electrostatic (Hartree) energy of</span>
        <span class="c">!! `(rhoscf - rhoatm)` density</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">DUext</span>
        <span class="c">!! Interaction energy with external electric field</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Exc</span>
        <span class="c">!! SCF exchange-correlation energy</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Dxc</span>
        <span class="c">!! SCF double-counting correction to Exc  </span>
        <span class="c">!! `Dxc = integral of ( (epsxc - Vxc) * Rho )`  </span>
        <span class="c">!! All energies in Rydbergs</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Electric dipole (in a.u.)</span>
        <span class="c">!! only when the system is a molecule</span>

      <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">use_rhog_in</span>
      <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span> <span class="k">optional</span> <span class="kd">::</span> <span class="n">charge_density_only</span>


<span class="c">!     Local variables</span>
      <span class="kt">integer</span>  <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">ia</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">nsd</span><span class="p">,</span> <span class="n">np_vac</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Interface to JMS&#39;s SiestaXC</span>
      <span class="kt">integer</span>       <span class="kd">::</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">integer</span><span class="p">,</span> <span class="k">save</span> <span class="kd">::</span> <span class="n">JDGdistr</span><span class="o">=-</span><span class="mi">1</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">stressXC</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">b1Xb2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">const</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DStres</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
     <span class="p">&amp;</span>            <span class="n">Ec</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">rhotot</span><span class="p">,</span> <span class="n">x0</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Vmax_vac</span><span class="p">,</span> <span class="n">Vmean_vac</span>
<span class="cp">#ifdef BSC_CELLXC</span>
<span class="c">!     Dummy arrays for cellxc call</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">aux3</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dummy_DVxcdn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="kt">logical</span> <span class="kd">::</span> <span class="n">use_rhog</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">volcel</span><span class="p">,</span> <span class="n">ddot</span>

      <span class="k">external</span>
     <span class="p">&amp;</span>  <span class="n">cross</span><span class="p">,</span>
     <span class="p">&amp;</span>  <span class="n">dipole</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">poison</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">reord</span><span class="p">,</span> <span class="n">rhooda</span><span class="p">,</span> <span class="n">rhoofdsp</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">timer</span><span class="p">,</span> <span class="n">vmatsp</span><span class="p">,</span> 
     <span class="p">&amp;</span>  <span class="n">readsp</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">external </span><span class="n">bsc_cellxc</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="c">!     Work arrays</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Vscf</span><span class="p">(:,:),</span> <span class="n">Vscf_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                         <span class="n">DRho</span><span class="p">(:,:),</span> <span class="n">DRho_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                         <span class="n">Vaux</span><span class="p">(:),</span> <span class="n">Vaux_par</span><span class="p">(:),</span> <span class="n">Chlocal</span><span class="p">(:),</span>
     <span class="p">&amp;</span>                         <span class="n">Totchar</span><span class="p">(:),</span> <span class="n">fsrc</span><span class="p">(:),</span> <span class="n">fdst</span><span class="p">(:),</span>
     <span class="p">&amp;</span>                         <span class="n">rhoatm_quad</span><span class="p">(:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">(),</span>
     <span class="p">&amp;</span>                         <span class="n">DRho_quad</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>
      <span class="c">! Temporary reciprocal spin quantity</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span> <span class="kd">::</span> <span class="n">rnsd</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Vscf_gga</span><span class="p">(:,:),</span> <span class="n">DRho_gga</span><span class="p">(:,:)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
<span class="cp">#ifdef MPI</span>
      <span class="kt">integer</span>  <span class="kd">::</span> <span class="n">MPIerror</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">sbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef DEBUG</span>
      <span class="k">call </span><span class="n">write_debug</span><span class="p">(</span> <span class="s1">&#39;    PRE DHSCF&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">H</span> <span class="o">/=</span> <span class="n">size</span><span class="p">(</span><span class="n">Dscf</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">die</span><span class="p">(</span><span class="s1">&#39;Spin components is not equal to options.&#39;</span><span class="p">)</span>
      <span class="k">end if</span>

<span class="k">      if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;DM&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">)</span>
         <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Hmat</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">spin</span><span class="p">%</span><span class="n">H</span><span class="p">)</span>
      <span class="k">end if</span>
      
<span class="c">!-------------------------------------------------------------------- BEGIN</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Start of SCF iteration part</span>
<span class="c">! ----------------------------------------------------------------------</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     At the end of DHSCF_INIT, and also at the end of any previous</span>
<span class="c">!     call to dhscf, we were in the UNIFORM distribution</span>
<span class="c">!     Rhoatm, Rhopcc and Vna were in UNIFORM dist, sequential form</span>
<span class="c">!     The index array endpht was in the QUADRATIC distribution</span>
<span class="c">! ----------------------------------------------------------------------</span>

<span class="cp">#ifdef _TRACE_</span>
      <span class="k">call </span><span class="n">MPI_Barrier</span><span class="p">(</span> <span class="n">MPI_Comm_World</span><span class="p">,</span> <span class="n">MPIerror</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">MPItrace_restart</span><span class="p">(</span> <span class="p">)</span>
<span class="cp">#endif</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>

      <span class="k">nullify</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">Totchar</span> <span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">nullify</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="n">DRho_gga</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="n">volume</span> <span class="o">=</span> <span class="n">volcel</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

<span class="c">!-------------------------------------------------------------------------</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">analyze_charge_density_only</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">!! Use the functionality in the first block</span>
         <span class="c">!! of the routine to get charge files and partial charges</span>
         <span class="k">call </span><span class="n">setup_analysis_options</span><span class="p">()</span>
      <span class="n">endif</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Uniform dist, sequential form</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vna&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span><span class="n">Vna</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vna</span><span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="s2">&quot;Vna&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vna</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="s2">&quot;Vna&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Allocate memory for DRho using the UNIFORM data distribution</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

<span class="c">! Find number of diagonal spin values</span>
      <span class="n">nsd</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span> <span class="n">nspin</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">nsd</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         </span><span class="n">rnsd</span> <span class="o">=</span> <span class="mf">1._grid_p</span>
      <span class="k">else</span>
<span class="k">         </span><span class="n">rnsd</span> <span class="o">=</span> <span class="mf">1._grid_p</span> <span class="o">/</span> <span class="n">nsd</span>
      <span class="k">end if</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Find SCF electron density at mesh points. Store it in array DRho</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!</span>
<span class="c">!     The reading routine works in the uniform distribution, in</span>
<span class="c">!     sequential form</span>
<span class="c">!</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">use_rhog_in</span><span class="p">))</span> <span class="k">then</span>
<span class="k">            </span><span class="n">use_rhog</span> <span class="o">=</span> <span class="n">use_rhog_in</span>
         <span class="k">else</span>
<span class="k">            </span><span class="n">use_rhog</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="n">endif</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">use_rhog</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! fourier transform back into drho</span>
         <span class="k">call </span><span class="n">rhofft</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>                  <span class="n">DRho</span><span class="p">,</span><span class="n">rhog_in</span><span class="p">,</span><span class="n">BACKWARD</span><span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span><span class="n">read_charge_cdf</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">read_grid_netcdf</span><span class="p">(</span><span class="n">ntm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="n">DRho</span><span class="p">,</span><span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
         <span class="n">read_charge_cdf</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">else if</span> <span class="p">(</span><span class="n">read_deformation_charge_cdf</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">read_grid_netcdf</span><span class="p">(</span><span class="n">ntm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="n">DRho</span><span class="p">,</span><span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
         <span class="c">! Add to diagonal components only</span>
         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
            <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
<span class="c">!             rhoatm and Drho are in sequential mode</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
            <span class="n">enddo</span>
         <span class="n">enddo</span>
         <span class="n">read_deformation_charge_cdf</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
      <span class="k">else</span>
        <span class="c">! Set the QUADRATIC distribution and allocate memory for DRho_par</span>
        <span class="c">! since the construction of the density from the DM and orbital</span>
        <span class="c">! data needs that distribution</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;DRho_par&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>       
        <span class="k">if</span> <span class="p">(</span><span class="n">Spiral</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">rhoofdsp</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>                   <span class="n">nspin</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span>
     <span class="p">&amp;</span>                   <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">qspiral</span> <span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">rhoofd</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="n">nspin</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">DRho_par</span><span class="p">,</span> 
     <span class="p">&amp;</span>                 <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="c">! DRHO_par is here in QUADRATIC, clustered form</span>

<span class="c">!       Set the UNIFORM distribution again and copy DRho to it</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>

        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! Sequential to be able to write it out</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
        <span class="n">enddo</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho_par</span><span class="p">,</span> <span class="s1">&#39;DRho_par&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;DRho&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nspin</span><span class="p">)</span>
        <span class="k">end if</span>

<span class="k">        if</span> <span class="p">(</span><span class="n">save_initial_charge_density</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! This section is to be deprecated in favor</span>
           <span class="c">! of &quot;analyze_charge_density_only&quot;</span>
           <span class="c">! (except for the special name for the .nc file)</span>
<span class="cp">#ifdef NCDF_4</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoInit&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">ntml</span><span class="p">,</span><span class="n">DRho</span><span class="p">)</span>
          <span class="k">else</span>
<span class="k">             call </span><span class="n">write_rho</span><span class="p">(</span> <span class="s2">&quot;RHO_INIT&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>            <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">)</span>
             <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="err">$</span>            <span class="s2">&quot;RhoInit&quot;</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="cp">#else</span>
          <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="s2">&quot;RHO_INIT&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>         <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">)</span>
          <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="err">$</span>         <span class="s2">&quot;RhoInit&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
          <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;STOP after producing RHO_INIT from input DM&quot;</span><span class="p">)</span>
        <span class="n">endif</span>

      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">mix_charge</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! Save fourier transform of charge density</span>
         <span class="k">call </span><span class="n">rhofft</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">DRho</span><span class="p">,</span><span class="n">rhog</span><span class="p">,</span><span class="n">FORWARD</span><span class="p">)</span>
      <span class="n">endif</span>
<span class="c">!</span>
<span class="c">!     Proper place to integrate Hirshfeld and Voronoi code,</span>
<span class="c">!     since we have just computed rhoatm and Rho.</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">want_partial_charges</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! The endpht array is in the quadratic distribution, so</span>
        <span class="c">! we need to use it for this...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;DRho_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>       
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">rhoatm_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;rhoatm_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="c">! Redistribute grid-density</span>
        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho_quad</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="n">enddo</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">rhoatm</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">rhoatm_quad</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">compute_partial_charges</span><span class="p">(</span><span class="n">DRho_quad</span><span class="p">,</span><span class="n">rhoatm_quad</span><span class="p">,</span>
     <span class="p">.</span>                  <span class="n">nspin</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> 
     <span class="p">.</span>                  <span class="n">isa</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span><span class="n">dvol</span><span class="p">)</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span><span class="n">rhoatm_quad</span><span class="p">,</span><span class="s1">&#39;rhoatm_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span><span class="n">Drho_quad</span><span class="p">,</span><span class="s1">&#39;DRho_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save electron density</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">!  DRho is already using a uniform, sequential form</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Rho&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;Rho&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>
<span class="c">!-----------------------------------------------------------------------</span>
<span class="c">! Save TD-electron density after every given number of steps- Rafi, Jan 2016</span>
<span class="c">!-----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">write_tdrho</span><span class="p">(</span><span class="n">filesOut</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">tdrho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">!  DRho is already using a uniform, sequential form</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">tdrho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                  <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;TDRho&quot;</span><span class="p">)</span>
      <span class="n">endif</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save the diffuse ionic charge and/or the total (ionic+electronic) charge</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!       Find diffuse ionic charge on mesh</span>
        <span class="c">! Note that the *OnMesh routines, except PhiOnMesh,</span>
        <span class="c">! work with any distribution, thanks to the fact that</span>
        <span class="c">! the ipa, idop, and indexp arrays are distro-specific</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">LocalChargeOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">indxua</span> <span class="p">)</span>
        <span class="c">! Chlocal comes out in clustered form, so we convert it</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Chlocal</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">end if</span>

<span class="c">!       Save diffuse ionic charge </span>
        <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">Chlocal</span><span class="p">)</span>
          <span class="k">else</span>
<span class="k">             call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="n">Chlocal</span><span class="p">)</span>
             <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="s1">&#39;Chlocal&#39;</span> <span class="p">)</span>
          <span class="k">end if</span>
<span class="cp">#else</span>
          <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Chlocal</span><span class="p">)</span>
          <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>         <span class="n">Chlocal</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>
        <span class="n">endif</span>

<span class="c">!       Save total (ionic+electronic) charge </span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
           <span class="c">! *****************</span>
           <span class="c">! **  IMPORTANT  **</span>
           <span class="c">! The Chlocal array is re-used to minimize memory</span>
           <span class="c">! usage. In the this small snippet the Chlocal</span>
           <span class="c">! array will contain the total charge, and</span>
           <span class="c">! if the logic should change, (i.e. should Chlocal</span>
           <span class="c">! be retained) is the Totchar needed to be re-instantiated.</span>
           <span class="c">! *****************</span>

<span class="c">!$OMP parallel default(shared), private(ispin,ip)</span>
           <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
<span class="c">!$OMP do </span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
              <span class="n">Chlocal</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">Chlocal</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="k">end do</span>
<span class="c">!$OMP end do </span>
           <span class="k">end do</span>
<span class="c">!$OMP end parallel</span>

          <span class="c">! See note above</span>
<span class="cp">#ifdef NCDF_4</span>
           <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">              call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoTot&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">Chlocal</span><span class="p">)</span>
           <span class="k">else</span>
<span class="k">              call </span><span class="n">write_rho</span><span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">ntm</span><span class="p">,</span><span class="n">nsm</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Chlocal</span><span class="p">)</span>
              <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Chlocal</span><span class="p">,</span> 
     <span class="p">&amp;</span>             <span class="s2">&quot;TotalCharge&quot;</span><span class="p">)</span>
           <span class="k">end if</span>
<span class="cp">#else</span>
           <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Chlocal</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Chlocal</span><span class="p">,</span> <span class="s2">&quot;TotalCharge&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
        <span class="k">end if </span>
<span class="k">        call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Chlocal</span><span class="p">,</span> <span class="s1">&#39;Chlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save the total charge (model core + valence) for Bader analysis</span>
<span class="c">! ----------------------------------------------------------------------</span>
      
      <span class="c">! The test for toch guarantees that we are in &quot;analysis mode&quot;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">savebader</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        call </span><span class="n">save_bader_charge</span><span class="p">()</span>
      <span class="n">endif</span>

<span class="c">! Find difference between selfconsistent and atomic densities</span>

      <span class="c">!Both DRho and rhoatm are using a UNIFORM, sequential form</span>
<span class="c">!$OMP parallel do default(shared), private(ispin,ip),</span>
<span class="c">!$OMP&amp;collapse(2)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Save electron density difference</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoDelta&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span><span class="p">,</span> <span class="s2">&quot;DeltaRho&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">charge_density_only</span><span class="p">))</span> <span class="k">then </span>
<span class="k">         if</span> <span class="p">(</span><span class="n">charge_density_only</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
            <span class="k">RETURN</span>
<span class="k">         </span><span class="n">endif</span>
      <span class="n">endif</span>

<span class="c">! End of analysis section</span>
<span class="c">! Can exit now, if requested</span>
      
        <span class="k">if</span> <span class="p">(</span><span class="n">analyze_charge_density_only</span><span class="p">)</span> <span class="k">then </span>
<span class="k">            call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
           <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s2">&quot;STOP after analyzing charge from input DM&quot;</span><span class="p">)</span>
        <span class="n">endif</span>

<span class="c">!-------------------------------------------------------------</span>
<span class="c">!     Transform spin density into sum and difference</span>

      <span class="c">! TODO Check for NC/SO:</span>
      <span class="c">! Should we diagonalize locally at every point first?</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(rhotot,ip)</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
          <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">rhotot</span>
        <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">endif</span>

<span class="c">! Add a background charge to neutralize the net charge, to</span>
<span class="c">! model doped systems. It only adds the charge at points</span>
<span class="c">! where there are atoms (i.e., not in vacuum).          </span>
<span class="c">! First, call with &#39;task=0&#39; to add background charge    </span>
      <span class="k">if</span> <span class="p">(</span><span class="n">doping_active</span><span class="p">)</span> <span class="k">call </span><span class="n">doping_uniform</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">rhoatm</span><span class="p">)</span>
      
      <span class="c">! Add doping in cell (from ChargeGeometries/Geometry.Charge)</span>
      <span class="c">! Note that this routine will return immediately if no dopant is present</span>
      <span class="k">call </span><span class="n">charge_add</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Calculate the dipole moment</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39;bulk&#39;</span><span class="p">)</span> <span class="k">then</span>

<span class="c">! Find center of system</span>
        <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
        <span class="k">do </span><span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nua</span>
          <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">x0</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">xa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ia</span><span class="p">)</span> <span class="o">/</span> <span class="n">nua</span>
        <span class="n">enddo</span>

<span class="c">! Find dipole</span>
        <span class="c">! This routine is distribution-blind</span>
        <span class="c">! and will reduce over all processors.</span>
        <span class="k">call </span><span class="n">dipole</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">nsm</span><span class="p">,</span>
     <span class="p">&amp;</span>               <span class="n">DRho</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dipol</span> <span class="p">)</span>

        <span class="c">! Orthogonalize dipole to bulk directions</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          </span><span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">bcell</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span> <span class="o">*</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else if</span> <span class="p">(</span><span class="nb">shape</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;slab&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">cross</span><span class="p">(</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bcell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">b1Xb2</span> <span class="p">)</span>
          <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">b1Xb2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span> <span class="o">*</span> <span class="n">b1Xb2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
       <span class="k">end if</span>

<span class="k">       if</span> <span class="p">(</span> <span class="n">TSmode</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span> <span class="n">N_elec</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span> <span class="k">then</span>
          <span class="c">! Orthogonalize dipole to electrode transport directions</span>
          <span class="k">do </span><span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">,</span> <span class="n">N_Elec</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">Elecs</span><span class="p">(</span><span class="n">ia</span><span class="p">)%</span><span class="n">cell</span><span class="p">(:,</span><span class="n">Elecs</span><span class="p">(</span><span class="n">ia</span><span class="p">)%</span><span class="n">t_dir</span><span class="p">)</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">const</span> <span class="o">*</span> <span class="n">x0</span>
          <span class="k">end do</span>
<span class="k">        else if</span> <span class="p">(</span> <span class="p">(</span><span class="nb">shape</span> <span class="o">==</span> <span class="s1">&#39;molecule&#39;</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="nb">shape</span> <span class="o">==</span> <span class="s1">&#39;chain&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="k">then</span>
          <span class="c">! Only allow dipole correction for chains and molecules</span>
          <span class="c">! along the semi-infinite direciton.</span>
          <span class="c">! Note this is *only* for 1-electrode setups</span>
          <span class="c">! Note that since the above removes the periodic directions</span>
          <span class="c">! this should not do anything for &#39;chain&#39; with the same semi-infinite</span>
          <span class="c">! direction</span>
          <span class="n">x0</span> <span class="o">=</span> <span class="n">Elecs</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">cell</span><span class="p">(:,</span><span class="n">Elecs</span><span class="p">(</span><span class="mi">1</span><span class="p">)%</span><span class="n">t_dir</span><span class="p">)</span>
          <span class="n">const</span> <span class="o">=</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">dipol</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span> <span class="o">*</span> <span class="n">x0</span>
        <span class="k">end if</span>
<span class="k">       end if</span>
<span class="k">          </span>
<span class="k">      </span><span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find Hartree potential of DRho = rhoscf-rhoatm. Store it in Vaux</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Solve Poisson&#39;s equation</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Vaux&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">call </span><span class="n">poison</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ntml</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DUscf</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">DStres</span><span class="p">,</span> <span class="n">nsm</span> <span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;Poisson&#39;</span><span class="p">,</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vaux</span><span class="p">(:)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
      <span class="k">end if</span>

      <span class="c">! Vscf is in the UNIFORM, sequential form, and only using</span>
      <span class="c">! the first spin index</span>

      <span class="c">! We require that even the SIESTA potential is &quot;fixed&quot;</span>
      <span class="c">! NOTE, this will only do something if</span>
      <span class="c">!   TS.Hartree.Fix is set</span>
      <span class="k">call </span><span class="n">ts_hartree_fix</span><span class="p">(</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">)</span>
      
<span class="c">! Add contribution to stress from electrostatic energy of rhoscf-rhoatm</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">istr</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">stressl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">stressl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">DStres</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find electrostatic (Hartree) energy of full SCF electron density</span>
<span class="c">!     using the original data distribution </span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">Uatm</span> <span class="o">=</span> <span class="n">Uharrs</span>
      <span class="n">Uscf</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP parallel do default(shared), private(ip), </span>
<span class="c">!$OMP&amp;reduction(+:Uscf)</span>
      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
        <span class="n">Uscf</span> <span class="o">=</span> <span class="n">Uscf</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">Uscf</span> <span class="o">=</span> <span class="n">Uscf</span> <span class="o">*</span> <span class="n">dVol</span> <span class="o">+</span> <span class="n">Uatm</span> <span class="o">+</span> <span class="n">DUscf</span>

<span class="c">! Call doping with &#39;task=1&#39; to remove background charge added previously</span>
<span class="c">! The extra charge thus only affects the Hartree energy and potential,</span>
<span class="c">! but not the contribution to Enascf ( = \Int_{Vna*\rho})</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">doping_active</span><span class="p">)</span> <span class="k">call </span><span class="n">doping_uniform</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ntpl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">),</span><span class="n">rhoatm</span><span class="p">)</span>

      <span class="c">! Remove doping in cell (from ChargeGeometries/Geometry.Charge)</span>
      <span class="c">! Note that this routine will return immediately if no dopant is present</span>
      <span class="k">call </span><span class="n">charge_add</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add neutral-atom potential to Vaux</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
<span class="c">!$OMP parallel do default(shared), private(ip),</span>
<span class="c">!$OMP&amp;reduction(+:Enaatm,Enascf)</span>
      <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
        <span class="n">Enaatm</span>   <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="n">Enascf</span>   <span class="o">=</span> <span class="n">Enascf</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vna</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">*</span> <span class="n">dVol</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="n">Enaatm</span> <span class="o">+</span> <span class="n">Enascf</span> <span class="o">*</span> <span class="n">dVol</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add potential from external electric field (if present)</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">acting_efield</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span> <span class="n">dipole_correction</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">            </span><span class="n">field</span> <span class="o">=</span> <span class="n">get_field_from_dipole</span><span class="p">(</span><span class="n">dipol</span><span class="p">,</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Node</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">	       write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;(a,3f12.4,a)&#39;</span><span class="p">)</span>
     <span class="err">$</span>              <span class="s1">&#39;Dipole moment in unit cell   =&#39;</span><span class="p">,</span> <span class="n">dipol</span><span class="o">/</span><span class="n">Debye</span><span class="p">,</span> <span class="s1">&#39; D&#39;</span>
	       <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;(a,3f12.6,a)&#39;</span><span class="p">)</span>
     <span class="err">$</span>              <span class="s1">&#39;Electric field for dipole correction =&#39;</span><span class="p">,</span>
     <span class="err">$</span>              <span class="n">field</span><span class="o">/</span><span class="n">eV</span><span class="o">*</span><span class="n">Ang</span><span class="p">,</span> <span class="s1">&#39; eV/Ang/e&#39;</span>
            <span class="k">end if</span>
            <span class="c">! The dipole correction energy has an extra factor</span>
            <span class="c">! of one half because the field involved is internal.</span>
            <span class="c">! See the paper by Bengtsson DOI:10.1103/PhysRevB.59.12301</span>
            <span class="c">! Hence we compute this part separately</span>
            <span class="n">DUext</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5_dp</span> <span class="o">*</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">field</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
         <span class="k">else</span>
<span class="k">            </span><span class="n">field</span> <span class="o">=</span> <span class="mf">0._dp</span>
            <span class="n">DUext</span> <span class="o">=</span> <span class="mf">0._dp</span>
         <span class="k">end if</span>
         <span class="c">! Add the external electric field</span>
         <span class="n">field</span> <span class="o">=</span> <span class="n">field</span> <span class="o">+</span> <span class="n">user_specified_field</span>
         <span class="c">! This routine expects a sequential array,</span>
         <span class="c">! but it is distribution-blind</span>
         <span class="k">call </span><span class="n">add_potential_from_field</span><span class="p">(</span> <span class="n">field</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">nua</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span>
     <span class="p">&amp;</span>                                  <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
         <span class="c">! Add energy of external electric field</span>
         <span class="n">DUext</span> <span class="o">=</span> <span class="n">DUext</span> <span class="o">-</span> <span class="n">ddot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">user_specified_field</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dipol</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">endif</span>

<span class="c">! ---------------------------------------------------------------------</span>
<span class="c">!     Transiesta:</span>
<span class="c">!     add the potential corresponding to the (possible) voltage-drop.</span>
<span class="c">!     note that ts_voltage is not sharing the reord wih efield since</span>
<span class="c">!     we should not encounter both at the same time.</span>
<span class="c">! ---------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">TSmode</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">IsVolt</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">TSrun</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! This routine expects a sequential array,</span>
         <span class="c">! in whatever distribution</span>
<span class="cp">#ifdef TRANSIESTA_VOLTAGE_DEBUG</span>
<span class="c">!$OMP parallel workshare default(shared)</span>
         <span class="n">Vaux</span><span class="p">(:)</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="c">!$OMP end parallel workshare</span>
<span class="cp">#endif</span>
         <span class="k">call </span><span class="n">ts_voltage</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">)</span>
<span class="cp">#ifdef TRANSIESTA_VOLTAGE_DEBUG</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> 
     <span class="p">&amp;</span>        <span class="s2">&quot;TransiestaHartreePotential&quot;</span><span class="p">)</span>
         <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;ts_volt&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
         <span class="k">call </span><span class="n">bye</span><span class="p">(</span><span class="s1">&#39;transiesta debug for Hartree potential&#39;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Add potential from user defined geometries (if present)</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">hartree_add</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Save electrostatic potential</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! Note that only the first spin component is used</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vh&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vaux</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">Vaux</span><span class="p">,</span> <span class="s2">&quot;ElectrostaticPotential&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Get back spin density from sum and difference</span>
      <span class="c">! TODO Check for NC/SO:</span>
      <span class="c">! Should we diagonalize locally at every point first?</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(ip,rhotot)</span>
        <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
          <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5_dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhotot</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
          <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5_dp</span> <span class="o">*</span> <span class="p">(</span><span class="n">rhotot</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">! Set uniform distribution of mesh points and find my processor mesh box</span>
<span class="c">! This is the interface to JM Soler&#39;s own cellxc routine, which sets</span>
<span class="c">! up the right distribution internally.</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">call </span><span class="n">jms_setMeshDistr</span><span class="p">(</span> <span class="n">distrID</span><span class="o">=</span><span class="n">JDGdistr</span><span class="p">,</span> <span class="n">nMesh</span><span class="o">=</span><span class="n">ntm</span><span class="p">,</span> 
     <span class="p">.</span>                   <span class="n">nNodesX</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nNodesY</span><span class="o">=</span><span class="n">ProcessorY</span><span class="p">,</span> <span class="n">nBlock</span><span class="o">=</span><span class="n">nsm</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">myMeshBox</span><span class="p">(</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">JDGdistr</span><span class="p">,</span> <span class="n">myBox</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
<span class="c">! Exchange-correlation energy</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Vscf&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
         
<span class="c">!$OMP parallel do default(shared), private(ip,ispin), collapse(2)</span>
       <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
          <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
             <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span>
     <span class="p">&amp;</span>            <span class="p">(</span><span class="n">rhopcc</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">rnsd</span>
          <span class="n">enddo</span>
       <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

      <span class="k">else</span>

<span class="c">!$OMP parallel do default(shared), private(ip,ispin), collapse(2)</span>
       <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
          <span class="k">do </span><span class="n">ip</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span>
             <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span>
     <span class="p">&amp;</span>            <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
          <span class="n">enddo</span>
       <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>

      <span class="k">end if</span>

      <span class="c">! Write the electron density used by cellxc</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoXC&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">else</span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">DRho</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;RhoXC&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">DRho</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> 
     <span class="p">&amp;</span>       <span class="s2">&quot;RhoXC&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">!     Everything now is in UNIFORM, sequential form</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;CellXC&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Vscf_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">DRho_gga</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;DRho_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="c">! Redistribute all spin densities</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
        <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DRho_gga</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
      <span class="n">enddo</span>

      <span class="k">call </span><span class="n">bsc_cellxc</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aux3</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DRho_gga</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">Ec</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">Vscf_gga</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">dummy_DVxcdn</span><span class="p">,</span> <span class="n">stressl</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">call </span><span class="n">cellXC</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
     <span class="p">.</span>                           <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
     <span class="p">.</span>                           <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">.</span>             <span class="n">DRho</span><span class="p">,</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">Ec</span><span class="p">,</span> <span class="n">DEx</span><span class="p">,</span> <span class="n">DEc</span><span class="p">,</span> <span class="n">stressXC</span><span class="p">,</span> <span class="n">Vscf</span> <span class="p">)</span>
<span class="cp">#else /* BSC_CELLXC */</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="c">! Redistribute to the Vxc array</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nspin</span>
        <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf_gga</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
      <span class="n">enddo</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;XC&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nspin</span><span class="p">)</span>
      <span class="k">end if</span>
      
      
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Vscf is still sequential after the call to JMS&#39;s cellxc</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho_gga</span><span class="p">,</span> <span class="s1">&#39;DRho_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_gga</span><span class="p">,</span> <span class="s1">&#39;Vscf_gga&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="n">Exc</span> <span class="o">=</span>  <span class="n">Ex</span> <span class="o">+</span>  <span class="n">Ec</span>
      <span class="n">Dxc</span> <span class="o">=</span> <span class="n">DEx</span> <span class="o">+</span> <span class="n">DEc</span>

      <span class="k">call </span><span class="n">timer</span><span class="p">(</span><span class="s2">&quot;CellXC&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="c">!     Vscf contains only Vxc, and is UNIFORM and sequential</span>
<span class="c">!     Now we add up the other contributions to it, at </span>
<span class="c">!     the same time that we get DRho back to true DeltaRho form</span>
<span class="c">!$OMP parallel default(shared), private(ip,ispin)</span>

      <span class="c">! Hartree potential only has diagonal components</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP do</span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> 
     <span class="p">&amp;</span>             <span class="p">(</span><span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">+</span><span class="n">rhopcc</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">rnsd</span>
              <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
           <span class="n">enddo</span>
<span class="c">!$OMP end do</span>
        <span class="k">else</span>
<span class="c">!$OMP do</span>
           <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
              <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">*</span> <span class="n">rnsd</span>
              <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">Vscf</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">Vaux</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
           <span class="n">enddo</span>
<span class="c">!$OMP end do</span>
        <span class="n">endif</span>
      <span class="n">enddo</span>
<span class="c">!$OMP end parallel</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="n">stress</span> <span class="o">=</span> <span class="n">stress</span> <span class="o">+</span> <span class="n">stressXC</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Save total potential</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef NCDF_4</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Vt&#39;</span><span class="p">,</span><span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vscf</span><span class="p">)</span>
        <span class="k">else </span>
<span class="k">           call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>          <span class="n">Vscf</span> <span class="p">)</span>
           <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> 
     <span class="p">&amp;</span>          <span class="s2">&quot;TotalPotential&quot;</span><span class="p">)</span>
        <span class="k">end if</span>
<span class="cp">#else</span>
        <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">)</span>
        <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>       <span class="n">Vscf</span><span class="p">,</span> <span class="s2">&quot;TotalPotential&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">endif</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Print vacuum level</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span><span class="o">/=</span><span class="s1">&#39; &#39;</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span><span class="o">/=</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        forall</span><span class="p">(</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nsd</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">+</span> <span class="n">rhoatm</span><span class="p">(:)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="k">call </span><span class="n">vacuum_level</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> 
     <span class="p">.</span>                     <span class="n">np_vac</span><span class="p">,</span> <span class="n">Vmax_vac</span><span class="p">,</span> <span class="n">Vmean_vac</span> <span class="p">)</span>
        <span class="k">forall</span><span class="p">(</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nsd</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhoatm</span><span class="p">(:)</span> <span class="o">*</span> <span class="n">rnsd</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np_vac</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="n">Node</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">print</span><span class="s1">&#39;(/,a,2f12.6,a)&#39;</span><span class="p">,</span> 
     <span class="p">.</span>    <span class="s1">&#39;dhscf: Vacuum level (max, mean) =&#39;</span><span class="p">,</span> 
     <span class="p">.</span>    <span class="n">Vmax_vac</span><span class="o">/</span><span class="n">eV</span><span class="p">,</span> <span class="n">Vmean_vac</span><span class="o">/</span><span class="n">eV</span><span class="p">,</span> <span class="s1">&#39; eV&#39;</span>
      <span class="n">endif</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span> <span class="o">/=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">save_ebs_density</span><span class="p">()</span>
      <span class="n">endif</span>
      
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Find SCF contribution to hamiltonian matrix elements</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">iHmat</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                         <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
         <span class="n">endif</span>

<span class="c">!        This is a work array, to which we copy Vscf</span>
         <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

         <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
           <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
           <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                        <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
         <span class="n">enddo</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">Spiral</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">vmatsp</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">qspiral</span> <span class="p">)</span>
         <span class="k">else</span>
<span class="k">            call </span><span class="n">vmat</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">spin</span><span class="p">,</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Hmat</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span>
     <span class="p">&amp;</span>           <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>
         <span class="n">endif</span>

         <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span>  <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!          Everything back to UNIFORM, sequential</span>
           <span class="k">call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                         <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
         <span class="n">endif</span>
      <span class="n">endif</span>


<span class="cp">#ifdef MPI</span>
<span class="c">!     Global reduction of Uscf/DUscf/Uatm/Enaatm/Enascf</span>
<span class="cp">#ifndef BSC_CELLXC</span>
<span class="c">!     Note that Exc and Dxc are already reduced in the new cellxc</span>
<span class="cp">#endif /* ! BSC_CELLXC */</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uscf</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DUscf</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uatm</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Enaatm</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Enascf</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Exc</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">Dxc</span>
<span class="cp">#else</span>
      <span class="n">sbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0._dp</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">call </span><span class="n">MPI_AllReduce</span><span class="p">(</span> <span class="n">sbuffer</span><span class="p">,</span> <span class="n">rbuffer</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">MPI_double_precision</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">MPI_Sum</span><span class="p">,</span> <span class="n">MPI_Comm_World</span><span class="p">,</span> <span class="n">MPIerror</span> <span class="p">)</span>
      <span class="n">Uscf</span>   <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">DUscf</span>  <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">Uatm</span>   <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">Enaatm</span> <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
      <span class="n">Enascf</span> <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="n">Exc</span>    <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
      <span class="n">Dxc</span>    <span class="o">=</span> <span class="n">rbuffer</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
<span class="cp">#endif /* MPI */</span>

<span class="c">!     Add contribution to stress from the derivative of the Jacobian of ---</span>
<span class="c">!     r-&gt;r&#39; (strained r) in the integral of Vna*(rhoscf-rhoatm)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">istr</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
          <span class="n">stress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">stress</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">Enascf</span> <span class="o">-</span> <span class="n">Enaatm</span> <span class="p">)</span> <span class="o">/</span> <span class="n">volume</span>
        <span class="n">enddo</span>
      <span class="n">endif</span>

<span class="c">!     Stop time counter for SCF iteration part</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF3&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     End of SCF iteration part</span>
<span class="c">! ----------------------------------------------------------------------</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">ifa</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">istr</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">! Forces and stress : SCF contribution</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!       Start time counter for force calculation part</span>
        <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF4&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>

<span class="c">!       Find contribution of partial-core-correction</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">npcc</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">reord</span><span class="p">(</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="c">! The partial core calculation only acts on</span>
          <span class="c">! the diagonal spin-components (no need to</span>
          <span class="c">! redistribute un-used elements)</span>
          <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
            <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span>
     <span class="p">&amp;</span>                  <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
          <span class="n">enddo</span>

          <span class="k">call </span><span class="n">PartialCoreOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">nsd</span><span class="p">,</span>
     <span class="p">&amp;</span>                            <span class="n">dvol</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span>
     <span class="p">&amp;</span>                            <span class="n">stressl</span><span class="p">,</span> <span class="n">ifa</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">istr</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span> <span class="p">)</span>
   
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="c">! ** see above</span>
          <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsd</span>
            <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">),</span>
     <span class="p">&amp;</span>                  <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
          <span class="n">enddo</span>

          <span class="k">if</span> <span class="p">(</span> <span class="n">debug_dhscf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">             write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="n">debug_fmt</span><span class="p">)</span> <span class="n">Node</span><span class="p">,</span><span class="s1">&#39;PartialCore&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>            <span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">ispin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsd</span><span class="p">)</span>
          <span class="k">end if</span>
<span class="k">        </span><span class="n">endif</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">harrisfun</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!         Forhar deals internally with its own needs</span>
<span class="c">!         for distribution changes</span>
<span class="cp">#ifndef BSC_CELLXC</span>
          <span class="k">call </span><span class="n">forhar</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">npcc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> 
<span class="cp">#else /* BSC_CELLXC */</span>
          <span class="k">call </span><span class="n">forhar</span><span class="p">(</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">npcc</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> 
<span class="cp">#endif /* BSC_CELLXC */</span>
     <span class="p">&amp;</span>                 <span class="n">rhoatm</span><span class="p">,</span> <span class="n">rhopcc</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Vscf</span><span class="p">,</span> <span class="n">Vaux</span> <span class="p">)</span>
<span class="c">!         Upon return, everything is UNIFORM, sequential form</span>
        <span class="n">endif</span>

<span class="c">!     Transform spin density into sum and difference</span>
        <span class="c">! TODO NC/SO</span>
        <span class="c">! Should we perform local diagonalization?</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nsd</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<span class="c">!$OMP parallel do default(shared), private(rhotot,ip)</span>
          <span class="k">do </span><span class="n">ip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ntpl</span>
            <span class="n">rhotot</span>     <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">DRho</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">rhotot</span>
          <span class="n">enddo</span>
<span class="c">!$OMP end parallel do</span>
        <span class="n">endif</span>

<span class="c">!       Find contribution of neutral-atom potential</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">NeutralAtomOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> 
     <span class="p">&amp;</span>                          <span class="n">volume</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span><span class="p">,</span> 
     <span class="p">&amp;</span>                          <span class="n">ifa</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span> <span class="n">istr</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">DRho</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">Vna</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">           call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>

        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Vscf</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Vscf_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>                       <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>
        <span class="n">enddo</span>

<span class="c">!       Remember that Vaux contains everything except Vxc</span>
        <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="s1">&#39;Vaux_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">Vaux</span><span class="p">,</span>
     <span class="p">&amp;</span>                     <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">TO_CLUSTER</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">dfscf</span><span class="p">(</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>              <span class="n">indxua</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> 
     <span class="p">&amp;</span>              <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span>
     <span class="p">&amp;</span>              <span class="n">Vscf_par</span><span class="p">,</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="n">dvol</span><span class="p">,</span> <span class="n">volume</span><span class="p">,</span> <span class="n">Fal</span><span class="p">,</span> <span class="n">stressl</span> <span class="p">)</span>

        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vaux_par</span><span class="p">,</span> <span class="s1">&#39;Vaux_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
        <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf_par</span><span class="p">,</span> <span class="s1">&#39;Vscf_par&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
        <span class="n">endif</span>


<span class="c">!       Stop time counter for force calculation part</span>
        <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF4&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!       End of force and stress calculation</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="n">endif</span>

<span class="c">!     We are in the UNIFORM distribution</span>
<span class="c">!     Rhoatm, Rhopcc and Vna are in UNIFORM dist, sequential form</span>
<span class="c">!     The index array endpht is in the QUADRATIC distribution</span>

<span class="c">!     Stop time counter</span>
      <span class="k">call </span><span class="n">timer</span><span class="p">(</span> <span class="s1">&#39;DHSCF&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>

<span class="c">! ----------------------------------------------------------------------</span>
<span class="c">!     Free locally allocated memory</span>
<span class="c">! ----------------------------------------------------------------------</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vaux</span><span class="p">,</span> <span class="s1">&#39;Vaux&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Vscf</span><span class="p">,</span> <span class="s1">&#39;Vscf&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">DRho</span><span class="p">,</span> <span class="s1">&#39;DRho&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

<span class="cp">#ifdef DEBUG</span>
      <span class="k">call </span><span class="n">write_debug</span><span class="p">(</span> <span class="s1">&#39;    POS DHSCF&#39;</span> <span class="p">)</span>
<span class="cp">#endif</span>
<span class="c">!------------------------------------------------------------------------ END</span>
      <span class="k">CONTAINS</span>

<span class="k">      subroutine </span><span class="n">save_bader_charge</span><span class="p">()</span>
      <span class="k">use </span><span class="n">meshsubs</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ModelCoreChargeOnMesh</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">write_cdf</span>
      <span class="k">use </span><span class="n">m_ncdf_siesta</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">cdf_save_grid</span>
<span class="cp">#endif</span>
      <span class="c">! Auxiliary routine to output the Bader Charge</span>
      <span class="c">!</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">BaderCharge</span><span class="p">(:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BaderCharge&#39;</span><span class="p">,</span>
     <span class="p">&amp;</span>                 <span class="n">routine</span><span class="o">=</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="c">! Find a model core charge by re-scaling the local charge</span>
      <span class="k">call </span><span class="n">ModelCoreChargeOnMesh</span><span class="p">(</span> <span class="n">na</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">indxua</span> <span class="p">)</span>
      <span class="c">! It comes out in clustered form, so we convert it</span>
      <span class="k">call </span><span class="n">reord</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span><span class="p">)</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsd</span>
         <span class="n">BaderCharge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">)</span> <span class="o">=</span> <span class="n">BaderCharge</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">)</span> <span class="o">+</span> <span class="n">DRho</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">ntpl</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
      <span class="n">enddo</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;RhoBader&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">BaderCharge</span><span class="p">)</span>
      <span class="k">else</span>
<span class="k">         call </span><span class="n">write_rho</span><span class="p">(</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BaderCharge</span> <span class="p">)</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">BaderCharge</span><span class="p">,</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">)</span>
      <span class="k">end if</span>
<span class="cp">#else</span>
      <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span> <span class="s2">&quot;.BADER&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BaderCharge</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">BaderCharge</span><span class="p">,</span> <span class="s2">&quot;BaderCharge&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>

      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">BaderCharge</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BaderCharge&#39;</span> <span class="p">)</span>
      <span class="k">end subroutine </span><span class="n">save_bader_charge</span>

      <span class="k">subroutine </span><span class="n">setup_analysis_options</span><span class="p">()</span>
      <span class="c">!! For the analyze-charge-density-only case,</span>
      <span class="c">!! avoiding any diagonalization</span>

      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">hirshpop</span><span class="p">,</span> <span class="n">voropop</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">saverho</span><span class="p">,</span> <span class="n">savedrho</span><span class="p">,</span> <span class="n">saverhoxc</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savevh</span><span class="p">,</span> <span class="n">savevt</span><span class="p">,</span> <span class="n">savevna</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">savepsch</span><span class="p">,</span> <span class="n">savetoch</span>

      <span class="n">want_partial_charges</span> <span class="o">=</span> <span class="p">(</span><span class="n">hirshpop</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">voropop</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">saverho</span><span class="p">)</span>   <span class="n">filesOut</span><span class="p">%</span><span class="n">rho</span>   <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.RHO&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savedrho</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">drho</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.DRHO&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">saverhoxc</span><span class="p">)</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">rhoxc</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.RHOXC&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevh</span><span class="p">)</span>    <span class="n">filesOut</span><span class="p">%</span><span class="n">vh</span>    <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VH&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevt</span><span class="p">)</span>    <span class="n">filesOut</span><span class="p">%</span><span class="n">vt</span>    <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VT&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savevna</span><span class="p">)</span>   <span class="n">filesOut</span><span class="p">%</span><span class="n">vna</span>   <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.VNA&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savepsch</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">psch</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.IOCH&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">savetoch</span><span class="p">)</span>  <span class="n">filesOut</span><span class="p">%</span><span class="n">toch</span>  <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.TOCH&#39;</span>

      <span class="k">end subroutine </span><span class="n">setup_analysis_options</span>

      <span class="k">subroutine </span><span class="n">save_ebs_density</span><span class="p">()</span>
<span class="c">!! Optional output of the &quot;band-structure energy density&quot;, which</span>
<span class="c">!! is just the charge density weighted by the eigenvalues, i.e.,</span>
<span class="c">!! using EDM instead of DM in rhoofd</span>

      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">Escf</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">Ebs_dens</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">(),</span>
     <span class="p">&amp;</span>                         <span class="n">Ebs_dens_quad</span><span class="p">(:,:)</span> <span class="o">=&gt;</span> <span class="nb">null</span><span class="p">()</span>

<span class="c">!     Allocate memory for Ebs_dens using the UNIFORM data distribution</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">Ebs_dens</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span><span class="p">)</span>

<span class="c">!     Switch to quadratic distribution for call to rhoofd</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">ebs_dens_quad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="s1">&#39;Ebs_dens_quad&#39;</span><span class="p">,</span> <span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">rhoofd</span><span class="p">(</span> <span class="n">norb</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">maxnd</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">listdptr</span><span class="p">,</span> <span class="n">listd</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">nspin</span><span class="p">,</span> <span class="n">Escf</span><span class="p">,</span> <span class="n">Ebs_dens_quad</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">nuo</span><span class="p">,</span> <span class="n">nuotot</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">isa</span> <span class="p">)</span>

<span class="c">!     Ebs_dens_par is here in QUADRATIC, clustered form</span>

<span class="c">!     Set the UNIFORM distribution again and copy Ebs_dens to it</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
      <span class="n">endif</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span>
         <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">Ebs_dens_quad</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">Ebs_dens</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="c">! Sequential to be able to write it out</span>
         <span class="c">! if nodes==1, this call will just reorder</span>
         <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">QUADRATIC</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">TO_SEQUENTIAL</span> <span class="p">)</span>
      <span class="n">enddo</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Ebs_dens_quad</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens_quad&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>
<span class="cp">#ifdef NCDF_4</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">write_cdf</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">cdf_save_grid</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">slabel</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="s1">&#39;Ebs_density&#39;</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">nspin</span><span class="p">,</span><span class="n">ntml</span><span class="p">,</span> <span class="n">Ebs_dens</span><span class="p">)</span>
      <span class="k">else</span>
<span class="k">         call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span><span class="p">,</span>
     <span class="err">$</span>        <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">Ebs_dens</span> <span class="p">)</span>
         <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">Ebs_dens</span><span class="p">,</span>
     <span class="p">&amp;</span>        <span class="s2">&quot;Ebs_density&quot;</span><span class="p">)</span>
      <span class="k">end if</span>
<span class="cp">#else</span>
      <span class="k">call </span><span class="n">write_rho</span><span class="p">(</span> <span class="n">filesOut</span><span class="p">%</span><span class="n">ebs_dens</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="err">$</span>     <span class="n">Ebs_dens</span><span class="p">)</span>
      <span class="k">call </span><span class="n">write_grid_netcdf</span><span class="p">(</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ntm</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span>
     <span class="p">&amp;</span>     <span class="n">Ebs_dens</span><span class="p">,</span> <span class="s2">&quot;Ebs_density&quot;</span><span class="p">)</span>
<span class="cp">#endif</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">Ebs_dens</span><span class="p">,</span> <span class="s1">&#39;Ebs_dens&#39;</span><span class="p">,</span><span class="s1">&#39;dhscf&#39;</span> <span class="p">)</span>

      <span class="k">end subroutine </span><span class="n">save_ebs_density</span>

      <span class="k">end subroutine </span><span class="n">dhscf</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> SIESTA was developed by SIESTA Group</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>