<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A first-principles materials simulation code using Density Functional Theory.">
    
    <meta name="author" content="SIESTA Group" >
    <link rel="icon" href="../favicon.png">

    <title>compute_energies &ndash; SIESTA</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">SIESTA <small>trunk-700--vdikan-edens-711-ford-681</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Program Overview</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>compute_energies
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 1.8% of total for procedures.">172 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/compute_energies.F90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/compute_energies.f90.html'>compute_energies.F90</a></li>
    
     <li><a href='../module/m_compute_energies.html'>m_compute_energies</a></li>
    
  
     <li class="active">compute_energies</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/compute_energies.html#src">compute_energies</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine compute_energies(iscf)
    
    
   
</h2>
    
  
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Uses</h3>
      </div>
      <ul class="list-group">
      
      <li class="list-group-item">
  <ul class="list-inline">
    
    <li><a href='../module/precision.html'>precision</a></li>
    
    <li>fdf</li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li><a href='../module/siesta_options.html'>siesta_options</a></li>
    
    <li>sparse_matrices</li>
    
    <li>sparse_matrices</li>
    
    <li>sparse_matrices</li>
    
    <li><a href='../module/m_dhscf.html'>m_dhscf</a></li>
    
    <li>m_energies</li>
    
    <li>atomlist</li>
    
    <li>m_ntm</li>
    
    <li>m_spin</li>
    
    <li><a href='../module/parallel.html'>parallel</a></li>
    
    <li>m_dipol</li>
    
    <li>siesta_geom</li>
    
    <li><a href='../module/m_rhog.html'>m_rhog</a></li>
    
  </ul>
      </li>
      
      
      
      <li class="list-group-item">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~compute_energies~~UsesGraph Pages: 1 -->
<svg id="proccompute_energiesUsesGraph" width="419pt" height="529pt"
 viewBox="0.00 0.00 419.00 529.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~compute_energies~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 525)">
<title>proc~~compute_energies~~UsesGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-525 415,-525 415,4 -4,4"/>
<!-- proc~compute_energies -->
<g id="proc~~compute_energies~~UsesGraph_node1" class="node"><title>proc~compute_energies</title>
<polygon fill="none" stroke="black" points="411,-272 310,-272 310,-248 411,-248 411,-272"/>
<text text-anchor="middle" x="360.5" y="-257.6" font-family="Helvetica,sans-Serif" font-size="10.50">compute_energies</text>
</g>
<!-- module~m_dhscf -->
<g id="proc~~compute_energies~~UsesGraph_node2" class="node"><title>module~m_dhscf</title>
<g id="a_proc~~compute_energies~~UsesGraph_node2"><a xlink:href=".././module/m_dhscf.html" xlink:title="m_dhscf">
<polygon fill="#337ab7" stroke="#337ab7" points="255.5,-520 201.5,-520 201.5,-496 255.5,-496 255.5,-520"/>
<text text-anchor="middle" x="228.5" y="-505.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_dhscf</text>
</a>
</g>
</g>
<!-- proc~compute_energies&#45;&gt;module~m_dhscf -->
<g id="proc~~compute_energies~~UsesGraph_edge8" class="edge"><title>proc~compute_energies&#45;&gt;module~m_dhscf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M357.737,-272.014C351.933,-307.85 330.462,-415.619 274,-482 271.196,-485.297 267.862,-488.277 264.3,-490.941"/>
<polygon fill="#000000" stroke="#000000" points="262.146,-488.168 255.712,-496.586 265.991,-494.017 262.146,-488.168"/>
</g>
<!-- module~precision -->
<g id="proc~~compute_energies~~UsesGraph_node3" class="node"><title>module~precision</title>
<g id="a_proc~~compute_energies~~UsesGraph_node3"><a xlink:href=".././module/precision.html" xlink:title="precision">
<polygon fill="#337ab7" stroke="#337ab7" points="101,-479 46,-479 46,-455 101,-455 101,-479"/>
<text text-anchor="middle" x="73.5" y="-464.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">precision</text>
</a>
</g>
</g>
<!-- proc~compute_energies&#45;&gt;module~precision -->
<g id="proc~~compute_energies~~UsesGraph_edge2" class="edge"><title>proc~compute_energies&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M358.116,-272.363C353.514,-307.015 335.348,-405.39 274,-449 226.081,-483.064 154.447,-479.987 111.319,-473.968"/>
<polygon fill="#000000" stroke="#000000" points="111.674,-470.482 101.261,-472.438 110.621,-477.402 111.674,-470.482"/>
</g>
<!-- module~siesta_options -->
<g id="proc~~compute_energies~~UsesGraph_node4" class="node"><title>module~siesta_options</title>
<g id="a_proc~~compute_energies~~UsesGraph_node4"><a xlink:href=".././module/siesta_options.html" xlink:title="siesta_options">
<polygon fill="#337ab7" stroke="#337ab7" points="269,-440 188,-440 188,-416 269,-416 269,-440"/>
<text text-anchor="middle" x="228.5" y="-425.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_options</text>
</a>
</g>
</g>
<!-- proc~compute_energies&#45;&gt;module~siesta_options -->
<g id="proc~~compute_energies~~UsesGraph_edge3" class="edge"><title>proc~compute_energies&#45;&gt;module~siesta_options</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M355.262,-272.294C345.219,-299.812 317.507,-367.078 274,-407 272.745,-408.152 271.416,-409.251 270.031,-410.3"/>
<polygon fill="#000000" stroke="#000000" points="268.11,-407.374 261.631,-415.757 271.923,-413.244 268.11,-407.374"/>
</g>
<!-- siesta_geom -->
<g id="proc~~compute_energies~~UsesGraph_node5" class="node"><title>siesta_geom</title>
<polygon fill="#337ab7" stroke="#337ab7" points="265,-398 192,-398 192,-374 265,-374 265,-398"/>
<text text-anchor="middle" x="228.5" y="-383.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_geom</text>
</g>
<!-- proc~compute_energies&#45;&gt;siesta_geom -->
<g id="proc~~compute_energies~~UsesGraph_edge5" class="edge"><title>proc~compute_energies&#45;&gt;siesta_geom</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M352.185,-272.184C338.916,-293.433 308.986,-337.613 274,-365 272.251,-366.369 270.398,-367.677 268.481,-368.921"/>
<polygon fill="#000000" stroke="#000000" points="266.675,-365.922 259.782,-373.968 270.188,-371.977 266.675,-365.922"/>
</g>
<!-- fdf -->
<g id="proc~~compute_energies~~UsesGraph_node6" class="node"><title>fdf</title>
<polygon fill="#337ab7" stroke="#337ab7" points="255.5,-356 201.5,-356 201.5,-332 255.5,-332 255.5,-356"/>
<text text-anchor="middle" x="228.5" y="-341.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">fdf</text>
</g>
<!-- proc~compute_energies&#45;&gt;fdf -->
<g id="proc~~compute_energies~~UsesGraph_edge4" class="edge"><title>proc~compute_energies&#45;&gt;fdf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M344.974,-272.07C328.431,-285.483 300.284,-307.317 274,-323 271.139,-324.707 268.117,-326.382 265.049,-327.993"/>
<polygon fill="#000000" stroke="#000000" points="263.199,-325.005 255.825,-332.613 266.333,-331.265 263.199,-325.005"/>
</g>
<!-- sparse_matrices -->
<g id="proc~~compute_energies~~UsesGraph_node7" class="node"><title>sparse_matrices</title>
<polygon fill="#337ab7" stroke="#337ab7" points="274,-314 183,-314 183,-290 274,-290 274,-314"/>
<text text-anchor="middle" x="228.5" y="-299.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">sparse_matrices</text>
</g>
<!-- proc~compute_energies&#45;&gt;sparse_matrices -->
<g id="proc~~compute_energies~~UsesGraph_edge6" class="edge"><title>proc~compute_energies&#45;&gt;sparse_matrices</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M322.247,-272.036C307.968,-276.649 291.49,-281.972 276.42,-286.841"/>
<polygon fill="#000000" stroke="#000000" points="275.198,-283.558 266.758,-289.963 277.35,-290.219 275.198,-283.558"/>
</g>
<!-- atomlist -->
<g id="proc~~compute_energies~~UsesGraph_node8" class="node"><title>atomlist</title>
<polygon fill="#337ab7" stroke="#337ab7" points="255.5,-272 201.5,-272 201.5,-248 255.5,-248 255.5,-272"/>
<text text-anchor="middle" x="228.5" y="-257.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">atomlist</text>
</g>
<!-- proc~compute_energies&#45;&gt;atomlist -->
<g id="proc~~compute_energies~~UsesGraph_edge7" class="edge"><title>proc~compute_energies&#45;&gt;atomlist</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M309.982,-260C295.23,-260 279.348,-260 265.622,-260"/>
<polygon fill="#000000" stroke="#000000" points="265.601,-256.5 255.601,-260 265.601,-263.5 265.601,-256.5"/>
</g>
<!-- module~parallel -->
<g id="proc~~compute_energies~~UsesGraph_node9" class="node"><title>module~parallel</title>
<g id="a_proc~~compute_energies~~UsesGraph_node9"><a xlink:href=".././module/parallel.html" xlink:title="parallel">
<polygon fill="#337ab7" stroke="#337ab7" points="255.5,-230 201.5,-230 201.5,-206 255.5,-206 255.5,-230"/>
<text text-anchor="middle" x="228.5" y="-215.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">parallel</text>
</a>
</g>
</g>
<!-- proc~compute_energies&#45;&gt;module~parallel -->
<g id="proc~~compute_energies~~UsesGraph_edge1" class="edge"><title>proc~compute_energies&#45;&gt;module~parallel</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M322.247,-247.964C304.435,-242.21 283.2,-235.349 265.547,-229.646"/>
<polygon fill="#000000" stroke="#000000" points="266.211,-226.182 255.619,-226.439 264.059,-232.843 266.211,-226.182"/>
</g>
<!-- m_energies -->
<g id="proc~~compute_energies~~UsesGraph_node10" class="node"><title>m_energies</title>
<polygon fill="#337ab7" stroke="#337ab7" points="263,-188 194,-188 194,-164 263,-164 263,-188"/>
<text text-anchor="middle" x="228.5" y="-173.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_energies</text>
</g>
<!-- proc~compute_energies&#45;&gt;m_energies -->
<g id="proc~~compute_energies~~UsesGraph_edge9" class="edge"><title>proc~compute_energies&#45;&gt;m_energies</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M344.974,-247.93C328.431,-234.517 300.284,-212.683 274,-197 271.524,-195.523 268.928,-194.07 266.285,-192.661"/>
<polygon fill="#000000" stroke="#000000" points="267.735,-189.472 257.234,-188.067 264.567,-195.714 267.735,-189.472"/>
</g>
<!-- module~m_rhog -->
<g id="proc~~compute_energies~~UsesGraph_node11" class="node"><title>module~m_rhog</title>
<g id="a_proc~~compute_energies~~UsesGraph_node11"><a xlink:href=".././module/m_rhog.html" xlink:title="m_rhog">
<polygon fill="#337ab7" stroke="#337ab7" points="255.5,-146 201.5,-146 201.5,-122 255.5,-122 255.5,-146"/>
<text text-anchor="middle" x="228.5" y="-131.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_rhog</text>
</a>
</g>
</g>
<!-- proc~compute_energies&#45;&gt;module~m_rhog -->
<g id="proc~~compute_energies~~UsesGraph_edge10" class="edge"><title>proc~compute_energies&#45;&gt;module~m_rhog</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M352.185,-247.816C338.916,-226.567 308.986,-182.387 274,-155 271.07,-152.706 267.848,-150.585 264.519,-148.644"/>
<polygon fill="#000000" stroke="#000000" points="266.061,-145.5 255.583,-143.932 262.796,-151.692 266.061,-145.5"/>
</g>
<!-- m_dipol -->
<g id="proc~~compute_energies~~UsesGraph_node12" class="node"><title>m_dipol</title>
<polygon fill="#337ab7" stroke="#337ab7" points="255.5,-104 201.5,-104 201.5,-80 255.5,-80 255.5,-104"/>
<text text-anchor="middle" x="228.5" y="-89.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_dipol</text>
</g>
<!-- proc~compute_energies&#45;&gt;m_dipol -->
<g id="proc~~compute_energies~~UsesGraph_edge11" class="edge"><title>proc~compute_energies&#45;&gt;m_dipol</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M355.262,-247.706C345.219,-220.188 317.507,-152.922 274,-113 271.191,-110.423 268.009,-108.106 264.67,-106.037"/>
<polygon fill="#000000" stroke="#000000" points="266.071,-102.815 255.61,-101.13 262.737,-108.97 266.071,-102.815"/>
</g>
<!-- m_spin -->
<g id="proc~~compute_energies~~UsesGraph_node13" class="node"><title>m_spin</title>
<polygon fill="#337ab7" stroke="#337ab7" points="100.5,-64 46.5,-64 46.5,-40 100.5,-40 100.5,-64"/>
<text text-anchor="middle" x="73.5" y="-49.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_spin</text>
</g>
<!-- proc~compute_energies&#45;&gt;m_spin -->
<g id="proc~~compute_energies~~UsesGraph_edge12" class="edge"><title>proc~compute_energies&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M358.105,-247.653C353.474,-213.041 335.24,-114.762 274,-71 225.882,-36.6148 153.706,-39.5162 110.636,-45.3478"/>
<polygon fill="#000000" stroke="#000000" points="109.986,-41.9058 100.605,-46.8308 111.01,-48.8305 109.986,-41.9058"/>
</g>
<!-- m_ntm -->
<g id="proc~~compute_energies~~UsesGraph_node14" class="node"><title>m_ntm</title>
<polygon fill="#337ab7" stroke="#337ab7" points="255.5,-24 201.5,-24 201.5,-0 255.5,-0 255.5,-24"/>
<text text-anchor="middle" x="228.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_ntm</text>
</g>
<!-- proc~compute_energies&#45;&gt;m_ntm -->
<g id="proc~~compute_energies~~UsesGraph_edge13" class="edge"><title>proc~compute_energies&#45;&gt;m_ntm</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M357.737,-247.986C351.933,-212.15 330.462,-104.381 274,-38 271.196,-34.7029 267.862,-31.7235 264.3,-29.0594"/>
<polygon fill="#000000" stroke="#000000" points="265.991,-25.983 255.712,-23.4144 262.146,-31.8323 265.991,-25.983"/>
</g>
<!-- module~m_dhscf&#45;&gt;module~precision -->
<g id="proc~~compute_energies~~UsesGraph_edge14" class="edge"><title>module~m_dhscf&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M201.198,-500.952C176.315,-494.284 138.747,-484.216 110.975,-476.774"/>
<polygon fill="#000000" stroke="#000000" points="111.793,-473.37 101.228,-474.162 109.981,-480.132 111.793,-473.37"/>
</g>
<!-- module~m_dfscf -->
<g id="proc~~compute_energies~~UsesGraph_node17" class="node"><title>module~m_dfscf</title>
<g id="a_proc~~compute_energies~~UsesGraph_node17"><a xlink:href=".././module/m_dfscf.html" xlink:title="m_dfscf">
<polygon fill="#337ab7" stroke="#337ab7" points="100.5,-521 46.5,-521 46.5,-497 100.5,-497 100.5,-521"/>
<text text-anchor="middle" x="73.5" y="-506.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">m_dfscf</text>
</a>
</g>
</g>
<!-- module~m_dhscf&#45;&gt;module~m_dfscf -->
<g id="proc~~compute_energies~~UsesGraph_edge15" class="edge"><title>module~m_dhscf&#45;&gt;module~m_dfscf</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M201.198,-508.172C176.273,-508.335 138.619,-508.581 110.833,-508.763"/>
<polygon fill="#000000" stroke="#000000" points="110.691,-505.263 100.714,-508.829 110.737,-512.263 110.691,-505.263"/>
</g>
<!-- module~m_rhog&#45;&gt;module~precision -->
<g id="proc~~compute_energies~~UsesGraph_edge16" class="edge"><title>module~m_rhog&#45;&gt;module~precision</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M201.19,-142.255C194.545,-145.374 187.912,-149.537 183,-155 104.624,-242.179 82.2347,-389.066 76.394,-444.721"/>
<polygon fill="#000000" stroke="#000000" points="72.8909,-444.584 75.4095,-454.876 79.8582,-445.26 72.8909,-444.584"/>
</g>
<!-- module~m_rhog&#45;&gt;m_spin -->
<g id="proc~~compute_energies~~UsesGraph_edge18" class="edge"><title>module~m_rhog&#45;&gt;m_spin</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M201.097,-123.654C194.886,-120.659 188.484,-117.078 183,-113 163.808,-98.727 167.265,-85.7039 147,-73 136.071,-66.1484 122.827,-61.461 110.664,-58.2865"/>
<polygon fill="#000000" stroke="#000000" points="111.313,-54.8435 100.777,-55.9614 109.71,-61.6576 111.313,-54.8435"/>
</g>
<!-- class_Fstack_Pair_dData1D -->
<g id="proc~~compute_energies~~UsesGraph_node15" class="node"><title>class_Fstack_Pair_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="147,-190 0,-190 0,-166 147,-166 147,-190"/>
<text text-anchor="middle" x="73.5" y="-175.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_Fstack_Pair_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_Fstack_Pair_dData1D -->
<g id="proc~~compute_energies~~UsesGraph_edge19" class="edge"><title>module~m_rhog&#45;&gt;class_Fstack_Pair_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M201.198,-141.564C180.607,-147.486 151.328,-155.906 126.102,-163.16"/>
<polygon fill="#000000" stroke="#000000" points="124.944,-159.851 116.301,-165.979 126.879,-166.579 124.944,-159.851"/>
</g>
<!-- class_dData1D -->
<g id="proc~~compute_energies~~UsesGraph_node16" class="node"><title>class_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="116,-148 31,-148 31,-124 116,-124 116,-148"/>
<text text-anchor="middle" x="73.5" y="-133.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_dData1D -->
<g id="proc~~compute_energies~~UsesGraph_edge20" class="edge"><title>module~m_rhog&#45;&gt;class_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M201.198,-134.344C180.623,-134.613 151.373,-134.995 126.161,-135.325"/>
<polygon fill="#000000" stroke="#000000" points="125.957,-131.827 116.003,-135.457 126.048,-138.826 125.957,-131.827"/>
</g>
<!-- class_Pair_dData1D -->
<g id="proc~~compute_energies~~UsesGraph_node18" class="node"><title>class_Pair_dData1D</title>
<polygon fill="#337ab7" stroke="#337ab7" points="128,-106 19,-106 19,-82 128,-82 128,-106"/>
<text text-anchor="middle" x="73.5" y="-91.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">class_Pair_dData1D</text>
</g>
<!-- module~m_rhog&#45;&gt;class_Pair_dData1D -->
<g id="proc~~compute_energies~~UsesGraph_edge17" class="edge"><title>module~m_rhog&#45;&gt;class_Pair_dData1D</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M201.198,-127.124C181.749,-122.039 154.55,-114.928 130.336,-108.598"/>
<polygon fill="#000000" stroke="#000000" points="131.086,-105.176 120.526,-106.033 129.315,-111.949 131.086,-105.176"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="490pt" height="32pt"
 viewBox="0.00 0.00 489.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 485.5,-28 485.5,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node"><title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24 0,-24 0,-0 54,-0 54,-24"/>
<text text-anchor="middle" x="27" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node"><title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="139.5,-24 72.5,-24 72.5,-0 139.5,-0 139.5,-24"/>
<text text-anchor="middle" x="106" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="222,-24 158,-24 158,-0 222,-0 222,-24"/>
<text text-anchor="middle" x="190" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="294,-24 240,-24 240,-0 294,-0 294,-24"/>
<text text-anchor="middle" x="267" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="366,-24 312,-24 312,-0 366,-0 366,-24"/>
<text text-anchor="middle" x="339" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="481.5,-24 384.5,-24 384.5,-0 481.5,-0 481.5,-24"/>
<text text-anchor="middle" x="433" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a submodule to the (sub)module which it is
    descended from. Dashed arrows point from a module or program unit to 
    modules which it uses.
    </p>
    </div></div></div></div>
      </li>
      
      </ul>
    </div>
    


    
    <p>This routine computes the Harris energy from E_KS(DM_in):</p>
<p></p><div class="alert alert-success" role="alert"><h4>Todo</h4><p>Edit formulas
</p></div>
<p>
<div class="codehilite"><pre><span></span>E_Harris = E_KS(DM_in) + Tr[H_in*(DM_out-DM_in)]
</pre></div>


<p>and possibly E_KS(DM_out) as</p>
<div class="codehilite"><pre><span></span>E_KS(DM_out) = Tr[H_in*DM_out] + E_HXC(DM_out)
</pre></div>


<p>Note that E_KS(DM_in), as computed in setup_hamiltonian, is not
 variational if mixing the DM, as the kinetic energy term is
 using a DM (DM_in) which is not derived from wave-functions. It
 is also not consistent if we are using the charge density as
 primary variable for mixing. In this case the Enl and Ekin parts
 are computed with the previous step's DM, whereas the "scf" part
 comes from the (mixed) rho.</p>
<p>E_KS(DM_out) computed in setup_hamiltonian with DM_out is
 variational. Rather than calling again setup_hamiltonian, it is
 enough to compute the "scf" part of the energy by calling dhscf
 with DM_out.</p>
<p>The routine checks the mixing type and proceeds accordingly</p>
    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-iscf%7E4"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>iscf</strong></td><td></td>
  
</tr>

</tbody>
</table>

    
    
    
    <br>
    
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Calls</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~compute_energies~~CallsGraph Pages: 1 -->
<svg id="proccompute_energiesCallsGraph" width="221pt" height="158pt"
 viewBox="0.00 0.00 221.00 158.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~compute_energies~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 154)">
<title>proc~~compute_energies~~CallsGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-154 217,-154 217,4 -4,4"/>
<!-- proc~compute_energies -->
<g id="proc~~compute_energies~~CallsGraph_node1" class="node"><title>proc~compute_energies</title>
<polygon fill="none" stroke="black" points="101,-87 0,-87 0,-63 101,-63 101,-87"/>
<text text-anchor="middle" x="50.5" y="-72.6" font-family="Helvetica,sans-Serif" font-size="10.50">compute_energies</text>
</g>
<!-- update_freee -->
<g id="proc~~compute_energies~~CallsGraph_node2" class="node"><title>update_freee</title>
<polygon fill="#777777" stroke="#777777" points="213,-150 137,-150 137,-126 213,-126 213,-150"/>
<text text-anchor="middle" x="175" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">update_freee</text>
</g>
<!-- proc~compute_energies&#45;&gt;update_freee -->
<g id="proc~~compute_energies~~CallsGraph_edge1" class="edge"><title>proc~compute_energies&#45;&gt;update_freee</title>
<path fill="none" stroke="#000000" d="M75.1192,-87.147C93.9302,-96.8213 120.473,-110.472 141.322,-121.194"/>
<polygon fill="#000000" stroke="#000000" points="139.96,-124.429 150.453,-125.89 143.161,-118.204 139.96,-124.429"/>
</g>
<!-- update_dena -->
<g id="proc~~compute_energies~~CallsGraph_node3" class="node"><title>update_dena</title>
<polygon fill="#777777" stroke="#777777" points="213,-108 137,-108 137,-84 213,-84 213,-108"/>
<text text-anchor="middle" x="175" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">update_dena</text>
</g>
<!-- proc~compute_energies&#45;&gt;update_dena -->
<g id="proc~~compute_energies~~CallsGraph_edge2" class="edge"><title>proc~compute_energies&#45;&gt;update_dena</title>
<path fill="none" stroke="#000000" d="M101.325,-83.5415C109.802,-84.9946 118.581,-86.4997 126.982,-87.9399"/>
<polygon fill="#000000" stroke="#000000" points="126.549,-91.4165 136.997,-89.6566 127.732,-84.5172 126.549,-91.4165"/>
</g>
<!-- fdf_get -->
<g id="proc~~compute_energies~~CallsGraph_node4" class="node"><title>fdf_get</title>
<polygon fill="#777777" stroke="#777777" points="202,-66 148,-66 148,-42 202,-42 202,-66"/>
<text text-anchor="middle" x="175" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">fdf_get</text>
</g>
<!-- proc~compute_energies&#45;&gt;fdf_get -->
<g id="proc~~compute_energies~~CallsGraph_edge3" class="edge"><title>proc~compute_energies&#45;&gt;fdf_get</title>
<path fill="none" stroke="#000000" d="M101.325,-66.4585C113.497,-64.3719 126.293,-62.1784 137.697,-60.2234"/>
<polygon fill="#000000" stroke="#000000" points="138.456,-63.6444 147.721,-58.505 137.273,-56.7451 138.456,-63.6444"/>
</g>
<!-- update_etot -->
<g id="proc~~compute_energies~~CallsGraph_node5" class="node"><title>update_etot</title>
<polygon fill="#777777" stroke="#777777" points="210,-24 140,-24 140,-0 210,-0 210,-24"/>
<text text-anchor="middle" x="175" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">update_etot</text>
</g>
<!-- proc~compute_energies&#45;&gt;update_etot -->
<g id="proc~~compute_energies~~CallsGraph_edge4" class="edge"><title>proc~compute_energies&#45;&gt;update_etot</title>
<path fill="none" stroke="#000000" d="M75.1192,-62.853C93.9302,-53.1787 120.473,-39.5283 141.322,-28.8056"/>
<polygon fill="#000000" stroke="#000000" points="143.161,-31.7958 150.453,-24.1097 139.96,-25.5708 143.161,-31.7958"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
     
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Called by</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~compute_energies~~CalledByGraph Pages: 1 -->
<svg id="proccompute_energiesCalledByGraph" width="221pt" height="32pt"
 viewBox="0.00 0.00 221.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~compute_energies~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>proc~~compute_energies~~CalledByGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 217,-28 217,4 -4,4"/>
<!-- proc~compute_energies -->
<g id="proc~~compute_energies~~CalledByGraph_node1" class="node"><title>proc~compute_energies</title>
<polygon fill="none" stroke="black" points="213,-24 112,-24 112,-0 213,-0 213,-24"/>
<text text-anchor="middle" x="162.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">compute_energies</text>
</g>
<!-- proc~siesta_forces -->
<g id="proc~~compute_energies~~CalledByGraph_node2" class="node"><title>proc~siesta_forces</title>
<g id="a_proc~~compute_energies~~CalledByGraph_node2"><a xlink:href=".././proc/siesta_forces.html" xlink:title="siesta_forces">
<polygon fill="#d9534f" stroke="#d9534f" points="76,-24 0,-24 0,-0 76,-0 76,-24"/>
<text text-anchor="middle" x="38" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_forces</text>
</a>
</g>
</g>
<!-- proc~siesta_forces&#45;&gt;proc~compute_energies -->
<g id="proc~~compute_energies~~CalledByGraph_edge1" class="edge"><title>proc~siesta_forces&#45;&gt;proc~compute_energies</title>
<path fill="none" stroke="#000000" d="M76.0865,-12C84.1847,-12 92.9542,-12 101.685,-12"/>
<polygon fill="#000000" stroke="#000000" points="101.873,-15.5001 111.873,-12 101.873,-8.5001 101.873,-15.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/compute_energies.html#src">compute_energies</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>  <span class="k">subroutine  </span><span class="n">compute_energies</span><span class="p">(</span><span class="n">iscf</span><span class="p">)</span>
<span class="c">!! This routine computes the Harris energy from E_KS(DM_in):</span>
<span class="c">!!</span>
<span class="c">!!@todo</span>
<span class="c">!! Edit formulas</span>
<span class="c">!!@endtodo</span>
<span class="c">!!</span>
<span class="c">!!    E_Harris = E_KS(DM_in) + Tr[H_in*(DM_out-DM_in)]</span>
<span class="c">!!</span>
<span class="c">!! and possibly E_KS(DM_out) as</span>
<span class="c">!!</span>
<span class="c">!!    E_KS(DM_out) = Tr[H_in*DM_out] + E_HXC(DM_out)</span>
<span class="c">!!</span>
<span class="c">!! Note that E_KS(DM_in), as computed in setup_hamiltonian, is not</span>
<span class="c">!! variational if mixing the DM, as the kinetic energy term is</span>
<span class="c">!! using a DM (DM_in) which is not derived from wave-functions. It</span>
<span class="c">!! is also not consistent if we are using the charge density as</span>
<span class="c">!! primary variable for mixing. In this case the Enl and Ekin parts</span>
<span class="c">!! are computed with the previous step&#39;s DM, whereas the &quot;scf&quot; part</span>
<span class="c">!! comes from the (mixed) rho.</span>
<span class="c">!!</span>
<span class="c">!! E_KS(DM_out) computed in setup_hamiltonian with DM_out is</span>
<span class="c">!! variational. Rather than calling again setup_hamiltonian, it is</span>
<span class="c">!! enough to compute the &quot;scf&quot; part of the energy by calling dhscf</span>
<span class="c">!! with DM_out.</span>
<span class="c">!!</span>
<span class="c">!! The routine checks the mixing type and proceeds accordingly</span>

      <span class="k">use </span><span class="nb">precision</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">dp</span>
      <span class="k">use </span><span class="n">fdf</span><span class="p">,</span>             <span class="n">only</span><span class="p">:</span> <span class="n">fdf_get</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">g2cut</span><span class="p">,</span> <span class="n">Temp</span>
      <span class="k">use </span><span class="n">siesta_options</span><span class="p">,</span>  <span class="n">only</span><span class="p">:</span> <span class="n">mix_charge</span><span class="p">,</span> <span class="n">mixH</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">listh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">maxnh</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">Dold</span>
      <span class="k">use </span><span class="n">m_dhscf</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">dhscf</span>
      <span class="k">use </span><span class="n">m_energies</span>
      <span class="k">use </span><span class="n">atomlist</span><span class="p">,</span>        <span class="n">only</span><span class="p">:</span> <span class="n">no_u</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphkb</span><span class="p">,</span> <span class="n">qtot</span><span class="p">,</span> <span class="n">indxuo</span><span class="p">,</span> <span class="n">datm</span><span class="p">,</span>   <span class="p">&amp;</span>
                                 <span class="n">lastkb</span><span class="p">,</span> <span class="n">no_s</span><span class="p">,</span> <span class="n">rmaxv</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">lasto</span><span class="p">,</span> <span class="p">&amp;</span>
                                 <span class="n">rmaxo</span><span class="p">,</span> <span class="n">no_l</span>
      <span class="k">use </span><span class="n">m_ntm</span><span class="p">,</span>           <span class="n">only</span><span class="p">:</span> <span class="n">ntm</span>

      <span class="k">use </span><span class="n">m_spin</span><span class="p">,</span>          <span class="n">only</span><span class="p">:</span> <span class="n">spin</span>
      <span class="k">use </span><span class="n">parallel</span><span class="p">,</span>        <span class="n">only</span><span class="p">:</span> <span class="n">IONode</span>

      <span class="k">use </span><span class="n">m_dipol</span><span class="p">,</span>         <span class="n">only</span><span class="p">:</span> <span class="n">dipol</span>
      <span class="k">use </span><span class="n">siesta_geom</span><span class="p">,</span>     <span class="n">only</span><span class="p">:</span> <span class="n">na_u</span><span class="p">,</span> <span class="n">na_s</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">isa</span>
      <span class="k">use </span><span class="n">m_rhog</span><span class="p">,</span>          <span class="n">only</span><span class="p">:</span> <span class="n">rhog</span>
<span class="cp">#ifdef MPI</span>
      <span class="k">use </span><span class="n">m_mpi_utils</span><span class="p">,</span>     <span class="n">only</span><span class="p">:</span> <span class="n">globalize_sum</span>
<span class="cp">#endif</span>

      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">iscf</span>

      <span class="kt">integer</span>               <span class="kd">::</span> <span class="n">ispin</span><span class="p">,</span> <span class="n">io</span>
<span class="cp">#ifdef MPI</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">buffer1</span>
<span class="cp">#endif</span>

      <span class="kt">logical</span>  <span class="kd">::</span> <span class="n">mixDM</span>


      <span class="n">mixDM</span> <span class="o">=</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="p">(</span><span class="n">mixH</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">mix_charge</span><span class="p">))</span>

<span class="c">!     Compute the band-structure energy</span>

      <span class="k">call </span><span class="n">compute_EBS</span><span class="p">()</span>

      <span class="c">! These energies were calculated in the latest call to</span>
      <span class="c">! setup_hamiltonian, using as ingredient D_in</span>

      <span class="c">! Ecorrec comes from O(N)...</span>
      <span class="c">! DUext is the energy of the charge from DM_in in a field.</span>
      <span class="c">! Emad, Emm, Emeta are extra terms that are added for</span>
      <span class="c">! consistency of the total energy.</span>

      <span class="c">! E0 = Ena + Ekin + Enl + Eso - Eions</span>

      <span class="k">call </span><span class="n">update_DEna</span><span class="p">()</span>
      <span class="k">call </span><span class="n">update_Etot</span><span class="p">()</span>


<span class="c">! Harris energy</span>
<span class="c">! It does not make sense if mixing the charge density, as there is no DM_in</span>
<span class="c">! If mixing the Hamiltonian its usefulness is questionable also.</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">mix_charge</span><span class="p">)</span> <span class="k">then</span>   <span class="c">! possibly add mixH here</span>
         <span class="n">EHarrs</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="k">else</span>
<span class="k">         call </span><span class="n">compute_DEharr</span><span class="p">()</span>
         <span class="n">Eharrs</span> <span class="o">=</span> <span class="n">Etot</span> <span class="o">+</span> <span class="n">DEharr</span>
      <span class="n">endif</span>

<span class="c">! Possible correction to Etot if mixing the DM. This is purely</span>
<span class="c">! cosmetic, to show uniformly converged values during the scf</span>
<span class="c">! cycle. The final energy will be completely correct if the DM is not</span>
<span class="c">! mixed after scf convergence.</span>

<span class="c">! The correction is mandatory if mixing the charge density. In this</span>
<span class="c">! case the call to dhscf is needed to generate rho(G)_out</span>

<span class="c">! If mixing H the KS energy is already variational, as it is</span>
<span class="c">! computed with DM_out</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">mixDM</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         if</span> <span class="p">(</span><span class="n">fdf_get</span><span class="p">(</span><span class="s2">&quot;SCF.Want.Variational.EKS&quot;</span><span class="p">,.</span><span class="n">false</span><span class="p">.))</span> <span class="k">then</span>
<span class="k">            call </span><span class="n">compute_correct_EKS</span><span class="p">()</span>
         <span class="n">endif</span>
      <span class="k">else if</span> <span class="p">(</span><span class="n">mixH</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! not needed</span>
      <span class="k">else if</span> <span class="p">(</span><span class="n">mix_charge</span><span class="p">)</span> <span class="k">then</span>
<span class="k">         call </span><span class="n">compute_correct_EKS</span><span class="p">()</span>
      <span class="n">endif</span>

      <span class="k">call </span><span class="n">update_FreeE</span><span class="p">(</span><span class="n">Temp</span><span class="p">)</span>

 <span class="k">CONTAINS</span>

<span class="k">   subroutine </span><span class="n">compute_EBS</span><span class="p">()</span>

     <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
     <span class="kt">complex</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ind</span>

      <span class="n">Ebs</span> <span class="o">=</span> <span class="mf">0.0_dp</span>

<span class="c">! Modifed for Off-Site Spin-orbit coupling by R. Cuadrado, Feb. 2018</span>
<span class="c">!</span>
<span class="c">!*****************************************************************************</span>
<span class="c">!  Note about Ebs and E_Harris calculation for the Spin-Orbit:</span>
<span class="c">!*****************************************************************************</span>
<span class="c">!</span>
<span class="c">!  E_bs and E_Harris are calculated by means of the following </span>
<span class="c">! complex matrix multiplication: </span>
<span class="c">!</span>
<span class="c">!                 E_bs = Re { Tr[ H * DM ] } </span>
<span class="c">!             E_Harris = Re { Tr[ H * (DM-DM_old) ] }  </span>
<span class="c">!</span>
<span class="c">!  In the following: DM/H(1,1) --&gt; up/up     &lt;--&gt; uu</span>
<span class="c">!                    DM/H(2,2) --&gt; down/down &lt;--&gt; dd</span>
<span class="c">!                    DM/H(1,2) --&gt; up/down   &lt;--&gt; ud</span>
<span class="c">!                    DM/H(2,1) --&gt; down/up   &lt;--&gt; du</span>
<span class="c">!</span>
<span class="c">!  Using DM/H components, E_bs would be sum(E_bs(1:4)), where</span>
<span class="c">!</span>
<span class="c">!   E_bs(1)=Re{sum_ij(H_ij(1,1)*D_ji(1,1))}=Re{sum_ij(H_ij^uu*(DM_ij^uu)^*)}</span>
<span class="c">!   E_bs(2)=Re{sum_ij(H_ij(2,2)*D_ji(2,2))}=Re{sum_ij(H_ij^dd*(DM_ij^dd)^*)}</span>
<span class="c">!   E_bs(3)=Re{sum_ij(H_ij(1,2)*D_ji(2,1))}=Re{sum_ij(H_ij^ud*(DM_ij^ud)^*)}</span>
<span class="c">!   E_bs(4)=Re{sum_ij(H_ij(2,1)*D_ji(1,2))}=Re{sum_ij(H_ij^du*(DM_ij^du)^*)}</span>
<span class="c">!</span>
<span class="c">!         since, due to overall hermiticity,  DM_ij^ab = (DM_ji^ba)^*</span>
<span class="c">!</span>
<span class="c">!   The trace operation is then an extended dot product over the &quot;ij&quot;</span>
<span class="c">!   sparse index, which can also be conveniently done in parallel, as</span>
<span class="c">!   each processor handles the same indexes in H and the DM. Only a</span>
<span class="c">!   global reduction is needed at the end.</span>
      
<span class="c">!  Same comments are valid for the E_Harris calculation.</span>
<span class="c">!</span>
<span class="c">!*****************************************************************************</span>
<span class="c">!</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="n">Ebs_SO</span> <span class="o">=</span> <span class="mf">0.0_dp</span>  
        <span class="n">Ebs_Daux</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="mf">0.0_dp</span><span class="p">,</span> <span class="mf">0.0_dp</span><span class="p">)</span>
        <span class="n">Ebs_Haux</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="mf">0.0_dp</span><span class="p">,</span> <span class="mf">0.0_dp</span><span class="p">)</span>

        <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>

          <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>  
          <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>  
          <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="o">-</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> 
          <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span> 

          <span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span> 
          <span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span> 
          <span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="o">-</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
          <span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span> 


          <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dconjg</span><span class="p">(</span><span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
          <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dconjg</span><span class="p">(</span><span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>
          <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dconjg</span><span class="p">(</span><span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>
          <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ebs_SO</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">Ebs_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dconjg</span><span class="p">(</span><span class="n">Ebs_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>

        <span class="n">enddo</span>

        <span class="n">Ebs</span> <span class="o">=</span> <span class="nb">sum</span> <span class="p">(</span> <span class="n">Ebs_SO</span> <span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">NCol</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
          <span class="n">Ebs</span>    <span class="o">=</span> <span class="n">Ebs</span>    <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="p">)</span>   <span class="p">&amp;</span>
                          <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>  <span class="p">)</span>   <span class="p">&amp;</span>
                 <span class="o">+</span> <span class="mf">2.0_dp</span> <span class="o">*</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>  <span class="p">)</span>   <span class="p">&amp;</span>
                 <span class="o">+</span> <span class="mf">2.0_dp</span> <span class="o">*</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>  <span class="p">)</span>
        <span class="n">enddo</span>
      <span class="k">else if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">Col</span> <span class="p">)</span>  <span class="k">then</span>
<span class="k">        do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
          <span class="n">Ebs</span>    <span class="o">=</span> <span class="n">Ebs</span>    <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="p">&amp;</span>
                          <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">enddo</span>
      <span class="k">else if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="k">none</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
          <span class="n">Ebs</span>    <span class="o">=</span> <span class="n">Ebs</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span>  <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">enddo</span>
      <span class="n">endif</span>

<span class="cp">#ifdef MPI</span>
<span class="c">!     Global reduction </span>
      <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span><span class="n">Ebs</span><span class="p">,</span><span class="n">buffer1</span><span class="p">)</span>
      <span class="n">Ebs</span> <span class="o">=</span> <span class="n">buffer1</span>
<span class="cp">#endif</span>
    <span class="k">end subroutine </span><span class="n">compute_EBS</span>

    <span class="k">subroutine </span><span class="n">compute_DEharr</span><span class="p">()</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
      <span class="kt">complex</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

      <span class="n">DEharr</span> <span class="o">=</span> <span class="mf">0.0_dp</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO</span> <span class="p">)</span> <span class="k">then</span>

<span class="k">        </span><span class="n">DEharr_SO</span> <span class="o">=</span> <span class="mf">0.0_dp</span> 
        <span class="n">DEharr_Daux</span>     <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="mf">0.0_dp</span><span class="p">,</span> <span class="mf">0.0_dp</span><span class="p">)</span>
        <span class="n">DEharr_Daux_old</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="mf">0.0_dp</span><span class="p">,</span> <span class="mf">0.0_dp</span><span class="p">)</span>
        <span class="n">DEharr_Haux</span>     <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="mf">0.0_dp</span><span class="p">,</span> <span class="mf">0.0_dp</span><span class="p">)</span>

        <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>

          <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="o">-</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span>

          <span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="o">-</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span>

          <span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span>
          <span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> 
          <span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="o">-</span><span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> 
          <span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span>


          <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
             <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dconjg</span><span class="p">(</span><span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span> 

          <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
             <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dconjg</span><span class="p">(</span><span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>

          <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
             <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dconjg</span><span class="p">(</span><span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span>

          <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">DEharr_SO</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">&amp;</span>
             <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">DEharr_Haux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dconjg</span><span class="p">(</span><span class="n">DEharr_Daux</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">DEharr_Daux_old</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>

         <span class="n">enddo</span>

         <span class="n">DEharr</span> <span class="o">=</span> <span class="nb">sum</span> <span class="p">(</span> <span class="n">DEharr_SO</span> <span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">NCol</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
          <span class="n">DEharr</span> <span class="o">=</span> <span class="n">DEharr</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>  <span class="p">&amp;</span>
                          <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>  <span class="p">&amp;</span>
                 <span class="o">+</span> <span class="mf">2.0_dp</span> <span class="o">*</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>  <span class="p">&amp;</span>
                 <span class="o">+</span> <span class="mf">2.0_dp</span> <span class="o">*</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">enddo</span>
      <span class="n">elseif</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">Col</span> <span class="p">)</span>  <span class="k">then</span>
<span class="k">        do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
          <span class="n">DEharr</span> <span class="o">=</span> <span class="n">DEharr</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>  <span class="p">&amp;</span>
                          <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">enddo</span>
      <span class="n">elseif</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="k">none</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">        do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
          <span class="n">DEharr</span> <span class="o">=</span> <span class="n">DEharr</span> <span class="o">+</span> <span class="n">H</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Dold</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">enddo</span>
      <span class="n">endif</span>

<span class="cp">#ifdef MPI</span>
      <span class="c">!     Global reduction of DEharr</span>
      <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span> <span class="n">DEharr</span><span class="p">,</span> <span class="n">buffer1</span> <span class="p">)</span>
      <span class="n">DEharr</span> <span class="o">=</span> <span class="n">buffer1</span>
<span class="cp">#endif</span>
    <span class="k">end subroutine </span><span class="n">compute_DEharr</span>
      
    <span class="k">subroutine </span><span class="n">compute_correct_EKS</span><span class="p">()</span>

      <span class="k">use </span><span class="n">files</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">filesOut_t</span>    <span class="c">! derived type for output file names</span>
      <span class="k">use </span><span class="n">class_dSpData1D</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">val</span>
      <span class="k">use </span><span class="n">class_dSpData2D</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">val</span>
      <span class="k">use </span><span class="n">class_zSpData2D</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">val</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H_kin_1D</span><span class="p">,</span> <span class="n">H_vkb_1D</span>
      <span class="k">use </span><span class="n">sparse_matrices</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">H_so_on_2D</span><span class="p">,</span> <span class="n">H_so_off_2D</span>


      <span class="k">type</span><span class="p">(</span><span class="n">filesOut_t</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">filesOut</span>  <span class="c">! blank output file names</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">H_vkb</span><span class="p">(:),</span> <span class="n">H_kin</span><span class="p">(:),</span> <span class="n">H_so_on</span><span class="p">(:,:)</span>
      <span class="kt">complex</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">H_so_off</span><span class="p">(:,:)</span>


      <span class="kt">complex</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Hc</span><span class="p">,</span> <span class="n">Dc</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dummy_stress</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dummy_fa</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dummy_E</span><span class="p">,</span> <span class="n">g2max</span><span class="p">,</span> <span class="n">dummy_H</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
      <span class="kt">integer</span>     <span class="kd">::</span> <span class="n">ihmat</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span>
      
      <span class="c">! Compute E_KS(DM_out)</span>

      <span class="n">g2max</span> <span class="o">=</span> <span class="n">g2cut</span>
      <span class="n">ifa</span>  <span class="o">=</span> <span class="mi">0</span>
      <span class="n">istr</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">ihmat</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="c">! Pass DM_out to compute E_HXC(out)</span>

      <span class="c">! Remove unwanted arguments...</span>

      <span class="k">call </span><span class="n">dhscf</span><span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">Grid</span><span class="p">,</span> <span class="n">no_s</span><span class="p">,</span> <span class="n">iaorb</span><span class="p">,</span> <span class="n">iphorb</span><span class="p">,</span> <span class="n">no_l</span><span class="p">,</span>      <span class="p">&amp;</span>
                  <span class="n">no_u</span><span class="p">,</span> <span class="n">na_u</span><span class="p">,</span> <span class="n">na_s</span><span class="p">,</span> <span class="n">isa</span><span class="p">,</span> <span class="n">xa</span><span class="p">,</span> <span class="n">indxua</span><span class="p">,</span>                        <span class="p">&amp;</span>
                  <span class="n">ntm</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">istr</span><span class="p">,</span> <span class="n">ihmat</span><span class="p">,</span> <span class="n">filesOut</span><span class="p">,</span>                          <span class="p">&amp;</span>
                  <span class="n">maxnh</span><span class="p">,</span> <span class="n">numh</span><span class="p">,</span> <span class="n">listhptr</span><span class="p">,</span> <span class="n">listh</span><span class="p">,</span> <span class="n">Dscf</span><span class="p">,</span> <span class="n">Datm</span><span class="p">,</span>                 <span class="p">&amp;</span>
                  <span class="n">maxnh</span><span class="p">,</span> <span class="n">dummy_H</span><span class="p">,</span> <span class="n">Enaatm</span><span class="p">,</span> <span class="n">Enascf</span><span class="p">,</span> <span class="n">Uatm</span><span class="p">,</span> <span class="n">Uscf</span><span class="p">,</span> <span class="n">DUscf</span><span class="p">,</span> <span class="n">DUext</span><span class="p">,</span> <span class="p">&amp;</span>
                  <span class="n">Exc</span><span class="p">,</span> <span class="n">Dxc</span><span class="p">,</span> <span class="n">dipol</span><span class="p">,</span> <span class="n">dummy_stress</span><span class="p">,</span> <span class="n">dummy_fa</span><span class="p">,</span> <span class="n">dummy_stress</span><span class="p">)</span>
      <span class="c">! (when mix_charge is true, rhog will contain the output rho(G))</span>

      <span class="k">call </span><span class="n">update_DEna</span><span class="p">()</span>

<span class="c">!     Compute Tr[H_0*DM_out] = Ekin + Enl + Eso with DM_out</span>

      <span class="n">H_vkb</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_vkb_1D</span><span class="p">)</span>
      <span class="n">H_kin</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_kin_1D</span><span class="p">)</span>
      
      <span class="n">Ekin</span> <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="n">Enl</span>  <span class="o">=</span> <span class="mf">0.0_dp</span>
      <span class="k">do </span><span class="n">ispin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spin</span><span class="p">%</span><span class="n">spinor</span>
         <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
            <span class="n">Ekin</span> <span class="o">=</span> <span class="n">Ekin</span> <span class="o">+</span> <span class="n">H_kin</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
            <span class="n">Enl</span>  <span class="o">=</span> <span class="n">Enl</span>  <span class="o">+</span> <span class="n">H_vkb</span><span class="p">(</span><span class="n">io</span><span class="p">)</span> <span class="o">*</span> <span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">ispin</span><span class="p">)</span>
         <span class="n">enddo</span>
      <span class="n">enddo</span>

<span class="cp">#ifdef MPI</span>
      <span class="c">! Global reduction of Ekin, Enl</span>
      <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span> <span class="n">Ekin</span><span class="p">,</span> <span class="n">buffer1</span> <span class="p">)</span>
      <span class="n">Ekin</span> <span class="o">=</span> <span class="n">buffer1</span>
      <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span> <span class="n">Enl</span><span class="p">,</span> <span class="n">buffer1</span> <span class="p">)</span>
      <span class="n">Enl</span> <span class="o">=</span> <span class="n">buffer1</span>
<span class="cp">#endif</span>

      <span class="n">Eso</span> <span class="o">=</span> <span class="mf">0._dp</span>

      <span class="k">if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO_offsite</span> <span class="p">)</span> <span class="k">then</span>
<span class="k">         </span><span class="n">H_so_off</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_so_off_2D</span><span class="p">)</span>

         <span class="c">! The computation of the trace is different here, as H_so_off has</span>
         <span class="c">! a different structure from H and the DM.</span>
        <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">maxnh</span>

<span class="c">!-------- Eso(u,u)</span>
          <span class="n">Dc</span> <span class="o">=</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
          <span class="n">Eso</span> <span class="o">=</span> <span class="n">Eso</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">H_so_off</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Dc</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<span class="c">!-------- Eso(d,d)</span>
          <span class="n">Dc</span> <span class="o">=</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
          <span class="n">Eso</span> <span class="o">=</span> <span class="n">Eso</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">H_so_off</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Dc</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<span class="c">!-------- Eso(u,d)</span>
          <span class="n">Dc</span> <span class="o">=</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
          <span class="n">Eso</span> <span class="o">=</span> <span class="n">Eso</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">H_so_off</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">Dc</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>
<span class="c">!-------- Eso(d,u)</span>
          <span class="n">Dc</span> <span class="o">=</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="o">-</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">dp</span><span class="p">)</span>
          <span class="n">Eso</span> <span class="o">=</span> <span class="n">Eso</span> <span class="o">+</span> <span class="kt">real</span><span class="p">(</span> <span class="n">H_so_off</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Dc</span><span class="p">,</span> <span class="n">dp</span><span class="p">)</span>

        <span class="k">end do</span>

<span class="k">      else if</span> <span class="p">(</span> <span class="n">spin</span><span class="p">%</span><span class="n">SO_onsite</span> <span class="p">)</span> <span class="k">then</span>
         <span class="c">! Sadly some compilers (g95), does</span>
         <span class="c">! not allow bounds for pointer assignments :(</span>
         <span class="n">H_so_on</span> <span class="o">=&gt;</span> <span class="n">val</span><span class="p">(</span><span class="n">H_so_on_2D</span><span class="p">)</span>
         <span class="k">do </span><span class="n">io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">maxnh</span>
            <span class="n">Eso</span> <span class="o">=</span> <span class="n">Eso</span> <span class="o">+</span> <span class="n">H_so_on</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_so_on</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="p">&amp;</span>
                 <span class="o">+</span> <span class="n">H_so_on</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">H_so_on</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">&amp;</span>
                 <span class="o">-</span> <span class="n">H_so_on</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">H_so_on</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">Dscf</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
          <span class="k">end do</span>
<span class="k">          </span>
<span class="k">      end if</span>

<span class="cp">#ifdef MPI</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">spin</span><span class="p">%</span><span class="n">SO</span><span class="p">)</span> <span class="k">then</span>
         <span class="c">! Global reduction of Eso</span>
         <span class="k">call </span><span class="n">globalize_sum</span><span class="p">(</span> <span class="n">Eso</span><span class="p">,</span> <span class="n">buffer1</span> <span class="p">)</span>
         <span class="n">Eso</span> <span class="o">=</span> <span class="n">buffer1</span>
      <span class="n">endif</span>
<span class="cp">#endif</span>
      
      <span class="c">! E0 = Ena + Ekin + Enl + Eso - Eions</span>

      <span class="c">! Clarify: Ecorrec (from O(N))</span>
      <span class="k">call </span><span class="n">update_Etot</span><span class="p">()</span>
      
    <span class="k">end subroutine </span><span class="n">compute_correct_EKS</span>

  <span class="k">end subroutine </span><span class="n">compute_energies</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> SIESTA was developed by SIESTA Group</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>