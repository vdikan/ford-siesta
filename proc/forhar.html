<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="A first-principles materials simulation code using Density Functional Theory.">
    
    <meta name="author" content="SIESTA Group" >
    <link rel="icon" href="../favicon.png">

    <title>forhar &ndash; SIESTA</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">SIESTA <small>trunk-700--vdikan-edens-710-ford-681</small></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Program Overview</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>forhar
      <small>Subroutine</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     <li><i class="fa fa-pencil"></i> J.Junquera</li>
     
     
    <li><i class="fa fa-calendar-o"></i> 09/00</li>
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 1.0% of total for procedures.">89 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/forhar.F"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
     <li><a href='../sourcefile/forhar.f.html'>forhar.F</a></li>
    
     <li><a href='../module/m_forhar.html'>m_forhar</a></li>
    
  
     <li class="active">forhar</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/forhar.html#src">forhar</a>
  </div>
</div>



</div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>
public subroutine forhar(NTPL, NSPIN, NML, NTML, NPCC, CELL, RHOATM, RHOPCC, VNA, DRHOOUT, VHARRIS1, VHARRIS2)
    
    
   
</h2>
    
  


    
    <p>Build the potentials needed for computing Harris forces:</p>
<p></p><div class="alert alert-success" role="alert"><h4>Todo</h4><p>Formulas in description
</p></div>
<p>
<p>
<script type="math/tex">
 (V_{NA} + V_{Hartree}(DeltaRho_{in}) - DV_{xc}(Rho_{in})/Dn * (Rho_{out}-Rho_{in}))
</script>
</p>
<p>
<script type="math/tex">
 (V_{NA} + V_{Hartree}(DeltaRho_in) + V_{xc}(Rho_{in})
</script>
</p>
<p>In the first SCF step, <script type="math/tex"> V_{Hartree}(DeltaRho_{in}) </script> is zero, because
 in that case, <script type="math/tex"> Rho_{SCF}(r) = Rho_{atm}(r) </script> and therefore, <script type="math/tex"> DeltaRho(r) = 0 </script>
 This calculation will be skipped.</p>
<p>If Harris + Spin polarized in the first SCF step, then Vharris2 will
 multiply to <script type="math/tex"> D Rho(Harris)/D R </script> inside dfscf, and the change of
 the harris density respect the displacement
 on one atom will not depend on spin. We add in Vharris2 the
 contributions of both spins.</p>
    

    <h3>Arguments</h3>
    
      
<table class="table table-striped varlist">
<thead><tr><th>Type</th>
<th>Intent</th><th>Optional</th>
<th>Attributes</th><th></th><th>Name</th><th></th></thead>



<tbody>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ntpl"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>NTPL</strong></td><td><p>Number of Mesh Total Points in unit cell (including subpoints      !) locally.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nspin%7E3"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>NSPIN</strong></td><td><p>Spin polarizations</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-nml"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>NML</strong>(3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-ntml"></span>integer</td>
  <td></td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>NTML</strong>(3)</td><td></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-npcc"></span>integer,</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>NPCC</strong></td><td><p>Partial core corrections? (<code>0</code>=no,<code>1</code>=yes)</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-cell"></span>real(kind=dp),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>CELL</strong>(3,3)</td><td><p>Cell vectors</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-rhoatm"></span>real(kind=grid_p),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>RHOATM</strong>(NTPL)</td><td><p>Harris density at mesh points</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-rhopcc"></span>real(kind=grid_p),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>RHOPCC</strong>(NTPL)</td><td><p>Partial-core-correction density for xc</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-vna"></span>real(kind=grid_p),</td>
  <td>intent(in)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>VNA</strong>(NTPL)</td><td><p>Sum of neutral atoms potentials</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-drhoout"></span>real(kind=grid_p),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>DRHOOUT</strong>(NTPL,NSPIN)</td><td><p>Charge density at the mesh points in current step.
 The charge density that enters in forhar is <script type="math/tex"> Drho_{out} - Rho_{atm} </script>.</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-vharris1"></span>real(kind=grid_p),</td>
  <td>intent(inout),</td>
  <td></td>
  
  <td>TARGET</td><td>::</td>
  <td><strong>VHARRIS1</strong>(NTPL,NSPIN)</td><td><p>
<script type="math/tex"> V_{na} + V_{Hartree}(DeltaRho_{in}) + V_{xc}(Rho_{in}) </script>
</p></td>
  
</tr>

  
  
  
  
<tr>
  
  <td><span class="anchor" id="variable-vharris2"></span>real(kind=grid_p),</td>
  <td>intent(inout)</td>
  <td></td>
  
  <td></td><td>::</td>
  <td><strong>VHARRIS2</strong>(NTPL)</td><td><p>
<script type="math/tex">
 V_{na} + V_{Hartree}(Rho_{in}) +
 DV_{xc}(Rho_{in})/DRho_{in} * (Rho_{out}-Rho_{in})
 </script>
</p>
<p>If Harris forces are computed in the first SCF step,
 it does not depend on spin.</p></td>
  
</tr>

</tbody>
</table>

    
    
    
    <br>
    
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Calls</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~forhar~~CallsGraph Pages: 1 -->
<svg id="procforharCallsGraph" width="555pt" height="710pt"
 viewBox="0.00 0.00 555.00 710.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~forhar~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 706)">
<title>proc~~forhar~~CallsGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-706 551,-706 551,4 -4,4"/>
<!-- proc~forhar -->
<g id="proc~~forhar~~CallsGraph_node1" class="node"><title>proc~forhar</title>
<polygon fill="none" stroke="black" points="54,-300 0,-300 0,-276 54,-276 54,-300"/>
<text text-anchor="middle" x="27" y="-285.6" font-family="Helvetica,sans-Serif" font-size="10.50">forhar</text>
</g>
<!-- mymeshbox -->
<g id="proc~~forhar~~CallsGraph_node2" class="node"><title>mymeshbox</title>
<polygon fill="#777777" stroke="#777777" points="173,-702 103,-702 103,-678 173,-678 173,-702"/>
<text text-anchor="middle" x="138" y="-687.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mymeshbox</text>
</g>
<!-- proc~forhar&#45;&gt;mymeshbox -->
<g id="proc~~forhar~~CallsGraph_edge1" class="edge"><title>proc~forhar&#45;&gt;mymeshbox</title>
<path fill="none" stroke="#000000" d="M28.468,-300.386C30.912,-359.109 43.9143,-609.121 90,-669 91.2673,-670.647 92.6922,-672.167 94.2354,-673.572"/>
<polygon fill="#000000" stroke="#000000" points="92.5869,-676.696 102.758,-679.664 96.6578,-671.001 92.5869,-676.696"/>
</g>
<!-- proc~setmeshdistr -->
<g id="proc~~forhar~~CallsGraph_node3" class="node"><title>proc~setmeshdistr</title>
<g id="a_proc~~forhar~~CallsGraph_node3"><a xlink:href=".././proc/setmeshdistr.html" xlink:title="setMeshDistr">
<polygon fill="#d9534f" stroke="#d9534f" points="175.5,-660 100.5,-660 100.5,-636 175.5,-636 175.5,-660"/>
<text text-anchor="middle" x="138" y="-645.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">setMeshDistr</text>
</a>
</g>
</g>
<!-- proc~forhar&#45;&gt;proc~setmeshdistr -->
<g id="proc~~forhar~~CallsGraph_edge2" class="edge"><title>proc~forhar&#45;&gt;proc~setmeshdistr</title>
<path fill="none" stroke="#000000" d="M28.8808,-300.197C32.9584,-353.846 51.4638,-568.534 90,-622 92.0804,-624.886 94.5848,-627.49 97.3406,-629.831"/>
<polygon fill="#000000" stroke="#000000" points="95.457,-632.787 105.629,-635.75 99.5249,-627.09 95.457,-632.787"/>
</g>
<!-- re_alloc -->
<g id="proc~~forhar~~CallsGraph_node4" class="node"><title>re_alloc</title>
<polygon fill="#777777" stroke="#777777" points="540.5,-420 486.5,-420 486.5,-396 540.5,-396 540.5,-420"/>
<text text-anchor="middle" x="513.5" y="-405.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">re_alloc</text>
</g>
<!-- proc~forhar&#45;&gt;re_alloc -->
<g id="proc~~forhar~~CallsGraph_edge3" class="edge"><title>proc~forhar&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M36.0801,-300.195C68.9605,-348.556 198.569,-527.211 358,-589 393.639,-602.812 412.551,-610.724 444,-589 496.699,-552.597 508.897,-470.044 511.69,-430.257"/>
<polygon fill="#000000" stroke="#000000" points="515.198,-430.207 512.263,-420.027 508.209,-429.815 515.198,-430.207"/>
</g>
<!-- interface~distmeshdata -->
<g id="proc~~forhar~~CallsGraph_node5" class="node"><title>interface~distmeshdata</title>
<g id="a_proc~~forhar~~CallsGraph_node5"><a xlink:href=".././interface/distmeshdata.html" xlink:title="distMeshData">
<polygon fill="#a7506f" stroke="#a7506f" points="177,-300 99,-300 99,-276 177,-276 177,-300"/>
<text text-anchor="middle" x="138" y="-285.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData</text>
</a>
</g>
</g>
<!-- proc~forhar&#45;&gt;interface~distmeshdata -->
<g id="proc~~forhar~~CallsGraph_edge4" class="edge"><title>proc~forhar&#45;&gt;interface~distmeshdata</title>
<path fill="none" stroke="#000000" d="M54.1082,-288C64.4353,-288 76.6493,-288 88.4825,-288"/>
<polygon fill="#000000" stroke="#000000" points="88.7264,-291.5 98.7263,-288 88.7263,-284.5 88.7264,-291.5"/>
</g>
<!-- de_alloc -->
<g id="proc~~forhar~~CallsGraph_node6" class="node"><title>de_alloc</title>
<polygon fill="#777777" stroke="#777777" points="540.5,-292 486.5,-292 486.5,-268 540.5,-268 540.5,-292"/>
<text text-anchor="middle" x="513.5" y="-277.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">de_alloc</text>
</g>
<!-- proc~forhar&#45;&gt;de_alloc -->
<g id="proc~~forhar~~CallsGraph_edge5" class="edge"><title>proc~forhar&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M50.5236,-275.78C114.462,-242.805 301.658,-158.214 444,-215 455.95,-219.768 478.998,-243.124 495.041,-260.482"/>
<polygon fill="#000000" stroke="#000000" points="492.529,-262.921 501.855,-267.948 497.699,-258.202 492.529,-262.921"/>
</g>
<!-- jms_setmeshdistr -->
<g id="proc~~forhar~~CallsGraph_node7" class="node"><title>jms_setmeshdistr</title>
<polygon fill="#777777" stroke="#777777" points="186,-142 90,-142 90,-118 186,-118 186,-142"/>
<text text-anchor="middle" x="138" y="-127.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">jms_setmeshdistr</text>
</g>
<!-- proc~forhar&#45;&gt;jms_setmeshdistr -->
<g id="proc~~forhar~~CallsGraph_edge6" class="edge"><title>proc~forhar&#45;&gt;jms_setmeshdistr</title>
<path fill="none" stroke="#000000" d="M31.0327,-275.617C37.7615,-250.36 56.0902,-192.232 90,-156 92.8674,-152.936 96.179,-150.146 99.69,-147.628"/>
<polygon fill="#000000" stroke="#000000" points="101.58,-150.574 108.129,-142.247 97.8158,-144.672 101.58,-150.574"/>
</g>
<!-- bsc_cellxc -->
<g id="proc~~forhar~~CallsGraph_node8" class="node"><title>bsc_cellxc</title>
<polygon fill="#777777" stroke="#777777" points="168.5,-100 107.5,-100 107.5,-76 168.5,-76 168.5,-100"/>
<text text-anchor="middle" x="138" y="-85.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">bsc_cellxc</text>
</g>
<!-- proc~forhar&#45;&gt;bsc_cellxc -->
<g id="proc~~forhar~~CallsGraph_edge7" class="edge"><title>proc~forhar&#45;&gt;bsc_cellxc</title>
<path fill="none" stroke="#000000" d="M28.932,-275.897C31.9696,-244.413 44.217,-158.938 90,-109 92.429,-106.351 95.2549,-104.015 98.2929,-101.961"/>
<polygon fill="#000000" stroke="#000000" points="100.282,-104.857 107.263,-96.8868 96.8361,-98.7637 100.282,-104.857"/>
</g>
<!-- proc~distmeshdata_rea -->
<g id="proc~~forhar~~CallsGraph_node9" class="node"><title>proc~distmeshdata_rea</title>
<g id="a_proc~~forhar~~CallsGraph_node9"><a xlink:href=".././proc/distmeshdata_rea.html" xlink:title="distMeshData_rea">
<polygon fill="#d9534f" stroke="#d9534f" points="322,-360 222,-360 222,-336 322,-336 322,-360"/>
<text text-anchor="middle" x="272" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData_rea</text>
</a>
</g>
</g>
<!-- interface~distmeshdata&#45;&gt;proc~distmeshdata_rea -->
<g id="proc~~forhar~~CallsGraph_edge8" class="edge"><title>interface~distmeshdata&#45;&gt;proc~distmeshdata_rea</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M165.712,-300.142C185.661,-309.21 213.14,-321.7 235.023,-331.647"/>
<polygon fill="#000000" stroke="#000000" points="233.776,-334.924 244.328,-335.876 236.672,-328.552 233.776,-334.924"/>
</g>
<!-- proc~distmeshdata_int -->
<g id="proc~~forhar~~CallsGraph_node10" class="node"><title>proc~distmeshdata_int</title>
<g id="a_proc~~forhar~~CallsGraph_node10"><a xlink:href=".././proc/distmeshdata_int.html" xlink:title="distMeshData_int">
<polygon fill="#d9534f" stroke="#d9534f" points="319.5,-260 224.5,-260 224.5,-236 319.5,-236 319.5,-260"/>
<text text-anchor="middle" x="272" y="-245.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distMeshData_int</text>
</a>
</g>
</g>
<!-- interface~distmeshdata&#45;&gt;proc~distmeshdata_int -->
<g id="proc~~forhar~~CallsGraph_edge9" class="edge"><title>interface~distmeshdata&#45;&gt;proc~distmeshdata_int</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M177.18,-276.43C190.914,-272.268 206.615,-267.511 221.193,-263.093"/>
<polygon fill="#000000" stroke="#000000" points="222.513,-266.35 231.068,-260.101 220.483,-259.651 222.513,-266.35"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;re_alloc -->
<g id="proc~~forhar~~CallsGraph_edge13" class="edge"><title>proc~distmeshdata_rea&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M282.385,-360.101C296.571,-377.29 325.316,-408.018 358,-420 396.748,-434.205 444.534,-427.078 476.613,-419.083"/>
<polygon fill="#000000" stroke="#000000" points="477.673,-422.423 486.445,-416.483 475.883,-415.656 477.673,-422.423"/>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;de_alloc -->
<g id="proc~~forhar~~CallsGraph_edge16" class="edge"><title>proc~distmeshdata_rea&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M293.981,-335.853C310.784,-326.63 335.229,-314.325 358,-307 397.358,-294.34 444.379,-287.199 476.127,-283.484"/>
<polygon fill="#000000" stroke="#000000" points="476.725,-286.94 486.275,-282.353 475.949,-279.983 476.725,-286.94"/>
</g>
<!-- mpitrace_event -->
<g id="proc~~forhar~~CallsGraph_node11" class="node"><title>mpitrace_event</title>
<polygon fill="#777777" stroke="#777777" points="444,-580 358,-580 358,-556 444,-556 444,-580"/>
<text text-anchor="middle" x="401" y="-565.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpitrace_event</text>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;mpitrace_event -->
<g id="proc~~forhar~~CallsGraph_edge10" class="edge"><title>proc~distmeshdata_rea&#45;&gt;mpitrace_event</title>
<path fill="none" stroke="#000000" d="M275.194,-360.365C281.797,-394.296 304.427,-490.114 358,-547 358.912,-547.968 359.878,-548.898 360.888,-549.791"/>
<polygon fill="#000000" stroke="#000000" points="359.164,-552.866 369.308,-555.923 363.285,-547.207 359.164,-552.866"/>
</g>
<!-- proc~boxintersection -->
<g id="proc~~forhar~~CallsGraph_node12" class="node"><title>proc~boxintersection</title>
<g id="a_proc~~forhar~~CallsGraph_node12"><a xlink:href=".././proc/boxintersection.html" xlink:title="boxIntersection">
<polygon fill="#d9534f" stroke="#d9534f" points="443.5,-260 358.5,-260 358.5,-236 443.5,-236 443.5,-260"/>
<text text-anchor="middle" x="401" y="-245.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">boxIntersection</text>
</a>
</g>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~boxintersection -->
<g id="proc~~forhar~~CallsGraph_edge11" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~boxintersection</title>
<path fill="none" stroke="#000000" d="M285.7,-335.777C301.854,-320.511 330.913,-293.971 358,-274 361.934,-271.099 366.199,-268.201 370.452,-265.449"/>
<polygon fill="#000000" stroke="#000000" points="372.446,-268.329 379.054,-260.048 368.724,-262.401 372.446,-268.329"/>
</g>
<!-- proc~reord -->
<g id="proc~~forhar~~CallsGraph_node13" class="node"><title>proc~reord</title>
<g id="a_proc~~forhar~~CallsGraph_node13"><a xlink:href=".././proc/reord.html" xlink:title="reord">
<polygon fill="#d9534f" stroke="#d9534f" points="428,-340 374,-340 374,-316 428,-316 428,-340"/>
<text text-anchor="middle" x="401" y="-325.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">reord</text>
</a>
</g>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~reord -->
<g id="proc~~forhar~~CallsGraph_edge12" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~reord</title>
<path fill="none" stroke="#000000" d="M322.102,-340.267C335.981,-338.082 350.829,-335.743 363.8,-333.701"/>
<polygon fill="#000000" stroke="#000000" points="364.412,-337.148 373.746,-332.135 363.323,-330.233 364.412,-337.148"/>
</g>
<!-- timer -->
<g id="proc~~forhar~~CallsGraph_node14" class="node"><title>timer</title>
<polygon fill="#777777" stroke="#777777" points="540.5,-360 486.5,-360 486.5,-336 540.5,-336 540.5,-360"/>
<text text-anchor="middle" x="513.5" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">timer</text>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;timer -->
<g id="proc~~forhar~~CallsGraph_edge14" class="edge"><title>proc~distmeshdata_rea&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M322.44,-348.68C334.102,-348.813 346.489,-348.932 358,-349 396.222,-349.225 405.779,-349.279 444,-349 454.526,-348.923 465.96,-348.78 476.417,-348.625"/>
<polygon fill="#000000" stroke="#000000" points="476.535,-352.124 486.479,-348.469 476.426,-345.125 476.535,-352.124"/>
</g>
<!-- mpi_barrier -->
<g id="proc~~forhar~~CallsGraph_node15" class="node"><title>mpi_barrier</title>
<polygon fill="#777777" stroke="#777777" points="434.5,-538 367.5,-538 367.5,-514 434.5,-514 434.5,-538"/>
<text text-anchor="middle" x="401" y="-523.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_barrier</text>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;mpi_barrier -->
<g id="proc~~forhar~~CallsGraph_edge15" class="edge"><title>proc~distmeshdata_rea&#45;&gt;mpi_barrier</title>
<path fill="none" stroke="#000000" d="M276.745,-360.197C286.098,-388.878 313.013,-461.455 358,-505 359.098,-506.063 360.261,-507.083 361.473,-508.061"/>
<polygon fill="#000000" stroke="#000000" points="359.79,-511.15 370.021,-513.902 363.739,-505.37 359.79,-511.15"/>
</g>
<!-- write_debug -->
<g id="proc~~forhar~~CallsGraph_node16" class="node"><title>write_debug</title>
<polygon fill="#777777" stroke="#777777" points="436.5,-496 365.5,-496 365.5,-472 436.5,-472 436.5,-496"/>
<text text-anchor="middle" x="401" y="-481.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_debug</text>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;write_debug -->
<g id="proc~~forhar~~CallsGraph_edge17" class="edge"><title>proc~distmeshdata_rea&#45;&gt;write_debug</title>
<path fill="none" stroke="#000000" d="M280.244,-360.042C293.616,-381.576 323.94,-427.297 358,-458 361.225,-460.907 364.816,-463.681 368.504,-466.261"/>
<polygon fill="#000000" stroke="#000000" points="366.866,-469.371 377.155,-471.9 370.689,-463.507 366.866,-469.371"/>
</g>
<!-- proc~die -->
<g id="proc~~forhar~~CallsGraph_node17" class="node"><title>proc~die</title>
<g id="a_proc~~forhar~~CallsGraph_node17"><a xlink:href=".././proc/die.html" xlink:title="die">
<polygon fill="#d9534f" stroke="#d9534f" points="428,-142 374,-142 374,-118 428,-118 428,-142"/>
<text text-anchor="middle" x="401" y="-127.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">die</text>
</a>
</g>
</g>
<!-- proc~distmeshdata_rea&#45;&gt;proc~die -->
<g id="proc~~forhar~~CallsGraph_edge18" class="edge"><title>proc~distmeshdata_rea&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M280.807,-335.786C290.62,-320.35 307.888,-292.905 322,-269 346.43,-227.615 373.612,-178.409 388.568,-151.04"/>
<polygon fill="#000000" stroke="#000000" points="391.783,-152.456 393.497,-142 385.637,-149.104 391.783,-152.456"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;re_alloc -->
<g id="proc~~forhar~~CallsGraph_edge19" class="edge"><title>proc~distmeshdata_int&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M280.373,-260.309C293.503,-281.268 322.883,-324.036 358,-349 394.371,-374.856 443.527,-391.064 476.537,-399.808"/>
<polygon fill="#000000" stroke="#000000" points="475.676,-403.2 486.231,-402.285 477.409,-396.418 475.676,-403.2"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;de_alloc -->
<g id="proc~~forhar~~CallsGraph_edge21" class="edge"><title>proc~distmeshdata_int&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M304.439,-235.981C339.413,-224.46 397.157,-210.994 444,-227 463.56,-233.684 481.865,-248.472 494.623,-260.734"/>
<polygon fill="#000000" stroke="#000000" points="492.274,-263.334 501.812,-267.947 497.232,-258.393 492.274,-263.334"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;proc~boxintersection -->
<g id="proc~~forhar~~CallsGraph_edge20" class="edge"><title>proc~distmeshdata_int&#45;&gt;proc~boxintersection</title>
<path fill="none" stroke="#000000" d="M319.569,-248C328.927,-248 338.814,-248 348.333,-248"/>
<polygon fill="#000000" stroke="#000000" points="348.476,-251.5 358.476,-248 348.476,-244.5 348.476,-251.5"/>
</g>
<!-- proc~distmeshdata_int&#45;&gt;proc~die -->
<g id="proc~~forhar~~CallsGraph_edge22" class="edge"><title>proc~distmeshdata_int&#45;&gt;proc~die</title>
<path fill="none" stroke="#000000" d="M286.113,-235.816C308.168,-215.325 352.855,-173.804 379.22,-149.308"/>
<polygon fill="#000000" stroke="#000000" points="381.825,-151.665 386.768,-142.294 377.06,-146.537 381.825,-151.665"/>
</g>
<!-- proc~reord&#45;&gt;re_alloc -->
<g id="proc~~forhar~~CallsGraph_edge23" class="edge"><title>proc~reord&#45;&gt;re_alloc</title>
<path fill="none" stroke="#000000" d="M418.783,-340.15C437.143,-353.443 466.754,-374.881 487.774,-390.099"/>
<polygon fill="#000000" stroke="#000000" points="485.769,-392.968 495.922,-395.998 489.874,-387.298 485.769,-392.968"/>
</g>
<!-- proc~reord&#45;&gt;de_alloc -->
<g id="proc~~forhar~~CallsGraph_edge24" class="edge"><title>proc~reord&#45;&gt;de_alloc</title>
<path fill="none" stroke="#000000" d="M428.187,-316.625C442.668,-310.334 460.874,-302.426 476.658,-295.569"/>
<polygon fill="#000000" stroke="#000000" points="478.341,-298.655 486.118,-291.46 475.552,-292.234 478.341,-298.655"/>
</g>
<!-- proc~reord&#45;&gt;timer -->
<g id="proc~~forhar~~CallsGraph_edge25" class="edge"><title>proc~reord&#45;&gt;timer</title>
<path fill="none" stroke="#000000" d="M428.187,-332.74C442.532,-335.336 460.53,-338.594 476.211,-341.432"/>
<polygon fill="#000000" stroke="#000000" points="475.655,-344.888 486.118,-343.225 476.901,-338 475.655,-344.888"/>
</g>
<!-- io_close -->
<g id="proc~~forhar~~CallsGraph_node18" class="node"><title>io_close</title>
<polygon fill="#777777" stroke="#777777" points="540.5,-234 486.5,-234 486.5,-210 540.5,-210 540.5,-234"/>
<text text-anchor="middle" x="513.5" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">io_close</text>
</g>
<!-- proc~die&#45;&gt;io_close -->
<g id="proc~~forhar~~CallsGraph_edge26" class="edge"><title>proc~die&#45;&gt;io_close</title>
<path fill="none" stroke="#000000" d="M424.791,-142.162C431.318,-146.147 438.224,-150.881 444,-156 463.168,-172.988 460.997,-183.827 480,-201 481.09,-201.985 482.232,-202.956 483.407,-203.906"/>
<polygon fill="#000000" stroke="#000000" points="481.356,-206.742 491.486,-209.845 485.502,-201.102 481.356,-206.742"/>
</g>
<!-- cmlfinishfile -->
<g id="proc~~forhar~~CallsGraph_node19" class="node"><title>cmlfinishfile</title>
<polygon fill="#777777" stroke="#777777" points="547,-192 480,-192 480,-168 547,-168 547,-192"/>
<text text-anchor="middle" x="513.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cmlfinishfile</text>
</g>
<!-- proc~die&#45;&gt;cmlfinishfile -->
<g id="proc~~forhar~~CallsGraph_edge27" class="edge"><title>proc~die&#45;&gt;cmlfinishfile</title>
<path fill="none" stroke="#000000" d="M428.187,-141.849C442.563,-148.354 460.608,-156.519 476.312,-163.625"/>
<polygon fill="#000000" stroke="#000000" points="475.18,-166.955 485.733,-167.888 478.066,-160.577 475.18,-166.955"/>
</g>
<!-- io_assign -->
<g id="proc~~forhar~~CallsGraph_node20" class="node"><title>io_assign</title>
<polygon fill="#777777" stroke="#777777" points="542.5,-150 484.5,-150 484.5,-126 542.5,-126 542.5,-150"/>
<text text-anchor="middle" x="513.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">io_assign</text>
</g>
<!-- proc~die&#45;&gt;io_assign -->
<g id="proc~~forhar~~CallsGraph_edge28" class="edge"><title>proc~die&#45;&gt;io_assign</title>
<path fill="none" stroke="#000000" d="M428.187,-131.896C441.877,-132.887 458.894,-134.119 474.048,-135.216"/>
<polygon fill="#000000" stroke="#000000" points="473.951,-138.718 484.178,-135.95 474.457,-131.736 473.951,-138.718"/>
</g>
<!-- pxfabort -->
<g id="proc~~forhar~~CallsGraph_node21" class="node"><title>pxfabort</title>
<polygon fill="#777777" stroke="#777777" points="540.5,-108 486.5,-108 486.5,-84 540.5,-84 540.5,-108"/>
<text text-anchor="middle" x="513.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">pxfabort</text>
</g>
<!-- proc~die&#45;&gt;pxfabort -->
<g id="proc~~forhar~~CallsGraph_edge29" class="edge"><title>proc~die&#45;&gt;pxfabort</title>
<path fill="none" stroke="#000000" d="M428.187,-121.942C442.532,-117.529 460.53,-111.991 476.211,-107.166"/>
<polygon fill="#000000" stroke="#000000" points="477.59,-110.404 486.118,-104.118 475.531,-103.713 477.59,-110.404"/>
</g>
<!-- mpi_abort -->
<g id="proc~~forhar~~CallsGraph_node22" class="node"><title>mpi_abort</title>
<polygon fill="#777777" stroke="#777777" points="544,-66 483,-66 483,-42 544,-42 544,-66"/>
<text text-anchor="middle" x="513.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_abort</text>
</g>
<!-- proc~die&#45;&gt;mpi_abort -->
<g id="proc~~forhar~~CallsGraph_edge30" class="edge"><title>proc~die&#45;&gt;mpi_abort</title>
<path fill="none" stroke="#000000" d="M418.904,-117.784C434.611,-106.503 458.715,-89.3724 480,-75 481.628,-73.9004 483.309,-72.7779 485.009,-71.6522"/>
<polygon fill="#000000" stroke="#000000" points="487.061,-74.4918 493.511,-66.0865 483.227,-68.635 487.061,-74.4918"/>
</g>
<!-- pxfflush -->
<g id="proc~~forhar~~CallsGraph_node23" class="node"><title>pxfflush</title>
<polygon fill="#777777" stroke="#777777" points="540.5,-24 486.5,-24 486.5,-0 540.5,-0 540.5,-24"/>
<text text-anchor="middle" x="513.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">pxfflush</text>
</g>
<!-- proc~die&#45;&gt;pxfflush -->
<g id="proc~~forhar~~CallsGraph_edge31" class="edge"><title>proc~die&#45;&gt;pxfflush</title>
<path fill="none" stroke="#000000" d="M409.819,-117.932C422.795,-98.5039 450.306,-59.7671 480,-33 481.092,-32.0161 482.234,-31.047 483.41,-30.0974"/>
<polygon fill="#000000" stroke="#000000" points="485.504,-32.9021 491.492,-24.162 481.361,-27.26 485.504,-32.9021"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
     
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Called by</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: proc~~forhar~~CalledByGraph Pages: 1 -->
<svg id="procforharCalledByGraph" width="400pt" height="74pt"
 viewBox="0.00 0.00 400.00 74.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~forhar~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 70)">
<title>proc~~forhar~~CalledByGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-70 396,-70 396,4 -4,4"/>
<!-- proc~forhar -->
<g id="proc~~forhar~~CalledByGraph_node1" class="node"><title>proc~forhar</title>
<polygon fill="none" stroke="black" points="392,-45 338,-45 338,-21 392,-21 392,-45"/>
<text text-anchor="middle" x="365" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50">forhar</text>
</g>
<!-- proc~dhscf -->
<g id="proc~~forhar~~CalledByGraph_node2" class="node"><title>proc~dhscf</title>
<g id="a_proc~~forhar~~CalledByGraph_node2"><a xlink:href=".././proc/dhscf.html" xlink:title="dhscf">
<polygon fill="#d9534f" stroke="#d9534f" points="302,-45 248,-45 248,-21 302,-21 302,-45"/>
<text text-anchor="middle" x="275" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dhscf</text>
</a>
</g>
</g>
<!-- proc~dhscf&#45;&gt;proc~forhar -->
<g id="proc~~forhar~~CalledByGraph_edge1" class="edge"><title>proc~dhscf&#45;&gt;proc~forhar</title>
<path fill="none" stroke="#000000" d="M302.403,-33C310.393,-33 319.311,-33 327.824,-33"/>
<polygon fill="#000000" stroke="#000000" points="327.919,-36.5001 337.919,-33 327.919,-29.5001 327.919,-36.5001"/>
</g>
<!-- proc~siesta_analysis -->
<g id="proc~~forhar~~CalledByGraph_node3" class="node"><title>proc~siesta_analysis</title>
<g id="a_proc~~forhar~~CalledByGraph_node3"><a xlink:href=".././proc/siesta_analysis.html" xlink:title="siesta_analysis">
<polygon fill="#d9534f" stroke="#d9534f" points="204.5,-66 119.5,-66 119.5,-42 204.5,-42 204.5,-66"/>
<text text-anchor="middle" x="162" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_analysis</text>
</a>
</g>
</g>
<!-- proc~siesta_analysis&#45;&gt;proc~dhscf -->
<g id="proc~~forhar~~CalledByGraph_edge2" class="edge"><title>proc~siesta_analysis&#45;&gt;proc~dhscf</title>
<path fill="none" stroke="#000000" d="M204.648,-46.1206C215.65,-44.0392 227.428,-41.811 238.097,-39.7925"/>
<polygon fill="#000000" stroke="#000000" points="238.75,-43.2311 247.925,-37.9331 237.449,-36.3531 238.75,-43.2311"/>
</g>
<!-- proc~setup_hamiltonian -->
<g id="proc~~forhar~~CalledByGraph_node4" class="node"><title>proc~setup_hamiltonian</title>
<g id="a_proc~~forhar~~CalledByGraph_node4"><a xlink:href=".././proc/setup_hamiltonian.html" xlink:title="setup_hamiltonian">
<polygon fill="#d9534f" stroke="#d9534f" points="212,-24 112,-24 112,-0 212,-0 212,-24"/>
<text text-anchor="middle" x="162" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">setup_hamiltonian</text>
</a>
</g>
</g>
<!-- proc~setup_hamiltonian&#45;&gt;proc~dhscf -->
<g id="proc~~forhar~~CalledByGraph_edge3" class="edge"><title>proc~setup_hamiltonian&#45;&gt;proc~dhscf</title>
<path fill="none" stroke="#000000" d="M212.009,-21.272C220.666,-22.9099 229.537,-24.5881 237.763,-26.1444"/>
<polygon fill="#000000" stroke="#000000" points="237.297,-29.6183 247.774,-28.0383 238.599,-22.7403 237.297,-29.6183"/>
</g>
<!-- proc~siesta_forces -->
<g id="proc~~forhar~~CalledByGraph_node5" class="node"><title>proc~siesta_forces</title>
<g id="a_proc~~forhar~~CalledByGraph_node5"><a xlink:href=".././proc/siesta_forces.html" xlink:title="siesta_forces">
<polygon fill="#d9534f" stroke="#d9534f" points="76,-24 0,-24 0,-0 76,-0 76,-24"/>
<text text-anchor="middle" x="38" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">siesta_forces</text>
</a>
</g>
</g>
<!-- proc~siesta_forces&#45;&gt;proc~setup_hamiltonian -->
<g id="proc~~forhar~~CalledByGraph_edge4" class="edge"><title>proc~siesta_forces&#45;&gt;proc~setup_hamiltonian</title>
<path fill="none" stroke="#000000" d="M76.2669,-12C84.3255,-12 93.0387,-12 101.706,-12"/>
<polygon fill="#000000" stroke="#000000" points="101.817,-15.5001 111.817,-12 101.817,-8.5001 101.817,-15.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="560pt" height="32pt"
 viewBox="0.00 0.00 559.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 555.5,-28 555.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node"><title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="64,-24 0,-24 0,-0 64,-0 64,-24"/>
<text text-anchor="middle" x="32" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node"><title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="136,-24 82,-24 82,-0 136,-0 136,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node"><title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="209.5,-24 154.5,-24 154.5,-0 209.5,-0 209.5,-24"/>
<text text-anchor="middle" x="182" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node4" class="node"><title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="364,-24 228,-24 228,-0 364,-0 364,-24"/>
<text text-anchor="middle" x="296" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node5" class="node"><title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="436,-24 382,-24 382,-0 436,-0 436,-24"/>
<text text-anchor="middle" x="409" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="551.5,-24 454.5,-24 454.5,-0 551.5,-0 551.5,-24"/>
<text text-anchor="middle" x="503" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a procedure to one which it calls. Dashed 
    arrows point from an interface to procedures which implement that interface.
    This could include the module procedures in a generic interface or the
    implementation in a submodule of an interface in a parent module.
    </p>
    </div></div></div></div>
      </div>
    </div>
     
    <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 





















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../proc/forhar.html#src">forhar</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    

    
    
    
    
    

    
    
    
    
    


    
    
    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="highlight"><pre><span></span>      <span class="k">subroutine </span><span class="n">forhar</span><span class="p">(</span> <span class="n">NTPL</span><span class="p">,</span> <span class="n">NSPIN</span><span class="p">,</span> <span class="n">NML</span><span class="p">,</span> <span class="n">NTML</span><span class="p">,</span> <span class="n">NTM</span><span class="p">,</span> <span class="n">NPCC</span><span class="p">,</span>
     <span class="err">$</span>                   <span class="n">CELL</span><span class="p">,</span> <span class="n">RHOATM</span><span class="p">,</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="k">subroutine </span><span class="n">forhar</span><span class="p">(</span> <span class="n">NTPL</span><span class="p">,</span> <span class="n">NSPIN</span><span class="p">,</span> <span class="n">NML</span><span class="p">,</span> <span class="n">NTML</span><span class="p">,</span> <span class="n">NPCC</span><span class="p">,</span> <span class="n">CELL</span><span class="p">,</span> <span class="n">RHOATM</span><span class="p">,</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
     <span class="p">&amp;</span>                   <span class="n">RHOPCC</span><span class="p">,</span> <span class="n">VNA</span><span class="p">,</span> <span class="n">DRHOOUT</span><span class="p">,</span> <span class="n">VHARRIS1</span><span class="p">,</span> <span class="n">VHARRIS2</span> <span class="p">)</span>
<span class="c">!! author: J.Junquera</span>
<span class="c">!! date: 09/00</span>
<span class="c">!!</span>
<span class="c">!! Build the potentials needed for computing Harris forces:</span>
<span class="c">!!</span>
<span class="c">!!@todo</span>
<span class="c">!! Formulas in description</span>
<span class="c">!!@endtodo</span>
<span class="c">!!</span>
<span class="c">!!\(</span>
<span class="c">!! (V_{NA} + V_{Hartree}(DeltaRho_{in}) - DV_{xc}(Rho_{in})/Dn * (Rho_{out}-Rho_{in}))</span>
<span class="c">!!\)</span>
<span class="c">!!</span>
<span class="c">!!\(</span>
<span class="c">!! (V_{NA} + V_{Hartree}(DeltaRho_in) + V_{xc}(Rho_{in})</span>
<span class="c">!!\)</span>
<span class="c">!!</span>
<span class="c">!! In the first SCF step, \( V_{Hartree}(DeltaRho_{in}) \) is zero, because</span>
<span class="c">!! in that case, \( Rho_{SCF}(r) = Rho_{atm}(r) \) and therefore, \( DeltaRho(r) = 0 \)</span>
<span class="c">!! This calculation will be skipped.</span>
<span class="c">!!</span>
<span class="c">!! If Harris + Spin polarized in the first SCF step, then Vharris2 will</span>
<span class="c">!! multiply to \( D Rho(Harris)/D R \) inside dfscf, and the change of</span>
<span class="c">!! the harris density respect the displacement</span>
<span class="c">!! on one atom will not depend on spin. We add in Vharris2 the</span>
<span class="c">!! contributions of both spins.</span>

      <span class="kt">INTEGER</span>             <span class="kd">::</span> <span class="n">NTPL</span>
        <span class="c">!! Number of Mesh Total Points in unit cell (including subpoints) locally.</span>
      <span class="kt">INTEGER</span>             <span class="kd">::</span> <span class="n">NML</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">NTML</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">NTM</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Number of mesh divisions of each cell</span>
        <span class="c">!! vector, including subgrid</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">NSPIN</span>
        <span class="c">!! Spin polarizations</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">NPCC</span>
        <span class="c">!! Partial core corrections? (`0`=no,`1`=yes)</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">NSPIN</span><span class="p">,</span> <span class="n">NPCC</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="kt">REAL</span><span class="p">(</span><span class="n">dp</span><span class="p">),</span>                <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CELL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="c">!! Cell vectors</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span>            <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">VNA</span><span class="p">(</span><span class="n">NTPL</span><span class="p">)</span>
        <span class="c">!! Sum of neutral atoms potentials</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span>            <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">RHOATM</span><span class="p">(</span><span class="n">NTPL</span><span class="p">)</span>
        <span class="c">!! Harris density at mesh points</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span>            <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span> <span class="kd">::</span> <span class="n">RHOPCC</span><span class="p">(</span><span class="n">NTPL</span><span class="p">)</span>
        <span class="c">!! Partial-core-correction density for xc</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span>         <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">DRHOOUT</span><span class="p">(</span><span class="n">NTPL</span><span class="p">,</span><span class="n">NSPIN</span><span class="p">)</span>
<span class="c">!! Charge density at the mesh points in current step.</span>
<span class="c">!! The charge density that enters in forhar is \( Drho_{out} - Rho_{atm} \).</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span> <span class="k">TARGET</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">VHARRIS1</span><span class="p">(</span><span class="n">NTPL</span><span class="p">,</span><span class="n">NSPIN</span><span class="p">)</span>
<span class="c">!! \( V_{na} + V_{Hartree}(DeltaRho_{in}) + V_{xc}(Rho_{in}) \)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span>         <span class="k">intent</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span> <span class="kd">::</span> <span class="n">VHARRIS2</span><span class="p">(</span><span class="n">NTPL</span><span class="p">)</span>
<span class="c">!! \(</span>
<span class="c">!! V_{na} + V_{Hartree}(Rho_{in}) +</span>
<span class="c">!! DV_{xc}(Rho_{in})/DRho_{in} * (Rho_{out}-Rho_{in})</span>
<span class="c">!! \)</span>
<span class="c">!!</span>
<span class="c">!! If Harris forces are computed in the first SCF step,</span>
<span class="c">!! it does not depend on spin.</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">EXTERNAL </span><span class="n">REORD</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="k">EXTERNAL </span><span class="n">bsc_cellxc</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="c">! AG: Note:  REAL*4 variables are really REAL(kind=grid_p)</span>
<span class="c">!</span>
<span class="n">C</span> <span class="o">*****</span> <span class="n">INTERNAL</span> <span class="n">VARIABLES</span> <span class="o">*********************************************</span>
<span class="n">C</span> <span class="kt">REAL</span><span class="o">*</span><span class="mi">4</span> <span class="n">DVXDN</span><span class="p">(</span><span class="n">NTPL</span><span class="p">,</span><span class="n">NSPIN</span><span class="p">,</span><span class="n">NSPIN</span><span class="p">):</span> <span class="n">Derivative</span> <span class="n">of</span> <span class="n">exchange</span><span class="o">-</span><span class="n">correlation</span>
<span class="n">C</span>                                <span class="n">potential</span> <span class="n">respect</span> <span class="n">the</span> <span class="n">charge</span> <span class="n">density</span>
<span class="n">C</span> <span class="o">**********************************************************************</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Internal</span> <span class="n">variables</span> <span class="nb">and </span><span class="n">arrays</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="kt">INTEGER </span><span class="n">IP</span><span class="p">,</span> <span class="n">ISPIN</span><span class="p">,</span> <span class="n">ISPIN2</span><span class="p">,</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span> <span class="n">EX</span><span class="p">,</span> <span class="n">EC</span><span class="p">,</span> <span class="n">DEX</span><span class="p">,</span> <span class="n">DEC</span><span class="p">,</span> <span class="n">STRESS</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">SAVE</span><span class="kd">::</span> <span class="n">JDGdistr</span><span class="o">=-</span><span class="mi">1</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span>  <span class="k">pointer</span> <span class="kd">::</span> <span class="n">drhoin</span><span class="p">(:,:),</span> 
     <span class="p">&amp;</span>                          <span class="n">dvxcdn</span><span class="p">(:,:,:)</span> 
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="kt">INTEGER</span>                <span class="kd">::</span> <span class="n">IP</span><span class="p">,</span> <span class="n">ISPIN</span><span class="p">,</span> <span class="n">ISPIN2</span><span class="p">,</span> <span class="n">NMPL</span>
      <span class="kt">REAL</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">EX</span><span class="p">,</span> <span class="n">EC</span><span class="p">,</span> <span class="n">DEX</span><span class="p">,</span> <span class="n">DEC</span><span class="p">,</span> <span class="n">STRESSL</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">aux3</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>   <span class="c">!! dummy arrays for cellxc</span>

      <span class="kt">real</span><span class="p">(</span><span class="n">grid_p</span><span class="p">),</span>  <span class="k">pointer</span> <span class="kd">::</span> <span class="n">drhoin</span><span class="p">(:,:),</span> <span class="n">drhoin_par</span><span class="p">(:,:),</span>
     <span class="p">&amp;</span>                          <span class="n">dvxcdn</span><span class="p">(:,:,:),</span> <span class="n">dvxcdn_par</span><span class="p">(:,:,:),</span>
     <span class="p">&amp;</span>                          <span class="n">vharris1_par</span><span class="p">(:,:),</span> <span class="n">fsrc</span><span class="p">(:),</span> <span class="n">fdst</span><span class="p">(:)</span>
      <span class="kt">INTEGER</span>                <span class="kd">::</span> <span class="n">ntpl_3</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="k">nullify</span><span class="p">(</span> <span class="n">drhoin</span><span class="p">,</span> <span class="n">dvxcdn</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">drhoin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="s1">&#39;drhoin&#39;</span><span class="p">,</span> <span class="s1">&#39;forhar&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">dvxcdn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>               <span class="s1">&#39;dvxcdn&#39;</span><span class="p">,</span> <span class="s1">&#39;forhar&#39;</span> <span class="p">)</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Initialize</span> <span class="n">some</span> <span class="n">variables</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="n">VHARRIS1</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="mf">0.0_grid_p</span>
      <span class="n">VHARRIS2</span><span class="p">(:)</span>   <span class="o">=</span> <span class="mf">0.0_grid_p</span>
      <span class="n">DRHOIN</span><span class="p">(:,:)</span>   <span class="o">=</span> <span class="mf">0.0_grid_p</span>
      <span class="n">DVXCDN</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="mf">0.0_grid_p</span>
<span class="cp">#ifndef BSC_CELLXC</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Set</span> <span class="n">uniform</span> <span class="n">distribution</span> <span class="n">of</span> <span class="n">mesh</span> <span class="n">points</span> <span class="nb">and </span><span class="n">find</span> <span class="n">my</span> <span class="n">processor</span> <span class="n">mesh</span> <span class="n">box</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>

      <span class="k">call </span><span class="n">jms_setMeshDistr</span><span class="p">(</span> <span class="n">distrID</span><span class="o">=</span><span class="n">JDGdistr</span><span class="p">,</span> <span class="n">nMesh</span><span class="o">=</span><span class="n">NTM</span><span class="p">,</span> 
     <span class="p">.</span>                       <span class="n">nNodesX</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nNodesY</span><span class="o">=</span><span class="n">ProcessorY</span><span class="p">,</span> <span class="n">nBlock</span><span class="o">=</span><span class="n">NSM</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">myMeshBox</span><span class="p">(</span> <span class="n">NTM</span><span class="p">,</span> <span class="n">JDGdistr</span><span class="p">,</span> <span class="n">myBox</span> <span class="p">)</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="n">STRESSL</span><span class="p">(:,:)</span>  <span class="o">=</span> <span class="mf">0.0_dp</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Compute</span> <span class="n">exchange</span><span class="o">-</span><span class="n">correlation</span> <span class="n">energy</span> <span class="nb">and </span><span class="n">potential</span> <span class="nb">and</span>
<span class="n">C</span> <span class="n">their</span> <span class="n">derivatives</span> <span class="n">respect</span> <span class="n">the</span> <span class="n">input</span> <span class="n">charge</span><span class="p">,</span> <span class="n">that</span> <span class="k">is</span><span class="p">,</span> <span class="n">Harris</span> <span class="n">charge</span>
<span class="n">C</span> <span class="nb">or </span><span class="n">the</span> <span class="nb">sum </span><span class="n">of</span> <span class="n">atomic</span> <span class="n">charges</span><span class="p">.</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>

      <span class="k">DO </span><span class="n">ISPIN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NSPIN</span>
        <span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NTPL</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">)</span> <span class="o">=</span>  <span class="n">RHOATM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NTPL</span><span class="p">)</span><span class="o">/</span><span class="n">NSPIN</span> 
        <span class="k">IF</span> <span class="p">(</span><span class="n">NPCC</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> 
     <span class="p">.</span>    <span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NTPL</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NTPL</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">)</span> <span class="o">+</span> 
     <span class="p">.</span>                           <span class="n">RHOPCC</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NTPL</span><span class="p">)</span><span class="o">/</span><span class="n">NSPIN</span>
      <span class="n">ENDDO</span>

<span class="cp">#ifdef BSC_CELLXC</span>
<span class="cp">#ifdef MPI</span>
      <span class="c">! The input distribution is UNIFORM, but we need to work</span>
      <span class="c">! with the LINEAR one</span>
      <span class="k">call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
<span class="cp">#endif</span>
      <span class="n">ntpl_3</span> <span class="o">=</span> <span class="n">ntpl</span>

      <span class="k">nullify</span><span class="p">(</span> <span class="n">drhoin_par</span><span class="p">,</span> <span class="n">vharris1_par</span><span class="p">,</span> <span class="n">dvxcdn_par</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">drhoin_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl_3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>               <span class="s1">&#39;drhoin_par&#39;</span><span class="p">,</span> <span class="s1">&#39;forhar&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">vharris1_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl_3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>               <span class="s1">&#39;vharris1_par&#39;</span><span class="p">,</span> <span class="s1">&#39;forhar&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">re_alloc</span><span class="p">(</span> <span class="n">dvxcdn_par</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ntpl_3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nspin</span><span class="p">,</span>
     <span class="p">&amp;</span>               <span class="s1">&#39;dvxcdn_par&#39;</span><span class="p">,</span> <span class="s1">&#39;forhar&#39;</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="k">DO </span><span class="n">ISPIN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NSPIN</span>
<span class="cp">#ifndef BSC_CELLXC</span>
        <span class="k">CALL </span><span class="n">REORD</span><span class="p">(</span><span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">),</span><span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">),</span><span class="n">NML</span><span class="p">,</span><span class="n">NSM</span><span class="p">,</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#else /* BSC_CELLXC */</span>
        <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">drhoin</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">drhoin_par</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="n">ENDDO</span>

<span class="cp">#ifndef BSC_CELLXC</span>
      <span class="k">CALL </span><span class="n">CELLXC</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CELL</span><span class="p">,</span> <span class="n">NTM</span><span class="p">,</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
     <span class="p">.</span>                           <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
     <span class="p">.</span>                           <span class="n">myBox</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">myBox</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">NSPIN</span><span class="p">,</span> <span class="n">DRHOIN</span><span class="p">,</span>
     <span class="p">.</span>             <span class="n">EX</span><span class="p">,</span> <span class="n">EC</span><span class="p">,</span> <span class="n">DEX</span><span class="p">,</span> <span class="n">DEC</span><span class="p">,</span> <span class="n">STRESS</span><span class="p">,</span> <span class="n">VHARRIS1</span><span class="p">,</span> <span class="n">DVXCDN</span> <span class="p">)</span>
<span class="cp">#else /* BSC_CELLXC */</span>
      <span class="k">CALL </span><span class="n">bsc_cellxc</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CELL</span><span class="p">,</span> <span class="n">NTML</span><span class="p">,</span> <span class="n">NTML</span><span class="p">,</span> <span class="n">NTPL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AUX3</span><span class="p">,</span> <span class="n">NSPIN</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DRHOIN_PAR</span><span class="p">,</span> <span class="n">EX</span><span class="p">,</span> <span class="n">EC</span><span class="p">,</span> <span class="n">DEX</span><span class="p">,</span> <span class="n">DEC</span><span class="p">,</span> <span class="n">VHARRIS1_PAR</span><span class="p">,</span>
     <span class="p">&amp;</span>             <span class="n">DVXCDN_PAR</span><span class="p">,</span> <span class="n">STRESSL</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>

      <span class="k">DO </span><span class="n">ISPIN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NSPIN</span>
<span class="cp">#ifndef BSC_CELLXC</span>
        <span class="k">CALL </span><span class="n">REORD</span><span class="p">(</span><span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">),</span><span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">),</span><span class="n">NML</span><span class="p">,</span><span class="n">NSM</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">CALL </span><span class="n">REORD</span><span class="p">(</span><span class="n">VHARRIS1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">),</span><span class="n">VHARRIS1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">),</span><span class="n">NML</span><span class="p">,</span><span class="n">NSM</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="cp">#else /* BSC_CELLXC */</span>
        <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">VHARRIS1_PAR</span><span class="p">(:,</span><span class="n">ISPIN</span><span class="p">)</span>
        <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">VHARRIS1</span><span class="p">(:,</span><span class="n">ispin</span><span class="p">)</span>
        <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
        <span class="k">DO </span><span class="n">ISPIN2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NSPIN</span>
<span class="cp">#ifndef BSC_CELLXC</span>
          <span class="k">CALL </span><span class="n">REORD</span><span class="p">(</span><span class="n">DVXCDN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">,</span><span class="n">ISPIN2</span><span class="p">),</span><span class="n">DVXCDN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">,</span><span class="n">ISPIN2</span><span class="p">),</span>
     <span class="p">.</span>               <span class="n">NML</span><span class="p">,</span><span class="n">NSM</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#else /* BSC_CELLXC */</span>
          <span class="n">fsrc</span> <span class="o">=&gt;</span> <span class="n">DVXCDN_PAR</span><span class="p">(:,</span><span class="n">ISPIN</span><span class="p">,</span><span class="n">ISPIN2</span><span class="p">)</span>
          <span class="n">fdst</span> <span class="o">=&gt;</span> <span class="n">DVXCDN</span><span class="p">(:,</span><span class="n">ISPIN</span><span class="p">,</span><span class="n">ISPIN2</span><span class="p">)</span>
          <span class="k">call </span><span class="n">distMeshData</span><span class="p">(</span> <span class="n">LINEAR</span><span class="p">,</span> <span class="n">fsrc</span><span class="p">,</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">KEEP</span> <span class="p">)</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
        <span class="n">ENDDO</span>
      <span class="n">ENDDO</span>

<span class="cp">#ifdef BSC_CELLXC</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">dvxcdn_par</span><span class="p">,</span>   <span class="s1">&#39;dvxcdn_par&#39;</span><span class="p">,</span>   <span class="s1">&#39;forhar&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">vharris1_par</span><span class="p">,</span> <span class="s1">&#39;vharris1_par&#39;</span><span class="p">,</span> <span class="s1">&#39;forhar&#39;</span> <span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">drhoin_par</span><span class="p">,</span>   <span class="s1">&#39;drhoin_par&#39;</span><span class="p">,</span>   <span class="s1">&#39;forhar&#39;</span> <span class="p">)</span>

<span class="cp">#ifdef MPI</span>
      <span class="k">call </span><span class="n">setMeshDistr</span><span class="p">(</span> <span class="n">UNIFORM</span><span class="p">,</span> <span class="n">nsm</span><span class="p">,</span> <span class="n">nsp</span><span class="p">,</span> <span class="n">nml</span><span class="p">,</span> <span class="n">nmpl</span><span class="p">,</span> <span class="n">ntml</span><span class="p">,</span> <span class="n">ntpl</span> <span class="p">)</span>
<span class="cp">#endif</span>
<span class="cp">#endif /* BSC_CELLXC */</span>
      <span class="k">DO </span><span class="n">ISPIN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NSPIN</span>
        <span class="k">IF</span><span class="p">(</span> <span class="n">NPCC</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> 
     <span class="p">&amp;</span>    <span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NTPL</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRHOIN</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NTPL</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">)</span> <span class="o">-</span> 
     <span class="p">&amp;</span>                           <span class="n">RHOPCC</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NTPL</span><span class="p">)</span><span class="o">/</span><span class="n">NSPIN</span>
        <span class="k">DO </span><span class="n">IP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NTPL</span>
          <span class="n">VHARRIS1</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">)</span> <span class="o">=</span> <span class="n">VHARRIS1</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">)</span> <span class="o">+</span> <span class="n">VNA</span><span class="p">(</span><span class="n">IP</span><span class="p">)</span>
        <span class="n">ENDDO</span>
      <span class="n">ENDDO</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Compute</span> <span class="n">the</span> <span class="nb">product </span><span class="n">DV_xc</span><span class="p">(</span><span class="n">Rho_in</span><span class="p">)</span><span class="o">/</span><span class="n">DRho_in</span> <span class="o">*</span> <span class="p">(</span><span class="n">Rho_out</span> <span class="o">-</span> <span class="n">Rho_in</span><span class="p">).</span>
<span class="n">C</span> <span class="n">Since</span> <span class="n">the</span> <span class="n">charge</span> <span class="n">that</span> <span class="n">enters</span> <span class="n">into</span> <span class="n">forhar</span> <span class="k">is </span><span class="n">DRHOOUT</span> <span class="o">=</span> <span class="n">Rho_out</span><span class="o">-</span><span class="n">Rhoatm</span>
<span class="n">C</span> <span class="n">no</span> <span class="n">extra</span> <span class="n">transformation</span> <span class="n">on</span> <span class="n">the</span> <span class="n">charge</span> <span class="n">density</span> <span class="k">is </span><span class="n">needed</span><span class="p">.</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>

      <span class="k">DO </span><span class="n">ISPIN</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NSPIN</span>
        <span class="k">DO </span><span class="n">ISPIN2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NSPIN</span>
          <span class="k">DO </span><span class="n">IP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NTPL</span>
            <span class="n">VHARRIS2</span><span class="p">(</span><span class="n">IP</span><span class="p">)</span> <span class="o">=</span> <span class="n">VHARRIS2</span><span class="p">(</span><span class="n">IP</span><span class="p">)</span> <span class="o">+</span> 
     <span class="p">&amp;</span>                     <span class="n">DVXCDN</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span><span class="n">ISPIN2</span><span class="p">,</span><span class="n">ISPIN</span><span class="p">)</span> <span class="o">*</span> <span class="n">DRHOOUT</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span><span class="n">ISPIN2</span><span class="p">)</span>
          <span class="n">ENDDO</span>
        <span class="n">ENDDO</span>
      <span class="n">ENDDO</span>

<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
<span class="n">C</span> <span class="n">Since</span> <span class="n">V_Hartree</span><span class="p">(</span><span class="n">DeltaRho_in</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">we</span> <span class="n">only</span> <span class="n">add</span> <span class="n">to</span> <span class="n">vharris2</span> <span class="n">the</span> <span class="n">neutral</span>
<span class="n">C</span> <span class="n">atom</span> <span class="n">potential</span>
<span class="n">C</span> <span class="o">----------------------------------------------------------------------</span>
      <span class="k">DO </span><span class="n">IP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NTPL</span>
        <span class="n">VHARRIS2</span><span class="p">(</span><span class="n">IP</span><span class="p">)</span> <span class="o">=</span> <span class="n">VNA</span><span class="p">(</span><span class="n">IP</span><span class="p">)</span> <span class="o">-</span> <span class="n">VHARRIS2</span><span class="p">(</span><span class="n">IP</span><span class="p">)</span>
      <span class="n">ENDDO</span>

      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">dvxcdn</span><span class="p">,</span> <span class="s1">&#39;dvxcdn&#39;</span><span class="p">,</span> <span class="s1">&#39;forhar&#39;</span><span class="p">)</span>
      <span class="k">call </span><span class="n">de_alloc</span><span class="p">(</span> <span class="n">drhoin</span><span class="p">,</span> <span class="s1">&#39;drhoin&#39;</span><span class="p">,</span> <span class="s1">&#39;forhar&#39;</span><span class="p">)</span>
      <span class="k">end subroutine </span><span class="n">forhar</span>
</pre></div>

    </section>
    <br>
    
    
    </div>
  </div>


    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2018 <a rel="license" href="http://www.gnu.org/licenses/old-licenses/fdl-1.2.en.html">GNU Free Documentation License</a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> SIESTA was developed by SIESTA Group</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>